---
title: Minimizar a coordenação
description: Minimizar a coordenação entre os serviços de aplicativos para atingir a escalabilidade
author: MikeWasson
ms.openlocfilehash: f26222148db2b48743c52293011ea0a5a58ebe07
ms.sourcegitcommit: 26b04f138a860979aea5d253ba7fecffc654841e
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/19/2018
ms.locfileid: "36206491"
---
# <a name="minimize-coordination"></a><span data-ttu-id="f45ce-103">Minimizar a coordenação</span><span class="sxs-lookup"><span data-stu-id="f45ce-103">Minimize coordination</span></span> 

## <a name="minimize-coordination-between-application-services-to-achieve-scalability"></a><span data-ttu-id="f45ce-104">Minimizar a coordenação entre os serviços de aplicativos para atingir a escalabilidade</span><span class="sxs-lookup"><span data-stu-id="f45ce-104">Minimize coordination between application services to achieve scalability</span></span>

<span data-ttu-id="f45ce-105">A maioria dos aplicativos de nuvem consiste em vários serviços de aplicativo &mdash; front-ends da Web, bancos de dados, processos de negócios, relatórios e análises e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="f45ce-105">Most cloud applications consist of multiple application services &mdash; web front ends, databases, business processes, reporting and analysis, and so on.</span></span> <span data-ttu-id="f45ce-106">Para obter escalabilidade e confiabilidade, cada um desses serviços deve ser executado em várias instâncias.</span><span class="sxs-lookup"><span data-stu-id="f45ce-106">To achieve scalability and reliability, each of those services should run on multiple instances.</span></span> 

<span data-ttu-id="f45ce-107">O que acontece quando duas instâncias tentam realizar operações simultâneas que afetam a algum estado compartilhado?</span><span class="sxs-lookup"><span data-stu-id="f45ce-107">What happens when two instances try to perform concurrent operations that affect some shared state?</span></span> <span data-ttu-id="f45ce-108">Em alguns casos, deve haver coordenação entre nós, por exemplo, para preservar as garantias ACID.</span><span class="sxs-lookup"><span data-stu-id="f45ce-108">In some cases, there must be coordination across nodes, for example to preserve ACID guarantees.</span></span> <span data-ttu-id="f45ce-109">Neste diagrama, `Node2` está aguardando `Node1` para liberar um bloqueio de banco de dados:</span><span class="sxs-lookup"><span data-stu-id="f45ce-109">In this diagram, `Node2` is waiting for `Node1` to release a database lock:</span></span>

![](./images/database-lock.svg)

<span data-ttu-id="f45ce-110">A coordenação limita os benefícios de escala horizontal e cria afunilamentos.</span><span class="sxs-lookup"><span data-stu-id="f45ce-110">Coordination limits the benefits of horizontal scale and creates bottlenecks.</span></span> <span data-ttu-id="f45ce-111">Neste exemplo, ao expandir o aplicativo e adicionar mais instâncias, você verá a contenção de bloqueio maior.</span><span class="sxs-lookup"><span data-stu-id="f45ce-111">In this example, as you scale out the application and add more instances, you'll see increased lock contention.</span></span> <span data-ttu-id="f45ce-112">No pior dos casos, as instâncias de front-end passam a maior parte do tempo aguardando bloqueios.</span><span class="sxs-lookup"><span data-stu-id="f45ce-112">In the worst case, the front-end instances will spend most of their time waiting on locks.</span></span>

<span data-ttu-id="f45ce-113">As semânticas "Exatamente uma vez" são outra fonte de coordenação frequente.</span><span class="sxs-lookup"><span data-stu-id="f45ce-113">"Exactly once" semantics are another frequent source of coordination.</span></span> <span data-ttu-id="f45ce-114">Por exemplo, um pedido deve ser processado exatamente uma vez.</span><span class="sxs-lookup"><span data-stu-id="f45ce-114">For example, an order must be processed exactly once.</span></span> <span data-ttu-id="f45ce-115">Dois trabalhadores estão ouvindo novas ordens.</span><span class="sxs-lookup"><span data-stu-id="f45ce-115">Two workers are listening for new orders.</span></span> <span data-ttu-id="f45ce-116">`Worker1` pega um pedido para processamento.</span><span class="sxs-lookup"><span data-stu-id="f45ce-116">`Worker1` picks up an order for processing.</span></span> <span data-ttu-id="f45ce-117">O aplicativo deve garantir que `Worker2` não duplique o trabalho, mas também se `Worker1` falhar, que o pedido não seja descartado.</span><span class="sxs-lookup"><span data-stu-id="f45ce-117">The application must ensure that `Worker2` doesn't duplicate the work, but also if `Worker1` crashes, the order isn't dropped.</span></span>

![](./images/coordination.svg)

<span data-ttu-id="f45ce-118">Você pode usar um padrão como [Supervisor de Agente de Agendador][sas-pattern] para coordenar entre os trabalhadores, mas nesse caso, uma abordagem melhor seria particionar o trabalho.</span><span class="sxs-lookup"><span data-stu-id="f45ce-118">You can use a pattern such as [Scheduler Agent Supervisor][sas-pattern] to coordinate between the workers, but in this case a better approach might be to partition the work.</span></span> <span data-ttu-id="f45ce-119">Cada trabalho é atribuído a um determinado intervalo de pedidos (digamos, por região de cobrança).</span><span class="sxs-lookup"><span data-stu-id="f45ce-119">Each worker is assigned a certain range of orders (say, by billing region).</span></span> <span data-ttu-id="f45ce-120">Se um trabalho falhar, uma nova instância assume onde a instância anterior foi interrompida, mas as várias instâncias não estão concorrendo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-120">If a worker crashes, a new instance picks up where the previous instance left off, but multiple instances aren't contending.</span></span>

## <a name="recommendations"></a><span data-ttu-id="f45ce-121">Recomendações</span><span class="sxs-lookup"><span data-stu-id="f45ce-121">Recommendations</span></span>

<span data-ttu-id="f45ce-122">**Adote a consistência eventual**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-122">**Embrace eventual consistency**.</span></span> <span data-ttu-id="f45ce-123">Quando os dados são distribuídos, leva coordenação para impor as garantias de consistência forte.</span><span class="sxs-lookup"><span data-stu-id="f45ce-123">When data is distributed, it takes coordination to enforce strong consistency guarantees.</span></span> <span data-ttu-id="f45ce-124">Por exemplo, suponha que uma operação atualize dois bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="f45ce-124">For example, suppose an operation updates two databases.</span></span> <span data-ttu-id="f45ce-125">Em vez de colocá-lo em um escopo de transação única, é melhor se o sistema puder acomodar a consistência eventual, talvez usando o padrão [Transação de Compensação][compensating-transaction] para reverter logicamente após uma falha.</span><span class="sxs-lookup"><span data-stu-id="f45ce-125">Instead of putting it into a single transaction scope, it's better if the system can accommodate eventual consistency, perhaps by using the [Compensating Transaction][compensating-transaction] pattern to logically roll back after a failure.</span></span>

<span data-ttu-id="f45ce-126">**Usar eventos de domínio para sincronizar o estado**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-126">**Use domain events to synchronize state**.</span></span> <span data-ttu-id="f45ce-127">Um [evento de domínio][domain-event] é um evento que registra quando acontecer algo que tenha importância no domínio.</span><span class="sxs-lookup"><span data-stu-id="f45ce-127">A [domain event][domain-event] is an event that records when something happens that has significance within the domain.</span></span> <span data-ttu-id="f45ce-128">Os serviços interessados podem escutar o evento, em vez de usar uma transação global para coordenar entre vários serviços.</span><span class="sxs-lookup"><span data-stu-id="f45ce-128">Interested services can listen for the event, rather than using a global transaction to coordinate across multiple services.</span></span> <span data-ttu-id="f45ce-129">Se essa abordagem for usada, o sistema deverá tolerar a consistência eventual (veja o item anterior).</span><span class="sxs-lookup"><span data-stu-id="f45ce-129">If this approach is used, the system must tolerate eventual consistency (see previous item).</span></span> 

<span data-ttu-id="f45ce-130">**Considere os padrões como o CQRS e o fornecimento de evento**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-130">**Consider patterns such as CQRS and event sourcing**.</span></span> <span data-ttu-id="f45ce-131">Esses dois padrões podem ajudar a reduzir a contenção entre as cargas de trabalho de leitura e gravação.</span><span class="sxs-lookup"><span data-stu-id="f45ce-131">These two patterns can help to reduce contention between read workloads and write workloads.</span></span> 

- <span data-ttu-id="f45ce-132">O [padrão CQRS][cqrs-pattern] separa as operações de gravação e de leitura.</span><span class="sxs-lookup"><span data-stu-id="f45ce-132">The [CQRS pattern][cqrs-pattern] separates read operations from write operations.</span></span> <span data-ttu-id="f45ce-133">Em algumas implementações, os dados de leitura são separados fisicamente dos dados de gravação.</span><span class="sxs-lookup"><span data-stu-id="f45ce-133">In some implementations, the read data is physically separated from the write data.</span></span> 

- <span data-ttu-id="f45ce-134">No [padrão Evento de Fornecimento][event-sourcing], as alterações de estado são registradas como uma série de eventos para um armazenamento de dados somente de acréscimo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-134">In the [Event Sourcing pattern][event-sourcing], state changes are recorded as a series of events to an append-only data store.</span></span> <span data-ttu-id="f45ce-135">O acréscimo de um evento ao fluxo é uma operação atômica, exigindo bloqueio mínimo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-135">Appending an event to the stream is an atomic operation, requiring minimal locking.</span></span> 

<span data-ttu-id="f45ce-136">Esses dois padrões se complementam.</span><span class="sxs-lookup"><span data-stu-id="f45ce-136">These two patterns complement each other.</span></span> <span data-ttu-id="f45ce-137">Se o armazenamento de somente gravação CQRS usa fontes de evento, o armazenamento de somente leitura pode escutar os mesmos eventos criar um instantâneo de leitura do estado atual, otimizado para consultas.</span><span class="sxs-lookup"><span data-stu-id="f45ce-137">If the write-only store in CQRS uses event sourcing, the read-only store can listen for the same events to create a readable snapshot of the current state, optimized for queries.</span></span> <span data-ttu-id="f45ce-138">Antes de adotar o CQRS ou o fornecimento de evento, no entanto, lembre-se dos desafios dessa abordagem.</span><span class="sxs-lookup"><span data-stu-id="f45ce-138">Before adopting CQRS or event sourcing, however, be aware of the challenges of this approach.</span></span> <span data-ttu-id="f45ce-139">Para saber mais, veja [estilo de arquitetura do CQRS][cqrs-style].</span><span class="sxs-lookup"><span data-stu-id="f45ce-139">For more information, see [CQRS architecture style][cqrs-style].</span></span>

<span data-ttu-id="f45ce-140">**Dados de partição**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-140">**Partition data**.</span></span>  <span data-ttu-id="f45ce-141">Evite colocar todos os seus dados em um esquema de dados que seja compartilhado entre vários serviços de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-141">Avoid putting all of your data into one data schema that is shared across many application services.</span></span> <span data-ttu-id="f45ce-142">Uma arquitetura de microsserviços impõe esse princípio, tornando cada serviço responsável por seu próprio armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="f45ce-142">A microservices architecture enforces this principle by making each service responsible for its own data store.</span></span> <span data-ttu-id="f45ce-143">Em um único banco de dados, o particionamento dos dados em fragmentos pode melhorar a simultaneidade, porque um serviço de gravar um fragmento não afeta um serviço de gravação de um fragmento diferente.</span><span class="sxs-lookup"><span data-stu-id="f45ce-143">Within a single database, partitioning the data into shards can improve concurrency, because a service writing to one shard does not affect a service writing to a different shard.</span></span>

<span data-ttu-id="f45ce-144">**Criar operações idempotentes**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-144">**Design idempotent operations**.</span></span> <span data-ttu-id="f45ce-145">Quando possível, projete as operações como idempotentes.</span><span class="sxs-lookup"><span data-stu-id="f45ce-145">When possible, design operations to be idempotent.</span></span> <span data-ttu-id="f45ce-146">Dessa forma, elas poderão ser manipuladas usando a semântica at-least-once.</span><span class="sxs-lookup"><span data-stu-id="f45ce-146">That way, they can be handled using at-least-once semantics.</span></span> <span data-ttu-id="f45ce-147">Por exemplo, você pode colocar itens de trabalho em uma fila.</span><span class="sxs-lookup"><span data-stu-id="f45ce-147">For example, you can put work items on a queue.</span></span> <span data-ttu-id="f45ce-148">Se um trabalho falhar no meio de uma operação, outro trabalhador simplesmente escolhe o item de trabalho.</span><span class="sxs-lookup"><span data-stu-id="f45ce-148">If a worker crashes in the middle of an operation, another worker simply picks up the work item.</span></span>

<span data-ttu-id="f45ce-149">**Use o processamento paralelo assíncrono**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-149">**Use asynchronous parallel processing**.</span></span> <span data-ttu-id="f45ce-150">Se uma operação exigir várias etapas executadas de forma assíncrona (como chamadas de serviço remoto), você poderá chamá-los em paralelo e, em seguida, agregar os resultados.</span><span class="sxs-lookup"><span data-stu-id="f45ce-150">If an operation requires multiple steps that are performed asynchronously (such as remote service calls), you might be able to call them in parallel, and then aggregate the results.</span></span> <span data-ttu-id="f45ce-151">Essa abordagem supõe que cada etapa não dependa dos resultados da etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="f45ce-151">This approach assumes that each step does not depend on the results of the previous step.</span></span>   

<span data-ttu-id="f45ce-152">**Use a simultaneidade otimista quando possível**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-152">**Use optimistic concurrency when possible**.</span></span> <span data-ttu-id="f45ce-153">O controle de simultaneidade pessimista usa bloqueios de banco de dados para evitar conflitos.</span><span class="sxs-lookup"><span data-stu-id="f45ce-153">Pessimistic concurrency control uses database locks to prevent conflicts.</span></span> <span data-ttu-id="f45ce-154">Isso pode causar baixo desempenho e reduzir a disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="f45ce-154">This can cause poor performance and reduce availability.</span></span> <span data-ttu-id="f45ce-155">Com o controle de simultaneidade otimista, cada transação modifica uma cópia ou um instantâneo dos dados.</span><span class="sxs-lookup"><span data-stu-id="f45ce-155">With optimistic concurrency control, each transaction modifies a copy or snapshot of the data.</span></span> <span data-ttu-id="f45ce-156">Quando a transação é confirmada, o mecanismo de banco de dados valida a transação e rejeita qualquer transação que possa afetar a consistência do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="f45ce-156">When the transaction is committed, the database engine validates the transaction and rejects any transactions that would affect database consistency.</span></span> 

<span data-ttu-id="f45ce-157">O banco de dados SQL do Azure e o SQL Server oferecem suporte à simultaneidade otimista por meio de [isolamento de instantâneo][sql-snapshot-isolation].</span><span class="sxs-lookup"><span data-stu-id="f45ce-157">Azure SQL Database and SQL Server support optimistic concurrency through [snapshot isolation][sql-snapshot-isolation].</span></span> <span data-ttu-id="f45ce-158">Alguns serviços de armazenamento do Azure oferecem suporte à simultaneidade otimista com Etags, incluindo o [Azure Cosmos DB][cosmosdb-faq] e o [Armazenamento do Azure][storage-concurrency].</span><span class="sxs-lookup"><span data-stu-id="f45ce-158">Some Azure storage services support optimistic concurrency through the use of Etags, including [Azure Cosmos DB][cosmosdb-faq] and [Azure Storage][storage-concurrency].</span></span>

<span data-ttu-id="f45ce-159">**Considere o MapReduce ou outros algoritmos paralelos e distribuídos**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-159">**Consider MapReduce or other parallel, distributed algorithms**.</span></span> <span data-ttu-id="f45ce-160">Dependendo dos dados e o tipo de trabalho a ser executado, você poderá dividir o trabalho em tarefas independentes que podem ser executadas por vários nós de trabalho em paralelo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-160">Depending on the data and type of work to be performed, you may be able to split the work into independent tasks that can be performed by multiple nodes working in parallel.</span></span> <span data-ttu-id="f45ce-161">Veja [Estilo de arquitetura de computação intensa][big-compute].</span><span class="sxs-lookup"><span data-stu-id="f45ce-161">See [Big compute architecture style][big-compute].</span></span>

<span data-ttu-id="f45ce-162">**Use a seleção de preenchimento para coordenação**.</span><span class="sxs-lookup"><span data-stu-id="f45ce-162">**Use leader election for coordination**.</span></span> <span data-ttu-id="f45ce-163">Em casos em que você precisa coordenar operações, verifique se o coordenador não entrar em um ponto único de falha no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="f45ce-163">In cases where you need to coordinate operations, make sure the coordinator does not become a single point of failure in the application.</span></span> <span data-ttu-id="f45ce-164">Com o [padrão Eleição do Líder][leader-election], uma instância é líder a qualquer momento e atua como o coordenador.</span><span class="sxs-lookup"><span data-stu-id="f45ce-164">Using the [Leader Election pattern][leader-election], one instance is the leader at any time, and acts as the coordinator.</span></span> <span data-ttu-id="f45ce-165">Se o líder falhar, uma nova instância é escolhida para ser o líder.</span><span class="sxs-lookup"><span data-stu-id="f45ce-165">If the leader fails, a new instance is elected to be the leader.</span></span> 
 

<!-- links -->

[big-compute]: ../architecture-styles/big-compute.md
[compensating-transaction]: ../../patterns/compensating-transaction.md
[cqrs-style]: ../architecture-styles/cqrs.md
[cqrs-pattern]: ../../patterns/cqrs.md
[cosmosdb-faq]: /azure/cosmos-db/faq
[domain-event]: https://martinfowler.com/eaaDev/DomainEvent.html
[event-sourcing]: ../../patterns/event-sourcing.md
[leader-election]: ../../patterns/leader-election.md
[sas-pattern]: ../../patterns/scheduler-agent-supervisor.md
[sql-snapshot-isolation]: /sql/t-sql/statements/set-transaction-isolation-level-transact-sql
[storage-concurrency]: https://azure.microsoft.com/blog/managing-concurrency-in-microsoft-azure-storage-2/
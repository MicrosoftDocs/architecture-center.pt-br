---
title: Estilo de arquitetura CQRS
titleSuffix: Azure Application Architecture Guide
description: Descreve os benefícios, os desafios e as práticas recomendadas para arquiteturas CQRS.
author: MikeWasson
ms.date: 08/30/2018
ms.custom: seojan19
ms.openlocfilehash: eab765d4eece919d2ca946a3f7152bde24bfd6c5
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2019
ms.locfileid: "54114038"
---
# <a name="cqrs-architecture-style"></a><span data-ttu-id="612d0-103">Estilo de arquitetura CQRS</span><span class="sxs-lookup"><span data-stu-id="612d0-103">CQRS architecture style</span></span>

<span data-ttu-id="612d0-104">O CQRS (Command and Query Responsibility Segregation) é um estilo de arquitetura que separa operações de leitura de operações de gravação.</span><span class="sxs-lookup"><span data-stu-id="612d0-104">Command and Query Responsibility Segregation (CQRS) is an architecture style that separates read operations from write operations.</span></span>

![Diagrama lógico de um estilo de arquitetura CQRS](./images/cqrs-logical.svg)

<span data-ttu-id="612d0-106">Nas arquiteturas tradicionais, o mesmo modelo de dados é usado para consultar e atualizar um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-106">In traditional architectures, the same data model is used to query and update a database.</span></span> <span data-ttu-id="612d0-107">É simples e funciona bem para operações CRUD básicas.</span><span class="sxs-lookup"><span data-stu-id="612d0-107">That's simple and works well for basic CRUD operations.</span></span> <span data-ttu-id="612d0-108">Em aplicativos mais complexos, no entanto, essa abordagem pode se tornar complicada.</span><span class="sxs-lookup"><span data-stu-id="612d0-108">In more complex applications, however, this approach can become unwieldy.</span></span> <span data-ttu-id="612d0-109">Por exemplo, no lado de leitura, o aplicativo pode executar muitas consultas diferentes, retornando objetos de transferência de dados (DTOs) com formas diferentes.</span><span class="sxs-lookup"><span data-stu-id="612d0-109">For example, on the read side, the application may perform many different queries, returning data transfer objects (DTOs) with different shapes.</span></span> <span data-ttu-id="612d0-110">O mapeamento de objetos pode se tornar complicado.</span><span class="sxs-lookup"><span data-stu-id="612d0-110">Object mapping can become complicated.</span></span> <span data-ttu-id="612d0-111">No lado da gravação, o modelo pode implementar uma validação complexa e lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="612d0-111">On the write side, the model may implement complex validation and business logic.</span></span> <span data-ttu-id="612d0-112">Como resultado, você pode terminar com um modelo excessivamente complexo que faz coisas em excesso.</span><span class="sxs-lookup"><span data-stu-id="612d0-112">As a result, you can end up with an overly complex model that does too much.</span></span>

<span data-ttu-id="612d0-113">Outro problema potencial é que a leitura e a gravação de cargas de trabalho geralmente são assimétricas, com diferentes requisitos de desempenho e escalabilidade.</span><span class="sxs-lookup"><span data-stu-id="612d0-113">Another potential problem is that read and write workloads are often asymmetrical, with very different performance and scale requirements.</span></span>

<span data-ttu-id="612d0-114">O CQRS trata desses problemas, separando as leituras e gravações em modelos separados, usando **comandos** para atualizar dados e **consultas** para ler dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-114">CQRS addresses these problems by separating reads and writes into separate models, using **commands** to update data, and **queries** to read data.</span></span>

- <span data-ttu-id="612d0-115">Os comandos devem ser baseados em tarefas, em vez de centrados nos dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-115">Commands should be task based, rather than data centric.</span></span> <span data-ttu-id="612d0-116">Os comandos ("Book hotel room," not "set ReservationStatus to Reserved.") podem ser posicionados em uma fila para processamento assíncrono, em vez de ser processado de forma síncrona.</span><span class="sxs-lookup"><span data-stu-id="612d0-116">("Book hotel room," not "set ReservationStatus to Reserved.") Commands may be placed on a queue for asynchronous processing, rather than being processed synchronously.</span></span>

- <span data-ttu-id="612d0-117">As consultas nunca modificam o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-117">Queries never modify the database.</span></span> <span data-ttu-id="612d0-118">Uma consulta retorna um DTO que não encapsula qualquer conhecimento de domínio.</span><span class="sxs-lookup"><span data-stu-id="612d0-118">A query returns a DTO that does not encapsulate any domain knowledge.</span></span>

<span data-ttu-id="612d0-119">Para maior isolamento, você pode separar fisicamente os dados de leitura de dados de gravação.</span><span class="sxs-lookup"><span data-stu-id="612d0-119">For greater isolation, you can physically separate the read data from the write data.</span></span> <span data-ttu-id="612d0-120">Nesse caso, o banco de dados de leitura pode usar seu próprio esquema de dados, otimizado para consultas.</span><span class="sxs-lookup"><span data-stu-id="612d0-120">In that case, the read database can use its own data schema that is optimized for queries.</span></span> <span data-ttu-id="612d0-121">Por exemplo, ele pode armazenar uma [exibição materializada][materialized-view] dos dados, para evitar mapeamentos de O/RM complexos ou junções complexas.</span><span class="sxs-lookup"><span data-stu-id="612d0-121">For example, it can store a [materialized view][materialized-view] of the data, in order to avoid complex joins or complex O/RM mappings.</span></span> <span data-ttu-id="612d0-122">Ele ainda pode usar um tipo diferente de armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-122">It might even use a different type of data store.</span></span> <span data-ttu-id="612d0-123">Por exemplo, o banco de dados de gravação pode ser relacional, enquanto o banco de dados de leitura é um banco de dados de documento.</span><span class="sxs-lookup"><span data-stu-id="612d0-123">For example, the write database might be relational, while the read database is a document database.</span></span>

<span data-ttu-id="612d0-124">Se os bancos de dados de leitura e gravação separados forem usados, deverão ser mantidos em sincronia. Normalmente, isso é feito com a publicação de um evento pelo modelo de gravação sempre que ele atualiza o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="612d0-124">If separate read and write databases are used, they must be kept in sync. Typically this is accomplished by having the write model publish an event whenever it updates the database.</span></span> <span data-ttu-id="612d0-125">A atualização do banco de dados e a publicação do evento devem ocorrer em uma única transação.</span><span class="sxs-lookup"><span data-stu-id="612d0-125">Updating the database and publishing the event must occur in a single transaction.</span></span>

<span data-ttu-id="612d0-126">Algumas implementações do CQRS usam o [padrão de Evento de Fornecimento][event-sourcing].</span><span class="sxs-lookup"><span data-stu-id="612d0-126">Some implementations of CQRS use the [Event Sourcing pattern][event-sourcing].</span></span> <span data-ttu-id="612d0-127">Com esse padrão, o estado do aplicativo é armazenado como uma sequência de eventos.</span><span class="sxs-lookup"><span data-stu-id="612d0-127">With this pattern, application state is stored as a sequence of events.</span></span> <span data-ttu-id="612d0-128">Cada evento representa um conjunto de alterações nos dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-128">Each event represents a set of changes to the data.</span></span> <span data-ttu-id="612d0-129">O estado atual foi criado pela repetição dos eventos.</span><span class="sxs-lookup"><span data-stu-id="612d0-129">The current state is constructed by replaying the events.</span></span> <span data-ttu-id="612d0-130">Em um contexto CQRS, um dos benefícios do fornecimento do evento é que os mesmos eventos podem ser usados para notificar outros componentes &mdash; em particular, para notificar o modelo de leitura.</span><span class="sxs-lookup"><span data-stu-id="612d0-130">In a CQRS context, one benefit of Event Sourcing is that the same events can be used to notify other components &mdash; in particular, to notify the read model.</span></span> <span data-ttu-id="612d0-131">O modelo de leitura usa os eventos para criar um instantâneo do estado atual, que é mais eficiente para consultas.</span><span class="sxs-lookup"><span data-stu-id="612d0-131">The read model uses the events to create a snapshot of the current state, which is more efficient for queries.</span></span> <span data-ttu-id="612d0-132">No entanto, o fornecimento de evento adiciona complexidade ao design.</span><span class="sxs-lookup"><span data-stu-id="612d0-132">However, Event Sourcing adds complexity to the design.</span></span>

![Eventos CQRS](./images/cqrs-events.svg)

## <a name="when-to-use-this-architecture"></a><span data-ttu-id="612d0-134">Quando usar essa arquitetura</span><span class="sxs-lookup"><span data-stu-id="612d0-134">When to use this architecture</span></span>

<span data-ttu-id="612d0-135">Considere o CQRS para domínios colaborativos em que muitos usuários acessem os mesmos dados, especialmente quando as cargas de trabalho de leitura e gravação forem assimétricas.</span><span class="sxs-lookup"><span data-stu-id="612d0-135">Consider CQRS for collaborative domains where many users access the same data, especially when the read and write workloads are asymmetrical.</span></span>

<span data-ttu-id="612d0-136">O CQRS não é uma arquitetura de nível superior que se aplica ao sistema inteiro.</span><span class="sxs-lookup"><span data-stu-id="612d0-136">CQRS is not a top-level architecture that applies to an entire system.</span></span> <span data-ttu-id="612d0-137">Aplique o CQRS somente a esses subsistemas onde houver um valor claro na separação de leituras e gravações.</span><span class="sxs-lookup"><span data-stu-id="612d0-137">Apply CQRS only to those subsystems where there is clear value in separating reads and writes.</span></span> <span data-ttu-id="612d0-138">Caso contrário, você estará criando uma complexidade adicional sem nenhum benefício.</span><span class="sxs-lookup"><span data-stu-id="612d0-138">Otherwise, you are creating additional complexity for no benefit.</span></span>

## <a name="benefits"></a><span data-ttu-id="612d0-139">Benefícios</span><span class="sxs-lookup"><span data-stu-id="612d0-139">Benefits</span></span>

- <span data-ttu-id="612d0-140">**Dimensionamento independente**.</span><span class="sxs-lookup"><span data-stu-id="612d0-140">**Independently scaling**.</span></span> <span data-ttu-id="612d0-141">O CQRS permite que as cargas de trabalho de leitura e gravação sejam dimensionadas de forma independente e pode resultar em menos contenções de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="612d0-141">CQRS allows the read and write workloads to scale independently, and may result in fewer lock contentions.</span></span>
- <span data-ttu-id="612d0-142">**Esquemas de dados otimizados**.</span><span class="sxs-lookup"><span data-stu-id="612d0-142">**Optimized data schemas**.</span></span> <span data-ttu-id="612d0-143">O lado de leitura pode usar um esquema que é otimizado para consultas, enquanto o lado de gravação usa um esquema que é otimizado para atualizações.</span><span class="sxs-lookup"><span data-stu-id="612d0-143">The read side can use a schema that is optimized for queries, while the write side uses a schema that is optimized for updates.</span></span>
- <span data-ttu-id="612d0-144">**Segurança**.</span><span class="sxs-lookup"><span data-stu-id="612d0-144">**Security**.</span></span> <span data-ttu-id="612d0-145">É mais fácil garantir que apenas as entidades do direito de domínio estejam executando gravações nos dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-145">It's easier to ensure that only the right domain entities are performing writes on the data.</span></span>
- <span data-ttu-id="612d0-146">**Separação de preocupações**.</span><span class="sxs-lookup"><span data-stu-id="612d0-146">**Separation of concerns**.</span></span> <span data-ttu-id="612d0-147">Isolar os lados de leitura e gravação pode resultar em modelos mais flexíveis e sustentáveis.</span><span class="sxs-lookup"><span data-stu-id="612d0-147">Segregating the read and write sides can result in models that are more maintainable and flexible.</span></span> <span data-ttu-id="612d0-148">A maior parte da lógica de negócios complexa vai para o modelo de gravação.</span><span class="sxs-lookup"><span data-stu-id="612d0-148">Most of the complex business logic goes into the write model.</span></span> <span data-ttu-id="612d0-149">O modelo de leitura pode ser relativamente simples.</span><span class="sxs-lookup"><span data-stu-id="612d0-149">The read model can be relatively simple.</span></span>
- <span data-ttu-id="612d0-150">**Consultas mais simples**.</span><span class="sxs-lookup"><span data-stu-id="612d0-150">**Simpler queries**.</span></span> <span data-ttu-id="612d0-151">Ao armazenar uma exibição materializada no banco de dados de leitura, o aplicativo poderá evitar junções complexas durante as consultas.</span><span class="sxs-lookup"><span data-stu-id="612d0-151">By storing a materialized view in the read database, the application can avoid complex joins when querying.</span></span>

## <a name="challenges"></a><span data-ttu-id="612d0-152">Desafios</span><span class="sxs-lookup"><span data-stu-id="612d0-152">Challenges</span></span>

- <span data-ttu-id="612d0-153">**Complexidade**.</span><span class="sxs-lookup"><span data-stu-id="612d0-153">**Complexity**.</span></span> <span data-ttu-id="612d0-154">A ideia básica do CQRS é simples.</span><span class="sxs-lookup"><span data-stu-id="612d0-154">The basic idea of CQRS is simple.</span></span> <span data-ttu-id="612d0-155">Mas isso poderá resultar em um design de aplicativo mais complexo, especialmente se eles incluírem o padrão Fornecimento de Eventos.</span><span class="sxs-lookup"><span data-stu-id="612d0-155">But it can lead to a more complex application design, especially if they include the Event Sourcing pattern.</span></span>

- <span data-ttu-id="612d0-156">**Mensagens**.</span><span class="sxs-lookup"><span data-stu-id="612d0-156">**Messaging**.</span></span> <span data-ttu-id="612d0-157">Embora o CQRS não necessite de mensagens, é comum usar mensagens para comandos de processo e publicar eventos de atualização.</span><span class="sxs-lookup"><span data-stu-id="612d0-157">Although CQRS does not require messaging, it's common to use messaging to process commands and publish update events.</span></span> <span data-ttu-id="612d0-158">Neste caso, o aplicativo deve tratar as falhas de mensagem ou as mensagens duplicadas.</span><span class="sxs-lookup"><span data-stu-id="612d0-158">In that case, the application must handle message failures or duplicate messages.</span></span>

- <span data-ttu-id="612d0-159">**Consistência eventual**.</span><span class="sxs-lookup"><span data-stu-id="612d0-159">**Eventual consistency**.</span></span> <span data-ttu-id="612d0-160">Se você separar os bancos de dados de leitura e de gravação, os dados de leitura poderão ficar obsoletos.</span><span class="sxs-lookup"><span data-stu-id="612d0-160">If you separate the read and write databases, the read data may be stale.</span></span>

## <a name="best-practices"></a><span data-ttu-id="612d0-161">Práticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="612d0-161">Best practices</span></span>

- <span data-ttu-id="612d0-162">Para saber mais sobre como implementar o CQRS, confira o [padrão CQRS][cqrs-pattern].</span><span class="sxs-lookup"><span data-stu-id="612d0-162">For more information about implementing CQRS, see the [CQRS pattern][cqrs-pattern].</span></span>

- <span data-ttu-id="612d0-163">Considere o uso do padrão [Fornecimento de Evento][event-sourcing] para evitar conflitos de atualização.</span><span class="sxs-lookup"><span data-stu-id="612d0-163">Consider using the [Event Sourcing][event-sourcing] pattern to avoid update conflicts.</span></span>

- <span data-ttu-id="612d0-164">Considere o uso do [padrão Exibição Materializada][materialized-view] para o modelo de leitura para otimizar o esquema para consultas.</span><span class="sxs-lookup"><span data-stu-id="612d0-164">Consider using the [Materialized View pattern][materialized-view] for the read model, to optimize the schema for queries.</span></span>

## <a name="cqrs-in-microservices"></a><span data-ttu-id="612d0-165">CQRS em microsserviços</span><span class="sxs-lookup"><span data-stu-id="612d0-165">CQRS in microservices</span></span>

<span data-ttu-id="612d0-166">O CQRS pode ser especialmente útil em uma [arquitetura de microsserviços][microservices].</span><span class="sxs-lookup"><span data-stu-id="612d0-166">CQRS can be especially useful in a [microservices architecture][microservices].</span></span> <span data-ttu-id="612d0-167">Um dos princípios de microsserviços é que um serviço não pode acessar diretamente o armazenamento de dados do outro serviço.</span><span class="sxs-lookup"><span data-stu-id="612d0-167">One of the principles of microservices is that a service cannot directly access another service's data store.</span></span>

![Diagrama de uma abordagem de microsserviços incorreta](./images/cqrs-microservices-wrong.png)

<span data-ttu-id="612d0-169">No diagrama a seguir, o Serviço A grava em um armazenamento de dados e o Serviço B mantém uma exibição materializada dos dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-169">In the following diagram, Service A writes to a data store, and Service B keeps a materialized view of the data.</span></span> <span data-ttu-id="612d0-170">Um serviço publica um evento sempre que ele grava no armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="612d0-170">Service A publishes an event whenever it writes to the data store.</span></span> <span data-ttu-id="612d0-171">O Serviço B assina o evento.</span><span class="sxs-lookup"><span data-stu-id="612d0-171">Service B subscribes to the event.</span></span>

![Diagrama de uma abordagem de microsserviços correta](./images/cqrs-microservices-right.png)

<!-- links -->

[cqrs-pattern]: ../../patterns/cqrs.md
[event-sourcing]: ../../patterns/event-sourcing.md
[materialized-view]: ../../patterns/materialized-view.md
[microservices]: ./microservices.md

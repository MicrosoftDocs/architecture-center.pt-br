---
title: Padrão de Transação de Compensação
titleSuffix: Cloud Design Patterns
description: Desfaça o trabalho executado por uma série de etapas que, juntas, definem uma operação que acabe sendo consistente.
keywords: padrão de design
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: b81151a6db08c2c14c7f26af3b4b79bfd22a18bb
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011609"
---
# <a name="compensating-transaction-pattern"></a><span data-ttu-id="d4627-104">Padrão de Transação de Compensação</span><span class="sxs-lookup"><span data-stu-id="d4627-104">Compensating Transaction pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="d4627-105">Desfaça o trabalho executado por uma série de etapas, que juntas definem uma operação eventualmente consistente, se uma ou mais das etapas falhar.</span><span class="sxs-lookup"><span data-stu-id="d4627-105">Undo the work performed by a series of steps, which together define an eventually consistent operation, if one or more of the steps fail.</span></span> <span data-ttu-id="d4627-106">As operações que seguem o modelo de consistência eventual geralmente normalmente são encontradas em aplicativos hospedados em nuvem que implementam fluxos de trabalho e processos de negócios complexos.</span><span class="sxs-lookup"><span data-stu-id="d4627-106">Operations that follow the eventual consistency model are commonly found in cloud-hosted applications that implement complex business processes and workflows.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="d4627-107">Contexto e problema</span><span class="sxs-lookup"><span data-stu-id="d4627-107">Context and problem</span></span>

<span data-ttu-id="d4627-108">Aplicativos em execução na nuvem com modificam os dados com frequência.</span><span class="sxs-lookup"><span data-stu-id="d4627-108">Applications running in the cloud frequently modify data.</span></span> <span data-ttu-id="d4627-109">Esses dados podem ser distribuídos entre várias fontes de dados mantidas em diferentes locais geográficos.</span><span class="sxs-lookup"><span data-stu-id="d4627-109">This data might be spread across various data sources held in different geographic locations.</span></span> <span data-ttu-id="d4627-110">Para evitar a contenção e melhorar o desempenho em um ambiente distribuído, um aplicativo não deve tentar fornecer forte consistência transacional.</span><span class="sxs-lookup"><span data-stu-id="d4627-110">To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency.</span></span> <span data-ttu-id="d4627-111">Em vez disso, o aplicativo deve implementar a consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="d4627-111">Rather, the application should implement eventual consistency.</span></span> <span data-ttu-id="d4627-112">Neste modelo, uma operação de negócios típica consiste em uma série de etapas separadas.</span><span class="sxs-lookup"><span data-stu-id="d4627-112">In this model, a typical business operation consists of a series of separate steps.</span></span> <span data-ttu-id="d4627-113">Enquanto essas etapas estão sendo executadas, a visão geral do estado do sistema pode ficar divergente, mas quando a operação for concluída e todas as etapas forem executadas no sistema, ela deverá ficar consistente novamente.</span><span class="sxs-lookup"><span data-stu-id="d4627-113">While these steps are being performed, the overall view of the system state might be inconsistent, but when the operation has completed and all of the steps have been executed the system should become consistent again.</span></span>

> <span data-ttu-id="d4627-114">O [Primer de Consistência de Dados](https://msdn.microsoft.com/library/dn589800.aspx) fornece informações sobre por que as transações distribuídas não escalam bem e os princípios do modelo de consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="d4627-114">The [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) provides information about why distributed transactions don't scale well, and the principles of the eventual consistency model.</span></span>

<span data-ttu-id="d4627-115">Um desafio do modelo de consistência eventual é como tratar uma etapa que falhou.</span><span class="sxs-lookup"><span data-stu-id="d4627-115">A challenge in the eventual consistency model is how to handle a step that has failed.</span></span> <span data-ttu-id="d4627-116">Nesse caso, pode ser necessário desfazer todo o trabalho concluído pelas etapas anteriores na operação.</span><span class="sxs-lookup"><span data-stu-id="d4627-116">In this case it might be necessary to undo all of the work completed by the previous steps in the operation.</span></span> <span data-ttu-id="d4627-117">No entanto, os dados não podem ser simplesmente revertidos porque outras instâncias simultâneas do aplicativo já podem tê-los alterado.</span><span class="sxs-lookup"><span data-stu-id="d4627-117">However, the data can't simply be rolled back because other concurrent instances of the application might have changed it.</span></span> <span data-ttu-id="d4627-118">Mesmo nos casos em que os dados não foram alterados por uma instância simultânea, desfazer uma etapa pode não ser simplesmente uma questão de restaurar o estado original.</span><span class="sxs-lookup"><span data-stu-id="d4627-118">Even in cases where the data hasn't been changed by a concurrent instance, undoing a step might not simply be a matter of restoring the original state.</span></span> <span data-ttu-id="d4627-119">Pode ser necessário aplicar várias regras específicas de negócios (consulte o site de viagem descrito na seção Exemplo).</span><span class="sxs-lookup"><span data-stu-id="d4627-119">It might be necessary to apply various business-specific rules (see the travel website described in the Example section).</span></span>

<span data-ttu-id="d4627-120">Se uma operação que implementa a consistência eventual abrange vários armazenamentos de dados heterogêneos, desfazer as etapas na operação exige visitar cada armazenamento de dados por vez.</span><span class="sxs-lookup"><span data-stu-id="d4627-120">If an operation that implements eventual consistency spans several heterogeneous data stores, undoing the steps in the operation will require visiting each data store in turn.</span></span> <span data-ttu-id="d4627-121">O trabalho realizado em cada armazenamento de dados deve ser desfeito de forma confiável para impedir que o sistema permaneça divergente.</span><span class="sxs-lookup"><span data-stu-id="d4627-121">The work performed in every data store must be undone reliably to prevent the system from remaining inconsistent.</span></span>

<span data-ttu-id="d4627-122">Nem todos os dados afetados por uma operação que implementa a consistência eventual podem ser mantidos em um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d4627-122">Not all data affected by an operation that implements eventual consistency might be held in a database.</span></span> <span data-ttu-id="d4627-123">Em um ambiente de arquitetura SOA uma operação poderia invocar uma ação em um serviço e causar uma alteração no estado mantido por esse serviço.</span><span class="sxs-lookup"><span data-stu-id="d4627-123">In a service oriented architecture (SOA) environment an operation could invoke an action in a service, and cause a change in the state held by that service.</span></span> <span data-ttu-id="d4627-124">Para desfazer a operação, essa alteração de estado também deverá ser desfeita.</span><span class="sxs-lookup"><span data-stu-id="d4627-124">To undo the operation, this state change must also be undone.</span></span> <span data-ttu-id="d4627-125">Isso pode envolver invocar o serviço novamente e executar outra ação que reverte os efeitos da primeira.</span><span class="sxs-lookup"><span data-stu-id="d4627-125">This can involve invoking the service again and performing another action that reverses the effects of the first.</span></span>

## <a name="solution"></a><span data-ttu-id="d4627-126">Solução</span><span class="sxs-lookup"><span data-stu-id="d4627-126">Solution</span></span>

<span data-ttu-id="d4627-127">A solução é implementar uma transação de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-127">The solution is to implement a compensating transaction.</span></span> <span data-ttu-id="d4627-128">As etapas em uma transação de compensação devem desfazer os efeitos das etapas na operação original.</span><span class="sxs-lookup"><span data-stu-id="d4627-128">The steps in a compensating transaction must undo the effects of the steps in the original operation.</span></span> <span data-ttu-id="d4627-129">Uma transação de compensação não poderá simplesmente substituir o estado atual pelo estado em que o sistema estava no início da operação porque essa abordagem poderia substituir as alterações feitas por outras instâncias simultâneas de um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d4627-129">A compensating transaction might not be able to simply replace the current state with the state the system was in at the start of the operation because this approach could overwrite changes made by other concurrent instances of an application.</span></span> <span data-ttu-id="d4627-130">Em vez disso, ele deve ser um processo inteligente que leva em conta a qualquer trabalho realizado por instâncias simultâneas.</span><span class="sxs-lookup"><span data-stu-id="d4627-130">Instead, it must be an intelligent process that takes into account any work done by concurrent instances.</span></span> <span data-ttu-id="d4627-131">Esse processo geralmente será específico do aplicativo, acompanhando a natureza do trabalho realizado pela operação original.</span><span class="sxs-lookup"><span data-stu-id="d4627-131">This process will usually be application specific, driven by the nature of the work performed by the original operation.</span></span>

<span data-ttu-id="d4627-132">Uma abordagem comum é usar um fluxo de trabalho para implementar uma operação eventualmente consistente que exige compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-132">A common approach is to use a workflow to implement an eventually consistent operation that requires compensation.</span></span> <span data-ttu-id="d4627-133">À medida que a operação original prossegue, o sistema registra informações sobre cada etapa e como o trabalho executado pela etapa pode ser desfeito.</span><span class="sxs-lookup"><span data-stu-id="d4627-133">As the original operation proceeds, the system records information about each step and how the work performed by that step can be undone.</span></span> <span data-ttu-id="d4627-134">Se a operação falhar em qualquer ponto, o fluxo de trabalho retrocede as etapas concluídas e executa o trabalho que reverte cada etapa.</span><span class="sxs-lookup"><span data-stu-id="d4627-134">If the operation fails at any point, the workflow rewinds back through the steps it's completed and performs the work that reverses each step.</span></span> <span data-ttu-id="d4627-135">Observe que uma transação de compensação pode não precisar desfazer o trabalho na ordem inversa exata da operação original e pode ser possível realizar algumas das etapas de reversão em paralelo.</span><span class="sxs-lookup"><span data-stu-id="d4627-135">Note that a compensating transaction might not have to undo the work in the exact reverse order of the original operation, and it might be possible to perform some of the undo steps in parallel.</span></span>

> <span data-ttu-id="d4627-136">Essa abordagem é semelhante à estratégia do Sagas discutida no [blog de Clemens Vasters](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span><span class="sxs-lookup"><span data-stu-id="d4627-136">This approach is similar to the Sagas strategy discussed in [Clemens Vasters’ blog](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span></span>

<span data-ttu-id="d4627-137">Uma transação de compensação também é uma operação eventualmente consistente e ela também poderia falhar.</span><span class="sxs-lookup"><span data-stu-id="d4627-137">A compensating transaction is also an eventually consistent operation and it could also fail.</span></span> <span data-ttu-id="d4627-138">O sistema deve ser capaz de retomar a transação de compensação no ponto de falha e continuar.</span><span class="sxs-lookup"><span data-stu-id="d4627-138">The system should be able to resume the compensating transaction at the point of failure and continue.</span></span> <span data-ttu-id="d4627-139">Pode ser necessário repetir uma etapa que falhou, portanto as etapas em uma transação de compensação devem ser definidas como comandos idempotentes.</span><span class="sxs-lookup"><span data-stu-id="d4627-139">It might be necessary to repeat a step that's failed, so the steps in a compensating transaction should be defined as idempotent commands.</span></span> <span data-ttu-id="d4627-140">Para obter mais informações, consulte [Padrões de idempotência](https://blog.jonathanoliver.com/idempotency-patterns/) no blog de Jonathan Oliver.</span><span class="sxs-lookup"><span data-stu-id="d4627-140">For more information, see [Idempotency Patterns](https://blog.jonathanoliver.com/idempotency-patterns/) on Jonathan Oliver’s blog.</span></span>

<span data-ttu-id="d4627-141">Em alguns casos, pode não ser possível recuperar de uma etapa com falha, exceto por meio de intervenção manual.</span><span class="sxs-lookup"><span data-stu-id="d4627-141">In some cases it might not be possible to recover from a step that has failed except through manual intervention.</span></span> <span data-ttu-id="d4627-142">Nessas situações, o sistema deve acionar um alerta e fornecer o máximo possível de informações sobre o motivo da falha.</span><span class="sxs-lookup"><span data-stu-id="d4627-142">In these situations the system should raise an alert and provide as much information as possible about the reason for the failure.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="d4627-143">Problemas e considerações</span><span class="sxs-lookup"><span data-stu-id="d4627-143">Issues and considerations</span></span>

<span data-ttu-id="d4627-144">Considere os seguintes pontos ao decidir como implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="d4627-144">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="d4627-145">Pode ser difícil determinar quando uma etapa em uma operação que implementa a consistência eventual falhou.</span><span class="sxs-lookup"><span data-stu-id="d4627-145">It might not be easy to determine when a step in an operation that implements eventual consistency has failed.</span></span> <span data-ttu-id="d4627-146">Uma etapa não pode falhar imediatamente sendo, em vez disso, bloqueada.</span><span class="sxs-lookup"><span data-stu-id="d4627-146">A step might not fail immediately, but instead could block.</span></span> <span data-ttu-id="d4627-147">Pode ser necessário implementar algum mecanismo de tempo limite.</span><span class="sxs-lookup"><span data-stu-id="d4627-147">It might be necessary to implement some form of time-out mechanism.</span></span>

<span data-ttu-id="d4627-148">-A lógica de compensação não é facilmente generalizada.</span><span class="sxs-lookup"><span data-stu-id="d4627-148">-Compensation logic isn't easily generalized.</span></span> <span data-ttu-id="d4627-149">Uma transação de compensação é específica do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d4627-149">A compensating transaction is application specific.</span></span> <span data-ttu-id="d4627-150">Ele se baseia no aplicativo ter informações suficientes para poder desfazer os efeitos de cada etapa em uma operação com falha.</span><span class="sxs-lookup"><span data-stu-id="d4627-150">It relies on the application having sufficient information to be able to undo the effects of each step in a failed operation.</span></span>

<span data-ttu-id="d4627-151">Você deve definir as etapas em uma transação de compensação como comandos idempotentes.</span><span class="sxs-lookup"><span data-stu-id="d4627-151">You should define the steps in a compensating transaction as idempotent commands.</span></span> <span data-ttu-id="d4627-152">Isso permite que as etapas sejam repetidas se a própria transação de compensação falhar.</span><span class="sxs-lookup"><span data-stu-id="d4627-152">This enables the steps to be repeated if the compensating transaction itself fails.</span></span>

<span data-ttu-id="d4627-153">A infraestrutura que manipula as etapas da operação original, bem como a transação de compensação, deve ser resiliente.</span><span class="sxs-lookup"><span data-stu-id="d4627-153">The infrastructure that handles the steps in the original operation, and the compensating transaction, must be resilient.</span></span> <span data-ttu-id="d4627-154">É preciso que ela não perca as informações necessárias para compensar uma etapa que falhou e deve ser capaz monitorar o progresso da lógica de compensação de forma confiável.</span><span class="sxs-lookup"><span data-stu-id="d4627-154">It must not lose the information required to compensate for a failing step, and it must be able to reliably monitor the progress of the compensation logic.</span></span>

<span data-ttu-id="d4627-155">Uma transação de compensação não necessariamente retorna os dados no sistema para o estado em que ele estava no início da operação original.</span><span class="sxs-lookup"><span data-stu-id="d4627-155">A compensating transaction doesn't necessarily return the data in the system to the state it was in at the start of the original operation.</span></span> <span data-ttu-id="d4627-156">Em vez disso, ela compensa o trabalho realizado pelas etapas concluídas com êxito antes da operação falhar.</span><span class="sxs-lookup"><span data-stu-id="d4627-156">Instead, it compensates for the work performed by the steps that completed successfully before the operation failed.</span></span>

<span data-ttu-id="d4627-157">A ordem das etapas de transações de compensação não precisa necessariamente ser o oposto exato das etapas na operação original.</span><span class="sxs-lookup"><span data-stu-id="d4627-157">The order of the steps in the compensating transaction doesn't necessarily have to be the exact opposite of the steps in the original operation.</span></span> <span data-ttu-id="d4627-158">Por exemplo, um armazenamento de dados pode ser mais suscetível a inconsistências que outro, portanto as etapas na transação de compensação que desfazem as alterações neste repositório devem ocorrer primeiro.</span><span class="sxs-lookup"><span data-stu-id="d4627-158">For example, one data store might be more sensitive to inconsistencies than another, and so the steps in the compensating transaction that undo the changes to this store should occur first.</span></span>

<span data-ttu-id="d4627-159">Colocar um bloqueio de curto prazo baseado em tempo limite em cada recurso necessário para concluir uma operação e obter esses recursos com antecedência, pode ajudar a aumentar a probabilidade de que a atividade geral tenha êxito.</span><span class="sxs-lookup"><span data-stu-id="d4627-159">Placing a short-term timeout-based lock on each resource that's required to complete an operation, and obtaining these resources in advance, can help increase the likelihood that the overall activity will succeed.</span></span> <span data-ttu-id="d4627-160">O trabalho deverá ser executado somente depois que todos os recursos forem adquiridos.</span><span class="sxs-lookup"><span data-stu-id="d4627-160">The work should be performed only after all the resources have been acquired.</span></span> <span data-ttu-id="d4627-161">Todas as ações devem ser finalizadas antes dos bloqueios expirarem.</span><span class="sxs-lookup"><span data-stu-id="d4627-161">All actions must be finalized before the locks expire.</span></span>

<span data-ttu-id="d4627-162">Considere usar lógica de repetição mais tolerante que o normal para minimizar falhas que disparam uma transação de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-162">Consider using retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction.</span></span> <span data-ttu-id="d4627-163">Se uma etapa em uma operação que implementa a consistência eventual falhar, tente tratar a falha como uma exceção transitória e repita a etapa.</span><span class="sxs-lookup"><span data-stu-id="d4627-163">If a step in an operation that implements eventual consistency fails, try handling the failure as a transient exception and repeat the step.</span></span> <span data-ttu-id="d4627-164">Apenas pare a operação e inicie uma transação de compensação se uma etapa falhar repetidamente ou de forma irrecuperável.</span><span class="sxs-lookup"><span data-stu-id="d4627-164">Only stop the operation and initiate a compensating transaction if a step fails repeatedly or irrecoverably.</span></span>

> <span data-ttu-id="d4627-165">Muitos dos desafios da implementação de uma transação de compensação são iguais aos da implementação de consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="d4627-165">Many of the challenges of implementing a compensating transaction are the same as those with implementing eventual consistency.</span></span> <span data-ttu-id="d4627-166">Consulte a seção Considerações para implementar a consistência eventual no [Primer de consistência de dados](https://msdn.microsoft.com/library/dn589800.aspx) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="d4627-166">See the section Considerations for Implementing Eventual Consistency in the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for more information.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="d4627-167">Quando usar esse padrão</span><span class="sxs-lookup"><span data-stu-id="d4627-167">When to use this pattern</span></span>

<span data-ttu-id="d4627-168">Use este padrão apenas para operações que devem ser desfeitas se elas falharem.</span><span class="sxs-lookup"><span data-stu-id="d4627-168">Use this pattern only for operations that must be undone if they fail.</span></span> <span data-ttu-id="d4627-169">Se possível, crie soluções para evitar a complexidade de exigir transações de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-169">If possible, design solutions to avoid the complexity of requiring compensating transactions.</span></span>

## <a name="example"></a><span data-ttu-id="d4627-170">Exemplo</span><span class="sxs-lookup"><span data-stu-id="d4627-170">Example</span></span>

<span data-ttu-id="d4627-171">Um site de viagem permite que os clientes reservem roteiro.</span><span class="sxs-lookup"><span data-stu-id="d4627-171">A travel website lets customers book itineraries.</span></span> <span data-ttu-id="d4627-172">Um único roteiro pode ser composto por uma série de voos e hotéis.</span><span class="sxs-lookup"><span data-stu-id="d4627-172">A single itinerary might comprise a series of flights and hotels.</span></span> <span data-ttu-id="d4627-173">Um cliente que viaja de Seattle para Londres e depois para Paris poderia executar as seguintes etapas ao criar um roteiro:</span><span class="sxs-lookup"><span data-stu-id="d4627-173">A customer traveling from Seattle to London and then on to Paris could perform the following steps when creating an itinerary:</span></span>

1. <span data-ttu-id="d4627-174">Reservar um assento no voo F1 de Seattle para Londres.</span><span class="sxs-lookup"><span data-stu-id="d4627-174">Book a seat on flight F1 from Seattle to London.</span></span>
2. <span data-ttu-id="d4627-175">Reservar um assento no voo F2 de Londres para Paris.</span><span class="sxs-lookup"><span data-stu-id="d4627-175">Book a seat on flight F2 from London to Paris.</span></span>
3. <span data-ttu-id="d4627-176">Reservar um assento no voo F3 de Paris para Seattle.</span><span class="sxs-lookup"><span data-stu-id="d4627-176">Book a seat on flight F3 from Paris to Seattle.</span></span>
4. <span data-ttu-id="d4627-177">Reserve um quarto no hotel H1 em Londres.</span><span class="sxs-lookup"><span data-stu-id="d4627-177">Reserve a room at hotel H1 in London.</span></span>
5. <span data-ttu-id="d4627-178">Reserve um quarto no hotel H2 em Paris.</span><span class="sxs-lookup"><span data-stu-id="d4627-178">Reserve a room at hotel H2 in Paris.</span></span>

<span data-ttu-id="d4627-179">Essas etapas constituem uma operação eventualmente consistente, embora cada uma delas seja uma ação separada.</span><span class="sxs-lookup"><span data-stu-id="d4627-179">These steps constitute an eventually consistent operation, although each step is a separate action.</span></span> <span data-ttu-id="d4627-180">Portanto, além de executar essas etapas, o sistema deve também registrar as operações de contador necessárias para desfazer cada etapa caso o cliente decida cancelar o roteiro.</span><span class="sxs-lookup"><span data-stu-id="d4627-180">Therefore, as well as performing these steps, the system must also record the counter operations necessary to undo each step in case the customer decides to cancel the itinerary.</span></span> <span data-ttu-id="d4627-181">As etapas necessárias para executar as operações de contador podem então ser executadas como uma transação de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-181">The steps necessary to perform the counter operations can then run as a compensating transaction.</span></span>

<span data-ttu-id="d4627-182">Observe que as etapas na transação de compensação podem não ser o oposto exato das etapas originais e a lógica de cada etapa na transação de compensação deve levar em conta as regras específicas de negócios.</span><span class="sxs-lookup"><span data-stu-id="d4627-182">Notice that the steps in the compensating transaction might not be the exact opposite of the original steps, and the logic in each step in the compensating transaction must take into account any business-specific rules.</span></span> <span data-ttu-id="d4627-183">Por exemplo, cancelar a reserva de um voo pode não conceder ao cliente um reembolso completo do valor pago.</span><span class="sxs-lookup"><span data-stu-id="d4627-183">For example, unbooking a seat on a flight might not entitle the customer to a complete refund of any money paid.</span></span> <span data-ttu-id="d4627-184">A figura ilustra a criação de uma transação de compensação para desfazer uma transação de execução longa para reservar um roteiro de viagem.</span><span class="sxs-lookup"><span data-stu-id="d4627-184">The figure illustrates generating a compensating transaction to undo a long-running transaction to book a travel itinerary.</span></span>

![Criar uma transação de compensação para desfazer uma transação de execução longa para reservar um roteiro de viagem](./_images/compensating-transaction-diagram.png)

> [!NOTE]
> <span data-ttu-id="d4627-186">Pode ser possível que as etapas na transação de compensação sejam executadas em paralelo, dependendo de como você criou a lógica de compensação para cada etapa.</span><span class="sxs-lookup"><span data-stu-id="d4627-186">It might be possible for the steps in the compensating transaction to be performed in parallel, depending on how you've designed the compensating logic for each step.</span></span>

<span data-ttu-id="d4627-187">Em muitas soluções de negócios, a falha de uma única etapa não exige a reversão do sistema usando uma transação de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-187">In many business solutions, failure of a single step doesn't always necessitate rolling the system back by using a compensating transaction.</span></span> <span data-ttu-id="d4627-188">Por exemplo, se &mdash; após ter reservado os voos F1, F2 e F3 no cenário de site de viagem&mdash; o cliente não puder reservar um quarto no hotel H1, é preferível oferecer ao cliente um quarto em um hotel diferente na mesma cidade em vez de cancelar os voos.</span><span class="sxs-lookup"><span data-stu-id="d4627-188">For example, if&mdash;after having booked flights F1, F2, and F3 in the travel website scenario&mdash;the customer is unable to reserve a room at hotel H1, it's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights.</span></span> <span data-ttu-id="d4627-189">O cliente ainda pode optar por cancelar (quando então a transação de compensação é executada e desfaz as reservas feitas nos voos F1, F2 e F3), mas essa decisão deve ser feita pelo cliente e não pelo sistema.</span><span class="sxs-lookup"><span data-stu-id="d4627-189">The customer can still decide to cancel (in which case the compensating transaction runs and undoes the bookings made on flights F1, F2, and F3), but this decision should be made by the customer rather than by the system.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="d4627-190">Diretrizes e padrões relacionados</span><span class="sxs-lookup"><span data-stu-id="d4627-190">Related patterns and guidance</span></span>

<span data-ttu-id="d4627-191">Os padrões e diretrizes a seguir também podem ser relevantes ao implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="d4627-191">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="d4627-192">[Primer de Consistência de Dados](https://msdn.microsoft.com/library/dn589800.aspx).</span><span class="sxs-lookup"><span data-stu-id="d4627-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="d4627-193">O padrão de Transações de Compensação geralmente é usado para desfazer operações que implementam o modelo de consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="d4627-193">The Compensating Transaction pattern is often used to undo operations that implement the eventual consistency model.</span></span> <span data-ttu-id="d4627-194">Esse primer fornece informações sobre as vantagens e desvantagens da consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="d4627-194">This primer provides information on the benefits and tradeoffs of eventual consistency.</span></span>

- <span data-ttu-id="d4627-195">[Padrão Agendador-Agente-Supervisor](./scheduler-agent-supervisor.md).</span><span class="sxs-lookup"><span data-stu-id="d4627-195">[Scheduler-Agent-Supervisor pattern](./scheduler-agent-supervisor.md).</span></span> <span data-ttu-id="d4627-196">Descreve como implementar sistemas resilientes que executam operações de negócios que usam recursos e serviços distribuídos.</span><span class="sxs-lookup"><span data-stu-id="d4627-196">Describes how to implement resilient systems that perform business operations that use distributed services and resources.</span></span> <span data-ttu-id="d4627-197">Às vezes, pode ser necessário desfazer o trabalho executado por uma operação usando uma transação de compensação.</span><span class="sxs-lookup"><span data-stu-id="d4627-197">Sometimes, it might be necessary to undo the work performed by an operation by using a compensating transaction.</span></span>

- <span data-ttu-id="d4627-198">[Padrão de repetição](./retry.md).</span><span class="sxs-lookup"><span data-stu-id="d4627-198">[Retry pattern](./retry.md).</span></span> <span data-ttu-id="d4627-199">Pode ser caro executar as transações de compensação, por isso pode ser possível minimizar seu uso com a implementação de uma política efetiva de repetição de operações com falha seguindo o Padrão de repetição.</span><span class="sxs-lookup"><span data-stu-id="d4627-199">Compensating transactions can be expensive to perform, and it might be possible to minimize their use by implementing an effective policy of retrying failing operations by following the Retry pattern.</span></span>

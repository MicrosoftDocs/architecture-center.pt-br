---
title: Valet Key
description: Use um token ou chave que fornece aos clientes acesso direto e restrito a um determinado recurso ou serviço.
keywords: padrão de design
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- data-management
- security
ms.openlocfilehash: 791132eabf926cc285567454c60f894efa286433
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/14/2017
ms.locfileid: "24542034"
---
# <a name="valet-key-pattern"></a><span data-ttu-id="2237d-104">Padrão Valet Key</span><span class="sxs-lookup"><span data-stu-id="2237d-104">Valet Key pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="2237d-105">Use um token que fornece aos clientes acesso direto e restrito a um recurso específico, para descarregar a transferência de dados do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2237d-105">Use a token that provides clients with restricted direct access to a specific resource, in order to offload data transfer from the application.</span></span> <span data-ttu-id="2237d-106">Isso é particularmente útil em aplicativos que utilizam filas ou sistemas de armazenamento hospedados na nuvem e podem minimizar custos e maximizar a escalabilidade e o desempenho.</span><span class="sxs-lookup"><span data-stu-id="2237d-106">This is particularly useful in applications that use cloud-hosted storage systems or queues, and can minimize cost and maximize scalability and performance.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="2237d-107">Contexto e problema</span><span class="sxs-lookup"><span data-stu-id="2237d-107">Context and problem</span></span>

<span data-ttu-id="2237d-108">Programas cliente e navegadores da Web geralmente precisam ler e gravar arquivos ou fluxos de dados para e do armazenamento de um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2237d-108">Client programs and web browsers often need to read and write files or data streams to and from an application’s storage.</span></span> <span data-ttu-id="2237d-109">Normalmente, o aplicativo irá tratar o movimento dos dados &mdash;, seja buscando-o do armazenamento e transmitido-o por streaming para o cliente, ou lendo o fluxo carregado do cliente e armazenando-o no armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-109">Typically, the application will handle the movement of the data &mdash; either by fetching it from storage and streaming it to the client, or by reading the uploaded stream from the client and storing it in the data store.</span></span> <span data-ttu-id="2237d-110">No entanto, essa abordagem absorve recursos valiosos, como computação, memória e largura de banda.</span><span class="sxs-lookup"><span data-stu-id="2237d-110">However, this approach absorbs valuable resources such as compute, memory, and bandwidth.</span></span>

<span data-ttu-id="2237d-111">Os repositórios de dados têm a capacidade de tratar o upload e download de dados diretamente, sem exigir que o aplicativo execute qualquer processamento para mover esses dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-111">Data stores have the ability to handle upload and download of data directly, without requiring that the application perform any processing to move this data.</span></span> <span data-ttu-id="2237d-112">Mas, isso normalmente exige que o cliente tenha acesso às credenciais de segurança do repositório.</span><span class="sxs-lookup"><span data-stu-id="2237d-112">But, this typically requires the client to have access to the security credentials for the store.</span></span> <span data-ttu-id="2237d-113">Essa pode ser uma técnica útil para minimizar os custos de transferência de dados e os requisitos para escalar horizontalmente o aplicativo e maximizar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="2237d-113">This can be a useful technique to minimize data transfer costs and the requirement to scale out the application, and to maximize performance.</span></span> <span data-ttu-id="2237d-114">Isso significa, porém, que o aplicativo não é mais capaz de gerenciar a segurança dos dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-114">It means, though, that the application is no longer able to manage the security of the data.</span></span> <span data-ttu-id="2237d-115">Depois que o cliente tiver uma conexão com o repositório de dados para acesso direto, o aplicativo não poderá agir como o gatekeeper.</span><span class="sxs-lookup"><span data-stu-id="2237d-115">After the client has a connection to the data store for direct access, the application can't act as the gatekeeper.</span></span> <span data-ttu-id="2237d-116">Pois já não estará mais no controle do processo e não poderá impedir de  fazer uploads ou downloads subsequentes do repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-116">It's no longer in control of the process and can't prevent subsequent uploads or downloads from the data store.</span></span>

<span data-ttu-id="2237d-117">Essa não é uma abordagem realista em sistemas distribuídos que precisam servir clientes não confiáveis.</span><span class="sxs-lookup"><span data-stu-id="2237d-117">This isn't a realistic approach in distributed systems that need to serve untrusted clients.</span></span> <span data-ttu-id="2237d-118">Em vez disso, os aplicativos devem poder controlar de forma segura o acesso aos dados de forma granular, mas ainda reduzir a carga no servidor configurando essa conexão e, em seguida, permitindo que o cliente se comunique diretamente com o repositório de dados para executar as operações de leitura ou gravação necessárias .</span><span class="sxs-lookup"><span data-stu-id="2237d-118">Instead, applications must be able to securely control access to data in a granular way, but still reduce the load on the server by setting up this connection and then allowing the client to communicate directly with the data store to perform the required read or write operations.</span></span>

## <a name="solution"></a><span data-ttu-id="2237d-119">Solução</span><span class="sxs-lookup"><span data-stu-id="2237d-119">Solution</span></span>

<span data-ttu-id="2237d-120">É necessário resolver o problema de controle de acesso a um repositório de dados, de maneira que o repositório não possa gerenciar a autenticação e autorização de clientes.</span><span class="sxs-lookup"><span data-stu-id="2237d-120">You need to resolve the problem of controlling access to a data store where the store can't manage authentication and authorization of clients.</span></span> <span data-ttu-id="2237d-121">Uma solução típica é restringir o acesso à conexão pública do repositório de dados e fornecer ao cliente uma chave ou token que possa ser validado pelo repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-121">One typical solution is to restrict access to the data store’s public connection and provide the client with a key or token that the data store can validate.</span></span>

<span data-ttu-id="2237d-122">Essa chave ou token geralmente é referido como uma valet key.</span><span class="sxs-lookup"><span data-stu-id="2237d-122">This key or token is usually referred to as a valet key.</span></span> <span data-ttu-id="2237d-123">Ele fornece acesso com limite de tempo a recursos específicos e permite apenas operações pré-definidas, como leitura e gravação para armazenamento ou filas, ou fazer o upload ou o download em um navegador da Web.</span><span class="sxs-lookup"><span data-stu-id="2237d-123">It provides time-limited access to specific resources and allows only predefined operations such as reading and writing to storage or queues, or uploading and downloading in a web browser.</span></span> <span data-ttu-id="2237d-124">Os aplicativos podem criar e emitir keys valet para dispositivos de cliente e navegadores da Web de forma rápida e fácil, permitindo que os clientes executem as operações necessárias sem exigir que o aplicativo trate diretamente a transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-124">Applications can create and issue valet keys to client devices and web browsers quickly and easily, allowing clients to perform the required operations without requiring the application to directly handle the data transfer.</span></span> <span data-ttu-id="2237d-125">Isso remove a sobrecarga de processamento e o impacto no desempenho e escalabilidade, a partir do aplicativo e do servidor.</span><span class="sxs-lookup"><span data-stu-id="2237d-125">This removes the processing overhead, and the impact on performance and scalability, from the application and the server.</span></span>

<span data-ttu-id="2237d-126">O cliente usa esse token para acessar um recurso específico no repositório de dados por apenas um período específico e com restrições específicas nas permissões de acesso, conforme mostrado na figura.</span><span class="sxs-lookup"><span data-stu-id="2237d-126">The client uses this token to access a specific resource in the data store for only a specific period, and with specific restrictions on access permissions, as shown in the figure.</span></span> <span data-ttu-id="2237d-127">Após o período especificado, a chave torna-se inválida e não permitirá o acesso ao recurso.</span><span class="sxs-lookup"><span data-stu-id="2237d-127">After the specified period, the key becomes invalid and won't allow access to the resource.</span></span>

![Figura 1 - Visão geral do padrão](./_images/valet-key-pattern.png)

<span data-ttu-id="2237d-129">Também é possível configurar uma chave que tenha outras dependências, como o escopo dos dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-129">It's also possible to configure a key that has other dependencies, such as the scope of the data.</span></span> <span data-ttu-id="2237d-130">Por exemplo, dependendo dos recursos do repositório de dados, a chave pode especificar uma tabela completa em um repositório de dados ou apenas as linhas específicas em uma tabela.</span><span class="sxs-lookup"><span data-stu-id="2237d-130">For example, depending on the data store capabilities, the key can specify a complete table in a data store, or only specific rows in a table.</span></span> <span data-ttu-id="2237d-131">Nos sistemas de armazenamento em nuvem, a chave pode especificar um contêiner ou apenas um item específico dentro de um contêiner.</span><span class="sxs-lookup"><span data-stu-id="2237d-131">In cloud storage systems the key can specify a container, or just a specific item within a container.</span></span>

<span data-ttu-id="2237d-132">A chave também pode ser invalidada pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2237d-132">The key can also be invalidated by the application.</span></span> <span data-ttu-id="2237d-133">Essa é uma abordagem útil se o cliente notificar o servidor que a operação de transferência de dados está completa.</span><span class="sxs-lookup"><span data-stu-id="2237d-133">This is a useful approach if the client notifies the server that the data transfer operation is complete.</span></span> <span data-ttu-id="2237d-134">O servidor poderá, então, invalidar essa chave para evitar transferência adicional.</span><span class="sxs-lookup"><span data-stu-id="2237d-134">The server can then invalidate that key to prevent further.</span></span>

<span data-ttu-id="2237d-135">Usar esse padrão pode simplificar o gerenciamento de acesso aos recursos, porque não há necessidade de criar e autenticar um usuário, conceder permissões e, posteriormente, remover o usuário novamente.</span><span class="sxs-lookup"><span data-stu-id="2237d-135">Using this pattern can simplify managing access to resources because there's no requirement to create and authenticate a user, grant permissions, and then remove the user again.</span></span> <span data-ttu-id="2237d-136">Isso também facilita limitar a localização, a permissão e do período de validade&mdash;, simplesmente gerando uma chave no tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="2237d-136">It also makes it easy to limit the location, the permission, and the validity period&mdash;all by simply generating a key at runtime.</span></span> <span data-ttu-id="2237d-137">Os fatores importantes são para limitar o período de validade e especialmente a localização do recurso, tão rigorosamente o quanto possível para que o destinatário possa usá-la apenas para o propósito pretendido.</span><span class="sxs-lookup"><span data-stu-id="2237d-137">The important factors are to limit the validity period, and especially the location of the resource, as tightly as possible so that the recipient can only use it for the intended purpose.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="2237d-138">Problemas e considerações</span><span class="sxs-lookup"><span data-stu-id="2237d-138">Issues and considerations</span></span>

<span data-ttu-id="2237d-139">Considere os seguintes pontos ao decidir como implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="2237d-139">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="2237d-140">**Gerenciar o status de validade e o período da chave**.</span><span class="sxs-lookup"><span data-stu-id="2237d-140">**Manage the validity status and period of the key**.</span></span> <span data-ttu-id="2237d-141">Se vazada ou comprometida, a chave efetivamente desbloqueará o item de destino e o disponibilizará para uso malicioso durante o período de validade.</span><span class="sxs-lookup"><span data-stu-id="2237d-141">If leaked or compromised, the key effectively unlocks the target item and makes it available for malicious use during the validity period.</span></span> <span data-ttu-id="2237d-142">Uma chave geralmente pode ser revogada ou desabilitada, dependendo de como foi emitida.</span><span class="sxs-lookup"><span data-stu-id="2237d-142">A key can usually be revoked or disabled, depending on how it was issued.</span></span> <span data-ttu-id="2237d-143">As políticas do servidor podem ser alteradas ou a chave do servidor, com a qual foi assinada, pode ser invalidada.</span><span class="sxs-lookup"><span data-stu-id="2237d-143">Server-side policies can be changed or, the server key it was signed with can be invalidated.</span></span> <span data-ttu-id="2237d-144">Especifique um período de validade curto para minimizar o risco de permitir que operações não autorizadas ocorram contra o repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-144">Specify a short validity period to minimize the risk of allowing unauthorized operations to take place against the data store.</span></span> <span data-ttu-id="2237d-145">No entanto, se o período de validade for muito curto, o cliente não poderá concluir a operação antes que a chave expire.</span><span class="sxs-lookup"><span data-stu-id="2237d-145">However, if the validity period is too short, the client might not be able to complete the operation before the key expires.</span></span> <span data-ttu-id="2237d-146">Permita que os usuários autorizados renovem a chave antes do período de validade expirar, caso sejam necessários múltiplos acessos ao recurso protegido.</span><span class="sxs-lookup"><span data-stu-id="2237d-146">Allow authorized users to renew the key before the validity period expires if multiple accesses to the protected resource are required.</span></span>

<span data-ttu-id="2237d-147">**Controle o nível de acesso que a chave fornecerá**.</span><span class="sxs-lookup"><span data-stu-id="2237d-147">**Control the level of access the key will provide**.</span></span> <span data-ttu-id="2237d-148">Normalmente, a chave deve permitir ao usuário executar apenas as ações necessárias para concluir a operação, como o acesso somente leitura se o cliente não puder fazer o upload de dados no repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-148">Typically, the key should allow the user to only perform the actions necessary to complete the operation, such as read-only access if the client shouldn't be able to upload data to the data store.</span></span> <span data-ttu-id="2237d-149">Para carregamentos de arquivos é comum especificar uma chave que forneça permissão somente gravação, assim como a localização e o período de validade.</span><span class="sxs-lookup"><span data-stu-id="2237d-149">For file uploads, it's common to specify a key that provides write-only permission, as well as the location and the validity period.</span></span> <span data-ttu-id="2237d-150">É fundamental especificar com precisão o recurso ou o conjunto de recursos ao qual a chave se aplica.</span><span class="sxs-lookup"><span data-stu-id="2237d-150">It's critical to accurately specify the resource or the set of resources to which the key applies.</span></span>

<span data-ttu-id="2237d-151">**Considere como controlar o comportamento dos usuários**.</span><span class="sxs-lookup"><span data-stu-id="2237d-151">**Consider how to control users’ behavior**.</span></span> <span data-ttu-id="2237d-152">A implementação desse padrão significa uma perda de controle sobre os recursos que os usuários possuem acesso.</span><span class="sxs-lookup"><span data-stu-id="2237d-152">Implementing this pattern means some loss of control over the resources users are granted access to.</span></span> <span data-ttu-id="2237d-153">O nível de controle que pode ser exercido é limitado pelos recursos das políticas e permissões disponíveis para o serviço ou o repositório de dados de destino.</span><span class="sxs-lookup"><span data-stu-id="2237d-153">The level of control that can be exerted is limited by the capabilities of the policies and permissions available for the service or the target data store.</span></span> <span data-ttu-id="2237d-154">Por exemplo, geralmente não é possível criar uma chave que limita o tamanho dos dados a serem gravados no armazenamento, ou o número de vezes que a chave pode ser usada para acessar um arquivo.</span><span class="sxs-lookup"><span data-stu-id="2237d-154">For example, it's usually not possible to create a key that limits the size of the data to be written to storage, or the number of times the key can be used to access a file.</span></span> <span data-ttu-id="2237d-155">Isso pode resultar em enormes custos inesperados para a transferência de dados, mesmo quando usado pelo cliente pretendido e podem ser causados por um erro no código que causa upload ou download repetido.</span><span class="sxs-lookup"><span data-stu-id="2237d-155">This can result in huge unexpected costs for data transfer, even when used by the intended client, and might be caused by an error in the code that causes repeated upload or download.</span></span> <span data-ttu-id="2237d-156">Para limitar o número de vezes que um arquivo pode ser carregado, sempre que possível, force o cliente a notificar o aplicativo quando uma operação for concluída.</span><span class="sxs-lookup"><span data-stu-id="2237d-156">To limit the number of times a file can be uploaded, where possible, force the client to notify the application when one operation has completed.</span></span> <span data-ttu-id="2237d-157">Por exemplo, alguns repositórios de dados aumentam os eventos que o código do aplicativo pode usar para monitorar as operações e controlar o comportamento do usuário.</span><span class="sxs-lookup"><span data-stu-id="2237d-157">For example, some data stores raise events the application code can use to monitor operations and control user behavior.</span></span> <span data-ttu-id="2237d-158">No entanto, é difícil exigir cotas para usuários individuais em um cenário multilocatário, onde a mesma chave é utilizada por todos os usuários de um locatário.</span><span class="sxs-lookup"><span data-stu-id="2237d-158">However, it's hard to enforce quotas for individual users in a multi-tenant scenario where the same key is used by all the users from one tenant.</span></span>

<span data-ttu-id="2237d-159">**Validar, e opcionalmente limpar, todos os dados carregados**.</span><span class="sxs-lookup"><span data-stu-id="2237d-159">**Validate, and optionally sanitize, all uploaded data**.</span></span> <span data-ttu-id="2237d-160">Um usuário mal-intencionado que obtenha acesso à chave poderá carregar dados projetados para comprometer o sistema.</span><span class="sxs-lookup"><span data-stu-id="2237d-160">A malicious user that gains access to the key could upload data designed to compromise the system.</span></span> <span data-ttu-id="2237d-161">Alternativamente, usuários autorizados podem carregar dados inválidos e, quando processados, poderão resultar em um erro ou falha no sistema.</span><span class="sxs-lookup"><span data-stu-id="2237d-161">Alternatively, authorized users might upload data that's invalid and, when processed, could result in an error or system failure.</span></span> <span data-ttu-id="2237d-162">Para proteger contra isso, assegure-se de que todos os dados carregados sejam validados e verificados quanto a conteúdo malicioso antes de serem utilizados.</span><span class="sxs-lookup"><span data-stu-id="2237d-162">To protect against this, ensure that all uploaded data is validated and checked for malicious content before use.</span></span>

<span data-ttu-id="2237d-163">**Auditar todas as operações**.</span><span class="sxs-lookup"><span data-stu-id="2237d-163">**Audit all operations**.</span></span> <span data-ttu-id="2237d-164">Muitos mecanismos baseados em chave podem registrar operações como uploads, downloads e falhas.</span><span class="sxs-lookup"><span data-stu-id="2237d-164">Many key-based mechanisms can log operations such as uploads, downloads, and failures.</span></span> <span data-ttu-id="2237d-165">Esses registros geralmente podem ser incorporados em um processo de auditoria e, também, utilizados para cobrança se o usuário for cobrado com base no tamanho do arquivo ou no volume de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-165">These logs can usually be incorporated into an audit process, and also used for billing if the user is charged based on file size or data volume.</span></span> <span data-ttu-id="2237d-166">Use os registros para detectar falhas de autenticação que podem ser causadas por problemas com o provedor de chave ou remoção acidental de uma política de acesso armazenada.</span><span class="sxs-lookup"><span data-stu-id="2237d-166">Use the logs to detect authentication failures that might be caused by issues with the key provider, or accidental removal of a stored access policy.</span></span>

<span data-ttu-id="2237d-167">**Entregar a chave com segurança**.</span><span class="sxs-lookup"><span data-stu-id="2237d-167">**Deliver the key securely**.</span></span> <span data-ttu-id="2237d-168">É possível ser inserida em uma URL que o usuário ativa em uma página da Web, ou pode ser utilizada em uma operação de redirecionamento do servidor para que o download ocorra automaticamente.</span><span class="sxs-lookup"><span data-stu-id="2237d-168">It can be embedded in a URL that the user activates in a web page, or it can be used in a server redirection operation so that the download occurs automatically.</span></span> <span data-ttu-id="2237d-169">Sempre use HTTPS para entregar a chave por um canal seguro.</span><span class="sxs-lookup"><span data-stu-id="2237d-169">Always use HTTPS to deliver the key over a secure channel.</span></span>

<span data-ttu-id="2237d-170">**Proteger dados confidenciais em trânsito**.</span><span class="sxs-lookup"><span data-stu-id="2237d-170">**Protect sensitive data in transit**.</span></span> <span data-ttu-id="2237d-171">Os dados confiáveis entregues através do aplicativo geralmente ocorrem usando SSL ou TLS e isso deve ser aplicado para clientes que acessem o repositório de dados diretamente.</span><span class="sxs-lookup"><span data-stu-id="2237d-171">Sensitive data delivered through the application will usually take place using SSL or TLS, and this should be enforced for clients accessing the data store directly.</span></span>

<span data-ttu-id="2237d-172">Outras questões a serem reconhecidas ao implementar esse padrão são:</span><span class="sxs-lookup"><span data-stu-id="2237d-172">Other issues to be aware of when implementing this pattern are:</span></span>

- <span data-ttu-id="2237d-173">Se o cliente não notificar o servidor da conclusão da operação, ou não puder fazê-la, e o único limite for o período de validade da chave, o aplicativo não poderá realizar operações de auditoria, tais como contar o número de uploads ou downloads, ou impedir múltiplos carregamentos ou downloads.</span><span class="sxs-lookup"><span data-stu-id="2237d-173">If the client doesn't, or can't, notify the server of completion of the operation, and the only limit is the expiration period of the key, the application won't be able to perform auditing operations such as counting the number of uploads or downloads, or preventing multiple uploads or downloads.</span></span>

- <span data-ttu-id="2237d-174">A flexibilidade das políticas de chave que podem ser geradas pode ser limitada.</span><span class="sxs-lookup"><span data-stu-id="2237d-174">The flexibility of key policies that can be generated might be limited.</span></span> <span data-ttu-id="2237d-175">Por exemplo, alguns mecanismos somente permitem o uso de um período de validade cronometrado.</span><span class="sxs-lookup"><span data-stu-id="2237d-175">For example, some mechanisms only allow the use of a timed expiration period.</span></span> <span data-ttu-id="2237d-176">Outros não são capazes de especificar uma granularidade suficiente de permissões de leitura/gravação.</span><span class="sxs-lookup"><span data-stu-id="2237d-176">Others aren't able to specify a sufficient granularity of read/write permissions.</span></span>

- <span data-ttu-id="2237d-177">Se a hora de início para o período de validade de chave ou token for especificada, assegure-se de que seja um pouco mais cedo do que o tempo atual do servidor para permitir que os relógios do cliente possam estar ligeiramente fora da sincronização.</span><span class="sxs-lookup"><span data-stu-id="2237d-177">If the start time for the key or token validity period is specified, ensure that it's a little earlier than the current server time to allow for client clocks that might be slightly out of synchronization.</span></span> <span data-ttu-id="2237d-178">O padrão, se não especificado, geralmente é o tempo atual do servidor.</span><span class="sxs-lookup"><span data-stu-id="2237d-178">The default, if not specified, is usually the current server time.</span></span>

- <span data-ttu-id="2237d-179">A URL que contém a chave será gravada em arquivos de log do servidor.</span><span class="sxs-lookup"><span data-stu-id="2237d-179">The URL containing the key will be recorded in server log files.</span></span> <span data-ttu-id="2237d-180">Embora a chave normalmente tenha expirado antes que os arquivos de log sejam utilizados para análise, assegure-se de limitar o acesso.</span><span class="sxs-lookup"><span data-stu-id="2237d-180">While the key will typically have expired before the log files are used for analysis, ensure that you limit access to them.</span></span> <span data-ttu-id="2237d-181">Se os dados de log forem transmitidos para um sistema de monitoramento ou armazenados em outro local, considere implementar um atraso para evitar vazamentos de chaves até que o período de validade tenha expirado.</span><span class="sxs-lookup"><span data-stu-id="2237d-181">If log data is transmitted to a monitoring system or stored in another location, consider implementing a delay to prevent leakage of keys until after their validity period has expired.</span></span>

- <span data-ttu-id="2237d-182">Se o código do cliente for executado em um navegador da Web, talvez o navegador precise suportar o CORS (Compartilhamento de Recursos entre Origens) para habilitar o código que executa dentro do navegador da Web para acessar dados em um domínio diferente daquele que atendia a página.</span><span class="sxs-lookup"><span data-stu-id="2237d-182">If the client code runs in a web browser, the browser might need to support cross-origin resource sharing (CORS) to enable code that executes within the web browser to access data in a different domain from the one that served the page.</span></span> <span data-ttu-id="2237d-183">Alguns navegadores mais antigos e alguns repositórios de dados não suportam o CORS e, o código que executa nesses navegadores pode usar uma valet key para fornecer o acesso para dados em um domínio diferente, como uma conta de armazenamento em nuvem.</span><span class="sxs-lookup"><span data-stu-id="2237d-183">Some older browsers and some data stores don't support CORS, and code that runs in these browsers might be able to use a valet key to provide access to data in a different domain, such as a cloud storage account.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="2237d-184">Quando usar esse padrão</span><span class="sxs-lookup"><span data-stu-id="2237d-184">When to use this pattern</span></span>

<span data-ttu-id="2237d-185">Esse padrão não é útil para as seguintes situações:</span><span class="sxs-lookup"><span data-stu-id="2237d-185">This pattern is useful for the following situations:</span></span>

- <span data-ttu-id="2237d-186">Minimizar o carregamento de recursos e maximizar o desempenho e a escalabilidade.</span><span class="sxs-lookup"><span data-stu-id="2237d-186">To minimize resource loading and maximize performance and scalability.</span></span> <span data-ttu-id="2237d-187">O uso de uma valet key não requer que o recurso seja bloqueado, nenhuma chamada remota do servidor é necessária, não há limite no número de valet keys que possam ser emitidas e evita um ponto único de falha resultante da execução da transferência de dados através do código do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2237d-187">Using a valet key doesn't require the resource to be locked, no remote server call is required, there's no limit on the number of valet keys that can be issued, and it avoids a single point of failure resulting from performing the data transfer through the application code.</span></span> <span data-ttu-id="2237d-188">Criar uma valet key é tipicamente uma operação criptográfica simples de autenticar uma cadeia de caracteres com uma chave.</span><span class="sxs-lookup"><span data-stu-id="2237d-188">Creating a valet key is typically a simple cryptographic operation of signing a string with a key.</span></span>

- <span data-ttu-id="2237d-189">Minimizar o custo operacional.</span><span class="sxs-lookup"><span data-stu-id="2237d-189">To minimize operational cost.</span></span> <span data-ttu-id="2237d-190">Permitir acesso direto a repositórios e filas é um recurso economicamente eficiente, podendo resultar em menos viagens de ida e volta da rede e permitir uma redução no número de recursos de computação necessários.</span><span class="sxs-lookup"><span data-stu-id="2237d-190">Enabling direct access to stores and queues is resource and cost efficient, can result in fewer network round trips, and might allow for a reduction in the number of compute resources required.</span></span>

- <span data-ttu-id="2237d-191">Quando os clientes fazem o upload ou download de dados regularmente, especialmente quando há um grande volume ou quando cada operação envolve arquivos grandes.</span><span class="sxs-lookup"><span data-stu-id="2237d-191">When clients regularly upload or download data, particularly where there's a large volume or when each operation involves large files.</span></span>

- <span data-ttu-id="2237d-192">Quando o aplicativo possui recursos de computação limitados disponíveis, devido a limitações de hospedagem ou considerações de custo.</span><span class="sxs-lookup"><span data-stu-id="2237d-192">When the application has limited compute resources available, either due to hosting limitations or cost considerations.</span></span> <span data-ttu-id="2237d-193">Nesse cenário, o padrão é ainda mais útil se houver muitos uploads ou downloads simultâneos de dados, pois alivia o aplicativo de tratar com a transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-193">In this scenario, the pattern is even more helpful if there are many concurrent data uploads or downloads because it relieves the application from handling the data transfer.</span></span>

- <span data-ttu-id="2237d-194">Quando os dados são armazenados em um repositório de dados remoto ou em um datacenter diferente.</span><span class="sxs-lookup"><span data-stu-id="2237d-194">When the data is stored in a remote data store or a different datacenter.</span></span> <span data-ttu-id="2237d-195">Se o aplicativo fosse necessário para agir como um gatekeeper, poderia haver uma cobrança pela largura de banda adicional da transferência de dados entre datacenters, ou entre redes públicas ou privadas entre o cliente e o aplicativo e, depois, entre o aplicativo e o repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-195">If the application was required to act as a gatekeeper, there might be a charge for the additional bandwidth of transferring the data between datacenters, or across public or private networks between the client and the application, and then between the application and the data store.</span></span>

<span data-ttu-id="2237d-196">Esse padrão pode não ser útil nas seguintes situações:</span><span class="sxs-lookup"><span data-stu-id="2237d-196">This pattern might not be useful in the following situations:</span></span>

- <span data-ttu-id="2237d-197">Se o aplicativo tiver que executar alguma tarefa nos dados antes de ser armazenado ou antes de ser enviado ao cliente.</span><span class="sxs-lookup"><span data-stu-id="2237d-197">If the application must perform some task on the data before it's stored or before it's sent to the client.</span></span> <span data-ttu-id="2237d-198">Por exemplo, se o aplicativo precisar executar a validação, acessar o log com êxito ou executar uma transformação nos dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-198">For example, if the application needs to perform validation, log access success, or execute a transformation on the data.</span></span> <span data-ttu-id="2237d-199">No entanto, alguns repositórios de dados e clientes são capazes de negociar e realizar transformações simples, como compactação e descompactação (por exemplo, um navegador da Web geralmente pode tratar formatos GZip).</span><span class="sxs-lookup"><span data-stu-id="2237d-199">However, some data stores and clients are able to negotiate and carry out simple transformations such as compression and decompression (for example, a web browser can usually handle GZip formats).</span></span>

- <span data-ttu-id="2237d-200">Se o design de um aplicativo existente dificulta a incorporação do padrão.</span><span class="sxs-lookup"><span data-stu-id="2237d-200">If the design of an existing application makes it difficult to incorporate the pattern.</span></span> <span data-ttu-id="2237d-201">O uso deste padrão normalmente requer uma abordagem arquitetônica diferente para entregar e receber dados.</span><span class="sxs-lookup"><span data-stu-id="2237d-201">Using this pattern typically requires a different architectural approach for delivering and receiving data.</span></span>

- <span data-ttu-id="2237d-202">Se for necessário manter trilhas de auditoria ou controlar o número de vezes que uma operação de transferência de dados é executada e o mecanismo de valet key em uso não fornece suporte para notificações que o servidor pode usar para gerenciar essas operações.</span><span class="sxs-lookup"><span data-stu-id="2237d-202">If it's necessary to maintain audit trails or control the number of times a data transfer operation is executed, and the valet key mechanism in use doesn't support notifications that the server can use to manage these operations.</span></span>

- <span data-ttu-id="2237d-203">Se for necessário limitar o tamanho dos dados, especialmente durante as operações de upload.</span><span class="sxs-lookup"><span data-stu-id="2237d-203">If it's necessary to limit the size of the data, especially during upload operations.</span></span> <span data-ttu-id="2237d-204">A única solução para isso é que o aplicativo verifique o tamanho dos dados após a conclusão da operação ou verifique o tamanho dos uploads após um período especificado ou com base em um agendamento.</span><span class="sxs-lookup"><span data-stu-id="2237d-204">The only solution to this is for the application to check the data size after the operation is complete, or check the size of uploads after a specified period or on a scheduled basis.</span></span>

## <a name="example"></a><span data-ttu-id="2237d-205">Exemplo</span><span class="sxs-lookup"><span data-stu-id="2237d-205">Example</span></span>

<span data-ttu-id="2237d-206">O Azure fornece suporte a assinaturas de acesso compartilhado no Armazenamento do Microsoft Azure para o controle de acesso granular para dados em blobs, tabelas e filas e para filas e tópicos do Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="2237d-206">Azure supports shared access signatures on Azure Storage for granular access control to data in blobs, tables, and queues, and for Service Bus queues and topics.</span></span> <span data-ttu-id="2237d-207">Um token de assinatura de acesso compartilhado pode ser configurado para fornecer direitos de acesso específicos, como ler, escrever, atualizar e excluir em uma tabela específica; um intervalo chaves dentro de uma tabela; uma fila; um blob; ou um contêiner de blob.</span><span class="sxs-lookup"><span data-stu-id="2237d-207">A shared access signature token can be configured to provide specific access rights such as read, write, update, and delete to a specific table; a key range within a table; a queue; a blob; or a blob container.</span></span> <span data-ttu-id="2237d-208">A validade pode ser um período de tempo especificado ou sem limite de tempo.</span><span class="sxs-lookup"><span data-stu-id="2237d-208">The validity can be a specified time period or with no time limit.</span></span>

<span data-ttu-id="2237d-209">As assinaturas de acesso compartilhado do Azure também fornecem suporte a políticas de acesso armazenadas em servidor que podem ser associadas a um recurso específico, como uma tabela ou blob.</span><span class="sxs-lookup"><span data-stu-id="2237d-209">Azure shared access signatures also support server-stored access policies that can be associated with a specific resource such as a table or blob.</span></span> <span data-ttu-id="2237d-210">Esse recurso fornece controle e flexibilidade adicionais em comparação com tokens de assinatura de acesso compartilhado gerado por aplicativos e deve ser usado sempre que possível.</span><span class="sxs-lookup"><span data-stu-id="2237d-210">This feature provides additional control and flexibility compared to application-generated shared access signature tokens, and should be used whenever possible.</span></span> <span data-ttu-id="2237d-211">As configurações definidas em uma política armazenada em servidor podem ser alteradas e são refletidas no token sem requerer que um novo token seja emitido, mas, as configurações definidas no token não podem ser alteradas sem emitir um novo token.</span><span class="sxs-lookup"><span data-stu-id="2237d-211">Settings defined in a server-stored policy can be changed and are reflected in the token without requiring a new token to be issued, but settings defined in the token can't be changed without issuing a new token.</span></span> <span data-ttu-id="2237d-212">Essa abordagem também permite revogar um token de assinatura de acesso compartilhado válido antes de expirar.</span><span class="sxs-lookup"><span data-stu-id="2237d-212">This approach also makes it possible to revoke a valid shared access signature token before it's expired.</span></span>

> <span data-ttu-id="2237d-213">Para obter mais informações, consulte [Introdução à SAS (Assinatura de Acesso Compartilhado) de tabela, SAS de fila e atualização para SAS de Blob](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) e [Uso de assinaturas de acesso compartilhado](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/) no MSDN.</span><span class="sxs-lookup"><span data-stu-id="2237d-213">For more information see [Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) and [Using Shared Access Signatures](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/) on MSDN.</span></span>

<span data-ttu-id="2237d-214">O código a seguir mostra como criar um token de assinatura de acesso compartilhado válido por cinco minutos.</span><span class="sxs-lookup"><span data-stu-id="2237d-214">The following code shows how to create a shared access signature token that's valid for five minutes.</span></span> <span data-ttu-id="2237d-215">O método `GetSharedAccessReferenceForUpload` retorna um token de assinatura de acesso compartilhado que pode ser usado para carregar um arquivo para o Armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="2237d-215">The `GetSharedAccessReferenceForUpload` method returns a shared access signatures token that can be used to upload a file to Azure Blob Storage.</span></span>

```csharp
public class ValuesController : ApiController
{
  private readonly CloudStorageAccount account;
  private readonly string blobContainer;
  ...
  /// <summary>
  /// Return a limited access key that allows the caller to upload a file
  /// to this specific destination for a defined period of time.
  /// </summary>
  private StorageEntitySas GetSharedAccessReferenceForUpload(string blobName)
  {
    var blobClient = this.account.CreateCloudBlobClient();
    var container = blobClient.GetContainerReference(this.blobContainer);

    var blob = container.GetBlockBlobReference(blobName);

    var policy = new SharedAccessBlobPolicy
    {
      Permissions = SharedAccessBlobPermissions.Write,

      // Specify a start time five minutes earlier to allow for client clock skew.
      SharedAccessStartTime = DateTime.UtcNow.AddMinutes(-5),

      // Specify a validity period of five minutes starting from now.
      SharedAccessExpiryTime = DateTime.UtcNow.AddMinutes(5)
    };

    // Create the signature.
    var sas = blob.GetSharedAccessSignature(policy);

    return new StorageEntitySas
    {
      BlobUri = blob.Uri,
      Credentials = sas,
      Name = blobName
    };
  }

  public struct StorageEntitySas
  {
    public string Credentials;
    public Uri BlobUri;
    public string Name;
  }
}
```

> <span data-ttu-id="2237d-216">A amostra completa está disponível na solução ValetKey disponível para fazer o download a partir do [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span><span class="sxs-lookup"><span data-stu-id="2237d-216">The complete sample is available in the ValetKey solution available for download from [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span> <span data-ttu-id="2237d-217">O projeto ValetKey.Web nessa solução contém um aplicativo da Web que inclui a classe `ValuesController` mostrada acima.</span><span class="sxs-lookup"><span data-stu-id="2237d-217">The ValetKey.Web project in this solution contains a web application that includes the `ValuesController` class shown above.</span></span> <span data-ttu-id="2237d-218">Um aplicativo cliente de amostra que utiliza esse aplicativo Web para recuperar uma chave de assinaturas de acesso compartilhado e carregar um arquivo para o armazenamento de Blobs está disponível no projeto ValetKey.Client.</span><span class="sxs-lookup"><span data-stu-id="2237d-218">A sample client application that uses this web application to retrieve a shared access signatures key and upload a file to blob storage is available in the ValetKey.Client project.</span></span>

## <a name="next-steps"></a><span data-ttu-id="2237d-219">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="2237d-219">Next steps</span></span>

<span data-ttu-id="2237d-220">Os padrões e diretrizes a seguir também podem ser relevantes ao implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="2237d-220">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="2237d-221">Um exemplo que demonstra esse padrão está disponível em [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span><span class="sxs-lookup"><span data-stu-id="2237d-221">A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span>
- <span data-ttu-id="2237d-222">[Padrão de gatekeeper](gatekeeper.md).</span><span class="sxs-lookup"><span data-stu-id="2237d-222">[Gatekeeper pattern](gatekeeper.md).</span></span> <span data-ttu-id="2237d-223">Este padrão pode ser utilizado em conjunto com o padrão Valet Key para proteger aplicativos e serviços, utilizando uma instância de host dedicada que age como agente entre clientes e o aplicativo ou serviço.</span><span class="sxs-lookup"><span data-stu-id="2237d-223">This pattern can be used in conjunction with the Valet Key pattern to protect applications and services by using a dedicated host instance that acts as a broker between clients and the application or service.</span></span> <span data-ttu-id="2237d-224">O gatekeeper valida e limpa as solicitações, e transmite as solicitações e os dados entre o cliente e o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="2237d-224">The gatekeeper validates and sanitizes requests, and passes requests and data between the client and the application.</span></span> <span data-ttu-id="2237d-225">Isso pode fornecer uma camada adicional de segurança e reduzir a superfície de ataque do sistema.</span><span class="sxs-lookup"><span data-stu-id="2237d-225">Can provide an additional layer of security, and reduce the attack surface of the system.</span></span>
- <span data-ttu-id="2237d-226">[Padrão de hospedagem de conteúdo estático](static-content-hosting.md).</span><span class="sxs-lookup"><span data-stu-id="2237d-226">[Static Content Hosting pattern](static-content-hosting.md).</span></span> <span data-ttu-id="2237d-227">Descreve como implantar recursos estáticos em um serviço de armazenamento baseado em nuvem que pode entregar esses recursos diretamente ao cliente para reduzir o requisito de instâncias de computação dispendiosas.</span><span class="sxs-lookup"><span data-stu-id="2237d-227">Describes how to deploy static resources to a cloud-based storage service that can deliver these resources directly to the client to reduce the requirement for expensive compute instances.</span></span> <span data-ttu-id="2237d-228">Onde os recursos não se destinam a ser publicamente disponíveis, o padrão Valet Key poderá ser usado para protegê-los.</span><span class="sxs-lookup"><span data-stu-id="2237d-228">Where the resources aren't intended to be publicly available, the Valet Key pattern can be used to secure them.</span></span>
- [<span data-ttu-id="2237d-229">Introdução à SAS (Assinatura de Acesso Compartilhado) de tabela, SAS de fila e atualização para SAS de Blob</span><span class="sxs-lookup"><span data-stu-id="2237d-229">Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS</span></span>](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/)
- [<span data-ttu-id="2237d-230">Uso de assinaturas de acesso compartilhado</span><span class="sxs-lookup"><span data-stu-id="2237d-230">Using Shared Access Signatures</span></span>](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)
- [<span data-ttu-id="2237d-231">Autenticação de assinatura de acesso compartilhado com Barramento de serviço</span><span class="sxs-lookup"><span data-stu-id="2237d-231">Shared Access Signature Authentication with Service Bus</span></span>](https://azure.microsoft.com/documentation/articles/service-bus-shared-access-signature-authentication/)

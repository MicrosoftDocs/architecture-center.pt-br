---
title: Supervisor de Agente do Agendador
description: "Coordene um conjunto de ações em um conjunto distribuído de serviços e outros recursos remotos."
keywords: "padrão de design"
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- messaging
- resiliency
ms.openlocfilehash: 03bfe2fe96b3b81d547cfedb075bcf855846b668
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/14/2017
---
# <a name="scheduler-agent-supervisor-pattern"></a><span data-ttu-id="7ce28-104">Padrão de supervisor de agente do Agendador</span><span class="sxs-lookup"><span data-stu-id="7ce28-104">Scheduler Agent Supervisor pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="7ce28-105">Coordene um conjunto de ações distribuídas como uma única operação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-105">Coordinate a set of distributed actions as a single operation.</span></span> <span data-ttu-id="7ce28-106">Se qualquer uma das ações falhar, tente tratar as falhas de forma transparente ou então desfaça o trabalho que foi executado para que toda a operação tenha êxito ou falhe como um todo.</span><span class="sxs-lookup"><span data-stu-id="7ce28-106">If any of the actions fail, try to handle the failures transparently, or else undo the work that was performed, so the entire operation succeeds or fails as a whole.</span></span> <span data-ttu-id="7ce28-107">Isso pode adicionar resiliência a um sistema distribuído, permitindo que se recupere e tente novamente as ações que falharem devido a exceções transitórias, falhas de longa duração e falhas do processo.</span><span class="sxs-lookup"><span data-stu-id="7ce28-107">This can add resiliency to a distributed system, by enabling it to recover and retry actions that fail due to transient exceptions, long-lasting faults, and process failures.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="7ce28-108">Contexto e problema</span><span class="sxs-lookup"><span data-stu-id="7ce28-108">Context and problem</span></span>

<span data-ttu-id="7ce28-109">Um aplicativo executa tarefas que incluem uma série de etapas, algumas das quais podem invocar serviços remotos ou acessar recursos remotos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-109">An application performs tasks that include a number of steps, some of which might invoke remote services or access remote resources.</span></span> <span data-ttu-id="7ce28-110">As etapas individuais podem ser independentes umas das outras, mas elas são organizadas pela lógica de aplicativo que implementa a tarefa.</span><span class="sxs-lookup"><span data-stu-id="7ce28-110">The individual steps might be independent of each other, but they are orchestrated by the application logic that implements the task.</span></span>

<span data-ttu-id="7ce28-111">Sempre que possível, o aplicativo deve garantir que a tarefa seja concluída e resolver as falhas que possam ocorrer ao acessar serviços ou recursos remotos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-111">Whenever possible, the application should ensure that the task runs to completion and resolve any failures that might occur when accessing remote services or resources.</span></span> <span data-ttu-id="7ce28-112">As falhas podem ocorrer por várias razões.</span><span class="sxs-lookup"><span data-stu-id="7ce28-112">Failures can occur for many reasons.</span></span> <span data-ttu-id="7ce28-113">Por exemplo, a rede pode estar inativa, as comunicações podem ser interrompidas, um serviço remoto pode não estar respondendo ou pode estar em estado instável ou um recurso remoto pode estar temporariamente inacessível, talvez devido a restrições de recursos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-113">For example, the network might be down, communications could be interrupted, a remote service might be unresponsive or in an unstable state, or a remote resource might be temporarily inaccessible, perhaps due to resource constraints.</span></span> <span data-ttu-id="7ce28-114">Em muitos casos as falhas serão transitórias e podem ser tratadas por meio de [padrão de Repetição][retry-pattern].</span><span class="sxs-lookup"><span data-stu-id="7ce28-114">In many cases the failures will be transient and can be handled by using the [Retry pattern][retry-pattern].</span></span>

<span data-ttu-id="7ce28-115">Se o aplicativo detectar uma falha mais permanente da qual não pode se recurar com facilidade, ele deve ser capaz de restaurar o sistema para um estado consistente e garantir a integridade de toda a operação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-115">If the application detects a more permanent fault it can't easily recover from, it must be able to restore the system to a consistent state and ensure integrity of the entire operation.</span></span>

## <a name="solution"></a><span data-ttu-id="7ce28-116">Solução</span><span class="sxs-lookup"><span data-stu-id="7ce28-116">Solution</span></span>

<span data-ttu-id="7ce28-117">O padrão de Supervisor de Agente do Agendador define os atores a seguir.</span><span class="sxs-lookup"><span data-stu-id="7ce28-117">The Scheduler Agent Supervisor pattern defines the following actors.</span></span> <span data-ttu-id="7ce28-118">Esses atores coordenam as etapas que devem ser executadas como parte da tarefa geral.</span><span class="sxs-lookup"><span data-stu-id="7ce28-118">These actors orchestrate the steps to be performed as part of the overall task.</span></span>

- <span data-ttu-id="7ce28-119">O **Agendador** providencia as etapas que compõem a tarefa a ser executada e coordena a operação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-119">The **Scheduler** arranges for the steps that make up the task to be executed and orchestrates their operation.</span></span> <span data-ttu-id="7ce28-120">Essas etapas podem ser combinadas em um pipeline ou fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-120">These steps can be combined into a pipeline or workflow.</span></span> <span data-ttu-id="7ce28-121">O Agendador é responsável por garantir que as etapas nesse fluxo de trabalho sejam executadas na ordem correta.</span><span class="sxs-lookup"><span data-stu-id="7ce28-121">The Scheduler is responsible for ensuring that the steps in this workflow are performed in the right order.</span></span> <span data-ttu-id="7ce28-122">À medida que cada etapa é executada, o Agendador registra o estado do fluxo de trabalho, como "etapa ainda não iniciada", "etapa em execução" ou "etapa concluída".</span><span class="sxs-lookup"><span data-stu-id="7ce28-122">As each step is performed, the Scheduler records the state of the workflow, such as "step not yet started," "step running," or "step completed."</span></span> <span data-ttu-id="7ce28-123">As informações de estado também devem incluir um limite máximo de tempo permitido para a conclusão da etapa, chamado de tempo de conclusão.</span><span class="sxs-lookup"><span data-stu-id="7ce28-123">The state information should also include an upper limit of the time allowed for the step to finish, called the complete-by time.</span></span> <span data-ttu-id="7ce28-124">Se uma etapa requer acesso a um serviço ou recurso remoto, o Agendador invocar o agente apropriado, passando os detalhes do trabalho a ser executado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-124">If a step requires access to a remote service or resource, the Scheduler invokes the appropriate Agent, passing it the details of the work to be performed.</span></span> <span data-ttu-id="7ce28-125">O Agendador normalmente se comunica com um Agente usando mensagens de solicitação/resposta assíncronas.</span><span class="sxs-lookup"><span data-stu-id="7ce28-125">The Scheduler typically communicates with an Agent using asynchronous request/response messaging.</span></span> <span data-ttu-id="7ce28-126">Isso pode ser implementado usando filas, embora outras tecnologias de mensagens distribuídas possam ser usadas em vez disso.</span><span class="sxs-lookup"><span data-stu-id="7ce28-126">This can be implemented using queues, although other distributed messaging technologies could be used instead.</span></span>

    > <span data-ttu-id="7ce28-127">O Agendador executa uma função semelhante para o Gerenciador de Processo no [padrão de Gerenciador de Processo](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span><span class="sxs-lookup"><span data-stu-id="7ce28-127">The Scheduler performs a similar function to the Process Manager in the [Process Manager pattern](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html).</span></span> <span data-ttu-id="7ce28-128">O fluxo de trabalho real normalmente é definido e implementado por um mecanismo de fluxo de trabalho que é controlado pelo Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-128">The actual workflow is typically defined and implemented by a workflow engine that's controlled by the Scheduler.</span></span> <span data-ttu-id="7ce28-129">Essa abordagem separa a lógica de negócios no fluxo de trabalho do Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-129">This approach decouples the business logic in the workflow from the Scheduler.</span></span>

- <span data-ttu-id="7ce28-130">O **Agente** contém a lógica que encapsula uma chamada para um serviço remoto ou o acesso a um recurso remoto referenciado por uma etapa em uma tarefa.</span><span class="sxs-lookup"><span data-stu-id="7ce28-130">The **Agent** contains logic that encapsulates a call to a remote service, or access to a remote resource referenced by a step in a task.</span></span> <span data-ttu-id="7ce28-131">Cada Agente normalmente encapsula chamadas para um único serviço ou recurso, implementando a lógica de lidar com erros e tentar novamente (sujeito a uma restrição de tempo limite, descrita posteriormente).</span><span class="sxs-lookup"><span data-stu-id="7ce28-131">Each Agent typically wraps calls to a single service or resource, implementing the appropriate error handling and retry logic (subject to a timeout constraint, described later).</span></span> <span data-ttu-id="7ce28-132">Se as etapas no fluxo de trabalho sendo executadas pelo Agendador usam vários serviços e recursos entre etapas diferentes, cada etapa pode fazer referência a um Agente diferente (esse é um detalhe de implementação do padrão).</span><span class="sxs-lookup"><span data-stu-id="7ce28-132">If the steps in the workflow being run by the Scheduler use several services and resources across different steps, each step might reference a different Agent (this is an implementation detail of the pattern).</span></span>

- <span data-ttu-id="7ce28-133">O **Supervisor** monitora o status das etapas da tarefa que está sendo executada pelo Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-133">The **Supervisor** monitors the status of the steps in the task being performed by the Scheduler.</span></span> <span data-ttu-id="7ce28-134">Ele é executado periodicamente (a frequência será específica do sistema) e examina o status das etapas mantidas pelo Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-134">It runs periodically (the frequency will be system specific), and examines the status of steps maintained by the Scheduler.</span></span> <span data-ttu-id="7ce28-135">Se ele detectar algum que tenha expirado ou falhado, providenciará que o Agente apropriado recupere a etapa ou execute a ação corretiva apropriada (isso pode envolver a modificação do status de uma etapa).</span><span class="sxs-lookup"><span data-stu-id="7ce28-135">If it detects any that have timed out or failed, it arranges for the appropriate Agent to recover the step or execute the appropriate remedial action (this might involve modifying the status of a step).</span></span> <span data-ttu-id="7ce28-136">Observe que a recuperação ou as ações corretivas são implementadas pelo Agendador e os Agentes.</span><span class="sxs-lookup"><span data-stu-id="7ce28-136">Note that the recovery or remedial actions are implemented by the Scheduler and Agents.</span></span> <span data-ttu-id="7ce28-137">O Supervisor deve simplesmente solicitar que essas ações sejam executadas.</span><span class="sxs-lookup"><span data-stu-id="7ce28-137">The Supervisor should simply request that these actions be performed.</span></span>

<span data-ttu-id="7ce28-138">O Agendador, o Agente e o Supervisor são componentes lógicos e sua implementação física depende da tecnologia que está sendo usada.</span><span class="sxs-lookup"><span data-stu-id="7ce28-138">The Scheduler, Agent, and Supervisor are logical components and their physical implementation depends on the technology being used.</span></span> <span data-ttu-id="7ce28-139">Por exemplo, vários agentes lógicos podem ser implementados como parte de um único serviço web.</span><span class="sxs-lookup"><span data-stu-id="7ce28-139">For example, several logical agents might be implemented as part of a single web service.</span></span>

<span data-ttu-id="7ce28-140">O Agendador mantém informações sobre o andamento da tarefa e o estado de cada etapa em um repositório de dados durável, chamado de repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-140">The Scheduler maintains information about the progress of the task and the state of each step in a durable data store, called the state store.</span></span> <span data-ttu-id="7ce28-141">O Supervisor pode usar essas informações para ajudar a determinar se uma etapa falhou.</span><span class="sxs-lookup"><span data-stu-id="7ce28-141">The Supervisor can use this information to help determine whether a step has failed.</span></span> <span data-ttu-id="7ce28-142">A figura ilustra o relacionamento entre o Agendador, os Agentes, o Supervisor e o repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-142">The figure illustrates the relationship between the Scheduler, the Agents, the Supervisor, and the state store.</span></span>

![Figura 1 - Os atores no padrão de Supervisor de Agente do Agendador](./_images/scheduler-agent-supervisor-pattern.png)


> <span data-ttu-id="7ce28-144">Esse diagrama mostra uma versão simplificada do padrão.</span><span class="sxs-lookup"><span data-stu-id="7ce28-144">This diagram shows a simplified version of the pattern.</span></span> <span data-ttu-id="7ce28-145">Em uma implementação real, pode haver várias instâncias do Agendador em execução simultaneamente, cada uma um subconjunto da tarefas.</span><span class="sxs-lookup"><span data-stu-id="7ce28-145">In a real implementation, there might be many instances of the Scheduler running concurrently, each a subset of tasks.</span></span> <span data-ttu-id="7ce28-146">Da mesma forma, o sistema pode executar várias instâncias de cada Agente, ou até mesmo vários Supervisores.</span><span class="sxs-lookup"><span data-stu-id="7ce28-146">Similarly, the system could run multiple instances of each Agent, or even multiple Supervisors.</span></span> <span data-ttu-id="7ce28-147">Nesse caso, os Supervisores devem coordenar o trabalho entre si com cuidado para garantir que eles não compitam para recuperar as mesmas etapas e tarefas com falha.</span><span class="sxs-lookup"><span data-stu-id="7ce28-147">In this case, Supervisors must coordinate their work with each other carefully to ensure that they don’t compete to recover the same failed steps and tasks.</span></span> <span data-ttu-id="7ce28-148">O [padrão de Eleição de Líder](leader-election.md) fornece uma solução possível para esse problema.</span><span class="sxs-lookup"><span data-stu-id="7ce28-148">The [Leader Election pattern](leader-election.md) provides one possible solution to this problem.</span></span>

<span data-ttu-id="7ce28-149">Quando o aplicativo está pronto para executar uma tarefa, ele envia uma solicitação para o Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-149">When the application is ready to run a task, it submits a request to the Scheduler.</span></span> <span data-ttu-id="7ce28-150">O Agendador registra as informações de estado inicial sobre a tarefa e suas etapas (por exemplo, etapa ainda não iniciada) no repositório de estado e, em seguida, começa a executar as operações definidas pelo fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-150">The Scheduler records initial state information about the task and its steps (for example, step not yet started) in the state store and then starts performing the operations defined by the workflow.</span></span> <span data-ttu-id="7ce28-151">Como o Agendador inicia cada etapa, ele atualiza as informações sobre o estado da etapa no repositório de estado (por exemplo, etapa em execução).</span><span class="sxs-lookup"><span data-stu-id="7ce28-151">As the Scheduler starts each step, it updates the information about the state of that step in the state store (for example, step running).</span></span>

<span data-ttu-id="7ce28-152">Se uma etapa faz referência a um serviço ou recurso remoto, o Agendador envia uma mensagem para o Agente apropriado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-152">If a step references a remote service or resource, the Scheduler sends a message to the appropriate Agent.</span></span> <span data-ttu-id="7ce28-153">A mensagem contém as informações que o Agente deve passar para o serviço ou acessar o recurso, além do tempo de conclusão para a operação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-153">The message contains the information that the Agent needs to pass to the service or access the resource, in addition to the complete-by time for the operation.</span></span> <span data-ttu-id="7ce28-154">Se o Agente concluir com êxito sua operação, ele enviará uma resposta para o Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-154">If the Agent completes its operation successfully, it returns a response to the Scheduler.</span></span> <span data-ttu-id="7ce28-155">O Agendador pode, em seguida, atualizar as informações de estado no repositório de estado (por exemplo, etapa concluída) e executar a próxima etapa.</span><span class="sxs-lookup"><span data-stu-id="7ce28-155">The Scheduler can then update the state information in the state store (for example, step completed) and perform the next step.</span></span> <span data-ttu-id="7ce28-156">Esse processo continua até que toda a tarefa seja concluída.</span><span class="sxs-lookup"><span data-stu-id="7ce28-156">This process continues until the entire task is complete.</span></span>

<span data-ttu-id="7ce28-157">Um Agente pode implementar qualquer lógica de repetição que seja necessária para realizar seu trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-157">An Agent can implement any retry logic that's necessary to perform its work.</span></span> <span data-ttu-id="7ce28-158">No entanto, se o Agente não concluir seu trabalho antes de o período de conclusão expirar, o Agendador presumirá que a operação falhou.</span><span class="sxs-lookup"><span data-stu-id="7ce28-158">However, if the Agent doesn't complete its work before the complete-by period expires, the Scheduler will assume that the operation has failed.</span></span> <span data-ttu-id="7ce28-159">Nesse caso, o Agente deve interromper seu trabalho e não tentar retorna nada para o Agendador (nem mesmo uma mensagem de erro) ou qualquer forma de recuperação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-159">In this case, the Agent should stop its work and not try to return anything to the Scheduler (not even an error message), or try any form of recovery.</span></span> <span data-ttu-id="7ce28-160">A razão para essa restrição é que, após uma etapa expirar ou falhar, outra instância do Agente pode ser agendada para executar a etapa que falhou (esse processo é descrito posteriormente).</span><span class="sxs-lookup"><span data-stu-id="7ce28-160">The reason for this restriction is that, after a step has timed out or failed, another instance of the Agent might be scheduled to run the failing step (this process is described later).</span></span>

<span data-ttu-id="7ce28-161">Se o Agente falhar, o Agendador não receberá uma resposta.</span><span class="sxs-lookup"><span data-stu-id="7ce28-161">If the Agent fails, the Scheduler won't receive a response.</span></span> <span data-ttu-id="7ce28-162">O padrão não faz uma distinção entre uma etapa que atingiu o tempo limite e uma que realmente falhou.</span><span class="sxs-lookup"><span data-stu-id="7ce28-162">The pattern doesn't make a distinction between a step that has timed out and one that has genuinely failed.</span></span>

<span data-ttu-id="7ce28-163">Se uma etapa expirar ou falhar, o repositório de estado conterá um registro que indica que a etapa está em execução, mas o tempo de conclusão terá passado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-163">If a step times out or fails, the state store will contain a record that indicates that the step is running, but the complete-by time will have passed.</span></span> <span data-ttu-id="7ce28-164">O Supervisor procura as etapas assim e tenta recuperá-las.</span><span class="sxs-lookup"><span data-stu-id="7ce28-164">The Supervisor looks for steps like this and tries to recover them.</span></span> <span data-ttu-id="7ce28-165">Uma estratégia possível é o Supervisor atualizar o valor de conclusão para prolongar o tempo disponível para concluir a etapa e, em seguida, enviar uma mensagem para o Agendador identificando a etapa que atingiu o tempo limite. O Agendador pode tentar repetir esta etapa.</span><span class="sxs-lookup"><span data-stu-id="7ce28-165">One possible strategy is for the Supervisor to update the complete-by value to extend the time available to complete the step, and then send a message to the Scheduler identifying the step that has timed out. The Scheduler can then try to repeat this step.</span></span> <span data-ttu-id="7ce28-166">No entanto, esse design requer que as tarefas sejam idempotentes.</span><span class="sxs-lookup"><span data-stu-id="7ce28-166">However, this design requires the tasks to be idempotent.</span></span>

<span data-ttu-id="7ce28-167">O Supervisor pode precisar impedir que a mesma etapa seja repetida se continuamente falhar ou expirar. Para fazer isso, o Supervisor pode manter uma contagem de repetição para cada etapa, junto com as informações de estado, no repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-167">The Supervisor might need to prevent the same step from being retried if it continually fails or times out. To do this, the Supervisor could maintain a retry count for each step, along with the state information, in the state store.</span></span> <span data-ttu-id="7ce28-168">Se essa contagem exceder um limite predefinido, o Supervisor pode adotar uma estratégia de espera por um longo período antes de notificar o Agendador de que ele deve tentar novamente a etapa, com a expectativa de que a falha seja resolvida durante esse período.</span><span class="sxs-lookup"><span data-stu-id="7ce28-168">If this count exceeds a predefined threshold the Supervisor can adopt a strategy of waiting for an extended period before notifying the Scheduler that it should retry the step, in the expectation that the fault will be resolved during this period.</span></span> <span data-ttu-id="7ce28-169">Como alternativa, o Supervisor pode enviar uma mensagem para o Agendador para solicitar que toda a tarefa seja desfeita implementando um [padrão de Transação de Compensação](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="7ce28-169">Alternatively, the Supervisor can send a message to the Scheduler to request the entire task be undone by implementing a [Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="7ce28-170">Essa abordagem dependerá do Agendador e dos Agentes que fornecem as informações necessárias para implementar as operações de compensação para cada etapa concluída com êxito.</span><span class="sxs-lookup"><span data-stu-id="7ce28-170">This approach will depend on the Scheduler and Agents providing the information necessary to implement the compensating operations for each step that completed successfully.</span></span>

> <span data-ttu-id="7ce28-171">Não é a finalidade do Supervisor monitorar o Agendador e os Agentes e reiniciá-los se eles falharem.</span><span class="sxs-lookup"><span data-stu-id="7ce28-171">It isn't the purpose of the Supervisor to monitor the Scheduler and Agents, and restart them if they fail.</span></span> <span data-ttu-id="7ce28-172">Esse aspecto do sistema deve ser tratado pela infraestrutura na qual esses componentes estão em execução.</span><span class="sxs-lookup"><span data-stu-id="7ce28-172">This aspect of the system should be handled by the infrastructure these components are running in.</span></span> <span data-ttu-id="7ce28-173">Da mesma forma, o Supervisor não deve ter conhecimento das operações de negócios que as tarefas executadas pelo Agendador estão executando (incluindo como compensar caso essas tarefas falhem).</span><span class="sxs-lookup"><span data-stu-id="7ce28-173">Similarly, the Supervisor shouldn't have knowledge of the actual business operations that the tasks being performed by the Scheduler are running (including how to compensate should these tasks fail).</span></span> <span data-ttu-id="7ce28-174">Essa é a finalidade da lógica de fluxo de trabalho implementada pelo Agendador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-174">This is the purpose of the workflow logic implemented by the Scheduler.</span></span> <span data-ttu-id="7ce28-175">É de responsabilidade exclusiva do Supervisor determinar se uma etapa falhou e providenciar para que ela seja repetida ou para a tarefa inteira contendo a etapa que falhou seja desfeita.</span><span class="sxs-lookup"><span data-stu-id="7ce28-175">The sole responsibility of the Supervisor is to determine whether a step has failed and arrange either for it to be repeated or for the entire task containing the failed step to be undone.</span></span>

<span data-ttu-id="7ce28-176">Se o Agendador for reiniciado após uma falha ou o fluxo de trabalho sendo executado pelo Agendador terminar inesperadamente, o Agendador deverá ser capaz de determinar o status de qualquer tarefa em andamento que estava tratando quando falhou e estar preparado para continuar esta tarefa a partir desse ponto.</span><span class="sxs-lookup"><span data-stu-id="7ce28-176">If the Scheduler is restarted after a failure, or the workflow being performed by the Scheduler terminates unexpectedly, the Scheduler should be able to determine the status of any inflight task that it was handling when it failed, and be prepared to resume this task from that point.</span></span> <span data-ttu-id="7ce28-177">Os detalhes de implementação desse processo são provavelmente específicas do sistema.</span><span class="sxs-lookup"><span data-stu-id="7ce28-177">The implementation details of this process are likely to be system specific.</span></span> <span data-ttu-id="7ce28-178">Se a tarefa não puder ser recuperada, pode ser necessário desfazer o trabalho já foi executado pela tarefa.</span><span class="sxs-lookup"><span data-stu-id="7ce28-178">If the task can't be recovered, it might be necessary to undo the work already performed by the task.</span></span> <span data-ttu-id="7ce28-179">Isso também pode exigir a implementação de uma [transação de compensação](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="7ce28-179">This might also require implementing a [compensating transaction](compensating-transaction.md).</span></span>

<span data-ttu-id="7ce28-180">A principal vantagem desse padrão é que o sistema é resiliente em caso de falhas inesperadas temporárias ou irrecuperáveis.</span><span class="sxs-lookup"><span data-stu-id="7ce28-180">The key advantage of this pattern is that the system is resilient in the event of unexpected temporary or unrecoverable failures.</span></span> <span data-ttu-id="7ce28-181">O sistema pode ser construído para se autorrecuperar.</span><span class="sxs-lookup"><span data-stu-id="7ce28-181">The system can be constructed to be self healing.</span></span> <span data-ttu-id="7ce28-182">Por exemplo, se um Agente ou o Agendador falhar, um novo pode ser iniciado e o Supervisor pode providenciar para que uma tarefa seja retomada.</span><span class="sxs-lookup"><span data-stu-id="7ce28-182">For example, if an Agent or the Scheduler fails, a new one can be started and the Supervisor can arrange for a task to be resumed.</span></span> <span data-ttu-id="7ce28-183">Se o Supervisor falhar, outra instância pode ser iniciada e pode assumir a partir onde a falha ocorreu.</span><span class="sxs-lookup"><span data-stu-id="7ce28-183">If the Supervisor fails, another instance can be started and can take over from where the failure occurred.</span></span> <span data-ttu-id="7ce28-184">Se o Supervisor for agendado para ser executado periodicamente, uma nova instância poderá ser iniciada automaticamente após um intervalo predefinido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-184">If the Supervisor is scheduled to run periodically, a new instance can be automatically started after a predefined interval.</span></span> <span data-ttu-id="7ce28-185">O repositório de estado pode ser replicado para chegar a um nível ainda maior de resiliência.</span><span class="sxs-lookup"><span data-stu-id="7ce28-185">The state store can be replicated to reach an even greater degree of resiliency.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="7ce28-186">Problemas e considerações</span><span class="sxs-lookup"><span data-stu-id="7ce28-186">Issues and considerations</span></span>

<span data-ttu-id="7ce28-187">Você deve considerar os seguintes pontos ao decidir como implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="7ce28-187">You should consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="7ce28-188">Esse padrão pode ser difícil de implementar e requer um teste completo de cada modo de falha possíveis do sistema.</span><span class="sxs-lookup"><span data-stu-id="7ce28-188">This pattern can be difficult to implement and requires thorough testing of each possible failure mode of the system.</span></span>

- <span data-ttu-id="7ce28-189">A lógica de repetição/recuperação implementada pelo Agendador é complexa e dependente de informações de estado mantidas no repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-189">The recovery/retry logic implemented by the Scheduler is complex and dependent on state information held in the state store.</span></span> <span data-ttu-id="7ce28-190">Também pode ser necessário registrar as informações necessárias para implementar uma transação de compensação em um repositório de dados durável.</span><span class="sxs-lookup"><span data-stu-id="7ce28-190">It might also be necessary to record the information required to implement a compensating transaction in a durable data store.</span></span>

- <span data-ttu-id="7ce28-191">A frequência de execuções do Supervisor será importante.</span><span class="sxs-lookup"><span data-stu-id="7ce28-191">How often the Supervisor runs will be important.</span></span> <span data-ttu-id="7ce28-192">Ele deve ser executado com frequência suficiente para impedir que uma tarefa com falha aplicativ bloqueie um aplicativo por um longo período de tempo, mas não deve ser executado com uma frequência que crie uma sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="7ce28-192">It should run often enough to prevent any failed steps from blocking an application for an extended period, but it shouldn't run so often that it becomes an overhead.</span></span>

- <span data-ttu-id="7ce28-193">As etapas executadas por um Agente podem ser executadas mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="7ce28-193">The steps performed by an Agent could be run more than once.</span></span> <span data-ttu-id="7ce28-194">A lógica que implementa essas etapas deve ser idempotente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-194">The logic that implements these steps should be idempotent.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="7ce28-195">Quando usar esse padrão</span><span class="sxs-lookup"><span data-stu-id="7ce28-195">When to use this pattern</span></span>

<span data-ttu-id="7ce28-196">Use esse padrão quando um processo que é executado em um ambiente distribuído, como a nuvem, precisar ser resiliente a falhas de comunicação e/ou falha operacional.</span><span class="sxs-lookup"><span data-stu-id="7ce28-196">Use this pattern when a process that runs in a distributed environment, such as the cloud, must be resilient to communications failure and/or operational failure.</span></span>

<span data-ttu-id="7ce28-197">Esse padrão pode não ser adequado para tarefas que não invoquem serviços remotos ou acessem recursos remotos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-197">This pattern might not be suitable for tasks that don't invoke remote services or access remote resources.</span></span>

## <a name="example"></a><span data-ttu-id="7ce28-198">Exemplo</span><span class="sxs-lookup"><span data-stu-id="7ce28-198">Example</span></span>

<span data-ttu-id="7ce28-199">Um aplicativo web que implementa um sistema de comércio eletrônico foi implantado no Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="7ce28-199">A web application that implements an ecommerce system has been deployed on Microsoft Azure.</span></span> <span data-ttu-id="7ce28-200">Os usuários podem executar esse aplicativo para procurar os produtos disponíveis e fazer pedidos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-200">Users can run this application to browse the available products and to place orders.</span></span> <span data-ttu-id="7ce28-201">A interface do usuário é executada como função web e os elementos de processamento de pedido do aplicativo são implementados como conjunto de funções de trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-201">The user interface runs as a web role, and the order processing elements of the application are implemented as a set of worker roles.</span></span> <span data-ttu-id="7ce28-202">Parte da lógica de processamento de pedidos envolve acessar um serviço remoto e esse aspecto do sistema pode estar sujeito a falhas transitórias ou de longa duração.</span><span class="sxs-lookup"><span data-stu-id="7ce28-202">Part of the order processing logic involves accessing a remote service, and this aspect of the system could be prone to transient or more long-lasting faults.</span></span> <span data-ttu-id="7ce28-203">Por esse motivo, os designers usaram o padrão de Supervisor de Agente do Agendador para implementar os elementos de processamento de pedidos do sistema.</span><span class="sxs-lookup"><span data-stu-id="7ce28-203">For this reason, the designers used the Scheduler Agent Supervisor pattern to implement the order processing elements of the system.</span></span>

<span data-ttu-id="7ce28-204">Quando um cliente faz um pedido, o aplicativo constrói uma mensagem que descreve o pedido e envia essa mensagem para uma fila.</span><span class="sxs-lookup"><span data-stu-id="7ce28-204">When a customer places an order, the application constructs a message that describes the order and posts this message to a queue.</span></span> <span data-ttu-id="7ce28-205">Um processo de envio separado, em execução em uma função de trabalho, recupera a mensagem, insere os detalhes do pedido no banco de dados de pedidos e cria um registro para o processo de pedido no repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-205">A separate submission process, running in a worker role, retrieves the message, inserts the order details into the orders database, and creates a record for the order process in the state store.</span></span> <span data-ttu-id="7ce28-206">Observe que as inserções no banco de dados de pedidos e o repositório de estado são executados como parte da mesma operação.</span><span class="sxs-lookup"><span data-stu-id="7ce28-206">Note that the inserts into the orders database and the state store are performed as part of the same operation.</span></span> <span data-ttu-id="7ce28-207">O processo de envio foi desenvolvido para garantir que ambas as inserções completem-se juntas.</span><span class="sxs-lookup"><span data-stu-id="7ce28-207">The submission process is designed to ensure that both inserts complete together.</span></span>

<span data-ttu-id="7ce28-208">As informações de estado que o processo de envio cria para o pedido incluem:</span><span class="sxs-lookup"><span data-stu-id="7ce28-208">The state information that the submission process creates for the order includes:</span></span>

- <span data-ttu-id="7ce28-209">**OrderID**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-209">**OrderID**.</span></span> <span data-ttu-id="7ce28-210">A ID do pedido no banco de dados de pedidos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-210">The ID of the order in the orders database.</span></span>

- <span data-ttu-id="7ce28-211">**LockedBy**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-211">**LockedBy**.</span></span> <span data-ttu-id="7ce28-212">A ID da instância da função de trabalho tratando o pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-212">The instance ID of the worker role handling the order.</span></span> <span data-ttu-id="7ce28-213">Pode haver várias instâncias atuais da função de trabalho em execução no Agendador, mas cada pedido só deve ser tratado por uma única instância.</span><span class="sxs-lookup"><span data-stu-id="7ce28-213">There might be multiple current instances of the worker role running the Scheduler, but each order should only be handled by a single instance.</span></span>

- <span data-ttu-id="7ce28-214">**CompleteBy**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-214">**CompleteBy**.</span></span> <span data-ttu-id="7ce28-215">O prazo máximo de processamento do pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-215">The time the order should be processed by.</span></span>

- <span data-ttu-id="7ce28-216">**ProcessState**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-216">**ProcessState**.</span></span> <span data-ttu-id="7ce28-217">O estado atual da tarefa tratando o pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-217">The current state of the task handling the order.</span></span> <span data-ttu-id="7ce28-218">Os possíveis estados são:</span><span class="sxs-lookup"><span data-stu-id="7ce28-218">The possible states are:</span></span>

    - <span data-ttu-id="7ce28-219">**Pendente**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-219">**Pending**.</span></span> <span data-ttu-id="7ce28-220">O pedido foi criado, mas o processamento ainda não foi iniciado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-220">The order has been created but processing hasn't yet been started.</span></span>
    - <span data-ttu-id="7ce28-221">**Processando**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-221">**Processing**.</span></span> <span data-ttu-id="7ce28-222">O pedido está sendo processado no momento.</span><span class="sxs-lookup"><span data-stu-id="7ce28-222">The order is currently being processed.</span></span>
    - <span data-ttu-id="7ce28-223">**Processado**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-223">**Processed**.</span></span> <span data-ttu-id="7ce28-224">O pedido foi processado com êxito.</span><span class="sxs-lookup"><span data-stu-id="7ce28-224">The order has been processed successfully.</span></span>
    - <span data-ttu-id="7ce28-225">**Erro**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-225">**Error**.</span></span> <span data-ttu-id="7ce28-226">O processamento de pedido falhou.</span><span class="sxs-lookup"><span data-stu-id="7ce28-226">The order processing has failed.</span></span>

- <span data-ttu-id="7ce28-227">**FailureCount**.</span><span class="sxs-lookup"><span data-stu-id="7ce28-227">**FailureCount**.</span></span> <span data-ttu-id="7ce28-228">O número de tentativas de processamento do pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-228">The number of times that processing has been tried for the order.</span></span>

<span data-ttu-id="7ce28-229">Nessa informação de estado, o campo `OrderID` é copiado da ID do novo pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-229">In this state information, the `OrderID` field is copied from the order ID of the new order.</span></span> <span data-ttu-id="7ce28-230">Os campos `LockedBy` e `CompleteBy` são definidos como `null`, o campo `ProcessState` é definido como `Pending` e o campo `FailureCount` é definido como 0.</span><span class="sxs-lookup"><span data-stu-id="7ce28-230">The `LockedBy` and `CompleteBy` fields are set to `null`, the `ProcessState` field is set to `Pending`, and the `FailureCount` field is set to 0.</span></span>

> <span data-ttu-id="7ce28-231">Nesse exemplo, a lógica de tratamento de pedido é relativamente simples e tem apenas uma única etapa que invoca um serviço remoto.</span><span class="sxs-lookup"><span data-stu-id="7ce28-231">In this example, the order handling logic is relatively simple and only has a single step that invokes a remote service.</span></span> <span data-ttu-id="7ce28-232">Em um cenário mais complexo de várias etapas, o processo de envio provavelmente envolveria várias etapas e, portanto, vários registros seriam criados no repositório de estado, cada um deles descrevendo o estado de uma etapa individual.</span><span class="sxs-lookup"><span data-stu-id="7ce28-232">In a more complex multistep scenario, the submission process would likely involve several steps, and so several records would be created in the state store—each one describing the state of an individual step.</span></span>

<span data-ttu-id="7ce28-233">O Agendador também é executado como parte de uma função de trabalho e implementa a lógica de negócios que controla o pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-233">The Scheduler also runs as part of a worker role and implements the business logic that handles the order.</span></span> <span data-ttu-id="7ce28-234">Uma instância do Agendador sonda novos pedidos examina o repositório de estado quanto a registros em que o campo `LockedBy` é nulo e o campo `ProcessState` está pendente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-234">An instance of the Scheduler polling for new orders examines the state store for records where the `LockedBy` field is null and the `ProcessState` field is pending.</span></span> <span data-ttu-id="7ce28-235">Quando o Agendador encontra um novo pedido, ele preenche imediatamente o campo `LockedBy` com sua própria ID de instância, define o campo `CompleteBy` para um horário apropriado e define o campo `ProcessState` para processamento.</span><span class="sxs-lookup"><span data-stu-id="7ce28-235">When the Scheduler finds a new order, it immediately populates the `LockedBy` field with its own instance ID, sets the `CompleteBy` field to an appropriate time, and sets the `ProcessState` field to processing.</span></span> <span data-ttu-id="7ce28-236">O código é projetado para ser exclusivo e atômico para garantir que duas instâncias simultâneas do Agendador não possam tentar tratar o mesmo pedido simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-236">The code is designed to be exclusive and atomic to ensure that two concurrent instances of the Scheduler can't try to handle the same order simultaneously.</span></span>

<span data-ttu-id="7ce28-237">O Agendador, em seguida, executa o fluxo de trabalho de negócios para processar o pedido de forma assíncrona, passando o valor do campo `OrderID` do repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-237">The Scheduler then runs the business workflow to process the order asynchronously, passing it the value in the `OrderID` field from the state store.</span></span> <span data-ttu-id="7ce28-238">O fluxo de trabalho tratando o pedido recupera os detalhes do pedido do banco de dados de pedidos e executa seu trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-238">The workflow handling the order retrieves the details of the order from the orders database and performs its work.</span></span> <span data-ttu-id="7ce28-239">Quando uma etapa do fluxo de trabalho de processamento de pedido precisa invocar o serviço remoto, ele usa um Agente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-239">When a step in the order processing workflow needs to invoke the remote service, it uses an Agent.</span></span> <span data-ttu-id="7ce28-240">A etapa de fluxo de trabalho se comunica com o Agente usando um par de filas de mensagens do Barramento de Serviço do Microsoft Azure agindo como canal de solicitação/resposta.</span><span class="sxs-lookup"><span data-stu-id="7ce28-240">The workflow step communicates with the Agent using a pair of Azure Service Bus message queues acting as a request/response channel.</span></span> <span data-ttu-id="7ce28-241">A figura mostra uma exibição de alto nível da solução.</span><span class="sxs-lookup"><span data-stu-id="7ce28-241">The figure shows a high level view of the solution.</span></span>

![Figura 2 - Usando o padrão de Supervisor de Agente do Agendador para lidar com pedidos em uma solução do Azure](./_images/scheduler-agent-supervisor-solution.png)

<span data-ttu-id="7ce28-243">A mensagem enviada para o Agente de uma etapa do fluxo de trabalho descreve o pedido e inclui o tempo de conclusão.</span><span class="sxs-lookup"><span data-stu-id="7ce28-243">The message sent to the Agent from a workflow step describes the order and includes the complete-by time.</span></span> <span data-ttu-id="7ce28-244">Se o Agente recebe uma resposta do serviço remoto antes de expirar o tempo de conclusão, ele envia uma mensagem de resposta na fila do Barramento de Serviço na qual o fluxo de trabalho está escutando.</span><span class="sxs-lookup"><span data-stu-id="7ce28-244">If the Agent receives a response from the remote service before the complete-by time expires, it posts a reply message on the Service Bus queue on which the workflow is listening.</span></span> <span data-ttu-id="7ce28-245">Quando a etapa do fluxo de trabalho recebe a mensagem de resposta válida, ela conclui o processamento e o Agendador define o campo ProcessState do estado do pedido a ser processado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-245">When the workflow step receives the valid reply message, it completes its processing and the Scheduler sets the \`ProcessState field of the order state to processed.</span></span> <span data-ttu-id="7ce28-246">Nesse momento, o processamento do pedido estará concluído com sucesso.</span><span class="sxs-lookup"><span data-stu-id="7ce28-246">At this point, the order processing has completed successfully.</span></span>

<span data-ttu-id="7ce28-247">Se o tempo de conclusão expirar antes que o Agente receba uma resposta do serviço remoto, o Agente simplesmente interromperá o processamento e terminará de tratar o pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-247">If the complete-by time expires before the Agent receives a response from the remote service, the Agent simply halts its processing and terminates handling the order.</span></span> <span data-ttu-id="7ce28-248">Da mesma forma, se o fluxo de trabalho tratando o pedido exceder o tempo de conclusão, ele também será encerrado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-248">Similarly, if the workflow handling the order exceeds the complete-by time, it also terminates.</span></span> <span data-ttu-id="7ce28-249">Em ambos os casos, o estado do pedido no repositório de estado permanece configurado para processar, mas o tempo de conclusão indica que o tempo para processar o pedido foi excedido e o processo é considerado com falha.</span><span class="sxs-lookup"><span data-stu-id="7ce28-249">In both cases, the state of the order in the state store remains set to processing, but the complete-by time indicates that the time for processing the order has passed and the process is deemed to have failed.</span></span> <span data-ttu-id="7ce28-250">Observe que se o Agente que está acessando o serviço remoto ou se o fluxo de trabalho que está tratando o pedido (ou ambos) for encerrado inesperadamente, as informações no repositório de estado novamente permanecerão configuradas para processar e, por fim, terão um valor de conclusão expirado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-250">Note that if the Agent that's accessing the remote service, or the workflow that's handling the order (or both) terminate unexpectedly, the information in the state store will again remain set to processing and eventually will have an expired complete-by value.</span></span>

<span data-ttu-id="7ce28-251">Se o Agente detectar uma falha irrecuperável e não transitória enquanto está tentando entrar em contato com o serviço remoto, ele poderá enviar uma resposta de erro de volta para o fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="7ce28-251">If the Agent detects an unrecoverable, nontransient fault while it's trying to contact the remote service, it can send an error response back to the workflow.</span></span> <span data-ttu-id="7ce28-252">O Agendador pode definir o status do pedido como erro e acionar um evento que alerta o operador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-252">The Scheduler can set the status of the order to error and raise an event that alerts an operator.</span></span> <span data-ttu-id="7ce28-253">O operador pode, então, tentar resolver manualmente o motivo da falha e reenviar a etapa de processamento com falha.</span><span class="sxs-lookup"><span data-stu-id="7ce28-253">The operator can then try to resolve the reason for the failure manually and resubmit the failed processing step.</span></span>

<span data-ttu-id="7ce28-254">O Supervisor periodicamente examina o repositório de estado procurando pedidos com valor de conclusão expirado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-254">The Supervisor periodically examines the state store looking for orders with an expired complete-by value.</span></span> <span data-ttu-id="7ce28-255">Se o Supervisor localizar um registro, o campo `FailureCount` será incrementado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-255">If the Supervisor finds a record, it increments the `FailureCount` field.</span></span> <span data-ttu-id="7ce28-256">Se o valor de contagem de falha estiver abaixo de um valor de limite especificado, o Supervisor redefinirá o campo `LockedBy` para nulo, atualizará o campo `CompleteBy` com um novo tempo de expiração e definirá o campo `ProcessState` como pendente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-256">If the failure count value is below a specified threshold value, the Supervisor resets the `LockedBy` field to null, updates the `CompleteBy` field with a new expiration time, and sets the `ProcessState` field to pending.</span></span> <span data-ttu-id="7ce28-257">Uma instância do Agendador pode pegar esse pedido e executar o processamento como antes.</span><span class="sxs-lookup"><span data-stu-id="7ce28-257">An instance of the Scheduler can pick up this order and perform its processing as before.</span></span> <span data-ttu-id="7ce28-258">Se o valor de contagem de falhas exceder um limite especificado, o motivo da falha será considerado não transitório.</span><span class="sxs-lookup"><span data-stu-id="7ce28-258">If the failure count value exceeds a specified threshold, the reason for the failure is assumed to be nontransient.</span></span> <span data-ttu-id="7ce28-259">O Supervisor define o status do pedido como erro e aciona um evento que alerta o operador.</span><span class="sxs-lookup"><span data-stu-id="7ce28-259">The Supervisor sets the status of the order to error and raises an event that alerts an operator.</span></span>

> <span data-ttu-id="7ce28-260">Neste exemplo, o Supervisor é implementado em uma função de trabalho separada.</span><span class="sxs-lookup"><span data-stu-id="7ce28-260">In this example, the Supervisor is implemented in a separate worker role.</span></span> <span data-ttu-id="7ce28-261">Você pode usar uma variedade de estratégias para fazer com que a tarefa do Supervisor seja executado, inclusive usando o serviço do Agendador do Azure (não deve ser confundido com o componente do Agendador neste padrão).</span><span class="sxs-lookup"><span data-stu-id="7ce28-261">You can use a variety of strategies to arrange for the Supervisor task to be run, including using the Azure Scheduler service (not to be confused with the Scheduler component in this pattern).</span></span> <span data-ttu-id="7ce28-262">Para obter mais informações sobre o serviço de Agendador do Azure, acesse a página do [Agendador](https://azure.microsoft.com/services/scheduler/).</span><span class="sxs-lookup"><span data-stu-id="7ce28-262">For more information about the Azure Scheduler service, visit the [Scheduler](https://azure.microsoft.com/services/scheduler/) page.</span></span>

<span data-ttu-id="7ce28-263">Embora não mostrado neste exemplo, o Agendador talvez precise manter o aplicativo que enviou o pedido informado sobre o andamento e o status do pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-263">Although it isn't shown in this example, the Scheduler might need to keep the application that submitted the order informed about the progress and status of the order.</span></span> <span data-ttu-id="7ce28-264">O aplicativo e o Agendador são isolados um do outro para eliminar todas as dependências entre eles.</span><span class="sxs-lookup"><span data-stu-id="7ce28-264">The application and the Scheduler are isolated from each other to eliminate any dependencies between them.</span></span> <span data-ttu-id="7ce28-265">O aplicativo não sabe qual instância do Agendador está tratando o pedido e o Agendador não fica ciente de qual instância específica do aplicativo publicou o pedido.</span><span class="sxs-lookup"><span data-stu-id="7ce28-265">The application has no knowledge of which instance of the Scheduler is handling the order, and the Scheduler is unaware of which specific application instance posted the order.</span></span>

<span data-ttu-id="7ce28-266">Para permitir que o status do pedido seja relatado, o aplicativo pode usar sua própria fila de resposta privada.</span><span class="sxs-lookup"><span data-stu-id="7ce28-266">To allow the order status to be reported, the application could use its own private response queue.</span></span> <span data-ttu-id="7ce28-267">Os detalhes dessa fila de resposta seriam incluídos como parte da solicitação enviada para o processo de envio, que incluiria essas informações no repositório de estado.</span><span class="sxs-lookup"><span data-stu-id="7ce28-267">The details of this response queue would be included as part of the request sent to the submission process, which would include this information in the state store.</span></span> <span data-ttu-id="7ce28-268">O Agendador, então, publicaria mensagens nessa fila indicando o status do pedido (solicitação recebida, pedido concluído, pedido com falha e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="7ce28-268">The Scheduler would then post messages to this queue indicating the status of the order (request received, order completed, order failed, and so on).</span></span> <span data-ttu-id="7ce28-269">Ela deve incluir a ID do pedido nessas mensagens para que possam ser correlacionadas com a solicitação original pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7ce28-269">It should include the order ID in these messages so they can be correlated with the original request by the application.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="7ce28-270">Diretrizes e padrões relacionados</span><span class="sxs-lookup"><span data-stu-id="7ce28-270">Related patterns and guidance</span></span>

<span data-ttu-id="7ce28-271">Os padrões e diretrizes a seguir também podem ser relevantes ao implementar esse padrão:</span><span class="sxs-lookup"><span data-stu-id="7ce28-271">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="7ce28-272">[Padrão de repetição][retry-pattern].</span><span class="sxs-lookup"><span data-stu-id="7ce28-272">[Retry pattern][retry-pattern].</span></span> <span data-ttu-id="7ce28-273">Um Agente pode usar esse padrão para repetir de modo transparente uma operação que acessa um serviço ou recurso remoto que tenha falhado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-273">An Agent can use this pattern to transparently retry an operation that accesses a remote service or resource that has previously failed.</span></span> <span data-ttu-id="7ce28-274">Use quando a expectativa é de que a causa da falha é transitória e pode ser corrigida.</span><span class="sxs-lookup"><span data-stu-id="7ce28-274">Use when the expectation is that the cause of the failure is transient and can be corrected.</span></span>
- <span data-ttu-id="7ce28-275">[Padrão de disjuntor](circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="7ce28-275">[Circuit Breaker pattern](circuit-breaker.md).</span></span> <span data-ttu-id="7ce28-276">Um Agente pode usar esse padrão para tratar as falhas que consumem uma quantidade variável de tempo para serem corrigidas ao se conectar a um serviço ou recurso remoto.</span><span class="sxs-lookup"><span data-stu-id="7ce28-276">An Agent can use this pattern to handle faults that take a variable amount of time to correct when connecting to a remote service or resource.</span></span>
- <span data-ttu-id="7ce28-277">[Padrão de Transação de Compensação](compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="7ce28-277">[Compensating Transaction pattern](compensating-transaction.md).</span></span> <span data-ttu-id="7ce28-278">Se o fluxo de trabalho que está sendo executado por um Agendador não puder ser concluído com êxito, poderá ser necessário desfazer qualquer trabalho executado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="7ce28-278">If the workflow being performed by a Scheduler can't be completed successfully, it might be necessary to undo any work it's previously performed.</span></span> <span data-ttu-id="7ce28-279">O padrão de Transação de Compensação descreve como isso pode ser feito para operações que seguem o modelo de consistência futuro.</span><span class="sxs-lookup"><span data-stu-id="7ce28-279">The Compensating Transaction pattern describes how this can be achieved for operations that follow the eventual consistency model.</span></span> <span data-ttu-id="7ce28-280">Esses tipos de operações geralmente são implementados por um Agendador que executa fluxos de trabalho e processos de negócios complexos.</span><span class="sxs-lookup"><span data-stu-id="7ce28-280">These types of operations are commonly implemented by a Scheduler that performs complex business processes and workflows.</span></span>
- <span data-ttu-id="7ce28-281">[Prévia de mensagens assíncronas](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="7ce28-281">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="7ce28-282">Os componentes no padrão de Supervisor de Agente do Agendador normalmente são executados separados uns dos outros e se comunicam de forma assíncrona.</span><span class="sxs-lookup"><span data-stu-id="7ce28-282">The components in the Scheduler Agent Supervisor pattern typically run decoupled from each other and communicate asynchronously.</span></span> <span data-ttu-id="7ce28-283">Descreve algumas das abordagens que podem ser usadas para implementar a comunicação assíncrona com base em filas de mensagens.</span><span class="sxs-lookup"><span data-stu-id="7ce28-283">Describes some of the approaches that can be used to implement asynchronous communication based on message queues.</span></span>
- <span data-ttu-id="7ce28-284">[Padrão de eleição de líder](leader-election.md).</span><span class="sxs-lookup"><span data-stu-id="7ce28-284">[Leader Election pattern](leader-election.md).</span></span> <span data-ttu-id="7ce28-285">Talvez seja necessário coordenar as ações de várias instâncias de um Supervisor para impedir que tentem recuperar o mesmo processo com falha.</span><span class="sxs-lookup"><span data-stu-id="7ce28-285">It might be necessary to coordinate the actions of multiple instances of a Supervisor to prevent them from attempting to recover the same failed process.</span></span> <span data-ttu-id="7ce28-286">O padrão de eleição de líder descreve como fazer isso.</span><span class="sxs-lookup"><span data-stu-id="7ce28-286">The Leader Election pattern describes how to do this.</span></span>
- <span data-ttu-id="7ce28-287">[Arquitetura de nuvem: o padrão de Agendador-Agente-Supervisor](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) no blog de Clemens Vasters</span><span class="sxs-lookup"><span data-stu-id="7ce28-287">[Cloud Architecture: The Scheduler-Agent-Supervisor Pattern](https://blogs.msdn.microsoft.com/clemensv/2010/09/27/cloud-architecture-the-scheduler-agent-supervisor-pattern/) on Clemens Vasters' blog</span></span>
- [<span data-ttu-id="7ce28-288">Padrão de gerenciador de processo</span><span class="sxs-lookup"><span data-stu-id="7ce28-288">Process Manager pattern</span></span>](http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html)
- <span data-ttu-id="7ce28-289">[Referência 6: uma saga em Sagas](https://msdn.microsoft.com/library/jj591569.aspx).</span><span class="sxs-lookup"><span data-stu-id="7ce28-289">[Reference 6: A Saga on Sagas](https://msdn.microsoft.com/library/jj591569.aspx).</span></span> <span data-ttu-id="7ce28-290">Um exemplo que mostra como o padrão CQRS usa um gerenciador de processo (parte do guia Recurso CQRS).</span><span class="sxs-lookup"><span data-stu-id="7ce28-290">An example showing how the CQRS pattern uses a process manager (part of the CQRS Journey guidance).</span></span>
- [<span data-ttu-id="7ce28-291">Agendador do Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="7ce28-291">Microsoft Azure Scheduler</span></span>](https://azure.microsoft.com/services/scheduler/)

[retry-pattern]: ./retry.md

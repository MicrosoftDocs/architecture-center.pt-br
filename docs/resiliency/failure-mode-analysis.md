---
title: Análise do modo de falha
description: Diretrizes para executar a análise do modo de falha para soluções de nuvem baseadas no Azure.
author: MikeWasson
ms.date: 05/07/2018
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: resiliency
ms.openlocfilehash: 6d0f58161c5b9d5922c21f24b1b1a50bab836bb1
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54484271"
---
# <a name="failure-mode-analysis"></a><span data-ttu-id="8890a-103">Análise do modo de falha</span><span class="sxs-lookup"><span data-stu-id="8890a-103">Failure mode analysis</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="8890a-104">A FMA (análise do modo de falha) é um processo de criação de resiliência em um sistema por meio da identificação de possíveis pontos de falha no sistema.</span><span class="sxs-lookup"><span data-stu-id="8890a-104">Failure mode analysis (FMA) is a process for building resiliency into a system, by identifying possible failure points in the system.</span></span> <span data-ttu-id="8890a-105">A FMA deve ser parte das fases de arquitetura e de design para que você possa inserir a recuperação de falha no sistema desde o início.</span><span class="sxs-lookup"><span data-stu-id="8890a-105">The FMA should be part of the architecture and design phases, so that you can build failure recovery into the system from the beginning.</span></span>

<span data-ttu-id="8890a-106">Veja abaixo o processo geral para realizar uma FMA:</span><span class="sxs-lookup"><span data-stu-id="8890a-106">Here is the general process to conduct an FMA:</span></span>

1. <span data-ttu-id="8890a-107">Identifique todos os componentes no sistema.</span><span class="sxs-lookup"><span data-stu-id="8890a-107">Identify all of the components in the system.</span></span> <span data-ttu-id="8890a-108">Inclua dependências externas, por exemplo, provedores de identidade, serviços de terceiros e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="8890a-108">Include external dependencies, such as as identity providers, third-party services, and so on.</span></span>
2. <span data-ttu-id="8890a-109">Para cada componente, identifique possíveis falhas que possam ocorrer.</span><span class="sxs-lookup"><span data-stu-id="8890a-109">For each component, identify potential failures that could occur.</span></span> <span data-ttu-id="8890a-110">Um único componente pode ter mais de um modo de falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-110">A single component may have more than one failure mode.</span></span> <span data-ttu-id="8890a-111">Por exemplo, considere a possibilidade de falhas de leitura e de gravação separadamente, pois o impacto e as possíveis mitigações serão diferentes.</span><span class="sxs-lookup"><span data-stu-id="8890a-111">For example, you should consider read failures and write failures separately, because the impact and possible mitigations will be different.</span></span>
3. <span data-ttu-id="8890a-112">Classifique cada modo de falha de acordo com seu risco geral.</span><span class="sxs-lookup"><span data-stu-id="8890a-112">Rate each failure mode according to its overall risk.</span></span> <span data-ttu-id="8890a-113">Considere estes fatores:</span><span class="sxs-lookup"><span data-stu-id="8890a-113">Consider these factors:</span></span>

   - <span data-ttu-id="8890a-114">Qual é a probabilidade da falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-114">What is the likelihood of the failure.</span></span> <span data-ttu-id="8890a-115">Ela é relativamente comum?</span><span class="sxs-lookup"><span data-stu-id="8890a-115">Is it relatively common?</span></span> <span data-ttu-id="8890a-116">Extremamente rara?</span><span class="sxs-lookup"><span data-stu-id="8890a-116">Extrememly rare?</span></span> <span data-ttu-id="8890a-117">Não são necessários números exatos; o objetivo é ajudar a classificar a prioridade.</span><span class="sxs-lookup"><span data-stu-id="8890a-117">You don't need exact numbers; the purpose is to help rank the priority.</span></span>
   - <span data-ttu-id="8890a-118">Qual é o impacto no aplicativo em termos de disponibilidade, de perda de dados, do custo monetário e da interrupção dos negócios?</span><span class="sxs-lookup"><span data-stu-id="8890a-118">What is the impact on the application, in terms of availability, data loss, monetary cost, and business disruption?</span></span>

4. <span data-ttu-id="8890a-119">Para cada modo de falha, determinam como o aplicativo responderá e se recuperará.</span><span class="sxs-lookup"><span data-stu-id="8890a-119">For each failure mode, determine how the application will respond and recover.</span></span> <span data-ttu-id="8890a-120">Considere as compensações em relação aos custos e à complexidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-120">Consider tradeoffs in cost and application complexity.</span></span>

<span data-ttu-id="8890a-121">Como ponto de partida para o processo de FMA, este artigo contém um catálogo de possíveis modos de falha e suas mitigações.</span><span class="sxs-lookup"><span data-stu-id="8890a-121">As a starting point for your FMA process, this article contains a catalog of potential failure modes and their mitigations.</span></span> <span data-ttu-id="8890a-122">O catálogo é organizado por tecnologia ou serviço do Azure, além de uma categoria geral para o design em nível do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-122">The catalog is organized by technology or Azure service, plus a general category for application-level design.</span></span> <span data-ttu-id="8890a-123">O catálogo não é completo, mas abrange muitos dos principais serviços do Azure.</span><span class="sxs-lookup"><span data-stu-id="8890a-123">The catalog is not exhaustive, but covers many of the core Azure services.</span></span>

## <a name="app-service"></a><span data-ttu-id="8890a-124">Serviço de Aplicativo</span><span class="sxs-lookup"><span data-stu-id="8890a-124">App Service</span></span>

<!-- markdownlint-disable MD026 -->

### <a name="app-service-app-shuts-down"></a><span data-ttu-id="8890a-125">Aplicativo do Serviço de Aplicativo desliga.</span><span class="sxs-lookup"><span data-stu-id="8890a-125">App Service app shuts down.</span></span>

<span data-ttu-id="8890a-126">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-126">**Detection**.</span></span> <span data-ttu-id="8890a-127">Possíveis causas:</span><span class="sxs-lookup"><span data-stu-id="8890a-127">Possible causes:</span></span>

- <span data-ttu-id="8890a-128">Desligamento esperado</span><span class="sxs-lookup"><span data-stu-id="8890a-128">Expected shutdown</span></span>

  - <span data-ttu-id="8890a-129">Um operador desliga o aplicativo, por exemplo, usando o Portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="8890a-129">An operator shuts down the application; for example, using the Azure portal.</span></span>
  - <span data-ttu-id="8890a-130">O aplicativo foi descarregado porque estava ocioso.</span><span class="sxs-lookup"><span data-stu-id="8890a-130">The app was unloaded because it was idle.</span></span> <span data-ttu-id="8890a-131">(Somente se a configuração `Always On` estiver desabilitada.)</span><span class="sxs-lookup"><span data-stu-id="8890a-131">(Only if the `Always On` setting is disabled.)</span></span>

- <span data-ttu-id="8890a-132">Desligamento inesperado</span><span class="sxs-lookup"><span data-stu-id="8890a-132">Unexpected shutdown</span></span>

  - <span data-ttu-id="8890a-133">Falha no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-133">The app crashes.</span></span>
  - <span data-ttu-id="8890a-134">Uma instância VM do Serviço de Aplicativo torna-se não disponível.</span><span class="sxs-lookup"><span data-stu-id="8890a-134">An App Service VM instance becomes unavailable.</span></span>

<span data-ttu-id="8890a-135">O log Application_End detectará o desligamento do domínio do aplicativo (falha simples de processo) e será a única maneira de detectar os desligamentos do domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-135">Application_End logging will catch the app domain shutdown (soft process crash) and is the only way to catch the application domain shutdowns.</span></span>

<span data-ttu-id="8890a-136">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-136">**Recovery:**</span></span>

- <span data-ttu-id="8890a-137">Se o desligamento for esperado, use o evento de desligamento do aplicativo para desligá-lo normalmente.</span><span class="sxs-lookup"><span data-stu-id="8890a-137">If the shutdown was expected, use the application's shutdown event to shut down gracefully.</span></span> <span data-ttu-id="8890a-138">Por exemplo, no ASP.NET, use o método `Application_End`.</span><span class="sxs-lookup"><span data-stu-id="8890a-138">For example, in ASP.NET, use the `Application_End` method.</span></span>
- <span data-ttu-id="8890a-139">Se o aplicativo for descarregado quando ocioso, ele será reiniciado automaticamente na próxima solicitação.</span><span class="sxs-lookup"><span data-stu-id="8890a-139">If the application was unloaded while idle, it is automatically restarted on the next request.</span></span> <span data-ttu-id="8890a-140">No entanto, ocorrerá a "inicialização a frio".</span><span class="sxs-lookup"><span data-stu-id="8890a-140">However, you will incur the "cold start" cost.</span></span>
- <span data-ttu-id="8890a-141">Para impedir que o aplicativo seja descarregado quando ocioso, habilite a configuração `Always On` no aplicativo Web.</span><span class="sxs-lookup"><span data-stu-id="8890a-141">To prevent the application from being unloaded while idle, enable the `Always On` setting in the web app.</span></span> <span data-ttu-id="8890a-142">Veja [Configurar aplicativos Web no Serviço de Aplicativo do Azure][app-service-configure].</span><span class="sxs-lookup"><span data-stu-id="8890a-142">See [Configure web apps in Azure App Service][app-service-configure].</span></span>
- <span data-ttu-id="8890a-143">Para impedir que um operador desligue o aplicativo, defina um bloqueio de recurso com o nível `ReadOnly`.</span><span class="sxs-lookup"><span data-stu-id="8890a-143">To prevent an operator from shutting down the app, set a resource lock with `ReadOnly` level.</span></span> <span data-ttu-id="8890a-144">Veja [Bloquear recursos com o Azure Resource Manager][rm-locks].</span><span class="sxs-lookup"><span data-stu-id="8890a-144">See [Lock resources with Azure Resource Manager][rm-locks].</span></span>
- <span data-ttu-id="8890a-145">Se o aplicativo falhar ou se uma VM do Serviço de Aplicativo ficar não disponível, o Serviço de Aplicativo reiniciará automaticamente o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-145">If the app crashes or an App Service VM becomes unavailable, App Service automatically restarts the app.</span></span>

<span data-ttu-id="8890a-146">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-146">**Diagnostics**.</span></span> <span data-ttu-id="8890a-147">Logs do aplicativo e logs do servidor Web.</span><span class="sxs-lookup"><span data-stu-id="8890a-147">Application logs and web server logs.</span></span> <span data-ttu-id="8890a-148">Veja [Habilitar o registro em log de diagnóstico para aplicativos Web no Serviço de Aplicativo do Azure][app-service-logging].</span><span class="sxs-lookup"><span data-stu-id="8890a-148">See [Enable diagnostics logging for web apps in Azure App Service][app-service-logging].</span></span>

### <a name="a-particular-user-repeatedly-makes-bad-requests-or-overloads-the-system"></a><span data-ttu-id="8890a-149">Um usuário específico repetidamente faz solicitações inválidas ou sobrecarrega o sistema.</span><span class="sxs-lookup"><span data-stu-id="8890a-149">A particular user repeatedly makes bad requests or overloads the system.</span></span>

<span data-ttu-id="8890a-150">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-150">**Detection**.</span></span> <span data-ttu-id="8890a-151">Autentique os usuários e inclua a ID de usuário nos logs do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-151">Authenticate users and include user ID in application logs.</span></span>

<span data-ttu-id="8890a-152">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-152">**Recovery:**</span></span>

- <span data-ttu-id="8890a-153">Use o [Gerenciamento de API do Azure][api-management] para limitar as solicitações do usuário.</span><span class="sxs-lookup"><span data-stu-id="8890a-153">Use [Azure API Management][api-management] to throttle requests from the user.</span></span> <span data-ttu-id="8890a-154">Veja [Limitação de solicitação avançada com o Gerenciamento de API do Azure][api-management-throttling]</span><span class="sxs-lookup"><span data-stu-id="8890a-154">See [Advanced request throttling with Azure API Management][api-management-throttling]</span></span>
- <span data-ttu-id="8890a-155">Bloqueie o usuário.</span><span class="sxs-lookup"><span data-stu-id="8890a-155">Block the user.</span></span>

<span data-ttu-id="8890a-156">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-156">**Diagnostics**.</span></span> <span data-ttu-id="8890a-157">Registre em log todas as solicitações de autenticação.</span><span class="sxs-lookup"><span data-stu-id="8890a-157">Log all authentication requests.</span></span>

### <a name="a-bad-update-was-deployed"></a><span data-ttu-id="8890a-158">Uma atualização inválida foi implantada.</span><span class="sxs-lookup"><span data-stu-id="8890a-158">A bad update was deployed.</span></span>

<span data-ttu-id="8890a-159">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-159">**Detection**.</span></span> <span data-ttu-id="8890a-160">Monitore a integridade do aplicativo por meio do Portal do Azure (veja [Monitorar o desempenho do aplicativo Web do Azure][app-insights-web-apps]) ou implemente o [padrão de monitoramento do ponto de extremidade de integridade][health-endpoint-monitoring-pattern].</span><span class="sxs-lookup"><span data-stu-id="8890a-160">Monitor the application health through the Azure Portal (see [Monitor Azure web app performance][app-insights-web-apps]) or implement the [health endpoint monitoring pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="8890a-161">**Recuperação:**.</span><span class="sxs-lookup"><span data-stu-id="8890a-161">**Recovery:**.</span></span> <span data-ttu-id="8890a-162">Use vários [slots de implantação][app-service-slots] e reverta para a última implantação válida conhecida.</span><span class="sxs-lookup"><span data-stu-id="8890a-162">Use multiple [deployment slots][app-service-slots] and roll back to the last-known-good deployment.</span></span> <span data-ttu-id="8890a-163">Para obter mais informações, veja [Basic web application][ra-web-apps-basic] (Aplicativo Web básico).</span><span class="sxs-lookup"><span data-stu-id="8890a-163">For more information, see [Basic web application][ra-web-apps-basic].</span></span>

## <a name="azure-active-directory"></a><span data-ttu-id="8890a-164">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8890a-164">Azure Active Directory</span></span>

### <a name="openid-connect-oidc-authentication-fails"></a><span data-ttu-id="8890a-165">Falha na autenticação OIDC (OpenID Connect).</span><span class="sxs-lookup"><span data-stu-id="8890a-165">OpenID Connect (OIDC) authentication fails.</span></span>

<span data-ttu-id="8890a-166">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-166">**Detection**.</span></span> <span data-ttu-id="8890a-167">Os possíveis modos de falha incluem:</span><span class="sxs-lookup"><span data-stu-id="8890a-167">Possible failure modes include:</span></span>

1. <span data-ttu-id="8890a-168">O Azure AD não está disponível ou não pode ser acessado devido a um problema de rede.</span><span class="sxs-lookup"><span data-stu-id="8890a-168">Azure AD is not available, or cannot be reached due to a network problem.</span></span> <span data-ttu-id="8890a-169">Falha no redirecionamento para o ponto de extremidade de autenticação e o middleware OIDC gera uma exceção.</span><span class="sxs-lookup"><span data-stu-id="8890a-169">Redirection to the authentication endpoint fails, and the OIDC middleware throws an exception.</span></span>
2. <span data-ttu-id="8890a-170">O locatário do Azure AD não existe.</span><span class="sxs-lookup"><span data-stu-id="8890a-170">Azure AD tenant does not exist.</span></span> <span data-ttu-id="8890a-171">O redirecionamento para o ponto de extremidade de autenticação retorna um código de erro HTTP e o middleware OIDC gera uma exceção.</span><span class="sxs-lookup"><span data-stu-id="8890a-171">Redirection to the authentication endpoint returns an HTTP error code, and the OIDC middleware throws an exception.</span></span>
3. <span data-ttu-id="8890a-172">O usuário não pode se conectar.</span><span class="sxs-lookup"><span data-stu-id="8890a-172">User cannot authenticate.</span></span> <span data-ttu-id="8890a-173">Nenhuma estratégia de detecção é necessária. O Azure AD resolve as falhas de logon.</span><span class="sxs-lookup"><span data-stu-id="8890a-173">No detection strategy is necessary; Azure AD handles login failures.</span></span>

<span data-ttu-id="8890a-174">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-174">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-175">Detecte exceções sem tratamento do middleware.</span><span class="sxs-lookup"><span data-stu-id="8890a-175">Catch unhandled exceptions from the middleware.</span></span>
2. <span data-ttu-id="8890a-176">Trate os eventos `AuthenticationFailed`.</span><span class="sxs-lookup"><span data-stu-id="8890a-176">Handle `AuthenticationFailed` events.</span></span>
3. <span data-ttu-id="8890a-177">Redirecione o usuário para uma página de erro.</span><span class="sxs-lookup"><span data-stu-id="8890a-177">Redirect the user to an error page.</span></span>
4. <span data-ttu-id="8890a-178">O usuário tenta novamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-178">User retries.</span></span>

## <a name="azure-search"></a><span data-ttu-id="8890a-179">Azure Search</span><span class="sxs-lookup"><span data-stu-id="8890a-179">Azure Search</span></span>

### <a name="writing-data-to-azure-search-fails"></a><span data-ttu-id="8890a-180">Falha ao gravar dados do Azure Search.</span><span class="sxs-lookup"><span data-stu-id="8890a-180">Writing data to Azure Search fails.</span></span>

<span data-ttu-id="8890a-181">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-181">**Detection**.</span></span> <span data-ttu-id="8890a-182">Detecte erros `Microsoft.Rest.Azure.CloudException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-182">Catch `Microsoft.Rest.Azure.CloudException` errors.</span></span>

<span data-ttu-id="8890a-183">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-183">**Recovery:**</span></span>

<span data-ttu-id="8890a-184">O [SDK .NET do Search][search-sdk] tenta novamente de maneira automática após falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-184">The [Search .NET SDK][search-sdk] automatically retries after transient failures.</span></span> <span data-ttu-id="8890a-185">As exceções geradas pelo SDK cliente devem ser tratadas como erros não transitórios.</span><span class="sxs-lookup"><span data-stu-id="8890a-185">Any exceptions thrown by the client SDK should be treated as non-transient errors.</span></span>

<span data-ttu-id="8890a-186">A política de novas tentativas padrão usa retirada exponencial.</span><span class="sxs-lookup"><span data-stu-id="8890a-186">The default retry policy uses exponential back-off.</span></span> <span data-ttu-id="8890a-187">Para usar uma política de novas tentativas diferente, chame `SetRetryPolicy` na classe `SearchIndexClient` ou `SearchServiceClient`.</span><span class="sxs-lookup"><span data-stu-id="8890a-187">To use a different retry policy, call `SetRetryPolicy` on the `SearchIndexClient` or `SearchServiceClient` class.</span></span> <span data-ttu-id="8890a-188">Para obter mais informações, veja [Tentativas automáticas][auto-rest-client-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-188">For more information, see [Automatic Retries][auto-rest-client-retry].</span></span>

<span data-ttu-id="8890a-189">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-189">**Diagnostics**.</span></span> <span data-ttu-id="8890a-190">Use a [Análise de Tráfego de Pesquisa][search-analytics].</span><span class="sxs-lookup"><span data-stu-id="8890a-190">Use [Search Traffic Analytics][search-analytics].</span></span>

### <a name="reading-data-from-azure-search-fails"></a><span data-ttu-id="8890a-191">Falha ao ler dados do Azure Search.</span><span class="sxs-lookup"><span data-stu-id="8890a-191">Reading data from Azure Search fails.</span></span>

<span data-ttu-id="8890a-192">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-192">**Detection**.</span></span> <span data-ttu-id="8890a-193">Detecte erros `Microsoft.Rest.Azure.CloudException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-193">Catch `Microsoft.Rest.Azure.CloudException` errors.</span></span>

<span data-ttu-id="8890a-194">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-194">**Recovery:**</span></span>

<span data-ttu-id="8890a-195">O [SDK .NET do Search][search-sdk] tenta novamente de maneira automática após falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-195">The [Search .NET SDK][search-sdk]  automatically retries after transient failures.</span></span> <span data-ttu-id="8890a-196">As exceções geradas pelo SDK cliente devem ser tratadas como erros não transitórios.</span><span class="sxs-lookup"><span data-stu-id="8890a-196">Any exceptions thrown by the client SDK should be treated as non-transient errors.</span></span>

<span data-ttu-id="8890a-197">A política de novas tentativas padrão usa retirada exponencial.</span><span class="sxs-lookup"><span data-stu-id="8890a-197">The default retry policy uses exponential back-off.</span></span> <span data-ttu-id="8890a-198">Para usar uma política de novas tentativas diferente, chame `SetRetryPolicy` na classe `SearchIndexClient` ou `SearchServiceClient`.</span><span class="sxs-lookup"><span data-stu-id="8890a-198">To use a different retry policy, call `SetRetryPolicy` on the `SearchIndexClient` or `SearchServiceClient` class.</span></span> <span data-ttu-id="8890a-199">Para obter mais informações, veja [Tentativas automáticas][auto-rest-client-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-199">For more information, see [Automatic Retries][auto-rest-client-retry].</span></span>

<span data-ttu-id="8890a-200">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-200">**Diagnostics**.</span></span> <span data-ttu-id="8890a-201">Use a [Análise de Tráfego de Pesquisa][search-analytics].</span><span class="sxs-lookup"><span data-stu-id="8890a-201">Use [Search Traffic Analytics][search-analytics].</span></span>

## <a name="cassandra"></a><span data-ttu-id="8890a-202">Cassandra</span><span class="sxs-lookup"><span data-stu-id="8890a-202">Cassandra</span></span>

### <a name="reading-or-writing-to-a-node-fails"></a><span data-ttu-id="8890a-203">Falha de leitura ou de gravação em um nó.</span><span class="sxs-lookup"><span data-stu-id="8890a-203">Reading or writing to a node fails.</span></span>

<span data-ttu-id="8890a-204">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-204">**Detection**.</span></span> <span data-ttu-id="8890a-205">Detecte a exceção.</span><span class="sxs-lookup"><span data-stu-id="8890a-205">Catch the exception.</span></span> <span data-ttu-id="8890a-206">Para clientes .NET, normalmente será `System.Web.HttpException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-206">For .NET clients, this will typically be `System.Web.HttpException`.</span></span> <span data-ttu-id="8890a-207">Outro cliente pode ter outros tipos de exceção.</span><span class="sxs-lookup"><span data-stu-id="8890a-207">Other client may have other exception types.</span></span>  <span data-ttu-id="8890a-208">Para obter mais informações, veja [Cassandra error handling done right](https://www.datastax.com/dev/blog/cassandra-error-handling-done-right) (Tratamento de erro do Cassandra feito da maneira correta).</span><span class="sxs-lookup"><span data-stu-id="8890a-208">For more information, see [Cassandra error handling done right](https://www.datastax.com/dev/blog/cassandra-error-handling-done-right).</span></span>

<span data-ttu-id="8890a-209">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-209">**Recovery:**</span></span>

- <span data-ttu-id="8890a-210">Cada [cliente Cassandra](https://wiki.apache.org/cassandra/ClientOptions) tem suas próprias políticas de novas tentativas e funcionalidades.</span><span class="sxs-lookup"><span data-stu-id="8890a-210">Each [Cassandra client](https://wiki.apache.org/cassandra/ClientOptions) has its own retry policies and capabilities.</span></span> <span data-ttu-id="8890a-211">Para obter mais informações, veja [Cassandra error handling done right][cassandra-error-handling] (Tratamento de erro do Cassandra feito da maneira correta).</span><span class="sxs-lookup"><span data-stu-id="8890a-211">For more information, see [Cassandra error handling done right][cassandra-error-handling].</span></span>
- <span data-ttu-id="8890a-212">Use uma implantação com reconhecimento de rack, com nós de dados distribuídos entre os domínios de falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-212">Use a rack-aware deployment, with data nodes distributed across the fault domains.</span></span>
- <span data-ttu-id="8890a-213">Implante em várias regiões com consistência de quorum local.</span><span class="sxs-lookup"><span data-stu-id="8890a-213">Deploy to multiple regions with local quorum consistency.</span></span> <span data-ttu-id="8890a-214">Se ocorrer uma falha não transitória, faça failover para outra região.</span><span class="sxs-lookup"><span data-stu-id="8890a-214">If a non-transient failure occurs, fail over to another region.</span></span>

<span data-ttu-id="8890a-215">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-215">**Diagnostics**.</span></span> <span data-ttu-id="8890a-216">Logs de aplicativo</span><span class="sxs-lookup"><span data-stu-id="8890a-216">Application logs</span></span>

## <a name="cloud-service"></a><span data-ttu-id="8890a-217">Serviço de Nuvem</span><span class="sxs-lookup"><span data-stu-id="8890a-217">Cloud Service</span></span>

### <a name="web-or-worker-roles-are-unexpectedlybeing-shut-down"></a><span data-ttu-id="8890a-218">Funções de trabalho ou Web estão sendo desligadas inesperadamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-218">Web or worker roles are unexpectedly being shut down.</span></span>

<span data-ttu-id="8890a-219">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-219">**Detection**.</span></span> <span data-ttu-id="8890a-220">O evento [RoleEnvironment.Stopping][RoleEnvironment.Stopping] é disparado.</span><span class="sxs-lookup"><span data-stu-id="8890a-220">The [RoleEnvironment.Stopping][RoleEnvironment.Stopping] event is fired.</span></span>

<span data-ttu-id="8890a-221">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-221">**Recovery**.</span></span> <span data-ttu-id="8890a-222">Substitua o método [RoleEntryPoint.OnStop][RoleEntryPoint.OnStop] para executar uma limpeza normal.</span><span class="sxs-lookup"><span data-stu-id="8890a-222">Override the [RoleEntryPoint.OnStop][RoleEntryPoint.OnStop] method to gracefully clean up.</span></span> <span data-ttu-id="8890a-223">Para obter mais informações, veja [The Right Way to Handle Azure OnStop Events][onstop-events] (A maneira correta de tratar eventos OnStop do Azure) (blog).</span><span class="sxs-lookup"><span data-stu-id="8890a-223">For more information, see [The Right Way to Handle Azure OnStop Events][onstop-events] (blog).</span></span>

## <a name="cosmos-db"></a><span data-ttu-id="8890a-224">Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="8890a-224">Cosmos DB</span></span>

### <a name="reading-data-fails"></a><span data-ttu-id="8890a-225">Falha na leitura de dados.</span><span class="sxs-lookup"><span data-stu-id="8890a-225">Reading data fails.</span></span>

<span data-ttu-id="8890a-226">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-226">**Detection**.</span></span> <span data-ttu-id="8890a-227">Detecte `System.Net.Http.HttpRequestException` ou `Microsoft.Azure.Documents.DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-227">Catch `System.Net.Http.HttpRequestException` or `Microsoft.Azure.Documents.DocumentClientException`.</span></span>

<span data-ttu-id="8890a-228">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-228">**Recovery:**</span></span>

- <span data-ttu-id="8890a-229">O SDK tenta novamente de maneira automática em caso de tentativas com falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-229">The SDK automatically retries failed attempts.</span></span> <span data-ttu-id="8890a-230">Para definir o número de novas tentativas e o tempo de espera máximo, configure `ConnectionPolicy.RetryOptions`.</span><span class="sxs-lookup"><span data-stu-id="8890a-230">To set the number of retries and the maximum wait time, configure `ConnectionPolicy.RetryOptions`.</span></span> <span data-ttu-id="8890a-231">As exceções que o cliente gera excedem a política de repetição ou não são erros transitórios.</span><span class="sxs-lookup"><span data-stu-id="8890a-231">Exceptions that the client raises are either beyond the retry policy or are not transient errors.</span></span>
- <span data-ttu-id="8890a-232">Se o Cosmos DB limitar o cliente, ele retornará um erro HTTP 429.</span><span class="sxs-lookup"><span data-stu-id="8890a-232">If Cosmos DB throttles the client, it returns an HTTP 429 error.</span></span> <span data-ttu-id="8890a-233">Confira o código de status no `DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-233">Check the status code in the `DocumentClientException`.</span></span> <span data-ttu-id="8890a-234">Se você estiver recebendo o erro 429 consistentemente, considere aumentar o valor da taxa de transferência da coleção.</span><span class="sxs-lookup"><span data-stu-id="8890a-234">If you are getting error 429 consistently, consider increasing the throughput value of the collection.</span></span>
  - <span data-ttu-id="8890a-235">Se você estiver usando a API do MongoDB, o serviço retornará o código de erro 16500 durante a limitação.</span><span class="sxs-lookup"><span data-stu-id="8890a-235">If you are using the MongoDB API, the service returns error code 16500 when throttling.</span></span>
- <span data-ttu-id="8890a-236">Replique o banco de dados do Cosmos DB em duas ou mais regiões.</span><span class="sxs-lookup"><span data-stu-id="8890a-236">Replicate the Cosmos DB database across two or more regions.</span></span> <span data-ttu-id="8890a-237">Todas as réplicas são legíveis.</span><span class="sxs-lookup"><span data-stu-id="8890a-237">All replicas are readable.</span></span> <span data-ttu-id="8890a-238">Usando os SDKs cliente, especifique o parâmetro `PreferredLocations`.</span><span class="sxs-lookup"><span data-stu-id="8890a-238">Using the client SDKs, specify the `PreferredLocations` parameter.</span></span> <span data-ttu-id="8890a-239">Trata-se de uma lista ordenada de regiões do Azure.</span><span class="sxs-lookup"><span data-stu-id="8890a-239">This is an ordered list of Azure regions.</span></span> <span data-ttu-id="8890a-240">Todas as leituras serão enviadas para a primeira região disponível na lista.</span><span class="sxs-lookup"><span data-stu-id="8890a-240">All reads will be sent to the first available region in the list.</span></span> <span data-ttu-id="8890a-241">Se a solicitação falhar, o cliente tentará outras regiões na lista, em ordem.</span><span class="sxs-lookup"><span data-stu-id="8890a-241">If the request fails, the client will try the other regions in the list, in order.</span></span> <span data-ttu-id="8890a-242">Para obter mais informações, confira [Como configurar a distribuição global do Azure Cosmos DB usando a API do SQL][cosmosdb-multi-region].</span><span class="sxs-lookup"><span data-stu-id="8890a-242">For more information, see [How to setup Azure Cosmos DB global distribution using the SQL API][cosmosdb-multi-region].</span></span>

<span data-ttu-id="8890a-243">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-243">**Diagnostics**.</span></span> <span data-ttu-id="8890a-244">Registre em log todos os erros no lado do cliente.</span><span class="sxs-lookup"><span data-stu-id="8890a-244">Log all errors on the client side.</span></span>

### <a name="writing-data-fails"></a><span data-ttu-id="8890a-245">Falha na gravação de dados.</span><span class="sxs-lookup"><span data-stu-id="8890a-245">Writing data fails.</span></span>

<span data-ttu-id="8890a-246">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-246">**Detection**.</span></span> <span data-ttu-id="8890a-247">Detecte `System.Net.Http.HttpRequestException` ou `Microsoft.Azure.Documents.DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-247">Catch `System.Net.Http.HttpRequestException` or `Microsoft.Azure.Documents.DocumentClientException`.</span></span>

<span data-ttu-id="8890a-248">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-248">**Recovery:**</span></span>

- <span data-ttu-id="8890a-249">O SDK tenta novamente de maneira automática em caso de tentativas com falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-249">The SDK automatically retries failed attempts.</span></span> <span data-ttu-id="8890a-250">Para definir o número de novas tentativas e o tempo de espera máximo, configure `ConnectionPolicy.RetryOptions`.</span><span class="sxs-lookup"><span data-stu-id="8890a-250">To set the number of retries and the maximum wait time, configure `ConnectionPolicy.RetryOptions`.</span></span> <span data-ttu-id="8890a-251">As exceções que o cliente gera excedem a política de repetição ou não são erros transitórios.</span><span class="sxs-lookup"><span data-stu-id="8890a-251">Exceptions that the client raises are either beyond the retry policy or are not transient errors.</span></span>
- <span data-ttu-id="8890a-252">Se o Cosmos DB limitar o cliente, ele retornará um erro HTTP 429.</span><span class="sxs-lookup"><span data-stu-id="8890a-252">If Cosmos DB throttles the client, it returns an HTTP 429 error.</span></span> <span data-ttu-id="8890a-253">Confira o código de status no `DocumentClientException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-253">Check the status code in the `DocumentClientException`.</span></span> <span data-ttu-id="8890a-254">Se você estiver recebendo o erro 429 consistentemente, considere aumentar o valor da taxa de transferência da coleção.</span><span class="sxs-lookup"><span data-stu-id="8890a-254">If you are getting error 429 consistently, consider increasing the throughput value of the collection.</span></span>
- <span data-ttu-id="8890a-255">Replique o banco de dados do Cosmos DB em duas ou mais regiões.</span><span class="sxs-lookup"><span data-stu-id="8890a-255">Replicate the Cosmos DB database across two or more regions.</span></span> <span data-ttu-id="8890a-256">Se a região primária falhar, outra região será promovida para gravação.</span><span class="sxs-lookup"><span data-stu-id="8890a-256">If the primary region fails, another region will be promoted to write.</span></span> <span data-ttu-id="8890a-257">Você também pode disparar um failover manual.</span><span class="sxs-lookup"><span data-stu-id="8890a-257">You can also trigger a failover manually.</span></span> <span data-ttu-id="8890a-258">O SDK faz a descoberta e roteamento automáticos para que o código do aplicativo continue a funcionar após um failover.</span><span class="sxs-lookup"><span data-stu-id="8890a-258">The SDK does automatic discovery and routing, so application code continues to work after a failover.</span></span> <span data-ttu-id="8890a-259">Durante o período do failover (normalmente alguns minutos), as operações de gravação terão latência mais alta, enquanto o SDK localizar a nova região de gravação.</span><span class="sxs-lookup"><span data-stu-id="8890a-259">During the failover period (typically minutes), write operations will have higher latency, as the SDK finds the new write region.</span></span> <span data-ttu-id="8890a-260">Para obter mais informações, confira [Como configurar a distribuição global do Azure Cosmos DB usando a API do SQL][cosmosdb-multi-region].</span><span class="sxs-lookup"><span data-stu-id="8890a-260">For more information, see [How to setup Azure Cosmos DB global distribution using the SQL API][cosmosdb-multi-region].</span></span>
- <span data-ttu-id="8890a-261">Como fallback, mantenha o documento em uma fila de backup e processe a fila mais tarde.</span><span class="sxs-lookup"><span data-stu-id="8890a-261">As a fallback, persist the document to a backup queue, and process the queue later.</span></span>

<span data-ttu-id="8890a-262">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-262">**Diagnostics**.</span></span> <span data-ttu-id="8890a-263">Registre em log todos os erros no lado do cliente.</span><span class="sxs-lookup"><span data-stu-id="8890a-263">Log all errors on the client side.</span></span>

## <a name="elasticsearch"></a><span data-ttu-id="8890a-264">Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="8890a-264">Elasticsearch</span></span>

### <a name="reading-data-from-elasticsearch-fails"></a><span data-ttu-id="8890a-265">Falha na leitura de dados do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="8890a-265">Reading data from Elasticsearch fails.</span></span>

<span data-ttu-id="8890a-266">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-266">**Detection**.</span></span> <span data-ttu-id="8890a-267">Capture a exceção apropriada para o [cliente Elasticsearch][elasticsearch-client] específico sendo usado.</span><span class="sxs-lookup"><span data-stu-id="8890a-267">Catch the appropriate exception for the particular [Elasticsearch client][elasticsearch-client] being used.</span></span>

<span data-ttu-id="8890a-268">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-268">**Recovery:**</span></span>

- <span data-ttu-id="8890a-269">Use um mecanismo de novas tentativas.</span><span class="sxs-lookup"><span data-stu-id="8890a-269">Use a retry mechanism.</span></span> <span data-ttu-id="8890a-270">Cada cliente tem suas próprias políticas de novas tentativas.</span><span class="sxs-lookup"><span data-stu-id="8890a-270">Each client has its own retry policies.</span></span>
- <span data-ttu-id="8890a-271">Implante vários nós do Elasticsearch e use a replicação para obter alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="8890a-271">Deploy multiple Elasticsearch nodes and use replication for high availability.</span></span>

<span data-ttu-id="8890a-272">Para obter mais informações, veja [Executar o Elasticsearch no Azure][elasticsearch-azure].</span><span class="sxs-lookup"><span data-stu-id="8890a-272">For more information, see [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

<span data-ttu-id="8890a-273">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-273">**Diagnostics**.</span></span> <span data-ttu-id="8890a-274">Você pode usar ferramentas de monitoramento para Elasticsearch ou registrar todos os erros no lado do cliente com a conteúdo.</span><span class="sxs-lookup"><span data-stu-id="8890a-274">You can use monitoring tools for Elasticsearch, or log all errors on the client side with the payload.</span></span> <span data-ttu-id="8890a-275">Consulte a seção "Monitoramento" em [Executar o Elasticsearch no Azure][elasticsearch-azure].</span><span class="sxs-lookup"><span data-stu-id="8890a-275">See the 'Monitoring' section in [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

### <a name="writing-data-to-elasticsearch-fails"></a><span data-ttu-id="8890a-276">Falha na gravação de dados no Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="8890a-276">Writing data to Elasticsearch fails.</span></span>

<span data-ttu-id="8890a-277">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-277">**Detection**.</span></span> <span data-ttu-id="8890a-278">Capture a exceção apropriada para o [cliente Elasticsearch][elasticsearch-client] específico sendo usado.</span><span class="sxs-lookup"><span data-stu-id="8890a-278">Catch the appropriate exception for the particular [Elasticsearch client][elasticsearch-client] being used.</span></span>

<span data-ttu-id="8890a-279">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-279">**Recovery:**</span></span>

- <span data-ttu-id="8890a-280">Use um mecanismo de novas tentativas.</span><span class="sxs-lookup"><span data-stu-id="8890a-280">Use a retry mechanism.</span></span> <span data-ttu-id="8890a-281">Cada cliente tem suas próprias políticas de novas tentativas.</span><span class="sxs-lookup"><span data-stu-id="8890a-281">Each client has its own retry policies.</span></span>
- <span data-ttu-id="8890a-282">Se o aplicativo puder tolerar um nível de consistência reduzido, considere gravar com a configuração `write_consistency` de `quorum`.</span><span class="sxs-lookup"><span data-stu-id="8890a-282">If the application can tolerate a reduced consistency level, consider writing with `write_consistency` setting of `quorum`.</span></span>

<span data-ttu-id="8890a-283">Para obter mais informações, veja [Executar o Elasticsearch no Azure][elasticsearch-azure].</span><span class="sxs-lookup"><span data-stu-id="8890a-283">For more information, see [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

<span data-ttu-id="8890a-284">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-284">**Diagnostics**.</span></span> <span data-ttu-id="8890a-285">Você pode usar ferramentas de monitoramento para Elasticsearch ou registrar todos os erros no lado do cliente com a conteúdo.</span><span class="sxs-lookup"><span data-stu-id="8890a-285">You can use monitoring tools for Elasticsearch, or log all errors on the client side with the payload.</span></span> <span data-ttu-id="8890a-286">Consulte a seção "Monitoramento" em [Executar o Elasticsearch no Azure][elasticsearch-azure].</span><span class="sxs-lookup"><span data-stu-id="8890a-286">See the 'Monitoring' section in [Running Elasticsearch on Azure][elasticsearch-azure].</span></span>

## <a name="queue-storage"></a><span data-ttu-id="8890a-287">Armazenamento de filas</span><span class="sxs-lookup"><span data-stu-id="8890a-287">Queue storage</span></span>

### <a name="writing-a-message-to-azure-queue-storage-fails-consistently"></a><span data-ttu-id="8890a-288">Falha consistente na gravação de uma mensagem do Armazenamento de Filas do Azure.</span><span class="sxs-lookup"><span data-stu-id="8890a-288">Writing a message to Azure Queue storage fails consistently.</span></span>

<span data-ttu-id="8890a-289">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-289">**Detection**.</span></span> <span data-ttu-id="8890a-290">Depois de *N* novas tentativas, ainda há falha na operação de gravação.</span><span class="sxs-lookup"><span data-stu-id="8890a-290">After *N* retry attempts, the write operation still fails.</span></span>

<span data-ttu-id="8890a-291">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-291">**Recovery:**</span></span>

- <span data-ttu-id="8890a-292">Armazene os dados em um cache local e encaminhe as gravações para o armazenamento mais tarde, quando o serviço estiver disponível.</span><span class="sxs-lookup"><span data-stu-id="8890a-292">Store the data in a local cache, and forward the writes to storage later, when the service becomes available.</span></span>
- <span data-ttu-id="8890a-293">Crie uma fila secundária e grave nessa fila se a fila principal não estiver disponível.</span><span class="sxs-lookup"><span data-stu-id="8890a-293">Create a secondary queue, and write to that queue if the primary queue is unavailable.</span></span>

<span data-ttu-id="8890a-294">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-294">**Diagnostics**.</span></span> <span data-ttu-id="8890a-295">Use [métricas de armazenamento][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="8890a-295">Use [storage metrics][storage-metrics].</span></span>

### <a name="the-application-cannot-process-a-particular-message-from-the-queue"></a><span data-ttu-id="8890a-296">O aplicativo não pode processar uma mensagem específica da fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-296">The application cannot process a particular message from the queue.</span></span>

<span data-ttu-id="8890a-297">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-297">**Detection**.</span></span> <span data-ttu-id="8890a-298">Específico ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-298">Application specific.</span></span> <span data-ttu-id="8890a-299">Por exemplo, a mensagem contém dados inválidos ou há falha na lógica de negócios por algum motivo.</span><span class="sxs-lookup"><span data-stu-id="8890a-299">For example, the message contains invalid data, or the business logic fails for some reason.</span></span>

<span data-ttu-id="8890a-300">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-300">**Recovery:**</span></span>

<span data-ttu-id="8890a-301">Mova a mensagem para uma fila separada.</span><span class="sxs-lookup"><span data-stu-id="8890a-301">Move the message to a separate queue.</span></span> <span data-ttu-id="8890a-302">Execute um processo separado para examinar as mensagens na fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-302">Run a separate process to examine the messages in that queue.</span></span>

<span data-ttu-id="8890a-303">Considere usar filas de mensagens do Barramento de Serviço do Azure, que fornece uma funcionalidade de [fila de mensagens mortas][sb-dead-letter-queue] para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="8890a-303">Consider using Azure Service Bus Messaging queues, which provides a [dead-letter queue][sb-dead-letter-queue] functionality for this purpose.</span></span>

> [!NOTE]
> <span data-ttu-id="8890a-304">Se você estiver usando filas de armazenamento com WebJobs, o SDK do WebJobs fornecerá tratamento interno de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="8890a-304">If you are using Storage queues with WebJobs, the WebJobs SDK provides built-in poison message handling.</span></span> <span data-ttu-id="8890a-305">Veja [Como usar o Armazenamento de Filas do Azure com o SDK do WebJobs][sb-poison-message].</span><span class="sxs-lookup"><span data-stu-id="8890a-305">See [How to use Azure queue storage with the WebJobs SDK][sb-poison-message].</span></span>

<span data-ttu-id="8890a-306">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-306">**Diagnostics**.</span></span> <span data-ttu-id="8890a-307">Use o registro em log do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-307">Use application logging.</span></span>

## <a name="redis-cache"></a><span data-ttu-id="8890a-308">Cache Redis</span><span class="sxs-lookup"><span data-stu-id="8890a-308">Redis Cache</span></span>

### <a name="reading-from-the-cache-fails"></a><span data-ttu-id="8890a-309">Falha na leitura do cache.</span><span class="sxs-lookup"><span data-stu-id="8890a-309">Reading from the cache fails.</span></span>

<span data-ttu-id="8890a-310">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-310">**Detection**.</span></span> <span data-ttu-id="8890a-311">Detecte `StackExchange.Redis.RedisConnectionException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-311">Catch `StackExchange.Redis.RedisConnectionException`.</span></span>

<span data-ttu-id="8890a-312">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-312">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-313">Tente novamente em caso de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-313">Retry on transient failures.</span></span> <span data-ttu-id="8890a-314">O Cache Redis do Azure é compatível com novas tentativas internas. Veja as [Diretrizes de para Cache Redis][redis-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-314">Azure Redis cache supports built-in retry through See [Redis Cache retry guidelines][redis-retry].</span></span>
2. <span data-ttu-id="8890a-315">Trate as falhas não transitórias como uma perda no cache e faça fallback para a fonte de dados original.</span><span class="sxs-lookup"><span data-stu-id="8890a-315">Treat non-transient failures as a cache miss, and fall back to the original data source.</span></span>

<span data-ttu-id="8890a-316">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-316">**Diagnostics**.</span></span> <span data-ttu-id="8890a-317">Use o [Diagnóstico do Cache Redis][redis-monitor].</span><span class="sxs-lookup"><span data-stu-id="8890a-317">Use [Redis Cache diagnostics][redis-monitor].</span></span>

### <a name="writing-to-the-cache-fails"></a><span data-ttu-id="8890a-318">Falha ao gravar no cache.</span><span class="sxs-lookup"><span data-stu-id="8890a-318">Writing to the cache fails.</span></span>

<span data-ttu-id="8890a-319">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-319">**Detection**.</span></span> <span data-ttu-id="8890a-320">Detecte `StackExchange.Redis.RedisConnectionException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-320">Catch `StackExchange.Redis.RedisConnectionException`.</span></span>

<span data-ttu-id="8890a-321">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-321">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-322">Tente novamente em caso de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-322">Retry on transient failures.</span></span> <span data-ttu-id="8890a-323">O Cache Redis do Azure é compatível com novas tentativas internas. Veja as [Diretrizes de para Cache Redis][redis-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-323">Azure Redis cache supports built-in retry through See [Redis Cache retry guidelines][redis-retry].</span></span>
2. <span data-ttu-id="8890a-324">Se o erro não for transitório, ignore-o e permita que outras transações gravem no cache mais tarde.</span><span class="sxs-lookup"><span data-stu-id="8890a-324">If the error is non-transient, ignore it and let other transactions write to the cache later.</span></span>

<span data-ttu-id="8890a-325">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-325">**Diagnostics**.</span></span> <span data-ttu-id="8890a-326">Use o [Diagnóstico do Cache Redis][redis-monitor].</span><span class="sxs-lookup"><span data-stu-id="8890a-326">Use [Redis Cache diagnostics][redis-monitor].</span></span>

## <a name="sql-database"></a><span data-ttu-id="8890a-327">Banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="8890a-327">SQL Database</span></span>

### <a name="cannot-connect-to-the-database-in-the-primary-region"></a><span data-ttu-id="8890a-328">Não é possível conectar ao banco de dados na região primária.</span><span class="sxs-lookup"><span data-stu-id="8890a-328">Cannot connect to the database in the primary region.</span></span>

<span data-ttu-id="8890a-329">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-329">**Detection**.</span></span> <span data-ttu-id="8890a-330">Falha na conexão.</span><span class="sxs-lookup"><span data-stu-id="8890a-330">Connection fails.</span></span>

<span data-ttu-id="8890a-331">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-331">**Recovery:**</span></span>

<span data-ttu-id="8890a-332">Pré-requisito: o banco de dados deve estar configurado para replicação geográfica ativa.</span><span class="sxs-lookup"><span data-stu-id="8890a-332">Prerequisite: The database must be configured for active geo-replication.</span></span> <span data-ttu-id="8890a-333">Veja [Replicação geográfica ativa para Banco de Dados SQL][sql-db-replication].</span><span class="sxs-lookup"><span data-stu-id="8890a-333">See [SQL Database Active Geo-Replication][sql-db-replication].</span></span>

- <span data-ttu-id="8890a-334">Para as consultas, leia de uma réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="8890a-334">For queries, read from a secondary replica.</span></span>
- <span data-ttu-id="8890a-335">Para inserções e atualizações, faça failover manualmente para uma réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="8890a-335">For inserts and updates, manually fail over to a secondary replica.</span></span> <span data-ttu-id="8890a-336">Veja [Iniciar um failover planejado ou não planejado para o Banco de Dados SQL do Azure][sql-db-failover].</span><span class="sxs-lookup"><span data-stu-id="8890a-336">See [Initiate a planned or unplanned failover for Azure SQL Database][sql-db-failover].</span></span>

<span data-ttu-id="8890a-337">A réplica usa uma cadeia de conexão diferente, portanto será necessário atualizar a cadeia de conexão em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-337">The replica uses a different connection string, so you will need to update the connection string in your application.</span></span>

### <a name="client-runs-out-of-connections-in-the-connection-pool"></a><span data-ttu-id="8890a-338">O cliente fica sem conexões no pool de conexões.</span><span class="sxs-lookup"><span data-stu-id="8890a-338">Client runs out of connections in the connection pool.</span></span>

<span data-ttu-id="8890a-339">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-339">**Detection**.</span></span> <span data-ttu-id="8890a-340">Detecte erros `System.InvalidOperationException`.</span><span class="sxs-lookup"><span data-stu-id="8890a-340">Catch `System.InvalidOperationException` errors.</span></span>

<span data-ttu-id="8890a-341">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-341">**Recovery:**</span></span>

- <span data-ttu-id="8890a-342">Repita a operação.</span><span class="sxs-lookup"><span data-stu-id="8890a-342">Retry the operation.</span></span>
- <span data-ttu-id="8890a-343">Como plano de mitigação, isole os pools de conexões para cada caso de uso, para que um caso de uso não domine todas as conexões.</span><span class="sxs-lookup"><span data-stu-id="8890a-343">As a mitigation plan, isolate the connection pools for each use case, so that one use case can't dominate all the connections.</span></span>
- <span data-ttu-id="8890a-344">Aumente os limites máximos dos pools de conexões.</span><span class="sxs-lookup"><span data-stu-id="8890a-344">Increase the maximum connection pools.</span></span>

<span data-ttu-id="8890a-345">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-345">**Diagnostics**.</span></span> <span data-ttu-id="8890a-346">Logs do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-346">Application logs.</span></span>

### <a name="database-connection-limit-is-reached"></a><span data-ttu-id="8890a-347">O limite de conexão de banco de dados foi alcançado.</span><span class="sxs-lookup"><span data-stu-id="8890a-347">Database connection limit is reached.</span></span>

<span data-ttu-id="8890a-348">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-348">**Detection**.</span></span> <span data-ttu-id="8890a-349">O Banco de Dados SQL do Azure limita o número de trabalhos, logons e sessões simultâneos.</span><span class="sxs-lookup"><span data-stu-id="8890a-349">Azure SQL Database limits the number of concurrent workers, logins, and sessions.</span></span> <span data-ttu-id="8890a-350">Os limites dependem da camada de serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-350">The limits depend on the service tier.</span></span> <span data-ttu-id="8890a-351">Para obter mais informações, veja [Limites de recursos do Banco de Dados SQL do Azure][sql-db-limits].</span><span class="sxs-lookup"><span data-stu-id="8890a-351">For more information, see [Azure SQL Database resource limits][sql-db-limits].</span></span>

<span data-ttu-id="8890a-352">Para detectar esses erros, detecte `System.Data.SqlClient.SqlException` e verifique o valor de `SqlException.Number` para o código de erro SQL.</span><span class="sxs-lookup"><span data-stu-id="8890a-352">To detect these errors, catch `System.Data.SqlClient.SqlException` and check the value of `SqlException.Number` for the SQL error code.</span></span> <span data-ttu-id="8890a-353">Para obter uma lista dos códigos de erro relevantes, confira [códigos de erro SQL para aplicativos de cliente do banco de dados SQL: erros de conexão de banco de dados e outros problemas][sql-db-errors].</span><span class="sxs-lookup"><span data-stu-id="8890a-353">For a list of relevant error codes, see [SQL error codes for SQL Database client applications: Database connection error and other issues][sql-db-errors].</span></span>

<span data-ttu-id="8890a-354">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-354">**Recovery**.</span></span> <span data-ttu-id="8890a-355">Esses erros são considerados transitórios, portanto tentar novamente poderá resolver o problema.</span><span class="sxs-lookup"><span data-stu-id="8890a-355">These errors are considered transient, so retrying may resolve the issue.</span></span> <span data-ttu-id="8890a-356">Se você encontrar consistentemente esses erros, considere dimensionar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8890a-356">If you consistently hit these errors, consider scaling the database.</span></span>

<span data-ttu-id="8890a-357">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-357">**Diagnostics**.</span></span> <span data-ttu-id="8890a-358">- A consulta [sys.event_log][sys.event_log] retorna conexões de banco de dados bem-sucedidas, falhas na conexão e deadlocks.</span><span class="sxs-lookup"><span data-stu-id="8890a-358">- The [sys.event_log][sys.event_log] query returns successful database connections, connection failures, and deadlocks.</span></span>

- <span data-ttu-id="8890a-359">Crie uma [regra de alerta][azure-alerts] para falhas em conexões.</span><span class="sxs-lookup"><span data-stu-id="8890a-359">Create an [alert rule][azure-alerts] for failed connections.</span></span>
- <span data-ttu-id="8890a-360">Habilite [Auditoria do Banco de Dados SQL][sql-db-audit] e verifique se há falha em logons.</span><span class="sxs-lookup"><span data-stu-id="8890a-360">Enable [SQL Database auditing][sql-db-audit] and check for failed logins.</span></span>

## <a name="service-bus-messaging"></a><span data-ttu-id="8890a-361">Mensagens do Barramento de Serviço</span><span class="sxs-lookup"><span data-stu-id="8890a-361">Service Bus Messaging</span></span>

### <a name="reading-a-message-from-a-service-bus-queue-fails"></a><span data-ttu-id="8890a-362">Falha na leitura de uma mensagem de uma fila do Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-362">Reading a message from a Service Bus queue fails.</span></span>

<span data-ttu-id="8890a-363">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-363">**Detection**.</span></span> <span data-ttu-id="8890a-364">Detecte exceções no SDK do cliente.</span><span class="sxs-lookup"><span data-stu-id="8890a-364">Catch exceptions from the client SDK.</span></span> <span data-ttu-id="8890a-365">A classe base para exceções do Barramento de Serviço é [MessagingException][sb-messagingexception-class].</span><span class="sxs-lookup"><span data-stu-id="8890a-365">The base class for Service Bus exceptions is [MessagingException][sb-messagingexception-class].</span></span> <span data-ttu-id="8890a-366">Se o erro for transitório, a propriedade `IsTransient` será true.</span><span class="sxs-lookup"><span data-stu-id="8890a-366">If the error is transient, the `IsTransient` property is true.</span></span>

<span data-ttu-id="8890a-367">Para obter mais informações, veja [Exceções de mensagens do Barramento de Serviço][sb-messaging-exceptions].</span><span class="sxs-lookup"><span data-stu-id="8890a-367">For more information, see [Service Bus messaging exceptions][sb-messaging-exceptions].</span></span>

<span data-ttu-id="8890a-368">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-368">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-369">Tente novamente em caso de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-369">Retry on transient failures.</span></span> <span data-ttu-id="8890a-370">Veja [Diretrizes de repetição para Barramento de Serviço][sb-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-370">See [Service Bus retry guidelines][sb-retry].</span></span>
2. <span data-ttu-id="8890a-371">As mensagens que não podem ser entregues a nenhum receptor são colocadas em um *fila de mensagens mortas*.</span><span class="sxs-lookup"><span data-stu-id="8890a-371">Messages that cannot be delivered to any receiver are placed in a *dead-letter queue*.</span></span> <span data-ttu-id="8890a-372">Use essa fila para ver quais mensagens não puderam ser recebidas.</span><span class="sxs-lookup"><span data-stu-id="8890a-372">Use this queue to see which messages could not be received.</span></span> <span data-ttu-id="8890a-373">Não há opções de limpeza automática da fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="8890a-373">There is no automatic cleanup of the dead-letter queue.</span></span> <span data-ttu-id="8890a-374">As mensagens permanecem lá até você explicitamente recuperá-las.</span><span class="sxs-lookup"><span data-stu-id="8890a-374">Messages remain there until you explicitly retrieve them.</span></span> <span data-ttu-id="8890a-375">Veja [Visão geral das filas de mensagens mortas do Barramento de Serviço][sb-dead-letter-queue].</span><span class="sxs-lookup"><span data-stu-id="8890a-375">See [Overview of Service Bus dead-letter queues][sb-dead-letter-queue].</span></span>

### <a name="writing-a-message-to-a-service-bus-queue-fails"></a><span data-ttu-id="8890a-376">Falha na gravação de uma mensagem em uma fila do Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-376">Writing a message to a Service Bus queue fails.</span></span>

<span data-ttu-id="8890a-377">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-377">**Detection**.</span></span> <span data-ttu-id="8890a-378">Detecte exceções no SDK do cliente.</span><span class="sxs-lookup"><span data-stu-id="8890a-378">Catch exceptions from the client SDK.</span></span> <span data-ttu-id="8890a-379">A classe base para exceções do Barramento de Serviço é [MessagingException][sb-messagingexception-class].</span><span class="sxs-lookup"><span data-stu-id="8890a-379">The base class for Service Bus exceptions is [MessagingException][sb-messagingexception-class].</span></span> <span data-ttu-id="8890a-380">Se o erro for transitório, a propriedade `IsTransient` será true.</span><span class="sxs-lookup"><span data-stu-id="8890a-380">If the error is transient, the `IsTransient` property is true.</span></span>

<span data-ttu-id="8890a-381">Para obter mais informações, veja [Exceções de mensagens do Barramento de Serviço][sb-messaging-exceptions].</span><span class="sxs-lookup"><span data-stu-id="8890a-381">For more information, see [Service Bus messaging exceptions][sb-messaging-exceptions].</span></span>

<span data-ttu-id="8890a-382">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-382">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-383">O cliente do Barramento de Serviço tenta novamente de maneira automática após erros transitórios.</span><span class="sxs-lookup"><span data-stu-id="8890a-383">The Service Bus client automatically retries after transient errors.</span></span> <span data-ttu-id="8890a-384">Por padrão, ele usa retirada exponencial.</span><span class="sxs-lookup"><span data-stu-id="8890a-384">By default, it uses exponential back-off.</span></span> <span data-ttu-id="8890a-385">Após a contagem máxima de novas tentativas ou do tempo limite máximo, o cliente gerará uma exceção.</span><span class="sxs-lookup"><span data-stu-id="8890a-385">After the maximum retry count or maximum timeout period, the client throws an exception.</span></span> <span data-ttu-id="8890a-386">Para obter mais informações, veja [Diretrizes de repetição para Barramento de Serviço][sb-retry].</span><span class="sxs-lookup"><span data-stu-id="8890a-386">For more information, see [Service Bus retry guidelines][sb-retry].</span></span>
2. <span data-ttu-id="8890a-387">Se a cota da fila for excedida, o cliente gerará [QuotaExceededException][QuotaExceededException].</span><span class="sxs-lookup"><span data-stu-id="8890a-387">If the queue quota is exceeded, the client throws [QuotaExceededException][QuotaExceededException].</span></span> <span data-ttu-id="8890a-388">A mensagem de exceção fornece mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="8890a-388">The exception message gives more details.</span></span> <span data-ttu-id="8890a-389">Retire algumas mensagens da fila antes de tentar novamente e considere usar o padrão de Disjuntor para evitar novas tentativas contínuas enquanto a cota estiver excedida.</span><span class="sxs-lookup"><span data-stu-id="8890a-389">Drain some messages from the queue before retrying, and consider using the Circuit Breaker pattern to avoid continued retries while the quota is exceeded.</span></span> <span data-ttu-id="8890a-390">Além disso, verifique se a propriedade [BrokeredMessage.TimeToLive] não está definida com um valor muito alto.</span><span class="sxs-lookup"><span data-stu-id="8890a-390">Also, make sure the [BrokeredMessage.TimeToLive] property is not set too high.</span></span>
3. <span data-ttu-id="8890a-391">Em uma região, a resiliência pode ser melhorada usando [filas ou tópicos particionados][sb-partition].</span><span class="sxs-lookup"><span data-stu-id="8890a-391">Within a region, resiliency can be improved by using [partitioned queues or topics][sb-partition].</span></span> <span data-ttu-id="8890a-392">Uma fila ou um tópico não particionado é atribuído a um repositório de mensagens.</span><span class="sxs-lookup"><span data-stu-id="8890a-392">A non-partitioned queue or topic is assigned to one messaging store.</span></span> <span data-ttu-id="8890a-393">Se esse repositório de mensagens não estiver disponível, todas as operações na fila ou no tópico falharão.</span><span class="sxs-lookup"><span data-stu-id="8890a-393">If this messaging store is unavailable, all operations on that queue or topic will fail.</span></span> <span data-ttu-id="8890a-394">Uma fila ou tópico particionado é particionado em vários repositórios de mensagens.</span><span class="sxs-lookup"><span data-stu-id="8890a-394">A partitioned queue or topic is partitioned across multiple messaging stores.</span></span>
4. <span data-ttu-id="8890a-395">Para obter resiliência adicional, crie dois namespaces do Barramento de Serviço em regiões diferentes e replique as mensagens.</span><span class="sxs-lookup"><span data-stu-id="8890a-395">For additional resiliency, create two Service Bus namespaces in different regions, and replicate the messages.</span></span> <span data-ttu-id="8890a-396">Você pode usar a replicação ativa ou passiva.</span><span class="sxs-lookup"><span data-stu-id="8890a-396">You can use either active replication or passive replication.</span></span>

    - <span data-ttu-id="8890a-397">Replicação ativa: o cliente envia todas as mensagens para ambas as filas.</span><span class="sxs-lookup"><span data-stu-id="8890a-397">Active replication: The client sends every message to both queues.</span></span> <span data-ttu-id="8890a-398">O receptor escuta em ambas as filas.</span><span class="sxs-lookup"><span data-stu-id="8890a-398">The receiver listens on both queues.</span></span> <span data-ttu-id="8890a-399">Marque mensagens com um identificador exclusivo para que o cliente possa descartar mensagens duplicadas.</span><span class="sxs-lookup"><span data-stu-id="8890a-399">Tag messages with a unique identifier, so the client can discard duplicate messages.</span></span>
    - <span data-ttu-id="8890a-400">Replicação passiva: o cliente envia todas as mensagens para uma fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-400">Passive replication: The client sends the message to one queue.</span></span> <span data-ttu-id="8890a-401">Se houver um erro, o cliente fará fallback para a outra fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-401">If there is an error, the client falls back to the other queue.</span></span> <span data-ttu-id="8890a-402">O receptor escuta em ambas as filas.</span><span class="sxs-lookup"><span data-stu-id="8890a-402">The receiver listens on both queues.</span></span> <span data-ttu-id="8890a-403">Essa abordagem reduz o número de mensagens duplicadas enviadas.</span><span class="sxs-lookup"><span data-stu-id="8890a-403">This approach reduces the number of duplicate messages that are sent.</span></span> <span data-ttu-id="8890a-404">No entanto, o receptor ainda deve tratar as mensagens duplicadas.</span><span class="sxs-lookup"><span data-stu-id="8890a-404">However, the receiver must still handle duplicate messages.</span></span>

    <span data-ttu-id="8890a-405">Para saber mais, veja [Exemplo de replicação geográfica][sb-georeplication-sample] e [Práticas recomendadas para isolar aplicativos contra interrupções e desastres do Barramento de Serviço](/azure/service-bus-messaging/service-bus-outages-disasters/).</span><span class="sxs-lookup"><span data-stu-id="8890a-405">For more information, see [GeoReplication sample][sb-georeplication-sample] and [Best practices for insulating applications against Service Bus outages and disasters](/azure/service-bus-messaging/service-bus-outages-disasters/).</span></span>

### <a name="duplicate-message"></a><span data-ttu-id="8890a-406">Duplique a mensagem.</span><span class="sxs-lookup"><span data-stu-id="8890a-406">Duplicate message.</span></span>

<span data-ttu-id="8890a-407">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-407">**Detection**.</span></span> <span data-ttu-id="8890a-408">Examine as propriedades `MessageId` e `DeliveryCount` da mensagem.</span><span class="sxs-lookup"><span data-stu-id="8890a-408">Examine the `MessageId` and `DeliveryCount` properties of the message.</span></span>

<span data-ttu-id="8890a-409">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-409">**Recovery:**</span></span>

- <span data-ttu-id="8890a-410">Se possível, crie suas próprias operações de processamento de mensagens para serem idempotentes.</span><span class="sxs-lookup"><span data-stu-id="8890a-410">If possible, design your message processing operations to be idempotent.</span></span> <span data-ttu-id="8890a-411">Caso contrário, armazene as IDs das mensagens já processadas e verifique a ID antes de processar uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="8890a-411">Otherwise, store message IDs of messages that are already processed, and check the ID before processing a message.</span></span>
- <span data-ttu-id="8890a-412">Habilite detecção de duplicidades criando a fila com `RequiresDuplicateDetection` definido como true.</span><span class="sxs-lookup"><span data-stu-id="8890a-412">Enable duplicate detection, by creating the queue with `RequiresDuplicateDetection` set to true.</span></span> <span data-ttu-id="8890a-413">Com essa configuração, o Barramento de Serviço exclui automaticamente qualquer mensagem enviada com a mesma `MessageId` que alguma mensagem anterior.</span><span class="sxs-lookup"><span data-stu-id="8890a-413">With this setting, Service Bus automatically deletes any message that is sent with the same `MessageId` as a previous message.</span></span>  <span data-ttu-id="8890a-414">Observe o seguinte:</span><span class="sxs-lookup"><span data-stu-id="8890a-414">Note the following:</span></span>

  - <span data-ttu-id="8890a-415">Essa configuração impede que mensagens duplicadas sejam colocadas na fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-415">This setting prevents duplicate messages from being put into the queue.</span></span> <span data-ttu-id="8890a-416">Ela não impede que um receptor de processar a mesma mensagem mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="8890a-416">It doesn't prevent a receiver from processing the same message more than once.</span></span>
  - <span data-ttu-id="8890a-417">A detecção de duplicidades tem uma janela de tempo.</span><span class="sxs-lookup"><span data-stu-id="8890a-417">Duplicate detection has a time window.</span></span> <span data-ttu-id="8890a-418">Se uma duplicata for enviada fora dessa janela, ela não será detectada.</span><span class="sxs-lookup"><span data-stu-id="8890a-418">If a duplicate is sent beyond this window, it won't be detected.</span></span>

<span data-ttu-id="8890a-419">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-419">**Diagnostics**.</span></span> <span data-ttu-id="8890a-420">Registre em log as mensagens duplicadas.</span><span class="sxs-lookup"><span data-stu-id="8890a-420">Log duplicated messages.</span></span>

### <a name="the-application-cant-process-a-particular-message-from-the-queue"></a><span data-ttu-id="8890a-421">O aplicativo não pode processar uma mensagem específica da fila.</span><span class="sxs-lookup"><span data-stu-id="8890a-421">The application can't process a particular message from the queue.</span></span>

<span data-ttu-id="8890a-422">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-422">**Detection**.</span></span> <span data-ttu-id="8890a-423">Específico ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-423">Application specific.</span></span> <span data-ttu-id="8890a-424">Por exemplo, a mensagem contém dados inválidos ou há falha na lógica de negócios por algum motivo.</span><span class="sxs-lookup"><span data-stu-id="8890a-424">For example, the message contains invalid data, or the business logic fails for some reason.</span></span>

<span data-ttu-id="8890a-425">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-425">**Recovery:**</span></span>

<span data-ttu-id="8890a-426">Há dois modos de falha a serem considerados.</span><span class="sxs-lookup"><span data-stu-id="8890a-426">There are two failure modes to consider.</span></span>

- <span data-ttu-id="8890a-427">O receptor detecta a falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-427">The receiver detects the failure.</span></span> <span data-ttu-id="8890a-428">Nesse caso, mova a mensagem para a fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="8890a-428">In this case, move the message to the dead-letter queue.</span></span> <span data-ttu-id="8890a-429">Depois, execute um processo separado para examinar as mensagens na fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="8890a-429">Later, run a separate process to examine the messages in the dead-letter queue.</span></span>
- <span data-ttu-id="8890a-430">O receptor encontra uma falha durante o processamento da mensagem &mdash;, por exemplo, devido a uma exceção sem tratamento.</span><span class="sxs-lookup"><span data-stu-id="8890a-430">The receiver fails in the middle of processing the message &mdash; for example, due to an unhandled exception.</span></span> <span data-ttu-id="8890a-431">Para tratar esse caso, use o modo `PeekLock`.</span><span class="sxs-lookup"><span data-stu-id="8890a-431">To handle this case, use `PeekLock` mode.</span></span> <span data-ttu-id="8890a-432">Nesse modo, se o bloqueio expirar, a mensagem ficará disponível para outros receptores.</span><span class="sxs-lookup"><span data-stu-id="8890a-432">In this mode, if the lock expires, the message becomes available to other receivers.</span></span> <span data-ttu-id="8890a-433">Se a mensagem exceder a contagem máxima de entregas ou o tempo de vida, ela será automaticamente movida para a fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="8890a-433">If the message exceeds the maximum delivery count or the time-to-live, the message is automatically moved to the dead-letter queue.</span></span>

<span data-ttu-id="8890a-434">Para obter mais informações, veja [Visão geral das filas de mensagens mortas do Barramento de Serviço][sb-dead-letter-queue].</span><span class="sxs-lookup"><span data-stu-id="8890a-434">For more information, see [Overview of Service Bus dead-letter queues][sb-dead-letter-queue].</span></span>

<span data-ttu-id="8890a-435">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-435">**Diagnostics**.</span></span> <span data-ttu-id="8890a-436">Sempre que o aplicativo mover uma mensagem para a fila de mensagens mortas, grave um evento nos logs do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-436">Whenever the application moves a message to the dead-letter queue, write an event to the application logs.</span></span>

## <a name="service-fabric"></a><span data-ttu-id="8890a-437">Service Fabric</span><span class="sxs-lookup"><span data-stu-id="8890a-437">Service Fabric</span></span>

### <a name="a-request-to-a-service-fails"></a><span data-ttu-id="8890a-438">Falha em uma solicitação para um serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-438">A request to a service fails.</span></span>

<span data-ttu-id="8890a-439">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-439">**Detection**.</span></span> <span data-ttu-id="8890a-440">O serviço retorna um erro.</span><span class="sxs-lookup"><span data-stu-id="8890a-440">The service returns an error.</span></span>

<span data-ttu-id="8890a-441">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-441">**Recovery:**</span></span>

- <span data-ttu-id="8890a-442">Localize um proxy novamente (`ServiceProxy` ou `ActorProxy`) e chame o método do serviço/ator novamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-442">Locate a proxy again (`ServiceProxy` or `ActorProxy`) and call the service/actor method again.</span></span>
- <span data-ttu-id="8890a-443">**Serviço com estado**.</span><span class="sxs-lookup"><span data-stu-id="8890a-443">**Stateful service**.</span></span> <span data-ttu-id="8890a-444">Encapsule operações em coleções confiáveis em uma transação.</span><span class="sxs-lookup"><span data-stu-id="8890a-444">Wrap operations on reliable collections in a transaction.</span></span> <span data-ttu-id="8890a-445">Se houver um erro, a transação será revertida.</span><span class="sxs-lookup"><span data-stu-id="8890a-445">If there is an error, the transaction will be rolled back.</span></span> <span data-ttu-id="8890a-446">A solicitação, se extraída de uma fila, será processada novamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-446">The request, if pulled from a queue, will be processed again.</span></span>
- <span data-ttu-id="8890a-447">**Serviço sem estado**.</span><span class="sxs-lookup"><span data-stu-id="8890a-447">**Stateless service**.</span></span> <span data-ttu-id="8890a-448">Se o serviço persistir dados em um repositório externo, todas as operações precisarão ser idempotentes.</span><span class="sxs-lookup"><span data-stu-id="8890a-448">If the service persists data to an external store, all operations need to be idempotent.</span></span>

<span data-ttu-id="8890a-449">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-449">**Diagnostics**.</span></span> <span data-ttu-id="8890a-450">Log do aplicativo</span><span class="sxs-lookup"><span data-stu-id="8890a-450">Application log</span></span>

### <a name="service-fabric-node-is-shut-down"></a><span data-ttu-id="8890a-451">O nó do Service Fabric é desligado.</span><span class="sxs-lookup"><span data-stu-id="8890a-451">Service Fabric node is shut down.</span></span>

<span data-ttu-id="8890a-452">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-452">**Detection**.</span></span> <span data-ttu-id="8890a-453">Um token de cancelamento é passado para o método `RunAsync` do serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-453">A cancellation token is passed to the service's `RunAsync` method.</span></span> <span data-ttu-id="8890a-454">O Service Fabric cancela a tarefa antes de desligar o nó.</span><span class="sxs-lookup"><span data-stu-id="8890a-454">Service Fabric cancels the task before shutting down the node.</span></span>

<span data-ttu-id="8890a-455">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-455">**Recovery**.</span></span> <span data-ttu-id="8890a-456">Use o token de cancelamento para detectar o desligamento.</span><span class="sxs-lookup"><span data-stu-id="8890a-456">Use the cancellation token to detect shutdown.</span></span> <span data-ttu-id="8890a-457">Quando o Service Fabric solicitar o cancelamento, conclua qualquer trabalho e saia do  `RunAsync` assim que possível.</span><span class="sxs-lookup"><span data-stu-id="8890a-457">When Service Fabric requests cancellation, finish any work and exit `RunAsync` as quickly as possible.</span></span>

<span data-ttu-id="8890a-458">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-458">**Diagnostics**.</span></span> <span data-ttu-id="8890a-459">Logs de aplicativo</span><span class="sxs-lookup"><span data-stu-id="8890a-459">Application logs</span></span>

## <a name="storage"></a><span data-ttu-id="8890a-460">Armazenamento</span><span class="sxs-lookup"><span data-stu-id="8890a-460">Storage</span></span>

### <a name="writing-data-to-azure-storage-fails"></a><span data-ttu-id="8890a-461">Falha na gravação de dados no Armazenamento do Azure</span><span class="sxs-lookup"><span data-stu-id="8890a-461">Writing data to Azure Storage fails</span></span>

<span data-ttu-id="8890a-462">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-462">**Detection**.</span></span> <span data-ttu-id="8890a-463">O cliente recebe erros durante a gravação.</span><span class="sxs-lookup"><span data-stu-id="8890a-463">The client receives errors when writing.</span></span>

<span data-ttu-id="8890a-464">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-464">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-465">Tente a operação novamente para recuperar-se de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-465">Retry the operation, to recover from transient failures.</span></span> <span data-ttu-id="8890a-466">A [política de novas tentativas][Storage.RetryPolicies] no SDK cliente trata disso automaticamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-466">The [retry policy][Storage.RetryPolicies] in the client SDK handles this automatically.</span></span>
2. <span data-ttu-id="8890a-467">Implemente o padrão de Disjuntor para evitar armazenamento excessivo.</span><span class="sxs-lookup"><span data-stu-id="8890a-467">Implement the Circuit Breaker pattern to avoid overwhelming storage.</span></span>
3. <span data-ttu-id="8890a-468">Se houver falha em N novas tentativas, execute um fallback normal.</span><span class="sxs-lookup"><span data-stu-id="8890a-468">If N retry attempts fail, perform a graceful fallback.</span></span> <span data-ttu-id="8890a-469">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="8890a-469">For example:</span></span>

   - <span data-ttu-id="8890a-470">Armazene os dados em um cache local e encaminhe as gravações para o armazenamento mais tarde, quando o serviço estiver disponível.</span><span class="sxs-lookup"><span data-stu-id="8890a-470">Store the data in a local cache, and forward the writes to storage later, when the service becomes available.</span></span>
   - <span data-ttu-id="8890a-471">Se a ação de gravação estiver em um escopo transacional, compense a transação.</span><span class="sxs-lookup"><span data-stu-id="8890a-471">If the write action was in a transactional scope, compensate the transaction.</span></span>

<span data-ttu-id="8890a-472">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-472">**Diagnostics**.</span></span> <span data-ttu-id="8890a-473">Use [métricas de armazenamento][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="8890a-473">Use [storage metrics][storage-metrics].</span></span>

### <a name="reading-data-from-azure-storage-fails"></a><span data-ttu-id="8890a-474">Falha na leitura de dados do Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="8890a-474">Reading data from Azure Storage fails.</span></span>

<span data-ttu-id="8890a-475">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-475">**Detection**.</span></span> <span data-ttu-id="8890a-476">O cliente recebe erros durante a leitura.</span><span class="sxs-lookup"><span data-stu-id="8890a-476">The client receives errors when reading.</span></span>

<span data-ttu-id="8890a-477">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-477">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-478">Tente a operação novamente para recuperar-se de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-478">Retry the operation, to recover from transient failures.</span></span> <span data-ttu-id="8890a-479">A [política de novas tentativas][Storage.RetryPolicies] no SDK cliente trata disso automaticamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-479">The [retry policy][Storage.RetryPolicies] in the client SDK handles this automatically.</span></span>
2. <span data-ttu-id="8890a-480">Para o armazenamento RA-GRS, se houver falha na leitura do ponto de extremidade primário, tente ler do ponto de extremidade secundário.</span><span class="sxs-lookup"><span data-stu-id="8890a-480">For RA-GRS storage, if reading from the primary endpoint fails, try reading from the secondary endpoint.</span></span> <span data-ttu-id="8890a-481">O SDK cliente pode tratar disso automaticamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-481">The client SDK can handle this automatically.</span></span> <span data-ttu-id="8890a-482">Veja [Replicação de Armazenamento do Azure][storage-replication].</span><span class="sxs-lookup"><span data-stu-id="8890a-482">See [Azure Storage replication][storage-replication].</span></span>
3. <span data-ttu-id="8890a-483">Se houver falha em *N* novas tentativas, execute uma ação de fallback para degradar normalmente.</span><span class="sxs-lookup"><span data-stu-id="8890a-483">If *N* retry attempts fail, take a fallback action to degrade gracefully.</span></span> <span data-ttu-id="8890a-484">Por exemplo, se uma imagem do produto não puder ser recuperada do armazenamento, mostre uma imagem de espaço reservado genérico.</span><span class="sxs-lookup"><span data-stu-id="8890a-484">For example, if a product image can't be retrieved from storage, show a generic placeholder image.</span></span>

<span data-ttu-id="8890a-485">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-485">**Diagnostics**.</span></span> <span data-ttu-id="8890a-486">Use [métricas de armazenamento][storage-metrics].</span><span class="sxs-lookup"><span data-stu-id="8890a-486">Use [storage metrics][storage-metrics].</span></span>

## <a name="virtual-machine"></a><span data-ttu-id="8890a-487">Máquina virtual</span><span class="sxs-lookup"><span data-stu-id="8890a-487">Virtual machine</span></span>

### <a name="connection-to-a-backend-vm-fails"></a><span data-ttu-id="8890a-488">Falha na conexão a uma VM de back-end.</span><span class="sxs-lookup"><span data-stu-id="8890a-488">Connection to a backend VM fails.</span></span>

<span data-ttu-id="8890a-489">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-489">**Detection**.</span></span> <span data-ttu-id="8890a-490">Erros na conexão de rede.</span><span class="sxs-lookup"><span data-stu-id="8890a-490">Network connection errors.</span></span>

<span data-ttu-id="8890a-491">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-491">**Recovery:**</span></span>

- <span data-ttu-id="8890a-492">Implante pelo menos duas VMs de back-end em um conjunto de disponibilidade, atrás de um balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="8890a-492">Deploy at least two backend VMs in an availability set, behind a load balancer.</span></span>
- <span data-ttu-id="8890a-493">Se o erro na conexão for transitório, às vezes, o TCP tentará enviar a mensagem novamente com êxito.</span><span class="sxs-lookup"><span data-stu-id="8890a-493">If the connection error is transient, sometimes TCP will successfully retry sending the message.</span></span>
- <span data-ttu-id="8890a-494">Implemente uma política de novas tentativas no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-494">Implement a retry policy in the application.</span></span>
- <span data-ttu-id="8890a-495">Para erros persistentes ou não transitórios, implemente o padrão de [Disjuntor][circuit-breaker].</span><span class="sxs-lookup"><span data-stu-id="8890a-495">For persistent or non-transient errors, implement the [Circuit Breaker][circuit-breaker] pattern.</span></span>
- <span data-ttu-id="8890a-496">Se a VM chamando exceder seu limite de saída de rede, a fila de saída será preenchida.</span><span class="sxs-lookup"><span data-stu-id="8890a-496">If the calling VM exceeds its network egress limit, the outbound queue will fill up.</span></span> <span data-ttu-id="8890a-497">Se a fila de saída estiver consistentemente cheia, considere a possibilidade de expansão.</span><span class="sxs-lookup"><span data-stu-id="8890a-497">If the outbound queue is consistently full, consider scaling out.</span></span>

<span data-ttu-id="8890a-498">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-498">**Diagnostics**.</span></span> <span data-ttu-id="8890a-499">Registre em log os eventos nos limites dos serviços.</span><span class="sxs-lookup"><span data-stu-id="8890a-499">Log events at service boundaries.</span></span>

### <a name="vm-instance-becomes-unavailable-or-unhealthy"></a><span data-ttu-id="8890a-500">A instância VM torna-se não disponível ou não íntegra.</span><span class="sxs-lookup"><span data-stu-id="8890a-500">VM instance becomes unavailable or unhealthy.</span></span>

<span data-ttu-id="8890a-501">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-501">**Detection**.</span></span> <span data-ttu-id="8890a-502">Configure uma [investigação de integridade][lb-probe] do balanceador de carga que indique se a instância VM está íntegra.</span><span class="sxs-lookup"><span data-stu-id="8890a-502">Configure a Load Balancer [health probe][lb-probe] that signals whether the VM instance is healthy.</span></span> <span data-ttu-id="8890a-503">A investigação deve verificar se as funções críticas estão respondendo corretamente.</span><span class="sxs-lookup"><span data-stu-id="8890a-503">The probe should check whether critical functions are responding correctly.</span></span>

<span data-ttu-id="8890a-504">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-504">**Recovery**.</span></span> <span data-ttu-id="8890a-505">Para cada camada de aplicativo, coloque várias instâncias de VM no mesmo conjunto de disponibilidade e coloque um balanceador de carga na frente das VMs.</span><span class="sxs-lookup"><span data-stu-id="8890a-505">For each application tier, put multiple VM instances into the same availability set, and place a load balancer in front of the VMs.</span></span> <span data-ttu-id="8890a-506">Se houver falha na investigação de integridade, o balanceador de carga interromperá o envio de novas conexões para a instância não íntegra.</span><span class="sxs-lookup"><span data-stu-id="8890a-506">If the health probe fails, the Load Balancer stops sending new connections to the unhealthy instance.</span></span>

<span data-ttu-id="8890a-507">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-507">**Diagnostics**.</span></span> <span data-ttu-id="8890a-508">- Use a [análise de log][lb-monitor] do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="8890a-508">- Use Load Balancer [log analytics][lb-monitor].</span></span>

- <span data-ttu-id="8890a-509">Configure o sistema de monitoramento para monitorar todos os pontos de extremidade de monitoramento de integridade.</span><span class="sxs-lookup"><span data-stu-id="8890a-509">Configure your monitoring system to monitor all of the health monitoring endpoints.</span></span>

### <a name="operator-accidentally-shuts-down-a-vm"></a><span data-ttu-id="8890a-510">O operador desliga uma VM acidentalmente.</span><span class="sxs-lookup"><span data-stu-id="8890a-510">Operator accidentally shuts down a VM.</span></span>

<span data-ttu-id="8890a-511">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-511">**Detection**.</span></span> <span data-ttu-id="8890a-512">N/D</span><span class="sxs-lookup"><span data-stu-id="8890a-512">N/A</span></span>

<span data-ttu-id="8890a-513">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-513">**Recovery**.</span></span> <span data-ttu-id="8890a-514">Defina um bloqueio de recurso com nível `ReadOnly`.</span><span class="sxs-lookup"><span data-stu-id="8890a-514">Set a resource lock with `ReadOnly` level.</span></span> <span data-ttu-id="8890a-515">Veja [Bloquear recursos com o Azure Resource Manager][rm-locks].</span><span class="sxs-lookup"><span data-stu-id="8890a-515">See [Lock resources with Azure Resource Manager][rm-locks].</span></span>

<span data-ttu-id="8890a-516">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-516">**Diagnostics**.</span></span> <span data-ttu-id="8890a-517">Use os [Logs de Atividades do Azure][azure-activity-logs].</span><span class="sxs-lookup"><span data-stu-id="8890a-517">Use [Azure Activity Logs][azure-activity-logs].</span></span>

## <a name="webjobs"></a><span data-ttu-id="8890a-518">Trabalhos Web</span><span class="sxs-lookup"><span data-stu-id="8890a-518">WebJobs</span></span>

### <a name="continuous-job-stops-running-when-the-scm-host-is-idle"></a><span data-ttu-id="8890a-519">A execução de trabalho contínuo é interrompida quando o host do SCM está ocioso.</span><span class="sxs-lookup"><span data-stu-id="8890a-519">Continuous job stops running when the SCM host is idle.</span></span>

<span data-ttu-id="8890a-520">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-520">**Detection**.</span></span> <span data-ttu-id="8890a-521">Passe um token de cancelamento para a função WebJob.</span><span class="sxs-lookup"><span data-stu-id="8890a-521">Pass a cancellation token to the WebJob function.</span></span> <span data-ttu-id="8890a-522">Para obter mais informações, consulte [Desligamento normal][web-jobs-shutdown].</span><span class="sxs-lookup"><span data-stu-id="8890a-522">For more information, see [Graceful shutdown][web-jobs-shutdown].</span></span>

<span data-ttu-id="8890a-523">**Recuperação**.</span><span class="sxs-lookup"><span data-stu-id="8890a-523">**Recovery**.</span></span> <span data-ttu-id="8890a-524">Habilite a configuração `Always On` no aplicativo Web.</span><span class="sxs-lookup"><span data-stu-id="8890a-524">Enable the `Always On` setting in the web app.</span></span> <span data-ttu-id="8890a-525">Para obter mais informações, consulte [Executar tarefas em segundo plano com o WebJobs][web-jobs].</span><span class="sxs-lookup"><span data-stu-id="8890a-525">For more information, see [Run Background tasks with WebJobs][web-jobs].</span></span>

## <a name="application-design"></a><span data-ttu-id="8890a-526">Design do aplicativo</span><span class="sxs-lookup"><span data-stu-id="8890a-526">Application design</span></span>

### <a name="application-cant-handle-a-spike-in-incoming-requests"></a><span data-ttu-id="8890a-527">O aplicativo não pode tratar de um aumento nas solicitações de entrada.</span><span class="sxs-lookup"><span data-stu-id="8890a-527">Application can't handle a spike in incoming requests.</span></span>

<span data-ttu-id="8890a-528">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-528">**Detection**.</span></span> <span data-ttu-id="8890a-529">Depende do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8890a-529">Depends on the application.</span></span> <span data-ttu-id="8890a-530">Sintomas comuns:</span><span class="sxs-lookup"><span data-stu-id="8890a-530">Typical symptoms:</span></span>

- <span data-ttu-id="8890a-531">O site é iniciado retornando códigos de erro HTTP 5xx.</span><span class="sxs-lookup"><span data-stu-id="8890a-531">The website starts returning HTTP 5xx error codes.</span></span>
- <span data-ttu-id="8890a-532">Serviços dependentes, como o banco de dados ou o armazenamento, iniciam as solicitações de limitação.</span><span class="sxs-lookup"><span data-stu-id="8890a-532">Dependent services, such as database or storage, start to throttle requests.</span></span> <span data-ttu-id="8890a-533">Procure erros HTTP, como HTTP 429 (Número excessivo de solicitações), dependendo do serviço.</span><span class="sxs-lookup"><span data-stu-id="8890a-533">Look for HTTP errors such as HTTP 429 (Too Many Requests), depending on the service.</span></span>
- <span data-ttu-id="8890a-534">O tamanho da Fila HTTP aumenta.</span><span class="sxs-lookup"><span data-stu-id="8890a-534">HTTP queue length grows.</span></span>

<span data-ttu-id="8890a-535">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-535">**Recovery:**</span></span>

- <span data-ttu-id="8890a-536">Expanda para tratar do aumento de carga.</span><span class="sxs-lookup"><span data-stu-id="8890a-536">Scale out to handle increased load.</span></span>
- <span data-ttu-id="8890a-537">Mitigue falhas para evitar que falhas em cascata interrompa o aplicativo inteiro.</span><span class="sxs-lookup"><span data-stu-id="8890a-537">Mitigate failures to avoid having cascading failures disrupt the entire application.</span></span> <span data-ttu-id="8890a-538">As estratégias de mitigação incluem:</span><span class="sxs-lookup"><span data-stu-id="8890a-538">Mitigation strategies include:</span></span>

  - <span data-ttu-id="8890a-539">Implementar o [Padrão de Limitação][throttling-pattern] para evitar sobrecarregar sistemas de back-end.</span><span class="sxs-lookup"><span data-stu-id="8890a-539">Implement the [Throttling pattern][throttling-pattern] to avoid overwhelming backend systems.</span></span>
  - <span data-ttu-id="8890a-540">Usar o [nivelamento de carga baseado em fila][queue-based-load-leveling] para solicitações de buffer e processá-las em um ritmo apropriado.</span><span class="sxs-lookup"><span data-stu-id="8890a-540">Use [queue-based load leveling][queue-based-load-leveling] to buffer requests and process them at an appropriate pace.</span></span>
  - <span data-ttu-id="8890a-541">Priorizar determinados clientes.</span><span class="sxs-lookup"><span data-stu-id="8890a-541">Prioritize certain clients.</span></span> <span data-ttu-id="8890a-542">Por exemplo, se o aplicativo tiver camadas gratuitas e pagas, limite os clientes na camada gratuita, mas não os clientes pagos.</span><span class="sxs-lookup"><span data-stu-id="8890a-542">For example, if the application has free and paid tiers, throttle customers on the free tier, but not paid customers.</span></span> <span data-ttu-id="8890a-543">Veja [Padrão de fila de prioridade][priority-queue-pattern].</span><span class="sxs-lookup"><span data-stu-id="8890a-543">See [Priority queue pattern][priority-queue-pattern].</span></span>

<span data-ttu-id="8890a-544">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-544">**Diagnostics**.</span></span> <span data-ttu-id="8890a-545">Use o [registro em log de diagnóstico do Serviço de Aplicativo][app-service-logging].</span><span class="sxs-lookup"><span data-stu-id="8890a-545">Use [App Service diagnostic logging][app-service-logging].</span></span> <span data-ttu-id="8890a-546">Use um serviço como o [Azure Log Analytics][azure-log-analytics], o [Application Insights][app-insights] ou o [New Relic][new-relic] para ajudar na compreensão dos logs de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="8890a-546">Use a service such as [Azure Log Analytics][azure-log-analytics], [Application Insights][app-insights], or [New Relic][new-relic] to help understand the diagnostic logs.</span></span>

### <a name="one-of-the-operations-in-a-workflow-or-distributed-transaction-fails"></a><span data-ttu-id="8890a-547">Falha em uma das operações em um fluxo de trabalho ou uma transação distribuída.</span><span class="sxs-lookup"><span data-stu-id="8890a-547">One of the operations in a workflow or distributed transaction fails.</span></span>

<span data-ttu-id="8890a-548">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-548">**Detection**.</span></span> <span data-ttu-id="8890a-549">Depois de *N* novas tentativas, ainda há falha.</span><span class="sxs-lookup"><span data-stu-id="8890a-549">After *N* retry attempts, it still fails.</span></span>

<span data-ttu-id="8890a-550">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-550">**Recovery:**</span></span>

- <span data-ttu-id="8890a-551">Como plano de mitigação, implemente o padrão do [Supervisor do Agente do Agendador][scheduler-agent-supervisor] para gerenciar o fluxo de trabalho inteiro.</span><span class="sxs-lookup"><span data-stu-id="8890a-551">As a mitigation plan, implement the [Scheduler Agent Supervisor][scheduler-agent-supervisor] pattern to manage the entire workflow.</span></span>
- <span data-ttu-id="8890a-552">Não tente novamente quando o tempo limite esgotar.</span><span class="sxs-lookup"><span data-stu-id="8890a-552">Don't retry on timeouts.</span></span> <span data-ttu-id="8890a-553">Há uma baixa taxa de êxito para esse erro.</span><span class="sxs-lookup"><span data-stu-id="8890a-553">There is a low success rate for this error.</span></span>
- <span data-ttu-id="8890a-554">Coloque o trabalho na fila para tentar novamente mais tarde.</span><span class="sxs-lookup"><span data-stu-id="8890a-554">Queue work, in order to retry later.</span></span>

<span data-ttu-id="8890a-555">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-555">**Diagnostics**.</span></span> <span data-ttu-id="8890a-556">Registre em log todas as operações (bem-sucedidas e com falha), incluindo as ações de compensação.</span><span class="sxs-lookup"><span data-stu-id="8890a-556">Log all operations (successful and failed), including compensating actions.</span></span> <span data-ttu-id="8890a-557">Use as IDs de correlação para que você possa acompanhar todas as operações na mesma transação.</span><span class="sxs-lookup"><span data-stu-id="8890a-557">Use correlation IDs, so that you can track all operations within the same transaction.</span></span>

### <a name="a-call-to-a-remote-service-fails"></a><span data-ttu-id="8890a-558">Falha em uma chamada para um serviço remoto.</span><span class="sxs-lookup"><span data-stu-id="8890a-558">A call to a remote service fails.</span></span>

<span data-ttu-id="8890a-559">**Detecção**.</span><span class="sxs-lookup"><span data-stu-id="8890a-559">**Detection**.</span></span> <span data-ttu-id="8890a-560">Código de erro HTTP.</span><span class="sxs-lookup"><span data-stu-id="8890a-560">HTTP error code.</span></span>

<span data-ttu-id="8890a-561">**Recuperação:**</span><span class="sxs-lookup"><span data-stu-id="8890a-561">**Recovery:**</span></span>

1. <span data-ttu-id="8890a-562">Tente novamente em caso de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="8890a-562">Retry on transient failures.</span></span>
2. <span data-ttu-id="8890a-563">Se a chamada falhar após *N* tentativas, execute uma ação de fallback.</span><span class="sxs-lookup"><span data-stu-id="8890a-563">If the call fails after *N* attempts, take a fallback action.</span></span> <span data-ttu-id="8890a-564">(Depende do aplicativo.)</span><span class="sxs-lookup"><span data-stu-id="8890a-564">(Application specific.)</span></span>
3. <span data-ttu-id="8890a-565">Implemente o [padrão de Disjuntor][circuit-breaker] para evitar falhas em cascata.</span><span class="sxs-lookup"><span data-stu-id="8890a-565">Implement the [Circuit Breaker pattern][circuit-breaker] to avoid cascading failures.</span></span>

<span data-ttu-id="8890a-566">**Diagnóstico**.</span><span class="sxs-lookup"><span data-stu-id="8890a-566">**Diagnostics**.</span></span> <span data-ttu-id="8890a-567">Registre em log todas as falhas de chamada remota.</span><span class="sxs-lookup"><span data-stu-id="8890a-567">Log all remote call failures.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8890a-568">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="8890a-568">Next steps</span></span>

<span data-ttu-id="8890a-569">Para obter mais informações sobre o processo FMA, veja [Resilience by design for cloud services][resilience-by-design-pdf] (Resiliência por design para serviços de nuvem) (download de PDF).</span><span class="sxs-lookup"><span data-stu-id="8890a-569">For more information about the FMA process, see [Resilience by design for cloud services][resilience-by-design-pdf] (PDF download).</span></span>

<!-- markdownlint-enable MD026 -->

<!-- links -->

[api-management]: /azure/api-management/
[api-management-throttling]: /azure/api-management/api-management-sample-flexible-throttling/
[app-insights]: /azure/application-insights/app-insights-overview/
[app-insights-web-apps]: /azure/application-insights/app-insights-azure-web-apps/
[app-service-configure]: /azure/app-service-web/web-sites-configure/
[app-service-logging]: /azure/app-service-web/web-sites-enable-diagnostic-log/
[app-service-slots]: /azure/app-service-web/web-sites-staged-publishing/
[auto-rest-client-retry]: https://github.com/Azure/autorest/tree/master/docs
[azure-activity-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-activity-logs/
[azure-alerts]: /azure/monitoring-and-diagnostics/insights-alerts-portal/
[azure-log-analytics]: /azure/log-analytics/log-analytics-overview/
[BrokeredMessage.TimeToLive]: https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.timetolive.aspx
[cassandra-error-handling]: https://www.datastax.com/dev/blog/cassandra-error-handling-done-right
[circuit-breaker]: https://msdn.microsoft.com/library/dn589784.aspx
[cosmosdb-multi-region]: /azure/cosmos-db/tutorial-global-distribution-sql-api
[elasticsearch-azure]: ../elasticsearch/index.md
[elasticsearch-client]: https://www.elastic.co/guide/en/elasticsearch/client/index.html
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[onstop-events]: https://azure.microsoft.com/blog/the-right-way-to-handle-azure-onstop-events/
[lb-monitor]: /azure/load-balancer/load-balancer-monitor-log/
[lb-probe]: /azure/load-balancer/load-balancer-custom-probe-overview/#learn-about-the-types-of-probes
[new-relic]: https://newrelic.com/
[priority-queue-pattern]: https://msdn.microsoft.com/library/dn589794.aspx
[queue-based-load-leveling]: https://msdn.microsoft.com/library/dn589783.aspx
[QuotaExceededException]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.quotaexceededexception.aspx
[ra-web-apps-basic]: ../reference-architectures/app-service-web-app/basic-web-app.md
[redis-monitor]: /azure/redis-cache/cache-how-to-monitor/
[redis-retry]: ../best-practices/retry-service-specific.md#azure-redis-cache
[resilience-by-design-pdf]: https://download.microsoft.com/download/D/8/C/D8C599A4-4E8A-49BF-80EE-FE35F49B914D/Resilience_by_Design_for_Cloud_Services_White_Paper.pdf
[RoleEntryPoint.OnStop]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx
[RoleEnvironment.Stopping]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx
[rm-locks]: /azure/azure-resource-manager/resource-group-lock-resources/
[sb-dead-letter-queue]: /azure/service-bus-messaging/service-bus-dead-letter-queues/
[sb-georeplication-sample]: https://github.com/Azure-Samples/azure-servicebus-messaging-samples/tree/master/GeoReplication
[sb-messagingexception-class]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingexception.aspx
[sb-messaging-exceptions]: /azure/service-bus-messaging/service-bus-messaging-exceptions/
[sb-outages]: /azure/service-bus-messaging/service-bus-outages-disasters/#protecting-queues-and-topics-against-datacenter-outages-or-disasters
[sb-partition]: /azure/service-bus-messaging/service-bus-partitioning/
[sb-poison-message]: /azure/app-service-web/websites-dotnet-webjobs-sdk-storage-queues-how-to/#poison
[sb-retry]: ../best-practices/retry-service-specific.md#service-bus
[search-sdk]: https://msdn.microsoft.com/library/dn951165.aspx
[scheduler-agent-supervisor]: https://msdn.microsoft.com/library/dn589780.aspx
[search-analytics]: /azure/search/search-traffic-analytics/
[sql-db-audit]: /azure/sql-database/sql-database-auditing-get-started/
[sql-db-errors]: /azure/sql-database/sql-database-develop-error-messages/#resource-governance-errors
[sql-db-failover]: /azure/sql-database/sql-database-geo-replication-failover-portal/
[sql-db-limits]: /azure/sql-database/sql-database-resource-limits/
[sql-db-replication]: /azure/sql-database/sql-database-geo-replication-overview/
[storage-metrics]: https://msdn.microsoft.com/library/dn782843.aspx
[storage-replication]: /azure/storage/storage-redundancy/
[Storage.RetryPolicies]: https://msdn.microsoft.com/library/microsoft.windowsazure.storage.retrypolicies.aspx
[sys.event_log]: https://msdn.microsoft.com/library/dn270018.aspx
[throttling-pattern]: https://msdn.microsoft.com/library/dn589798.aspx
[web-jobs]: /azure/app-service-web/web-sites-create-web-jobs/
[web-jobs-shutdown]: /azure/app-service-web/websites-dotnet-webjobs-sdk-storage-queues-how-to/#graceful

---
title: 'Orientações técnicas: Recuperação de falhas locais no Azure'
description: Artigo sobre compreensão e design de aplicativos resilientes, altamente disponíveis e tolerante a falhas, bem como planejamento de recuperação de desastre concentrado em falhas locais no Azure.
author: adamglick
ms.date: 08/18/2016
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: resiliency
ms.openlocfilehash: a567b138580999c7b7a6ae8dedb244f4e37970e7
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486039"
---
[!INCLUDE [header](../_includes/header.md)]

# <a name="azure-resiliency-technical-guidance-recovery-from-local-failures-in-azure"></a><span data-ttu-id="9fc80-103">Orientações técnicas de resiliência do Azure: Recuperação de falhas locais no Azure</span><span class="sxs-lookup"><span data-stu-id="9fc80-103">Azure resiliency technical guidance: Recovery from local failures in Azure</span></span>

<span data-ttu-id="9fc80-104">Há duas ameaças básicas à disponibilidade de aplicativos:</span><span class="sxs-lookup"><span data-stu-id="9fc80-104">There are two primary threats to application availability:</span></span>

- <span data-ttu-id="9fc80-105">A falha de dispositivos, como unidades e servidores</span><span class="sxs-lookup"><span data-stu-id="9fc80-105">The failure of devices, such as drives and servers</span></span>
- <span data-ttu-id="9fc80-106">O esgotamento de recursos essenciais, como a computação em condições de picos de carga</span><span class="sxs-lookup"><span data-stu-id="9fc80-106">The exhaustion of critical resources, such as compute under peak load conditions</span></span>

<span data-ttu-id="9fc80-107">O Azure fornece uma combinação de gerenciamento de recursos, elasticidade, balanceamento de carga e particionamento para permitir alta disponibilidade sob essas circunstâncias.</span><span class="sxs-lookup"><span data-stu-id="9fc80-107">Azure provides a combination of resource management, elasticity, load balancing, and partitioning to enable high availability under these circumstances.</span></span> <span data-ttu-id="9fc80-108">Alguns desses recursos são executados automaticamente para todos os serviços do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-108">Some of these features are performed automatically for all Azure services.</span></span> <span data-ttu-id="9fc80-109">No entanto, em alguns casos, o desenvolvedor de aplicativo precisa fazer alguns ajustes para se beneficiar deles.</span><span class="sxs-lookup"><span data-stu-id="9fc80-109">However, in some cases, the application developer must do some additional work to benefit from them.</span></span>

## <a name="cloud-services"></a><span data-ttu-id="9fc80-110">Serviços de Nuvem</span><span class="sxs-lookup"><span data-stu-id="9fc80-110">Cloud Services</span></span>

<span data-ttu-id="9fc80-111">Os Serviços de Nuvem do Azure consistem em conjuntos de uma ou mais funções de trabalho ou web.</span><span class="sxs-lookup"><span data-stu-id="9fc80-111">Azure Cloud Services consists of collections of one or more web or worker roles.</span></span> <span data-ttu-id="9fc80-112">Uma ou mais instâncias de uma função podem ser executadas simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-112">One or more instances of a role can run concurrently.</span></span> <span data-ttu-id="9fc80-113">A configuração determina o número de instâncias.</span><span class="sxs-lookup"><span data-stu-id="9fc80-113">The configuration determines the number of instances.</span></span> <span data-ttu-id="9fc80-114">As instâncias de função são monitoradas e gerenciadas por meio de um componente chamado de controlador de malha.</span><span class="sxs-lookup"><span data-stu-id="9fc80-114">Role instances are monitored and managed through a component called the fabric controller.</span></span> <span data-ttu-id="9fc80-115">O controlador de malha detecta e responde automaticamente às falhas de software e hardware.</span><span class="sxs-lookup"><span data-stu-id="9fc80-115">The fabric controller detects and responds to both software and hardware failures automatically.</span></span>

<span data-ttu-id="9fc80-116">Cada instância de função é executada em sua própria VM (máquina virtual) e se comunica com seu controlador de malha por meio de um agente convidado.</span><span class="sxs-lookup"><span data-stu-id="9fc80-116">Every role instance runs in its own virtual machine (VM) and communicates with its fabric controller through a guest agent.</span></span> <span data-ttu-id="9fc80-117">O agente convidado coleta métricas de recurso e de nó, incluindo uso, status, logs, uso de recursos, exceções e condições de falha da VM.</span><span class="sxs-lookup"><span data-stu-id="9fc80-117">The guest agent collects resource and node metrics, including VM usage, status, logs, resource usage, exceptions, and failure conditions.</span></span> <span data-ttu-id="9fc80-118">O controlador de malha consulta o agente convidado em intervalos configuráveis e reinicia a VM se o agente convidado não responder.</span><span class="sxs-lookup"><span data-stu-id="9fc80-118">The fabric controller queries the guest agent at configurable intervals, and it restarts the VM if the guest agent fails to respond.</span></span> <span data-ttu-id="9fc80-119">No caso de falha de hardware, o controlador de malha associado move todas as instâncias de função afetadas para um novo nó de hardware e reconfigura a rede para rotear o tráfego para lá.</span><span class="sxs-lookup"><span data-stu-id="9fc80-119">In the event of hardware failure, the associated fabric controller moves all affected role instances to a new hardware node and reconfigures the network to route traffic there.</span></span>

<span data-ttu-id="9fc80-120">Para tirar proveito desses recursos, os desenvolvedores devem garantir que todas as funções de serviço evitem armazenar o estado nas instâncias de função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-120">To benefit from these features, developers should ensure that all service roles avoid storing state on the role instances.</span></span> <span data-ttu-id="9fc80-121">Em vez disso, todos os dados persistentes devem ser acessados do armazenamento durável, como Armazenamento do Azure ou Banco de Dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-121">Instead, all persistent data should be accessed from durable storage, such as Azure Storage or Azure SQL Database.</span></span> <span data-ttu-id="9fc80-122">Isso permite que qualquer função manipule solicitações.</span><span class="sxs-lookup"><span data-stu-id="9fc80-122">This allows any roles to handle requests.</span></span> <span data-ttu-id="9fc80-123">Isso também significa que as instâncias de função podem ficar inoperantes a qualquer momento sem criar inconsistências no estado transiente ou persistente do serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-123">It also means that role instances can go down at any time without creating inconsistencies in the transient or persistent state of the service.</span></span>

<span data-ttu-id="9fc80-124">O requisito para armazenar o estado externamente nas funções tem várias implicações.</span><span class="sxs-lookup"><span data-stu-id="9fc80-124">The requirement to store state externally to the roles has several implications.</span></span> <span data-ttu-id="9fc80-125">Significa, por exemplo, que todas as alterações relacionadas a uma tabela de Armazenamento do Azure devem ser modificadas em uma única transação de grupo de entidades, se possível.</span><span class="sxs-lookup"><span data-stu-id="9fc80-125">It implies, for example, that all related changes to an Azure Storage table should be changed in a single entity-group transaction, if possible.</span></span> <span data-ttu-id="9fc80-126">Obviamente, nem sempre é possível fazer todas as alterações em uma única transação.</span><span class="sxs-lookup"><span data-stu-id="9fc80-126">Of course, it isn't always possible to make all changes in a single transaction.</span></span> <span data-ttu-id="9fc80-127">Você deve tomar cuidado especial para garantir que falhas de instância de função não causem problemas quando interromperem operações de longa execução abrangendo duas ou mais atualizações para o estado persistente do serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-127">You must take special care to ensure that role instance failures do not cause problems when they interrupt long-running operations that span two or more updates to the persistent state of the service.</span></span> <span data-ttu-id="9fc80-128">Se outra função tentar repetir essa operação, ela deverá prever e tratar do caso em que o trabalho foi parcialmente concluído.</span><span class="sxs-lookup"><span data-stu-id="9fc80-128">If another role attempts to retry such an operation, it should anticipate and handle the case where the work was partially completed.</span></span>

<span data-ttu-id="9fc80-129">Por exemplo, considere um serviço que particione dados entre vários repositórios.</span><span class="sxs-lookup"><span data-stu-id="9fc80-129">For example, consider a service that partitions data across multiple stores.</span></span> <span data-ttu-id="9fc80-130">Se uma função de trabalho falhar enquanto estiver realocando um fragmento, talvez a realocação do fragmento não seja finalizada.</span><span class="sxs-lookup"><span data-stu-id="9fc80-130">If a worker role goes down while it's relocating a shard, the relocation of the shard might not finish.</span></span> <span data-ttu-id="9fc80-131">Ou a realocação pode ser repetida desde seu início por uma função de trabalho diferente, possivelmente causando uma corrupção de dados ou deixando dados órfãos.</span><span class="sxs-lookup"><span data-stu-id="9fc80-131">Or the relocation might be repeated from its inception by a different worker role, potentially causing orphaned data or data corruption.</span></span> <span data-ttu-id="9fc80-132">Para evitar problemas, as operações de longa execução devem ser dos tipos a seguir:</span><span class="sxs-lookup"><span data-stu-id="9fc80-132">To prevent problems, long-running operations must be one or both of the following:</span></span>

- <span data-ttu-id="9fc80-133">*Idempotente*: repetíveis sem efeitos colaterais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-133">*Idempotent*: Repeatable without side effects.</span></span> <span data-ttu-id="9fc80-134">Para ser idempotente, uma operação de longa execução deve ter o mesmo efeito, não importando quantas vezes ela é executada, mesmo que ela seja interrompida durante a execução.</span><span class="sxs-lookup"><span data-stu-id="9fc80-134">To be idempotent, a long-running operation should have the same effect no matter how many times it's executed, even when it's interrupted during execution.</span></span>
- <span data-ttu-id="9fc80-135">*Reinicializável incrementalmente*: capaz de continuar do ponto de falha mais recente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-135">*Incrementally restartable*: Able to continue from the most recent point of failure.</span></span> <span data-ttu-id="9fc80-136">Para ser reinicializável incrementalmente, uma operação longa execução deve consistir em uma sequência de operações atômicas menores.</span><span class="sxs-lookup"><span data-stu-id="9fc80-136">To be incrementally restartable, a long-running operation should consist of a sequence of smaller atomic operations.</span></span> <span data-ttu-id="9fc80-137">Ela também deve registrar seu progresso no armazenamento durável, de modo que cada invocação subsequente obtenha seu predecessor interrompido.</span><span class="sxs-lookup"><span data-stu-id="9fc80-137">It should also record its progress in durable storage, so that each subsequent invocation picks up where its predecessor stopped.</span></span>

<span data-ttu-id="9fc80-138">Por fim, todas as operações de longa execução devem ser invocadas repetidamente até que sejam bem-sucedidas.</span><span class="sxs-lookup"><span data-stu-id="9fc80-138">Finally, all long-running operations should be invoked repeatedly until they succeed.</span></span> <span data-ttu-id="9fc80-139">Por exemplo, uma operação de provisionamento pode ser colocada em uma fila do Azure e depois ser removida da fila por uma função de trabalho somente quando for bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="9fc80-139">For example, a provisioning operation might be placed in an Azure queue, and then removed from the queue by a worker role only when it succeeds.</span></span> <span data-ttu-id="9fc80-140">A coleta de lixo pode ser necessária para limpar os dados criados por operações interrompidas.</span><span class="sxs-lookup"><span data-stu-id="9fc80-140">Garbage collection might be necessary to clean up data that interrupted operations create.</span></span>

### <a name="elasticity"></a><span data-ttu-id="9fc80-141">Elasticidade</span><span class="sxs-lookup"><span data-stu-id="9fc80-141">Elasticity</span></span>

<span data-ttu-id="9fc80-142">O número inicial de instâncias em execução para cada função é determinado na configuração de cada função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-142">The initial number of instances running for each role is determined in each role’s configuration.</span></span> <span data-ttu-id="9fc80-143">Os administradores devem configurar inicialmente cada uma das funções para execução com duas ou mais instâncias baseadas na carga esperada.</span><span class="sxs-lookup"><span data-stu-id="9fc80-143">Administrators should initially configure each role to run with two or more instances based on expected load.</span></span> <span data-ttu-id="9fc80-144">Porém, é possível escalar verticalmente instâncias de função facilmente à medida que os padrões de uso mudam.</span><span class="sxs-lookup"><span data-stu-id="9fc80-144">But you can easily scale role instances up or down as usage patterns change.</span></span> <span data-ttu-id="9fc80-145">Você pode fazer isso manualmente no portal do Azure ou pode automatizar o processo usando o Windows PowerShell, a API de Gerenciamento de Serviços ou ferramentas de terceiros.</span><span class="sxs-lookup"><span data-stu-id="9fc80-145">You can do this manually in the Azure portal, or you can automate the process by using Windows PowerShell, the Service Management API, or third-party tools.</span></span> <span data-ttu-id="9fc80-146">Para saber mais, confira [Como dimensionar automaticamente um serviço de nuvem](/azure/cloud-services/cloud-services-how-to-scale/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-146">For more information, see [How to autoscale an application](/azure/cloud-services/cloud-services-how-to-scale/).</span></span>

### <a name="partitioning"></a><span data-ttu-id="9fc80-147">Particionamento</span><span class="sxs-lookup"><span data-stu-id="9fc80-147">Partitioning</span></span>

<span data-ttu-id="9fc80-148">O controlador de malha do Azure usa dois tipos de partição:</span><span class="sxs-lookup"><span data-stu-id="9fc80-148">The Azure fabric controller uses two types of partitions:</span></span>

- <span data-ttu-id="9fc80-149">Um *domínio de atualização* é usado para atualizar instâncias de função de um serviço em grupos.</span><span class="sxs-lookup"><span data-stu-id="9fc80-149">An *update domain* is used to upgrade a service’s role instances in groups.</span></span> <span data-ttu-id="9fc80-150">O Azure implanta instâncias do serviço em vários domínios de atualização.</span><span class="sxs-lookup"><span data-stu-id="9fc80-150">Azure deploys service instances into multiple update domains.</span></span> <span data-ttu-id="9fc80-151">Para uma atualização in-loco, o controlador de malha desativa todas as instâncias em um domínio de atualização, as atualiza e as reinicia antes de passar para o próximo domínio de atualização.</span><span class="sxs-lookup"><span data-stu-id="9fc80-151">For an in-place update, the fabric controller brings down all the instances in one update domain, updates them, and then restarts them before moving to the next update domain.</span></span> <span data-ttu-id="9fc80-152">Essa abordagem impede que o serviço inteiro fique indisponível durante o processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="9fc80-152">This approach prevents the entire service from being unavailable during the update process.</span></span>
- <span data-ttu-id="9fc80-153">Um *domínio de falha* define pontos potenciais de falha de hardware ou de rede.</span><span class="sxs-lookup"><span data-stu-id="9fc80-153">A *fault domain* defines potential points of hardware or network failure.</span></span> <span data-ttu-id="9fc80-154">Para qualquer função que tenha mais de uma instância, o controlador de malha garante que as instâncias sejam distribuídas entre vários domínios de falha, a fim de evitar que falhas de hardware isoladas interrompam o serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-154">For any role that has more than one instance, the fabric controller ensures that the instances are distributed across multiple fault domains, to prevent isolated hardware failures from disrupting service.</span></span> <span data-ttu-id="9fc80-155">Os domínios de falha administram toda a exposição de falhas de servidor e cluster.</span><span class="sxs-lookup"><span data-stu-id="9fc80-155">Fault domains govern all exposure to server and cluster failures.</span></span>

<span data-ttu-id="9fc80-156">O [SLA (contrato de nível de serviço) do Azure](https://azure.microsoft.com/support/legal/sla/) garante que quando duas ou mais instâncias de função web são implantadas em diferentes domínios de falha e atualização, elas tenham conectividade externa, pelo menos, 99,95% do tempo.</span><span class="sxs-lookup"><span data-stu-id="9fc80-156">The [Azure service-level agreement (SLA)](https://azure.microsoft.com/support/legal/sla/) guarantees that when two or more web role instances are deployed to different fault and upgrade domains, they'll have external connectivity at least 99.95 percent of the time.</span></span> <span data-ttu-id="9fc80-157">Ao contrário do que ocorre nos domínios de atualização, não há nenhuma maneira de controlar o número de domínios de falha.</span><span class="sxs-lookup"><span data-stu-id="9fc80-157">Unlike update domains, there's no way to control the number of fault domains.</span></span> <span data-ttu-id="9fc80-158">O Azure aloca domínios de falha e distribui instâncias de função entre eles automaticamente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-158">Azure automatically allocates fault domains and distributes role instances across them.</span></span> <span data-ttu-id="9fc80-159">Pelo menos as primeiras duas instâncias de cada função são colocadas em diferentes domínios de falha e de atualização para garantir que qualquer função com pelo menos duas instâncias atenda ao SLA.</span><span class="sxs-lookup"><span data-stu-id="9fc80-159">At least the first two instances of every role are placed in different fault and upgrade domains to ensure that any role with at least two instances will satisfy the SLA.</span></span> <span data-ttu-id="9fc80-160">Isso é representado no diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="9fc80-160">This is represented in the following diagram.</span></span>

![Exibição simplificada de isolamento de domínio de falha](./images/technical-guidance-recovery-local-failures/partitioning-1.png)

### <a name="load-balancing"></a><span data-ttu-id="9fc80-162">Balanceamento de carga</span><span class="sxs-lookup"><span data-stu-id="9fc80-162">Load balancing</span></span>

<span data-ttu-id="9fc80-163">Todo o tráfego de entrada para uma função web passa por um balanceador de carga sem estado, que distribui solicitações de cliente entre instâncias de função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-163">All inbound traffic to a web role passes through a stateless load balancer, which distributes client requests among the role instances.</span></span> <span data-ttu-id="9fc80-164">Instâncias de função individuais não têm endereços IP públicos e não podem ser endereçáveis diretamente da Internet.</span><span class="sxs-lookup"><span data-stu-id="9fc80-164">Individual role instances do not have public IP addresses, and they are not directly addressable from the Internet.</span></span> <span data-ttu-id="9fc80-165">As funções web não tem estado, de modo que qualquer solicitação de cliente possa ser roteada para qualquer instância de função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-165">Web roles are stateless so that any client request can be routed to any role instance.</span></span> <span data-ttu-id="9fc80-166">Um evento [StatusCheck](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.roleenvironment.statuscheck.aspx) é gerado a cada 15 segundos.</span><span class="sxs-lookup"><span data-stu-id="9fc80-166">A [StatusCheck](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.roleenvironment.statuscheck.aspx) event is raised every 15 seconds.</span></span> <span data-ttu-id="9fc80-167">Você pode usá-lo para indicar se a função está pronta para receber tráfego ou se ela está ocupada e deve ser retirada da rotação do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="9fc80-167">You can use this to indicate whether the role is ready to receive traffic, or whether it's busy and should be taken out of the load-balancer rotation.</span></span>

## <a name="virtual-machines"></a><span data-ttu-id="9fc80-168">Máquinas Virtuais</span><span class="sxs-lookup"><span data-stu-id="9fc80-168">Virtual Machines</span></span>

<span data-ttu-id="9fc80-169">As Máquinas Virtuais do Azure são diferentes de funções de computação de PaaS (plataforma como serviço) em vários aspectos, no que se refere à alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-169">Azure Virtual Machines differs from platform as a service (PaaS) compute roles in several respects in relation to high availability.</span></span> <span data-ttu-id="9fc80-170">Em alguns casos, você precisa fazer trabalho adicional para garantir a alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-170">In some instances, you must do additional work to ensure high availability.</span></span>

### <a name="disk-durability"></a><span data-ttu-id="9fc80-171">Durabilidade de disco</span><span class="sxs-lookup"><span data-stu-id="9fc80-171">Disk durability</span></span>

<span data-ttu-id="9fc80-172">Diferentemente do que ocorre nas instâncias de função de PaaS, os dados armazenados em unidades de máquina virtual são persistentes mesmo quando a máquina virtual é realocada.</span><span class="sxs-lookup"><span data-stu-id="9fc80-172">Unlike PaaS role instances, data stored on virtual machine drives is persistent even when the virtual machine is relocated.</span></span> <span data-ttu-id="9fc80-173">As máquinas virtuais do Azure usam discos de VM que existem como blobs no Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-173">Azure virtual machines use VM disks that exist as blobs in Azure Storage.</span></span> <span data-ttu-id="9fc80-174">Devido às características de disponibilidade do Armazenamento do Azure, os dados armazenados nas unidades de uma máquina virtual também têm alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-174">Because of the availability characteristics of Azure Storage, the data stored on a virtual machine’s drives is also highly available.</span></span>

<span data-ttu-id="9fc80-175">Observe que a unidade D (em VMs do Windows) é a exceção a essa regra.</span><span class="sxs-lookup"><span data-stu-id="9fc80-175">Note that drive D (in Windows VMs) is the exception to this rule.</span></span> <span data-ttu-id="9fc80-176">A unidade D é na verdade o armazenamento físico no servidor de rack que hospeda a VM, e seus dados serão perdidos se a VM for reciclada.</span><span class="sxs-lookup"><span data-stu-id="9fc80-176">Drive D is actually physical storage on the rack server that hosts the VM, and its data will be lost if the VM is recycled.</span></span> <span data-ttu-id="9fc80-177">A unidade D destina-se somente a armazenamento temporário.</span><span class="sxs-lookup"><span data-stu-id="9fc80-177">Drive D is intended for temporary storage only.</span></span> <span data-ttu-id="9fc80-178">No Linux, o Azure "geralmente" (mas nem sempre) expõe o disco temporário local como o dispositivo de bloco /dev/sdb.</span><span class="sxs-lookup"><span data-stu-id="9fc80-178">In Linux, Azure “usually” (but not always) exposes the local temporary disk as /dev/sdb block device.</span></span> <span data-ttu-id="9fc80-179">Geralmente, ele é montado pelo Agente Linux do Azure como pontos de montagem /mnt/resource ou /mnt (configuráveis via /etc/waagent.conf).</span><span class="sxs-lookup"><span data-stu-id="9fc80-179">It is often mounted by the Azure Linux Agent as /mnt/resource or /mnt mount points (configurable via /etc/waagent.conf).</span></span>

<!-- markdownlint-disable MD024 -->

### <a name="partitioning"></a><span data-ttu-id="9fc80-180">Particionamento</span><span class="sxs-lookup"><span data-stu-id="9fc80-180">Partitioning</span></span>

<span data-ttu-id="9fc80-181">O Azure compreende nativamente as camadas em um aplicativo de PaaS (função web e função de trabalho) e, portanto, pode distribuí-las entre domínios de falha e atualização.</span><span class="sxs-lookup"><span data-stu-id="9fc80-181">Azure natively understands the tiers in a PaaS application (web role and worker role) and thus can properly distribute them across fault and update domains.</span></span> <span data-ttu-id="9fc80-182">Em contrapartida, as camadas em um aplicativos de IaaS (infraestrutura como serviço) devem ser definidas manualmente por meio de conjuntos de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-182">In contrast, the tiers in an infrastructure as a service (IaaS) application must be manually defined through availability sets.</span></span> <span data-ttu-id="9fc80-183">Os conjuntos de disponibilidade são necessários para um SLA de IaaS.</span><span class="sxs-lookup"><span data-stu-id="9fc80-183">Availability sets are required for an SLA under IaaS.</span></span>

![Conjuntos de disponibilidade para máquinas virtuais do Azure](./images/technical-guidance-recovery-local-failures/partitioning-2.png)

<span data-ttu-id="9fc80-185">No diagrama anterior, a camada de IIS (Serviços de Informações da Internet) (que funciona como uma camada de aplicativo Web) e a camada SQL (que funciona como uma camada de dados) são atribuídas a diferentes conjuntos de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-185">In the preceding diagram, the Internet Information Services (IIS) tier (which works as a web app tier) and the SQL tier (which works as a data tier) are assigned to different availability sets.</span></span> <span data-ttu-id="9fc80-186">Isso garante que todas as instâncias de cada camada tenham redundância de hardware na distribuição de máquinas virtuais entre domínios de falha e que as camadas inteiras não sejam desativadas durante uma atualização.</span><span class="sxs-lookup"><span data-stu-id="9fc80-186">This ensures that all instances of each tier have hardware redundancy by distributing virtual machines across fault domains, and that entire tiers are not taken down during an update.</span></span>

### <a name="load-balancing"></a><span data-ttu-id="9fc80-187">Balanceamento de carga</span><span class="sxs-lookup"><span data-stu-id="9fc80-187">Load balancing</span></span>

<span data-ttu-id="9fc80-188">Se as VMs devem ter tráfego distribuído entre elas, você deve agrupá-las em um aplicativo e realizar o balanceamento de carga por um ponto de extremidade TCP ou UDP específico.</span><span class="sxs-lookup"><span data-stu-id="9fc80-188">If the VMs should have traffic distributed across them, you must group the VMs in an application and load balance across a specific TCP or UDP endpoint.</span></span> <span data-ttu-id="9fc80-189">Para saber mais, confira [Balanceamento de carga de máquinas virtuais](/azure/virtual-machines/virtual-machines-linux-load-balance/?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="9fc80-189">For more information, see [Load balancing virtual machines](/azure/virtual-machines/virtual-machines-linux-load-balance/?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <span data-ttu-id="9fc80-190">Se as VMs receberem entrada de outra fonte (por exemplo, um mecanismo de enfileiramento), não será necessário um balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="9fc80-190">If the VMs receive input from another source (for example, a queuing mechanism), a load balancer is not required.</span></span> <span data-ttu-id="9fc80-191">O balanceador de carga usará uma verificação básica de integridade para determinar se o tráfego deve ser enviado para o nó.</span><span class="sxs-lookup"><span data-stu-id="9fc80-191">The load balancer uses a basic health check to determine whether traffic should be sent to the node.</span></span> <span data-ttu-id="9fc80-192">Também é possível criar suas próprias investigações para implementar as métricas de integridade específicas de aplicativo que determinam se a VM deve receber tráfego.</span><span class="sxs-lookup"><span data-stu-id="9fc80-192">It's also possible to create your own probes to implement application-specific health metrics that determine whether the VM should receive traffic.</span></span>

## <a name="storage"></a><span data-ttu-id="9fc80-193">Armazenamento</span><span class="sxs-lookup"><span data-stu-id="9fc80-193">Storage</span></span>

<span data-ttu-id="9fc80-194">O Armazenamento do Azure é o serviço de dados durável de linha de base do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-194">Azure Storage is the baseline durable data service for Azure.</span></span> <span data-ttu-id="9fc80-195">Ele fornece blob, tabela, fila e armazenamento de VM em disco.</span><span class="sxs-lookup"><span data-stu-id="9fc80-195">It provides blob, table, queue, and VM disk storage.</span></span> <span data-ttu-id="9fc80-196">Ele usa uma combinação de replicação e gerenciamento de recursos para fornecer alta disponibilidade em um único datacenter.</span><span class="sxs-lookup"><span data-stu-id="9fc80-196">It uses a combination of replication and resource management to provide high availability within a single datacenter.</span></span> <span data-ttu-id="9fc80-197">O SLA de disponibilidade do Armazenamento do Azure garante que em pelo menos 99,9% do tempo:</span><span class="sxs-lookup"><span data-stu-id="9fc80-197">The Azure Storage availability SLA guarantees that at least 99.9 percent of the time:</span></span>

- <span data-ttu-id="9fc80-198">As solicitações corretamente formatadas para adicionar, atualizar, ler e excluir dados serão ser bem-sucedidas e processadas corretamente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-198">Correctly formatted requests to add, update, read, and delete data will be successfully and correctly processed.</span></span>
- <span data-ttu-id="9fc80-199">As contas de armazenamento terão conectividade com o gateway de Internet.</span><span class="sxs-lookup"><span data-stu-id="9fc80-199">Storage accounts will have connectivity to the Internet gateway.</span></span>

### <a name="replication"></a><span data-ttu-id="9fc80-200">Replicação</span><span class="sxs-lookup"><span data-stu-id="9fc80-200">Replication</span></span>

<span data-ttu-id="9fc80-201">O Armazenamento do Azure facilita a durabilidade de dados mantendo várias cópias de todos os dados em diferentes unidades pelos subsistemas físicos de armazenamento totalmente independentes na região.</span><span class="sxs-lookup"><span data-stu-id="9fc80-201">Azure Storage facilitates data durability by maintaining multiple copies of all data on different drives across fully independent physical storage subsystems within the region.</span></span> <span data-ttu-id="9fc80-202">Os dados são replicados de forma síncrona e todas as cópias são confirmadas antes da confirmação da gravação.</span><span class="sxs-lookup"><span data-stu-id="9fc80-202">Data is replicated synchronously, and all copies are committed before the write is acknowledged.</span></span> <span data-ttu-id="9fc80-203">O Armazenamento do Azure é altamente consistente, o que significa que há garantia de que as leituras reflitam as gravações mais recentes.</span><span class="sxs-lookup"><span data-stu-id="9fc80-203">Azure Storage is strongly consistent, meaning that reads are guaranteed to reflect the most recent writes.</span></span> <span data-ttu-id="9fc80-204">Além disso, cópias de dados são verificadas continuamente para detectar e reparar bits corrompidos, uma ameaça frequentemente desconsiderada à integridade dos dados armazenados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-204">In addition, copies of data are continually scanned to detect and repair bit rot, an often overlooked threat to the integrity of stored data.</span></span>

<span data-ttu-id="9fc80-205">Os serviços se beneficiam da replicação apenas pelo uso do Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-205">Services benefit from replication just by using Azure Storage.</span></span> <span data-ttu-id="9fc80-206">O desenvolvedor do serviço não precisa fazer mais nada para se recuperar de uma falha local.</span><span class="sxs-lookup"><span data-stu-id="9fc80-206">The service developer doesn't need to do additional work to recover from a local failure.</span></span>

### <a name="resource-management"></a><span data-ttu-id="9fc80-207">Gerenciamento de recursos</span><span class="sxs-lookup"><span data-stu-id="9fc80-207">Resource management</span></span>

<span data-ttu-id="9fc80-208">As contas de armazenamento criadas depois de maio de 2014 podem ter até 500 TB (o máximo anterior era 200 TB).</span><span class="sxs-lookup"><span data-stu-id="9fc80-208">Storage accounts created after May 2014, can grow to up to 500 TB (the previous maximum was 200 TB).</span></span> <span data-ttu-id="9fc80-209">Se espaço adicional for necessário, os aplicativos deverão ser criados para usar várias contas de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-209">If additional space is required, applications must be designed to use multiple storage accounts.</span></span>

### <a name="virtual-machine-disks"></a><span data-ttu-id="9fc80-210">Discos de máquina virtual</span><span class="sxs-lookup"><span data-stu-id="9fc80-210">Virtual machine disks</span></span>

<span data-ttu-id="9fc80-211">O disco de uma máquina virtual é armazenado como um blob de páginas no Armazenamento do Azure, o que dá a ele todas as mesmas propriedades de durabilidade e escalabilidade do armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="9fc80-211">A virtual machine’s disk is stored as a page blob in Azure Storage, giving it all the same durability and scalability properties as Blob storage.</span></span> <span data-ttu-id="9fc80-212">Esse design torna os dados em um disco de máquina virtual persistentes, mesmo se o servidor que executa a VM falhar e a VM precisa ser reiniciada em outro servidor.</span><span class="sxs-lookup"><span data-stu-id="9fc80-212">This design makes the data on a virtual machine’s disk persistent, even if the server running the VM fails and the VM must be restarted on another server.</span></span>

## <a name="database"></a><span data-ttu-id="9fc80-213">Banco de dados</span><span class="sxs-lookup"><span data-stu-id="9fc80-213">Database</span></span>

### <a name="sql-database"></a><span data-ttu-id="9fc80-214">Banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="9fc80-214">SQL Database</span></span>

<span data-ttu-id="9fc80-215">O Banco de Dados SQL do Azure fornece banco de dados como serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-215">Azure SQL Database provides database as a service.</span></span> <span data-ttu-id="9fc80-216">Ele permite que aplicativos sejam provisionados rapidamente, insiram dados e consultem bancos de dados relacionais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-216">It allows applications to quickly provision, insert data into, and query relational databases.</span></span> <span data-ttu-id="9fc80-217">Ele fornece muitos dos recursos e funcionalidades conhecidos do SQL Server, ao mesmo tempo que abstrai a carga de hardware, configuração, aplicação de patch e resiliência.</span><span class="sxs-lookup"><span data-stu-id="9fc80-217">It provides many of the familiar SQL Server features and functionality, while abstracting the burden of hardware, configuration, patching, and resiliency.</span></span>

> [!NOTE]
> <span data-ttu-id="9fc80-218">O Banco de Dados do SQL Azure não fornece paridade de recurso um para um com o SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9fc80-218">Azure SQL Database does not provide one-to-one feature parity with SQL Server.</span></span> <span data-ttu-id="9fc80-219">Ele foi desenvolvido para atender a um conjunto diferente de requisitos — um que seja exclusivamente adequado para aplicativos de nuvem (escala elástica, banco de dados como serviço para reduzir custos de manutenção e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="9fc80-219">It's intended to fulfill a different set of requirements--one that's uniquely suited to cloud applications (elastic scale, database as a service to reduce maintenance costs, and so on).</span></span> <span data-ttu-id="9fc80-220">Para mais informações, confira [Escolher uma opção do SQL Server de nuvem: Banco de dados do Azure SQL (PaaS) ou SQL Server em máquinas virtuais do Azure (IaaS)](/azure/sql-database/sql-database-paas-vs-sql-server-iaas/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-220">For more information, see [Choose a cloud SQL Server option: Azure SQL (PaaS) Database or SQL Server on Azure VMs (IaaS)](/azure/sql-database/sql-database-paas-vs-sql-server-iaas/).</span></span>

#### <a name="replication"></a><span data-ttu-id="9fc80-221">Replicação</span><span class="sxs-lookup"><span data-stu-id="9fc80-221">Replication</span></span>

<span data-ttu-id="9fc80-222">O Banco de Dados SQL do Azure fornece resiliência interna a falhas no nível de nó.</span><span class="sxs-lookup"><span data-stu-id="9fc80-222">Azure SQL Database provides built-in resiliency to node-level failure.</span></span> <span data-ttu-id="9fc80-223">Todas as gravações em um banco de dados são replicadas automaticamente em dois ou mais nós em segundo plano por meio de uma técnica de confirmação de quorum.</span><span class="sxs-lookup"><span data-stu-id="9fc80-223">All writes into a database are automatically replicated to two or more background nodes through a quorum commit technique.</span></span> <span data-ttu-id="9fc80-224">(A réplica primária, e pelo menos uma secundária, devem confirmar que a atividade foi gravada no log de transações antes que a transação seja considerada bem-sucedida e retorne.) No caso de falha de nó, o banco de dados faz failover automaticamente para uma das réplicas secundárias.</span><span class="sxs-lookup"><span data-stu-id="9fc80-224">(The primary and at least one secondary must confirm that the activity is written to the transaction log before the transaction is deemed successful and returns.) In the case of node failure, the database automatically fails over to one of the secondary replicas.</span></span> <span data-ttu-id="9fc80-225">Isso causa uma interrupção de conexão transitória para aplicativos cliente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-225">This causes a transient connection interruption for client applications.</span></span> <span data-ttu-id="9fc80-226">Por esse motivo, todos os clientes do Banco de Dados SQL do Azure devem implementar alguma forma de tratamento de conexão transitória.</span><span class="sxs-lookup"><span data-stu-id="9fc80-226">For this reason, all Azure SQL Database clients must implement some form of transient connection handling.</span></span> <span data-ttu-id="9fc80-227">Para saber mais, confira [Diretriz específica do serviço de repetição](/azure/best-practices-retry-service-specific/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-227">For more information, see [Retry service specific guidance](/azure/best-practices-retry-service-specific/).</span></span>

#### <a name="resource-management"></a><span data-ttu-id="9fc80-228">Gerenciamento de recursos</span><span class="sxs-lookup"><span data-stu-id="9fc80-228">Resource management</span></span>

<span data-ttu-id="9fc80-229">Cada banco de dados, quando criado, é configurado com um limite de tamanho superior.</span><span class="sxs-lookup"><span data-stu-id="9fc80-229">Each database, when created, is configured with an upper size limit.</span></span> <span data-ttu-id="9fc80-230">O tamanho máximo disponível atualmente é de 1 TB (os limites de tamanho variam com base em sua camada de serviço; confira [camadas de serviço e níveis de desempenho de Bancos de Dados do SQL Azure](/azure/sql-database/sql-database-resource-limits/#service-tiers-and-performance-levels).</span><span class="sxs-lookup"><span data-stu-id="9fc80-230">The currently available maximum size is 1 TB (size limits vary based on your service tier, see [service tiers and performance levels of Azure SQL Databases](/azure/sql-database/sql-database-resource-limits/#service-tiers-and-performance-levels).</span></span> <span data-ttu-id="9fc80-231">Quando um banco de dados atinge seu limite de tamanho superior, ele rejeita os comandos adicionais INSERT ou UPDATE.</span><span class="sxs-lookup"><span data-stu-id="9fc80-231">When a database hits its upper size limit, it rejects additional INSERT or UPDATE commands.</span></span> <span data-ttu-id="9fc80-232">(Ainda é possível consultar e excluir dados).</span><span class="sxs-lookup"><span data-stu-id="9fc80-232">(Querying and deleting data is still possible.)</span></span>

<span data-ttu-id="9fc80-233">Em um banco de dados, o Banco de Dados SQL do Azure usa uma malha para gerenciar recursos.</span><span class="sxs-lookup"><span data-stu-id="9fc80-233">Within a database, Azure SQL Database uses a fabric to manage resources.</span></span> <span data-ttu-id="9fc80-234">No entanto, em vez de um controlador de malha, ele usa uma topologia de anel para detectar falhas.</span><span class="sxs-lookup"><span data-stu-id="9fc80-234">However, instead of a fabric controller, it uses a ring topology to detect failures.</span></span> <span data-ttu-id="9fc80-235">Cada réplica em um cluster tem dois vizinhos e é responsável por detectar quando eles são desativados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-235">Every replica in a cluster has two neighbors and is responsible for detecting when they go down.</span></span> <span data-ttu-id="9fc80-236">Quando uma réplica é desativada, seus vizinhos disparam um agente de reconfiguração para recriá-la em outro computador.</span><span class="sxs-lookup"><span data-stu-id="9fc80-236">When a replica goes down, its neighbors trigger a reconfiguration agent to re-create it on another machine.</span></span> <span data-ttu-id="9fc80-237">A limitação de mecanismo é fornecida para garantir que um servidor lógico não use recursos demais em um computador ou exceda seus limites físicos.</span><span class="sxs-lookup"><span data-stu-id="9fc80-237">Engine throttling is provided to ensure that a logical server doesn't use too many resources on a machine or exceed the machine’s physical limits.</span></span>

### <a name="elasticity"></a><span data-ttu-id="9fc80-238">Elasticidade</span><span class="sxs-lookup"><span data-stu-id="9fc80-238">Elasticity</span></span>

<span data-ttu-id="9fc80-239">Se o aplicativo exigir mais do que o limite de banco de dados de 1 TB, ele deverá implementar uma abordagem de escalonamento horizontal.</span><span class="sxs-lookup"><span data-stu-id="9fc80-239">If the application requires more than the 1 TB database limit, it must implement a scale-out approach.</span></span> <span data-ttu-id="9fc80-240">Escale horizontalmente com o Banco de Dados SQL particionando manualmente os dados, também conhecido como fragmentação, entre vários bancos de dados SQL.</span><span class="sxs-lookup"><span data-stu-id="9fc80-240">You scale out with Azure SQL Database by manually partitioning, also known as sharding, data across multiple SQL databases.</span></span> <span data-ttu-id="9fc80-241">Essa abordagem de escalonamento horizontal dá oportunidade de atingir o crescimento de custo praticamente linear com escala.</span><span class="sxs-lookup"><span data-stu-id="9fc80-241">This scale-out approach provides the opportunity to achieve nearly linear cost growth with scale.</span></span> <span data-ttu-id="9fc80-242">O crescimento elástico ou a capacidade sob demanda podem crescer com custos incrementais conforme necessário, porque os bancos de dados são cobrados com base no tamanho real médio usado por dia, e não no tamanho máximo possível.</span><span class="sxs-lookup"><span data-stu-id="9fc80-242">Elastic growth or capacity on demand can grow with incremental costs as needed because databases are billed based on the average actual size used per day, not based on maximum possible size.</span></span>

## <a name="sql-server-on-virtual-machines"></a><span data-ttu-id="9fc80-243">SQL Server em máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="9fc80-243">SQL Server on Virtual Machines</span></span>

<span data-ttu-id="9fc80-244">A instalar o SQL Server (versão 2014 ou posterior) nas Máquinas Virtuais do Azure, você pode aproveitar os recursos tradicionais de disponibilidade do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9fc80-244">By installing SQL Server (version 2014 or later) on Azure Virtual Machines, you can take advantage of the traditional availability features of SQL Server.</span></span> <span data-ttu-id="9fc80-245">Esses recursos incluem Grupos de Disponibilidade do AlwaysOn e espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-245">These features include AlwaysOn Availability Groups and database mirroring.</span></span> <span data-ttu-id="9fc80-246">Observe que as VMs, o armazenamento e a rede do Azure têm características operacionais diferentes de uma infraestrutura de TI local não virtualizada.</span><span class="sxs-lookup"><span data-stu-id="9fc80-246">Note that Azure VMs, storage, and networking have different operational characteristics than an on-premises, non-virtualized IT infrastructure.</span></span> <span data-ttu-id="9fc80-247">Uma implementação bem-sucedida de uma solução do SQL Server de HA/DR (alta disponibilidade/recuperação de desastre) no Azure requer que você compreenda essas diferenças e crie sua solução para acomodá-las.</span><span class="sxs-lookup"><span data-stu-id="9fc80-247">A successful implementation of a high availability/disaster recovery (HA/DR) SQL Server solution in Azure requires that you understand these differences and design your solution to accommodate them.</span></span>

### <a name="high-availability-nodes-in-an-availability-set"></a><span data-ttu-id="9fc80-248">Nós de alta disponibilidade em um conjunto de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="9fc80-248">High-availability nodes in an availability set</span></span>

<span data-ttu-id="9fc80-249">Quando você implementa uma solução de alta disponibilidade no Azure, é possível usar o conjunto de disponibilidade no Azure para colocar os nós de alta disponibilidade em domínios de falha e domínios de atualização separados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-249">When you implement a high-availability solution in Azure, you can use the availability set in Azure to place the high-availability nodes into separate fault domains and upgrade domains.</span></span> <span data-ttu-id="9fc80-250">Para ser claro, o conjunto de disponibilidade é um conceito do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-250">To be clear, the availability set is an Azure concept.</span></span> <span data-ttu-id="9fc80-251">É uma prática recomendada que deve ser seguida para garantir que seus bancos de dados sejam, de fato, altamente disponibilizados, esteja você usando grupos de disponibilidade AlwaysOn, espelhamento de banco de dados ou outro meio.</span><span class="sxs-lookup"><span data-stu-id="9fc80-251">It's a best practice that you should follow to make sure that your databases are indeed highly available, whether you're using AlwaysOn Availability Groups, database mirroring, or something else.</span></span> <span data-ttu-id="9fc80-252">Não seguir essa prática recomendada pode fazê-lo supor erroneamente que seu sistema esteja altamente disponível.</span><span class="sxs-lookup"><span data-stu-id="9fc80-252">If you don't follow this best practice, you might be under the false assumption that your system is highly available.</span></span> <span data-ttu-id="9fc80-253">Na realidade, os nós podem falhar simultaneamente, pois pode acontecer de serem colocados no mesmo domínio de falha na região do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-253">But in reality, your nodes can all fail simultaneously because they happen to be placed in the same fault domain in the Azure region.</span></span>

<span data-ttu-id="9fc80-254">Essa recomendação não se aplica integralmente ao envio de logs.</span><span class="sxs-lookup"><span data-stu-id="9fc80-254">This recommendation is not as applicable with log shipping.</span></span> <span data-ttu-id="9fc80-255">Como um recurso de recuperação de desastre, você deve garantir que os servidores estejam sendo executados em regiões separadas do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-255">As a disaster recovery feature, you should ensure that the servers are running in separate Azure regions.</span></span> <span data-ttu-id="9fc80-256">Por definição, essas regiões são domínios de falha separados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-256">By definition, these regions are separate fault domains.</span></span>

<span data-ttu-id="9fc80-257">Para VMs de Serviços de Nuvem do Azure implantadas por meio do portal clássico para estarem no mesmo conjunto de disponibilidade, você deve implantá-las no mesmo Serviço de Nuvem.</span><span class="sxs-lookup"><span data-stu-id="9fc80-257">For Azure Cloud Services VMs deployed through the classic portal to be in the same availability set, you must deploy them in the same Cloud Service.</span></span> <span data-ttu-id="9fc80-258">VMs implantadas por meio do Azure Resource Manager (o portal atual) não têm essa limitação.</span><span class="sxs-lookup"><span data-stu-id="9fc80-258">VMs deployed through Azure Resource Manager (the current portal) do not have this limitation.</span></span> <span data-ttu-id="9fc80-259">Para VMs implantadas do portal clássico no Serviço de Nuvem do Azure, apenas os nós no mesmo Serviço de Nuvem podem participar do mesmo conjunto de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-259">For classic portal deployed VMs in Azure Cloud Service, only nodes in the same Cloud Service can participate in the same availability set.</span></span> <span data-ttu-id="9fc80-260">Além disso, as VMs dos Serviços de Nuvem deve estar na mesma rede virtual para garantir que mantenham seus IPs mesmo após a recuperação do serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-260">In addition, the Cloud Services VMs should be in the same virtual network to ensure that they maintain their IPs even after service healing.</span></span> <span data-ttu-id="9fc80-261">Isso evita interrupções de atualização de DNS.</span><span class="sxs-lookup"><span data-stu-id="9fc80-261">This avoids DNS update disruptions.</span></span>

### <a name="azure-only-high-availability-solutions"></a><span data-ttu-id="9fc80-262">Somente Azure: soluções de alta disponibilidade</span><span class="sxs-lookup"><span data-stu-id="9fc80-262">Azure-only: High-availability solutions</span></span>

<span data-ttu-id="9fc80-263">Você pode ter uma solução de alta disponibilidade para seus bancos de dados do SQL Server no Azure usando Grupos de Disponibilidade AlwaysOn ou o espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9fc80-263">You can have a high-availability solution for your SQL Server databases in Azure by using AlwaysOn Availability Groups or database mirroring.</span></span>

<span data-ttu-id="9fc80-264">O diagrama a seguir mostra a arquitetura dos Grupos de Disponibilidade AlwaysOn em execução em Máquinas Virtuais do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-264">The following diagram demonstrates the architecture of AlwaysOn Availability Groups running on Azure Virtual Machines.</span></span> <span data-ttu-id="9fc80-265">Esse diagrama foi retirado do artigo detalhado sobre o assunto, [Alta disponibilidade e recuperação de desastre para SQL Server nas Máquinas Virtuais do Azure](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-265">This diagram was taken from the in-depth article on this subject, [High availability and disaster recovery for SQL Server on Azure Virtual Machines](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span></span>

![Grupos de disponibilidade AlwaysOn no Microsoft Azure](./images/technical-guidance-recovery-local-failures/high_availability_solutions-1.png)

<span data-ttu-id="9fc80-267">Você também pode provisionar automaticamente a implantação de um Grupo de Disponibilidade AlwaysOn completo em VMs do Azure usando o modelo AlwaysOn no portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-267">You can also automatically provision an AlwaysOn Availability Groups deployment end-to-end on Azure VMs by using the AlwaysOn template in the Azure portal.</span></span> <span data-ttu-id="9fc80-268">Para obter mais informações, consulte [Oferta do AlwaysOn do SQL Server na Galeria do Portal do Microsoft Azure](https://blogs.technet.microsoft.com/dataplatforminsider/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-268">For more information, see [SQL Server AlwaysOn Offering in Microsoft Azure Portal Gallery](https://blogs.technet.microsoft.com/dataplatforminsider/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery/).</span></span>

<span data-ttu-id="9fc80-269">O diagrama a seguir demonstra o uso de espelhamento de banco de dados em Máquinas Virtuais do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-269">The following diagram demonstrates the use of database mirroring on Azure Virtual Machines.</span></span> <span data-ttu-id="9fc80-270">Ele também foi extraído do tópico detalhado sobre [Alta disponibilidade e recuperação de desastre para SQL Server nas Máquinas Virtuais do Azure](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span><span class="sxs-lookup"><span data-stu-id="9fc80-270">It was also taken from the in-depth topic [High availability and disaster recovery for SQL Server on Azure Virtual Machines](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/).</span></span>

![Espalhamento de banco de dados no Microsoft Azure](./images/technical-guidance-recovery-local-failures/high_availability_solutions-2.png)

> [!NOTE]
> <span data-ttu-id="9fc80-272">Ambas as arquiteturas exigem um controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="9fc80-272">Both architectures require a domain controller.</span></span> <span data-ttu-id="9fc80-273">No entanto, com o espelhamento de banco de dados, é possível usar certificados de servidor para eliminar a necessidade de um controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="9fc80-273">However, with database mirroring, it's possible to use server certificates to eliminate the need for a domain controller.</span></span>

## <a name="other-azure-platform-services"></a><span data-ttu-id="9fc80-274">Outros serviços da plataforma Azure</span><span class="sxs-lookup"><span data-stu-id="9fc80-274">Other Azure platform services</span></span>

<span data-ttu-id="9fc80-275">Os aplicativos criados no Azure se beneficiam dos recursos de plataforma para se recuperar de falhas locais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-275">Applications that are built on Azure benefit from platform capabilities to recover from local failures.</span></span> <span data-ttu-id="9fc80-276">Em alguns casos, você pode executar ações específicas para aumentar a disponibilidade para seu cenário específico.</span><span class="sxs-lookup"><span data-stu-id="9fc80-276">In some cases, you can take specific actions to increase availability for your specific scenario.</span></span>

### <a name="service-bus"></a><span data-ttu-id="9fc80-277">Barramento de Serviço</span><span class="sxs-lookup"><span data-stu-id="9fc80-277">Service Bus</span></span>

<span data-ttu-id="9fc80-278">Para atenuar uma interrupção temporária do Barramento de Serviço do Azure, considere a criação de uma fila durável do lado do cliente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-278">To mitigate against a temporary outage of Azure Service Bus, consider creating a durable client-side queue.</span></span> <span data-ttu-id="9fc80-279">Isso usa temporariamente um mecanismo de armazenamento local alternativo para armazenar mensagens que não podem ser adicionadas à fila de Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="9fc80-279">This temporarily uses an alternate, local storage mechanism to store messages that cannot be added to the Service Bus queue.</span></span> <span data-ttu-id="9fc80-280">O aplicativo pode decidir como lidar com as mensagens armazenadas temporariamente depois que o serviço for restaurado.</span><span class="sxs-lookup"><span data-stu-id="9fc80-280">The application can decide how to handle the temporarily stored messages after the service is restored.</span></span> <span data-ttu-id="9fc80-281">Para saber mais, confira [Práticas recomendadas para melhorias de desempenho usando o sistema de mensagens agenciado do Barramento de Serviço](/azure/service-bus-messaging/service-bus-performance-improvements/) e [Barramento de Serviço (recuperação de desastre)](recovery-loss-azure-region.md#other-azure-platform-services).</span><span class="sxs-lookup"><span data-stu-id="9fc80-281">For more information, see [Best practices for performance improvements using Service Bus brokered messaging](/azure/service-bus-messaging/service-bus-performance-improvements/) and [Service Bus (disaster recovery)](recovery-loss-azure-region.md#other-azure-platform-services).</span></span>

### <a name="hdinsight"></a><span data-ttu-id="9fc80-282">HDInsight</span><span class="sxs-lookup"><span data-stu-id="9fc80-282">HDInsight</span></span>

<span data-ttu-id="9fc80-283">Os dados associados ao HDInsight do Azure são armazenados por padrão no armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="9fc80-283">The data that's associated with Azure HDInsight is stored by default in Azure Blob storage.</span></span> <span data-ttu-id="9fc80-284">O Armazenamento do Azure especifica as propriedades de durabilidade e alta disponibilidade para o armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="9fc80-284">Azure Storage specifies high-availability and durability properties for Blob storage.</span></span> <span data-ttu-id="9fc80-285">O processamento de vários nós associado aos trabalhos do Hadoop MapReduce ocorre em um HDFS (Sistema de Arquivos Distribuídos Hadoop) transitório que é provisionado quando necessário pelo HDInsight.</span><span class="sxs-lookup"><span data-stu-id="9fc80-285">The multiple-node processing that's associated with Hadoop MapReduce jobs occurs on a transient Hadoop Distributed File System (HDFS) that is provisioned when HDInsight needs it.</span></span> <span data-ttu-id="9fc80-286">Os resultados de um trabalho MapReduce também são armazenados por padrão no armazenamento de Blobs do Azure para que os dados processados sejam duráveis e permaneçam altamente disponíveis depois que o cluster Hadoop for desprovisionado.</span><span class="sxs-lookup"><span data-stu-id="9fc80-286">Results from a MapReduce job are also stored by default in Azure Blob storage, so that the processed data is durable and remains highly available after the Hadoop cluster is deprovisioned.</span></span> <span data-ttu-id="9fc80-287">Para saber mais, confira [HDInsight (recuperação de desastre)](recovery-loss-azure-region.md#other-azure-platform-services).</span><span class="sxs-lookup"><span data-stu-id="9fc80-287">For more information, see [HDInsight (disaster recovery)](recovery-loss-azure-region.md#other-azure-platform-services).</span></span>

## <a name="checklists-for-local-failures"></a><span data-ttu-id="9fc80-288">Listas de verificação para falhas locais</span><span class="sxs-lookup"><span data-stu-id="9fc80-288">Checklists for local failures</span></span>

### <a name="cloud-services-checklist"></a><span data-ttu-id="9fc80-289">Lista de verificação de Serviços de Nuvem</span><span class="sxs-lookup"><span data-stu-id="9fc80-289">Cloud Services checklist</span></span>

1. <span data-ttu-id="9fc80-290">Examinar a seção Serviços de Nuvem deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-290">Review the Cloud Services section of this document.</span></span>
2. <span data-ttu-id="9fc80-291">Configure pelo menos duas instâncias para cada função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-291">Configure at least two instances for each role.</span></span>
3. <span data-ttu-id="9fc80-292">Mantenha o estado no armazenamento durável, não em instâncias de função.</span><span class="sxs-lookup"><span data-stu-id="9fc80-292">Persist state in durable storage, not on role instances.</span></span>
4. <span data-ttu-id="9fc80-293">Trate corretamente o evento StatusCheck.</span><span class="sxs-lookup"><span data-stu-id="9fc80-293">Correctly handle the StatusCheck event.</span></span>
5. <span data-ttu-id="9fc80-294">Encapsule alterações relacionadas em transações quando possível.</span><span class="sxs-lookup"><span data-stu-id="9fc80-294">Wrap related changes in transactions when possible.</span></span>
6. <span data-ttu-id="9fc80-295">Verifique se as tarefas de função de trabalho são idempotentes e reinicializáveis.</span><span class="sxs-lookup"><span data-stu-id="9fc80-295">Verify that worker role tasks are idempotent and restartable.</span></span>
7. <span data-ttu-id="9fc80-296">Continue invocando operações até que tenham êxito.</span><span class="sxs-lookup"><span data-stu-id="9fc80-296">Continue to invoke operations until they succeed.</span></span>
8. <span data-ttu-id="9fc80-297">Considere estratégias de dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="9fc80-297">Consider autoscaling strategies.</span></span>

### <a name="virtual-machines-checklist"></a><span data-ttu-id="9fc80-298">Lista de verificação de Máquinas Virtuais</span><span class="sxs-lookup"><span data-stu-id="9fc80-298">Virtual Machines checklist</span></span>

1. <span data-ttu-id="9fc80-299">Examinar a seção Máquinas Virtuais deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-299">Review the Virtual Machines section of this document.</span></span>
2. <span data-ttu-id="9fc80-300">Não use a unidade D para armazenamento persistente.</span><span class="sxs-lookup"><span data-stu-id="9fc80-300">Do not use drive D for persistent storage.</span></span>
3. <span data-ttu-id="9fc80-301">Agrupe computadores em uma camada de serviço em um conjunto de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fc80-301">Group machines in a service tier into an availability set.</span></span>
4. <span data-ttu-id="9fc80-302">Configure o balanceamento de carga e investigações opcionais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-302">Configure load balancing and optional probes.</span></span>

### <a name="storage-checklist"></a><span data-ttu-id="9fc80-303">Lista de verificação de armazenamento</span><span class="sxs-lookup"><span data-stu-id="9fc80-303">Storage checklist</span></span>

1. <span data-ttu-id="9fc80-304">Examinar a seção Armazenamento deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-304">Review the Storage section of this document.</span></span>
2. <span data-ttu-id="9fc80-305">Use várias contas de armazenamento quando dados ou largura de banda excederem as cotas.</span><span class="sxs-lookup"><span data-stu-id="9fc80-305">Use multiple storage accounts when data or bandwidth exceeds quotas.</span></span>

### <a name="sql-database-checklist"></a><span data-ttu-id="9fc80-306">Lista de verificação de Banco de Dados SQL</span><span class="sxs-lookup"><span data-stu-id="9fc80-306">SQL Database checklist</span></span>

1. <span data-ttu-id="9fc80-307">Examinar a seção Banco de Dados SQL deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-307">Review the SQL Database section of this document.</span></span>
2. <span data-ttu-id="9fc80-308">Implemente uma política de repetição para tratar de erros transitórios.</span><span class="sxs-lookup"><span data-stu-id="9fc80-308">Implement a retry policy to handle transient errors.</span></span>
3. <span data-ttu-id="9fc80-309">Use particionamento/fragmentação como uma estratégia de escalonamento horizontal.</span><span class="sxs-lookup"><span data-stu-id="9fc80-309">Use partitioning/sharding as a scale-out strategy.</span></span>

### <a name="sql-server-on-virtual-machines-checklist"></a><span data-ttu-id="9fc80-310">Lista de verificação do SQL Server em Máquinas Virtuais</span><span class="sxs-lookup"><span data-stu-id="9fc80-310">SQL Server on Virtual Machines checklist</span></span>

1. <span data-ttu-id="9fc80-311">Examinar a seção SQL Server em máquinas virtuais deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-311">Review the SQL Server on Virtual Machines section of this document.</span></span>
2. <span data-ttu-id="9fc80-312">Siga as recomendações anteriores para máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-312">Follow the previous recommendations for Virtual Machines.</span></span>
3. <span data-ttu-id="9fc80-313">Use recursos de alta disponibilidade do SQL Server, como o AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="9fc80-313">Use SQL Server high availability features, such as AlwaysOn.</span></span>

### <a name="service-bus-checklist"></a><span data-ttu-id="9fc80-314">Lista de verificação do Barramento de Serviço</span><span class="sxs-lookup"><span data-stu-id="9fc80-314">Service Bus checklist</span></span>

1. <span data-ttu-id="9fc80-315">Examinar a seção Barramento de Serviço deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-315">Review the Service Bus section of this document.</span></span>
2. <span data-ttu-id="9fc80-316">Considere a criação de uma fila durável do lado do cliente como um backup.</span><span class="sxs-lookup"><span data-stu-id="9fc80-316">Consider creating a durable client-side queue as a backup.</span></span>

### <a name="hdinsight-checklist"></a><span data-ttu-id="9fc80-317">Lista de verificação do HDInsight</span><span class="sxs-lookup"><span data-stu-id="9fc80-317">HDInsight checklist</span></span>

1. <span data-ttu-id="9fc80-318">Examinar a seção HDInsight deste documento.</span><span class="sxs-lookup"><span data-stu-id="9fc80-318">Review the HDInsight section of this document.</span></span>
2. <span data-ttu-id="9fc80-319">Nenhuma etapa adicional de disponibilidade é necessária para falhas locais.</span><span class="sxs-lookup"><span data-stu-id="9fc80-319">No additional availability steps are required for local failures.</span></span>

<!-- markdownlint-enable MD024 -->

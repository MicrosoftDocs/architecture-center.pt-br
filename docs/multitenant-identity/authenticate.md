---
title: Autenticação em aplicativos multilocatários
description: Como um aplicativo multilocatário pode autenticar usuários do Azure AD
author: MikeWasson
ms:date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: e85817626675cec4d126921c19a31a0983ecd62d
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/08/2017
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="b1d41-103">Autentique usando o Azure AD e o OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b1d41-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="b1d41-104">[Código de exemplo do ![GitHub](../_images/github.png)][sample application]</span><span class="sxs-lookup"><span data-stu-id="b1d41-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="b1d41-105">O aplicativo Surveys usa o protocolo OIDC (OpenID Connect) para autenticar usuários com o Azure AD (Azure Active Directory).</span><span class="sxs-lookup"><span data-stu-id="b1d41-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="b1d41-106">O aplicativo de Pesquisas usa o ASP.NET Core, que tem o middleware interno para OIDC.</span><span class="sxs-lookup"><span data-stu-id="b1d41-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="b1d41-107">O diagrama a seguir mostra o que acontece quando o usuário faz logon, em um alto nível.</span><span class="sxs-lookup"><span data-stu-id="b1d41-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Fluxo de autenticação](./images/auth-flow.png)

1. <span data-ttu-id="b1d41-109">O usuário clica no botão "entrar" no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="b1d41-110">Essa ação é realizada por um controlador MVC.</span><span class="sxs-lookup"><span data-stu-id="b1d41-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="b1d41-111">O controlador MVC retorna uma ação **ChallengeResult** .</span><span class="sxs-lookup"><span data-stu-id="b1d41-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="b1d41-112">O middleware intercepta o **ChallengeResult** e cria uma resposta 302, que redireciona o usuário para a página de entrada do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b1d41-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="b1d41-113">O usuário autentica no Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b1d41-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="b1d41-114">O Azure AD envia um token de ID para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="b1d41-115">O middleware valida o token de ID.</span><span class="sxs-lookup"><span data-stu-id="b1d41-115">The middleware validates the ID token.</span></span> <span data-ttu-id="b1d41-116">Neste ponto, o usuário está autenticado dentro do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="b1d41-117">O middleware redireciona o usuário de volta para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="b1d41-118">Registrar o aplicativo no Azure AD</span><span class="sxs-lookup"><span data-stu-id="b1d41-118">Register the app with Azure AD</span></span>
<span data-ttu-id="b1d41-119">Para habilitar o OpenID Connect, o provedor de SaaS registra o aplicativo dentro de seu próprio locatário do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b1d41-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="b1d41-120">Para registrar o aplicativo, siga as etapas em [Integrar aplicativos ao Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/) na seção [Adicionar um aplicativo](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="b1d41-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="b1d41-121">Consulte [Executar o aplicativo Surveys](./run-the-app.md) para as etapas específicas para o aplicativo Surveys.</span><span class="sxs-lookup"><span data-stu-id="b1d41-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="b1d41-122">Observe o seguinte:</span><span class="sxs-lookup"><span data-stu-id="b1d41-122">Note the following:</span></span>

- <span data-ttu-id="b1d41-123">Para um aplicativo multilocatário, você deve configurar a opção multilocatário explicitamente.</span><span class="sxs-lookup"><span data-stu-id="b1d41-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="b1d41-124">Isso habilita outras organizações a acessar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="b1d41-125">A URL de resposta é a URL em que o Azure AD enviará respostas do OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="b1d41-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="b1d41-126">Ao usar o ASP.NET Core, isso deve corresponder ao caminho que você configura no middleware de autenticação (consulte a próxima seção),</span><span class="sxs-lookup"><span data-stu-id="b1d41-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section),</span></span> 

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="b1d41-127">Configurar o middleware de autenticação</span><span class="sxs-lookup"><span data-stu-id="b1d41-127">Configure the auth middleware</span></span>
<span data-ttu-id="b1d41-128">Esta seção descreve como configurar o middleware de autenticação no ASP.NET Core para autenticação multilocatário com OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="b1d41-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="b1d41-129">Em sua [classe de inicialização](/aspnet/core/fundamentals/startup), adicione o middleware OpenID Connect:</span><span class="sxs-lookup"><span data-stu-id="b1d41-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="b1d41-130">Observe que algumas das configurações são obtidas de opções de configuração no tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="b1d41-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="b1d41-131">Estes são os significados das opções de middleware:</span><span class="sxs-lookup"><span data-stu-id="b1d41-131">Here's what the middleware options mean:</span></span>

* <span data-ttu-id="b1d41-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-132">**ClientId**.</span></span> <span data-ttu-id="b1d41-133">ID do cliente do aplicativo, que você obteve ao registrar o aplicativo no Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b1d41-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
* <span data-ttu-id="b1d41-134">**Autoridade**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-134">**Authority**.</span></span> <span data-ttu-id="b1d41-135">No caso do aplicativo de multilocatário, defina como `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="b1d41-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="b1d41-136">Essa é a URL do ponto de extremidade comum do Azure AD e ela permite que usuários de qualquer locatário do Azure AD entrem.</span><span class="sxs-lookup"><span data-stu-id="b1d41-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="b1d41-137">Para saber mais sobre o ponto de extremidade comum, confira [esta postagem do blog](http://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="b1d41-137">For more information about the common endpoint, see [this blog post](http://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
* <span data-ttu-id="b1d41-138">Em **TokenValidationParameters**, defina **ValidateIssuer** como false.</span><span class="sxs-lookup"><span data-stu-id="b1d41-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="b1d41-139">Isso significa que o aplicativo será responsável pela validação do valor do emissor no token de ID.</span><span class="sxs-lookup"><span data-stu-id="b1d41-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="b1d41-140">(O middleware ainda valida o token em si.) Para obter mais informações sobre a validação do emissor, consulte [Validação do emissor](claims.md#issuer-validation).</span><span class="sxs-lookup"><span data-stu-id="b1d41-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
* <span data-ttu-id="b1d41-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="b1d41-142">Especifique uma URL para redirecionar os usuários após a saída. Essa deve ser uma página que permite que solicitações anônimas &mdash; normalmente a página inicial.</span><span class="sxs-lookup"><span data-stu-id="b1d41-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
* <span data-ttu-id="b1d41-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-143">**SignInScheme**.</span></span> <span data-ttu-id="b1d41-144">Defina isso como `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="b1d41-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="b1d41-145">Essa configuração significa que, após a autenticação do usuário, as declarações de usuário são armazenadas localmente em um cookie.</span><span class="sxs-lookup"><span data-stu-id="b1d41-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="b1d41-146">Esse cookie diz como o usuário permanece conectado durante a sessão do navegador.</span><span class="sxs-lookup"><span data-stu-id="b1d41-146">This cookie is how the user stays logged in during the browser session.</span></span>
* <span data-ttu-id="b1d41-147">**Eventos.**</span><span class="sxs-lookup"><span data-stu-id="b1d41-147">**Events.**</span></span> <span data-ttu-id="b1d41-148">Retornos de chamada do evento; confira [Eventos de autenticação](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="b1d41-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="b1d41-149">Além disso, adicione o middleware de Autenticação de Cookie ao pipeline.</span><span class="sxs-lookup"><span data-stu-id="b1d41-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="b1d41-150">Este middleware é responsável por gravar as declarações de usuário em um cookie e, em seguida, ler o cookie durante carregamentos subsequentes da página.</span><span class="sxs-lookup"><span data-stu-id="b1d41-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="b1d41-151">Iniciar o fluxo de autenticação</span><span class="sxs-lookup"><span data-stu-id="b1d41-151">Initiate the authentication flow</span></span>
<span data-ttu-id="b1d41-152">Para iniciar o fluxo de autenticação no ASP.NET MVC, retorne um **ChallengeResult** do controlador:</span><span class="sxs-lookup"><span data-stu-id="b1d41-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="b1d41-153">Isso faz com que o middleware retorne uma resposta 302 (Found) que redireciona para o ponto de extremidade de autenticação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="b1d41-154">Sessões de logon do usuário</span><span class="sxs-lookup"><span data-stu-id="b1d41-154">User login sessions</span></span>
<span data-ttu-id="b1d41-155">Conforme mencionado, quando o usuário entra pela primeira vez, o middleware de Autenticação de Cookie grava as declarações do usuário em um cookie.</span><span class="sxs-lookup"><span data-stu-id="b1d41-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="b1d41-156">Depois disso, as solicitações HTTP são autenticadas por meio da leitura do cookie.</span><span class="sxs-lookup"><span data-stu-id="b1d41-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="b1d41-157">Por padrão, o middleware de cookie grava um [cookie de sessão][session-cookie], que é excluído quando o usuário fecha o navegador.</span><span class="sxs-lookup"><span data-stu-id="b1d41-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="b1d41-158">Na próxima vez que o usuário visitar o site, será necessário entrar novamente.</span><span class="sxs-lookup"><span data-stu-id="b1d41-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="b1d41-159">No entanto, se você definir **IsPersistent** como verdadeiro em **ChallengeResult**, o middleware gravará um cookie persistente para que o usuário permaneça conectado depois de fechar o navegador.</span><span class="sxs-lookup"><span data-stu-id="b1d41-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="b1d41-160">Você pode configurar a expiração do cookie; consulte [Controlando opções de cookie][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="b1d41-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="b1d41-161">Cookies persistentes são mais convenientes para o usuário, mas podem ser inadequados para alguns aplicativos (por exemplo, um aplicativo bancário) nos quais você deseja que o usuário entre cada vez que acessar.</span><span class="sxs-lookup"><span data-stu-id="b1d41-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="b1d41-162">Sobre o middleware OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b1d41-162">About the OpenID Connect middleware</span></span>
<span data-ttu-id="b1d41-163">O middleware OpenID Connect no ASP.NET oculta a maioria dos detalhes do protocolo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="b1d41-164">Esta seção contém algumas observações sobre a implementação que podem ser úteis para entender o fluxo do protocolo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="b1d41-165">Primeiro, vamos examinar o fluxo de autenticação em termos de ASP.NET (ignorando os detalhes do fluxo de protocolo OIDC entre o aplicativo e o Azure AD).</span><span class="sxs-lookup"><span data-stu-id="b1d41-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="b1d41-166">O diagrama a seguir mostra o processo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-166">The following diagram shows the process.</span></span>

![Fluxo de entrada](./images/sign-in-flow.png)

<span data-ttu-id="b1d41-168">Neste diagrama, há dois controladores MVC.</span><span class="sxs-lookup"><span data-stu-id="b1d41-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="b1d41-169">O Controlador de conta lida com solicitações de entrada, e o Controlador inicial atende à home page.</span><span class="sxs-lookup"><span data-stu-id="b1d41-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="b1d41-170">Este é o processo de autenticação:</span><span class="sxs-lookup"><span data-stu-id="b1d41-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="b1d41-171">O usuário clica no botão "Entrar", e o navegador envia uma solicitação GET.</span><span class="sxs-lookup"><span data-stu-id="b1d41-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="b1d41-172">Por exemplo: `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="b1d41-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="b1d41-173">O Controlador de conta retorna um `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="b1d41-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="b1d41-174">O middleware OIDC retorna uma resposta HTTP 302, redirecionando para o Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b1d41-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="b1d41-175">O navegador envia a solicitação de autenticação ao Azure AD</span><span class="sxs-lookup"><span data-stu-id="b1d41-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="b1d41-176">O usuário entra no Azure AD, e o Azure AD envia de volta uma resposta de autenticação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="b1d41-177">O middleware OIDC cria uma entidade de declarações e a transmite para o middleware de autenticação de Cookie.</span><span class="sxs-lookup"><span data-stu-id="b1d41-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="b1d41-178">O middleware do cookie serializa a entidade das declarações e define um cookie.</span><span class="sxs-lookup"><span data-stu-id="b1d41-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="b1d41-179">O middleware OIDC redireciona para a URL de retorno de chamada do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="b1d41-180">O navegador segue o redirecionamento, enviando o cookie na solicitação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="b1d41-181">O middleware do cookie desserializa o cookie para uma entidade de declarações e define `HttpContext.User` igual à entidade de declarações.</span><span class="sxs-lookup"><span data-stu-id="b1d41-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="b1d41-182">A solicitação é encaminhada para um controlador MVC.</span><span class="sxs-lookup"><span data-stu-id="b1d41-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="b1d41-183">Tíquete de autenticação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-183">Authentication ticket</span></span>
<span data-ttu-id="b1d41-184">Se a autenticação for bem-sucedida, o middleware OIDC criará um tíquete de autenticação contendo uma entidade de declarações que armazena as declarações do usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="b1d41-185">Você pode acessar o tíquete dentro do evento **AuthenticationValidated** ou **TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="b1d41-186">Até que todo o fluxo de autenticação esteja concluído, `HttpContext.User` ainda mantém uma entidade de segurança anônima, **não** o usuário autenticado.</span><span class="sxs-lookup"><span data-stu-id="b1d41-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="b1d41-187">A entidade anônima tem uma coleção de declarações vazias.</span><span class="sxs-lookup"><span data-stu-id="b1d41-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="b1d41-188">Após a conclusão da autenticação e o redirecionamentos do aplicativo, o cookie de middleware desserializa o cookie de autenticação e define `HttpContext.User` como uma entidade de declarações que representa o usuário autenticado.</span><span class="sxs-lookup"><span data-stu-id="b1d41-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>
> 
> 

### <a name="authentication-events"></a><span data-ttu-id="b1d41-189">Eventos de autenticação</span><span class="sxs-lookup"><span data-stu-id="b1d41-189">Authentication events</span></span>
<span data-ttu-id="b1d41-190">Durante o processo de autenticação, o middleware OpenID Connect gera uma série de eventos:</span><span class="sxs-lookup"><span data-stu-id="b1d41-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

* <span data-ttu-id="b1d41-191">**RedirectToIdentityProvider**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="b1d41-192">É chamado momentos antes de o middleware redirecionar para o ponto de extremidade de autenticação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="b1d41-193">Você pode usar esse evento para modificar a URL de redirecionamento; por exemplo, para adicionar parâmetros de solicitação.</span><span class="sxs-lookup"><span data-stu-id="b1d41-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="b1d41-194">Confira [Adicionar a solicitação de consentimento do administrador](signup.md#adding-the-admin-consent-prompt) para ter um exemplo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
* <span data-ttu-id="b1d41-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="b1d41-196">Chamado com o código de autorização.</span><span class="sxs-lookup"><span data-stu-id="b1d41-196">Called with the authorization code.</span></span>
* <span data-ttu-id="b1d41-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="b1d41-198">Chamado depois que o middleware obtém um token de acesso de IDP, mas antes de validá-lo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="b1d41-199">Aplica-se apenas ao fluxo do código de autorização</span><span class="sxs-lookup"><span data-stu-id="b1d41-199">Applies only to authorization code flow.</span></span>
* <span data-ttu-id="b1d41-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-200">**TokenValidated**.</span></span> <span data-ttu-id="b1d41-201">Chamado após o middleware validar o token de ID.</span><span class="sxs-lookup"><span data-stu-id="b1d41-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="b1d41-202">Neste ponto, o aplicativo tem um conjunto de declarações validadas sobre o usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="b1d41-203">Você pode usar esse evento para executar uma validação adicional nas declarações ou para transformar as declarações.</span><span class="sxs-lookup"><span data-stu-id="b1d41-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="b1d41-204">Confira [Trabalhar com declarações](claims.md).</span><span class="sxs-lookup"><span data-stu-id="b1d41-204">See [Working with claims](claims.md).</span></span>
* <span data-ttu-id="b1d41-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-205">**UserInformationReceived**.</span></span> <span data-ttu-id="b1d41-206">Chamado se o middleware obtém o perfil de usuário do ponto de extremidade de informações do usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="b1d41-207">Aplica-se somente ao fluxo de código de autorização e somente quando `GetClaimsFromUserInfoEndpoint = true` nas opções do middleware.</span><span class="sxs-lookup"><span data-stu-id="b1d41-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
* <span data-ttu-id="b1d41-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-208">**TicketReceived**.</span></span> <span data-ttu-id="b1d41-209">Chamado quando a autenticação é concluída.</span><span class="sxs-lookup"><span data-stu-id="b1d41-209">Called when authentication is completed.</span></span> <span data-ttu-id="b1d41-210">Esse é o último evento, supondo que a autenticação tenha êxito.</span><span class="sxs-lookup"><span data-stu-id="b1d41-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="b1d41-211">Após o tratamento desse evento, o usuário estará conectado ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-211">After this event is handled, the user is signed into the app.</span></span>
* <span data-ttu-id="b1d41-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="b1d41-213">Chamado se a autenticação falhar.</span><span class="sxs-lookup"><span data-stu-id="b1d41-213">Called if authentication fails.</span></span> <span data-ttu-id="b1d41-214">Use este evento para lidar com falhas de autenticação &mdash; por exemplo, ao redirecionar para uma página de erro.</span><span class="sxs-lookup"><span data-stu-id="b1d41-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="b1d41-215">Para fornecer retornos de chamada para esses eventos, defina a opção **Eventos** no middleware.</span><span class="sxs-lookup"><span data-stu-id="b1d41-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="b1d41-216">Há duas maneiras diferentes de declarar os manipuladores de eventos: embutidos com lambdas ou em uma classe derivada de **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="b1d41-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="b1d41-217">A segunda abordagem é recomendada se os seus retornos de chamada do evento tiverem uma quantidade consideração de lógica, para que eles não baguncem sua classe de inicialização.</span><span class="sxs-lookup"><span data-stu-id="b1d41-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="b1d41-218">Nossa implementação de referência usa essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="b1d41-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="b1d41-219">Pontos de extremidade do OpenId Connect</span><span class="sxs-lookup"><span data-stu-id="b1d41-219">OpenID connect endpoints</span></span>
<span data-ttu-id="b1d41-220">O Azure AD oferece suporte ao [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), no qual o IDP (provedor de identidade) retorna um documento de metadados JSON de um [ponto de extremidade conhecido](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="b1d41-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="b1d41-221">O documento de metadados contém informações como as seguintes:</span><span class="sxs-lookup"><span data-stu-id="b1d41-221">The metadata document contains information such as:</span></span>

* <span data-ttu-id="b1d41-222">A URL do ponto de extremidade de autorização.</span><span class="sxs-lookup"><span data-stu-id="b1d41-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="b1d41-223">Para onde o aplicativo é redirecionado a fim de autenticar o usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-223">This is where the app redirects to authenticate the user.</span></span>
* <span data-ttu-id="b1d41-224">A URL do ponto de extremidade "encerrar sessão", onde o aplicativo acessar para efetuar logoff do usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
* <span data-ttu-id="b1d41-225">A URL para obter as chaves de assinatura, usadas pelo cliente para validar os tokens OIDC obtidos com o IDP.</span><span class="sxs-lookup"><span data-stu-id="b1d41-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="b1d41-226">Por padrão, o middleware OIDC sabe como buscar esses metadados.</span><span class="sxs-lookup"><span data-stu-id="b1d41-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="b1d41-227">Defina a opção **Authority** no middleware, e o middleware construirá a URL dos metadados.</span><span class="sxs-lookup"><span data-stu-id="b1d41-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="b1d41-228">(Você pode substituir a URL dos metadados, definindo a opção **MetadataAddress** .)</span><span class="sxs-lookup"><span data-stu-id="b1d41-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="b1d41-229">Fluxos do OpenId Connect</span><span class="sxs-lookup"><span data-stu-id="b1d41-229">OpenID connect flows</span></span>
<span data-ttu-id="b1d41-230">Por padrão, o middleware OIDC usa um fluxo híbrido com o modo de resposta de postagem de formulário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

* <span data-ttu-id="b1d41-231">*Fluxo híbrido* significa que o cliente pode obter um token de ID e um código de autorização na mesma viagem de ida e volta ao servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="b1d41-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
* <span data-ttu-id="b1d41-232">*Modo de resposta de postagem de formulário* significa que o servidor de autorização usa uma solicitação HTTP POST para enviar o código de autorização e o token de ID ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1d41-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="b1d41-233">Os valores são form-urlencoded (tipo de conteúdo = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="b1d41-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="b1d41-234">Quando o middleware OIDC redireciona para o ponto de extremidade de autorização, a URL de redirecionamento inclui todos os parâmetros da cadeia de caracteres de consulta necessários para o OIDC.</span><span class="sxs-lookup"><span data-stu-id="b1d41-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="b1d41-235">Para o fluxo híbrido:</span><span class="sxs-lookup"><span data-stu-id="b1d41-235">For hybrid flow:</span></span>

* <span data-ttu-id="b1d41-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="b1d41-236">client_id.</span></span> <span data-ttu-id="b1d41-237">Esse valor é definido na opção **ClientId**</span><span class="sxs-lookup"><span data-stu-id="b1d41-237">This value is set in the **ClientId** option</span></span>
* <span data-ttu-id="b1d41-238">escopo = "openid profile", significando que é uma solicitação OIDC e que queremos o perfil do usuário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
* <span data-ttu-id="b1d41-239">response_type  = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="b1d41-239">response_type  = "code id_token".</span></span> <span data-ttu-id="b1d41-240">Isso especifica o fluxo híbrido.</span><span class="sxs-lookup"><span data-stu-id="b1d41-240">This specifies hybrid flow.</span></span>
* <span data-ttu-id="b1d41-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="b1d41-241">response_mode = "form_post".</span></span> <span data-ttu-id="b1d41-242">Isso especifica a resposta de postagem do formulário.</span><span class="sxs-lookup"><span data-stu-id="b1d41-242">This specifies form post response.</span></span>

<span data-ttu-id="b1d41-243">Para especificar um fluxo diferente, defina a propriedade **ResponseType** nas opções.</span><span class="sxs-lookup"><span data-stu-id="b1d41-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="b1d41-244">Por exemplo: </span><span class="sxs-lookup"><span data-stu-id="b1d41-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="b1d41-245">[**Avançar**][claims]</span><span class="sxs-lookup"><span data-stu-id="b1d41-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance

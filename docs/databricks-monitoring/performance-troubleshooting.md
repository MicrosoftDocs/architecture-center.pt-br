---
title: Solução de problemas para o Azure Databricks usando o Azure Monitor de desempenho
titleSuffix: ''
description: Use painéis do Grafana para solucionar problemas de desempenho no Azure Databricks
author: petertaylor9999
ms.date: 04/02/2019
ms.topic: ''
ms.service: ''
ms.subservice: ''
ms.openlocfilehash: 49ec63d0c45ab388ca83b3ab0562428327539619
ms.sourcegitcommit: 1a3cc91530d56731029ea091db1f15d41ac056af
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/03/2019
ms.locfileid: "58887921"
---
# <a name="troubleshoot-performance-bottlenecks-in-azure-databricks"></a><span data-ttu-id="786be-103">Solucionar problemas de gargalos de desempenho no Azure Databricks</span><span class="sxs-lookup"><span data-stu-id="786be-103">Troubleshoot performance bottlenecks in Azure Databricks</span></span>

<span data-ttu-id="786be-104">Este artigo descreve como usar os painéis de monitoramento para localizar gargalos de desempenho em trabalhos do Spark no Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="786be-104">This article describes how to use monitoring dashboards to find performance bottlenecks in Spark jobs on Azure Databricks.</span></span>

<span data-ttu-id="786be-105">[O Azure Databricks](/azure/azure-databricks/) é um [Apache Spark](https://spark.apache.org/)– com base em serviço de análise que torna mais fácil desenvolver e implantar a análise de big data rapidamente.</span><span class="sxs-lookup"><span data-stu-id="786be-105">[Azure Databricks](/azure/azure-databricks/) is an [Apache Spark](https://spark.apache.org/)–based analytics service that makes it easy to rapidly develop and deploy big data analytics.</span></span> <span data-ttu-id="786be-106">Monitorar e solucionar problemas de desempenho são fundamental durante a operação de cargas de trabalho de produção do Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="786be-106">Monitoring and troubleshooting performance issues is a critical when operating production Azure Databricks workloads.</span></span> <span data-ttu-id="786be-107">Para identificar problemas de desempenho comuns, é útil usar visualizações de monitoramento com base em dados de telemetria.</span><span class="sxs-lookup"><span data-stu-id="786be-107">To identify common performance issues, it's helpful to use monitoring visualizations based on telemetry data.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="786be-108">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="786be-108">Prerequisites</span></span>

<span data-ttu-id="786be-109">Para configurar os painéis do Grafana mostrados neste artigo:</span><span class="sxs-lookup"><span data-stu-id="786be-109">To set up the Grafana dashboards shown in this article:</span></span>

- <span data-ttu-id="786be-110">Configure o cluster do Databricks para enviar telemetria para um espaço de trabalho do Log Analytics, usando a biblioteca de monitoramento do Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="786be-110">Configure your Databricks cluster to send telemetry to a Log Analytics workspace, using the Azure Databricks Monitoring Library.</span></span> <span data-ttu-id="786be-111">Para obter detalhes, consulte [configurar o Azure Databricks para enviar métricas para o Azure Monitor](./configure-cluster.md).</span><span class="sxs-lookup"><span data-stu-id="786be-111">For details, see [Configure Azure Databricks to send metrics to Azure Monitor](./configure-cluster.md).</span></span>

- <span data-ttu-id="786be-112">Implante o Grafana em uma máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="786be-112">Deploy Grafana in a virtual machine.</span></span> <span data-ttu-id="786be-113">Ver [usar painéis para visualizar as métricas do Azure Databricks](./dashboards.md).</span><span class="sxs-lookup"><span data-stu-id="786be-113">See [Use dashboards to visualize Azure Databricks metrics](./dashboards.md).</span></span>

<span data-ttu-id="786be-114">O painel do Grafana que é implantado inclui um conjunto de visualizações de série temporal.</span><span class="sxs-lookup"><span data-stu-id="786be-114">The Grafana dashboard that is deployed includes a set of time-series visualizations.</span></span> <span data-ttu-id="786be-115">Cada gráfico é um gráfico de série temporal de métricas relacionadas a um trabalho do Apache Spark, os estágios do trabalho e tarefas que compõem cada estágio.</span><span class="sxs-lookup"><span data-stu-id="786be-115">Each graph is time-series plot of metrics related to an Apache Spark job, the stages of the job, and tasks that make up each stage.</span></span>

## <a name="azure-databricks-performance-overview"></a><span data-ttu-id="786be-116">Visão geral de desempenho do Azure Databricks</span><span class="sxs-lookup"><span data-stu-id="786be-116">Azure Databricks performance overview</span></span>

<span data-ttu-id="786be-117">O Azure Databricks se baseia no Apache Spark, um sistema genérico de computação distribuído.</span><span class="sxs-lookup"><span data-stu-id="786be-117">Azure Databricks is based on Apache Spark, a general-purpose distributed computing system.</span></span> <span data-ttu-id="786be-118">Código do aplicativo, conhecido como uma **trabalho**, é executado em um cluster do Apache Spark, coordenado pelo Gerenciador de cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-118">Application code, known as a **job**, executes on an Apache Spark cluster, coordinated by the cluster manager.</span></span> <span data-ttu-id="786be-119">Em geral, um trabalho é a unidade de nível mais alto de computação.</span><span class="sxs-lookup"><span data-stu-id="786be-119">In general, a job is the highest-level unit of computation.</span></span> <span data-ttu-id="786be-120">Um trabalho representa a concluir a operação executada pelo aplicativo Spark.</span><span class="sxs-lookup"><span data-stu-id="786be-120">A job represents the complete operation performed by the Spark application.</span></span> <span data-ttu-id="786be-121">Uma operação típica inclui a leitura de uma fonte de dados, Aplicando transformações de dados e gravar os resultados para o armazenamento ou outro destino.</span><span class="sxs-lookup"><span data-stu-id="786be-121">A typical operation includes reading data from a source, applying data transformations, and writing the results to storage or another destination.</span></span>

<span data-ttu-id="786be-122">Trabalhos são divididos em **estágios**.</span><span class="sxs-lookup"><span data-stu-id="786be-122">Jobs are broken down into **stages**.</span></span> <span data-ttu-id="786be-123">O trabalho avança pelas fases sequencialmente, o que significa que estágios posteriores devem aguardar estágios anteriores concluir.</span><span class="sxs-lookup"><span data-stu-id="786be-123">The job advances through the stages sequentially, which means that later stages must wait for earlier stages to complete.</span></span> <span data-ttu-id="786be-124">Estágios contêm grupos de idênticos **tarefas** que podem ser executadas em paralelo em vários nós do cluster Spark.</span><span class="sxs-lookup"><span data-stu-id="786be-124">Stages contain groups of identical **tasks** that can be executed in parallel on multiple nodes of the Spark cluster.</span></span> <span data-ttu-id="786be-125">Tarefas são a unidade mais granular de execução está ocorrendo em um subconjunto dos dados.</span><span class="sxs-lookup"><span data-stu-id="786be-125">Tasks are the most granular unit of execution taking place on a subset of the data.</span></span>

<span data-ttu-id="786be-126">As seções a seguir descrevem algumas visualizações de painel que são úteis para solucionar problemas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="786be-126">The next sections describe some dashboard visualizations that are useful for performance troubleshooting.</span></span>

## <a name="job-and-stage-latency"></a><span data-ttu-id="786be-127">Latência de estágio e de trabalho</span><span class="sxs-lookup"><span data-stu-id="786be-127">Job and stage latency</span></span>

<span data-ttu-id="786be-128">Latência do trabalho é a duração da execução de um trabalho de quando ele é iniciado até que ela seja concluída.</span><span class="sxs-lookup"><span data-stu-id="786be-128">Job latency is the duration of a job execution from when it starts until it completes.</span></span> <span data-ttu-id="786be-129">Ele é mostrado como percentuais de execução de um trabalho por ID do aplicativo e o cluster, para permitir que a visualização de exceções.</span><span class="sxs-lookup"><span data-stu-id="786be-129">It is shown as percentiles of a job execution per cluster and application ID, to allow the visualization of outliers.</span></span> <span data-ttu-id="786be-130">O gráfico a seguir mostra um histórico de trabalho em que o 90 º percentil atingido 50 segundos, mesmo que o 50 º percentil foi consistentemente cerca de 10 segundos.</span><span class="sxs-lookup"><span data-stu-id="786be-130">The following graph shows a job history where the 90th percentile reached 50 seconds, even though the 50th percentile was consistently around 10 seconds.</span></span>

![Gráfico mostrando a latência do trabalho](./_images/grafana-job-latency.png)

<span data-ttu-id="786be-132">Investigar a execução do trabalho ao cluster e aplicativo, procura picos na latência.</span><span class="sxs-lookup"><span data-stu-id="786be-132">Investigate job execution by cluster and application, looking for spikes in latency.</span></span> <span data-ttu-id="786be-133">Depois de clusters e aplicativos com alta latência são identificados, passe para investigar a latência de estágio.</span><span class="sxs-lookup"><span data-stu-id="786be-133">Once clusters and applications with high latency are identified, move on to investigate stage latency.</span></span>

<span data-ttu-id="786be-134">Latência de estágio também é mostrada como percentuais para permitir que a visualização de exceções.</span><span class="sxs-lookup"><span data-stu-id="786be-134">Stage latency is also shown as percentiles to allow the visualization of outliers.</span></span> <span data-ttu-id="786be-135">Latência de estágio é dividida por cluster, o aplicativo e o nome do estágio.</span><span class="sxs-lookup"><span data-stu-id="786be-135">Stage latency is broken out by cluster, application, and stage name.</span></span> <span data-ttu-id="786be-136">Identificar picos na latência de tarefa no gráfico para determinar quais tarefas estão mantendo volta a conclusão do estágio.</span><span class="sxs-lookup"><span data-stu-id="786be-136">Identify spikes in task latency in the graph to determine which tasks are holding back completion of the stage.</span></span>

![Gráfico mostrando a latência de estágio](./_images/grafana-stage-latency.png)

<span data-ttu-id="786be-138">O gráfico de taxa de transferência de cluster mostra o número de trabalhos, estágios e as tarefas concluídas por minuto.</span><span class="sxs-lookup"><span data-stu-id="786be-138">The cluster throughput graph shows the number of jobs, stages, and tasks completed per minute.</span></span> <span data-ttu-id="786be-139">Isso ajuda você a entender a carga de trabalho em termos de número relativo de etapas e tarefas por trabalho.</span><span class="sxs-lookup"><span data-stu-id="786be-139">This helps you to understand the workload in terms of the relative number of stages and tasks per job.</span></span> <span data-ttu-id="786be-140">Aqui você pode ver que o número de trabalhos por minuto de intervalos entre 2 e 6, enquanto o número de estágios é cerca de 12 &ndash; 24 por minuto.</span><span class="sxs-lookup"><span data-stu-id="786be-140">Here you can see that the number of jobs per minute ranges between 2 and 6, while the number of stages is about 12 &ndash; 24 per minute.</span></span>

![Taxa de transferência do grafo mostrando cluster](./_images/grafana-cluster-throughput.png)

## <a name="sum-of-task-execution-latency"></a><span data-ttu-id="786be-142">Soma de latência de execução de tarefa</span><span class="sxs-lookup"><span data-stu-id="786be-142">Sum of task execution latency</span></span>

<span data-ttu-id="786be-143">Esta visualização mostra a soma da latência de execução de tarefa por execução em um cluster de host.</span><span class="sxs-lookup"><span data-stu-id="786be-143">This visualization shows the sum of task execution latency per host running on a cluster.</span></span> <span data-ttu-id="786be-144">Use este gráfico para detectar as tarefas executadas lentamente devido à lentidão host em um cluster ou um misallocation de tarefas por executor.</span><span class="sxs-lookup"><span data-stu-id="786be-144">Use this graph to detect tasks that run slowly due to the host slowing down on a cluster, or a misallocation of tasks per executor.</span></span> <span data-ttu-id="786be-145">No gráfico a seguir, a maioria dos hosts tem uma soma de cerca de 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="786be-145">In the following graph, most of the hosts have a sum of about 30 seconds.</span></span> <span data-ttu-id="786be-146">No entanto, dois dos hosts têm somas que passe o mouse cerca de 10 minutos.</span><span class="sxs-lookup"><span data-stu-id="786be-146">However, two of the hosts have sums that hover around 10 minutes.</span></span> <span data-ttu-id="786be-147">Os hosts estão muito lentos ou o número de tarefas por executor é misallocated.</span><span class="sxs-lookup"><span data-stu-id="786be-147">Either the hosts are running slow or the number of tasks per executor is misallocated.</span></span>

![Soma do grafo mostrando da execução de tarefa por host](./_images/grafana-sum-task-exec.png)

<span data-ttu-id="786be-149">O número de tarefas por executor mostra que dois executores são atribuídos a um número desproporcional de tarefas, causando um afunilamento.</span><span class="sxs-lookup"><span data-stu-id="786be-149">The number of tasks per executor shows that two executors are assigned a disproportionate number of tasks, causing a bottleneck.</span></span>

![Gráfico mostrando tarefas por executor](./_images/grafana-tasks-per-exec.png)

## <a name="task-metrics-per-stage"></a><span data-ttu-id="786be-151">Métricas de tarefa por estágio</span><span class="sxs-lookup"><span data-stu-id="786be-151">Task metrics per stage</span></span>

<span data-ttu-id="786be-152">A visualização de métricas de tarefa fornece a análise de custo para uma execução de tarefa.</span><span class="sxs-lookup"><span data-stu-id="786be-152">The task metrics visualization gives the cost breakdown for a task execution.</span></span> <span data-ttu-id="786be-153">Você pode usá-lo consulte o tempo relativo gasto em tarefas, como a serialização e desserialização.</span><span class="sxs-lookup"><span data-stu-id="786be-153">You can use it see the relative time spent on tasks such as serialization and deserialization.</span></span> <span data-ttu-id="786be-154">Esses dados poderá mostrar oportunidades para otimizar &mdash; por exemplo, usando [difundir variáveis](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) para evitar o envio de dados.</span><span class="sxs-lookup"><span data-stu-id="786be-154">This data might show opportunities to optimize &mdash; for example, by using [broadcast variables](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) to avoid shipping data.</span></span> <span data-ttu-id="786be-155">As métricas de tarefa também mostram o tamanho dos dados em ordem aleatória para uma tarefa, e a ordem aleatória de leitura e gravação vezes.</span><span class="sxs-lookup"><span data-stu-id="786be-155">The task metrics also show the shuffle data size for a task, and the shuffle read and write times.</span></span> <span data-ttu-id="786be-156">Se esses valores forem altos, isso significa que muitos dados são movidos pela rede.</span><span class="sxs-lookup"><span data-stu-id="786be-156">If these values are high, it means that a lot of data is moving across the network.</span></span>

<span data-ttu-id="786be-157">Outra métrica de tarefa é o atraso de Agendador, que mede o quanto tempo demora para agendar uma tarefa.</span><span class="sxs-lookup"><span data-stu-id="786be-157">Another task metric is the scheduler delay, which measures how long it takes to schedule a task.</span></span> <span data-ttu-id="786be-158">Idealmente, esse valor deve ser baixo em comparação com o tempo de computação de executor, que é o tempo gasto na execução, na verdade, a tarefa.</span><span class="sxs-lookup"><span data-stu-id="786be-158">Ideally, this value should be low compared to the executor compute time, which is the time spent actually executing the task.</span></span>

<span data-ttu-id="786be-159">O gráfico a seguir mostra um tempo de espera do Agendador (3.7 s) que exceda o tempo de computação do executor (1.1 s).</span><span class="sxs-lookup"><span data-stu-id="786be-159">The following graph shows a scheduler delay time (3.7 s) that exceeds the executor compute time (1.1 s).</span></span> <span data-ttu-id="786be-160">Isso significa que mais tempo é gasto aguardando tarefas sejam agendadas que fazendo o trabalho real.</span><span class="sxs-lookup"><span data-stu-id="786be-160">That means more time is spent waiting for tasks to be scheduled than doing the actual work.</span></span>

![Gráfico que mostra as métricas de tarefa por estágio](./_images/grafana-metrics-per-stage.png)

<span data-ttu-id="786be-162">Nesse caso, o problema foi causado por ter muitas partições, o que causou muita sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="786be-162">In this case, the problem was caused by having too many partitions, which caused a lot of overhead.</span></span> <span data-ttu-id="786be-163">Reduzindo o número de partições reduzido o tempo de atraso do Agendador.</span><span class="sxs-lookup"><span data-stu-id="786be-163">Reducing the number of partitions lowered the scheduler delay time.</span></span> <span data-ttu-id="786be-164">O gráfico a seguir mostra que a maior parte do tempo gasto na execução da tarefa.</span><span class="sxs-lookup"><span data-stu-id="786be-164">The next graph shows that most of the time is spent executing the task.</span></span>

![Gráfico que mostra as métricas de tarefa por estágio](./_images/grafana-metrics-per-stage2.png)

## <a name="streaming-throughput-and-latency"></a><span data-ttu-id="786be-166">Streaming de taxa de transferência e latência</span><span class="sxs-lookup"><span data-stu-id="786be-166">Streaming throughput and latency</span></span>

<span data-ttu-id="786be-167">Streaming de taxa de transferência está diretamente relacionado ao fluxo estruturado.</span><span class="sxs-lookup"><span data-stu-id="786be-167">Streaming throughput is directly related to structured streaming.</span></span> <span data-ttu-id="786be-168">Há duas métricas importantes associadas com streaming de taxa de transferência: Linhas de entrada por segundo e processadas linhas por segundo.</span><span class="sxs-lookup"><span data-stu-id="786be-168">There are two important metrics associated with streaming throughput: Input rows per second and processed rows per second.</span></span> <span data-ttu-id="786be-169">Se as linhas de entrada por segundo outpaces linhas processadas por segundo, isso significa que o sistema de processamento de fluxo está atrasado.</span><span class="sxs-lookup"><span data-stu-id="786be-169">If input rows per second outpaces processed rows per second, it means the stream processing system is falling behind.</span></span> <span data-ttu-id="786be-170">Além disso, se os dados de entrada provêm de Hubs de eventos ou Kafka, em seguida, as linhas de entrada por segundo devem manter a taxa de ingestão de dados no front-end.</span><span class="sxs-lookup"><span data-stu-id="786be-170">Also, if the input data comes from Event Hubs or Kafka, then input rows per second should keep up with the data ingestion rate at the front end.</span></span>

<span data-ttu-id="786be-171">Dois trabalhos podem ter uma taxa de transferência de cluster semelhante, mas as métricas de transmissão muito diferentes.</span><span class="sxs-lookup"><span data-stu-id="786be-171">Two jobs can have similar cluster throughput but very different streaming metrics.</span></span> <span data-ttu-id="786be-172">Captura de tela a seguir mostra duas cargas de trabalho diferentes.</span><span class="sxs-lookup"><span data-stu-id="786be-172">The following screenshot shows two different workloads.</span></span> <span data-ttu-id="786be-173">Elas são semelhantes em termos de taxa de transferência de cluster (trabalhos, etapas e tarefas por minuto).</span><span class="sxs-lookup"><span data-stu-id="786be-173">They are similar in terms of cluster throughput (jobs, stages, and tasks per minute).</span></span> <span data-ttu-id="786be-174">Mas a segunda execução processa linhas de 12.000/seg contra 4.000 linhas/s.</span><span class="sxs-lookup"><span data-stu-id="786be-174">But the second run processes 12,000 rows/sec versus 4,000 rows/sec.</span></span>

![Taxa de transferência de gráfico mostrando streaming](./_images/grafana-streaming-throughput.png)

<span data-ttu-id="786be-176">Streaming de taxa de transferência geralmente é uma métrica de negócios melhor que a taxa de transferência de cluster, porque ele mede o número de registros de dados que são processados.</span><span class="sxs-lookup"><span data-stu-id="786be-176">Streaming throughput is often a better business metric than cluster throughput, because it measures the number of data records that are processed.</span></span>

## <a name="resource-consumption-per-executor"></a><span data-ttu-id="786be-177">Consumo de recursos por executor</span><span class="sxs-lookup"><span data-stu-id="786be-177">Resource consumption per executor</span></span>

<span data-ttu-id="786be-178">Essas métricas ajudam a compreender o trabalho que executa cada executor.</span><span class="sxs-lookup"><span data-stu-id="786be-178">These metrics help to understand the work that each executor performs.</span></span>

<span data-ttu-id="786be-179">**As métricas de percentual** medir quanto tempo um executor gasta em várias coisas, expressadas como uma proporção de tempo gasto em comparação com o tempo de computação geral executor.</span><span class="sxs-lookup"><span data-stu-id="786be-179">**Percentage metrics** measure how much time an executor spends on various things, expressed as a ratio of time spent versus the overall executor compute time.</span></span> <span data-ttu-id="786be-180">As métricas são:</span><span class="sxs-lookup"><span data-stu-id="786be-180">The metrics are:</span></span>

- <span data-ttu-id="786be-181">% Tempo de serializar</span><span class="sxs-lookup"><span data-stu-id="786be-181">% Serialize time</span></span>
- <span data-ttu-id="786be-182">% Tempo de desserializar</span><span class="sxs-lookup"><span data-stu-id="786be-182">% Deserialize time</span></span>
- <span data-ttu-id="786be-183">% Tempo da CPU executor</span><span class="sxs-lookup"><span data-stu-id="786be-183">% CPU executor time</span></span>
- <span data-ttu-id="786be-184">% De tempo da JVM</span><span class="sxs-lookup"><span data-stu-id="786be-184">% JVM time</span></span>

<span data-ttu-id="786be-185">Estas visualizações mostram o quanto cada uma dessas métricas contribui para o executor geral de processamento.</span><span class="sxs-lookup"><span data-stu-id="786be-185">These visualizations show how much each of these metrics contributes to overall executor processing.</span></span>

![Gráfico que mostra as métricas de percentual](./_images/grafana-percentage.png)

<span data-ttu-id="786be-187">**Métricas de embaralhar** métricas relacionadas aos dados, a ordem aleatória entre os executores.</span><span class="sxs-lookup"><span data-stu-id="786be-187">**Shuffle metrics** are metrics related to data shuffling across the executors.</span></span>

- <span data-ttu-id="786be-188">E/s de ordem aleatória</span><span class="sxs-lookup"><span data-stu-id="786be-188">Shuffle I/O</span></span>
- <span data-ttu-id="786be-189">Memória de ordem aleatória</span><span class="sxs-lookup"><span data-stu-id="786be-189">Shuffle memory</span></span>
- <span data-ttu-id="786be-190">Uso do sistema de arquivos</span><span class="sxs-lookup"><span data-stu-id="786be-190">File system usage</span></span>
- <span data-ttu-id="786be-191">Uso do disco</span><span class="sxs-lookup"><span data-stu-id="786be-191">Disk usage</span></span>

## <a name="common-performance-bottlenecks"></a><span data-ttu-id="786be-192">Gargalos de desempenho comuns</span><span class="sxs-lookup"><span data-stu-id="786be-192">Common performance bottlenecks</span></span>

<span data-ttu-id="786be-193">São duas gargalos de desempenho comuns no Spark *intervalos irregulares de tarefa* e uma *contagem de partições de ordem aleatória não ideal*.</span><span class="sxs-lookup"><span data-stu-id="786be-193">Two common performance bottlenecks in Spark are *task stragglers* and a *non-optimal shuffle partition count*.</span></span>

### <a name="task-stragglers"></a><span data-ttu-id="786be-194">Intervalos irregulares de tarefa</span><span class="sxs-lookup"><span data-stu-id="786be-194">Task stragglers</span></span>

<span data-ttu-id="786be-195">Os estágios de um trabalho são executados sequencialmente, com bloqueio de estágios posteriores de estágios anteriores.</span><span class="sxs-lookup"><span data-stu-id="786be-195">The stages in a job are executed sequentially, with earlier stages blocking later stages.</span></span> <span data-ttu-id="786be-196">Se uma tarefa for executada mais lentamente do que outras tarefas de uma partição de ordem aleatória, todas as tarefas no cluster devem aguardar a tarefa lenta ficar atualizado antes que o estágio pode terminar.</span><span class="sxs-lookup"><span data-stu-id="786be-196">If one task executes a shuffle partition more slowly than other tasks, all tasks in the cluster must wait for the slow task to catch up before the stage can end.</span></span> <span data-ttu-id="786be-197">Isso pode ocorrer pelos seguintes motivos:</span><span class="sxs-lookup"><span data-stu-id="786be-197">This can happen for the following reasons:</span></span>

1. <span data-ttu-id="786be-198">Um host ou grupo de hosts estão muito lentos.</span><span class="sxs-lookup"><span data-stu-id="786be-198">A host or group of hosts are running slow.</span></span> <span data-ttu-id="786be-199">Sintomas: Tarefa alta, estágio, ou latência do trabalho e taxa de transferência baixa do cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-199">Symptoms: High task, stage, or job latency and low cluster throughput.</span></span> <span data-ttu-id="786be-200">A adição de latências de tarefas por host não será distribuída uniformemente.</span><span class="sxs-lookup"><span data-stu-id="786be-200">The summation of tasks latencies per host won't be evenly distributed.</span></span> <span data-ttu-id="786be-201">No entanto, o consumo de recursos será distribuído uniformemente entre os executores.</span><span class="sxs-lookup"><span data-stu-id="786be-201">However, resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="786be-202">Tarefas têm uma agregação cara executar (distorção de dados).</span><span class="sxs-lookup"><span data-stu-id="786be-202">Tasks have an expensive aggregation to execute (data skewing).</span></span> <span data-ttu-id="786be-203">Sintomas: Tarefa alta, estágio, ou trabalho e taxa de transferência baixa de cluster, mas o somatório de latências de cada host é distribuído uniformemente.</span><span class="sxs-lookup"><span data-stu-id="786be-203">Symptoms: High task, stage, or job and low cluster throughput, but the summation of latencies per host is evenly distributed.</span></span> <span data-ttu-id="786be-204">Consumo de recursos será distribuído uniformemente entre os executores.</span><span class="sxs-lookup"><span data-stu-id="786be-204">Resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="786be-205">Se as partições são de tamanho desigual, uma partição maior pode causar a execução de tarefa desbalanceada (inclinação de partição).</span><span class="sxs-lookup"><span data-stu-id="786be-205">If partitions are of unequal size, a larger partition may cause unbalanced task execution (partition skewing).</span></span> <span data-ttu-id="786be-206">Sintomas: Consumo de recursos do executor é alto em comparação com outros executores em execução no cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-206">Symptoms: Executor resource consumption is high compared to other executors running on the cluster.</span></span> <span data-ttu-id="786be-207">Todas as tarefas em execução em que o executor serão executado lentamente e manter a execução do estágio no pipeline.</span><span class="sxs-lookup"><span data-stu-id="786be-207">All tasks running on that executor will run slow and hold the stage execution in the pipeline.</span></span> <span data-ttu-id="786be-208">Esses estágios são considerados *estágio barreiras*.</span><span class="sxs-lookup"><span data-stu-id="786be-208">Those stages are said to be *stage barriers*.</span></span>

### <a name="non-optimal-shuffle-partition-count"></a><span data-ttu-id="786be-209">Contagem de partições não ideal em ordem aleatória</span><span class="sxs-lookup"><span data-stu-id="786be-209">Non-optimal shuffle partition count</span></span>

<span data-ttu-id="786be-210">Durante uma consulta de streaming estruturada, a atribuição de uma tarefa para um executor é uma operação de uso intensivo de recursos para o cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-210">During a structured streaming query, the assignment of a task to an executor is a resource-intensive operation for the cluster.</span></span> <span data-ttu-id="786be-211">Se os dados de ordem aleatória não forem o tamanho ideal, a quantidade de atraso para uma tarefa afetará negativamente taxa de transferência e latência.</span><span class="sxs-lookup"><span data-stu-id="786be-211">If the shuffle data isn't the optimal size, the amount of delay for a task will negatively impact throughput and latency.</span></span> <span data-ttu-id="786be-212">Se houver muito poucas partições, os núcleos do cluster serão subutilizados que pode resultar em processamento ineficiência.</span><span class="sxs-lookup"><span data-stu-id="786be-212">If there are too few partitions, the cores in the cluster will be underutilized which can result in processing inefficiency.</span></span> <span data-ttu-id="786be-213">Por outro lado, se houver um número excessivo de partições, há uma grande quantidade de sobrecarga de gerenciamento para um pequeno número de tarefas.</span><span class="sxs-lookup"><span data-stu-id="786be-213">Conversely, if there are too many partitions, there's a great deal of management overhead for a small number of tasks.</span></span>

<span data-ttu-id="786be-214">Use métricas de consumo de recursos para solucionar problemas de distorção de partição e misallocation de executores no cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-214">Use the resource consumption metrics to troubleshoot partition skewing and misallocation of executors on the cluster.</span></span> <span data-ttu-id="786be-215">Se uma partição estiverem distorcida, recursos do executor de serão elevados em comparação com outros executores em execução no cluster.</span><span class="sxs-lookup"><span data-stu-id="786be-215">If a partition is skewed, executor resources will be elevated in comparison to other executors running on the cluster.</span></span>

<span data-ttu-id="786be-216">Por exemplo, o gráfico a seguir mostra que a memória usada pelo embaralhamento nos dois primeiros executores é 90 X maior do que os outros executores:</span><span class="sxs-lookup"><span data-stu-id="786be-216">For example, the following graph shows that the memory used by shuffling on the first two executors is 90X bigger than the other executors:</span></span>

![Gráfico que mostra as métricas de percentual](./_images/grafana-shuffle-memory.png)
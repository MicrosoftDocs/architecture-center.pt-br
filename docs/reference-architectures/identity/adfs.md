---
title: Implementando o Serviços de Federação do Active Directory (AD FS) no Azure
description: >-
  Como implementar uma arquitetura de rede híbrida segura com autorização dos Serviço de Federação do Active Directory no Azure.

  guidance,vpn-gateway,expressroute,load-balancer,virtual-network,active-directory
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Identity management
pnp.series.prev: adds-forest
cardTitle: Extend AD FS to Azure
ms.openlocfilehash: adf989ec40f837ce95000e75b7bc642db446f396
ms.sourcegitcommit: 1287d635289b1c49e94f839b537b4944df85111d
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/27/2018
ms.locfileid: "52332333"
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a><span data-ttu-id="cd891-104">Estender o Serviços de Federação do Active Directory (AD FS) para o Azure</span><span class="sxs-lookup"><span data-stu-id="cd891-104">Extend Active Directory Federation Services (AD FS) to Azure</span></span>

<span data-ttu-id="cd891-105">Essa arquitetura de referência implementa uma rede híbrida segura que estende a rede local para o Azure e usa o [Serviços de Federação do Active Directory (AD FS)][active-directory-federation-services] para executar autenticação e autorização federadas para componentes em execução no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-105">This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)][active-directory-federation-services] to perform federated authentication and authorization for components running in Azure.</span></span> [<span data-ttu-id="cd891-106">**Implante essa solução**.</span><span class="sxs-lookup"><span data-stu-id="cd891-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="cd891-107">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="cd891-107">[![0]][0]</span></span>

<span data-ttu-id="cd891-108">*Baixe um [Arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="cd891-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="cd891-109">O AD FS poderá ser hospedado localmente, mas se o aplicativo for um híbrido com algumas partes implementadas no Azure, talvez seja mais eficiente replicar o AD FS na nuvem.</span><span class="sxs-lookup"><span data-stu-id="cd891-109">AD FS can be hosted on-premises, but if your application is a hybrid in which some parts are implemented in Azure, it may be more efficient to replicate AD FS in the cloud.</span></span> 

<span data-ttu-id="cd891-110">O diagrama mostra os cenários a seguir:</span><span class="sxs-lookup"><span data-stu-id="cd891-110">The diagram shows the following scenarios:</span></span>

* <span data-ttu-id="cd891-111">O código do aplicativo de uma organização parceira acessa um aplicativo Web hospedado dentro de sua VNet do Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-111">Application code from a partner organization accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="cd891-112">Um usuário externo, registrado com credenciais armazenadas no DS (Active Directory Domain Services) acessa um aplicativo Web hospedado dentro de sua VNet do Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-112">An external, registered user with credentials stored inside Active Directory Domain Services (DS) accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="cd891-113">Um usuário conectado à sua VNet usando um dispositivo autorizado executa um aplicativo Web hospedado dentro de sua VNet do Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-113">A user connected to your VNet using an authorized device executes a web application hosted inside your Azure VNet.</span></span>

<span data-ttu-id="cd891-114">Alguns usos típicos dessa arquitetura:</span><span class="sxs-lookup"><span data-stu-id="cd891-114">Typical uses for this architecture include:</span></span>

* <span data-ttu-id="cd891-115">Aplicativos híbridos nos quais as cargas de trabalho são executadas parcialmente localmente e parcialmente no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-115">Hybrid applications where workloads run partly on-premises and partly in Azure.</span></span>
* <span data-ttu-id="cd891-116">Soluções que usam a autorização federada para expor aplicativos Web a organizações parceiras.</span><span class="sxs-lookup"><span data-stu-id="cd891-116">Solutions that use federated authorization to expose web applications to partner organizations.</span></span>
* <span data-ttu-id="cd891-117">Sistemas que dão suporte a acesso de navegadores da Web em execução fora do firewall organizacional.</span><span class="sxs-lookup"><span data-stu-id="cd891-117">Systems that support access from web browsers running outside of the organizational firewall.</span></span>
* <span data-ttu-id="cd891-118">Sistemas que permitem que os usuários acessem aplicativos Web se conectando de dispositivos externos autorizados, como computadores remotos, notebooks e outros dispositivos móveis.</span><span class="sxs-lookup"><span data-stu-id="cd891-118">Systems that enable users to access to web applications by connecting from authorized external devices such as remote computers, notebooks, and other mobile devices.</span></span> 

<span data-ttu-id="cd891-119">Essa arquitetura de referência concentra-se na *federação passiva*, na qual os servidores de federação decidem como e quando autenticar um usuário.</span><span class="sxs-lookup"><span data-stu-id="cd891-119">This reference architecture focuses on *passive federation*, in which the federation servers decide how and when to authenticate a user.</span></span> <span data-ttu-id="cd891-120">O usuário fornece informações de entrada quando o aplicativo é iniciado.</span><span class="sxs-lookup"><span data-stu-id="cd891-120">The user provides sign in information when the application is started.</span></span> <span data-ttu-id="cd891-121">Esse mecanismo geralmente é usado por navegadores da Web e envolve um protocolo que redireciona o navegador para um site em que o usuário é autenticado.</span><span class="sxs-lookup"><span data-stu-id="cd891-121">This mechanism is most commonly used by web browsers and involves a protocol that redirects the browser to a site where the user authenticates.</span></span> <span data-ttu-id="cd891-122">O AD FS também dá suporte para *federação ativa*, na qual um aplicativo assume a responsabilidade de fornecer credenciais sem interação adicional do usuário, mas esse cenário está fora do escopo dessa arquitetura.</span><span class="sxs-lookup"><span data-stu-id="cd891-122">AD FS also supports *active federation*, where an application takes on responsibility for supplying credentials without further user interaction, but that scenario is outside the scope of this architecture.</span></span>

<span data-ttu-id="cd891-123">Para obter considerações adicionais, consulte [Escolher uma solução para a integração do Active Directory local ao Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="cd891-123">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span> 

## <a name="architecture"></a><span data-ttu-id="cd891-124">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="cd891-124">Architecture</span></span>

<span data-ttu-id="cd891-125">Essa arquitetura estende a implementação descrita em [Estendendo o AD DS (Active Directory Domain Services) para o Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="cd891-125">This architecture extends the implementation described in [Extending AD DS to Azure][extending-ad-to-azure].</span></span> <span data-ttu-id="cd891-126">Ela contém os componentes a seguir.</span><span class="sxs-lookup"><span data-stu-id="cd891-126">It contains the followign components.</span></span>

* <span data-ttu-id="cd891-127">**Sub-rede do AD DS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-127">**AD DS subnet**.</span></span> <span data-ttu-id="cd891-128">Os servidores do AD DS estão contidos em suas próprias sub-redes com as regras do NSG (Grupo de Segurança de Rede) atuando como um firewall.</span><span class="sxs-lookup"><span data-stu-id="cd891-128">The AD DS servers are contained in their own subnet with network security group (NSG) rules acting as a firewall.</span></span>

* <span data-ttu-id="cd891-129">**Servidores do AD DS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-129">**AD DS servers**.</span></span> <span data-ttu-id="cd891-130">Controladores de domínio em execução como VMs no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-130">Domain controllers running as VMs in Azure.</span></span> <span data-ttu-id="cd891-131">Esses servidores fornecem autenticação de identidades locais dentro do domínio.</span><span class="sxs-lookup"><span data-stu-id="cd891-131">These servers provide authentication of local identities within the domain.</span></span>

* <span data-ttu-id="cd891-132">**Sub-rede do AD FS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-132">**AD FS subnet**.</span></span> <span data-ttu-id="cd891-133">Os servidores do AD FS estão localizados em suas próprias sub-redes com regras do NSG atuando como um firewall.</span><span class="sxs-lookup"><span data-stu-id="cd891-133">The AD FS servers are located within their own subnet with NSG rules acting as a firewall.</span></span>

* <span data-ttu-id="cd891-134">**Servidores do AD FS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-134">**AD FS servers**.</span></span> <span data-ttu-id="cd891-135">Os servidores do AD FS fornecem autenticação e autorização federadas.</span><span class="sxs-lookup"><span data-stu-id="cd891-135">The AD FS servers provide federated authorization and authentication.</span></span> <span data-ttu-id="cd891-136">Nessa arquitetura, eles executam as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="cd891-136">In this architecture, they perform the following tasks:</span></span>
  
  * <span data-ttu-id="cd891-137">Recebimento de tokens de segurança contendo declarações feitas por um servidor de federação do parceiro em nome de um usuário do parceiro.</span><span class="sxs-lookup"><span data-stu-id="cd891-137">Receiving security tokens containing claims made by a partner federation server on behalf of a partner user.</span></span> <span data-ttu-id="cd891-138">O AD FS verifica se os tokens são válidos antes de passar as declarações para o aplicativo Web em execução no Azure para autorizar solicitações.</span><span class="sxs-lookup"><span data-stu-id="cd891-138">AD FS verifies that the tokens are valid before passing the claims to the web application running in Azure to authorize requests.</span></span> 
  
    <span data-ttu-id="cd891-139">O aplicativo Web em execução no Azure é a *terceira parte confiável*.</span><span class="sxs-lookup"><span data-stu-id="cd891-139">The web application running in Azure is the *relying party*.</span></span> <span data-ttu-id="cd891-140">O servidor de federação do parceiro deve emitir declarações que sejam entendidas pelo aplicativo Web.</span><span class="sxs-lookup"><span data-stu-id="cd891-140">The partner federation server must issue claims that are understood by the web application.</span></span> <span data-ttu-id="cd891-141">Os servidores de federação do parceiro são chamados de *parceiros de conta*, porque eles enviam solicitações de acesso em nome de contas autenticadas na organização do parceiro.</span><span class="sxs-lookup"><span data-stu-id="cd891-141">The partner federation servers are referred to as *account partners*, because they submit access requests on behalf of authenticated accounts in the partner organization.</span></span> <span data-ttu-id="cd891-142">Os servidores do AD FS são chamados de *parceiros de recurso* porque eles fornecem acesso aos recursos (o aplicativo Web).</span><span class="sxs-lookup"><span data-stu-id="cd891-142">The AD FS servers are called *resource partners* because they provide access to resources (the web application).</span></span>

  * <span data-ttu-id="cd891-143">Autenticação e autorização de solicitações recebidas de usuários externos executando um navegador da Web ou um dispositivo que precise de acesso a aplicativos Web, usando o AD DS e o [Serviço de registro de dispositivo do Active Directory][ADDRS].</span><span class="sxs-lookup"><span data-stu-id="cd891-143">Authenticating and authorizing incoming requests from external users running a web browser or device that needs access to web applications, by using AD DS and the [Active Directory Device Registration Service][ADDRS].</span></span>
    
  <span data-ttu-id="cd891-144">Os servidores do AD FS são configurados como um farm acessado por meio de um Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="cd891-144">The AD FS servers are configured as a farm accessed through an Azure load balancer.</span></span> <span data-ttu-id="cd891-145">Essa implementação melhora a disponibilidade e escalabilidade.</span><span class="sxs-lookup"><span data-stu-id="cd891-145">This implementation improves availability and scalability.</span></span> <span data-ttu-id="cd891-146">Os servidores do AD FS não são expostos diretamente à Internet.</span><span class="sxs-lookup"><span data-stu-id="cd891-146">The AD FS servers are not exposed directly to the Internet.</span></span> <span data-ttu-id="cd891-147">Todo o tráfego de Internet é filtrado por meio de servidores proxy de aplicativo Web do AD FS e de uma rede de perímetro (também conhecida como DMZ).</span><span class="sxs-lookup"><span data-stu-id="cd891-147">All Internet traffic is filtered through AD FS web application proxy servers and a DMZ (also referred to as a perimeter network).</span></span>

  <span data-ttu-id="cd891-148">Para obter mais informações de como funciona o AD FS, consulte [Visão geral dos Serviços de Federação do Active Directory (AD FS)][active-directory-federation-services-overview].</span><span class="sxs-lookup"><span data-stu-id="cd891-148">For more information about how AD FS works, see [Active Directory Federation Services Overview][active-directory-federation-services-overview].</span></span> <span data-ttu-id="cd891-149">Além disso, o artigo [Implantação do AD FS no Azure][adfs-intro] contém uma introdução passo a passo detalhada da implementação.</span><span class="sxs-lookup"><span data-stu-id="cd891-149">Also, the article [AD FS deployment in Azure][adfs-intro] contains a detailed step-by-step introduction to implementation.</span></span>

* <span data-ttu-id="cd891-150">**Sub-rede de proxy do AD FS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-150">**AD FS proxy subnet**.</span></span> <span data-ttu-id="cd891-151">Os servidores proxy do AD FS podem estar contidos em suas próprias sub-redes com regras do NSG fornecendo proteção.</span><span class="sxs-lookup"><span data-stu-id="cd891-151">The AD FS proxy servers can be contained within their own subnet, with NSG rules providing protection.</span></span> <span data-ttu-id="cd891-152">Os servidores nesta sub-rede são expostos à Internet por meio de um conjunto de soluções de virtualização de rede que fornecem um firewall entre a sua rede virtual do Azure e a Internet.</span><span class="sxs-lookup"><span data-stu-id="cd891-152">The servers in this subnet are exposed to the Internet through a set of network virtual appliances that provide a firewall between your Azure virtual network and the Internet.</span></span>

* <span data-ttu-id="cd891-153">**Servidores WAP (Proxy de aplicativo Web) do AD FS**.</span><span class="sxs-lookup"><span data-stu-id="cd891-153">**AD FS web application proxy (WAP) servers**.</span></span> <span data-ttu-id="cd891-154">Essas VMs atuam como servidores do AD FS para solicitações recebidas de organizações parceiras e de dispositivos externos.</span><span class="sxs-lookup"><span data-stu-id="cd891-154">These VMs act as AD FS servers for incoming requests from partner organizations and external devices.</span></span> <span data-ttu-id="cd891-155">Os servidores WAP atuam como um filtro, blindando os servidores do AD FS contra acesso direto da Internet.</span><span class="sxs-lookup"><span data-stu-id="cd891-155">The WAP servers act as a filter, shielding the AD FS servers from direct access from the Internet.</span></span> <span data-ttu-id="cd891-156">Assim como acontece com os servidores do AD FS, a implantação de servidores WAP em um farm com balanceamento de carga fornece maior disponibilidade e escalabilidade do que a implantação de uma coleção de servidores autônomos.</span><span class="sxs-lookup"><span data-stu-id="cd891-156">As with the AD FS servers, deploying the WAP servers in a farm with load balancing gives you greater availability and scalability than deploying a collection of stand-alone servers.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="cd891-157">Para obter informações detalhadas de como instalar servidores WAP, consulte [Instalar e configurar o servidor proxy de aplicativo Web][install_and_configure_the_web_application_proxy_server]</span><span class="sxs-lookup"><span data-stu-id="cd891-157">For detailed information about installing WAP servers, see [Install and Configure the Web Application Proxy Server][install_and_configure_the_web_application_proxy_server]</span></span>
  > 
  > 

* <span data-ttu-id="cd891-158">**Organização parceira**.</span><span class="sxs-lookup"><span data-stu-id="cd891-158">**Partner organization**.</span></span> <span data-ttu-id="cd891-159">Uma organização parceira que executa um aplicativo Web que solicita acesso a um aplicativo Web em execução no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-159">A partner organization running a web application that requests access to a web application running in Azure.</span></span> <span data-ttu-id="cd891-160">O servidor de federação na organização parceira autentica as solicitações localmente e envia tokens de segurança contendo declarações para o AD FS em execução no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-160">The federation server at the partner organization authenticates requests locally, and submits security tokens containing claims to AD FS running in Azure.</span></span> <span data-ttu-id="cd891-161">O AD FS no Azure valida os tokens de segurança e, quando eles são válidos, passa as declarações para o aplicativo Web em execução no Azure para autorizá-los.</span><span class="sxs-lookup"><span data-stu-id="cd891-161">AD FS in Azure validates the security tokens, and if valid can pass the claims to the web application running in Azure to authorize them.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="cd891-162">Você também pode configurar um túnel de VPN usando o gateway do Azure para fornecer acesso direto ao AD FS para parceiros confiáveis.</span><span class="sxs-lookup"><span data-stu-id="cd891-162">You can also configure a VPN tunnel using Azure gateway to provide direct access to AD FS for trusted partners.</span></span> <span data-ttu-id="cd891-163">As solicitações recebidas desses parceiros não passam por servidores WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-163">Requests received from these partners do not pass through the WAP servers.</span></span>
  > 
  > 

<span data-ttu-id="cd891-164">Para obter mais informações sobre as partes da arquitetura que não estão relacionadas ao AD FS, consulte o seguinte:</span><span class="sxs-lookup"><span data-stu-id="cd891-164">For more information about the parts of the architecture that are not related to AD FS, see the following:</span></span>
- <span data-ttu-id="cd891-165">[Implementando uma arquitetura de rede híbrida segura no Azure][implementing-a-secure-hybrid-network-architecture]</span><span class="sxs-lookup"><span data-stu-id="cd891-165">[Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture]</span></span>
- <span data-ttu-id="cd891-166">[Implementando uma arquitetura de rede híbrida segura com acesso à Internet no Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span><span class="sxs-lookup"><span data-stu-id="cd891-166">[Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span></span>
- <span data-ttu-id="cd891-167">[Implementando uma arquitetura de rede híbrida segura com identidades do Active Directory no Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="cd891-167">[Implementing a secure hybrid network architecture with Active Directory identities in Azure][extending-ad-to-azure].</span></span>


## <a name="recommendations"></a><span data-ttu-id="cd891-168">Recomendações</span><span class="sxs-lookup"><span data-stu-id="cd891-168">Recommendations</span></span>

<span data-ttu-id="cd891-169">As seguintes recomendações aplicam-se à maioria dos cenários.</span><span class="sxs-lookup"><span data-stu-id="cd891-169">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="cd891-170">Siga estas recomendações, a menos que você tenha um requisito específico que as substitua.</span><span class="sxs-lookup"><span data-stu-id="cd891-170">Follow these recommendations unless you have a specific requirement that overrides them.</span></span> 

### <a name="vm-recommendations"></a><span data-ttu-id="cd891-171">Recomendações de VM</span><span class="sxs-lookup"><span data-stu-id="cd891-171">VM recommendations</span></span>

<span data-ttu-id="cd891-172">Crie VMs com recursos suficientes para lidar com o volume ou o tráfego esperado.</span><span class="sxs-lookup"><span data-stu-id="cd891-172">Create VMs with sufficient resources to handle the expected volume of traffic.</span></span> <span data-ttu-id="cd891-173">Use o tamanho dos computadores existentes que hospedam o AD FS localmente como um ponto inicial.</span><span class="sxs-lookup"><span data-stu-id="cd891-173">Use the size of the existing machines hosting AD FS on premises as a starting point.</span></span> <span data-ttu-id="cd891-174">Monitore a utilização de recursos.</span><span class="sxs-lookup"><span data-stu-id="cd891-174">Monitor the resource utilization.</span></span> <span data-ttu-id="cd891-175">Você pode redimensionar as VMs e reduzir verticalmente se elas forem muito grandes.</span><span class="sxs-lookup"><span data-stu-id="cd891-175">You can resize the VMs and scale down if they are too large.</span></span>

<span data-ttu-id="cd891-176">Siga as recomendações listadas em [Executando uma VM do Windows no Azure][vm-recommendations].</span><span class="sxs-lookup"><span data-stu-id="cd891-176">Follow the recommendations listed in [Running a Windows VM on Azure][vm-recommendations].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="cd891-177">Recomendações de rede</span><span class="sxs-lookup"><span data-stu-id="cd891-177">Networking recommendations</span></span>

<span data-ttu-id="cd891-178">Configure o adaptador de rede para cada uma das VMs que hospedam o AD FS e os servidores WAP com endereços IP privados estáticos.</span><span class="sxs-lookup"><span data-stu-id="cd891-178">Configure the network interface for each of the VMs hosting AD FS and WAP servers with static private IP addresses.</span></span>

<span data-ttu-id="cd891-179">Não forneça endereços IP públicos às VMs do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-179">Do not give the AD FS VMs public IP addresses.</span></span> <span data-ttu-id="cd891-180">Para obter mais informações, consulte a seção Considerações de segurança.</span><span class="sxs-lookup"><span data-stu-id="cd891-180">For more information, see the Security considerations section.</span></span>

<span data-ttu-id="cd891-181">Defina o endereço IP dos servidores DNS (Serviço de Nomes de Domínio) preferencial e secundários para os adaptadores de rede de cada VM do AD FS e do WAP para referenciar as VMs do Active Directory DS.</span><span class="sxs-lookup"><span data-stu-id="cd891-181">Set the IP address of the preferred and secondary domain name service (DNS) servers for the network interfaces for each AD FS and WAP VM to reference the Active Directory DS VMs.</span></span> <span data-ttu-id="cd891-182">As VMs do Active Directory DS devem estar executando o DNS.</span><span class="sxs-lookup"><span data-stu-id="cd891-182">The Active Directory DS VMS should be running DNS.</span></span> <span data-ttu-id="cd891-183">Essa etapa é necessária para habilitar cada VM para ingressar no domínio.</span><span class="sxs-lookup"><span data-stu-id="cd891-183">This step is necessary to enable each VM to join the domain.</span></span>

### <a name="ad-fs-availability"></a><span data-ttu-id="cd891-184">Disponibilidade do AD FS</span><span class="sxs-lookup"><span data-stu-id="cd891-184">AD FS availability</span></span> 

<span data-ttu-id="cd891-185">Crie um farm do AD FS com pelo menos dois servidores para aumentar a disponibilidade do serviço.</span><span class="sxs-lookup"><span data-stu-id="cd891-185">Create an AD FS farm with at least two servers to increase availability of the service.</span></span> <span data-ttu-id="cd891-186">Use contas de armazenamento diferentes para cada VM do AD FS no farm.</span><span class="sxs-lookup"><span data-stu-id="cd891-186">Use different storage accounts for each AD FS VM in the farm.</span></span> <span data-ttu-id="cd891-187">Essa abordagem ajuda a garantir que uma falha em uma única conta de armazenamento não deixe todo o farm inacessível.</span><span class="sxs-lookup"><span data-stu-id="cd891-187">This approach helps to ensure that a failure in a single storage account does not make the entire farm inaccessible.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="cd891-188">Recomendamos o uso de [discos gerenciado](/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="cd891-188">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="cd891-189">Os discos gerenciados não exigem uma conta de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="cd891-189">Managed disks do not require a storage account.</span></span> <span data-ttu-id="cd891-190">Você simplesmente especifica o tamanho e o tipo de disco e ele é implantado em um modo altamente disponível.</span><span class="sxs-lookup"><span data-stu-id="cd891-190">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span> <span data-ttu-id="cd891-191">As nossas [arquiteturas de referência](/azure/architecture/reference-architectures/) não implantam discos gerenciados no momento, mas os [blocos de construção de modelo](https://github.com/mspnp/template-building-blocks/wiki) serão atualizados para implantar discos gerenciados na versão 2.</span><span class="sxs-lookup"><span data-stu-id="cd891-191">Our [reference architectures](/azure/architecture/reference-architectures/) do not currently deploy managed disks but the [template building blocks](https://github.com/mspnp/template-building-blocks/wiki) will be updated to deploy managed disks in version 2.</span></span>

<span data-ttu-id="cd891-192">Crie conjuntos de disponibilidade do Azure separados para as VMs do AD FS e do WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-192">Create separate Azure availability sets for the AD FS and WAP VMs.</span></span> <span data-ttu-id="cd891-193">Verifique se há pelo menos duas VMs em cada conjunto.</span><span class="sxs-lookup"><span data-stu-id="cd891-193">Ensure that there are at least two VMs in each set.</span></span> <span data-ttu-id="cd891-194">Cada conjunto de disponibilidade deve ter pelo menos dois domínios de atualização e dois domínios de falha.</span><span class="sxs-lookup"><span data-stu-id="cd891-194">Each availability set must have at least two update domains and two fault domains.</span></span>

<span data-ttu-id="cd891-195">Configure os balanceadores de carga das VMs do AD FS e das VMs do WAP da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="cd891-195">Configure the load balancers for the AD FS VMs and WAP VMs as follows:</span></span>

* <span data-ttu-id="cd891-196">Use um Azure Load Balancer para fornecer acesso externo para as VMs do WAP e um balanceador de carga interno para distribuir a carga entre os servidores do AD FS no farm.</span><span class="sxs-lookup"><span data-stu-id="cd891-196">Use an Azure load balancer to provide external access to the WAP VMs, and an internal load balancer to distribute the load across the AD FS servers in the farm.</span></span>
* <span data-ttu-id="cd891-197">Passe apenas o tráfego que aparece na porta 443 (HTTPS) para os servidores do AD FS/WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-197">Only pass traffic appearing on port 443 (HTTPS) to the AD FS/WAP servers.</span></span>
* <span data-ttu-id="cd891-198">Forneça um endereço IP estático ao balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="cd891-198">Give the load balancer a static IP address.</span></span>
* <span data-ttu-id="cd891-199">Crie uma investigação de integridade usando HTTP em `/adfs/probe`.</span><span class="sxs-lookup"><span data-stu-id="cd891-199">Create a health probe using HTTP against `/adfs/probe`.</span></span> <span data-ttu-id="cd891-200">Para saber mais, veja [Verificações de integridade do balanceador de carga de hardware e o proxy de aplicativo Web/AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/).</span><span class="sxs-lookup"><span data-stu-id="cd891-200">For more information, see [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="cd891-201">Os servidores do AD FS usam o protocolo SNI (Indicação de Nome de Servidor), portanto, haverá falha na tentativa de investigar usando um ponto de extremidade HTTPS do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="cd891-201">AD FS servers use the Server Name Indication (SNI) protocol, so attempting to probe using an HTTPS endpoint from the load balancer fails.</span></span>
  > 
  > 
* <span data-ttu-id="cd891-202">Adicione um registro DNS *A* para o domínio do balanceador de carga do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-202">Add a DNS *A* record to the domain for the AD FS load balancer.</span></span> <span data-ttu-id="cd891-203">Especifique o endereço IP do balanceador de carga e nomeie-o no domínio (como adfs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="cd891-203">Specify the IP address of the load balancer, and give it a name in the domain (such as adfs.contoso.com).</span></span> <span data-ttu-id="cd891-204">Esse é o nome que os clientes e os servidores do WAP usam para acessar o farm de servidores do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-204">This is the name clients and the WAP servers use to access the AD FS server farm.</span></span>

### <a name="ad-fs-security"></a><span data-ttu-id="cd891-205">Segurança do AD FS</span><span class="sxs-lookup"><span data-stu-id="cd891-205">AD FS security</span></span> 

<span data-ttu-id="cd891-206">Evite a exposição direta dos servidores do AD FS à Internet.</span><span class="sxs-lookup"><span data-stu-id="cd891-206">Prevent direct exposure of the AD FS servers to the Internet.</span></span> <span data-ttu-id="cd891-207">Os servidores do AD FS são computadores ingressados no domínio que têm autorização total para conceder tokens de segurança.</span><span class="sxs-lookup"><span data-stu-id="cd891-207">AD FS servers are domain-joined computers that have full authorization to grant security tokens.</span></span> <span data-ttu-id="cd891-208">Se um servidor estiver comprometido, um usuário mal-intencionado poderá emitir tokens de acesso completo a todos os aplicativos Web e a todos os servidores de federação protegidos pelo AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-208">If a server is compromised, a malicious user can issue full access tokens to all web applications and to all federation servers that are protected by AD FS.</span></span> <span data-ttu-id="cd891-209">Se o sistema precisar lidar com solicitações de usuários externos que não se conectam de sites de parceiros confiáveis, use os servidores do WAP para lidar com essas solicitações.</span><span class="sxs-lookup"><span data-stu-id="cd891-209">If your system must handle requests from external users not connecting from trusted partner sites, use WAP servers to handle these requests.</span></span> <span data-ttu-id="cd891-210">Para obter mais informações, consulte [Onde colocar um Proxy do servidor de Federação][where-to-place-an-fs-proxy].</span><span class="sxs-lookup"><span data-stu-id="cd891-210">For more information, see [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy].</span></span>

<span data-ttu-id="cd891-211">Coloque os servidores do AD FS e os servidores do WAP em sub-redes separadas com seus próprios firewalls.</span><span class="sxs-lookup"><span data-stu-id="cd891-211">Place AD FS servers and WAP servers in separate subnets with their own firewalls.</span></span> <span data-ttu-id="cd891-212">Você pode usar as regras do NSG para definir as regras de firewall.</span><span class="sxs-lookup"><span data-stu-id="cd891-212">You can use NSG rules to define firewall rules.</span></span> <span data-ttu-id="cd891-213">Se precisar de uma proteção mais abrangente, você poderá implementar um perímetro de segurança adicional envolvendo os servidores usando um par de sub-redes e NVAs (soluções de virtualização de rede), conforme é descrito no documento [Implementando uma arquitetura de rede híbrida segura com acesso de Internet no Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="cd891-213">If you require more comprehensive protection you can implement an additional security perimeter around servers by using a pair of subnets and network virtual appliances (NVAs), as described in the document [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="cd891-214">Todos os firewalls devem permitir o tráfego na porta 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="cd891-214">All firewalls should allow traffic on port 443 (HTTPS).</span></span>

<span data-ttu-id="cd891-215">Restrinja o acesso de entrada direta para os servidores do AD FS e do WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-215">Restrict direct sign in access to the AD FS and WAP servers.</span></span> <span data-ttu-id="cd891-216">Equipe de DevOps só deve ser capaz de se conectar.</span><span class="sxs-lookup"><span data-stu-id="cd891-216">Only DevOps staff should be able to connect.</span></span>

<span data-ttu-id="cd891-217">Não ingresse os servidores do WAP no domínio.</span><span class="sxs-lookup"><span data-stu-id="cd891-217">Do not join the WAP servers to the domain.</span></span>

### <a name="ad-fs-installation"></a><span data-ttu-id="cd891-218">Instalação do AD FS</span><span class="sxs-lookup"><span data-stu-id="cd891-218">AD FS installation</span></span> 

<span data-ttu-id="cd891-219">O artigo [Implantando um Farm de Servidores de Federação][Deploying_a_federation_server_farm] fornece instruções detalhadas para instalar e configurar o AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-219">The article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] provides detailed instructions for installing and configuring AD FS.</span></span> <span data-ttu-id="cd891-220">Execute as seguintes tarefas antes de configurar o primeiro servidor do AD FS no farm:</span><span class="sxs-lookup"><span data-stu-id="cd891-220">Perform the following tasks before configuring the first AD FS server in the farm:</span></span>

1. <span data-ttu-id="cd891-221">Obtenha um certificado confiável publicamente para executar a autenticação do servidor.</span><span class="sxs-lookup"><span data-stu-id="cd891-221">Obtain a publicly trusted certificate for performing server authentication.</span></span> <span data-ttu-id="cd891-222">O *nome da entidade* deve conter o nome que os clientes usam para acessar o serviço de federação.</span><span class="sxs-lookup"><span data-stu-id="cd891-222">The *subject name* must contain the name clients use to access the federation service.</span></span> <span data-ttu-id="cd891-223">Pode ser o nome DNS registrado para o balanceador de carga, por exemplo, *adfs.contoso.com* (evite usar nomes com caracteres curinga, como \**.contoso.com*, por motivos de segurança).</span><span class="sxs-lookup"><span data-stu-id="cd891-223">This can be the DNS name registered for the load balancer, for example, *adfs.contoso.com* (avoid using wildcard names such as \**.contoso.com*, for security reasons).</span></span> <span data-ttu-id="cd891-224">Use o mesmo certificado em todas as VMs de servidor do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-224">Use the same certificate on all AD FS server VMs.</span></span> <span data-ttu-id="cd891-225">É possível comprar um certificado de uma autoridade de certificação confiável, mas se a sua organização usa os Serviços de Certificados do Active Directory, você pode criar seus próprios certificados.</span><span class="sxs-lookup"><span data-stu-id="cd891-225">You can purchase a certificate from a trusted certification authority, but if your organization uses Active Directory Certificate Services you can create your own.</span></span> 
   
    <span data-ttu-id="cd891-226">O *nome alternativo da entidade* é usado pelo DRS (serviço de registro de dispositivo) para habilitar o acesso de dispositivos externos.</span><span class="sxs-lookup"><span data-stu-id="cd891-226">The *subject alternative name* is used by the device registration service (DRS) to enable access from external devices.</span></span> <span data-ttu-id="cd891-227">O formato deve ser *enterpriseregistration.contoso.com*.</span><span class="sxs-lookup"><span data-stu-id="cd891-227">This should be of the form *enterpriseregistration.contoso.com*.</span></span>
   
    <span data-ttu-id="cd891-228">Para obter mais informações, consulte [Obter e configurar um certificado de protocolo SSL para o AD FS][adfs_certificates].</span><span class="sxs-lookup"><span data-stu-id="cd891-228">For more information, see [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates].</span></span>

2. <span data-ttu-id="cd891-229">No controlador de domínio, gere uma nova chave de raiz para o Serviço de Distribuição de Chave.</span><span class="sxs-lookup"><span data-stu-id="cd891-229">On the domain controller, generate a new root key for the Key Distribution Service.</span></span> <span data-ttu-id="cd891-230">Defina o tempo efetivo para a hora atual menos 10 horas (essa configuração reduz o atraso que pode ocorrer na distribuição e na sincronização de chaves no domínio).</span><span class="sxs-lookup"><span data-stu-id="cd891-230">Set the effective time to the current time minus 10 hours (this configuration reduces the delay that can occur in distributing and synchronizing keys across the domain).</span></span> <span data-ttu-id="cd891-231">Essa etapa é necessária para dar suporte à criação da conta de serviço de grupo que é usada para executar o serviço do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-231">This step is necessary to support creating the group service account that is used to run the AD FS service.</span></span> <span data-ttu-id="cd891-232">O comando do PowerShell a seguir mostra um exemplo de como fazer isso:</span><span class="sxs-lookup"><span data-stu-id="cd891-232">The following PowerShell command shows an example of how to do this:</span></span>
   
    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. <span data-ttu-id="cd891-233">Adicione cada VM de servidor do AD FS no domínio.</span><span class="sxs-lookup"><span data-stu-id="cd891-233">Add each AD FS server VM to the domain.</span></span>

> [!NOTE]
> <span data-ttu-id="cd891-234">Para instalar o AD FS, o controlador de domínio que executa a função FSMO (Flexible Single Master Operation) do emulador do PDC (controlador de domínio primário) do domínio deve estar em execução e acessível para as VMs do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-234">To install AD FS, the domain controller running the primary domain controller (PDC) emulator flexible single master operation (FSMO) role for the domain must be running and accessible from the AD FS VMs.</span></span> <span data-ttu-id="cd891-235"><<RBC: existe alguma maneira de deixar isso menos repetitivo?>></span><span class="sxs-lookup"><span data-stu-id="cd891-235"><<RBC: Is there a way to make this less repetitive?>></span></span>
> 
> 

### <a name="ad-fs-trust"></a><span data-ttu-id="cd891-236">Relação de confiança do AD FS</span><span class="sxs-lookup"><span data-stu-id="cd891-236">AD FS trust</span></span> 

<span data-ttu-id="cd891-237">Estabelece a relação de confiança de federação entre a instalação do AD FS e os servidores de federação de qualquer organização parceira.</span><span class="sxs-lookup"><span data-stu-id="cd891-237">Establish federation trust between your AD FS installation, and the federation servers of any partner organizations.</span></span> <span data-ttu-id="cd891-238">Configure as filtragens e os mapeamentos de declaração necessários.</span><span class="sxs-lookup"><span data-stu-id="cd891-238">Configure any claims filtering and mapping required.</span></span> 

* <span data-ttu-id="cd891-239">A equipe de DevOps em cada organização parceira deve adicionar um objeto de confiança de terceira parte confiável para os aplicativos Web acessíveis por meio dos servidores do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-239">DevOps staff at each partner organization must add a relying party trust for the web applications accessible through your AD FS servers.</span></span>
* <span data-ttu-id="cd891-240">A equipe de DevOps em sua organização deve configurar a relação de confiança do provedor de declarações para permitir que os servidores do AD FS confiem nas declarações que as organizações parceiras fornecem.</span><span class="sxs-lookup"><span data-stu-id="cd891-240">DevOps staff in your organization must configure claims-provider trust to enable your AD FS servers to trust the claims that partner organizations provide.</span></span>
* <span data-ttu-id="cd891-241">A equipe de DevOps na organização também deve configurar o AD FS para transmitir declarações para os aplicativos Web da organização.</span><span class="sxs-lookup"><span data-stu-id="cd891-241">DevOps staff in your organization must also configure AD FS to pass claims on to your organization's web applications.</span></span>
  
<span data-ttu-id="cd891-242">Para obter mais informações, consulte [Establishing Federation Trust][establishing-federation-trust] (Estabelecendo uma relação de confiança de federação).</span><span class="sxs-lookup"><span data-stu-id="cd891-242">For more information, see [Establishing Federation Trust][establishing-federation-trust].</span></span>

<span data-ttu-id="cd891-243">Publique os aplicativos Web da organização e disponibilize-os a parceiros externos usando a pré-autenticação por meio dos servidores do WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-243">Publish your organization's web applications and make them available to external partners by using preauthentication through the WAP servers.</span></span> <span data-ttu-id="cd891-244">Para obter mais informações, consulte [Publicar aplicativos usando a pré-autenticação do AD FS][publish_applications_using_AD_FS_preauthentication]</span><span class="sxs-lookup"><span data-stu-id="cd891-244">For more information, see [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication]</span></span>

<span data-ttu-id="cd891-245">O AD FS dá suporte para aumento e transformação de token.</span><span class="sxs-lookup"><span data-stu-id="cd891-245">AD FS supports token transformation and augmentation.</span></span> <span data-ttu-id="cd891-246">O Azure Active Directory não oferece esse recurso.</span><span class="sxs-lookup"><span data-stu-id="cd891-246">Azure Active Directory does not provide this feature.</span></span> <span data-ttu-id="cd891-247">Com o AD FS, ao configurar as relações de confiança, você pode:</span><span class="sxs-lookup"><span data-stu-id="cd891-247">With AD FS, when you set up the trust relationships, you can:</span></span>

* <span data-ttu-id="cd891-248">Configurar transformações de declaração para regras de autorização.</span><span class="sxs-lookup"><span data-stu-id="cd891-248">Configure claim transformations for authorization rules.</span></span> <span data-ttu-id="cd891-249">Por exemplo, você pode mapear a segurança do grupo de uma representação usada por uma organização que não seja parceira da Microsoft para algo que o Active Directory DS possa autorizar em sua organização.</span><span class="sxs-lookup"><span data-stu-id="cd891-249">For example, you can map group security from a representation used by a non-Microsoft partner organization to something that that Active Directory DS can authorize in your organization.</span></span>
* <span data-ttu-id="cd891-250">Transforme declarações de um formato para outro.</span><span class="sxs-lookup"><span data-stu-id="cd891-250">Transform claims from one format to another.</span></span> <span data-ttu-id="cd891-251">Por exemplo, você poderá mapear de SAML 2.0 para SAML 1.1 se seu aplicativo somente der suporte para declarações SAML 1.1.</span><span class="sxs-lookup"><span data-stu-id="cd891-251">For example, you can map from SAML 2.0 to SAML 1.1 if your application only supports SAML 1.1 claims.</span></span>

### <a name="ad-fs-monitoring"></a><span data-ttu-id="cd891-252">Monitoramento do AD FS</span><span class="sxs-lookup"><span data-stu-id="cd891-252">AD FS monitoring</span></span> 

<span data-ttu-id="cd891-253">O [Pacote de Gerenciamento do Microsoft System Center para Serviços de Federação do Active Directory (AD FS) 2012 R2][oms-adfs-pack] fornece monitoramento proativo e reativo de sua implantação do AD FS para o servidor de federação.</span><span class="sxs-lookup"><span data-stu-id="cd891-253">The [Microsoft System Center Management Pack for Active Directory Federation Services 2012 R2][oms-adfs-pack] provides both proactive and reactive monitoring of your AD FS deployment for the federation server.</span></span> <span data-ttu-id="cd891-254">Este pacote de gerenciamento monitora:</span><span class="sxs-lookup"><span data-stu-id="cd891-254">This management pack monitors:</span></span>

* <span data-ttu-id="cd891-255">Eventos que o serviço do AD FS registra em seus logs de eventos.</span><span class="sxs-lookup"><span data-stu-id="cd891-255">Events that the AD FS service records in its event logs.</span></span>
* <span data-ttu-id="cd891-256">Os dados de desempenho que os contadores de desempenho do AD FS coletam.</span><span class="sxs-lookup"><span data-stu-id="cd891-256">The performance data that the AD FS performance counters collect.</span></span> 
* <span data-ttu-id="cd891-257">A integridade geral do sistema AD FS e dos aplicativos Web (terceiras partes confiáveis) e fornece alertas sobre problemas críticos e avisos.</span><span class="sxs-lookup"><span data-stu-id="cd891-257">The overall health of the AD FS system and web applications (relying parties), and provides alerts for critical issues and warnings.</span></span> 

## <a name="scalability-considerations"></a><span data-ttu-id="cd891-258">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="cd891-258">Scalability considerations</span></span>

<span data-ttu-id="cd891-259">As considerações a seguir, resumidas do artigo [Planejar sua implantação do AD FS][plan-your-adfs-deployment], oferecem um ponto inicial para o dimensionamento de farms do AD FS:</span><span class="sxs-lookup"><span data-stu-id="cd891-259">The following considerations, summarized from the article [Plan your AD FS deployment][plan-your-adfs-deployment], give a starting point for sizing AD FS farms:</span></span>

* <span data-ttu-id="cd891-260">Se você tiver menos de mil usuários, não crie servidores dedicados. Nesse caso, instale o AD FS em cada um dos servidores do Active Directory DS na nuvem.</span><span class="sxs-lookup"><span data-stu-id="cd891-260">If you have fewer than 1000 users, do not create dedicated servers, but instead install AD FS on each of the Active Directory DS servers in the cloud.</span></span> <span data-ttu-id="cd891-261">Verifique se há pelo menos dois servidores do Active Directory DS para manter a disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="cd891-261">Make sure that you have at least two Active Directory DS servers to maintain availability.</span></span> <span data-ttu-id="cd891-262">Crie um único servidor do WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-262">Create a single WAP server.</span></span>
* <span data-ttu-id="cd891-263">Se você tiver entre mil e 15 mil usuários, crie dois servidores do AD FS dedicados e dois servidores do WAP dedicados.</span><span class="sxs-lookup"><span data-stu-id="cd891-263">If you have between 1000 and 15000 users, create two dedicated AD FS servers and two dedicated WAP servers.</span></span>
* <span data-ttu-id="cd891-264">Se você tiver entre 15 mil e 60 mil usuários, crie entre três e cinco servidores do AD FS dedicados e pelo menos dois servidores do WAP dedicados.</span><span class="sxs-lookup"><span data-stu-id="cd891-264">If you have between 15000 and 60000 users, create between three and five dedicated AD FS servers and at least two dedicated WAP servers.</span></span>

<span data-ttu-id="cd891-265">Essas considerações presumem que você esteja usando um tamanho de VM quad-core dual (D4_v2 padrão ou melhor) no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-265">These considerations assume that you are using dual quad-core VM (Standard D4_v2, or better) sizes in Azure.</span></span>

<span data-ttu-id="cd891-266">Se você estiver usando o Banco de Dados Interno do Windows para armazenar dados de configuração do AD FS, haverá o limite de oito servidores do AD FS no farm.</span><span class="sxs-lookup"><span data-stu-id="cd891-266">If you are using the Windows Internal Database to store AD FS configuration data, you are limited to eight AD FS servers in the farm.</span></span> <span data-ttu-id="cd891-267">Se você conseguir prever que precisará de mais no futuro, use o SQL Server.</span><span class="sxs-lookup"><span data-stu-id="cd891-267">If you anticipate that you will need more in the future, use SQL Server.</span></span> <span data-ttu-id="cd891-268">Para obter mais informações, consulte [A função do banco de dados de configuração do AD FS][adfs-configuration-database].</span><span class="sxs-lookup"><span data-stu-id="cd891-268">For more information, see [The Role of the AD FS Configuration Database][adfs-configuration-database].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="cd891-269">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="cd891-269">Availability considerations</span></span>

<span data-ttu-id="cd891-270">Você pode usar o SQL Server ou o Banco de Dados Interno do Windows para manter as informações de configuração do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-270">You can use either SQL Server or the Windows Internal Database to hold AD FS configuration information.</span></span> <span data-ttu-id="cd891-271">O Banco de Dados Interno do Windows fornece redundância básica.</span><span class="sxs-lookup"><span data-stu-id="cd891-271">The Windows Internal Database provides basic redundancy.</span></span> <span data-ttu-id="cd891-272">As alterações são gravadas diretamente em apenas um dos bancos de dados do AD FS no cluster do AD FS, enquanto os outros servidores usam a replicação pull para manter seus bancos de dados atualizados.</span><span class="sxs-lookup"><span data-stu-id="cd891-272">Changes are written directly to only one of the AD FS databases in the AD FS cluster, while the other servers use pull replication to keep their databases up to date.</span></span> <span data-ttu-id="cd891-273">O uso do SQL Server pode fornecer redundância total de banco de dados e alta disponibilidade usando clustering de failover ou espelhamento.</span><span class="sxs-lookup"><span data-stu-id="cd891-273">Using SQL Server can provide full database redundancy and high availability using failover clustering or mirroring.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="cd891-274">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="cd891-274">Manageability considerations</span></span>

<span data-ttu-id="cd891-275">A equipe de DevOps deve estar preparada para executar as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="cd891-275">DevOps staff should be prepared to perform the following tasks:</span></span>

* <span data-ttu-id="cd891-276">Gerenciamento dos servidores de federação, incluindo o gerenciamento de farm do AD FS, gerenciamento de política de confiança em servidores de federação e gerenciamento dos certificados usados pelos serviços de federação.</span><span class="sxs-lookup"><span data-stu-id="cd891-276">Managing the federation servers, including managing the AD FS farm, managing trust policy on the federation servers, and managing the certificates used by the federation services.</span></span>
* <span data-ttu-id="cd891-277">Gerenciamento de servidores do WAP, incluindo o gerenciamento de farm e certificados do WAP.</span><span class="sxs-lookup"><span data-stu-id="cd891-277">Managing the WAP servers including managing the WAP farm and certificates.</span></span>
* <span data-ttu-id="cd891-278">Gerenciamento de aplicativos Web, incluindo configuração de terceiras partes confiáveis, métodos de autenticação e mapeamentos de declarações.</span><span class="sxs-lookup"><span data-stu-id="cd891-278">Managing web applications including configuring relying parties, authentication methods, and claims mappings.</span></span>
* <span data-ttu-id="cd891-279">Fazendo backup de componentes do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-279">Backing up AD FS components.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="cd891-280">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="cd891-280">Security considerations</span></span>

<span data-ttu-id="cd891-281">O AD FS usa o protocolo HTTPS, portanto, verifique se as regras do NSG da sub-rede que contém as VMs da camada da Web permitem solicitações HTTPS.</span><span class="sxs-lookup"><span data-stu-id="cd891-281">AD FS utilizes the HTTPS protocol, so make sure that the NSG rules for the subnet containing the web tier VMs permit HTTPS requests.</span></span> <span data-ttu-id="cd891-282">Essas solicitações podem ser originadas na rede local, nas sub-redes que contém a camada da Web, na camada de negócios, na camada de dados, no DMZ privado, no DMZ público e na sub-rede que contém os servidores do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-282">These requests can originate from the on-premises network, the subnets containing the web tier, business tier, data tier, private DMZ, public DMZ, and the subnet containing the AD FS servers.</span></span>

<span data-ttu-id="cd891-283">Considere usar um conjunto de soluções de virtualização de rede que registre informações detalhadas sobre o tráfego que atravessa a borda da sua rede virtual para fins de auditoria.</span><span class="sxs-lookup"><span data-stu-id="cd891-283">Consider using a set of network virtual appliances that logs detailed information on traffic traversing the edge of your virtual network for auditing purposes.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="cd891-284">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="cd891-284">Deploy the solution</span></span>

<span data-ttu-id="cd891-285">Há uma solução disponível no [GitHub][github] para implantar essa arquitetura de referência.</span><span class="sxs-lookup"><span data-stu-id="cd891-285">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="cd891-286">Você precisará da versão mais recente da [CLI do Azure][azure-cli] para executar o script do Powershell que implanta a solução.</span><span class="sxs-lookup"><span data-stu-id="cd891-286">You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="cd891-287">Para implantar a arquitetura de referência, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="cd891-287">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="cd891-288">Baixe ou clone a pasta da solução do [GitHub][github] em seu computador local.</span><span class="sxs-lookup"><span data-stu-id="cd891-288">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="cd891-289">Abra a CLI do Azure e navegue até a pasta da solução local.</span><span class="sxs-lookup"><span data-stu-id="cd891-289">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="cd891-290">Execute o comando a seguir:</span><span class="sxs-lookup"><span data-stu-id="cd891-290">Run the following command:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    <span data-ttu-id="cd891-291">Substitua `<subscription id>` por sua ID da assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-291">Replace `<subscription id>` with your Azure subscription ID.</span></span>
   
    <span data-ttu-id="cd891-292">Para `<location>`, especifique uma região do Azure, como `eastus` ou `westus`.</span><span class="sxs-lookup"><span data-stu-id="cd891-292">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>
   
    <span data-ttu-id="cd891-293">O parâmetro `<mode>` controla a granularidade da implantação e pode ter um dos seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="cd891-293">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>
   
   * <span data-ttu-id="cd891-294">`Onpremise`: implanta um ambiente local simulado.</span><span class="sxs-lookup"><span data-stu-id="cd891-294">`Onpremise`: Deploys a simulated on-premises environment.</span></span> <span data-ttu-id="cd891-295">Se não houver uma rede local existente ou se você desejar testar esta arquitetura de referência sem alterar a configuração da rede local existente, use esta implantação para testar e experimentar.</span><span class="sxs-lookup"><span data-stu-id="cd891-295">You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.</span></span>
   * <span data-ttu-id="cd891-296">`Infrastructure`: implanta a infraestrutura da VNet e o jumpbox.</span><span class="sxs-lookup"><span data-stu-id="cd891-296">`Infrastructure`: deploys the VNet infrastructure and jump box.</span></span>
   * <span data-ttu-id="cd891-297">`CreateVpn`: implanta um gateway de rede virtual do Azure e conecta-o à rede local simulada.</span><span class="sxs-lookup"><span data-stu-id="cd891-297">`CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   * <span data-ttu-id="cd891-298">`AzureADDS`: implanta as VMs que atuam como servidores do Active Directory DS, implanta o Active Directory nessas VMs e cria o domínio no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-298">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.</span></span>
   * <span data-ttu-id="cd891-299">`AdfsVm`: implanta as VMs do AD FS e a ingressa-as no domínio no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-299">`AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="cd891-300">`PublicDMZ`: implanta o DMZ público no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-300">`PublicDMZ`: deploys the public DMZ in Azure.</span></span>
   * <span data-ttu-id="cd891-301">`ProxyVm`: implanta as VMs de proxy do AD FS e ingressa-as no domínio no Azure.</span><span class="sxs-lookup"><span data-stu-id="cd891-301">`ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="cd891-302">`Prepare`: implanta todas as implantações anteriores.</span><span class="sxs-lookup"><span data-stu-id="cd891-302">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="cd891-303">**Essa será a opção recomendada se você estiver criando uma implantação totalmente nova e não tiver uma infraestrutura local existente.**</span><span class="sxs-lookup"><span data-stu-id="cd891-303">**This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.**</span></span> 
   * <span data-ttu-id="cd891-304">`Workload`: opcionalmente, implanta VMs de camada de dados, de negócios e da Web e a rede de apoio.</span><span class="sxs-lookup"><span data-stu-id="cd891-304">`Workload`: optionally deploys web, business, and data tier VMs and supporting network.</span></span> <span data-ttu-id="cd891-305">Não incluído no modo de implantação `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="cd891-305">Not included in the `Prepare` deployment mode.</span></span>
   * <span data-ttu-id="cd891-306">`PrivateDMZ`: opcionalmente, implanta o DMZ privado no Azure na frente das VMs de `Workload` implantadas acima.</span><span class="sxs-lookup"><span data-stu-id="cd891-306">`PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above.</span></span> <span data-ttu-id="cd891-307">Não incluído no modo de implantação `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="cd891-307">Not included in the `Prepare` deployment mode.</span></span>

4. <span data-ttu-id="cd891-308">Aguarde até que a implantação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="cd891-308">Wait for the deployment to complete.</span></span> <span data-ttu-id="cd891-309">Se você usar a opção `Prepare`, a implantação levará várias horas para ser concluída e terminará com a mensagem `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span><span class="sxs-lookup"><span data-stu-id="cd891-309">If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span></span>

5. <span data-ttu-id="cd891-310">Reinicie o jumpbox (*ra-adfs-mgmt-vm1* no grupo *ra-adfs-security-rg*) para permitir que suas configurações de DNS entrem em vigor.</span><span class="sxs-lookup"><span data-stu-id="cd891-310">Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.</span></span>

6. <span data-ttu-id="cd891-311">[Obtenha um certificado SSL para o AD FS][adfs_certificates] e instale esse certificado nas VMs do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-311">[Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs.</span></span> <span data-ttu-id="cd891-312">Observe que é possível se conectar a eles por meio do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="cd891-312">Note that you can connect to them through the jump box.</span></span> <span data-ttu-id="cd891-313">Os endereços IP são <em>10.0.5.4</em> e <em>10.0.5.5</em>.</span><span class="sxs-lookup"><span data-stu-id="cd891-313">The IP addresses are <em>10.0.5.4</em> and <em>10.0.5.5</em>.</span></span> <span data-ttu-id="cd891-314">O nome de usuário padrão é <em>contoso\testuser</em> com a senha <em>AweSome@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="cd891-314">The default username is <em>contoso\testuser</em> with password <em>AweSome@PW</em>.</span></span>
   
   > [!NOTE]
   > <span data-ttu-id="cd891-315">Neste ponto, os comentários no script Deploy-ReferenceArchitecture.ps1 fornecem instruções detalhadas para criar um certificado de teste autoassinado e uma autoridade usando o comando `makecert`.</span><span class="sxs-lookup"><span data-stu-id="cd891-315">The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command.</span></span> <span data-ttu-id="cd891-316">No entanto, execute estas etapas apenas como um **teste** e não use os certificados gerados por makecert em um ambiente de produção.</span><span class="sxs-lookup"><span data-stu-id="cd891-316">However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.</span></span>
   > 
   > 

7. <span data-ttu-id="cd891-317">Execute o seguinte comando do PowerShell para implantar o farm de servidores do AD FS:</span><span class="sxs-lookup"><span data-stu-id="cd891-317">Run the following PowerShell command to deploy the AD FS server farm:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ``` 

8. <span data-ttu-id="cd891-318">No jumpbox, navegue até `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` para testar a instalação do AD FS (você receberá um aviso que poderá ser ignorado para este teste).</span><span class="sxs-lookup"><span data-stu-id="cd891-318">On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test).</span></span> <span data-ttu-id="cd891-319">Verifique se a página de conexão da Contoso Corporation é exibida.</span><span class="sxs-lookup"><span data-stu-id="cd891-319">Verify that the Contoso Corporation sign-in page appears.</span></span> <span data-ttu-id="cd891-320">Entre como <em>contoso\testuser</em> com senha a <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="cd891-320">Sign in as <em>contoso\testuser</em> with password <em>AweS0me@PW</em>.</span></span>

9. <span data-ttu-id="cd891-321">Instale o certificado SSL nas VMs de proxy do AD FS.</span><span class="sxs-lookup"><span data-stu-id="cd891-321">Install the SSL certificate on the AD FS proxy VMs.</span></span> <span data-ttu-id="cd891-322">Os endereços IP são *10.0.6.4* e *10.0.6.5*.</span><span class="sxs-lookup"><span data-stu-id="cd891-322">The IP addresses are *10.0.6.4* and *10.0.6.5*.</span></span>

10. <span data-ttu-id="cd891-323">Execute o seguinte comando do PowerShell para implantar o primeiro servidor proxy do AD FS:</span><span class="sxs-lookup"><span data-stu-id="cd891-323">Run the following PowerShell command to deploy the first AD FS proxy server:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. <span data-ttu-id="cd891-324">Siga as instruções exibidas pelo script para testar a instalação do primeiro servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="cd891-324">Follow the instructions displayed by the script to test the installation of the first proxy server.</span></span>

12. <span data-ttu-id="cd891-325">Execute o seguinte comando do PowerShell para implantar o segundo servidor proxy:</span><span class="sxs-lookup"><span data-stu-id="cd891-325">Run the following PowerShell command to deploy the second proxy server:</span></span>
    
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. <span data-ttu-id="cd891-326">Siga as instruções exibidas pelo script para testar a configuração de proxy completa.</span><span class="sxs-lookup"><span data-stu-id="cd891-326">Follow the instructions displayed by the script to test the complete proxy configuration.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cd891-327">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="cd891-327">Next steps</span></span>

* <span data-ttu-id="cd891-328">Saiba mais sobre o [Azure Active Directory][aad].</span><span class="sxs-lookup"><span data-stu-id="cd891-328">Learn about [Azure Active Directory][aad].</span></span>
* <span data-ttu-id="cd891-329">Saiba mais sobre o [Azure Active Directory B2C][aadb2c].</span><span class="sxs-lookup"><span data-stu-id="cd891-329">Learn about [Azure Active Directory B2C][aadb2c].</span></span>

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: https://technet.microsoft.com/windowsserver/dd448613.aspx
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  /windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[aad]: https://azure.microsoft.com/documentation/services/active-directory/
[aadb2c]: https://azure.microsoft.com/documentation/services/active-directory-b2c/
[adfs-intro]: /azure/active-directory/hybrid/whatis-hybrid-identity
[github]: https://github.com/mspnp/identity-reference-architectures/tree/master/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
[0]: ./images/adfs.png "Arquitetura de rede híbrida segura com o Active Directory"

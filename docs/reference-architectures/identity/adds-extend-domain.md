---
title: Estender o AD DS (Active Directory Domain Services) para o Azure
titleSuffix: Azure Reference Architectures
description: Estender o seu domínio do Active Directory local para o Azure.
author: telmosampaio
ms.date: 05/02/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, identity
ms.openlocfilehash: 4e22469af58a08f42abedf34235be5e20f1dceae
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54482350"
---
# <a name="extend-active-directory-domain-services-ad-ds-to-azure"></a><span data-ttu-id="d56ff-103">Estender o AD DS (Active Directory Domain Services) para o Azure</span><span class="sxs-lookup"><span data-stu-id="d56ff-103">Extend Active Directory Domain Services (AD DS) to Azure</span></span>

<span data-ttu-id="d56ff-104">Essa arquitetura de referência mostra como estender seu ambiente do Active Directory para o Azure a fim de fornecer serviços de autenticação distribuídos usando o AD DS (Active Directory Domain Services).</span><span class="sxs-lookup"><span data-stu-id="d56ff-104">This reference architecture shows how to extend your Active Directory environment to Azure to provide distributed authentication services using Active Directory Domain Services (AD DS).</span></span> <span data-ttu-id="d56ff-105">[**Implantar esta solução**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="d56ff-105">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Arquitetura de rede híbrida segura com o Active Directory](./images/adds-extend-domain.png)

<span data-ttu-id="d56ff-107">*Baixe um [Arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="d56ff-107">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="d56ff-108">O AD DS é usado para autenticar o usuário, computador, aplicativo ou outras identidades incluídas em um domínio de segurança.</span><span class="sxs-lookup"><span data-stu-id="d56ff-108">AD DS is used to authenticate user, computer, application, or other identities that are included in a security domain.</span></span> <span data-ttu-id="d56ff-109">Ele poderá ser hospedado localmente, mas se o aplicativo estiver hospedado parcialmente localmente e parcialmente no Azure, será mais eficiente replicar essa funcionalidade no Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-109">It can be hosted on-premises, but if your application is hosted partly on-premises and partly in Azure, it may be more efficient to replicate this functionality in Azure.</span></span> <span data-ttu-id="d56ff-110">Isso pode reduzir a latência causada pelo envio de autenticação e solicitações de autorização local da nuvem de volta para o AD DS em execução local.</span><span class="sxs-lookup"><span data-stu-id="d56ff-110">This can reduce the latency caused by sending authentication and local authorization requests from the cloud back to AD DS running on-premises.</span></span>

<span data-ttu-id="d56ff-111">Essa arquitetura é geralmente usada quando a rede local e a rede virtual do Azure estão conectadas por uma conexão VPN ou de ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="d56ff-111">This architecture is commonly used when the on-premises network and the Azure virtual network are connected by a VPN or ExpressRoute connection.</span></span> <span data-ttu-id="d56ff-112">Essa arquitetura também dá suporte à replicação bidirecional, o que significa que alterações podem ser feitas localmente ou na nuvem, e ambas as fontes serão mantidas consistentes.</span><span class="sxs-lookup"><span data-stu-id="d56ff-112">This architecture also supports bidirectional replication, meaning changes can be made either on-premises or in the cloud, and both sources will be kept consistent.</span></span> <span data-ttu-id="d56ff-113">Usos típicos dessa arquitetura incluem aplicativos híbridos em que a funcionalidade é distribuída entre o local e o Azure, e os aplicativos e serviços que realizam autenticação usando o Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d56ff-113">Typical uses for this architecture include hybrid applications in which functionality is distributed between on-premises and Azure, and applications and services that perform authentication using Active Directory.</span></span>

<span data-ttu-id="d56ff-114">Para obter considerações adicionais, consulte [Escolher uma solução para a integração do Active Directory local ao Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="d56ff-114">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span>

## <a name="architecture"></a><span data-ttu-id="d56ff-115">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="d56ff-115">Architecture</span></span>

<span data-ttu-id="d56ff-116">Essa arquitetura estende aquela mostrada em [DMZ entre o Azure e a Internet][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="d56ff-116">This architecture extends the architecture shown in [DMZ between Azure and the Internet][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="d56ff-117">Ela tem os seguintes componentes.</span><span class="sxs-lookup"><span data-stu-id="d56ff-117">It has the following components.</span></span>

- <span data-ttu-id="d56ff-118">**Rede local**.</span><span class="sxs-lookup"><span data-stu-id="d56ff-118">**On-premises network**.</span></span> <span data-ttu-id="d56ff-119">A rede local inclui servidores locais do Active Directory que podem realizar a autenticação e autorização para componentes localizados localmente.</span><span class="sxs-lookup"><span data-stu-id="d56ff-119">The on-premises network includes local Active Directory servers that can perform authentication and authorization for components located on-premises.</span></span>
- <span data-ttu-id="d56ff-120">**Servidores do Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="d56ff-120">**Active Directory servers**.</span></span> <span data-ttu-id="d56ff-121">Esses são controladores de domínio que implementam serviços de diretório (AD DS) em execução como VMs na nuvem.</span><span class="sxs-lookup"><span data-stu-id="d56ff-121">These are domain controllers implementing directory services (AD DS) running as VMs in the cloud.</span></span> <span data-ttu-id="d56ff-122">Esses servidores podem fornecer autenticação dos componentes em execução na sua rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-122">These servers can provide authentication of components running in your Azure virtual network.</span></span>
- <span data-ttu-id="d56ff-123">**Sub-rede do Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="d56ff-123">**Active Directory subnet**.</span></span> <span data-ttu-id="d56ff-124">Os servidores do AD DS são hospedados em uma sub-rede separada.</span><span class="sxs-lookup"><span data-stu-id="d56ff-124">The AD DS servers are hosted in a separate subnet.</span></span> <span data-ttu-id="d56ff-125">As regras de NSG (grupo de segurança de rede) protegem os servidores do AD DS e fornecem um firewall em tráfego de fontes inesperadas.</span><span class="sxs-lookup"><span data-stu-id="d56ff-125">Network security group (NSG) rules protect the AD DS servers and provide a firewall against traffic from unexpected sources.</span></span>
- <span data-ttu-id="d56ff-126">**Sincronização do Gateway do Azure e do Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="d56ff-126">**Azure Gateway and Active Directory synchronization**.</span></span> <span data-ttu-id="d56ff-127">O gateway do Azure fornece uma conexão entre a rede local e a VNet do Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-127">The Azure gateway provides a connection between the on-premises network and the Azure VNet.</span></span> <span data-ttu-id="d56ff-128">Essa pode ser uma [conexão VPN][azure-vpn-gateway] ou do [Azure ExpressRoute][azure-expressroute].</span><span class="sxs-lookup"><span data-stu-id="d56ff-128">This can be a [VPN connection][azure-vpn-gateway] or [Azure ExpressRoute][azure-expressroute].</span></span> <span data-ttu-id="d56ff-129">Todas as solicitações de sincronização entre os servidores do Active Directory na nuvem e local passam pelo gateway.</span><span class="sxs-lookup"><span data-stu-id="d56ff-129">All synchronization requests between the Active Directory servers in the cloud and on-premises pass through the gateway.</span></span> <span data-ttu-id="d56ff-130">UDRs (rotas definidas pelo usuário) lidar com o roteamento para o tráfego local passado para o Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-130">User-defined routes (UDRs) handle routing for on-premises traffic that passes to Azure.</span></span> <span data-ttu-id="d56ff-131">Tráfego de e para os servidores do Active Directory não passa pelas NVAs (soluções de virtualização de rede) usadas nesse cenário.</span><span class="sxs-lookup"><span data-stu-id="d56ff-131">Traffic to and from the Active Directory servers does not pass through the network virtual appliances (NVAs) used in this scenario.</span></span>

<span data-ttu-id="d56ff-132">Para obter mais informações sobre como configurar UDRs e as NVAs, consulte [Implementar uma arquitetura de rede híbrida segura no Azure][implementing-a-secure-hybrid-network-architecture].</span><span class="sxs-lookup"><span data-stu-id="d56ff-132">For more information about configuring UDRs and the NVAs, see [Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture].</span></span>

## <a name="recommendations"></a><span data-ttu-id="d56ff-133">Recomendações</span><span class="sxs-lookup"><span data-stu-id="d56ff-133">Recommendations</span></span>

<span data-ttu-id="d56ff-134">As seguintes recomendações aplicam-se à maioria dos cenários.</span><span class="sxs-lookup"><span data-stu-id="d56ff-134">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="d56ff-135">Siga estas recomendações, a menos que você tenha um requisito específico que as substitua.</span><span class="sxs-lookup"><span data-stu-id="d56ff-135">Follow these recommendations unless you have a specific requirement that overrides them.</span></span>

### <a name="vm-recommendations"></a><span data-ttu-id="d56ff-136">Recomendações de VM</span><span class="sxs-lookup"><span data-stu-id="d56ff-136">VM recommendations</span></span>

<span data-ttu-id="d56ff-137">Determine seus requisitos de [tamanho da VM][vm-windows-sizes] com base no volume esperado de solicitações de autenticação.</span><span class="sxs-lookup"><span data-stu-id="d56ff-137">Determine your [VM size][vm-windows-sizes] requirements based on the expected volume of authentication requests.</span></span> <span data-ttu-id="d56ff-138">Use as especificações de computadores que hospedam o AD DS local como um ponto de partida e corresponda-as aos tamanhos de VM do Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-138">Use the specifications of the machines hosting AD DS on premises as a starting point, and match them with the Azure VM sizes.</span></span> <span data-ttu-id="d56ff-139">Uma vez implantada, monitore a utilização e a escala ou redução vertical com base na carga real das VMs.</span><span class="sxs-lookup"><span data-stu-id="d56ff-139">Once deployed, monitor utilization and scale up or down based on the actual load on the VMs.</span></span> <span data-ttu-id="d56ff-140">Para obter mais informações sobre o dimensionamento de controladores de domínio do AD DS, consulte [Planejamento de capacidade para Active Directory Domain Services][capacity-planning-for-adds].</span><span class="sxs-lookup"><span data-stu-id="d56ff-140">For more information about sizing AD DS domain controllers, see [Capacity Planning for Active Directory Domain Services][capacity-planning-for-adds].</span></span>

<span data-ttu-id="d56ff-141">Crie um disco de dados virtual separado para armazenar o banco de dados, logs e SYSVOL do Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d56ff-141">Create a separate virtual data disk for storing the database, logs, and SYSVOL for Active Directory.</span></span> <span data-ttu-id="d56ff-142">Não armazene esses itens no mesmo disco do sistema operacional.</span><span class="sxs-lookup"><span data-stu-id="d56ff-142">Do not store these items on the same disk as the operating system.</span></span> <span data-ttu-id="d56ff-143">Observe que, por padrão, os disco de dados que estão anexados a uma VM usam cache write-through.</span><span class="sxs-lookup"><span data-stu-id="d56ff-143">Note that by default, data disks that are attached to a VM use write-through caching.</span></span> <span data-ttu-id="d56ff-144">No entanto, essa forma de armazenamento em cache pode entrar em conflito com os requisitos do AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-144">However, this form of caching can conflict with the requirements of AD DS.</span></span> <span data-ttu-id="d56ff-145">Por esse motivo, defina a configuração de *Preferência de Cache do Host* no disco de dados para *Nenhum*.</span><span class="sxs-lookup"><span data-stu-id="d56ff-145">For this reason, set the *Host Cache Preference* setting on the data disk to *None*.</span></span> <span data-ttu-id="d56ff-146">Para obter mais informações, confira [Diretrizes para implantar o Active Directory do Windows Server em máquinas virtuais do Azure][adds-data-disks].</span><span class="sxs-lookup"><span data-stu-id="d56ff-146">For more information, see [Guidelines for Deploying Windows Server Active Directory on Azure Virtual Machines][adds-data-disks].</span></span>

<span data-ttu-id="d56ff-147">Implante pelo menos duas VMs que executam o AD DS como controladores de domínio e adicione-as a um [conjunto de disponibilidade][availability-set].</span><span class="sxs-lookup"><span data-stu-id="d56ff-147">Deploy at least two VMs running AD DS as domain controllers and add them to an [availability set][availability-set].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="d56ff-148">Recomendações de rede</span><span class="sxs-lookup"><span data-stu-id="d56ff-148">Networking recommendations</span></span>

<span data-ttu-id="d56ff-149">Configure o NIC (adaptador de rede) da VM para cada servidor do AD DS com um endereço IP privado estático para suporte a DNS (Serviço de Nomes de Domínio).</span><span class="sxs-lookup"><span data-stu-id="d56ff-149">Configure the VM network interface (NIC) for each AD DS server with a static private IP address for full domain name service (DNS) support.</span></span> <span data-ttu-id="d56ff-150">Para obter mais informações, consulte [Como definir um endereço IP privado estático no Portal do Azure][set-a-static-ip-address].</span><span class="sxs-lookup"><span data-stu-id="d56ff-150">For more information, see [How to set a static private IP address in the Azure portal][set-a-static-ip-address].</span></span>

> [!NOTE]
> <span data-ttu-id="d56ff-151">Não configure a NIC de VM para qualquer AD DS com um endereço IP público.</span><span class="sxs-lookup"><span data-stu-id="d56ff-151">Do not configure the VM NIC for any AD DS with a public IP address.</span></span> <span data-ttu-id="d56ff-152">Consulte [Considerações de segurança][security-considerations] para ver mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="d56ff-152">See [Security considerations][security-considerations] for more details.</span></span>
>

<span data-ttu-id="d56ff-153">O NSG da sub-rede do Active Directory requer regras para permitir tráfego de entrada do local.</span><span class="sxs-lookup"><span data-stu-id="d56ff-153">The Active Directory subnet NSG requires rules to permit incoming traffic from on-premises.</span></span> <span data-ttu-id="d56ff-154">Para obter informações detalhadas sobre as portas usadas pelo AD DS, consulte [Requisitos de porta do Active Directory e do Active Directory Domain Services][ad-ds-ports].</span><span class="sxs-lookup"><span data-stu-id="d56ff-154">For detailed information on the ports used by AD DS, see [Active Directory and Active Directory Domain Services Port Requirements][ad-ds-ports].</span></span> <span data-ttu-id="d56ff-155">Além disso, verifique se as tabelas UDR não roteiam o tráfego do AD DS por meio de NVAs usadas nesta arquitetura.</span><span class="sxs-lookup"><span data-stu-id="d56ff-155">Also, ensure the UDR tables do not route AD DS traffic through the NVAs used in this architecture.</span></span>

### <a name="active-directory-site"></a><span data-ttu-id="d56ff-156">Site do Active Directory</span><span class="sxs-lookup"><span data-stu-id="d56ff-156">Active Directory site</span></span>

<span data-ttu-id="d56ff-157">No AD DS, um site representa um local físico, uma rede ou uma coleção de dispositivos.</span><span class="sxs-lookup"><span data-stu-id="d56ff-157">In AD DS, a site represents a physical location, network, or collection of devices.</span></span> <span data-ttu-id="d56ff-158">Os sites do AD DS são usados para gerenciar a replicação de banco de dados do AD DS agrupando objetos do AD DS que se encontram próximos uns dos outros e são conectados por uma rede de alta velocidade.</span><span class="sxs-lookup"><span data-stu-id="d56ff-158">AD DS sites are used to manage AD DS database replication by grouping together AD DS objects that are located close to one another and are connected by a high speed network.</span></span> <span data-ttu-id="d56ff-159">O AD DS inclui lógica para selecionar a melhor estratégia para replicar o banco de dados do AD DS entre sites.</span><span class="sxs-lookup"><span data-stu-id="d56ff-159">AD DS includes logic to select the best strategy for replacating the AD DS database between sites.</span></span>

<span data-ttu-id="d56ff-160">É recomendável que você crie um site do AD DS que inclua as sub-redes definidas para seu aplicativo no Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-160">We recommend that you create an AD DS site including the subnets defined for your application in Azure.</span></span> <span data-ttu-id="d56ff-161">Em seguida, configure um link de site entre seus sites AD DS locais e o AD DS executará automaticamente a replicação de banco de dados mais eficiente possível.</span><span class="sxs-lookup"><span data-stu-id="d56ff-161">Then, configure a site link between your on-premises AD DS sites, and AD DS will automatically perform the most efficient database replication possible.</span></span> <span data-ttu-id="d56ff-162">Observe que essa replicação de banco de dados exige pouco além da configuração inicial.</span><span class="sxs-lookup"><span data-stu-id="d56ff-162">Note that this database replication requires little beyond the initial configuration.</span></span>

### <a name="active-directory-operations-masters"></a><span data-ttu-id="d56ff-163">Mestres de operações do Active Directory</span><span class="sxs-lookup"><span data-stu-id="d56ff-163">Active Directory operations masters</span></span>

<span data-ttu-id="d56ff-164">A função de mestres de operações pode ser atribuída aos controladores de domínio do AD DS para dar suporte à verificação de consistência entre instâncias de bancos de dados replicados do AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-164">The operations masters role can be assigned to AD DS domain controllers to support consistency checking between instances of replicated AD DS databases.</span></span> <span data-ttu-id="d56ff-165">Existem cinco funções de mestre de operações: mestre de esquema, mestre de nomeação de domínios, mestre identificador relativo, emulador mestre do controlador de domínio primário e mestre de infraestrutura.</span><span class="sxs-lookup"><span data-stu-id="d56ff-165">There are five operations master roles: schema master, domain naming master, relative identifier master, primary domain controller master emulator, and infrastructure master.</span></span> <span data-ttu-id="d56ff-166">Para obter mais informações sobre essas funções, consulte [O que são Mestres de Operações?][ad-ds-operations-masters].</span><span class="sxs-lookup"><span data-stu-id="d56ff-166">For more information about these roles, see [What are Operations Masters?][ad-ds-operations-masters].</span></span>

<span data-ttu-id="d56ff-167">Recomendamos que você não atribua funções de mestres de operações para os controladores de domínio implantados no Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-167">We recommend you do not assign operations masters roles to the domain controllers deployed in Azure.</span></span>

### <a name="monitoring"></a><span data-ttu-id="d56ff-168">Monitoramento</span><span class="sxs-lookup"><span data-stu-id="d56ff-168">Monitoring</span></span>

<span data-ttu-id="d56ff-169">Monitore os recursos de VMs do controlador de domínio, bem como os serviços do AD DS e crie um plano para corrigir rapidamente os problemas.</span><span class="sxs-lookup"><span data-stu-id="d56ff-169">Monitor the resources of the domain controller VMs as well as the AD DS Services and create a plan to quickly correct any problems.</span></span> <span data-ttu-id="d56ff-170">Para obter mais informações, consulte [Monitoramento do Active Directory][monitoring_ad].</span><span class="sxs-lookup"><span data-stu-id="d56ff-170">For more information, see [Monitoring Active Directory][monitoring_ad].</span></span> <span data-ttu-id="d56ff-171">Você também pode instalar ferramentas como o [Microsoft Systems Center][microsoft_systems_center] no servidor de monitoramento (consulte o diagrama de arquitetura) para ajudar a executar essas tarefas.</span><span class="sxs-lookup"><span data-stu-id="d56ff-171">You can also install tools such as [Microsoft Systems Center][microsoft_systems_center] on the monitoring server (see the architecture diagram) to help perform these tasks.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="d56ff-172">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="d56ff-172">Scalability considerations</span></span>

<span data-ttu-id="d56ff-173">O AD DS foi projetado visando a escalabilidade.</span><span class="sxs-lookup"><span data-stu-id="d56ff-173">AD DS is designed for scalability.</span></span> <span data-ttu-id="d56ff-174">Não é necessário configurar um balanceador de carga ou controlador de tráfego para direcionar solicitações para os controladores de domínio do AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-174">You don't need to configure a load balancer or traffic controller to direct requests to AD DS domain controllers.</span></span> <span data-ttu-id="d56ff-175">A única consideração de escalabilidade é configurar as VMs em execução no AD DS com o tamanho correto para os requisitos de carga da sua rede, monitorar a carga nas VMs e escalar ou reduzir verticalmente conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="d56ff-175">The only scalability consideration is to configure the VMs running AD DS with the correct size for your network load requirements, monitor the load on the VMs, and scale up or down as necessary.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="d56ff-176">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="d56ff-176">Availability considerations</span></span>

<span data-ttu-id="d56ff-177">Implante as VMs que executam o AD DS em um [conjunto de disponibilidade][availability-set].</span><span class="sxs-lookup"><span data-stu-id="d56ff-177">Deploy the VMs running AD DS into an [availability set][availability-set].</span></span> <span data-ttu-id="d56ff-178">Além disso, considere atribuir a função de [mestre de operações em espera][standby-operations-masters] a pelo menos um servidor e possivelmente mais de um, dependendo dos seus requisitos.</span><span class="sxs-lookup"><span data-stu-id="d56ff-178">Also, consider assigning the role of [standby operations master][standby-operations-masters] to at least one server, and possibly more depending on your requirements.</span></span> <span data-ttu-id="d56ff-179">Um mestre de operações em espera é uma cópia ativa do mestre de operações que pode ser usada no lugar do servidor mestre de operações principal durante o failover.</span><span class="sxs-lookup"><span data-stu-id="d56ff-179">A standby operations master is an active copy of the operations master that can be used in place of the primary operations masters server during fail over.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="d56ff-180">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="d56ff-180">Manageability considerations</span></span>

<span data-ttu-id="d56ff-181">Execute backups regulares do AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-181">Perform regular AD DS backups.</span></span> <span data-ttu-id="d56ff-182">Não basta copiar os arquivos VHD de controladores de domínio em vez de executar backups regulares, pois o aquivo de banco de dados do AD DS pode não estar em um estado consistente quando for copiado, impossibilitando a reinicialização do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d56ff-182">Don't simply copy the VHD files of domain controllers instead of performing regular backups, because the AD DS database file on the VHD may not be in a consistent state when it's copied, making it impossible to restart the database.</span></span>

<span data-ttu-id="d56ff-183">Não desative uma VM do controlador de domínio usando o Portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-183">Do not shut down a domain controller VM using Azure portal.</span></span> <span data-ttu-id="d56ff-184">Em vez disso, desligue e reinicie o sistema operacional convidado.</span><span class="sxs-lookup"><span data-stu-id="d56ff-184">Instead, shut down and restart from the guest operating system.</span></span> <span data-ttu-id="d56ff-185">Desligar por meio do portal faz com que a VM seja desalocada, o que redefine ambos o `VM-GenerationID` e o `invocationID` repositório do Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d56ff-185">Shutting down through the portal causes the VM to be deallocated, which resets both the `VM-GenerationID` and the `invocationID` of the Active Directory repository.</span></span> <span data-ttu-id="d56ff-186">Isso descarta o pool de RID (identificador relativo) do AD DS e marca o SYSVOL como não autoritativo e pode ser necessário reconfigurar o controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="d56ff-186">This discards the AD DS relative identifier (RID) pool and marks SYSVOL as nonauthoritative, and may require reconfiguration of the domain controller.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="d56ff-187">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="d56ff-187">Security considerations</span></span>

<span data-ttu-id="d56ff-188">Os servidores do AD DS fornecem serviços de autenticação e são um alvo atraente para ataques.</span><span class="sxs-lookup"><span data-stu-id="d56ff-188">AD DS servers provide authentication services and are an attractive target for attacks.</span></span> <span data-ttu-id="d56ff-189">Para protegê-los, evite a conectividade direta com a Internet colocando os servidores de AD DS em uma sub-rede separada com um NSG agindo como um firewall.</span><span class="sxs-lookup"><span data-stu-id="d56ff-189">To secure them, prevent direct Internet connectivity by placing the AD DS servers in a separate subnet with an NSG acting as a firewall.</span></span> <span data-ttu-id="d56ff-190">Feche todas as portas nos servidores do AD DS, exceto as necessárias para autenticação, autorização e sincronização do servidor.</span><span class="sxs-lookup"><span data-stu-id="d56ff-190">Close all ports on the AD DS servers except those necessary for authentication, authorization, and server synchronization.</span></span> <span data-ttu-id="d56ff-191">Para obter informações, consulte [Requisitos de porta do Active Directory e do Active Directory Domain Services][ad-ds-ports].</span><span class="sxs-lookup"><span data-stu-id="d56ff-191">For more information, see [Active Directory and Active Directory Domain Services Port Requirements][ad-ds-ports].</span></span>

<span data-ttu-id="d56ff-192">Considere implementar um perímetro de segurança adicional ao redor dos servidores com um par de sub-redes e NVAs, conforme descrito em [Implementar uma arquitetura de rede híbrida segura com acesso à Internet no Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="d56ff-192">Consider implementing an additional security perimeter around servers with a pair of subnets and NVAs, as described in [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span>

<span data-ttu-id="d56ff-193">Use a criptografia do BitLocker ou do disco do Azure para criptografar o disco que hospeda o banco de dados do AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-193">Use either BitLocker or Azure disk encryption to encrypt the disk hosting the AD DS database.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="d56ff-194">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="d56ff-194">Deploy the solution</span></span>

<span data-ttu-id="d56ff-195">Uma implantação para essa arquitetura está disponível no [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="d56ff-195">A deployment for this architecture is available on [GitHub][github].</span></span> <span data-ttu-id="d56ff-196">Observe que toda a implantação pode levar até duas horas, o que inclui a criação do gateway de VPN e a execução dos scripts que configuram o AD DS.</span><span class="sxs-lookup"><span data-stu-id="d56ff-196">Note that the entire deployment can take up to two hours, which includes creating the VPN gateway and running the scripts that configure AD DS.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="d56ff-197">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="d56ff-197">Prerequisites</span></span>

1. <span data-ttu-id="d56ff-198">Clone, crie um fork ou baixe o arquivo zip do [repositório GitHub](https://github.com/mspnp/identity-reference-architectures).</span><span class="sxs-lookup"><span data-stu-id="d56ff-198">Clone, fork, or download the zip file for the [GitHub repository](https://github.com/mspnp/identity-reference-architectures).</span></span>

2. <span data-ttu-id="d56ff-199">Instale a [CLI 2.0 do Azure](/cli/azure/install-azure-cli?view=azure-cli-latest).</span><span class="sxs-lookup"><span data-stu-id="d56ff-199">Install [Azure CLI 2.0](/cli/azure/install-azure-cli?view=azure-cli-latest).</span></span>

3. <span data-ttu-id="d56ff-200">Instale o pacote npm dos [Blocos de construção do Azure](https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks).</span><span class="sxs-lookup"><span data-stu-id="d56ff-200">Install the [Azure building blocks](https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks) npm package.</span></span>

   ```bash
   npm install -g @mspnp/azure-building-blocks
   ```

4. <span data-ttu-id="d56ff-201">Em um prompt de comando, prompt do bash ou prompt do PowerShell, entre na sua conta do Azure da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="d56ff-201">From a command prompt, bash prompt, or PowerShell prompt, sign into your Azure account as follows:</span></span>

   ```bash
   az login
   ```

### <a name="deploy-the-simulated-on-premises-datacenter"></a><span data-ttu-id="d56ff-202">Implantar o datacenter local simulado</span><span class="sxs-lookup"><span data-stu-id="d56ff-202">Deploy the simulated on-premises datacenter</span></span>

1. <span data-ttu-id="d56ff-203">Navegue até a pasta `identity/adds-extend-domain` do repositório do GitHub.</span><span class="sxs-lookup"><span data-stu-id="d56ff-203">Navigate to the `identity/adds-extend-domain` folder of the GitHub repository.</span></span>

2. <span data-ttu-id="d56ff-204">Abra o arquivo `onprem.json` .</span><span class="sxs-lookup"><span data-stu-id="d56ff-204">Open the `onprem.json` file.</span></span> <span data-ttu-id="d56ff-205">Pesquise instâncias de `adminPassword` e `Password` adicione valores para as senhas.</span><span class="sxs-lookup"><span data-stu-id="d56ff-205">Search for instances of `adminPassword` and `Password` and add values for the passwords.</span></span>

3. <span data-ttu-id="d56ff-206">Execute o seguinte comando e aguarde a conclusão da implantação:</span><span class="sxs-lookup"><span data-stu-id="d56ff-206">Run the following command and wait for the deployment to finish:</span></span>

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p onprem.json --deploy
    ```

### <a name="deploy-the-azure-vnet"></a><span data-ttu-id="d56ff-207">Implantar a VNET do Azure</span><span class="sxs-lookup"><span data-stu-id="d56ff-207">Deploy the Azure VNet</span></span>

1. <span data-ttu-id="d56ff-208">Abra o arquivo `azure.json` .</span><span class="sxs-lookup"><span data-stu-id="d56ff-208">Open the `azure.json` file.</span></span>  <span data-ttu-id="d56ff-209">Pesquise instâncias de `adminPassword` e `Password` adicione valores para as senhas.</span><span class="sxs-lookup"><span data-stu-id="d56ff-209">Search for instances of `adminPassword` and `Password` and add values for the passwords.</span></span>

2. <span data-ttu-id="d56ff-210">No mesmo arquivo, procure por instâncias de `sharedKey` e insira as chaves compartilhadas para a conexão VPN.</span><span class="sxs-lookup"><span data-stu-id="d56ff-210">In the same file, search for instances of `sharedKey` and enter shared keys for the VPN connection.</span></span>

    ```json
    "sharedKey": "",
    ```

3. <span data-ttu-id="d56ff-211">Execute o comando a seguir e aguarde a conclusão da implantação.</span><span class="sxs-lookup"><span data-stu-id="d56ff-211">Run the following command and wait for the deployment to finish.</span></span>

    ```bash
    azbb -s <subscription_id> -g <resource group> -l <location> -p onoprem.json --deploy
    ```

   <span data-ttu-id="d56ff-212">Implante no mesmo grupo de recursos da VNET local.</span><span class="sxs-lookup"><span data-stu-id="d56ff-212">Deploy to the same resource group as the on-premises VNet.</span></span>

### <a name="test-connectivity-with-the-azure-vnet"></a><span data-ttu-id="d56ff-213">Testar a conectividade com a VNET do Azure</span><span class="sxs-lookup"><span data-stu-id="d56ff-213">Test connectivity with the Azure VNet</span></span>

<span data-ttu-id="d56ff-214">Após a conclusão da implantação, você pode testar a conexão do ambiente simulado local para a VNET do Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-214">After deployment completes, you can test conectivity from the simulated on-premises environment to the Azure VNet.</span></span>

1. <span data-ttu-id="d56ff-215">Use o portal do Azure, navegue até o grupo de recursos que você criou.</span><span class="sxs-lookup"><span data-stu-id="d56ff-215">Use the Azure portal, navigate to the resource group that you created.</span></span>

2. <span data-ttu-id="d56ff-216">Encontre a VM denominada `ra-onpremise-mgmt-vm1`.</span><span class="sxs-lookup"><span data-stu-id="d56ff-216">Find the VM named `ra-onpremise-mgmt-vm1`.</span></span>

3. <span data-ttu-id="d56ff-217">Clique em `Connect` para abrir uma sessão de área de trabalho remota para a VM.</span><span class="sxs-lookup"><span data-stu-id="d56ff-217">Click `Connect` to open a remote desktop session to the VM.</span></span> <span data-ttu-id="d56ff-218">O nome de usuário é `contoso\testuser` e a senha é aquela especificada no arquivo de parâmetros `onprem.json`.</span><span class="sxs-lookup"><span data-stu-id="d56ff-218">The username is `contoso\testuser`, and the password is the one that you specified in the `onprem.json` parameter file.</span></span>

4. <span data-ttu-id="d56ff-219">De dentro de sua sessão de área de trabalho remota, abra outra sessão de área de trabalho remota para 10.0.4.4, que é o endereço IP da VM denominada `adds-vm1`.</span><span class="sxs-lookup"><span data-stu-id="d56ff-219">From inside your remote desktop session, open another remote desktop session to 10.0.4.4, which is the IP address of the VM named `adds-vm1`.</span></span> <span data-ttu-id="d56ff-220">O nome de usuário é `contoso\testuser` e a senha é aquela especificada no arquivo de parâmetros `azure.json`.</span><span class="sxs-lookup"><span data-stu-id="d56ff-220">The username is `contoso\testuser`, and the password is the one that you specified in the `azure.json` parameter file.</span></span>

5. <span data-ttu-id="d56ff-221">De dentro da sessão da área de trabalho remota para `adds-vm1`, vá para o **Gerenciador do Servidor** e clique em **Adicionar outros servidores para gerenciar.**</span><span class="sxs-lookup"><span data-stu-id="d56ff-221">From inside the remote desktop session for `adds-vm1`, go to **Server Manager** and click **Add other servers to manage**.</span></span>

6. <span data-ttu-id="d56ff-222">Na guia **Active Directory**, clique em **Localizar agora**.</span><span class="sxs-lookup"><span data-stu-id="d56ff-222">In the **Active Directory** tab, click **Find now**.</span></span> <span data-ttu-id="d56ff-223">Você deve ver uma lista das VMs do AD, do AD DS e da Web.</span><span class="sxs-lookup"><span data-stu-id="d56ff-223">You should see a list of the AD, AD DS, and Web VMs.</span></span>

   ![Captura de tela da caixa de diálogo Adicionar Servidores](./images/add-servers-dialog.png)

## <a name="next-steps"></a><span data-ttu-id="d56ff-225">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="d56ff-225">Next steps</span></span>

- <span data-ttu-id="d56ff-226">Conheça as práticas recomendadas para [criar uma floresta de recursos do AD DS][adds-resource-forest] no Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-226">Learn the best practices for [creating an AD DS resource forest][adds-resource-forest] in Azure.</span></span>
- <span data-ttu-id="d56ff-227">Conheça as práticas recomendadas para [criar uma infraestrutura do Serviços de Federação do Active Directory (AD FS)][adfs] no Azure.</span><span class="sxs-lookup"><span data-stu-id="d56ff-227">Learn the best practices for [creating an Active Directory Federation Services (AD FS) infrastructure][adfs] in Azure.</span></span>

<!-- links -->

[adds-resource-forest]: adds-forest.md
[adfs]: adfs.md
[azure-cli-2]: /azure/install-azure-cli
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md

[adds-data-disks]: https://msdn.microsoft.com/en-us/library/mt674703.aspx
[ad-ds-operations-masters]: https://technet.microsoft.com/library/cc779716(v=ws.10).aspx
[ad-ds-ports]: https://technet.microsoft.com/library/dd772723(v=ws.11).aspx
[availability-set]: /azure/virtual-machines/virtual-machines-windows-create-availability-set
[azure-expressroute]: /azure/expressroute/expressroute-introduction
[azure-vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[capacity-planning-for-adds]: https://social.technet.microsoft.com/wiki/contents/articles/14355.capacity-planning-for-active-directory-domain-services.aspx
[considerations]: ./considerations.md
[GitHub]: https://github.com/mspnp/identity-reference-architectures/tree/master/adds-extend-domain
[microsoft_systems_center]: https://www.microsoft.com/download/details.aspx?id=50013
[monitoring_ad]: https://msdn.microsoft.com/library/bb727046.aspx
[security-considerations]: #security-considerations
[set-a-static-ip-address]: /azure/virtual-network/virtual-networks-static-private-ip-arm-pportal
[standby-operations-masters]: https://technet.microsoft.com/library/cc794737(v=ws.10).aspx
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
[vm-windows-sizes]: /azure/virtual-machines/virtual-machines-windows-sizes

[0]: ./images/adds-extend-domain.png "Arquitetura de rede híbrida segura com o Active Directory"

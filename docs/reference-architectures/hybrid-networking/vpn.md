---
title: Conectar uma rede local ao Azure usando VPN
titleSuffix: Azure Reference Architectures
description: Implementar uma arquitetura de rede site a site segura que abranja uma rede virtual do Azure e uma rede local conectada usando uma VPN.
author: RohitSharma-pnp
ms.date: 10/22/2018
ms.openlocfilehash: 5d3c8eeeb04398c29a25e90956888d9f79572e4f
ms.sourcegitcommit: 8d951fd7e9534054b160be48a1881ae0857561ef
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/13/2018
ms.locfileid: "53329391"
---
# <a name="connect-an-on-premises-network-to-azure-using-a-vpn-gateway"></a><span data-ttu-id="497e1-103">Conectar uma rede local ao Azure usando um Gateway de VPN</span><span class="sxs-lookup"><span data-stu-id="497e1-103">Connect an on-premises network to Azure using a VPN gateway</span></span>

<span data-ttu-id="497e1-104">Essa arquitetura de referência mostra como estender uma rede local para o Azure, usando uma VPN (rede virtual privada) site a site.</span><span class="sxs-lookup"><span data-stu-id="497e1-104">This reference architecture shows how to extend an on-premises network to Azure, using a site-to-site virtual private network (VPN).</span></span> <span data-ttu-id="497e1-105">O tráfego flui entre a rede local e uma VNet (Rede Virtual) do Azure por meio de um túnel de VPN IPsec.</span><span class="sxs-lookup"><span data-stu-id="497e1-105">Traffic flows between the on-premises network and an Azure Virtual Network (VNet) through an IPSec VPN tunnel.</span></span> <span data-ttu-id="497e1-106">[**Implantar esta solução**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="497e1-106">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Rede híbrida que abrange as infraestruturas locais e do Azure](./images/vpn.png)

<span data-ttu-id="497e1-108">*Baixe um [Arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="497e1-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="497e1-109">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="497e1-109">Architecture</span></span>

<span data-ttu-id="497e1-110">A arquitetura consiste nos componentes a seguir.</span><span class="sxs-lookup"><span data-stu-id="497e1-110">The architecture consists of the following components.</span></span>

- <span data-ttu-id="497e1-111">**Rede local**.</span><span class="sxs-lookup"><span data-stu-id="497e1-111">**On-premises network**.</span></span> <span data-ttu-id="497e1-112">Uma rede de área local privada em execução dentro de uma organização.</span><span class="sxs-lookup"><span data-stu-id="497e1-112">A private local-area network running within an organization.</span></span>

- <span data-ttu-id="497e1-113">**Dispositivo de VPN**.</span><span class="sxs-lookup"><span data-stu-id="497e1-113">**VPN appliance**.</span></span> <span data-ttu-id="497e1-114">Um dispositivo ou serviço que fornece conectividade externa com a rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-114">A device or service that provides external connectivity to the on-premises network.</span></span> <span data-ttu-id="497e1-115">O dispositivo de VPN pode ser um dispositivo de hardware ou uma solução de software, como o RRAS (Serviço de Roteamento e Acesso Remoto) do Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="497e1-115">The VPN appliance may be a hardware device, or it can be a software solution such as the Routing and Remote Access Service (RRAS) in Windows Server 2012.</span></span> <span data-ttu-id="497e1-116">Para obter uma lista de dispositivos de VPN com suporte e informações de como configurá-los para se conectar a um Gateway de VPN do Azure, consulte as instruções para o dispositivo selecionado no artigo [Sobre dispositivos VPN para conexões do Gateway de VPN site a site][vpn-appliance].</span><span class="sxs-lookup"><span data-stu-id="497e1-116">For a list of supported VPN appliances and information on configuring them to connect to an Azure VPN gateway, see the instructions for the selected device in the article [About VPN devices for Site-to-Site VPN Gateway connections][vpn-appliance].</span></span>

- <span data-ttu-id="497e1-117">**Rede virtual (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="497e1-117">**Virtual network (VNet)**.</span></span> <span data-ttu-id="497e1-118">O aplicativo de nuvem e os componentes do Gateway de VPN do Azure residem na mesma [VNet][azure-virtual-network].</span><span class="sxs-lookup"><span data-stu-id="497e1-118">The cloud application and the components for the Azure VPN gateway reside in the same [VNet][azure-virtual-network].</span></span>

- <span data-ttu-id="497e1-119">**Gateway de VPN do Azure**.</span><span class="sxs-lookup"><span data-stu-id="497e1-119">**Azure VPN gateway**.</span></span> <span data-ttu-id="497e1-120">O serviço do [Gateway de VPN][azure-vpn-gateway] permite conectar a VNet à rede local por meio de um dispositivo de VPN.</span><span class="sxs-lookup"><span data-stu-id="497e1-120">The [VPN gateway][azure-vpn-gateway] service enables you to connect the VNet to the on-premises network through a VPN appliance.</span></span> <span data-ttu-id="497e1-121">Para obter mais informações, consulte [Conectar uma rede local a uma rede virtual do Microsoft Azure][connect-to-an-Azure-vnet].</span><span class="sxs-lookup"><span data-stu-id="497e1-121">For more information, see [Connect an on-premises network to a Microsoft Azure virtual network][connect-to-an-Azure-vnet].</span></span> <span data-ttu-id="497e1-122">O Gateway de VPN inclui os seguintes elementos:</span><span class="sxs-lookup"><span data-stu-id="497e1-122">The VPN gateway includes the following elements:</span></span>

  - <span data-ttu-id="497e1-123">**Gateway de rede virtual**.</span><span class="sxs-lookup"><span data-stu-id="497e1-123">**Virtual network gateway**.</span></span> <span data-ttu-id="497e1-124">Um recurso que fornece um dispositivo de VPN virtual para a VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-124">A resource that provides a virtual VPN appliance for the VNet.</span></span> <span data-ttu-id="497e1-125">Ele é responsável por rotear o tráfego da rede local para a VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-125">It is responsible for routing traffic from the on-premises network to the VNet.</span></span>
  - <span data-ttu-id="497e1-126">**Gateway de rede local**.</span><span class="sxs-lookup"><span data-stu-id="497e1-126">**Local network gateway**.</span></span> <span data-ttu-id="497e1-127">Uma abstração do dispositivo de VPN local.</span><span class="sxs-lookup"><span data-stu-id="497e1-127">An abstraction of the on-premises VPN appliance.</span></span> <span data-ttu-id="497e1-128">O tráfego de rede do aplicativo de nuvem para a rede local é roteado por esse gateway.</span><span class="sxs-lookup"><span data-stu-id="497e1-128">Network traffic from the cloud application to the on-premises network is routed through this gateway.</span></span>
  - <span data-ttu-id="497e1-129">**Conexão**.</span><span class="sxs-lookup"><span data-stu-id="497e1-129">**Connection**.</span></span> <span data-ttu-id="497e1-130">A conexão tem propriedades que especificam o tipo de conexão (IPsec) e a chave compartilhada com o dispositivo de VPN local para criptografar o tráfego.</span><span class="sxs-lookup"><span data-stu-id="497e1-130">The connection has properties that specify the connection type (IPSec) and the key shared with the on-premises VPN appliance to encrypt traffic.</span></span>
  - <span data-ttu-id="497e1-131">**Gateway de sub-rede**.</span><span class="sxs-lookup"><span data-stu-id="497e1-131">**Gateway subnet**.</span></span> <span data-ttu-id="497e1-132">O gateway de rede virtual é mantido em sua própria sub-rede, que está sujeita a vários requisitos, descritos na seção Recomendações abaixo.</span><span class="sxs-lookup"><span data-stu-id="497e1-132">The virtual network gateway is held in its own subnet, which is subject to various requirements, described in the Recommendations section below.</span></span>

- <span data-ttu-id="497e1-133">**Aplicativo de nuvem**.</span><span class="sxs-lookup"><span data-stu-id="497e1-133">**Cloud application**.</span></span> <span data-ttu-id="497e1-134">O aplicativo hospedado no Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-134">The application hosted in Azure.</span></span> <span data-ttu-id="497e1-135">Ele pode incluir várias camadas, com várias sub-redes conectadas por meio de balanceadores de carga do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-135">It might include multiple tiers, with multiple subnets connected through Azure load balancers.</span></span> <span data-ttu-id="497e1-136">Para obter mais informações sobre a infraestrutura do aplicativo, consulte [Execução de cargas de trabalho de VM do Windows][windows-vm-ra] e [Execução de cargas de trabalho de VM do Linux][linux-vm-ra].</span><span class="sxs-lookup"><span data-stu-id="497e1-136">For more information about the application infrastructure, see [Running Windows VM workloads][windows-vm-ra] and [Running Linux VM workloads][linux-vm-ra].</span></span>

- <span data-ttu-id="497e1-137">**Balanceador Interno de carga**.</span><span class="sxs-lookup"><span data-stu-id="497e1-137">**Internal load balancer**.</span></span> <span data-ttu-id="497e1-138">O tráfego de rede do Gateway de VPN é roteado para o aplicativo de nuvem por meio de um balanceador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="497e1-138">Network traffic from the VPN gateway is routed to the cloud application through an internal load balancer.</span></span> <span data-ttu-id="497e1-139">O balanceador de carga está localizado na sub-rede de front-end do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="497e1-139">The load balancer is located in the front-end subnet of the application.</span></span>

## <a name="recommendations"></a><span data-ttu-id="497e1-140">Recomendações</span><span class="sxs-lookup"><span data-stu-id="497e1-140">Recommendations</span></span>

<span data-ttu-id="497e1-141">As seguintes recomendações aplicam-se à maioria dos cenários.</span><span class="sxs-lookup"><span data-stu-id="497e1-141">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="497e1-142">Siga estas recomendações, a menos que você tenha um requisito específico que as substitua.</span><span class="sxs-lookup"><span data-stu-id="497e1-142">Follow these recommendations unless you have a specific requirement that overrides them.</span></span>

### <a name="vnet-and-gateway-subnet"></a><span data-ttu-id="497e1-143">VNet e sub-rede do gateway</span><span class="sxs-lookup"><span data-stu-id="497e1-143">VNet and gateway subnet</span></span>

<span data-ttu-id="497e1-144">Crie uma VNet do Azure com um espaço de endereço grande o suficiente para todos os recursos necessários.</span><span class="sxs-lookup"><span data-stu-id="497e1-144">Create an Azure VNet with an address space large enough for all of your required resources.</span></span> <span data-ttu-id="497e1-145">Verifique se o espaço de endereço da VNet tem espaço suficiente para aumentar caso haja necessidade de adicionar mais VMs no futuro.</span><span class="sxs-lookup"><span data-stu-id="497e1-145">Ensure that the VNet address space has sufficient room for growth if additional VMs are likely to be needed in the future.</span></span> <span data-ttu-id="497e1-146">O espaço de endereço da VNet não deve se sobrepor à rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-146">The address space of the VNet must not overlap with the on-premises network.</span></span> <span data-ttu-id="497e1-147">Por exemplo, o diagrama acima usa o espaço de endereço 10.20.0.0/16 para a VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-147">For example, the diagram above uses the address space 10.20.0.0/16 for the VNet.</span></span>

<span data-ttu-id="497e1-148">Crie uma sub-rede denominada *GatewaySubnet*, com um intervalo de endereços de /27.</span><span class="sxs-lookup"><span data-stu-id="497e1-148">Create a subnet named *GatewaySubnet*, with an address range of /27.</span></span> <span data-ttu-id="497e1-149">Essa sub-rede é necessária para o gateway de rede virtual.</span><span class="sxs-lookup"><span data-stu-id="497e1-149">This subnet is required by the virtual network gateway.</span></span> <span data-ttu-id="497e1-150">Alocar 32 endereços para essa sub-rede ajudará a evitar que as limitações de tamanho do gateway sejam atingidas no futuro.</span><span class="sxs-lookup"><span data-stu-id="497e1-150">Allocating 32 addresses to this subnet will help to prevent reaching gateway size limitations in the future.</span></span> <span data-ttu-id="497e1-151">Além disso, evite colocar essa sub-rede no meio do espaço de endereço.</span><span class="sxs-lookup"><span data-stu-id="497e1-151">Also, avoid placing this subnet in the middle of the address space.</span></span> <span data-ttu-id="497e1-152">Uma prática recomendada é definir o espaço de endereço para a sub-rede de gateway na extremidade superior do espaço de endereço da VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-152">A good practice is to set the address space for the gateway subnet at the upper end of the VNet address space.</span></span> <span data-ttu-id="497e1-153">O exemplo mostrado no diagrama usa 10.20.255.224/27.</span><span class="sxs-lookup"><span data-stu-id="497e1-153">The example shown in the diagram uses 10.20.255.224/27.</span></span>  <span data-ttu-id="497e1-154">Aqui está um procedimento rápido para calcular o [CIDR]:</span><span class="sxs-lookup"><span data-stu-id="497e1-154">Here is a quick procedure to calculate the [CIDR]:</span></span>

1. <span data-ttu-id="497e1-155">Defina os bits variáveis no espaço de endereço da VNet como 1, até os bits que estão sendo usados pela sub-rede do gateway e, em seguida, configure os bits restantes como 0.</span><span class="sxs-lookup"><span data-stu-id="497e1-155">Set the variable bits in the address space of the VNet to 1, up to the bits being used by the gateway subnet, then set the remaining bits to 0.</span></span>
2. <span data-ttu-id="497e1-156">Converta os bits resultantes em decimais e expresse-os como um espaço de endereço com o comprimento do prefixo definido para o tamanho da sub-rede do gateway.</span><span class="sxs-lookup"><span data-stu-id="497e1-156">Convert the resulting bits to decimal and express it as an address space with the prefix length set to the size of the gateway subnet.</span></span>

<span data-ttu-id="497e1-157">Por exemplo, para uma VNet com um intervalo de endereços IP igual a 10.20.0.0/16, a aplicação da etapa nº 1 acima transforma-o em 10.20.0b11111111.0b11100000.</span><span class="sxs-lookup"><span data-stu-id="497e1-157">For example, for a VNet with an IP address range of 10.20.0.0/16, applying step #1 above becomes 10.20.0b11111111.0b11100000.</span></span>  <span data-ttu-id="497e1-158">Convertê-lo em decimal e expressá-lo como um espaço de endereço produz 10.20.255.224/27.</span><span class="sxs-lookup"><span data-stu-id="497e1-158">Converting that to decimal and expressing it as an address space yields 10.20.255.224/27.</span></span>

> [!WARNING]
> <span data-ttu-id="497e1-159">Não implante nenhuma VM na sub-rede do gateway.</span><span class="sxs-lookup"><span data-stu-id="497e1-159">Do not deploy any VMs to the gateway subnet.</span></span> <span data-ttu-id="497e1-160">Além disso, não atribua um NSG a essa sub-rede, pois faria com que o gateway parasse de funcionar.</span><span class="sxs-lookup"><span data-stu-id="497e1-160">Also, do not assign an NSG to this subnet, as it will cause the gateway to stop functioning.</span></span>
>

### <a name="virtual-network-gateway"></a><span data-ttu-id="497e1-161">Gateway de rede virtual</span><span class="sxs-lookup"><span data-stu-id="497e1-161">Virtual network gateway</span></span>

<span data-ttu-id="497e1-162">Aloque um endereço IP público para o gateway de rede virtual.</span><span class="sxs-lookup"><span data-stu-id="497e1-162">Allocate a public IP address for the virtual network gateway.</span></span>

<span data-ttu-id="497e1-163">Crie o gateway de rede virtual na sub-rede do gateway e atribua-o ao endereço IP público recém-alocado.</span><span class="sxs-lookup"><span data-stu-id="497e1-163">Create the virtual network gateway in the gateway subnet and assign it the newly allocated public IP address.</span></span> <span data-ttu-id="497e1-164">Use o tipo de gateway que melhor corresponde aos seus requisitos e que está habilitado pelo seu dispositivo de VPN:</span><span class="sxs-lookup"><span data-stu-id="497e1-164">Use the gateway type that most closely matches your requirements and that is enabled by your VPN appliance:</span></span>

- <span data-ttu-id="497e1-165">Crie um [gateway baseado em políticas][policy-based-routing] se você precisar controlar atentamente como as solicitações são roteadas com base em critérios de política, como prefixos de endereço.</span><span class="sxs-lookup"><span data-stu-id="497e1-165">Create a [policy-based gateway][policy-based-routing] if you need to closely control how requests are routed based on policy criteria such as address prefixes.</span></span> <span data-ttu-id="497e1-166">Os gateways baseados em políticas usam o roteamento estático e funcionam apenas com conexões site a site.</span><span class="sxs-lookup"><span data-stu-id="497e1-166">Policy-based gateways use static routing, and only work with site-to-site connections.</span></span>

- <span data-ttu-id="497e1-167">Crie um [gateway baseado em rota][route-based-routing] se você se conecta à rede local usando o RRAS, dá suporte a conexões multisites ou entre regiões ou implementa conexões de VNet para VNet (incluindo rotas que atravessam várias VNets).</span><span class="sxs-lookup"><span data-stu-id="497e1-167">Create a [route-based gateway][route-based-routing] if you connect to the on-premises network using RRAS, support multi-site or cross-region connections, or implement VNet-to-VNet connections (including routes that traverse multiple VNets).</span></span> <span data-ttu-id="497e1-168">Os gateways baseados em rota usam o roteamento dinâmico para o tráfego direto entre redes.</span><span class="sxs-lookup"><span data-stu-id="497e1-168">Route-based gateways use dynamic routing to direct traffic between networks.</span></span> <span data-ttu-id="497e1-169">Eles conseguem tolerar falhas no caminho da rede melhor do que as rotas estáticas, porque eles podem tentar rotas alternativas.</span><span class="sxs-lookup"><span data-stu-id="497e1-169">They can tolerate failures in the network path better than static routes because they can try alternative routes.</span></span> <span data-ttu-id="497e1-170">Os gateways baseados em rota também conseguem reduzir a sobrecarga de gerenciamento porque é possível que as rotas não precisem ser atualizadas manualmente quando os endereços de rede são alterados.</span><span class="sxs-lookup"><span data-stu-id="497e1-170">Route-based gateways can also reduce the management overhead because routes might not need to be updated manually when network addresses change.</span></span>

<span data-ttu-id="497e1-171">Para obter uma lista de dispositivos de VPN com suporte, consulte [Sobre dispositivos VPN para conexões do Gateway de VPN site a site][vpn-appliances].</span><span class="sxs-lookup"><span data-stu-id="497e1-171">For a list of supported VPN appliances, see [About VPN devices for Site-to-Site VPN Gateway connections][vpn-appliances].</span></span>

> [!NOTE]
> <span data-ttu-id="497e1-172">Depois que o gateway for criado, você não poderá mais alterar o tipo de gateway sem excluir e recriar o gateway.</span><span class="sxs-lookup"><span data-stu-id="497e1-172">After the gateway has been created, you cannot change between gateway types without deleting and re-creating the gateway.</span></span>
>

<span data-ttu-id="497e1-173">Selecione a SKU do Gateway de VPN do Azure que melhor corresponde aos seus requisitos de produtividade.</span><span class="sxs-lookup"><span data-stu-id="497e1-173">Select the Azure VPN gateway SKU that most closely matches your throughput requirements.</span></span> <span data-ttu-id="497e1-174">Para obter mais informações, confira [SKUs do gateway][azure-gateway-skus]</span><span class="sxs-lookup"><span data-stu-id="497e1-174">For more informayion, see [Gateway SKUs][azure-gateway-skus]</span></span>

> [!NOTE]
> <span data-ttu-id="497e1-175">A SKU básica não é compatível com o Azure ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="497e1-175">The Basic SKU is not compatible with Azure ExpressRoute.</span></span> <span data-ttu-id="497e1-176">Você poderá [alterar a SKU][changing-SKUs] depois que o gateway for criado.</span><span class="sxs-lookup"><span data-stu-id="497e1-176">You can [change the SKU][changing-SKUs] after the gateway has been created.</span></span>
>

<span data-ttu-id="497e1-177">Você é cobrado com base no período de tempo em que o gateway é provisionado e fica disponível.</span><span class="sxs-lookup"><span data-stu-id="497e1-177">You are charged based on the amount of time that the gateway is provisioned and available.</span></span> <span data-ttu-id="497e1-178">Consulte [Preços do Gateway de VPN][azure-gateway-charges].</span><span class="sxs-lookup"><span data-stu-id="497e1-178">See [VPN Gateway Pricing][azure-gateway-charges].</span></span>

<span data-ttu-id="497e1-179">Crie regras de roteamento para a sub-rede de gateway que direcionem o tráfego do aplicativo de entrada do gateway para o balanceador de carga interno, em vez de permitirem que as solicitações passem diretamente para as VMs de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="497e1-179">Create routing rules for the gateway subnet that direct incoming application traffic from the gateway to the internal load balancer, rather than allowing requests to pass directly to the application VMs.</span></span>

### <a name="on-premises-network-connection"></a><span data-ttu-id="497e1-180">Conexão de rede local</span><span class="sxs-lookup"><span data-stu-id="497e1-180">On-premises network connection</span></span>

<span data-ttu-id="497e1-181">Criar um gateway de rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-181">Create a local network gateway.</span></span> <span data-ttu-id="497e1-182">Especifique o endereço IP público do dispositivo de VPN local e o espaço de endereço da rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-182">Specify the public IP address of the on-premises VPN appliance, and the address space of the on-premises network.</span></span> <span data-ttu-id="497e1-183">Observe que o dispositivo de VPN local deve ter um endereço IP público que possa ser acessado pelo gateway de rede local no Gateway de VPN do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-183">Note that the on-premises VPN appliance must have a public IP address that can be accessed by the local network gateway in Azure VPN Gateway.</span></span> <span data-ttu-id="497e1-184">O dispositivo VPN não pode estar localizado atrás de um dispositivo de NAT (conversão de endereços de rede).</span><span class="sxs-lookup"><span data-stu-id="497e1-184">The VPN device cannot be located behind a network address translation (NAT) device.</span></span>

<span data-ttu-id="497e1-185">Crie uma conexão site a site para o gateway de rede virtual e o gateway de rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-185">Create a site-to-site connection for the virtual network gateway and the local network gateway.</span></span> <span data-ttu-id="497e1-186">Selecione o tipo de conexão site a site (IPsec) e especifique a chave compartilhada.</span><span class="sxs-lookup"><span data-stu-id="497e1-186">Select the site-to-site (IPSec) connection type, and specify the shared key.</span></span> <span data-ttu-id="497e1-187">A criptografia site a site com o Gateway de VPN do Azure é baseada no protocolo IPsec, usando chaves pré-compartilhadas para autenticação.</span><span class="sxs-lookup"><span data-stu-id="497e1-187">Site-to-site encryption with the Azure VPN gateway is based on the IPSec protocol, using preshared keys for authentication.</span></span> <span data-ttu-id="497e1-188">Especifique a chave ao criar o Gateway de VPN do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-188">You specify the key when you create the Azure VPN gateway.</span></span> <span data-ttu-id="497e1-189">Você deve configurar o dispositivo de VPN em execução local com a mesma chave.</span><span class="sxs-lookup"><span data-stu-id="497e1-189">You must configure the VPN appliance running on-premises with the same key.</span></span> <span data-ttu-id="497e1-190">Atualmente, não há suporte para outros mecanismos de autenticação.</span><span class="sxs-lookup"><span data-stu-id="497e1-190">Other authentication mechanisms are not currently supported.</span></span>

<span data-ttu-id="497e1-191">Verifique se a infraestrutura de roteamento local está configurada para encaminhar as solicitações destinadas a endereços na VNet do Azure para o dispositivo VPN.</span><span class="sxs-lookup"><span data-stu-id="497e1-191">Ensure that the on-premises routing infrastructure is configured to forward requests intended for addresses in the Azure VNet to the VPN device.</span></span>

<span data-ttu-id="497e1-192">Abra todas as portas exigidas pelo aplicativo de nuvem na rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-192">Open any ports required by the cloud application in the on-premises network.</span></span>

<span data-ttu-id="497e1-193">Teste a conexão para verificar se:</span><span class="sxs-lookup"><span data-stu-id="497e1-193">Test the connection to verify that:</span></span>

- <span data-ttu-id="497e1-194">O dispositivo de VPN local roteia corretamente o tráfego para o aplicativo de nuvem por meio do Gateway de VPN do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-194">The on-premises VPN appliance correctly routes traffic to the cloud application through the Azure VPN gateway.</span></span>
- <span data-ttu-id="497e1-195">A VNet roteia corretamente o tráfego de volta para a rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-195">The VNet correctly routes traffic back to the on-premises network.</span></span>
- <span data-ttu-id="497e1-196">O tráfego proibido em ambas as direções é bloqueado corretamente.</span><span class="sxs-lookup"><span data-stu-id="497e1-196">Prohibited traffic in both directions is blocked correctly.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="497e1-197">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="497e1-197">Scalability considerations</span></span>

<span data-ttu-id="497e1-198">Você pode obter uma escalabilidade vertical limitada passando as SKUs do Gateway de VPN do plano Básico ou Standard para a SKU de VPN de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="497e1-198">You can achieve limited vertical scalability by moving from the Basic or Standard VPN Gateway SKUs to the High Performance VPN SKU.</span></span>

<span data-ttu-id="497e1-199">Para VNets que esperam um grande volume de tráfego de VPN, considere distribuir as diferentes cargas de trabalho em VNets menores separadas e configurar um Gateway de VPN para cada uma delas.</span><span class="sxs-lookup"><span data-stu-id="497e1-199">For VNets that expect a large volume of VPN traffic, consider distributing the different workloads into separate smaller VNets and configuring a VPN gateway for each of them.</span></span>

<span data-ttu-id="497e1-200">Você pode particionar a VNet horizontal ou verticalmente.</span><span class="sxs-lookup"><span data-stu-id="497e1-200">You can partition the VNet either horizontally or vertically.</span></span> <span data-ttu-id="497e1-201">Para particionar horizontalmente, mova algumas instâncias de VM de cada camada para as sub-redes da nova VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-201">To partition horizontally, move some VM instances from each tier into subnets of the new VNet.</span></span> <span data-ttu-id="497e1-202">O resultado é que cada VNet terá as mesmas estrutura e funcionalidade.</span><span class="sxs-lookup"><span data-stu-id="497e1-202">The result is that each VNet has the same structure and functionality.</span></span> <span data-ttu-id="497e1-203">Para particionar verticalmente, recrie cada camada para dividir a funcionalidade em áreas lógicas diferentes (como para tratamento de pedidos, faturamento, gerenciamento de contas de cliente e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="497e1-203">To partition vertically, redesign each tier to divide the functionality into different logical areas (such as handling orders, invoicing, customer account management, and so on).</span></span> <span data-ttu-id="497e1-204">Assim, cada área funcional poderá ser colocada em sua própria VNet.</span><span class="sxs-lookup"><span data-stu-id="497e1-204">Each functional area can then be placed in its own VNet.</span></span>

<span data-ttu-id="497e1-205">A replicação de um controlador de domínio do Active Directory local na VNet e a implementação de DNS na VNet podem ajudar a reduzir parte do tráfego relacionado à segurança e administrativo que flui do local para a nuvem.</span><span class="sxs-lookup"><span data-stu-id="497e1-205">Replicating an on-premises Active Directory domain controller in the VNet, and implementing DNS in the VNet, can help to reduce some of the security-related and administrative traffic flowing from on-premises to the cloud.</span></span> <span data-ttu-id="497e1-206">Para obter mais informações, consulte [Estendendo o AD DS (Active Directory Domain Services) para o Azure][adds-extend-domain].</span><span class="sxs-lookup"><span data-stu-id="497e1-206">For more information, see [Extending Active Directory Domain Services (AD DS) to Azure][adds-extend-domain].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="497e1-207">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="497e1-207">Availability considerations</span></span>

<span data-ttu-id="497e1-208">Se você precisa garantir que a rede local permaneça disponível para o Gateway de VPN do Azure, implemente um cluster de failover para o Gateway de VPN local.</span><span class="sxs-lookup"><span data-stu-id="497e1-208">If you need to ensure that the on-premises network remains available to the Azure VPN gateway, implement a failover cluster for the on-premises VPN gateway.</span></span>

<span data-ttu-id="497e1-209">Se sua organização tiver vários sites locais, crie [conexões multisites][vpn-gateway-multi-site] para uma ou mais VNets do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-209">If your organization has multiple on-premises sites, create [multi-site connections][vpn-gateway-multi-site] to one or more Azure VNets.</span></span> <span data-ttu-id="497e1-210">Essa abordagem requer o roteamento dinâmico (baseado em rota), portanto, verifique se o Gateway de VPN local dá suporte a esse recurso.</span><span class="sxs-lookup"><span data-stu-id="497e1-210">This approach requires dynamic (route-based) routing, so make sure that the on-premises VPN gateway supports this feature.</span></span>

<span data-ttu-id="497e1-211">Para obter detalhes sobre os contratos de nível de serviço, consulte [SLA para Gateway de VPN][sla-for-vpn-gateway].</span><span class="sxs-lookup"><span data-stu-id="497e1-211">For details about service level agreements, see [SLA for VPN Gateway][sla-for-vpn-gateway].</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="497e1-212">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="497e1-212">Manageability considerations</span></span>

<span data-ttu-id="497e1-213">Monitore as informações de diagnóstico usando dispositivos de VPN locais.</span><span class="sxs-lookup"><span data-stu-id="497e1-213">Monitor diagnostic information from on-premises VPN appliances.</span></span> <span data-ttu-id="497e1-214">Esse processo depende dos recursos fornecidos pelo dispositivo de VPN.</span><span class="sxs-lookup"><span data-stu-id="497e1-214">This process depends on the features provided by the VPN appliance.</span></span> <span data-ttu-id="497e1-215">Por exemplo, se você estiver usando o roteamento e o serviço de acesso remoto no Windows Server 2012, o [log de RRAS][rras-logging].</span><span class="sxs-lookup"><span data-stu-id="497e1-215">For example, if you are using the Routing and Remote Access Service on Windows Server 2012, [RRAS logging][rras-logging].</span></span>

<span data-ttu-id="497e1-216">Use [diagnóstico do Gateway de VPN do Azure][gateway-diagnostic-logs] para capturar informações sobre problemas de conectividade.</span><span class="sxs-lookup"><span data-stu-id="497e1-216">Use [Azure VPN gateway diagnostics][gateway-diagnostic-logs] to capture information about connectivity issues.</span></span> <span data-ttu-id="497e1-217">Esses logs podem ser usados para rastrear informações como a origem e os destinos das solicitações de conexão, o protocolo usado e como a conexão foi estabelecida (ou por que a tentativa falhou).</span><span class="sxs-lookup"><span data-stu-id="497e1-217">These logs can be used to track information such as the source and destinations of connection requests, which protocol was used, and how the connection was established (or why the attempt failed).</span></span>

<span data-ttu-id="497e1-218">Monitore os logs operacionais do Gateway de VPN do Azure usando os logs de auditoria disponíveis no portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-218">Monitor the operational logs of the Azure VPN gateway using the audit logs available in the Azure portal.</span></span> <span data-ttu-id="497e1-219">Logs separados estão disponíveis para o gateway de rede local, o gateway de rede do Azure e a conexão.</span><span class="sxs-lookup"><span data-stu-id="497e1-219">Separate logs are available for the local network gateway, the Azure network gateway, and the connection.</span></span> <span data-ttu-id="497e1-220">Essas informações podem ser usadas para acompanhar as alterações feitas no gateway e poderão ser úteis se um gateway que estava em funcionamento parar de funcionar por alguma razão.</span><span class="sxs-lookup"><span data-stu-id="497e1-220">This information can be used to track any changes made to the gateway, and can be useful if a previously functioning gateway stops working for some reason.</span></span>

![Logs de auditoria no portal do Azure](../_images/guidance-hybrid-network-vpn/audit-logs.png)

<span data-ttu-id="497e1-222">Monitore a conectividade e acompanhe os eventos de falha de conectividade.</span><span class="sxs-lookup"><span data-stu-id="497e1-222">Monitor connectivity, and track connectivity failure events.</span></span> <span data-ttu-id="497e1-223">Você pode usar um pacote de monitoramento, como o [Nagios][nagios] para capturar e relatar essas informações.</span><span class="sxs-lookup"><span data-stu-id="497e1-223">You can use a monitoring package such as [Nagios][nagios] to capture and report this information.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="497e1-224">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="497e1-224">Security considerations</span></span>

<span data-ttu-id="497e1-225">Gere uma chave compartilhada diferente para cada Gateway de VPN.</span><span class="sxs-lookup"><span data-stu-id="497e1-225">Generate a different shared key for each VPN gateway.</span></span> <span data-ttu-id="497e1-226">Use uma chave compartilhada forte para ajudar na resistência contra ataques de força bruta.</span><span class="sxs-lookup"><span data-stu-id="497e1-226">Use a strong shared key to help resist brute-force attacks.</span></span>

> [!NOTE]
> <span data-ttu-id="497e1-227">No momento, não é possível usar o Azure Key Vault para pré-compartilhar chaves do Gateway de VPN do Azure.</span><span class="sxs-lookup"><span data-stu-id="497e1-227">Currently, you cannot use Azure Key Vault to preshare keys for the Azure VPN gateway.</span></span>
>

<span data-ttu-id="497e1-228">Verifique se o dispositivo de VPN local usa um método de criptografia [compatível com o Gateway de VPN do Azure][vpn-appliance-ipsec].</span><span class="sxs-lookup"><span data-stu-id="497e1-228">Ensure that the on-premises VPN appliance uses an encryption method that is [compatible with the Azure VPN gateway][vpn-appliance-ipsec].</span></span> <span data-ttu-id="497e1-229">Para roteamento baseado em políticas, o Gateway de VPN do Azure dá suporte aos algoritmos de criptografia 3DES, AES256 e AES128.</span><span class="sxs-lookup"><span data-stu-id="497e1-229">For policy-based routing, the Azure VPN gateway supports the AES256, AES128, and 3DES encryption algorithms.</span></span> <span data-ttu-id="497e1-230">Os gateways baseados em rota dão suporte para AES256 e 3DES.</span><span class="sxs-lookup"><span data-stu-id="497e1-230">Route-based gateways support AES256 and 3DES.</span></span>

<span data-ttu-id="497e1-231">Se seu dispositivo de VPN local estiver em uma DMZ (rede de perímetro) com um firewall entre a rede de perímetro e a Internet, poderá ser necessário configurar [regras de firewall adicionais][additional-firewall-rules] para permitir a conexão de VPN site a site.</span><span class="sxs-lookup"><span data-stu-id="497e1-231">If your on-premises VPN appliance is on a perimeter network (DMZ) that has a firewall between the perimeter network and the Internet, you might have to configure [additional firewall rules][additional-firewall-rules] to allow the site-to-site VPN connection.</span></span>

<span data-ttu-id="497e1-232">Se o aplicativo na VNet envia dados para a Internet, considere [implementar um túnel forçado][forced-tunneling] para rotear todo o tráfego associado à Internet por meio da rede local.</span><span class="sxs-lookup"><span data-stu-id="497e1-232">If the application in the VNet sends data to the Internet, consider [implementing forced tunneling][forced-tunneling] to route all Internet-bound traffic through the on-premises network.</span></span> <span data-ttu-id="497e1-233">Essa abordagem permite auditar as solicitações de saída feitas pelo aplicativo da infraestrutura local.</span><span class="sxs-lookup"><span data-stu-id="497e1-233">This approach enables you to audit outgoing requests made by the application from the on-premises infrastructure.</span></span>

> [!NOTE]
> <span data-ttu-id="497e1-234">O túnel forçado pode afetar a conectividade para serviços do Azure (o serviço de armazenamento, por exemplo) e o Gerenciador de licenças do Windows.</span><span class="sxs-lookup"><span data-stu-id="497e1-234">Forced tunneling can impact connectivity to Azure services (the Storage Service, for example) and the Windows license manager.</span></span>
>

## <a name="deploy-the-solution"></a><span data-ttu-id="497e1-235">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="497e1-235">Deploy the solution</span></span>

<span data-ttu-id="497e1-236">**Pré-requisitos**.</span><span class="sxs-lookup"><span data-stu-id="497e1-236">**Prerequisites**.</span></span> <span data-ttu-id="497e1-237">Você deve ter uma infraestrutura local existente já configurada com um dispositivo de rede adequado.</span><span class="sxs-lookup"><span data-stu-id="497e1-237">You must have an existing on-premises infrastructure already configured with a suitable network appliance.</span></span>

<span data-ttu-id="497e1-238">Para implantar a solução, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="497e1-238">To deploy the solution, perform the following steps.</span></span>

<!-- markdownlint-disable MD033 -->

1. <span data-ttu-id="497e1-239">Clique no botão abaixo:</span><span class="sxs-lookup"><span data-stu-id="497e1-239">Click the button below:</span></span><br><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fhybrid-networking%2Fvpn%2Fazuredeploy.json" target="_blank"><img src="https://azuredeploy.net/deploybutton.png"/></a>
2. <span data-ttu-id="497e1-240">Aguarde até o link abrir no Portal do Azure e siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="497e1-240">Wait for the link to open in the Azure portal, then follow these steps:</span></span>
   - <span data-ttu-id="497e1-241">O nome do **Grupo de recursos** já está definido no arquivo de parâmetros, portanto, selecione **Criar novo** e digite `ra-hybrid-vpn-rg` na caixa de texto.</span><span class="sxs-lookup"><span data-stu-id="497e1-241">The **Resource group** name is already defined in the parameter file, so select **Create New** and enter `ra-hybrid-vpn-rg` in the text box.</span></span>
   - <span data-ttu-id="497e1-242">Selecione a região na caixa suspensa **Local**.</span><span class="sxs-lookup"><span data-stu-id="497e1-242">Select the region from the **Location** drop down box.</span></span>
   - <span data-ttu-id="497e1-243">Não edite as caixas de texto **URI da raiz do modelo** ou **URI da raiz do parâmetro**.</span><span class="sxs-lookup"><span data-stu-id="497e1-243">Do not edit the **Template Root Uri** or the **Parameter Root Uri** text boxes.</span></span>
   - <span data-ttu-id="497e1-244">Analise os termos e condições e clique na caixa de seleção **Concordo com os termos e condições declarados acima**.</span><span class="sxs-lookup"><span data-stu-id="497e1-244">Review the terms and conditions, then click the **I agree to the terms and conditions stated above** checkbox.</span></span>
   - <span data-ttu-id="497e1-245">Clique no botão **Comprar**.</span><span class="sxs-lookup"><span data-stu-id="497e1-245">Click the **Purchase** button.</span></span>
3. <span data-ttu-id="497e1-246">Aguarde até que a implantação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="497e1-246">Wait for the deployment to complete.</span></span>

<!-- markdownlint-enable MD033 -->

<span data-ttu-id="497e1-247">Para solucionar problemas de conexão, confira [Solucionar problemas de uma conexão VPN híbrida](./troubleshoot-vpn.md).</span><span class="sxs-lookup"><span data-stu-id="497e1-247">To troubleshoot the connection, see [Troubleshoot a hybrid VPN connection](./troubleshoot-vpn.md).</span></span>

<!-- links -->

[adds-extend-domain]: ../identity/adds-extend-domain.md
[windows-vm-ra]: ../virtual-machines-windows/index.md
[linux-vm-ra]: ../virtual-machines-linux/index.md

[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-virtual-network]: /azure/virtual-network/virtual-networks-overview
[vpn-appliance]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices
[azure-vpn-gateway]: https://azure.microsoft.com/services/vpn-gateway/
[azure-gateway-charges]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[azure-gateway-skus]: /azure/vpn-gateway/vpn-gateway-about-vpngateways#gwsku
[connect-to-an-Azure-vnet]: https://technet.microsoft.com/library/dn786406.aspx
[vpn-gateway-multi-site]: /azure/vpn-gateway/vpn-gateway-multi-site
[policy-based-routing]: https://en.wikipedia.org/wiki/Policy-based_routing
[route-based-routing]: https://en.wikipedia.org/wiki/Static_routing
[sla-for-vpn-gateway]: https://azure.microsoft.com/support/legal/sla/vpn-gateway/
[additional-firewall-rules]: https://technet.microsoft.com/library/dn786406.aspx#firewall
[nagios]: https://www.nagios.org/
[changing-SKUs]: https://azure.microsoft.com/blog/azure-virtual-network-gateway-improvements/
[gateway-diagnostic-logs]: https://blogs.technet.microsoft.com/keithmayer/2016/10/12/step-by-step-capturing-azure-resource-manager-arm-vnet-gateway-diagnostic-logs/
[rras-logging]: https://www.petri.com/enable-diagnostic-logging-in-windows-server-2012-r2-routing-and-remote-access
[forced-tunneling]: https://azure.microsoft.com/documentation/articles/vpn-gateway-about-forced-tunneling/
[vpn-appliances]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices
[visio-download]: https://archcenter.blob.core.windows.net/cdn/hybrid-network-architectures.vsdx
[vpn-appliance-ipsec]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices#ipsec-parameters
[azure-cli]: https://azure.microsoft.com/documentation/articles/xplat-cli-install/
[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing

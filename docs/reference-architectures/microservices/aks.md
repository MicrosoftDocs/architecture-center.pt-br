---
title: Arquitetura de microsserviços no AKS (Serviço de Kubernetes do Azure)
description: Implantar uma arquitetura de microsserviços no AKS (Serviço de Kubernetes do Azure)
author: MikeWasson
ms.date: 12/10/2018
ms.openlocfilehash: c8fa92e012374882e3af89f7ef8f7d800a52dacb
ms.sourcegitcommit: a0a9981e7586bed8d876a54e055dea1e392118f8
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/11/2018
ms.locfileid: "53233907"
---
# <a name="microservices-architecture-on-azure-kubernetes-service-aks"></a><span data-ttu-id="51380-103">Arquitetura de microsserviços no AKS (Serviço de Kubernetes do Azure)</span><span class="sxs-lookup"><span data-stu-id="51380-103">Microservices architecture on Azure Kubernetes Service (AKS)</span></span>

<span data-ttu-id="51380-104">Essa arquitetura de referência mostra um aplicativo de microsserviços implantado no AKS (Serviço de Kubernetes do Azure).</span><span class="sxs-lookup"><span data-stu-id="51380-104">This reference architectures shows a microservices application deployed to Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="51380-105">Ele mostra uma configuração básica do AKS que pode ser o ponto de partida para a maioria das implantações.</span><span class="sxs-lookup"><span data-stu-id="51380-105">It shows a basic AKS configuration that can be the starting point for most deployments.</span></span> <span data-ttu-id="51380-106">Opções mais avançadas, incluindo opções avançadas de rede, serão abordadas em uma arquitetura de referência separada.</span><span class="sxs-lookup"><span data-stu-id="51380-106">More advanced options, including advanced networking options, will be covered in a separate reference architecture.</span></span>

<span data-ttu-id="51380-107">Este artigo pressupõe conhecimentos básicos de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-107">This article assumes basic knowledge of Kubernetes.</span></span> <span data-ttu-id="51380-108">O artigo se concentra principalmente na infraestrutura e nas considerações de DevOps na execução de uma arquitetura de microsserviços no AKS.</span><span class="sxs-lookup"><span data-stu-id="51380-108">The article focuses mainly on the infrastructure and DevOps considerations of running a microservices architecture on AKS.</span></span> <span data-ttu-id="51380-109">Para obter orientação sobre como criar microsserviços de uma perspectiva de DDD (Design Controlado por Domínio), consulte [Projetando, compilando e operando microsserviços no Azure](/azure/architecture/microservices).</span><span class="sxs-lookup"><span data-stu-id="51380-109">For guidance on how to design microservices from a Domain Driven Design (DDD) perspective, see [Designing, building, and operating microservices on Azure](/azure/architecture/microservices).</span></span>

> [!NOTE]
> <span data-ttu-id="51380-110">Estamos trabalhando em uma RI (implementação de referência) para acompanhar este artigo, que esperamos publicar no início de 2019.</span><span class="sxs-lookup"><span data-stu-id="51380-110">We are working on a reference implementation (RI) to accompany this article, which we expect to publish in early 2019.</span></span> <span data-ttu-id="51380-111">Este artigo será atualizado para incorporar outras melhores práticas dessa RI.</span><span class="sxs-lookup"><span data-stu-id="51380-111">This article will be updated to incorporate additional best practices from that RI.</span></span>

![Arquitetura de referência do AKS](./_images/aks.png)

## <a name="architecture"></a><span data-ttu-id="51380-113">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="51380-113">Architecture</span></span>

<span data-ttu-id="51380-114">A arquitetura consiste nos componentes a seguir.</span><span class="sxs-lookup"><span data-stu-id="51380-114">The architecture consists of the following components.</span></span>

<span data-ttu-id="51380-115">**AKS** (Serviço de Kubernetes do Azure).</span><span class="sxs-lookup"><span data-stu-id="51380-115">**Azure Kubernetes Service** (AKS).</span></span> <span data-ttu-id="51380-116">O AKS é um serviço do Azure que implanta um cluster do Kubernetes gerenciado.</span><span class="sxs-lookup"><span data-stu-id="51380-116">AKS is an Azure service that deploys a managed Kubernetes cluster.</span></span> 

<span data-ttu-id="51380-117">**Cluster do Kubernetes**.</span><span class="sxs-lookup"><span data-stu-id="51380-117">**Kubernetes cluster**.</span></span> <span data-ttu-id="51380-118">O AKS é responsável por implantar o cluster do Kubernetes e gerenciar os mestres do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-118">AKS is responsible for deploying the Kubernetes cluster and for managing the Kubernetes masters.</span></span> <span data-ttu-id="51380-119">Você só pode gerenciar os nós de agente.</span><span class="sxs-lookup"><span data-stu-id="51380-119">You only manage the agent nodes.</span></span>

<span data-ttu-id="51380-120">**Rede virtual**.</span><span class="sxs-lookup"><span data-stu-id="51380-120">**Virtual network**.</span></span> <span data-ttu-id="51380-121">Por padrão, o AKS cria uma rede virtual para ter onde implantar os nós de agente.</span><span class="sxs-lookup"><span data-stu-id="51380-121">By default, AKS creates a virtual network to deploy the agent nodes into.</span></span> <span data-ttu-id="51380-122">Para cenários mais avançados, você pode criar a rede virtual primeiro, que permite controlar, por exemplo, como as sub-redes são configuradas, a conectividade local e o endereçamento IP.</span><span class="sxs-lookup"><span data-stu-id="51380-122">For more advanced scenarios, you can create the virtual network first, which lets you control things like how the subnets are configured, on-premises connectivity, and IP addressing.</span></span> <span data-ttu-id="51380-123">Para obter mais informações, consulte [Configurar rede avançada no AKS (Serviço de Kubernetes do Azure)](/azure/aks/configure-advanced-networking).</span><span class="sxs-lookup"><span data-stu-id="51380-123">For more information, see [Configure advanced networking in Azure Kubernetes Service (AKS)](/azure/aks/configure-advanced-networking).</span></span>

<span data-ttu-id="51380-124">**Entrada**.</span><span class="sxs-lookup"><span data-stu-id="51380-124">**Ingress**.</span></span> <span data-ttu-id="51380-125">Uma entrada expõe as rotas de HTTP(S) para serviços dentro do cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-125">An ingress exposes HTTP(S) routes to services inside the cluster.</span></span> <span data-ttu-id="51380-126">Para obter mais informações, consulte a seção [Gateway de API](#api-gateway) abaixo.</span><span class="sxs-lookup"><span data-stu-id="51380-126">For more information, see the section [API Gateway](#api-gateway) below.</span></span>

<span data-ttu-id="51380-127">**Armazenamentos de dados externos**.</span><span class="sxs-lookup"><span data-stu-id="51380-127">**External data stores**.</span></span> <span data-ttu-id="51380-128">Microsserviços são normalmente sem estado e gravam o estado em armazenamentos de dados externos, como o Banco de Dados SQL ou o Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="51380-128">Microservices are typically stateless and write state to external data stores, such as Azure SQL Database or Cosmos DB.</span></span>

<span data-ttu-id="51380-129">**Active Directory do Azure**.</span><span class="sxs-lookup"><span data-stu-id="51380-129">**Azure Active Directory**.</span></span> <span data-ttu-id="51380-130">O AKS usa uma identidade do Azure AD (Azure Active Directory) para criar e gerenciar outros recursos do Azure, como os balanceadores de carga do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-130">AKS uses an Azure Active Directory (Azure AD) identity to create and manage other Azure resources such as Azure load balancers.</span></span> <span data-ttu-id="51380-131">O Azure AD também é recomendado para autenticação de usuário em aplicativos cliente.</span><span class="sxs-lookup"><span data-stu-id="51380-131">Azure AD is also recommended for user authentication in client applications.</span></span>

<span data-ttu-id="51380-132">**Registro de Contêiner do Azure**.</span><span class="sxs-lookup"><span data-stu-id="51380-132">**Azure Container Registry**.</span></span> <span data-ttu-id="51380-133">Use o Registro de Contêiner para armazenar imagens privadas do Docker, que são implantadas no cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-133">Use Container Registry to store private Docker images, which are deployed to the cluster.</span></span> <span data-ttu-id="51380-134">O AKS pode fazer a autenticação com o Registro de Contêiner usando sua identidade do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="51380-134">AKS can authenticate with Container Registry using its Azure AD identity.</span></span> <span data-ttu-id="51380-135">Observe que o AKS não exige o Registro de Contêiner do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-135">Note that AKS does not require Azure Container Registry.</span></span> <span data-ttu-id="51380-136">Você pode usar outros registros de contêiner, como o Hub do Docker.</span><span class="sxs-lookup"><span data-stu-id="51380-136">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="51380-137">**Azure Pipelines**.</span><span class="sxs-lookup"><span data-stu-id="51380-137">**Azure Pipelines**.</span></span> <span data-ttu-id="51380-138">O Azure Pipelines faz parte dos serviços de DevOps do Azure e executa compilações, testes e implantações automatizadas.</span><span class="sxs-lookup"><span data-stu-id="51380-138">Pipelines is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="51380-139">Você também pode usar soluções de CI/CD de terceiros, como o Jenkins.</span><span class="sxs-lookup"><span data-stu-id="51380-139">You can also use third-party CI/CD solutions such as Jenkins.</span></span> 

<span data-ttu-id="51380-140">**Helm**.</span><span class="sxs-lookup"><span data-stu-id="51380-140">**Helm**.</span></span> <span data-ttu-id="51380-141">O Helm funciona como um gerenciador de pacotes para o Kubernetes &mdash; e é uma maneira de agrupar objetos Kubernetes em uma única unidade que você pode publicar, implantar, atualizar e controlar a versão.</span><span class="sxs-lookup"><span data-stu-id="51380-141">Helm is as a package manager for Kubernetes &mdash; a way to bundle Kubernetes objects into a single unit that you can publish, deploy, version, and update.</span></span>

<span data-ttu-id="51380-142">**Azure Monitor**.</span><span class="sxs-lookup"><span data-stu-id="51380-142">**Azure Monitor**.</span></span> <span data-ttu-id="51380-143">O Azure Monitor coleta e armazena métricas e logs, inclusive a métrica de plataforma para os serviços do Azure na telemetria do aplicativo e da solução.</span><span class="sxs-lookup"><span data-stu-id="51380-143">Azure Monitor collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="51380-144">Use esses dados para monitorar o aplicativo, configurar alertas e painéis e executar a análise da causa raiz de falhas.</span><span class="sxs-lookup"><span data-stu-id="51380-144">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="51380-145">O Azure Monitor integra-se ao AKS para coletar métricas de controladores, nós e contêineres, bem como logs do contêiner e logs do nó mestre.</span><span class="sxs-lookup"><span data-stu-id="51380-145">Azure Monitor integrates with AKS to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="51380-146">Considerações sobre o design</span><span class="sxs-lookup"><span data-stu-id="51380-146">Design considerations</span></span>

<span data-ttu-id="51380-147">Essa arquitetura de referência se concentra em arquiteturas de microsserviços, embora muitas das práticas recomendadas serão aplicáveis a outras cargas de trabalho em execução no AKS.</span><span class="sxs-lookup"><span data-stu-id="51380-147">This reference architecture is focused on microservices architectures, although many of the recommended practices will apply to other workloads running on AKS.</span></span>

### <a name="microservices"></a><span data-ttu-id="51380-148">Microsserviços</span><span class="sxs-lookup"><span data-stu-id="51380-148">Microservices</span></span>

<span data-ttu-id="51380-149">O objeto Kubernetes Service é uma maneira natural de modelar microsserviços no Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-149">The Kubernetes Service object is a natural way to model microservices in Kubernetes.</span></span> <span data-ttu-id="51380-150">Um microsserviço é uma unidade flexível, com implantação independente do código.</span><span class="sxs-lookup"><span data-stu-id="51380-150">A microservice is a loosely coupled, independently deployable unit of code.</span></span> <span data-ttu-id="51380-151">Os microsserviços normalmente se comunicam por meio de APIs bem definidas e podem ser descobertos por alguma forma de descoberta de serviços.</span><span class="sxs-lookup"><span data-stu-id="51380-151">Microservices typically communicate through well-defined APIs, and are discoverable through some form of service discovery.</span></span> <span data-ttu-id="51380-152">O objeto Kubernetes Service fornece um conjunto de recursos que correspondem a estes requisitos:</span><span class="sxs-lookup"><span data-stu-id="51380-152">The Kubernetes Service object provides a set of capabilities that match these requirements:</span></span>

- <span data-ttu-id="51380-153">Endereço IP.</span><span class="sxs-lookup"><span data-stu-id="51380-153">IP address.</span></span> <span data-ttu-id="51380-154">O objeto Service fornece um endereço IP interno estático para um grupo de pods (ReplicaSet).</span><span class="sxs-lookup"><span data-stu-id="51380-154">The Service object provides a static internal IP address for a group of pods (ReplicaSet).</span></span> <span data-ttu-id="51380-155">À medida que os pods são criados ou movidos, o serviço fica sempre acessível nesse endereço IP interno.</span><span class="sxs-lookup"><span data-stu-id="51380-155">As pods are created or moved around, the service is always reachable at this internal IP address.</span></span>

- <span data-ttu-id="51380-156">Balanceamento de carga.</span><span class="sxs-lookup"><span data-stu-id="51380-156">Load balancing.</span></span> <span data-ttu-id="51380-157">A carga do tráfego enviado para o endereço IP do serviço é balanceada nos pods.</span><span class="sxs-lookup"><span data-stu-id="51380-157">Traffic sent to the service's IP address is load balanced to the pods.</span></span> 

- <span data-ttu-id="51380-158">Descoberta de serviço.</span><span class="sxs-lookup"><span data-stu-id="51380-158">Service discovery.</span></span> <span data-ttu-id="51380-159">Os serviços recebem entradas DNS internas do serviço DNS do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-159">Services are assigned internal DNS entries by the Kubernetes DNS service.</span></span> <span data-ttu-id="51380-160">Isso significa que o gateway de API pode chamar um serviço de back-end usando o nome DNS.</span><span class="sxs-lookup"><span data-stu-id="51380-160">That means the API gateway can call a backend service using the DNS name.</span></span> <span data-ttu-id="51380-161">O mesmo mecanismo pode ser usado para comunicação entre serviços.</span><span class="sxs-lookup"><span data-stu-id="51380-161">The same mechanism can be used for service-to-service communication.</span></span> <span data-ttu-id="51380-162">As entradas DNS são organizadas por namespace e, portanto, se seus namespaces correspondem aos contextos limitados, o nome DNS para um serviço será mapeado naturalmente para o domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="51380-162">The DNS entries are organized by namespace, so if your namespaces correspond to bounded contexts, then the DNS name for a service will map naturally to the application domain.</span></span>

<span data-ttu-id="51380-163">O diagrama a seguir mostra a relação conceitual entre serviços e pods.</span><span class="sxs-lookup"><span data-stu-id="51380-163">The following diagram show the conceptual relation between services and pods.</span></span> <span data-ttu-id="51380-164">O mapeamento real para portas e endereços IP do ponto de extremidade é feito pelo kube-proxy, o proxy de rede do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-164">The actual mapping to endpoint IP addresses and ports is done by kube-proxy, the Kubernetes network proxy.</span></span>

![Serviços e pods](./_images/aks-services.png)

### <a name="api-gateway"></a><span data-ttu-id="51380-166">Gateway de API</span><span class="sxs-lookup"><span data-stu-id="51380-166">API Gateway</span></span>

<span data-ttu-id="51380-167">Um *gateway de API* é um gateway que se posiciona entre os clientes externos e os microsserviços.</span><span class="sxs-lookup"><span data-stu-id="51380-167">An *API gateway* is a gateway that sits between external clients and the microservices.</span></span> <span data-ttu-id="51380-168">Ele atua como um proxy reverso, encaminhando as solicitações de clientes para os microsserviços.</span><span class="sxs-lookup"><span data-stu-id="51380-168">It acts as a reverse proxy, routing requests from clients to microservices.</span></span> <span data-ttu-id="51380-169">Ele também pode executar várias tarefas detalhadas, como autenticação, terminação de SSL e a limitação de taxa.</span><span class="sxs-lookup"><span data-stu-id="51380-169">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> 

<span data-ttu-id="51380-170">A funcionalidade fornecida por um gateway pode ser agrupada da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="51380-170">Functionality provided by a gateway can be grouped as follows:</span></span>

- <span data-ttu-id="51380-171">[Roteamento de Gateway](../../patterns/gateway-routing.md): roteamento de solicitações de cliente para os serviços de back-end corretos.</span><span class="sxs-lookup"><span data-stu-id="51380-171">[Gateway Routing](../../patterns/gateway-routing.md): Routing client requests to the right backend services.</span></span> <span data-ttu-id="51380-172">Isso cria um ponto de extremidade único para os clientes e ajuda a separar clientes de serviços.</span><span class="sxs-lookup"><span data-stu-id="51380-172">This provides a single endpoint for clients, and helps to decouple clients from services.</span></span>

- <span data-ttu-id="51380-173">[Agregação de Gateway](../../patterns/gateway-aggregation.md): agregação de várias solicitações em uma única solicitação, para reduzir conversas entre o cliente e o back-end.</span><span class="sxs-lookup"><span data-stu-id="51380-173">[Gateway Aggregation](../../patterns/gateway-aggregation.md): Aggregation of multiple requests into a single request, to reduce chattiness between the client and the backend.</span></span>

- <span data-ttu-id="51380-174">[Descarregamento de gateway](../../patterns/gateway-offloading.md).</span><span class="sxs-lookup"><span data-stu-id="51380-174">[Gateway Offloading](../../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="51380-175">Um gateway pode descarregar funcionalidades de serviços de back-end, como terminação SSL, autenticação, lista de permissões de IP ou limitação de taxa do cliente (limitação).</span><span class="sxs-lookup"><span data-stu-id="51380-175">A gateway can offload functionality from the backend services, such as SSL termination, authentication, IP whitelisting, or client rate limiting (throttling).</span></span>

<span data-ttu-id="51380-176">Gateways de API são um [padrão de design de microsserviços](https://microservices.io/patterns/apigateway.html) geral.</span><span class="sxs-lookup"><span data-stu-id="51380-176">API gateways are a general [microservices design pattern](https://microservices.io/patterns/apigateway.html).</span></span> <span data-ttu-id="51380-177">Elas podem ser implementadas usando várias tecnologias diferentes.</span><span class="sxs-lookup"><span data-stu-id="51380-177">They can be implemented using a number of different technologies.</span></span> <span data-ttu-id="51380-178">Provavelmente, a implementação mais comum é a implantação de um roteador de borda ou proxy reverso, como Nginx, HAProxy ou Traefik, dentro do cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-178">Probably the most common implementation is to deploy an edge router or reverse proxy, such as Nginx, HAProxy, or Traefik, inside the cluster.</span></span> 

<span data-ttu-id="51380-179">Outras opções incluem:</span><span class="sxs-lookup"><span data-stu-id="51380-179">Other options include:</span></span>

- <span data-ttu-id="51380-180">Gateway de Aplicativo do Azure e/ou do Gerenciamento de API do Azure, que são dois serviços gerenciados que residem fora do cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-180">Azure Application Gateway and/or Azure API-Management, which are both managed services that reside outside of the cluster.</span></span> <span data-ttu-id="51380-181">Um Controlador de Entrada do Gateway de Aplicativo está atualmente em versão beta.</span><span class="sxs-lookup"><span data-stu-id="51380-181">An Application Gateway Ingress Controller is currently in beta.</span></span>

- <span data-ttu-id="51380-182">Proxies do Azure Functions.</span><span class="sxs-lookup"><span data-stu-id="51380-182">Azure Functions Proxies.</span></span> <span data-ttu-id="51380-183">Proxies podem modificar solicitações e respostas e rotear solicitações com base na URL.</span><span class="sxs-lookup"><span data-stu-id="51380-183">Proxies can modify requests and responses and route requests based on URL.</span></span>

<span data-ttu-id="51380-184">O tipo de recurso **Entrada** do Kubernetes abstrai as definições de configuração para um servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="51380-184">The Kubernetes **Ingress** resource type abstracts the configuration settings for a proxy server.</span></span> <span data-ttu-id="51380-185">Ele funciona em conjunto com um controlador de entrada, que fornece a implementação subjacente da Entrada.</span><span class="sxs-lookup"><span data-stu-id="51380-185">It works in conjunction with an ingress controller, which provides the underlying implementation of the Ingress.</span></span> <span data-ttu-id="51380-186">Há controladores de entrada para Nginx, HAProxy, Traefik e Gateway de Aplicativo (versão prévia), entre outros.</span><span class="sxs-lookup"><span data-stu-id="51380-186">There are ingress controllers for Nginx, HAProxy, Traefik, and Application Gateway (preview), among others.</span></span>

<span data-ttu-id="51380-187">O controlador de entrada lida com a configuração do servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="51380-187">The ingress controller handles configuring the proxy server.</span></span> <span data-ttu-id="51380-188">Geralmente, eles exigem arquivos de configuração complexos, que poderão ser difíceis de ajustar se você não for um especialista, por isso, o controlador de entrada é uma boa abstração.</span><span class="sxs-lookup"><span data-stu-id="51380-188">Often these require complex configuration files, which can be hard to tune if you aren't an expert, so the ingress controller is a nice abstraction.</span></span> <span data-ttu-id="51380-189">Além disso, o Controlador de Entrada tem acesso à API do Kubernetes e pode tomar decisões inteligentes sobre o roteamento e o balanceamento de carga.</span><span class="sxs-lookup"><span data-stu-id="51380-189">In addition, the Ingress Controller has access to the Kubernetes API, so it can make intelligent decisions about routing and load balancing.</span></span> <span data-ttu-id="51380-190">Por exemplo, o controlador de entrada Nginx ignora o proxy de rede do kube-proxy.</span><span class="sxs-lookup"><span data-stu-id="51380-190">For example, the Nginx ingress controller bypasses the kube-proxy network proxy.</span></span>

<span data-ttu-id="51380-191">Por outro lado, se você precisa de controle total sobre as configurações, talvez queira ignorar essa abstração e configurar o servidor proxy manualmente.</span><span class="sxs-lookup"><span data-stu-id="51380-191">On the other hand, if you need complete control over the settings, you may want to bypass this abstraction and configure the proxy server manually.</span></span> 

<span data-ttu-id="51380-192">Um servidor proxy reverso é um possível gargalo ou um ponto único de falha, portanto, sempre implante pelo menos duas réplicas para alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="51380-192">A reverse proxy server is a potential bottleneck or single point of failure, so always deploy at least two replicas for high availability.</span></span>

### <a name="data-storage"></a><span data-ttu-id="51380-193">Armazenamento de dados</span><span class="sxs-lookup"><span data-stu-id="51380-193">Data storage</span></span>

<span data-ttu-id="51380-194">Em uma arquitetura de microsserviços, os serviços não devem compartilhar o armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="51380-194">In a microservices architecture, services should not share data storage.</span></span> <span data-ttu-id="51380-195">Cada serviço deve possuir seus próprios dados privados em um armazenamento lógico separado, para evitar dependências ocultas entre serviços.</span><span class="sxs-lookup"><span data-stu-id="51380-195">Each service should own its own private data in a separate logical storage, to avoid hidden dependencies among services.</span></span> <span data-ttu-id="51380-196">O motivo disso é evitar o acoplamento não intencional entre serviços, o que poderá ocorrer se os serviços compartilharem os mesmos esquemas de dados subjacentes.</span><span class="sxs-lookup"><span data-stu-id="51380-196">The reason is to avoid unintentional coupling between services, which can happen when services share the same underlying data schemas.</span></span> <span data-ttu-id="51380-197">Além disso, quando os serviços gerenciam seus próprios armazenamentos de dados, eles podem usar o armazenamento de dados adequado para suas necessidades específicas.</span><span class="sxs-lookup"><span data-stu-id="51380-197">Also, when services manage their own data stores, they can use the right data store for their particular requirements.</span></span> <span data-ttu-id="51380-198">Para obter mais informações, confira [Criando microsserviços: considerações de dados](/azure/architecture/microservices/data-considerations).</span><span class="sxs-lookup"><span data-stu-id="51380-198">For more information, see [Designing microservices: Data considerations](/azure/architecture/microservices/data-considerations).</span></span>

<span data-ttu-id="51380-199">Evite armazenar dados persistentes no armazenamento de cluster local, pois isso vincula os dados ao nó.</span><span class="sxs-lookup"><span data-stu-id="51380-199">Avoid storing persistent data in local cluster storage, because that ties the data to the node.</span></span> <span data-ttu-id="51380-200">Em vez disso:</span><span class="sxs-lookup"><span data-stu-id="51380-200">Instead,</span></span> 

- <span data-ttu-id="51380-201">Use um serviço externo, como o Banco de Dados SQL do Azure ou Cosmos DB *ou*</span><span class="sxs-lookup"><span data-stu-id="51380-201">Use an external service such as Azure SQL Database or Cosmos DB, *or*</span></span>

- <span data-ttu-id="51380-202">Monte um volume persistente usando Discos do Azure ou Arquivos do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-202">Mount a persistent volume using Azure Disks or Azure Files.</span></span> <span data-ttu-id="51380-203">Use os Arquivos do Azure quando o mesmo volume precisar ser compartilhado por vários pods.</span><span class="sxs-lookup"><span data-stu-id="51380-203">Use Azure Files if the same volume needs to be shared by multiple pods.</span></span>

### <a name="namespaces"></a><span data-ttu-id="51380-204">Namespaces</span><span class="sxs-lookup"><span data-stu-id="51380-204">Namespaces</span></span>

<span data-ttu-id="51380-205">Use namespaces para organizar os serviços dentro do cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-205">Use namespaces to organize services within the cluster.</span></span> <span data-ttu-id="51380-206">Todos os objetos em um cluster do Kubernetes pertencem a um namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-206">Every object in a Kubernetes cluster belongs to a namespace.</span></span> <span data-ttu-id="51380-207">Por padrão, quando você cria um novo objeto, ele vai para o namespace `default`.</span><span class="sxs-lookup"><span data-stu-id="51380-207">By default, when you create a new object, it goes into the `default` namespace.</span></span> <span data-ttu-id="51380-208">Porém, é uma boa prática criar namespaces que sejam mais descritivos para ajudar a organizar os recursos no cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-208">But it's a good practice to create namespaces that are more descriptive to help organize the resources in the cluster.</span></span>

<span data-ttu-id="51380-209">Primeiro, os namespaces ajudam a evitar conflitos de nomenclatura.</span><span class="sxs-lookup"><span data-stu-id="51380-209">First, namespaces help prevent naming collisions.</span></span> <span data-ttu-id="51380-210">Quando várias equipes implantam microsserviços no mesmo cluster, com possivelmente centenas de microsserviços, fica difícil administrar se todos vão para o mesmo namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-210">When multiple teams deploy microservices into the same cluster, with possibly hundreds of microservices, it gets hard to manage if they all go into the same namespace.</span></span> <span data-ttu-id="51380-211">Além disso, os namespaces permitem a você:</span><span class="sxs-lookup"><span data-stu-id="51380-211">In addition, namespaces allow you to:</span></span>

- <span data-ttu-id="51380-212">Aplicar restrições de recursos a um namespace, para que o conjunto total de pods atribuído ao namespace não ultrapasse a cota de recursos do namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-212">Apply resource constraints to a namespace, so that the total set of pods assigned to that namespace cannot exceed the resource quota of the namespace.</span></span>

- <span data-ttu-id="51380-213">Aplicar políticas no nível do namespace, incluindo políticas de RBAC e segurança.</span><span class="sxs-lookup"><span data-stu-id="51380-213">Apply policies at the namespace level, including RBAC and security policies.</span></span>

<span data-ttu-id="51380-214">Para uma arquitetura de microsserviços, considere organizar os microsserviços em contextos limitados e criar namespaces para cada contexto limitado.</span><span class="sxs-lookup"><span data-stu-id="51380-214">For a microservices architecture, considering organizing the microservices into bounded contexts, and creating namespaces for each bounded context.</span></span> <span data-ttu-id="51380-215">Por exemplo, todos os microsserviços relativos ao contexto limitado "Preenchimento de pedidos" poderiam ir para o mesmo namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-215">For example, all microservices related to the "Order Fulfillment" bounded context could go into the same namespace.</span></span> <span data-ttu-id="51380-216">Outra alternativa é criar um namespace para cada equipe de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="51380-216">Alternatively, create a namespace for each development team.</span></span>

<span data-ttu-id="51380-217">Posicione os serviços essenciais em seu próprio namespace separado.</span><span class="sxs-lookup"><span data-stu-id="51380-217">Place utility services into their own separate namespace.</span></span> <span data-ttu-id="51380-218">Por exemplo, você pode implantar Elasticsearch ou Prometheus para monitoramento de cluster, ou Tiller para o Helm.</span><span class="sxs-lookup"><span data-stu-id="51380-218">For example, you might deploy Elasticsearch or Prometheus for cluster monitoring, or Tiller for Helm.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="51380-219">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="51380-219">Scalability considerations</span></span>

<span data-ttu-id="51380-220">O Kubernetes dá suporte à expansão em dois níveis:</span><span class="sxs-lookup"><span data-stu-id="51380-220">Kubernetes supports scale-out at two levels:</span></span>

- <span data-ttu-id="51380-221">Dimensionar o número de pods alocado a uma implantação.</span><span class="sxs-lookup"><span data-stu-id="51380-221">Scale the number of pods allocated to a deployment.</span></span>
- <span data-ttu-id="51380-222">Dimensionar os nós no cluster para aumentar os recursos de computação total disponíveis para o cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-222">Scale the nodes in the cluster, to increase the total compute resources available to the cluster.</span></span>

<span data-ttu-id="51380-223">Embora você possa escalar horizontalmente os pods e nós manualmente, recomendamos usar o dimensionamento automático para minimizar a possibilidade de os serviços ficarem sem recursos quando a carga é alta.</span><span class="sxs-lookup"><span data-stu-id="51380-223">Although you can scale out pods and nodes manually, we recommend using autoscaling, to minimize the chance that services will become resource starved under high load.</span></span> <span data-ttu-id="51380-224">Uma estratégia de dimensionamento automático precisa levar em consideração pods e nós.</span><span class="sxs-lookup"><span data-stu-id="51380-224">An autoscaling strategy must take both pods and nodes into account.</span></span> <span data-ttu-id="51380-225">Se você simplesmente escalar os pods horizontalmente, acabará atingindo os limites de recursos dos nós.</span><span class="sxs-lookup"><span data-stu-id="51380-225">If you just scale out the pods, eventually you will reach the resource limits of the nodes.</span></span> 

### <a name="pod-autoscaling"></a><span data-ttu-id="51380-226">Dimensionamento automático de pods</span><span class="sxs-lookup"><span data-stu-id="51380-226">Pod autoscaling</span></span>

<span data-ttu-id="51380-227">O HPA (Dimensionador Automático de Pod Horizontal) dimensiona os pods com base em métricas personalizadas, memória ou CPU observadas.</span><span class="sxs-lookup"><span data-stu-id="51380-227">The Horizontal Pod Autoscaler (HPA) scales pods based on observed CPU, memory, or custom metrics.</span></span> <span data-ttu-id="51380-228">Para configurar o dimensionamento horizontal de pods, você pode especificar uma métrica de destino (por exemplo, 70% da CPU) e o número mínimo e máximo de réplicas.</span><span class="sxs-lookup"><span data-stu-id="51380-228">To configure horizontal pod scaling, you specify a target metric (for example, 70% of CPU), and the minimum and maximum number of replicas.</span></span> <span data-ttu-id="51380-229">Você deve fazer um teste de carga nos serviços para obter esses números.</span><span class="sxs-lookup"><span data-stu-id="51380-229">You should load test your services to derive these numbers.</span></span>

<span data-ttu-id="51380-230">Um efeito colateral do dimensionamento automático é que os pods podem ser criados ou removidos com maior frequência, de acordo com os eventos de expansão e redução horizontal ocorridos.</span><span class="sxs-lookup"><span data-stu-id="51380-230">A side-effect of autoscaling is that pods may be created or evicted more frequently, as scale-out and scale-in events happen.</span></span> <span data-ttu-id="51380-231">Para reduzir os efeitos disso:</span><span class="sxs-lookup"><span data-stu-id="51380-231">To mitigate the effects of this:</span></span>

- <span data-ttu-id="51380-232">Use investigações de preparação para que o Kubernetes saiba quando um novo pod está pronto para aceitar tráfego.</span><span class="sxs-lookup"><span data-stu-id="51380-232">Use readiness probes to let Kubernetes know when a new pod is ready to accept traffic.</span></span>
- <span data-ttu-id="51380-233">Use os orçamentos de interrupção de pod para limitar quantos pods podem ser removidos de um serviço de cada vez.</span><span class="sxs-lookup"><span data-stu-id="51380-233">Use pod disruption budgets to limit how many pods can be evicted from a service at a time.</span></span>

### <a name="cluster-autoscaling"></a><span data-ttu-id="51380-234">Dimensionamento automático do cluster</span><span class="sxs-lookup"><span data-stu-id="51380-234">Cluster autoscaling</span></span>

<span data-ttu-id="51380-235">O dimensionador automático de cluster dimensiona o número de nós.</span><span class="sxs-lookup"><span data-stu-id="51380-235">The cluster autoscaler scales the number of nodes.</span></span> <span data-ttu-id="51380-236">Se pods não puderem ser agendados devido a restrições de recursos, o dimensionador automático de cluster provisionará mais nós.</span><span class="sxs-lookup"><span data-stu-id="51380-236">If pods can't be scheduled because of resource constraints, the cluster autoscaler will provision more nodes.</span></span>  <span data-ttu-id="51380-237">(Observação: a integração entre o AKS e o dimensionador automático de cluster está atualmente em versão prévia.)</span><span class="sxs-lookup"><span data-stu-id="51380-237">(Note: Integration between AKS and the cluster autoscaler is currently in preview.)</span></span>

<span data-ttu-id="51380-238">Enquanto o HPA examina os recursos reais consumidos ou outras métricas dos pods em execução, o dimensionador automático de cluster está provisionando nós para pods que ainda não estão agendados.</span><span class="sxs-lookup"><span data-stu-id="51380-238">Whereas HPA looks at actual resources consumed or other metrics from running pods, the cluster autoscaler is provisioning nodes for pods that aren't scheduled yet.</span></span> <span data-ttu-id="51380-239">Portanto, ele examina os recursos solicitados, conforme especificado nas especificações de pod do Kubernetes para uma determinada implantação.</span><span class="sxs-lookup"><span data-stu-id="51380-239">Therefore, it looks at the requested resources, as specified in the Kubernetes pod spec for a deployment.</span></span> <span data-ttu-id="51380-240">Use o teste de carga para ajustar esses valores.</span><span class="sxs-lookup"><span data-stu-id="51380-240">Use load testing to fine-tune these values.</span></span>

<span data-ttu-id="51380-241">Não é possível mudar o tamanho da VM depois de criar um cluster, ou seja, é necessário fazer um planejamento da capacidade inicial para escolher um tamanho de VM adequado para os nós de agente ao criar o cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-241">You can't change the VM size after you create the cluster, so you should do some initial capacity planning to choose an appropriate VM size for the agent nodes when you create the cluster.</span></span> 

## <a name="availability-considerations"></a><span data-ttu-id="51380-242">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="51380-242">Availability considerations</span></span>

### <a name="health-probes"></a><span data-ttu-id="51380-243">Investigações de integridade</span><span class="sxs-lookup"><span data-stu-id="51380-243">Health probes</span></span>

<span data-ttu-id="51380-244">O Kubernetes define dois tipos de investigação de integridade que um pod pode expor:</span><span class="sxs-lookup"><span data-stu-id="51380-244">Kubernetes defines two types of health probe that a pod can expose:</span></span>

- <span data-ttu-id="51380-245">Investigação de preparação: informa ao Kubernetes se o pod está pronto para aceitar solicitações.</span><span class="sxs-lookup"><span data-stu-id="51380-245">Readiness probe: Tells Kubernetes whether the pod is ready to accept requests.</span></span>

- <span data-ttu-id="51380-246">Investigação de atividade: informa ao Kubernetes se um pod precisa ser removido e uma nova instância precisa ser iniciada.</span><span class="sxs-lookup"><span data-stu-id="51380-246">Liveness probe: Tells Kubernetes whether a pod should be removed and a new instance started.</span></span>

<span data-ttu-id="51380-247">Ao pensar sobre os testes, é útil se lembrar de como funciona um serviço no Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-247">When thinking about probes, it's useful to recall how a service works in Kubernetes.</span></span> <span data-ttu-id="51380-248">Um serviço tem um seletor de rótulo que corresponde a um conjunto de pods (zero ou mais).</span><span class="sxs-lookup"><span data-stu-id="51380-248">A service has a label selector that matches a set of (zero or more) pods.</span></span> <span data-ttu-id="51380-249">O Kubernetes balanceia a carga de tráfego para os pods que correspondem ao seletor.</span><span class="sxs-lookup"><span data-stu-id="51380-249">Kubernetes load balances traffic to the pods that match the selector.</span></span> <span data-ttu-id="51380-250">Somente os pods que foram iniciados com êxito e estão íntegros recebem tráfego.</span><span class="sxs-lookup"><span data-stu-id="51380-250">Only pods that started successfully and are healthy receive traffic.</span></span> <span data-ttu-id="51380-251">Em caso de falha de um contêiner, o Kubernetes elimina o pod e agenda uma substituição.</span><span class="sxs-lookup"><span data-stu-id="51380-251">If a container crashes, Kubernetes kills the pod and schedules a replacement.</span></span>

<span data-ttu-id="51380-252">Às vezes, um pod pode não estar pronto para receber tráfego, mesmo que tenha sido iniciado com êxito.</span><span class="sxs-lookup"><span data-stu-id="51380-252">Sometimes, a pod may not be ready to receive traffic, even though the pod started successfully.</span></span> <span data-ttu-id="51380-253">Por exemplo, pode haver tarefas de inicialização em que o aplicativo em execução no contêiner carregue coisas na memória ou leia dados de configuração.</span><span class="sxs-lookup"><span data-stu-id="51380-253">For example, there may be initialization tasks, where the application running in the container loads things into memory or reads configuration data.</span></span> <span data-ttu-id="51380-254">Para indicar que um pod está íntegro, mas não está pronto para receber tráfego, defina uma investigação de preparação.</span><span class="sxs-lookup"><span data-stu-id="51380-254">To indicate that a pod is healthy but not ready to receive traffic, define a readiness probe.</span></span> 

<span data-ttu-id="51380-255">As investigações de atividade lidam com pods ainda em execução, mas que não estão íntegros e devem ser reciclados.</span><span class="sxs-lookup"><span data-stu-id="51380-255">Liveness probes handle the case where a pod is still running, but is unhealthy and should be recycled.</span></span> <span data-ttu-id="51380-256">Por exemplo, suponha que um contêiner esteja atendendo a solicitações HTTP, mas pare de responder por algum motivo.</span><span class="sxs-lookup"><span data-stu-id="51380-256">For example, suppose that a container is serving HTTP requests but hangs for some reason.</span></span> <span data-ttu-id="51380-257">O contêiner não falha, mas ele para de atender às solicitações.</span><span class="sxs-lookup"><span data-stu-id="51380-257">The container doesn't crash, but it has stopped serving any requests.</span></span> <span data-ttu-id="51380-258">Se você definir uma investigação de atividade de HTTP, a investigação vai parar de responder e informa ao Kubernetes para reiniciar o pod.</span><span class="sxs-lookup"><span data-stu-id="51380-258">If you define an HTTP liveness probe, the probe will stop responding and that informs Kubernetes to restart the pod.</span></span>

<span data-ttu-id="51380-259">Aqui estão algumas considerações para a criação de testes:</span><span class="sxs-lookup"><span data-stu-id="51380-259">Here are some considerations when designing probes:</span></span>

- <span data-ttu-id="51380-260">Se o código tem um longo tempo de inicialização, há o risco de uma investigação de atividade relatar falha antes da conclusão da inicialização.</span><span class="sxs-lookup"><span data-stu-id="51380-260">If your code has a long startup time, there is a danger that a liveness probe will report failure before the startup completes.</span></span> <span data-ttu-id="51380-261">Para evitar isso, use a configuração initialDelaySeconds, que atrasa o início da investigação.</span><span class="sxs-lookup"><span data-stu-id="51380-261">To prevent this, use the initialDelaySeconds setting, which delays the probe from starting.</span></span>

- <span data-ttu-id="51380-262">A investigação de atividade só ajuda se a reinicialização do pod tiver chance de restaurá-lo para um estado íntegro.</span><span class="sxs-lookup"><span data-stu-id="51380-262">A liveness probe doesn't help unless restarting the pod is likely to restore it to a healthy state.</span></span> <span data-ttu-id="51380-263">Você pode usar uma investigação de atividade para reduzir vazamentos de memória ou deadlocks inesperados, mas não há nenhuma razão para reiniciar um pod que vai falhar novamente de imediato.</span><span class="sxs-lookup"><span data-stu-id="51380-263">You can use a liveness probe to mitigate against memory leaks or unexpected deadlocks, but there's no point in restarting a pod that's going to immediately fail again.</span></span>

- <span data-ttu-id="51380-264">Às vezes, as investigações de preparação são usadas para verificar serviços dependentes.</span><span class="sxs-lookup"><span data-stu-id="51380-264">Sometimes readiness probes are used to check dependent services.</span></span> <span data-ttu-id="51380-265">Por exemplo, se um pod tem uma dependência em um banco de dados, a investigação de atividade pode verificar a conexão de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="51380-265">For example, if a pod has a dependency on a database, the liveness probe might check the database connection.</span></span> <span data-ttu-id="51380-266">No entanto, essa abordagem pode criar problemas inesperados.</span><span class="sxs-lookup"><span data-stu-id="51380-266">However, this approach can create unexpected problems.</span></span> <span data-ttu-id="51380-267">Um serviço externo pode estar temporariamente indisponível por algum motivo.</span><span class="sxs-lookup"><span data-stu-id="51380-267">An external service might be temporarily unavailable for some reason.</span></span> <span data-ttu-id="51380-268">Isso fará com que a investigação de preparação falhe em todos os pods do serviço, fazendo com que todos sejam removidos do balanceamento de carga e criando falhas em cascata upstream.</span><span class="sxs-lookup"><span data-stu-id="51380-268">That will cause the readiness probe to fail for all the pods in your service, causing all of them to be removed from load balancing, and thus creating cascading failures upstream.</span></span> <span data-ttu-id="51380-269">Uma abordagem melhor é implementar o tratamento de repetição no serviço, para que seu serviço possa se recuperar corretamente de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="51380-269">A better approach is to implement retry handling within your service, so that your service can recover correctly from transient failures.</span></span>

### <a name="resource-constraints"></a><span data-ttu-id="51380-270">Restrições de recursos</span><span class="sxs-lookup"><span data-stu-id="51380-270">Resource constraints</span></span>

<span data-ttu-id="51380-271">A contenção de recursos pode afetar a disponibilidade de um serviço.</span><span class="sxs-lookup"><span data-stu-id="51380-271">Resource contention can affect the availability of a service.</span></span> <span data-ttu-id="51380-272">Defina restrições de recursos para contêineres, para que um mesmo contêiner não possa sobrecarregar os recursos de cluster (memória e CPU).</span><span class="sxs-lookup"><span data-stu-id="51380-272">Define resource constraints for containers, so that a single container cannot overwhelm the cluster resources (memory and CPU).</span></span> <span data-ttu-id="51380-273">Para recursos que não são de contêiner, como threads ou conexões de rede, considere o uso do [Padrão de Bulkhead](/azure/architecture/patterns/bulkhead) para isolar recursos.</span><span class="sxs-lookup"><span data-stu-id="51380-273">For non-container resources, such as threads or network connections, consider using the [Bulkhead Pattern](/azure/architecture/patterns/bulkhead) to isolate resources.</span></span>

<span data-ttu-id="51380-274">Use cotas de recursos para limitar o total de recursos permitido para um namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-274">Use resource quotas to limit the total resources allowed for a namespace.</span></span> <span data-ttu-id="51380-275">Dessa forma, o front-end não pode enfraquecer os serviços de back-end por causa de recursos ou vice-versa.</span><span class="sxs-lookup"><span data-stu-id="51380-275">That way, the front end can't starve the backend services for resources or vice-versa.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="51380-276">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="51380-276">Security considerations</span></span>

### <a name="role-based-access-control-rbac"></a><span data-ttu-id="51380-277">RBAC (Controle de Acesso Baseado em Função)</span><span class="sxs-lookup"><span data-stu-id="51380-277">Role based access control (RBAC)</span></span>

<span data-ttu-id="51380-278">O Kubernetes e o Azure têm mecanismos de RBAC (controle de acesso baseado em função):</span><span class="sxs-lookup"><span data-stu-id="51380-278">Kubernetes and Azure both have mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="51380-279">O RBAC do Azure controla o acesso aos recursos no Azure, incluindo a capacidade de criar novos recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-279">Azure RBAC controls access to resources in Azure, including the ability to create new Azure resources.</span></span> <span data-ttu-id="51380-280">As permissões podem ser atribuídas a usuários, grupos ou entidades de serviço.</span><span class="sxs-lookup"><span data-stu-id="51380-280">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="51380-281">(Uma entidade de serviço é uma identidade de segurança usada pelos aplicativos.)</span><span class="sxs-lookup"><span data-stu-id="51380-281">(A service principal is a security identity used by applications.)</span></span>

- <span data-ttu-id="51380-282">O RBAC do Kubernetes controla permissões para a API do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-282">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="51380-283">Por exemplo, a criação e a listagem de pods são ações que podem ser autorizadas (ou negadas) a um usuário por meio de RBAC.</span><span class="sxs-lookup"><span data-stu-id="51380-283">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="51380-284">Para atribuir permissões de Kubernetes aos usuários, você cria *funções* e *associações de função*:</span><span class="sxs-lookup"><span data-stu-id="51380-284">To assign Kubernetes permissions to users, you create *roles* and *role bindings*:</span></span>

  - <span data-ttu-id="51380-285">Role é um conjunto de permissões que se aplicam dentro de um namespace.</span><span class="sxs-lookup"><span data-stu-id="51380-285">A Role is a set of permissions that apply within a namespace.</span></span> <span data-ttu-id="51380-286">As permissões são definidas como verbos (obter, atualizar, criar, excluir) em recursos (pods, implantações, etc.).</span><span class="sxs-lookup"><span data-stu-id="51380-286">Permissions are defined as verbs (get, update, create, delete) on resources (pods, deployments, etc.).</span></span>

  - <span data-ttu-id="51380-287">Um RoleBinding atribui usuários ou grupos a um Role.</span><span class="sxs-lookup"><span data-stu-id="51380-287">A RoleBinding assigns users or groups to a Role.</span></span>

  - <span data-ttu-id="51380-288">Também há um objeto ClusterRole, que é como Role, mas se aplica a todo o cluster em todos os namespaces.</span><span class="sxs-lookup"><span data-stu-id="51380-288">There is also a ClusterRole object, which is like a Role but applies to the entire cluster, across all namespaces.</span></span> <span data-ttu-id="51380-289">Para atribuir usuários ou grupos a um ClusterRole, crie um ClusterRoleBinding.</span><span class="sxs-lookup"><span data-stu-id="51380-289">To assign users or groups to a ClusterRole, create a ClusterRoleBinding.</span></span>

<span data-ttu-id="51380-290">O AKS integra esses dois mecanismos de RBAC.</span><span class="sxs-lookup"><span data-stu-id="51380-290">AKS integrates these two RBAC mechanisms.</span></span> <span data-ttu-id="51380-291">Quando você cria um cluster do AKS, é possível configurá-lo para usar o Azure AD na autenticação de usuários.</span><span class="sxs-lookup"><span data-stu-id="51380-291">When you create an AKS cluster, you can configure it to use Azure AD for user authentication.</span></span> <span data-ttu-id="51380-292">Para obter detalhes sobre como configurar isso, confira [Integrar o Azure Active Directory com o Serviço de Kubernetes do Azure](/azure/aks/aad-integration).</span><span class="sxs-lookup"><span data-stu-id="51380-292">For details on how to set this up, see [Integrate Azure Active Directory with Azure Kubernetes Service](/azure/aks/aad-integration).</span></span>

<span data-ttu-id="51380-293">Depois que isso é configurado, um usuário que deseja acessar a API do Kubernetes (por exemplo, por kubectl) deve entrar usando suas credenciais do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="51380-293">Once this is configured, a user who wants to access the Kubernetes API (for example, through kubectl) must sign in using their Azure AD credentials.</span></span>

<span data-ttu-id="51380-294">Por padrão, um usuário do Azure AD não tem acesso ao cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-294">By default, an Azure AD user has no access to the cluster.</span></span> <span data-ttu-id="51380-295">Para conceder acesso, o administrador de cluster cria RoleBindings que se referem a grupos ou usuários do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="51380-295">To grant access, the cluster administrator creates RoleBindings that refer to Azure AD users or groups.</span></span> <span data-ttu-id="51380-296">Se um usuário não tiver permissões para determinada operação, ela falhará.</span><span class="sxs-lookup"><span data-stu-id="51380-296">If a user doesn't have permissions for a particular operation, it will fail.</span></span>

<span data-ttu-id="51380-297">Se os usuários não têm acesso por padrão, como o administrador de cluster tem permissão para criar as associações de função, para começar?</span><span class="sxs-lookup"><span data-stu-id="51380-297">If users have no access by default, how does the cluster admin have permission to create the role bindings in the first place?</span></span> <span data-ttu-id="51380-298">Um cluster do AKS, na verdade, tem dois tipos de credenciais para chamar o servidor de API do Kubernetes: usuário de cluster e o administrador de cluster. As credenciais de administrador de cluster concedem acesso total ao cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-298">An AKS cluster actually has two types of credentials for calling the Kubernetes API server: cluster user and cluster admin. The cluster admin credentials grant full access to the cluster.</span></span> <span data-ttu-id="51380-299">O comando da CLI do Azure `az aks get-credentials --admin` baixa as credenciais de administrador de cluster e as salva em seu arquivo kubeconfig.</span><span class="sxs-lookup"><span data-stu-id="51380-299">The Azure CLI command `az aks get-credentials --admin` downloads the cluster admin credentials and saves them into your kubeconfig file.</span></span> <span data-ttu-id="51380-300">O administrador de cluster pode usar esse kubeconfig para criar funções e associações de função.</span><span class="sxs-lookup"><span data-stu-id="51380-300">The cluster administrator can use this kubeconfig to create roles and role bindings.</span></span>

<span data-ttu-id="51380-301">Como as credenciais de administrador de cluster têm muito poder, use o RBAC do Azure para restringir o acesso a elas:</span><span class="sxs-lookup"><span data-stu-id="51380-301">Because the cluster admin credentials are so powerful, use Azure RBAC to restrict access to them:</span></span>

- <span data-ttu-id="51380-302">A "Função de administrador de cluster do Serviço de Kubernetes do Azure" tem permissão para baixar as credenciais de administrador de cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-302">The "Azure Kubernetes Service Cluster Admin Role" has permission to download the cluster admin credentials.</span></span> <span data-ttu-id="51380-303">Somente os administradores de cluster devem receber essa função.</span><span class="sxs-lookup"><span data-stu-id="51380-303">Only cluster administrators should be assigned to this role.</span></span>

- <span data-ttu-id="51380-304">A "Função de usuário de cluster do Serviço de Kubernetes do Azure" tem permissão para baixar as credenciais de usuário de cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-304">The "Azure Kubernetes Service Cluster User Role" has permission to download the cluster user credentials.</span></span> <span data-ttu-id="51380-305">Os usuários não administradores não podem receber essa função.</span><span class="sxs-lookup"><span data-stu-id="51380-305">Non-admin users can be assigned to this role.</span></span> <span data-ttu-id="51380-306">Essa função não fornece nenhuma permissão específica em recursos do Kubernetes dentro do cluster &mdash; ela apenas permite que um usuário se conecte ao servidor de API.</span><span class="sxs-lookup"><span data-stu-id="51380-306">This role does not give any particular permissions on Kubernetes resources inside the cluster &mdash; it just allows a user to connect to the API server.</span></span> 

<span data-ttu-id="51380-307">Quando você definir as políticas de RBAC (Kubernetes e Azure), pense sobre as funções em sua organização:</span><span class="sxs-lookup"><span data-stu-id="51380-307">When you define your RBAC policies (both Kubernetes and Azure), think about the roles in your organization:</span></span>

- <span data-ttu-id="51380-308">Quem pode criar ou excluir um cluster do AKS e baixar as credenciais de administrador?</span><span class="sxs-lookup"><span data-stu-id="51380-308">Who can create or delete an AKS cluster and download the admin credentials?</span></span>
- <span data-ttu-id="51380-309">Quem pode administrar um cluster?</span><span class="sxs-lookup"><span data-stu-id="51380-309">Who can administer a cluster?</span></span>
- <span data-ttu-id="51380-310">Quem pode criar ou atualizar recursos dentro de um namespace?</span><span class="sxs-lookup"><span data-stu-id="51380-310">Who can create or update resources within a namespace?</span></span>

<span data-ttu-id="51380-311">É uma boa prática criar o escopo das permissões de RBAC do Kubernetes por namespace, usando Roles e RoleBindings em vez de ClusterRoles e ClusterRoleBindings.</span><span class="sxs-lookup"><span data-stu-id="51380-311">It's a good practice to scope Kubernetes RBAC permissions by namespace, using Roles and RoleBindings, rather than ClusterRoles and ClusterRoleBindings.</span></span>

<span data-ttu-id="51380-312">Por fim, convém saber quais permissões o cluster do AKS tem para criar e gerenciar recursos do Azure, como armazenamento, rede ou balanceadores de carga.</span><span class="sxs-lookup"><span data-stu-id="51380-312">Finally, there is the question of what permissions the AKS cluster has to create and manage Azure resources, such as load balancers, networking, or storage.</span></span> <span data-ttu-id="51380-313">Para se autenticar com as APIs do Azure, o cluster usa uma entidade de serviço do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="51380-313">To authenticate itself with Azure APIs, the cluster uses an Azure AD service principal.</span></span> <span data-ttu-id="51380-314">Se você não especificar uma entidade de serviço ao criar o cluster, uma será criada automaticamente.</span><span class="sxs-lookup"><span data-stu-id="51380-314">If you don't specify a service principal when you create the cluster, one is created automatically.</span></span> <span data-ttu-id="51380-315">No entanto, é uma boa prática de segurança primeiro criar a entidade de serviço e atribuir as permissões mínimas de RBAC a ela.</span><span class="sxs-lookup"><span data-stu-id="51380-315">However, it's a good security practice to create the service principal first and assign the minimal RBAC permissions to it.</span></span> <span data-ttu-id="51380-316">Para obter mais informações, confira [Entidades de serviço com o Serviço de Kubernetes do Azure](/azure/aks/kubernetes-service-principal).</span><span class="sxs-lookup"><span data-stu-id="51380-316">For more information, see [Service principals with Azure Kubernetes Service](/azure/aks/kubernetes-service-principal).</span></span>

### <a name="secrets-management-and-application-credentials"></a><span data-ttu-id="51380-317">Credenciais de aplicativo e gerenciamento de segredos</span><span class="sxs-lookup"><span data-stu-id="51380-317">Secrets management and application credentials</span></span>

<span data-ttu-id="51380-318">Aplicativos e serviços geralmente precisam de credenciais que permitam a eles se conectar a serviços externos, como o Armazenamento do Azure ou o Banco de Dados SQL.</span><span class="sxs-lookup"><span data-stu-id="51380-318">Applications and services often need credentials that allow them to connect to external services such as Azure Storage or SQL Database.</span></span> <span data-ttu-id="51380-319">O desafio é manter essas credenciais seguras e não divulgá-las.</span><span class="sxs-lookup"><span data-stu-id="51380-319">The challenge is to keep these credentials safe and not leak them.</span></span> 

<span data-ttu-id="51380-320">Para recursos do Azure, uma opção é usar identidades gerenciadas.</span><span class="sxs-lookup"><span data-stu-id="51380-320">For Azure resources, one option is to use managed identities.</span></span> <span data-ttu-id="51380-321">A ideia de uma identidade gerenciada é que um aplicativo ou serviço tenha uma identidade armazenada no Azure AD e use essa identidade para se autenticar em um serviço do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-321">The idea of a managed identity is that an application or service has an identity stored in Azure AD, and uses this identity to authenticate with an Azure service.</span></span> <span data-ttu-id="51380-322">O aplicativo ou serviço tem uma entidade de serviço criada para ele no Azure AD e é autenticado usando tokens OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="51380-322">The application or service has a Service Principal created for it in Azure AD, and authenticates using OAuth 2.0 tokens.</span></span> <span data-ttu-id="51380-323">O processo de execução chama um endereço do localhost para obter o token.</span><span class="sxs-lookup"><span data-stu-id="51380-323">The executing process calls a localhost address to get the token.</span></span> <span data-ttu-id="51380-324">Dessa forma, você não precisa armazenar senhas ou cadeias de conexão.</span><span class="sxs-lookup"><span data-stu-id="51380-324">That way, you don't need to store any passwords or connection strings.</span></span> <span data-ttu-id="51380-325">Você pode usar identidades gerenciadas no AKS atribuindo identidades a pods individuais, usando o projeto [aad-pod-identity](https://github.com/Azure/aad-pod-identity).</span><span class="sxs-lookup"><span data-stu-id="51380-325">You can use managed identities in AKS by assigning identities to individual pods, using the [aad-pod-identity](https://github.com/Azure/aad-pod-identity) project.</span></span>

<span data-ttu-id="51380-326">Atualmente, nem todos os serviços do Azure dão suporte à autenticação usando identidades gerenciadas.</span><span class="sxs-lookup"><span data-stu-id="51380-326">Currently, not all Azure services support authentication using managed identities.</span></span> <span data-ttu-id="51380-327">Para obter uma lista, consulte [Serviços do Azure que dão suporte à autenticação do Azure AD](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span><span class="sxs-lookup"><span data-stu-id="51380-327">For a list, see [Azure services that support Azure AD authentication](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span></span>

<span data-ttu-id="51380-328">Mesmo com identidades gerenciadas, você provavelmente precisará armazenar algumas credenciais ou outros segredos do aplicativo, seja para serviços do Azure que não dão suporte a identidades gerenciadas, serviços de terceiros, chaves de API ou outros.</span><span class="sxs-lookup"><span data-stu-id="51380-328">Even with managed identities, you'll probably need to store some credentials or other application secrets, whether for Azure services that don't support managed identities, third-party services, API keys, and so on.</span></span> <span data-ttu-id="51380-329">Aqui estão algumas opções para armazenar segredos com segurança:</span><span class="sxs-lookup"><span data-stu-id="51380-329">Here are some options for storing secrets securely:</span></span>

- <span data-ttu-id="51380-330">Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="51380-330">Azure Key Vault.</span></span> <span data-ttu-id="51380-331">No AKS, você pode montar um ou mais segredos do Key Vault como um volume.</span><span class="sxs-lookup"><span data-stu-id="51380-331">In AKS, you can mount one or more secrets from Key Vault as a volume.</span></span> <span data-ttu-id="51380-332">O volume lê os segredos do Key Vault.</span><span class="sxs-lookup"><span data-stu-id="51380-332">The volume reads the secrets from Key Vault.</span></span> <span data-ttu-id="51380-333">O pod, em seguida, pode ler os segredos como um volume normal.</span><span class="sxs-lookup"><span data-stu-id="51380-333">The pod can then read the secrets just like a regular volume.</span></span> <span data-ttu-id="51380-334">Para obter mais informações, consulte o projeto [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) no GitHub.</span><span class="sxs-lookup"><span data-stu-id="51380-334">For more information, see the [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) project on GitHub.</span></span>

    <span data-ttu-id="51380-335">O pod se autentica usando uma identidade de pod (descrita acima) ou usando uma entidade de serviço do Azure AD, juntamente com um segredo do cliente.</span><span class="sxs-lookup"><span data-stu-id="51380-335">The pod authenticates itself by using either a pod identity (described above) or by using an Azure AD Service Principal along with a client secret.</span></span> <span data-ttu-id="51380-336">O uso de identidades de pod é recomendado porque o segredo do cliente não é necessário nesse caso.</span><span class="sxs-lookup"><span data-stu-id="51380-336">Using pod identities is recommended because the client secret isn't needed in that case.</span></span> 

- <span data-ttu-id="51380-337">HashiCorp Vault.</span><span class="sxs-lookup"><span data-stu-id="51380-337">HashiCorp Vault.</span></span> <span data-ttu-id="51380-338">Os aplicativos do Kubernetes podem se autenticar com o HashiCorp Vault usando identidades gerenciadas do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="51380-338">Kubernetes applications can authenticate with HashiCorp Vault using Azure AD managed identities.</span></span> <span data-ttu-id="51380-339">Confira [O HashiCorp Vault é compatível com o Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/).</span><span class="sxs-lookup"><span data-stu-id="51380-339">See [HashiCorp Vault speaks Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/).</span></span> <span data-ttu-id="51380-340">Você pode implantar o Vault em si no Kubernetes, mas recomendamos executá-lo em um cluster dedicado separado de seu aplicativo cluster.</span><span class="sxs-lookup"><span data-stu-id="51380-340">You can deploy Vault itself to Kubernetes, but it's recommend to run it in a separate dedicated cluster from your application cluster.</span></span> 

- <span data-ttu-id="51380-341">segredos do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-341">Kubernetes secrets.</span></span> <span data-ttu-id="51380-342">Outra opção é simplesmente usar segredos do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="51380-342">Another option is simply to use Kubernetes secrets.</span></span> <span data-ttu-id="51380-343">Essa opção é a mais fácil de configurar, mas tem alguns desafios.</span><span class="sxs-lookup"><span data-stu-id="51380-343">This option is the easiest to configure but has some challenges.</span></span> <span data-ttu-id="51380-344">Os segredos são armazenados em etcd, que é um armazenamento de chave-valor distribuído.</span><span class="sxs-lookup"><span data-stu-id="51380-344">Secrets are stored in etcd, which is a distributed key-value store.</span></span> <span data-ttu-id="51380-345">O AKS [criptografa etcd em repouso](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span><span class="sxs-lookup"><span data-stu-id="51380-345">AKS [encrypts etcd at rest](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span></span> <span data-ttu-id="51380-346">A Microsoft gerencia as chaves de criptografia.</span><span class="sxs-lookup"><span data-stu-id="51380-346">Microsoft manages the encryption keys.</span></span>

<span data-ttu-id="51380-347">Usar um sistema como HashiCorp Vault ou o Azure Key Vault oferece várias vantagens, como:</span><span class="sxs-lookup"><span data-stu-id="51380-347">Using a system like HashiCorp Vault or Azure Key Vault provides several advantages, such as:</span></span>

- <span data-ttu-id="51380-348">Controle centralizado de segredos.</span><span class="sxs-lookup"><span data-stu-id="51380-348">Centralized control of secrets.</span></span>
- <span data-ttu-id="51380-349">Garantia de que todos os segredos sejam criptografados em repouso.</span><span class="sxs-lookup"><span data-stu-id="51380-349">Ensuring that all secrets are encrypted at rest.</span></span>
- <span data-ttu-id="51380-350">Gerenciamento centralizado de chaves.</span><span class="sxs-lookup"><span data-stu-id="51380-350">Centralized key management.</span></span>
- <span data-ttu-id="51380-351">Controle de acesso de segredos.</span><span class="sxs-lookup"><span data-stu-id="51380-351">Access control of secrets.</span></span>
- <span data-ttu-id="51380-352">Auditoria</span><span class="sxs-lookup"><span data-stu-id="51380-352">Auditing</span></span>

### <a name="pod-and-container-security"></a><span data-ttu-id="51380-353">Segurança do pod e do contêiner</span><span class="sxs-lookup"><span data-stu-id="51380-353">Pod and container security</span></span>

<span data-ttu-id="51380-354">Essa lista certamente não inclui todos os exemplos, mas aqui estão algumas práticas recomendadas para proteger seus pods e contêineres:</span><span class="sxs-lookup"><span data-stu-id="51380-354">This list is certainly not exhaustive, but here are some recommended practices for securing your pods and containers:</span></span> 

<span data-ttu-id="51380-355">Não execute contêineres no modo privilegiado.</span><span class="sxs-lookup"><span data-stu-id="51380-355">Don't run containers in privileged mode.</span></span> <span data-ttu-id="51380-356">O modo privilegiado concede acesso ao contêiner para todos os dispositivos no host.</span><span class="sxs-lookup"><span data-stu-id="51380-356">Privileged mode gives a container access to all devices on the host.</span></span> <span data-ttu-id="51380-357">Você pode definir a Política de Segurança de Pod para não permitir que os contêineres sejam executados no modo privilegiado.</span><span class="sxs-lookup"><span data-stu-id="51380-357">You can set Pod Security Policy to disallow containers from running in privileged mode.</span></span> 

<span data-ttu-id="51380-358">Quando possível, evite executar processos como raiz dentro de contêineres.</span><span class="sxs-lookup"><span data-stu-id="51380-358">When possible, avoid running processes as root inside containers.</span></span> <span data-ttu-id="51380-359">Os contêineres não fornecem isolamento completo do ponto de vista de segurança e, portanto, é melhor executar um processo de contêiner como um usuário sem privilégios.</span><span class="sxs-lookup"><span data-stu-id="51380-359">Containers do not provide complete isolation from a security standpoint, so it's better to run a container process as a non-privileged user.</span></span> 

<span data-ttu-id="51380-360">Armazene imagens em um registro privado confiável, como o Registro de Contêiner do Azure ou o Docker Trusted Registry.</span><span class="sxs-lookup"><span data-stu-id="51380-360">Store images in a trusted private registry, such as Azure Container Registry or Docker Trusted Registry.</span></span> <span data-ttu-id="51380-361">Use um webhook de admissão de validação no Kubernetes para fazer com que os pods possam efetuar pull somente de imagens do registro confiável.</span><span class="sxs-lookup"><span data-stu-id="51380-361">Use a validating admission webhook in Kubernetes to ensure that pods can only pull images from the trusted registry.</span></span>

<span data-ttu-id="51380-362">Verifique vulnerabilidades conhecidas nas imagens usando uma solução de verificação como Twistlock e Aqua, que estão disponíveis no Azure Marketplace.</span><span class="sxs-lookup"><span data-stu-id="51380-362">Scan images for known vulnerabilities, using a scanning solution such as Twistlock and Aqua, which are available through the Azure Marketplace.</span></span>

<span data-ttu-id="51380-363">Automatize a aplicação de patch em imagens usando Tarefas do ACR, um recurso do Registro de Contêiner do Azure.</span><span class="sxs-lookup"><span data-stu-id="51380-363">Automate image patching using ACR Tasks, a feature of Azure Container Registry.</span></span> <span data-ttu-id="51380-364">Uma imagem de contêiner baseia-se em camadas.</span><span class="sxs-lookup"><span data-stu-id="51380-364">A container image is built up from layers.</span></span> <span data-ttu-id="51380-365">As camadas de base incluem a imagem do sistema operacional e as imagens da estrutura de aplicativo, como ASP.NET Core ou Node.js.</span><span class="sxs-lookup"><span data-stu-id="51380-365">The base layers include the OS image and application framework images, such as ASP.NET Core or Node.js.</span></span> <span data-ttu-id="51380-366">As imagens de base são normalmente criadas upstream a partir dos desenvolvedores de aplicativos e são mantidas por outros mantenedores do projeto.</span><span class="sxs-lookup"><span data-stu-id="51380-366">The base images are typically created upstream from the application developers, and are maintained by other project maintainers.</span></span> <span data-ttu-id="51380-367">Quando essas imagens são corrigidas upstream, é importante atualizar, testar e reimplantar suas próprias imagens, para que você não deixe passar nenhuma vulnerabilidade de segurança conhecida.</span><span class="sxs-lookup"><span data-stu-id="51380-367">When these images are patched upstream, it's important to update, test, and redeploy your own images, so that you don't leave any known security vulnerabilities.</span></span> <span data-ttu-id="51380-368">As Tarefas do ACR podem ajudar a automatizar esse processo.</span><span class="sxs-lookup"><span data-stu-id="51380-368">ACR Tasks can help to automate this process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="51380-369">Considerações de implantação (CI/CD)</span><span class="sxs-lookup"><span data-stu-id="51380-369">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="51380-370">Aqui estão algumas metas de um processo de CI/CD robusto para uma arquitetura de microsserviços:</span><span class="sxs-lookup"><span data-stu-id="51380-370">Here are some goals of a robust CI/CD process for a microservices architecture:</span></span>

- <span data-ttu-id="51380-371">Cada equipe pode criar e implantar os serviços que ela possui independentemente, sem afetar ou interromper outras equipes.</span><span class="sxs-lookup"><span data-stu-id="51380-371">Each team can build and deploy the services that it owns independently, without affecting or disrupting other teams.</span></span> 

- <span data-ttu-id="51380-372">Antes de uma nova versão de um serviço ser implantada na produção, ela é implantada em ambientes de desenvolvimento/teste/garantia de qualidade para validação.</span><span class="sxs-lookup"><span data-stu-id="51380-372">Before a new version of a service is deployed to production, it gets deployed to dev/test/QA environments for validation.</span></span> <span data-ttu-id="51380-373">Há restrições de qualidade impostas em cada estágio.</span><span class="sxs-lookup"><span data-stu-id="51380-373">Quality gates are enforced at each stage.</span></span>

- <span data-ttu-id="51380-374">Uma nova versão de um serviço pode ser implantada lado a lado com a versão anterior.</span><span class="sxs-lookup"><span data-stu-id="51380-374">A new version of a service can be deployed side-by-side with the previous version.</span></span>

- <span data-ttu-id="51380-375">Há políticas de controle de acesso suficientes em vigor.</span><span class="sxs-lookup"><span data-stu-id="51380-375">Sufficient access control policies are in place.</span></span>

- <span data-ttu-id="51380-376">Você pode confiar nas imagens de contêiner que estão implantadas na produção.</span><span class="sxs-lookup"><span data-stu-id="51380-376">You can trust the container images that are deployed to production.</span></span>

### <a name="isolation-of-environments"></a><span data-ttu-id="51380-377">Isolamento de ambientes</span><span class="sxs-lookup"><span data-stu-id="51380-377">Isolation of environments</span></span>

<span data-ttu-id="51380-378">Você terá vários ambientes com serviços implantados, incluindo ambientes de desenvolvimento, smoke test, testes de integração, testes de carga e, finalmente, produção.</span><span class="sxs-lookup"><span data-stu-id="51380-378">You will have multiple environments where you deploy services, including environments for development, smoke testing, integration testing, load testing, and finally production.</span></span> <span data-ttu-id="51380-379">Esses ambientes precisam de algum nível de isolamento.</span><span class="sxs-lookup"><span data-stu-id="51380-379">These environments need some level of isolation.</span></span> <span data-ttu-id="51380-380">No Kubernetes, você pode escolher entre o isolamento físico e o isolamento lógico.</span><span class="sxs-lookup"><span data-stu-id="51380-380">In Kubernetes, you have a choice between physical isolation and logical isolation.</span></span> <span data-ttu-id="51380-381">Isolamento físico significa implantar em clusters separados.</span><span class="sxs-lookup"><span data-stu-id="51380-381">Physical isolation means deploying to separate clusters.</span></span> <span data-ttu-id="51380-382">O isolamento lógico faz uso de namespaces e as políticas, conforme descrito anteriormente.</span><span class="sxs-lookup"><span data-stu-id="51380-382">Logical isolation makes use of namespaces and policies, as described earlier.</span></span>

<span data-ttu-id="51380-383">Nossa recomendação é criar um cluster de produção dedicado juntamente com um cluster separado para seus ambientes de desenvolvimento/teste.</span><span class="sxs-lookup"><span data-stu-id="51380-383">Our recommendation is to create a dedicated production cluster along with a separate cluster for your dev/test environments.</span></span> <span data-ttu-id="51380-384">Use o isolamento lógico para separar ambientes dentro do cluster de desenvolvimento/teste.</span><span class="sxs-lookup"><span data-stu-id="51380-384">Use logical isolation to separate environments within the dev/test cluster.</span></span> <span data-ttu-id="51380-385">Os serviços implantados no cluster de desenvolvimento/teste nunca devem ter acesso a armazenamentos de dados que contêm dados de negócios.</span><span class="sxs-lookup"><span data-stu-id="51380-385">Services deployed to the dev/test cluster should never have access to data stores that hold business data.</span></span> 

### <a name="helm"></a><span data-ttu-id="51380-386">Helm</span><span class="sxs-lookup"><span data-stu-id="51380-386">Helm</span></span>

<span data-ttu-id="51380-387">Considere usar o Helm para gerenciar, criar e implantar serviços.</span><span class="sxs-lookup"><span data-stu-id="51380-387">Consider using Helm to manage building and deploying services.</span></span> <span data-ttu-id="51380-388">Alguns dos recursos do Helm que ajudam com CI/CD incluem:</span><span class="sxs-lookup"><span data-stu-id="51380-388">Some of the features of Helm that help with CI/CD include:</span></span>

- <span data-ttu-id="51380-389">Organizar todos os objetos de Kubernetes de um microsserviço específico em um único gráfico do Helm.</span><span class="sxs-lookup"><span data-stu-id="51380-389">Organizing all of the Kubernetes objects for a particular microservice into a single Helm chart.</span></span>
- <span data-ttu-id="51380-390">Implantar o gráfico como um comando do Helm único em vez de uma série de comandos kubectl.</span><span class="sxs-lookup"><span data-stu-id="51380-390">Deploying the chart as a single helm command, rather than a series of kubectl commands.</span></span>
- <span data-ttu-id="51380-391">Acompanhar atualizações e revisões, usando controle de versão semântico, além da capacidade de reverter para uma versão anterior.</span><span class="sxs-lookup"><span data-stu-id="51380-391">Tracking updates and revisions, using semantic versioning, along with the ability to roll back to a previous version.</span></span>
- <span data-ttu-id="51380-392">Usar modelos para evitar a duplicação de informações, como rótulos e seletores, em vários arquivos.</span><span class="sxs-lookup"><span data-stu-id="51380-392">The use of templates to avoid duplicating information, such as labels and selectors, across many files.</span></span>
- <span data-ttu-id="51380-393">Gerenciar dependências entre gráficos.</span><span class="sxs-lookup"><span data-stu-id="51380-393">Managing dependencies between charts.</span></span>
- <span data-ttu-id="51380-394">Publicar gráficos em um repositório do Helm, como um Registro de Contêiner do Azure, e integrá-los ao pipeline de build.</span><span class="sxs-lookup"><span data-stu-id="51380-394">Publishing charts to a Helm repository, such as Azure Container Registry, and integrating them with the build pipeline.</span></span> 

<span data-ttu-id="51380-395">Para obter mais informações sobre como usar o Registro de Contêiner como um repositório do Helm, confira [Usar o Registro de Contêiner do Azure como um repositório do Helm para os gráficos do aplicativo](/azure/container-registry/container-registry-helm-repos).</span><span class="sxs-lookup"><span data-stu-id="51380-395">For more information about using Container Registry as a Helm repository, see [Use Azure Container Registry as a Helm repository for your application charts](/azure/container-registry/container-registry-helm-repos).</span></span>

### <a name="cicd-workflow"></a><span data-ttu-id="51380-396">Fluxo de trabalho de CI/CD</span><span class="sxs-lookup"><span data-stu-id="51380-396">CI/CD workflow</span></span>

<span data-ttu-id="51380-397">O diagrama a seguir mostra um fluxo de trabalho de CI/CD possível.</span><span class="sxs-lookup"><span data-stu-id="51380-397">The following diagram shows a possible CI/CD workflow.</span></span> <span data-ttu-id="51380-398">Este exemplo supõe que há uma função de garantia de qualidade que é separada da função de desenvolvedor.</span><span class="sxs-lookup"><span data-stu-id="51380-398">This example assumes there is a QA role that is separate from the developer role.</span></span>

![Fluxo de trabalho de CI/CD](./_images/aks-cicd.png)

1. <span data-ttu-id="51380-400">O desenvolvedor confirma uma alteração que</span><span class="sxs-lookup"><span data-stu-id="51380-400">The developer commits a change, which</span></span>
1. <span data-ttu-id="51380-401">Dispara o pipeline de CI.</span><span class="sxs-lookup"><span data-stu-id="51380-401">Triggers the CI pipeline.</span></span> <span data-ttu-id="51380-402">Esse pipeline compila o código, executa testes e compila a imagem de contêiner.</span><span class="sxs-lookup"><span data-stu-id="51380-402">This pipeline builds the code, runs tests, and builds the container image.</span></span>
1. <span data-ttu-id="51380-403">Se todos os portões forem ultrapassados, a imagem será enviada por push para o repositório de imagens.</span><span class="sxs-lookup"><span data-stu-id="51380-403">If all gates are passed, the image is pushed the image repository.</span></span>
1. <span data-ttu-id="51380-404">Quando uma nova versão de um serviço está pronta para implantação, uma marca é adicionada e</span><span class="sxs-lookup"><span data-stu-id="51380-404">When a new version of a service is ready to deploy, a tag is added, which</span></span>
1. <span data-ttu-id="51380-405">Dispara o pipeline de CD de teste, que executa um comando de atualização do Helm para atualizar o cluster de teste.</span><span class="sxs-lookup"><span data-stu-id="51380-405">Triggers the test CD pipeline, which runs a helm upgrade command to update the test cluster.</span></span>
1. <span data-ttu-id="51380-406">Se a nova versão estiver pronta para implantação na produção, a função de garantia de qualidade disparará o pipeline de CD de produção manualmente.</span><span class="sxs-lookup"><span data-stu-id="51380-406">If the new version is ready to deploy to production, the QA role manually triggers the production CD pipeline.</span></span>

### <a name="recommended-cicd-practices"></a><span data-ttu-id="51380-407">Práticas recomendadas de CI/CD</span><span class="sxs-lookup"><span data-stu-id="51380-407">Recommended CI/CD practices</span></span>

<span data-ttu-id="51380-408">Use imagePullPolicy Always, para que o Kubernetes efetue pull sempre da imagem mais recente do repositório e não use uma imagem em cache.</span><span class="sxs-lookup"><span data-stu-id="51380-408">Use imagePullPolicy of Always, so that Kubernetes will always pull the latest image from the repository, and not use a cached image.</span></span> <span data-ttu-id="51380-409">Você pode impor isso em todo o cluster usando o controlador de admissão AlwaysPullImages.</span><span class="sxs-lookup"><span data-stu-id="51380-409">You can enforce this across the cluster by using the AlwaysPullImages admission controller.</span></span>

<span data-ttu-id="51380-410">Não use a marca `latest` para imagens em uma especificação de pod. Especifique sempre a versão da imagem.</span><span class="sxs-lookup"><span data-stu-id="51380-410">Don't use the `latest` tag for images in a pod spec. Always specify the image version.</span></span>

<span data-ttu-id="51380-411">Use namespaces no Serviço de Contêiner do Azure para organizar as imagens de contêiner pela equipe de desenvolvimento ou microsserviço.</span><span class="sxs-lookup"><span data-stu-id="51380-411">Use namespaces in Azure Container Service to organize container images by microservice or development team.</span></span>

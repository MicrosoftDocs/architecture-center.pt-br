---
title: Aplicativo de N camadas de várias regiões para alta disponibilidade
description: Como implantar VMs em várias regiões no Azure para alta disponibilidade e resiliência.
author: MikeWasson
ms.date: 07/19/2018
pnp.series.title: Windows VM workloads
pnp.series.prev: n-tier
ms.openlocfilehash: 34dd47175e7fd0002cba577ad6c1034968ed4098
ms.sourcegitcommit: b2a4eb132857afa70201e28d662f18458865a48e
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/05/2018
ms.locfileid: "48819118"
---
# <a name="multi-region-n-tier-application-for-high-availability"></a><span data-ttu-id="592ab-103">Aplicativo de N camadas de várias regiões para alta disponibilidade</span><span class="sxs-lookup"><span data-stu-id="592ab-103">Multi-region N-tier application for high availability</span></span>

<span data-ttu-id="592ab-104">Essa arquitetura de referência mostra um conjunto de práticas comprovadas para executar um aplicativo de N camadas em várias regiões do Azure, a fim de alcançar a disponibilidade e uma infraestrutura de recuperação de desastres robusta.</span><span class="sxs-lookup"><span data-stu-id="592ab-104">This reference architecture shows a set of proven practices for running an N-tier application in multiple Azure regions, in order to achieve availability and a robust disaster recovery infrastructure.</span></span> 

<span data-ttu-id="592ab-105">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="592ab-105">[![0]][0]</span></span> 

<span data-ttu-id="592ab-106">*Baixe um [Arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="592ab-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="592ab-107">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="592ab-107">Architecture</span></span> 

<span data-ttu-id="592ab-108">Essa arquitetura baseia-se naquela mostrada em [Aplicativo de N camadas com o SQL Server](n-tier-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="592ab-108">This architecture builds on the one shown in [N-tier application with SQL Server](n-tier-sql-server.md).</span></span> 

* <span data-ttu-id="592ab-109">**Regiões primárias e secundárias**.</span><span class="sxs-lookup"><span data-stu-id="592ab-109">**Primary and secondary regions**.</span></span> <span data-ttu-id="592ab-110">Use duas regiões para obter alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="592ab-110">Use two regions to achieve higher availability.</span></span> <span data-ttu-id="592ab-111">Uma delas é a região primária.</span><span class="sxs-lookup"><span data-stu-id="592ab-111">One is the primary region.</span></span> <span data-ttu-id="592ab-112">A outra região destina-se ao failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-112">The other region is for failover.</span></span>

* <span data-ttu-id="592ab-113">**Gerenciador de Tráfego do Microsoft Azure**.</span><span class="sxs-lookup"><span data-stu-id="592ab-113">**Azure Traffic Manager**.</span></span> <span data-ttu-id="592ab-114">O [Gerenciador de Tráfego][traffic-manager] roteia as solicitações de entrada para uma das regiões.</span><span class="sxs-lookup"><span data-stu-id="592ab-114">[Traffic Manager][traffic-manager] routes incoming requests to one of the regions.</span></span> <span data-ttu-id="592ab-115">Durante as operações normais, ele roteia as solicitações para a região primária.</span><span class="sxs-lookup"><span data-stu-id="592ab-115">During normal operations, it routes requests to the primary region.</span></span> <span data-ttu-id="592ab-116">Se essa região ficar indisponível, o Gerenciador de Tráfego fará failover para a região secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-116">If that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span> <span data-ttu-id="592ab-117">Para obter mais informações, consulte a [Configuração do Gerenciador de Tráfego](#traffic-manager-configuration).</span><span class="sxs-lookup"><span data-stu-id="592ab-117">For more information, see the section [Traffic Manager configuration](#traffic-manager-configuration).</span></span>

* <span data-ttu-id="592ab-118">**Grupos de recursos**.</span><span class="sxs-lookup"><span data-stu-id="592ab-118">**Resource groups**.</span></span> <span data-ttu-id="592ab-119">Crie [grupos de recursos][resource groups] separados para a região primária, a região secundária e para o Gerenciador de Tráfego.</span><span class="sxs-lookup"><span data-stu-id="592ab-119">Create separate [resource groups][resource groups] for the primary region, the secondary region, and for Traffic Manager.</span></span> <span data-ttu-id="592ab-120">Isso oferece flexibilidade para gerenciar cada região como uma única coleção de recursos.</span><span class="sxs-lookup"><span data-stu-id="592ab-120">This gives you the flexibility to manage each region as a single collection of resources.</span></span> <span data-ttu-id="592ab-121">Por exemplo, você poderia reimplantar uma região sem interromper a outra.</span><span class="sxs-lookup"><span data-stu-id="592ab-121">For example, you could redeploy one region, without taking down the other one.</span></span> <span data-ttu-id="592ab-122">[Vincule os grupos de recursos][resource-group-links] para ser possível executar uma consulta para listar todos os recursos para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="592ab-122">[Link the resource groups][resource-group-links], so that you can run a query to list all the resources for the application.</span></span>

* <span data-ttu-id="592ab-123">**VNets**.</span><span class="sxs-lookup"><span data-stu-id="592ab-123">**VNets**.</span></span> <span data-ttu-id="592ab-124">Crie uma VNet separada para cada região.</span><span class="sxs-lookup"><span data-stu-id="592ab-124">Create a separate VNet for each region.</span></span> <span data-ttu-id="592ab-125">Verifique se que os espaços de endereço não se sobrepõem.</span><span class="sxs-lookup"><span data-stu-id="592ab-125">Make sure the address spaces do not overlap.</span></span> 

* <span data-ttu-id="592ab-126">**Grupo de Disponibilidade Always On do SQL Server**.</span><span class="sxs-lookup"><span data-stu-id="592ab-126">**SQL Server Always On Availability Group**.</span></span> <span data-ttu-id="592ab-127">Se você utilizar o SQL Server, recomendamos usar os [Grupos de Disponibilidade Always On][sql-always-on] para ter alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="592ab-127">If you are using SQL Server, we recommend [SQL Always On Availability Groups][sql-always-on] for high availability.</span></span> <span data-ttu-id="592ab-128">Crie um único grupo de disponibilidade que inclui instâncias do SQL Server em ambas as regiões.</span><span class="sxs-lookup"><span data-stu-id="592ab-128">Create a single availability group that includes the SQL Server instances in both regions.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="592ab-129">Além disso, considere usar o [Banco de Dados SQL do Azure][azure-sql-db], que fornece um banco de dados relacional como um serviço de nuvem.</span><span class="sxs-lookup"><span data-stu-id="592ab-129">Also consider [Azure SQL Database][azure-sql-db], which provides a relational database as a cloud service.</span></span> <span data-ttu-id="592ab-130">Com o Banco de Dados SQL, você não precisa configurar um grupo de disponibilidade ou gerenciar o failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-130">With SQL Database, you don't need to configure an availability group or manage failover.</span></span>  
    > 

* <span data-ttu-id="592ab-131">**Gateways de VPN**.</span><span class="sxs-lookup"><span data-stu-id="592ab-131">**VPN Gateways**.</span></span> <span data-ttu-id="592ab-132">Crie um [gateway de VPN][vpn-gateway] em cada VNet e configure uma [conexão VNet para VNet][vnet-to-vnet] para permitir o tráfego de rede entre os duas VNets.</span><span class="sxs-lookup"><span data-stu-id="592ab-132">Create a [VPN gateway][vpn-gateway] in each VNet, and configure a [VNet-to-VNet connection][vnet-to-vnet], to enable network traffic between the two VNets.</span></span> <span data-ttu-id="592ab-133">Isso é necessário para o Grupo de Disponibilidade Always On do SQL.</span><span class="sxs-lookup"><span data-stu-id="592ab-133">This is required for the SQL Always On Availability Group.</span></span>

## <a name="recommendations"></a><span data-ttu-id="592ab-134">Recomendações</span><span class="sxs-lookup"><span data-stu-id="592ab-134">Recommendations</span></span>

<span data-ttu-id="592ab-135">Uma arquitetura de várias regiões pode fornecer uma disponibilidade maior que a implantação em uma única região.</span><span class="sxs-lookup"><span data-stu-id="592ab-135">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="592ab-136">Se uma interrupção regional afetar a região primária, você poderá usar o [Gerenciador de Tráfego][traffic-manager] para fazer failover para a região secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-136">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="592ab-137">Essa arquitetura também poderá ajudar a se um subsistema individual do aplicativo falhar.</span><span class="sxs-lookup"><span data-stu-id="592ab-137">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="592ab-138">Há várias abordagens gerais para alcançar alta disponibilidade em várias regiões:</span><span class="sxs-lookup"><span data-stu-id="592ab-138">There are several general approaches to achieving high availability across regions:</span></span> 

* <span data-ttu-id="592ab-139">Ativo/passivo com espera ativa.</span><span class="sxs-lookup"><span data-stu-id="592ab-139">Active/passive with hot standby.</span></span> <span data-ttu-id="592ab-140">O tráfego vai para uma região, enquanto a outra aguarda em espera ativa.</span><span class="sxs-lookup"><span data-stu-id="592ab-140">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="592ab-141">A espera ativa significa que as VMs na região secundária são alocadas e ficam em execução a todo momentos.</span><span class="sxs-lookup"><span data-stu-id="592ab-141">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
* <span data-ttu-id="592ab-142">Ativo/passivo com espera passiva.</span><span class="sxs-lookup"><span data-stu-id="592ab-142">Active/passive with cold standby.</span></span> <span data-ttu-id="592ab-143">O tráfego vai para uma região, enquanto a outra aguarda em espera passiva.</span><span class="sxs-lookup"><span data-stu-id="592ab-143">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="592ab-144">A espera passiva significa que as VMs na região secundária não são alocadas até serem necessárias para failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-144">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="592ab-145">Essa abordagem custa menos para ser executada, mas geralmente leva mais tempo para ficar online durante uma falha.</span><span class="sxs-lookup"><span data-stu-id="592ab-145">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
* <span data-ttu-id="592ab-146">Ativa/ativa.</span><span class="sxs-lookup"><span data-stu-id="592ab-146">Active/active.</span></span> <span data-ttu-id="592ab-147">Ambas as regiões ficam ativas e a carga das solicitações é balanceada entre elas.</span><span class="sxs-lookup"><span data-stu-id="592ab-147">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="592ab-148">Se uma região ficar indisponível, ela será retirada da rotação.</span><span class="sxs-lookup"><span data-stu-id="592ab-148">If one region becomes unavailable, it is taken out of rotation.</span></span> 

<span data-ttu-id="592ab-149">Essa arquitetura de referência se concentra em ativo/passivo com espera ativa, usando o Gerenciador de Tráfego para o failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-149">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> <span data-ttu-id="592ab-150">Observe que você poderia implantar um pequeno número de VMs para espera ativa e, em seguida, aumentar conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="592ab-150">Note that you could deploy a small number of VMs for hot standby and then scale out as needed.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="592ab-151">Emparelhamento regional</span><span class="sxs-lookup"><span data-stu-id="592ab-151">Regional pairing</span></span>

<span data-ttu-id="592ab-152">Cada região do Azure é emparelhada com outra na mesma área geográfica.</span><span class="sxs-lookup"><span data-stu-id="592ab-152">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="592ab-153">Em geral, escolha regiões do mesmo par regional (por exemplo, Leste dos EUA 2 e Centro dos EUA).</span><span class="sxs-lookup"><span data-stu-id="592ab-153">In general, choose regions from the same regional pair (for example, East US 2 and US Central).</span></span> <span data-ttu-id="592ab-154">Os benefícios de se fazer isso são:</span><span class="sxs-lookup"><span data-stu-id="592ab-154">Benefits of doing so include:</span></span>

* <span data-ttu-id="592ab-155">No caso de uma interrupção ampla, a recuperação de pelo menos uma região de cada par é priorizada.</span><span class="sxs-lookup"><span data-stu-id="592ab-155">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
* <span data-ttu-id="592ab-156">As atualizações planejadas do sistema do Azure são distribuídas em regiões emparelhadas sequencialmente para minimizar o possível tempo de inatividade.</span><span class="sxs-lookup"><span data-stu-id="592ab-156">Planned Azure system updates are rolled out to paired regions sequentially, to minimize possible downtime.</span></span>
* <span data-ttu-id="592ab-157">Os pares residem na mesma geografia para atender aos requisitos de residência de dados.</span><span class="sxs-lookup"><span data-stu-id="592ab-157">Pairs reside within the same geography, to meet data residency requirements.</span></span> 

<span data-ttu-id="592ab-158">No entanto, verifique se ambas as regiões dão suporte a todos os serviços do Azure necessários para seu aplicativo (consulte [Serviços por região][services-by-region]).</span><span class="sxs-lookup"><span data-stu-id="592ab-158">However, make sure that both regions support all of the Azure services needed for your application (see [Services by region][services-by-region]).</span></span> <span data-ttu-id="592ab-159">Para saber mais sobre pares regionais, consulte [Continuidade dos negócios e recuperação de desastres (BCDR): Regiões Emparelhadas do Azure][regional-pairs].</span><span class="sxs-lookup"><span data-stu-id="592ab-159">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="592ab-160">Configuração do Gerenciador de Tráfego</span><span class="sxs-lookup"><span data-stu-id="592ab-160">Traffic Manager configuration</span></span>

<span data-ttu-id="592ab-161">Considere os seguintes pontos ao configurar o Gerenciador de Tráfego:</span><span class="sxs-lookup"><span data-stu-id="592ab-161">Consider the following points when configuring Traffic Manager:</span></span>

* <span data-ttu-id="592ab-162">**Roteamento**.</span><span class="sxs-lookup"><span data-stu-id="592ab-162">**Routing**.</span></span> <span data-ttu-id="592ab-163">O Gerenciador de Tráfego dá suporte a vários [algoritmos de roteamento][tm-routing].</span><span class="sxs-lookup"><span data-stu-id="592ab-163">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="592ab-164">Para o cenário descrito neste artigo, use roteamento *prioritário* (anteriormente chamado de roteamento de *failover*).</span><span class="sxs-lookup"><span data-stu-id="592ab-164">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="592ab-165">Com essa configuração, o Gerenciador de Tráfego envia todas as solicitações para a região primária, a menos que ela fique inacessível.</span><span class="sxs-lookup"><span data-stu-id="592ab-165">With this setting, Traffic Manager sends all requests to the primary region, unless the primary region becomes unreachable.</span></span> <span data-ttu-id="592ab-166">Nesse ponto, ele automaticamente faz failover para a região secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-166">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="592ab-167">Consulte [Configurar o método de roteamento de failover][tm-configure-failover].</span><span class="sxs-lookup"><span data-stu-id="592ab-167">See [Configure Failover routing method][tm-configure-failover].</span></span>
* <span data-ttu-id="592ab-168">**Investigação de integridade**.</span><span class="sxs-lookup"><span data-stu-id="592ab-168">**Health probe**.</span></span> <span data-ttu-id="592ab-169">O Gerenciador de Tráfego usa uma [investigação][tm-monitoring] HTTP (ou HTTPS) para monitorar a disponibilidade de cada região.</span><span class="sxs-lookup"><span data-stu-id="592ab-169">Traffic Manager uses an HTTP (or HTTPS) [probe][tm-monitoring] to monitor the availability of each region.</span></span> <span data-ttu-id="592ab-170">A investigação verifica uma resposta HTTP 200 para um caminho de URL especificado.</span><span class="sxs-lookup"><span data-stu-id="592ab-170">The probe checks for an HTTP 200 response for a specified URL path.</span></span> <span data-ttu-id="592ab-171">Como uma prática recomendada, crie um ponto de extremidade que relata a integridade geral do aplicativo e use esse ponto de extremidade para a investigação de integridade.</span><span class="sxs-lookup"><span data-stu-id="592ab-171">As a best practice, create an endpoint that reports the overall health of the application, and use this endpoint for the health probe.</span></span> <span data-ttu-id="592ab-172">Caso contrário, a investigação pode relatar um ponto de extremidade íntegro quando partes essenciais do aplicativo estão falhando na verdade.</span><span class="sxs-lookup"><span data-stu-id="592ab-172">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span> <span data-ttu-id="592ab-173">Para obter mais informações, consulte o [Padrão de monitoramento de ponto de extremidade de integridade][health-endpoint-monitoring-pattern].</span><span class="sxs-lookup"><span data-stu-id="592ab-173">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>   

<span data-ttu-id="592ab-174">Quando o Gerenciador de Tráfego faz failover, há um período em que os clientes não podem acessar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="592ab-174">When Traffic Manager fails over there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="592ab-175">A duração é afetada pelos seguintes fatores:</span><span class="sxs-lookup"><span data-stu-id="592ab-175">The duration is affected by the following factors:</span></span>

* <span data-ttu-id="592ab-176">A investigação de integridade precisa detectar que a região primária ficou inacessível.</span><span class="sxs-lookup"><span data-stu-id="592ab-176">The health probe must detect that the primary region has become unreachable.</span></span>
* <span data-ttu-id="592ab-177">Os servidores DNS precisam atualizar os registros DNS armazenados em cache para o endereço IP, dependendo da TTL (vida útil) DNS.</span><span class="sxs-lookup"><span data-stu-id="592ab-177">DNS servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="592ab-178">A TTL padrão é 300 segundos (5 minutos), mas você pode configurar esse valor ao criar o perfil do Gerenciador de Tráfego.</span><span class="sxs-lookup"><span data-stu-id="592ab-178">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="592ab-179">Para saber mais, consulte [Sobre o monitoramento do Gerenciador de Tráfego][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="592ab-179">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="592ab-180">Em caso de falha do Gerenciador de Tráfego, é recomendável executar um failback manual em vez de implementar um failback automático.</span><span class="sxs-lookup"><span data-stu-id="592ab-180">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="592ab-181">Caso contrário, você pode criar uma situação em que o aplicativo fica alternando entre as regiões.</span><span class="sxs-lookup"><span data-stu-id="592ab-181">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="592ab-182">Verifique se todos os subsistemas de aplicativo estão íntegros antes de realizar o failback.</span><span class="sxs-lookup"><span data-stu-id="592ab-182">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="592ab-183">Observe que o Gerenciador de Tráfego realiza failback automaticamente por padrão.</span><span class="sxs-lookup"><span data-stu-id="592ab-183">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="592ab-184">Para evitar isso, diminua manualmente a prioridade da região primária após um evento de failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-184">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="592ab-185">Por exemplo, suponha que a região primária tem prioridade 1 e a secundária tem prioridade 2.</span><span class="sxs-lookup"><span data-stu-id="592ab-185">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="592ab-186">Após um failover, defina a região primária para a prioridade 3, para impedir o failback automático.</span><span class="sxs-lookup"><span data-stu-id="592ab-186">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="592ab-187">Quando você estiver pronto retornar para ela, atualize a prioridade para 1.</span><span class="sxs-lookup"><span data-stu-id="592ab-187">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="592ab-188">O seguinte comando da [CLI do Azure][azure-cli] atualiza a prioridade:</span><span class="sxs-lookup"><span data-stu-id="592ab-188">The following [Azure CLI][azure-cli] command updates the priority:</span></span>

```bat
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --priority 3
```    

<span data-ttu-id="592ab-189">Outra abordagem é desabilitar temporariamente o ponto de extremidade até que você esteja pronto para realizar failback:</span><span class="sxs-lookup"><span data-stu-id="592ab-189">Another approach is to temporarily disable the endpoint until you are ready to fail back:</span></span>

```bat
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --endpoint-status Disabled
```

<span data-ttu-id="592ab-190">Dependendo da causa de um failover, será necessário reimplantar os recursos dentro de uma região.</span><span class="sxs-lookup"><span data-stu-id="592ab-190">Depending on the cause of a failover, you might need to redeploy the resources within a region.</span></span> <span data-ttu-id="592ab-191">Antes de fazer o failback, execute um teste de prontidão operacional.</span><span class="sxs-lookup"><span data-stu-id="592ab-191">Before failing back, perform an operational readiness test.</span></span> <span data-ttu-id="592ab-192">O teste deverá verificar o seguinte:</span><span class="sxs-lookup"><span data-stu-id="592ab-192">The test should verify things like:</span></span>

* <span data-ttu-id="592ab-193">As VMs estão configuradas corretamente.</span><span class="sxs-lookup"><span data-stu-id="592ab-193">VMs are configured correctly.</span></span> <span data-ttu-id="592ab-194">(Todo o software necessário está instalado, o IIS está em execução e assim por diante.)</span><span class="sxs-lookup"><span data-stu-id="592ab-194">(All required software is installed, IIS is running, and so on.)</span></span>
* <span data-ttu-id="592ab-195">Os subsistemas de aplicativos estão íntegros.</span><span class="sxs-lookup"><span data-stu-id="592ab-195">Application subsystems are healthy.</span></span> 
* <span data-ttu-id="592ab-196">Testes funcionais.</span><span class="sxs-lookup"><span data-stu-id="592ab-196">Functional testing.</span></span> <span data-ttu-id="592ab-197">(Por exemplo, a camada de banco de dados pode ser acessada da camada da Web.)</span><span class="sxs-lookup"><span data-stu-id="592ab-197">(For example, the database tier is reachable from the web tier.)</span></span>

### <a name="configure-sql-server-always-on-availability-groups"></a><span data-ttu-id="592ab-198">Configurar Grupos de Disponibilidade Always On do SQL Server</span><span class="sxs-lookup"><span data-stu-id="592ab-198">Configure SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="592ab-199">Antes do Windows Server 2016, os Grupos de Disponibilidade Always On do SQL Server exigiam um controlador de domínio e todos os nós no grupo de disponibilidade precisavam estar no mesmo domínio do AD (Active Directory).</span><span class="sxs-lookup"><span data-stu-id="592ab-199">Prior to Windows Server 2016, SQL Server Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same Active Directory (AD) domain.</span></span> 

<span data-ttu-id="592ab-200">Para configurar o grupo de disponibilidade:</span><span class="sxs-lookup"><span data-stu-id="592ab-200">To configure the availability group:</span></span>

* <span data-ttu-id="592ab-201">No mínimo, coloque dois controladores de domínio em cada região.</span><span class="sxs-lookup"><span data-stu-id="592ab-201">At a minimum, place two domain controllers in each region.</span></span>
* <span data-ttu-id="592ab-202">Forneça um endereço IP estático para cada controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="592ab-202">Give each domain controller a static IP address.</span></span>
* <span data-ttu-id="592ab-203">Crie uma conexão VNet para VNet para habilitar a comunicação entre as VNets.</span><span class="sxs-lookup"><span data-stu-id="592ab-203">Create a VNet-to-VNet connection to enable communication between the VNets.</span></span>
* <span data-ttu-id="592ab-204">Para cada VNet, adicione os endereços IP dos controladores de domínio (de ambas as regiões) para a lista de servidores DNS.</span><span class="sxs-lookup"><span data-stu-id="592ab-204">For each VNet, add the IP addresses of the domain controllers (from both regions) to the DNS server list.</span></span> <span data-ttu-id="592ab-205">Você pode usar o comando da CLI a seguir.</span><span class="sxs-lookup"><span data-stu-id="592ab-205">You can use the following CLI command.</span></span> <span data-ttu-id="592ab-206">Para obter mais informações, consulte [alterar servidores DNS][vnet-dns].</span><span class="sxs-lookup"><span data-stu-id="592ab-206">For more information, see [Change DNS servers][vnet-dns].</span></span>

    ```bat
    az network vnet update --resource-group <resource-group> --name <vnet-name> --dns-servers "10.0.0.4,10.0.0.6,172.16.0.4,172.16.0.6"
    ```

* <span data-ttu-id="592ab-207">Crie um cluster WSFC ([Clustering de Failover do Windows Server][wsfc]) que inclui as instâncias do SQL Server em ambas as regiões.</span><span class="sxs-lookup"><span data-stu-id="592ab-207">Create a [Windows Server Failover Clustering][wsfc] (WSFC) cluster that includes the SQL Server instances in both regions.</span></span> 
* <span data-ttu-id="592ab-208">Crie um único Grupo de Disponibilidade Always On do SQL Server que inclui instâncias do SQL Server em ambas as regiões primária e secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-208">Create a SQL Server Always On Availability Group that includes the SQL Server instances in both the primary and secondary regions.</span></span> <span data-ttu-id="592ab-209">Consulte [Estendendo o Grupo de Disponibilidade Always On para o Datacenter Remoto do Azure (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/) para ver as etapas.</span><span class="sxs-lookup"><span data-stu-id="592ab-209">See [Extending Always On Availability Group to Remote Azure Datacenter (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/) for the steps.</span></span>

  * <span data-ttu-id="592ab-210">Coloque a réplica primária na região primária.</span><span class="sxs-lookup"><span data-stu-id="592ab-210">Put the primary replica in the primary region.</span></span>
  * <span data-ttu-id="592ab-211">Coloque uma ou mais réplicas secundárias na região primária.</span><span class="sxs-lookup"><span data-stu-id="592ab-211">Put one or more secondary replicas in the primary region.</span></span> <span data-ttu-id="592ab-212">Configure-as para usar a confirmação síncrona com failover automático.</span><span class="sxs-lookup"><span data-stu-id="592ab-212">Configure these to use synchronous commit with automatic failover.</span></span>
  * <span data-ttu-id="592ab-213">Coloque uma ou mais réplicas secundárias na região secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-213">Put one or more secondary replicas in the secondary region.</span></span> <span data-ttu-id="592ab-214">Configure-as para usar a confirmação *assíncrona*, por motivos de desempenho.</span><span class="sxs-lookup"><span data-stu-id="592ab-214">Configure these to use *asynchronous* commit, for performance reasons.</span></span> <span data-ttu-id="592ab-215">(Caso contrário, todas as transações de T-SQL precisarão aguardar uma viagem de ida e volta pela rede para a região secundária.)</span><span class="sxs-lookup"><span data-stu-id="592ab-215">(Otherwise, all T-SQL transactions have to wait on a round trip over the network to the secondary region.)</span></span>

    > [!NOTE]
    > <span data-ttu-id="592ab-216">Réplicas de confirmação assíncrona não dão suporte a failover automático.</span><span class="sxs-lookup"><span data-stu-id="592ab-216">Asynchronous commit replicas do not support automatic failover.</span></span>
    >
    >

## <a name="availability-considerations"></a><span data-ttu-id="592ab-217">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="592ab-217">Availability considerations</span></span>

<span data-ttu-id="592ab-218">Com um aplicativo complexo de N camadas, pode não ser necessário replicar o aplicativo inteiro na região secundária.</span><span class="sxs-lookup"><span data-stu-id="592ab-218">With a complex N-tier app, you may not need to replicate the entire application in the secondary region.</span></span> <span data-ttu-id="592ab-219">Em vez disso, você pode replicar apenas um subsistema crítico que é necessário para dar suporte à continuidade de negócios.</span><span class="sxs-lookup"><span data-stu-id="592ab-219">Instead, you might just replicate a critical subsystem that is needed to support business continuity.</span></span>

<span data-ttu-id="592ab-220">O Gerenciador de Tráfego é um possível ponto de falha no sistema.</span><span class="sxs-lookup"><span data-stu-id="592ab-220">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="592ab-221">Se o serviço do Gerenciador de Tráfego falhar, os clientes não poderão acessar seu aplicativo durante o tempo de inatividade.</span><span class="sxs-lookup"><span data-stu-id="592ab-221">If the Traffic Manager service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="592ab-222">Examine o [SLA do Gerenciador de Tráfego][tm-sla] e determine se usar apenas o Gerenciador de Tráfego atende aos seus requisitos de negócios para alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="592ab-222">Review the [Traffic Manager SLA][tm-sla], and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="592ab-223">Caso contrário, considere adicionar outra solução de gerenciamento de tráfego como um failback.</span><span class="sxs-lookup"><span data-stu-id="592ab-223">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="592ab-224">Se o serviço do Gerenciador de Tráfego do Azure falhar, altere os registros CNAME no DNS para apontar para outro serviço de gerenciamento de tráfego.</span><span class="sxs-lookup"><span data-stu-id="592ab-224">If the Azure Traffic Manager service fails, change your CNAME records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="592ab-225">(Esta etapa deve ser executada manualmente e seu aplicativo estará indisponível até que as alterações de DNS sejam propagadas.)</span><span class="sxs-lookup"><span data-stu-id="592ab-225">(This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.)</span></span>

<span data-ttu-id="592ab-226">Para o cluster do SQL Server, há dois cenários de failover a serem considerados:</span><span class="sxs-lookup"><span data-stu-id="592ab-226">For the SQL Server cluster, there are two failover scenarios to consider:</span></span>

- <span data-ttu-id="592ab-227">Todas as réplicas de banco de dados do SQL Server na região primária falham.</span><span class="sxs-lookup"><span data-stu-id="592ab-227">All of the SQL Server database replicas in the primary region fail.</span></span> <span data-ttu-id="592ab-228">Isso pode acontecer durante uma interrupção regional, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="592ab-228">For example, this could happen during a regional outage.</span></span> <span data-ttu-id="592ab-229">Nesse caso, você deve fazer failover do grupo de disponibilidade manualmente, mesmo que o Gerenciador de Tráfego faça failover automaticamente no front-end.</span><span class="sxs-lookup"><span data-stu-id="592ab-229">In that case, you must manually fail over the availability group, even though Traffic Manager automatically fails over on the front end.</span></span> <span data-ttu-id="592ab-230">Siga as etapas em [Executar um Failover Manual Forçado de um Grupo de Disponibilidade do SQL Server](https://msdn.microsoft.com/library/ff877957.aspx), que descreve como executar um failover forçado usando o SQL Server Management Studio, o Transact-SQL ou o PowerShell no SQL Server 2016.</span><span class="sxs-lookup"><span data-stu-id="592ab-230">Follow the steps in [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx), which describes how to perform a forced failover by using SQL Server Management Studio, Transact-SQL, or PowerShell in SQL Server 2016.</span></span>

   > [!WARNING]
   > <span data-ttu-id="592ab-231">Com o failover forçado, há um risco de perda de dados.</span><span class="sxs-lookup"><span data-stu-id="592ab-231">With forced failover, there is a risk of data loss.</span></span> <span data-ttu-id="592ab-232">Depois que a região principal estiver novamente online, crie um instantâneo do banco de dados e usar [tablediff] para encontrar as diferenças.</span><span class="sxs-lookup"><span data-stu-id="592ab-232">Once the primary region is back online, take a snapshot of the database and use [tablediff] to find the differences.</span></span>
   >
   >
- <span data-ttu-id="592ab-233">O Gerenciador de Tráfego faz failover para a região secundária, mas a réplica primária do Banco de Dados do SQL Server ainda está disponível.</span><span class="sxs-lookup"><span data-stu-id="592ab-233">Traffic Manager fails over to the secondary region, but the primary SQL Server database replica is still available.</span></span> <span data-ttu-id="592ab-234">A camada de front-end pode falhar sem afetar as VMs do SQL Server, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="592ab-234">For example, the front-end tier might fail, without affecting the SQL Server VMs.</span></span> <span data-ttu-id="592ab-235">Nesse caso, o tráfego da Internet é roteado para a região secundária e essa região ainda pode se conectar à réplica primária.</span><span class="sxs-lookup"><span data-stu-id="592ab-235">In that case, Internet traffic is routed to the secondary region, and that region can still connect to the primary replica.</span></span> <span data-ttu-id="592ab-236">No entanto, haverá aumento da latência, pois as conexões do SQL Server ocorrem entre regiões.</span><span class="sxs-lookup"><span data-stu-id="592ab-236">However, there will be increased latency, because the SQL Server connections are going across regions.</span></span> <span data-ttu-id="592ab-237">Nessa situação, você deve executar um failover manual da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="592ab-237">In this situation, you should perform a manual failover as follows:</span></span>

   1. <span data-ttu-id="592ab-238">Alterne temporariamente uma réplica de banco de dados do SQL Server na região secundária para confirmação *síncrona*.</span><span class="sxs-lookup"><span data-stu-id="592ab-238">Temporarily switch a SQL Server database replica in the secondary region to *synchronous* commit.</span></span> <span data-ttu-id="592ab-239">Isso garante que não haja perda de dados durante o failover.</span><span class="sxs-lookup"><span data-stu-id="592ab-239">This ensures there won't be data loss during the failover.</span></span>
   2. <span data-ttu-id="592ab-240">Failover para essa réplica.</span><span class="sxs-lookup"><span data-stu-id="592ab-240">Fail over to that replica.</span></span>
   3. <span data-ttu-id="592ab-241">Após realizar o failback para a região primária, restaure a configuração de confirmação assíncrona.</span><span class="sxs-lookup"><span data-stu-id="592ab-241">When you fail back to the primary region, restore the asynchronous commit setting.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="592ab-242">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="592ab-242">Manageability considerations</span></span>

<span data-ttu-id="592ab-243">Quando você atualizar a implantação, atualize uma região de cada vez para reduzir a chance de uma falha global devido a uma configuração incorreta ou um erro no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="592ab-243">When you update your deployment, update one region at a time to reduce the chance of a global failure from an incorrect configuration or an error in the application.</span></span>

<span data-ttu-id="592ab-244">Teste a resiliência do sistema a falhas.</span><span class="sxs-lookup"><span data-stu-id="592ab-244">Test the resiliency of the system to failures.</span></span> <span data-ttu-id="592ab-245">Aqui estão alguns cenários comuns de falha para testar:</span><span class="sxs-lookup"><span data-stu-id="592ab-245">Here are some common failure scenarios to test:</span></span>

* <span data-ttu-id="592ab-246">Desligamento de instâncias de VM.</span><span class="sxs-lookup"><span data-stu-id="592ab-246">Shut down VM instances.</span></span>
* <span data-ttu-id="592ab-247">Recursos de pressão, como CPU e memória.</span><span class="sxs-lookup"><span data-stu-id="592ab-247">Pressure resources such as CPU and memory.</span></span>
* <span data-ttu-id="592ab-248">Desconectar/atraso de rede.</span><span class="sxs-lookup"><span data-stu-id="592ab-248">Disconnect/delay network.</span></span>
* <span data-ttu-id="592ab-249">Falha de processos.</span><span class="sxs-lookup"><span data-stu-id="592ab-249">Crash processes.</span></span>
* <span data-ttu-id="592ab-250">Expiração de certificados.</span><span class="sxs-lookup"><span data-stu-id="592ab-250">Expire certificates.</span></span>
* <span data-ttu-id="592ab-251">Simular falhas de hardware.</span><span class="sxs-lookup"><span data-stu-id="592ab-251">Simulate hardware faults.</span></span>
* <span data-ttu-id="592ab-252">Desligamento do serviço DNS nos controladores de domínio.</span><span class="sxs-lookup"><span data-stu-id="592ab-252">Shut down the DNS service on the domain controllers.</span></span>

<span data-ttu-id="592ab-253">Meça o tempo de recuperação e verifique se ele cumpre seus requisitos de negócios.</span><span class="sxs-lookup"><span data-stu-id="592ab-253">Measure the recovery times and verify they meet your business requirements.</span></span> <span data-ttu-id="592ab-254">Teste também combinações dos modos de falha.</span><span class="sxs-lookup"><span data-stu-id="592ab-254">Test combinations of failure modes, as well.</span></span>



<!-- Links -->
[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[azure-sla]: https://azure.microsoft.com/support/legal/sla/
[azure-sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[azure-cli]: /cli/azure/
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-always-on]: https://msdn.microsoft.com/library/hh510230.aspx
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[vnet-dns]: /azure/virtual-network/manage-virtual-network#change-dns-servers
[vnet-to-vnet]: /azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps
[vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx

[0]: ./images/multi-region-sql-server.png "Arquitetura de rede altamente disponível para aplicativos de N camadas do Azure"

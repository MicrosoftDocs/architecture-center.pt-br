---
title: Implantar soluções de virtualização de rede altamente disponíveis
titleSuffix: Azure Reference Architectures
description: Implantar soluções de virtualização de rede com alta disponibilidade.
author: telmosampaio
ms.date: 12/08/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, networking
ms.openlocfilehash: 18a8620d835488be7a3639e8fbde86f9f10f946c
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/20/2019
ms.locfileid: "58244987"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="1a205-103">Implantar soluções de virtualização de rede altamente disponíveis</span><span class="sxs-lookup"><span data-stu-id="1a205-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="1a205-104">Este artigo mostra como implantar um conjunto de NVAs (soluções de virtualização de rede) para alta disponibilidade no Azure.</span><span class="sxs-lookup"><span data-stu-id="1a205-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="1a205-105">Uma NVA normalmente é usada para controlar o fluxo de tráfego de rede de uma rede de perímetro, também conhecida como DMZ, para outras redes ou sub-redes.</span><span class="sxs-lookup"><span data-stu-id="1a205-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="1a205-106">Para saber mais sobre a implementação de uma DMZ no Azure, consulte [Serviços em nuvem da Microsoft e segurança de rede][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="1a205-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="1a205-107">O artigo inclui as arquiteturas de exemplo apenas de entrada, apenas de saída e de entrada e saída.</span><span class="sxs-lookup"><span data-stu-id="1a205-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="1a205-108">**Pré-requisitos:** Este artigo pressupõe um entendimento básico de redes do Azure, [balanceadores de carga do Azure][lb-overview] e UDRs [(rotas definidas pelo usuário)][udr-overview].</span><span class="sxs-lookup"><span data-stu-id="1a205-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="1a205-109">Diagramas de arquitetura</span><span class="sxs-lookup"><span data-stu-id="1a205-109">Architecture diagrams</span></span>

<span data-ttu-id="1a205-110">Uma NVA pode ser implantada em uma DMZ em muitas arquiteturas diferentes.</span><span class="sxs-lookup"><span data-stu-id="1a205-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="1a205-111">Por exemplo, a figura a seguir ilustra o uso de uma [única NVA][nva-scenario] para entrada.</span><span class="sxs-lookup"><span data-stu-id="1a205-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="1a205-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="1a205-112">![[0]][0]</span></span>

<span data-ttu-id="1a205-113">Nessa arquitetura, a NVA fornece um limite de rede segura marcando todo tráfego de rede de entrada e saída e passando apenas o tráfego que atende às regras de segurança de rede.</span><span class="sxs-lookup"><span data-stu-id="1a205-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="1a205-114">No entanto, o fato de que todo o tráfego de rede deve passar pela NVA significa que ela é um ponto único de falha na rede.</span><span class="sxs-lookup"><span data-stu-id="1a205-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="1a205-115">Se a NVA falhar, não haverá nenhum outro caminho para o tráfego de rede e todas as sub-redes de back-end ficarão indisponíveis.</span><span class="sxs-lookup"><span data-stu-id="1a205-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="1a205-116">Para tornar uma NVA altamente disponível, implante mais de uma NVA em um conjunto de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="1a205-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="1a205-117">As arquiteturas a seguir descrevem os recursos e a configuração necessários para NVAs altamente disponíveis:</span><span class="sxs-lookup"><span data-stu-id="1a205-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="1a205-118">Solução</span><span class="sxs-lookup"><span data-stu-id="1a205-118">Solution</span></span> | <span data-ttu-id="1a205-119">Benefícios</span><span class="sxs-lookup"><span data-stu-id="1a205-119">Benefits</span></span> | <span data-ttu-id="1a205-120">Considerações</span><span class="sxs-lookup"><span data-stu-id="1a205-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="1a205-121">[Entrada com NVAs na camada 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1a205-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="1a205-122">Todos os nós de NVA estão ativos</span><span class="sxs-lookup"><span data-stu-id="1a205-122">All NVA nodes are active</span></span> |<span data-ttu-id="1a205-123">Requer uma NVA que pode encerrar conexões e usar SNAT</span><span class="sxs-lookup"><span data-stu-id="1a205-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="1a205-124">Requer um conjunto separado de NVAs para o tráfego proveniente da Internet e do Azure</span><span class="sxs-lookup"><span data-stu-id="1a205-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="1a205-125">Só pode ser usado para tráfego proveniente de fora do Azure</span><span class="sxs-lookup"><span data-stu-id="1a205-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="1a205-126">[Saída com NVAs na camada 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1a205-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="1a205-127">Todos os nós de NVA estão ativos</span><span class="sxs-lookup"><span data-stu-id="1a205-127">All NVA nodes are active</span></span> | <span data-ttu-id="1a205-128">Requer uma NVA que pode encerrar conexões e implementa SNAT (conversão de endereços de rede de origem)</span><span class="sxs-lookup"><span data-stu-id="1a205-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="1a205-129">[Entrada-saída com NVAs na camada 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1a205-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="1a205-130">Todos os nós estão ativos</span><span class="sxs-lookup"><span data-stu-id="1a205-130">All nodes are active</span></span><br/><span data-ttu-id="1a205-131">Capaz de lidar com tráfego originado no Azure</span><span class="sxs-lookup"><span data-stu-id="1a205-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="1a205-132">Requer uma NVA que pode encerrar conexões e usar SNAT</span><span class="sxs-lookup"><span data-stu-id="1a205-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="1a205-133">Requer um conjunto separado de NVAs para o tráfego proveniente da Internet e do Azure</span><span class="sxs-lookup"><span data-stu-id="1a205-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="1a205-134">[Opção PIP-UDR][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="1a205-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="1a205-135">Conjunto único de NVAs para todo o tráfego</span><span class="sxs-lookup"><span data-stu-id="1a205-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="1a205-136">Pode lidar com todo o tráfego (sem limite nas regras de porta)</span><span class="sxs-lookup"><span data-stu-id="1a205-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="1a205-137">Ativo-passivo</span><span class="sxs-lookup"><span data-stu-id="1a205-137">Active-passive</span></span><br/><span data-ttu-id="1a205-138">Requer um processo de failover</span><span class="sxs-lookup"><span data-stu-id="1a205-138">Requires a failover process</span></span> |
| [<span data-ttu-id="1a205-139">PIP-UDR sem SNAT</span><span class="sxs-lookup"><span data-stu-id="1a205-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="1a205-140">Conjunto único de NVAs para todo o tráfego</span><span class="sxs-lookup"><span data-stu-id="1a205-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="1a205-141">Pode lidar com todo o tráfego (sem limite nas regras de porta)</span><span class="sxs-lookup"><span data-stu-id="1a205-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="1a205-142">Não exige configuração de SNAT para solicitações de entrada</span><span class="sxs-lookup"><span data-stu-id="1a205-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="1a205-143">Ativo-passivo</span><span class="sxs-lookup"><span data-stu-id="1a205-143">Active-passive</span></span><br/><span data-ttu-id="1a205-144">Requer um processo de failover</span><span class="sxs-lookup"><span data-stu-id="1a205-144">Requires a failover process</span></span><br/><span data-ttu-id="1a205-145">A lógica de investigação e failover é executada fora da rede virtual</span><span class="sxs-lookup"><span data-stu-id="1a205-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="1a205-146">Entrada com NVAs na camada 7</span><span class="sxs-lookup"><span data-stu-id="1a205-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="1a205-147">A figura a seguir mostra uma arquitetura de alta disponibilidade que implementa uma DMZ de entrada por atrás de um balanceador de carga voltado para a Internet.</span><span class="sxs-lookup"><span data-stu-id="1a205-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="1a205-148">Essa arquitetura é projetada para fornecer conectividade a cargas de trabalho do Azure para o tráfego da camada 7, como HTTP ou HTTPS:</span><span class="sxs-lookup"><span data-stu-id="1a205-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="1a205-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="1a205-149">![[1]][1]</span></span>

<span data-ttu-id="1a205-150">A vantagem dessa arquitetura é que todas as NVAs estão ativas e, se uma falhar, o balanceador de carga direciona o tráfego de rede para a outra NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="1a205-151">Ambas NVAs encaminham o tráfego para o balanceador de carga interno, portanto, desde que uma NVA esteja ativa, o tráfego continuará a fluir.</span><span class="sxs-lookup"><span data-stu-id="1a205-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="1a205-152">As NVAs são necessárias para terminar o tráfego SSL destinado a VMs da camada da Web.</span><span class="sxs-lookup"><span data-stu-id="1a205-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="1a205-153">Essas NVAs não podem ser estendidas para lidar com o tráfego local porque este requer outro conjunto dedicado de NVAs com suas próprias rotas de rede.</span><span class="sxs-lookup"><span data-stu-id="1a205-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="1a205-154">Essa arquitetura é usada nas arquiteturas de referência de [DMZ entre o Azure e seu datacenter local][dmz-on-premises] e de [DMZ entre o Azure e a Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="1a205-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="1a205-155">Todas essas arquiteturas de referência incluem uma solução de implantação que você pode usar.</span><span class="sxs-lookup"><span data-stu-id="1a205-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="1a205-156">Siga os links abaixo para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="1a205-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="1a205-157">Saída com NVAs na camada 7</span><span class="sxs-lookup"><span data-stu-id="1a205-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="1a205-158">A arquitetura anterior pode ser expandida para fornecer uma DMZ de saída para solicitações originadas na carga de trabalho do Azure.</span><span class="sxs-lookup"><span data-stu-id="1a205-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="1a205-159">A arquitetura a seguir é projetada para fornecer alta disponibilidade de NVAs na DMZ para o tráfego de camada 7, como HTTP ou HTTPS:</span><span class="sxs-lookup"><span data-stu-id="1a205-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="1a205-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="1a205-160">![[2]][2]</span></span>

<span data-ttu-id="1a205-161">Nessa arquitetura, todo o tráfego originado no Azure é encaminhado para um balanceador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="1a205-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="1a205-162">O balanceador de carga distribui solicitações de saída entre um conjunto de NVAs.</span><span class="sxs-lookup"><span data-stu-id="1a205-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="1a205-163">Essas NVAs direcionam o tráfego para a Internet usando os endereços IP públicos individuais.</span><span class="sxs-lookup"><span data-stu-id="1a205-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="1a205-164">Essa arquitetura é usada nas arquiteturas de referência de [DMZ entre o Azure e seu datacenter local][dmz-on-premises] e de [DMZ entre o Azure e a Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="1a205-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="1a205-165">Todas essas arquiteturas de referência incluem uma solução de implantação que você pode usar.</span><span class="sxs-lookup"><span data-stu-id="1a205-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="1a205-166">Siga os links abaixo para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="1a205-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="1a205-167">Entrada-saída com NVAs na camada 7</span><span class="sxs-lookup"><span data-stu-id="1a205-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="1a205-168">Nas duas arquiteturas anteriores, havia uma DMZ separada para entrada e saída.</span><span class="sxs-lookup"><span data-stu-id="1a205-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="1a205-169">A arquitetura a seguir demonstra como criar uma DMZ que pode ser usada tanto para entrada quanto saída para o tráfego da camada 7, como HTTP ou HTTPS:</span><span class="sxs-lookup"><span data-stu-id="1a205-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="1a205-171">Nesta arquitetura, as NVAs processam solicitações de entrada do gateway de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1a205-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="1a205-172">As NVAs também processam solicitações de saída de VMs de carga de trabalho no pool de back-end do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="1a205-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="1a205-173">Como o tráfego de entrada é roteado com um gateway de aplicativo e o tráfego de saída é roteado com um balanceador de carga, os NVAs são responsáveis por manter a afinidade de sessão.</span><span class="sxs-lookup"><span data-stu-id="1a205-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="1a205-174">Ou seja, o gateway de aplicativo mantém um mapeamento de solicitações de entrada e saída para que ele possa encaminhar a resposta correta para o solicitante original.</span><span class="sxs-lookup"><span data-stu-id="1a205-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="1a205-175">No entanto, o balanceador de carga interno não tem acesso aos mapeamentos de gateway de aplicativo e usa sua própria lógica para enviar respostas para as NVAs.</span><span class="sxs-lookup"><span data-stu-id="1a205-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="1a205-176">É possível que o balanceador de carga possa enviar uma resposta para uma NVA que não recebeu a solicitação do gateway de aplicativo inicialmente.</span><span class="sxs-lookup"><span data-stu-id="1a205-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="1a205-177">Nesse caso, as NVAs devem se comunicar e transferir a resposta entre elas para que a NVA correta possa encaminhar a resposta para o gateway de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="1a205-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="1a205-178">Você também pode resolver o problema de roteamento assimétrico garantindo que as NVAs executem a SNAT (conversão de endereços de rede de origem) de entrada.</span><span class="sxs-lookup"><span data-stu-id="1a205-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="1a205-179">Isso substituiria o IP de origem original do solicitante por um dos endereços IP da NVA usada no fluxo de entrada.</span><span class="sxs-lookup"><span data-stu-id="1a205-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="1a205-180">Isso garante que você possa usar várias NVAs por vez, preservando ainda a simetria de rota.</span><span class="sxs-lookup"><span data-stu-id="1a205-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="1a205-181">Opção PIP-UDR com NVAs da camada 4</span><span class="sxs-lookup"><span data-stu-id="1a205-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="1a205-182">A arquitetura a seguir demonstra uma arquitetura com uma NVA ativa e uma passiva.</span><span class="sxs-lookup"><span data-stu-id="1a205-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="1a205-183">Essa arquitetura lida trata tanto a entrada quanto a saída para o tráfego da camada 4:</span><span class="sxs-lookup"><span data-stu-id="1a205-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="1a205-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="1a205-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="1a205-185">Há uma solução completa para essa arquitetura disponível no [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="1a205-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="1a205-186">Essa arquitetura é semelhante à primeira arquitetura discutida neste artigo.</span><span class="sxs-lookup"><span data-stu-id="1a205-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="1a205-187">Aquela arquitetura incluía uma única NVA que aceitava e filtrava solicitações de entrada da camada 4.</span><span class="sxs-lookup"><span data-stu-id="1a205-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="1a205-188">Essa arquitetura adiciona uma segunda NVA passiva para fornecer alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="1a205-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="1a205-189">Se a NVA ativa falhar, a NVA passiva fica ativa e o PIP e o UDR são alterados para apontar para os NICs na NVA que está ativa no momento.</span><span class="sxs-lookup"><span data-stu-id="1a205-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="1a205-190">Essas alterações do UDR e PIP podem ser feitas manualmente ou usando um processo automatizado.</span><span class="sxs-lookup"><span data-stu-id="1a205-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="1a205-191">O processo automatizado normalmente é daemon ou outro serviço de monitoramento em execução no Azure.</span><span class="sxs-lookup"><span data-stu-id="1a205-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="1a205-192">Ele consulta uma investigação de integridade na NVA ativa e executa a opção UDR e PIP quando detecta uma falha da NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="1a205-193">A figura anterior mostra um exemplo de cluster [ZooKeeper][zookeeper] que fornece um daemon de alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="1a205-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="1a205-194">Dentro do cluster do ZooKeeper, um quorum de nós elege um líder.</span><span class="sxs-lookup"><span data-stu-id="1a205-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="1a205-195">Se o líder falhar, os nós restantes elegerão um novo líder.</span><span class="sxs-lookup"><span data-stu-id="1a205-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="1a205-196">Para essa arquitetura, o nó líder executa o daemon que consulta o ponto de extremidade de integridade na NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="1a205-197">Se a NVA não responder à investigação de integridade, o daemon ativará a NVA passiva.</span><span class="sxs-lookup"><span data-stu-id="1a205-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="1a205-198">Em seguida, o daemon chama a API REST do Azure para remover o PIP da NVA com falha e a anexa ao NVA recém-ativado.</span><span class="sxs-lookup"><span data-stu-id="1a205-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="1a205-199">O daemon modifica então o UDR para apontar para o endereço IP interno da NVA recém-ativada.</span><span class="sxs-lookup"><span data-stu-id="1a205-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="1a205-200">Não inclua os nós do ZooKeeper em uma sub-rede que só é acessível por meio de uma rota que inclui a NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="1a205-201">Caso contrário, os nós do ZooKeeper ficarão inacessíveis se a NVA falhar.</span><span class="sxs-lookup"><span data-stu-id="1a205-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="1a205-202">Caso o daemon falhe por algum motivo, não será possível acessar nenhum nó do ZooKeeper para diagnosticar o problema.</span><span class="sxs-lookup"><span data-stu-id="1a205-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="1a205-203">Para ver a solução completa, incluindo o código de exemplo, confira os arquivos no [repositório GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="1a205-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="1a205-204">NVAs PIP-UDR sem SNAT</span><span class="sxs-lookup"><span data-stu-id="1a205-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="1a205-205">Essa arquitetura usa duas máquinas virtuais do Azure para hospedar o firewall de NVA em uma configuração ativo-passivo que dá suporte ao failover automático, mas não exige SNAT (Conversão de endereço de rede de origem).</span><span class="sxs-lookup"><span data-stu-id="1a205-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![NVAs PIP-UDR sem arquitetura SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="1a205-207">Há uma solução completa para essa arquitetura disponível no [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="1a205-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="1a205-208">Essa solução foi projetada para clientes do Azure que não conseguem configurar o SNAT para solicitações de entrada em seus firewalls de NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="1a205-209">O SNAT oculta o endereço IP de origem do cliente original.</span><span class="sxs-lookup"><span data-stu-id="1a205-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="1a205-210">Se você precisa registrar os IPs originais ou usá-los dentro de outros componentes de segurança em camadas por trás de seus NVAs, essa solução oferecerá uma abordagem básica.</span><span class="sxs-lookup"><span data-stu-id="1a205-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="1a205-211">O failover de entradas da tabela UDR é automatizado por um conjunto de endereços de próximo salto definido como o endereço IP de uma interface na máquina de virtual do firewall de NVA ativa.</span><span class="sxs-lookup"><span data-stu-id="1a205-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="1a205-212">A lógica de failover automatizado é hospedada em um aplicativo de funções que você cria usando o [Azure Functions](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="1a205-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="1a205-213">O código de failover é executado como uma função sem servidor dentro do Azure Functions.</span><span class="sxs-lookup"><span data-stu-id="1a205-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="1a205-214">A implantação é conveniente, econômica e fácil de manter e personalizar.</span><span class="sxs-lookup"><span data-stu-id="1a205-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="1a205-215">Além disso, o aplicativo de funções é hospedado dentro do Azure Functions, portanto, não tem dependências da rede virtual.</span><span class="sxs-lookup"><span data-stu-id="1a205-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="1a205-216">Se as alterações na rede virtual afetarem os firewalls de NVA, o aplicativo de função continuará executando de forma independente.</span><span class="sxs-lookup"><span data-stu-id="1a205-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="1a205-217">O teste também é mais preciso, pois ocorre fora da rede virtual usando a mesma rota que as solicitações de entrada do cliente.</span><span class="sxs-lookup"><span data-stu-id="1a205-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="1a205-218">Para verificar a disponibilidade do firewall de NVA, o código do aplicativo de função o investiga usando uma de duas maneiras:</span><span class="sxs-lookup"><span data-stu-id="1a205-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="1a205-219">Monitorando o estado das máquinas virtuais do Azure que hospedam o firewall de NVA.</span><span class="sxs-lookup"><span data-stu-id="1a205-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="1a205-220">Testando se há uma porta aberta no firewall para o servidor Web de back-end.</span><span class="sxs-lookup"><span data-stu-id="1a205-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="1a205-221">Para essa opção, a NVA deve expor um soquete por meio de PIP para teste do código do aplicativo de função.</span><span class="sxs-lookup"><span data-stu-id="1a205-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="1a205-222">Escolha o tipo de investigação que você deseja usar quando ao configurar o aplicativo de funções.</span><span class="sxs-lookup"><span data-stu-id="1a205-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="1a205-223">Para ver a solução completa, incluindo o código de exemplo, confira os arquivos no [repositório GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="1a205-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="1a205-224">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="1a205-224">Next steps</span></span>

- <span data-ttu-id="1a205-225">Saiba como [implementar uma DMZ entre o Azure e o datacenter local][dmz-on-premises] usando NVAs da camada 7.</span><span class="sxs-lookup"><span data-stu-id="1a205-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-premises] using layer-7 NVAs.</span></span>
- <span data-ttu-id="1a205-226">Saiba como [implementar uma DMZ entre o Azure e a Internet][dmz-internet] usando NVAs da camada 7.</span><span class="sxs-lookup"><span data-stu-id="1a205-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="1a205-227">Solução de problemas de virtualização de rede no Azure</span><span class="sxs-lookup"><span data-stu-id="1a205-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-premises]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Arquitetura NVA única"
[1]: ./images/nva-ha/l7-ingress.png "Entrada da camada 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Saída da camada 7"
[3]: ./images/nva-ha/active-passive.png "Cluster ativo-passivo"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png

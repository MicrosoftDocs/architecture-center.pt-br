---
title: Pontuação em lote para modelos de aprendizado profundo
titleSuffix: Azure Reference Architectures
description: Essa arquitetura de referência mostra como aplicar a transferência de estilo neural a um vídeo usando a IA do Lote do Azure.
author: jiata
ms.date: 10/02/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: azcat-ai
ms.openlocfilehash: 26a83b3f75b2e7e9ec4a8a99ab8b4d8f1b1ef4d7
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54488555"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="46858-103">Pontuação em lote para modelos de aprendizado profundo do Azure</span><span class="sxs-lookup"><span data-stu-id="46858-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="46858-104">Essa arquitetura de referência mostra como aplicar a transferência de estilo neural a um vídeo usando a IA do Lote do Azure.</span><span class="sxs-lookup"><span data-stu-id="46858-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="46858-105">A *Transferência de estilo* é uma técnica de aprendizado profundo que compõe uma imagem existente no estilo de outra imagem.</span><span class="sxs-lookup"><span data-stu-id="46858-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="46858-106">Essa arquitetura pode ser generalizada para qualquer cenário que usa a pontuação do lote com aprendizado profundo.</span><span class="sxs-lookup"><span data-stu-id="46858-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="46858-107">[**Implantar esta solução**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="46858-107">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Diagrama da arquitetura para modelos de aprendizado profundo usando a IA do Lote do Azure](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="46858-109">**Cenário**: uma organização de mídia tem um vídeo cujo estilo ela quer alterar para procurar uma pintura específica.</span><span class="sxs-lookup"><span data-stu-id="46858-109">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="46858-110">A organização quer ser capaz de aplicar esse estilo a todos os quadros do vídeo em tempo hábil e de uma forma automatizada.</span><span class="sxs-lookup"><span data-stu-id="46858-110">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="46858-111">Para saber mais sobre os algoritmos de transferência de estilo neural, consulte [Transferência de estilo de imagem usando redes neurais convolucionais neurais][image-style-transfer] (PDF).</span><span class="sxs-lookup"><span data-stu-id="46858-111">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="46858-112">Imagem do estilo:</span><span class="sxs-lookup"><span data-stu-id="46858-112">Style image:</span></span> | <span data-ttu-id="46858-113">Vídeo de entrada/conteúdo:</span><span class="sxs-lookup"><span data-stu-id="46858-113">Input/content video:</span></span> | <span data-ttu-id="46858-114">Vídeo de saída:</span><span class="sxs-lookup"><span data-stu-id="46858-114">Output video:</span></span> |
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="46858-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Vídeo de entrada") *clique para ver o vídeo*</span><span class="sxs-lookup"><span data-stu-id="46858-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="46858-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Vídeo de saída") *clique para ver o vídeo*</span><span class="sxs-lookup"><span data-stu-id="46858-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="46858-117">Essa arquitetura de referência foi projetada para cargas de trabalho que são disparadas pela presença da nova mídia no Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="46858-117">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="46858-118">O processamento envolve as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="46858-118">Processing involves the following steps:</span></span>

1. <span data-ttu-id="46858-119">Carregue uma imagem de estilo específica (como uma pintura do Van Gogh) e um script de transferência de estilo no Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-119">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="46858-120">Crie um cluster de dimensionamento automático da IA do Lote que esteja pronto para começar a fazer o trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-120">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="46858-121">Divida o arquivo de vídeo em quadros individuais e carregue-os no Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-121">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="46858-122">Após o upload de todos os quadros, carregue um arquivo de gatilho no Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-122">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="46858-123">Esse arquivo dispara um Aplicativo Lógico que cria um contêiner em execução em Instâncias de Contêiner do Azure.</span><span class="sxs-lookup"><span data-stu-id="46858-123">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="46858-124">O contêiner executa um script que cria os trabalhos de IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-124">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="46858-125">Cada trabalho aplica a transferência de estilo neural em paralelo em todos os nós do cluster da IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-125">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="46858-126">Após a geração das imagens, elas são salvas no Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-126">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="46858-127">Faça o download dos quadros gerados e insira as imagens de volta em um vídeo.</span><span class="sxs-lookup"><span data-stu-id="46858-127">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="46858-128">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="46858-128">Architecture</span></span>

<span data-ttu-id="46858-129">Essa arquitetura é formada pelos componentes a seguir.</span><span class="sxs-lookup"><span data-stu-id="46858-129">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="46858-130">Computação</span><span class="sxs-lookup"><span data-stu-id="46858-130">Compute</span></span>

<span data-ttu-id="46858-131">**[IA do Lote do Azure][batch-ai]** é usada para executar o algoritmo de transferência de estilo neural.</span><span class="sxs-lookup"><span data-stu-id="46858-131">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="46858-132">A IA do Lote dá suporte a cargas de trabalho de aprendizado profundo fornecendo ambientes em contêineres que são pré-configurados para estruturas de aprendizado profundo, em VMs habilitadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="46858-132">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="46858-133">A IA do Lote também pode conectar o cluster de computação ao Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-133">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="46858-134">Armazenamento</span><span class="sxs-lookup"><span data-stu-id="46858-134">Storage</span></span>

<span data-ttu-id="46858-135">**[Armazenamento de Blobs][blob-storage]** é usado para armazenar todas as imagens (imagens de entrada, imagens de estilo e imagens de saída) bem como todos os logs gerados na IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-135">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="46858-136">O Armazenamento de Blobs se integra à IA do Lote por meio do [blobfuse][blobfuse], um sistema de arquivos virtual de software livre que é apoiado pelo Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-136">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="46858-137">O Armazenamento de Blobs também é muito econômico para o desempenho exigido por essa carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-137">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="46858-138">Gatilho/agendamento</span><span class="sxs-lookup"><span data-stu-id="46858-138">Trigger / scheduling</span></span>

<span data-ttu-id="46858-139">**[Aplicativos Lógicos do Azure][logic-apps]** são usados para disparar o fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-139">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="46858-140">Quando o Aplicativo Lógico detecta que um blob foi adicionado ao contêiner, ele dispara o processo da IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-140">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="46858-141">O Aplicativo Lógico é ótimo para esta arquitetura de referência porque é uma maneira fácil de detectar alterações no armazenamento de blobs e fornece um processo fácil para alterar o gatilho.</span><span class="sxs-lookup"><span data-stu-id="46858-141">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="46858-142">**[As Instâncias de Contêiner do Azure][container-instances]** é usado para executar os scripts de Python que criam os trabalhos da IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-142">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="46858-143">A execução desses scripts dentro de um contêiner do Docker é uma maneira conveniente de executá-los sob demanda.</span><span class="sxs-lookup"><span data-stu-id="46858-143">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="46858-144">Para essa arquitetura, usamos as Instâncias de Contêiner porque não há um conector de Aplicativo Lógico pré-criados para ela, o que permite que o Aplicativo Lógico dispare o trabalho da IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-144">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="46858-145">As Instâncias de Contêiner podem ativar rapidamente os processos sem estado.</span><span class="sxs-lookup"><span data-stu-id="46858-145">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="46858-146">**[DockerHub][dockerhub]** é usado para armazenar a imagem do Docker usada pelas Instâncias de Contêiner para executar o processo de criação do trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-146">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="46858-147">O DockerHub foi escolhido para essa arquitetura por ser fácil de usar e ser o repositório de imagens padrão para usuários do Docker.</span><span class="sxs-lookup"><span data-stu-id="46858-147">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="46858-148">O [Registro de Contêiner do Azure][container-registry] também pode ser usado.</span><span class="sxs-lookup"><span data-stu-id="46858-148">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="46858-149">Preparação dos dados</span><span class="sxs-lookup"><span data-stu-id="46858-149">Data preparation</span></span>

<span data-ttu-id="46858-150">Essa arquitetura de referência usa filmagens de um orangotango em uma árvore.</span><span class="sxs-lookup"><span data-stu-id="46858-150">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="46858-151">Baixe a filmagem [aqui][source-video] e processe-a no fluxo de trabalho executando estas etapas:</span><span class="sxs-lookup"><span data-stu-id="46858-151">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="46858-152">Use o [AzCopy][azcopy] para baixar o vídeo do blob público.</span><span class="sxs-lookup"><span data-stu-id="46858-152">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="46858-153">Use [FFmpeg][ffmpeg] para extrair o arquivo de áudio, para que possa ser inseri-lo de volta posteriormente no vídeo de saída.</span><span class="sxs-lookup"><span data-stu-id="46858-153">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="46858-154">Use o FFmpeg para dividir o vídeo em quadros individuais.</span><span class="sxs-lookup"><span data-stu-id="46858-154">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="46858-155">Os quadros serão processados de forma independente, em paralelo.</span><span class="sxs-lookup"><span data-stu-id="46858-155">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="46858-156">Use o AzCopy para copiar os quadros individuais em seu contêiner de blob.</span><span class="sxs-lookup"><span data-stu-id="46858-156">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="46858-157">Nesse estágio, a filmagem está em um formato que pode ser usado para transferência de estilo neural.</span><span class="sxs-lookup"><span data-stu-id="46858-157">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="46858-158">Considerações sobre o desempenho</span><span class="sxs-lookup"><span data-stu-id="46858-158">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="46858-159">GPU versus CPU</span><span class="sxs-lookup"><span data-stu-id="46858-159">GPU vs CPU</span></span>

<span data-ttu-id="46858-160">Para cargas de trabalho de aprendizado profundo, as GPUs geralmente superam bastante as CPUs, chegando até a exigir um cluster considerável de CPUs para obter um desempenho comparável.</span><span class="sxs-lookup"><span data-stu-id="46858-160">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="46858-161">Embora seja uma opção usar apenas CPUs nessa arquitetura, as GPUs fornecerão um perfil de custo/desempenho muito melhor.</span><span class="sxs-lookup"><span data-stu-id="46858-161">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="46858-162">Recomendamos o uso de VMs otimizadas para GPU mais recentes [série NCv3]vm-sizes-gpu.</span><span class="sxs-lookup"><span data-stu-id="46858-162">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="46858-163">As GPUs não estão habilitadas por padrão em todas as regiões.</span><span class="sxs-lookup"><span data-stu-id="46858-163">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="46858-164">Selecione uma região com GPUs habilitadas.</span><span class="sxs-lookup"><span data-stu-id="46858-164">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="46858-165">Além disso, as assinaturas têm uma cota padrão de zero núcleos para VMs otimizadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="46858-165">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="46858-166">Eleve essa cota abrindo uma solicitação de suporte.</span><span class="sxs-lookup"><span data-stu-id="46858-166">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="46858-167">Verifique se a sua assinatura tem cota suficiente para executar sua carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-167">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="46858-168">Paralelização em VMs versus núcleos</span><span class="sxs-lookup"><span data-stu-id="46858-168">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="46858-169">Ao executar um processo de transferência de estilo como um trabalho em lotes, será necessário paralelizar entre VMs os trabalhos executadas principalmente em GPUs.</span><span class="sxs-lookup"><span data-stu-id="46858-169">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="46858-170">Há duas abordagens possíveis: você pode criar um cluster maior usando VMs que têm uma única GPU, ou criar um cluster menor usando VMs com várias GPUs.</span><span class="sxs-lookup"><span data-stu-id="46858-170">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span>

<span data-ttu-id="46858-171">Para essa carga de trabalho, essas duas opções terão um desempenho comparável.</span><span class="sxs-lookup"><span data-stu-id="46858-171">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="46858-172">Usar menos VMs com mais GPUs por VM pode ajudar a reduzir a movimentação de dados.</span><span class="sxs-lookup"><span data-stu-id="46858-172">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="46858-173">No entanto, o volume de dados por trabalho para essa carga de trabalho não é muito grande, portanto, você não observará muita limitação por Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-173">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="46858-174">Tamanho do lote de imagens por trabalho de IA do Lote</span><span class="sxs-lookup"><span data-stu-id="46858-174">Images batch size per Batch AI job</span></span>

<span data-ttu-id="46858-175">Outro parâmetro deve ser configurado é o número de imagens a serem processadas por um trabalho da IA do Lote.</span><span class="sxs-lookup"><span data-stu-id="46858-175">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="46858-176">Por um lado, convém garantir que o trabalho seja distribuído amplamente pelos nós e, se um trabalho falhar, não será necessário repetir muitas imagens.</span><span class="sxs-lookup"><span data-stu-id="46858-176">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="46858-177">Isso indica ter vários trabalhos da IA do Lote e, portanto, menos imagens para processar por trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-177">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="46858-178">Por outro lado, se poucas imagens forem processadas por trabalho, o tempo de configuração/inicialização ficará aumentará desproporcionalmente.</span><span class="sxs-lookup"><span data-stu-id="46858-178">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="46858-179">Defina o número de trabalhos igual ao número máximo de nós no cluster.</span><span class="sxs-lookup"><span data-stu-id="46858-179">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="46858-180">Essa opção proporcionará o melhor desempenho, supondo que nenhum trabalho falhe, pois minimiza o custo de configuração/inicialização.</span><span class="sxs-lookup"><span data-stu-id="46858-180">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="46858-181">No entanto, se um trabalho falhar, talvez seja necessário reprocessar uma grande quantidade de imagens.</span><span class="sxs-lookup"><span data-stu-id="46858-181">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="46858-182">Servidores de arquivos</span><span class="sxs-lookup"><span data-stu-id="46858-182">File servers</span></span>

<span data-ttu-id="46858-183">Ao usar a IA do Lote, você pode escolher várias opções de armazenamento, dependendo da taxa de transferência necessária para o seu cenário.</span><span class="sxs-lookup"><span data-stu-id="46858-183">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="46858-184">Para cargas de trabalho que precisam de uma taxa de transferência baixa, usar o Armazenamento de Blobs (por meio do blobfuse) deve ser suficiente.</span><span class="sxs-lookup"><span data-stu-id="46858-184">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="46858-185">Como alternativa, a IA do Lote também dá suporte a um Servidor de Arquivos da IA do Lote, um NFS gerenciado de nó único, que pode ser montado automaticamente em nós de cluster para fornecer um local de armazenamento de acesso centralizado para os trabalhos.</span><span class="sxs-lookup"><span data-stu-id="46858-185">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="46858-186">Na maioria dos casos, somente um servidor de arquivos é necessário em um espaço de trabalho e você pode separar os dados de seus trabalhos de treinamento em diretórios diferentes.</span><span class="sxs-lookup"><span data-stu-id="46858-186">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="46858-187">Se o NFS de nó único não for adequado para suas cargas de trabalho, a IA do Lote dá suporte a outras opções de armazenamento, incluindo o Arquivos do Azure ou soluções personalizadas como um sistema de arquivos Gluster ou Lustre.</span><span class="sxs-lookup"><span data-stu-id="46858-187">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="46858-188">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="46858-188">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="46858-189">Restrição do acesso ao Armazenamento de Blobs do Azure</span><span class="sxs-lookup"><span data-stu-id="46858-189">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="46858-190">Nessa arquitetura de referência, o Armazenamento de Blobs do Azure é o componente de armazenamento principal que precisa ser protegido.</span><span class="sxs-lookup"><span data-stu-id="46858-190">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="46858-191">A implantação de linha de base mostrada no repositório do GitHub usa chaves da conta de armazenamento para acessar o Armazenamento de Blobs.</span><span class="sxs-lookup"><span data-stu-id="46858-191">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="46858-192">Para obter mais controle e proteção, considere o uso de uma SAS (Assinatura de Acesso Compartilhado).</span><span class="sxs-lookup"><span data-stu-id="46858-192">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="46858-193">Isso concede acesso limitado a objetos no armazenamento, sem a necessidade de codificar as chaves da conta ou salvá-las em um texto não criptografado.</span><span class="sxs-lookup"><span data-stu-id="46858-193">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="46858-194">Essa abordagem é especialmente útil porque as chaves da conta são visíveis em texto não criptografado dentro da interface do designer do Aplicativo Lógico.</span><span class="sxs-lookup"><span data-stu-id="46858-194">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="46858-195">Usar uma SAS também ajuda a garantir que a conta de armazenamento tenha uma governança adequada, e que o acesso seja concedido somente para as pessoas certas.</span><span class="sxs-lookup"><span data-stu-id="46858-195">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="46858-196">Para cenários com os dados mais confidenciais, verifique se todas as chaves de armazenamento estão protegidas, pois essas chaves concedem acesso completo a todos os dados de entrada e de saída da carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-196">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="46858-197">Criptografia de dados e movimentação de dados</span><span class="sxs-lookup"><span data-stu-id="46858-197">Data encryption and data movement</span></span>

<span data-ttu-id="46858-198">Essa arquitetura de referência usa transferência de estilo como um exemplo de um processo de pontuação do lote.</span><span class="sxs-lookup"><span data-stu-id="46858-198">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="46858-199">Para cenários com dados mais confidenciais, os dados no armazenamento devem ser criptografados em repouso.</span><span class="sxs-lookup"><span data-stu-id="46858-199">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="46858-200">Sempre que os dados são movidos de um local para o próximo, use SSL para proteger a transferência de dados.</span><span class="sxs-lookup"><span data-stu-id="46858-200">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="46858-201">Para saber mais, confira o [Guia de segurança de Armazenamento do Azure][storage-security].</span><span class="sxs-lookup"><span data-stu-id="46858-201">For more information, see [Azure Storage security guide][storage-security].</span></span>

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="46858-202">Proteção dos dados em uma rede virtual</span><span class="sxs-lookup"><span data-stu-id="46858-202">Securing data in a virtual network</span></span>

<span data-ttu-id="46858-203">Ao implantar o cluster da IA do Lote, você pode configurar seu cluster para provisionamento dentro de uma sub-rede de uma rede virtual.</span><span class="sxs-lookup"><span data-stu-id="46858-203">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="46858-204">Isso permite que os nós de computação no cluster se comuniquem com segurança com outras máquinas virtuais, ou até mesmo com uma rede local.</span><span class="sxs-lookup"><span data-stu-id="46858-204">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="46858-205">Você também pode usar [pontos de extremidade de serviço][service-endpoints] com o armazenamento de blobs para conceder acesso de uma rede virtual ou usar um NFS de nó único dentro da VNET com a IA do Lote para garantir que os dados estejam sempre protegidos.</span><span class="sxs-lookup"><span data-stu-id="46858-205">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="46858-206">Proteção contra atividades mal-intencionadas</span><span class="sxs-lookup"><span data-stu-id="46858-206">Protecting against malicious activity</span></span>

<span data-ttu-id="46858-207">Em cenários com vários usuários, proteja os dados confidenciais contra atividades mal-intencionadas.</span><span class="sxs-lookup"><span data-stu-id="46858-207">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="46858-208">Se outros usuários receberem acesso a essa implantação para personalizar os dados de entrada, observe as seguintes precauções e considerações:</span><span class="sxs-lookup"><span data-stu-id="46858-208">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="46858-209">Use o RBAC para limitar o acesso de usuários somente aos recursos necessários.</span><span class="sxs-lookup"><span data-stu-id="46858-209">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="46858-210">Provisione duas contas de armazenamento separadas.</span><span class="sxs-lookup"><span data-stu-id="46858-210">Provision two separate storage accounts.</span></span> <span data-ttu-id="46858-211">Armazene dados de entrada e saída na primeira conta.</span><span class="sxs-lookup"><span data-stu-id="46858-211">Store input and output data in the first account.</span></span> <span data-ttu-id="46858-212">Os usuários externos podem obter acesso a essa conta.</span><span class="sxs-lookup"><span data-stu-id="46858-212">External users can be given access to this account.</span></span> <span data-ttu-id="46858-213">Armazene scripts executáveis e arquivos de log de saída na outra conta.</span><span class="sxs-lookup"><span data-stu-id="46858-213">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="46858-214">Os usuários externos não devem ter acesso a essa conta.</span><span class="sxs-lookup"><span data-stu-id="46858-214">External users should not have access to this account.</span></span> <span data-ttu-id="46858-215">Isso garantirá que os usuários externos não possam modificar os arquivos executáveis (para injetar código mal-intencionado) e não tenham acesso a arquivos de log, que podem conter informações confidenciais.</span><span class="sxs-lookup"><span data-stu-id="46858-215">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="46858-216">Os usuários mal-intencionados podem executar DDOS na fila de trabalho ou injetar mensagens suspeitas malformadas na fila de trabalho, fazendo com que o sistema trave ou causando erros de remoção da fila.</span><span class="sxs-lookup"><span data-stu-id="46858-216">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span>

## <a name="monitoring-and-logging"></a><span data-ttu-id="46858-217">Monitoramento e registro em log</span><span class="sxs-lookup"><span data-stu-id="46858-217">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="46858-218">Monitoramento de trabalhos da IA do Lote</span><span class="sxs-lookup"><span data-stu-id="46858-218">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="46858-219">Durante a execução do seu trabalho, é importante monitorar o progresso e certificar-se de que as coisas estão funcionando conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="46858-219">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="46858-220">No entanto, pode ser um desafio monitorar um cluster de nós ativos.</span><span class="sxs-lookup"><span data-stu-id="46858-220">However, it can be a challenge to monitor across a cluster of active nodes.</span></span>

<span data-ttu-id="46858-221">Para ter uma ideia do estado geral do cluster, vá até a folha de IA do Lote do Portal do Azure para inspecionar o estado dos nós no cluster.</span><span class="sxs-lookup"><span data-stu-id="46858-221">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="46858-222">Se um nó estiver inativo ou se um trabalho falhar, os logs de erro serão salvos no armazenamento de blobs e também poderão ser acessados na folha Trabalhos no portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="46858-222">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span>

<span data-ttu-id="46858-223">É possível melhorar ainda mais o monitoramento conectando os logs ao Application Insights ou executando processos separados para sondar o estado do cluster de IA do Lote e seus trabalhos.</span><span class="sxs-lookup"><span data-stu-id="46858-223">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="46858-224">Registro em log na IA do Lote</span><span class="sxs-lookup"><span data-stu-id="46858-224">Logging in Batch AI</span></span>

<span data-ttu-id="46858-225">A IA do Lote registrará automaticamente todos os stdout/stderr para a conta de armazenamento de blob associada.</span><span class="sxs-lookup"><span data-stu-id="46858-225">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="46858-226">O uso de uma ferramenta de navegação de armazenamento, como o Gerenciador de Armazenamento, fornecerá uma experiência muito mais fácil para navegação em arquivos de log.</span><span class="sxs-lookup"><span data-stu-id="46858-226">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span>

<span data-ttu-id="46858-227">As etapas de implantação para essa arquitetura de referência também mostra como configurar um sistema mais simples de registro em log, de modo que todos os logs em diferentes trabalhos são salvos no mesmo diretório em seu contêiner de blob, conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="46858-227">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span> <span data-ttu-id="46858-228">Use esses logs para monitorar quanto tempo demora para processar cada imagem e cada trabalho.</span><span class="sxs-lookup"><span data-stu-id="46858-228">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="46858-229">Isso lhe dará uma ideia melhor de como otimizar ainda mais o processo.</span><span class="sxs-lookup"><span data-stu-id="46858-229">This will give you a better sense of how to optimize the process even further.</span></span>

![Captura de tela de registro em log para a IA do Lote do Azure](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="46858-231">Considerações de custo</span><span class="sxs-lookup"><span data-stu-id="46858-231">Cost considerations</span></span>

<span data-ttu-id="46858-232">Em comparação com os componentes de armazenamento e agendamento, os recursos de computação usados nesta arquitetura de referência dominam em termos de custos.</span><span class="sxs-lookup"><span data-stu-id="46858-232">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="46858-233">Um dos principais desafios é paralelizar com eficiência o trabalho em um cluster de computadores habilitados para GPU.</span><span class="sxs-lookup"><span data-stu-id="46858-233">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="46858-234">O tamanho do cluster da IA do Lote pode aumentar e diminuir automaticamente dependendo dos trabalhos na fila.</span><span class="sxs-lookup"><span data-stu-id="46858-234">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="46858-235">Você pode habilitar o dimensionamento automático com a IA do Lote escolhendo entre duas maneiras.</span><span class="sxs-lookup"><span data-stu-id="46858-235">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="46858-236">Você pode isso programaticamente, que pode ser configurado no arquivo `.env` que faz parte das [etapas de implantação][deployment], ou você pode alterar a fórmula de dimensionamento diretamente no portal após a criação do cluster.</span><span class="sxs-lookup"><span data-stu-id="46858-236">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="46858-237">Para o trabalho que não exige processamento imediato, configure a fórmula de dimensionamento automático, para que o estado padrão (mínimo) seja um cluster sem nós.</span><span class="sxs-lookup"><span data-stu-id="46858-237">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="46858-238">Com essa configuração, o cluster começa com zero nós e só pode ser escalado verticalmente quando detecta os trabalhos na fila.</span><span class="sxs-lookup"><span data-stu-id="46858-238">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="46858-239">Se o processo de pontuação do lote acontecer apenas algumas vezes por dia, essa configuração permitirá uma economia considerável.</span><span class="sxs-lookup"><span data-stu-id="46858-239">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="46858-240">Talvez o dimensionamento automático não seja apropriado para trabalhos em lote que aconteçam muito próximos uns dos outros.</span><span class="sxs-lookup"><span data-stu-id="46858-240">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="46858-241">O tempo de ativação e desativação de um cluster também incorre em um custo, portanto, se uma carga de trabalho do lote começar apenas alguns minutos após o término do trabalho anterior, talvez seja mais econômico manter o cluster em execução entre os trabalhos.</span><span class="sxs-lookup"><span data-stu-id="46858-241">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="46858-242">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="46858-242">Deploy the solution</span></span>

<span data-ttu-id="46858-243">Para implantar essa arquitetura de referência, execute as etapas descritas no [repositório do GitHub][deployment].</span><span class="sxs-lookup"><span data-stu-id="46858-243">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

<!-- links -->

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu
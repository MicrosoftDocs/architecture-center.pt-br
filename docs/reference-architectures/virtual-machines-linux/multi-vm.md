---
title: Executar VMs com balanceamento de carga no Azure para escalabilidade e disponibilidade
description: Como executar várias VMs do Linux no Azure para ter escalabilidade e disponibilidade.
author: telmosampaio
ms.date: 11/16/2017
pnp.series.title: Linux VM workloads
pnp.series.next: n-tier
pnp.series.prev: single-vm
ms.openlocfilehash: 2c8b1310e0a76ae0cea0a52cdbd2a0e5d3205d6e
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/06/2018
---
# <a name="run-load-balanced-vms-for-scalability-and-availability"></a><span data-ttu-id="81411-103">Executar VMs com balanceamento de carga para ter escalabilidade e disponibilidade</span><span class="sxs-lookup"><span data-stu-id="81411-103">Run load-balanced VMs for scalability and availability</span></span>

<span data-ttu-id="81411-104">Essa arquitetura de referência mostra um conjunto de práticas comprovadas para executar várias VMs (máquinas de virtuais) do Linux em um conjunto de dimensionamento atrás de um balanceador de carga para melhorar a disponibilidade e a escalabilidade.</span><span class="sxs-lookup"><span data-stu-id="81411-104">This reference architecture shows a set of proven practices for running multiple Linux virtual machines (VMs) in a scale set behind a load balancer, to improve availability and scalability.</span></span> <span data-ttu-id="81411-105">Essa arquitetura pode ser usada para qualquer carga de trabalho sem estado, como um servidor Web e é uma fundação para a implantação de aplicativos de N camadas.</span><span class="sxs-lookup"><span data-stu-id="81411-105">This architecture can be used for any stateless workload, such as a web server, and is a foundation for deploying n-tier applications.</span></span> [<span data-ttu-id="81411-106">**Implante essa solução**.</span><span class="sxs-lookup"><span data-stu-id="81411-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="81411-107">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="81411-107">![[0]][0]</span></span>

<span data-ttu-id="81411-108">*Baixe um [Arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="81411-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="81411-109">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="81411-109">Architecture</span></span>

<span data-ttu-id="81411-110">Esta arquitetura baseia-se na [Arquitetura de referência de VM única ][single-vm].</span><span class="sxs-lookup"><span data-stu-id="81411-110">This architecture builds on the [Single VM reference architecture][single-vm].</span></span> <span data-ttu-id="81411-111">Essas recomendações também se aplicam a essa arquitetura.</span><span class="sxs-lookup"><span data-stu-id="81411-111">Those recommendations also apply to this architecture.</span></span>

<span data-ttu-id="81411-112">Nesta arquitetura, uma carga de trabalho é distribuída em várias instâncias de VM.</span><span class="sxs-lookup"><span data-stu-id="81411-112">In this architecture, a workload is distributed across multiple VM instances.</span></span> <span data-ttu-id="81411-113">Há um único endereço IP público e o tráfego da Internet é distribuído para as VMs usando um balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-113">There is a single public IP address, and Internet traffic is distributed to the VMs using a load balancer.</span></span> <span data-ttu-id="81411-114">Essa arquitetura pode ser usada para um aplicativo de camada única, como um aplicativo Web sem estado.</span><span class="sxs-lookup"><span data-stu-id="81411-114">This architecture can be used for a single-tier application, such as a stateless web application.</span></span>

<span data-ttu-id="81411-115">A arquitetura tem os seguintes componentes:</span><span class="sxs-lookup"><span data-stu-id="81411-115">The architecture has the following components:</span></span>

* <span data-ttu-id="81411-116">**Grupo de recursos.**</span><span class="sxs-lookup"><span data-stu-id="81411-116">**Resource group.**</span></span> <span data-ttu-id="81411-117">[Grupos de recursos][resource-manager-overview] são utilizados para agrupar os recursos para que eles possam ser gerenciados pelo tempo de vida, o proprietário ou outros critérios.</span><span class="sxs-lookup"><span data-stu-id="81411-117">[Resource groups][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, or other criteria.</span></span>
* <span data-ttu-id="81411-118">**Rede Virtual e sub-rede.**</span><span class="sxs-lookup"><span data-stu-id="81411-118">**Virtual network (VNet) and subnet.**</span></span> <span data-ttu-id="81411-119">Cada VM do Azure é implantada em uma VNet que pode ser segmentada em várias sub-redes.</span><span class="sxs-lookup"><span data-stu-id="81411-119">Every Azure VM is deployed into a VNet that can be segmented into multiple subnets.</span></span>
* <span data-ttu-id="81411-120">**Azure Load Balancer**.</span><span class="sxs-lookup"><span data-stu-id="81411-120">**Azure Load Balancer**.</span></span> <span data-ttu-id="81411-121">O [balanceador de carga][load-balancer] distribui as solicitações de entrada da Internet para as instâncias de VM.</span><span class="sxs-lookup"><span data-stu-id="81411-121">The [load balancer][load-balancer] distributes incoming Internet requests to the VM instances.</span></span> 
* <span data-ttu-id="81411-122">**Endereço IP público**.</span><span class="sxs-lookup"><span data-stu-id="81411-122">**Public IP address**.</span></span> <span data-ttu-id="81411-123">É necessário ter um endereço IP público para que o balanceador de carga possa receber o tráfego da Internet.</span><span class="sxs-lookup"><span data-stu-id="81411-123">A public IP address is needed for the load balancer to receive Internet traffic.</span></span>
* <span data-ttu-id="81411-124">**DNS do Azure**.</span><span class="sxs-lookup"><span data-stu-id="81411-124">**Azure DNS**.</span></span> <span data-ttu-id="81411-125">[DNS do Azure][azure-dns] é um serviço de hospedagem para domínios DNS, que fornece resolução de nomes usando a infraestrutura do Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="81411-125">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="81411-126">Ao hospedar seus domínios no Azure, você pode gerenciar seus registros DNS usando as mesmas credenciais, APIs, ferramentas e cobrança que seus outros serviços do Azure.</span><span class="sxs-lookup"><span data-stu-id="81411-126">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>
* <span data-ttu-id="81411-127">**Conjunto de dimensionamento de VM**.</span><span class="sxs-lookup"><span data-stu-id="81411-127">**VM scale set**.</span></span> <span data-ttu-id="81411-128">Um [conjunto de dimensionamento de VM][vm-scaleset] é um conjunto de VMs idênticas usado para hospedar uma carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="81411-128">A [VM scale set][vm-scaleset] is a set of identical VMs used to host a workload.</span></span> <span data-ttu-id="81411-129">Os conjuntos de dimensionamento permitem que o número de VMs seja reduzido horizontalmente dentro ou fora manualmente, ou automaticamente com base em regras predefinidas.</span><span class="sxs-lookup"><span data-stu-id="81411-129">Scale sets allow the number of VMs to be scaled in or out manually, or automatically based on predefined rules.</span></span>
* <span data-ttu-id="81411-130">**Conjunto de disponibilidade**.</span><span class="sxs-lookup"><span data-stu-id="81411-130">**Availability set**.</span></span> <span data-ttu-id="81411-131">O [conjunto de disponibilidade][availability-set] contém as VMs, tornando-as qualificadas para um [SLA (Contrato de Nível de Serviço)][vm-sla] mais elevado.</span><span class="sxs-lookup"><span data-stu-id="81411-131">The [availability set][availability-set] contains the VMs, making the VMs eligible for a higher [service level agreement (SLA)][vm-sla].</span></span> <span data-ttu-id="81411-132">Para que o SLA mais elevado seja aplicável, o conjunto de disponibilidade deve incluir um mínimo de duas VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-132">For the higher SLA to apply, the availability set must include a minimum of two VMs.</span></span> <span data-ttu-id="81411-133">Conjuntos de disponibilidade são conjuntos de dimensionamento implícitos.</span><span class="sxs-lookup"><span data-stu-id="81411-133">Availability sets are implicit in scale sets.</span></span> <span data-ttu-id="81411-134">Se você criar VMs fora de um conjunto de dimensionamento, será necessário criar o conjunto de disponibilidade independentemente.</span><span class="sxs-lookup"><span data-stu-id="81411-134">If you create VMs outside a scale set, you need to create the availability set independently.</span></span>
* <span data-ttu-id="81411-135">**Discos gerenciados**.</span><span class="sxs-lookup"><span data-stu-id="81411-135">**Managed disks**.</span></span> <span data-ttu-id="81411-136">O Azure Managed Disks gerenciam os arquivos VHD (disco rígido virtual) para os discos de VM.</span><span class="sxs-lookup"><span data-stu-id="81411-136">Azure Managed Disks manage the virtual hard disk (VHD) files for the VM disks.</span></span> 
* <span data-ttu-id="81411-137">**Armazenamento**.</span><span class="sxs-lookup"><span data-stu-id="81411-137">**Storage**.</span></span> <span data-ttu-id="81411-138">Crie uma conta de Armazenamento do Azure para conter os logs de diagnóstico para as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-138">Create an Azure Storage acount to hold diagnostic logs for the VMs.</span></span>

## <a name="recommendations"></a><span data-ttu-id="81411-139">Recomendações</span><span class="sxs-lookup"><span data-stu-id="81411-139">Recommendations</span></span>

<span data-ttu-id="81411-140">Seus requisitos podem não se alinhar completamente com a arquitetura descrita aqui.</span><span class="sxs-lookup"><span data-stu-id="81411-140">Your requirements may not align completely with the architecture described here.</span></span> <span data-ttu-id="81411-141">Use essas recomendações como ponto de partida.</span><span class="sxs-lookup"><span data-stu-id="81411-141">Use these recommendations as a starting point.</span></span> 

### <a name="availability-and-scalability-recommendations"></a><span data-ttu-id="81411-142">Recomendações de disponibilidade e escalabilidade</span><span class="sxs-lookup"><span data-stu-id="81411-142">Availability and scalability recommendations</span></span>

<span data-ttu-id="81411-143">Uma opção para ter disponibilidade e escalabilidade é usar um [conjunto de dimensionamento de máquinas virtuais][vmss].</span><span class="sxs-lookup"><span data-stu-id="81411-143">An option for availability and scalability is to use a [virtual machine scale set][vmss].</span></span> <span data-ttu-id="81411-144">Conjuntos de dimensionamento de VM ajudam a implantar e gerenciar um conjunto de VMs idênticas.</span><span class="sxs-lookup"><span data-stu-id="81411-144">VM scale sets help you to deploy and manage a set of identical VMs.</span></span> <span data-ttu-id="81411-145">Conjuntos de dimensionamento dão suporte ao dimensionamento automático com base nas métricas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="81411-145">Scale sets support autoscaling based on performance metrics.</span></span> <span data-ttu-id="81411-146">À medida que a carga nas VMs aumenta, VMs adicionais são acrescentadas automaticamente ao balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-146">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="81411-147">Considere usar os conjuntos de dimensionamento se você precisar aumentar as VMs rapidamente ou se precisar de dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="81411-147">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="81411-148">Por padrão, os conjuntos de dimensionamento usam “excesso de provisionamento”, o que significa que o conjunto de dimensionamento inicialmente provisiona mais VMs do que você pediu, excluindo posteriormente as VMs adicionais.</span><span class="sxs-lookup"><span data-stu-id="81411-148">By default, scale sets use "overprovisioning," which means the scale set initially provisions more VMs than you ask for, then deletes the extra VMs.</span></span> <span data-ttu-id="81411-149">Isso melhora a taxa de sucesso geral ao provisionar as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-149">This improves the overall success rate when provisioning the VMs.</span></span> <span data-ttu-id="81411-150">Se você não estiver usando [discos gerenciados](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), recomendamos não usar mais do que 20 VMs por conta de armazenamento com excesso com provisionamento habilitado e não mais do que 40 VMs com o excesso de provisionamento desabilitado.</span><span class="sxs-lookup"><span data-stu-id="81411-150">If you are not using [managed disks](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), we recommend no more than 20 VMs per storage account with overprovisioning enabled, and no more than 40 VMs with overprovisioning disabled.</span></span>

<span data-ttu-id="81411-151">Há duas maneiras básicas de configurar as VMs implantadas em um conjunto de dimensionamento:</span><span class="sxs-lookup"><span data-stu-id="81411-151">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="81411-152">Use as extensões para configurar a VM depois que ela é provisionada.</span><span class="sxs-lookup"><span data-stu-id="81411-152">Use extensions to configure the VM after it is provisioned.</span></span> <span data-ttu-id="81411-153">Com essa abordagem, novas instâncias de VM podem levar mais tempo para ser iniciadas do que uma VM sem extensões.</span><span class="sxs-lookup"><span data-stu-id="81411-153">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="81411-154">Implante um [disco gerenciado](/azure/storage/storage-managed-disks-overview) com uma imagem de disco personalizada.</span><span class="sxs-lookup"><span data-stu-id="81411-154">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="81411-155">Essa opção pode ser mais rápida de implantar.</span><span class="sxs-lookup"><span data-stu-id="81411-155">This option may be quicker to deploy.</span></span> <span data-ttu-id="81411-156">Porém, isso requer que você mantenha a imagem atualizada.</span><span class="sxs-lookup"><span data-stu-id="81411-156">However, it requires you to keep the image up to date.</span></span>

<span data-ttu-id="81411-157">Para ver considerações adicionais, consulte [Considerações de design para conjuntos de dimensionamento][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="81411-157">For additional considerations, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="81411-158">Ao usar qualquer solução de dimensionamento automático, teste-a com cargas de trabalho no nível de produção com bastante antecedência.</span><span class="sxs-lookup"><span data-stu-id="81411-158">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="81411-159">Se você não usar um conjunto de dimensionamento, considere usar pelo menos um conjunto de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="81411-159">If you do not use a scale set, consider at least using an availability set.</span></span> <span data-ttu-id="81411-160">Crie pelo menos duas VMs no conjunto de disponibilidade para dar suporte ao [SLA de disponibilidade para VMs do Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="81411-160">Create at least two VMs in the availability set to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="81411-161">O Azure Load Balancer também exige que as VMs com balanceamento de carga pertençam ao mesmo conjunto de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="81411-161">The Azure load balancer also requires that load-balanced VMs belong to the same availability set.</span></span>

<span data-ttu-id="81411-162">Cada assinatura do Azure tem limites padrão em vigor, incluindo um número máximo de VMs por região.</span><span class="sxs-lookup"><span data-stu-id="81411-162">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="81411-163">Você pode aumentar o limite enviando uma solicitação de suporte.</span><span class="sxs-lookup"><span data-stu-id="81411-163">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="81411-164">Para saber mais, confira [Assinatura e limites de serviço, cotas e restrições do Azure][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="81411-164">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

### <a name="network-recommendations"></a><span data-ttu-id="81411-165">Recomendações de rede</span><span class="sxs-lookup"><span data-stu-id="81411-165">Network recommendations</span></span>

<span data-ttu-id="81411-166">Implemente as VMs dentro da mesma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="81411-166">Deploy the VMs within the same subnet.</span></span> <span data-ttu-id="81411-167">Não exponha as VMs diretamente à Internet, concedendo, em vez disso, um endereço IP privado a cada VM.</span><span class="sxs-lookup"><span data-stu-id="81411-167">Do not expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="81411-168">Os clientes se conectam usando um endereço IP público do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-168">Clients connect using the public IP address of the load balancer.</span></span>

<span data-ttu-id="81411-169">Se você precisar fazer logon nas VMs atrás do balanceador de carga, considere adicionar uma VM única como jumpbox (também chamada de host de bastião) com um endereço IP público no qual você pode fazer logon.</span><span class="sxs-lookup"><span data-stu-id="81411-169">If you need to log into the VMs behind the load balancer, consider adding a single VM as a jumpbox (also called a bastion host) with a public IP address you can log into.</span></span> <span data-ttu-id="81411-170">Em seguida, faça logon nas VMs por trás do balanceador de carga por meio do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="81411-170">And then log into the VMs behind the load balancer from the jumpbox.</span></span> <span data-ttu-id="81411-171">Alternativamente, é possível configurar as regras de NAT (conversão de endereços de rede) de entrada do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-171">Alternatively, you can configure the load balancer's inbound network address translation (NAT) rules.</span></span> <span data-ttu-id="81411-172">No entanto, ter um jumpbox é a melhor solução quando você hospeda cargas de trabalho de N camadas ou várias cargas de trabalho.</span><span class="sxs-lookup"><span data-stu-id="81411-172">However, having a jumpbox is a better solution when you are hosting n-tier workloads or multiple workloads.</span></span>

### <a name="load-balancer-recommendations"></a><span data-ttu-id="81411-173">Recomendações de balanceador de carga</span><span class="sxs-lookup"><span data-stu-id="81411-173">Load balancer recommendations</span></span>

<span data-ttu-id="81411-174">Adicione todas as VMs no conjunto de disponibilidade ao pool de endereços de back-end do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-174">Add all VMs in the availability set to the back-end address pool of the load balancer.</span></span>

<span data-ttu-id="81411-175">Defina as regras do balanceador de carga para direcionar tráfego de rede para as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-175">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="81411-176">Por exemplo, para permitir tráfego HTTP, crie uma regra que mapeie a porta 80 da configuração de front-end para a porta 80 no pool de endereços de back-end.</span><span class="sxs-lookup"><span data-stu-id="81411-176">For example, to enable HTTP traffic, create a rule that maps port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="81411-177">Quando um cliente envia uma solicitação HTTP para a porta 80, o balanceador de carga seleciona um endereço IP de back-end usando um [algoritmo de hash][load-balancer-hashing] que inclui o endereço IP de origem.</span><span class="sxs-lookup"><span data-stu-id="81411-177">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load-balancer-hashing] that includes the source IP address.</span></span> <span data-ttu-id="81411-178">Dessa forma, as solicitações de cliente são distribuídas por todas as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-178">In that way, client requests are distributed across all the VMs.</span></span>

<span data-ttu-id="81411-179">Para rotear o tráfego para uma VM específica, use as regras NAT.</span><span class="sxs-lookup"><span data-stu-id="81411-179">To route traffic to a specific VM, use NAT rules.</span></span> <span data-ttu-id="81411-180">Por exemplo, para habilitar RDP para as máquinas virtuais, crie uma regra NAT separada para cada VM.</span><span class="sxs-lookup"><span data-stu-id="81411-180">For example, to enable RDP to the VMs, create a separate NAT rule for each VM.</span></span> <span data-ttu-id="81411-181">Cada regra deve mapear um número da porta diferente para a porta 3389, a porta padrão para RDP.</span><span class="sxs-lookup"><span data-stu-id="81411-181">Each rule should map a distinct port number to port 3389, the default port for RDP.</span></span> <span data-ttu-id="81411-182">Por exemplo, use a porta 50001 para “VM1”, 50002 para “VM2” e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="81411-182">For example, use port 50001 for "VM1," port 50002 for "VM2," and so on.</span></span> <span data-ttu-id="81411-183">Atribua as regras NAT às NICs nas VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-183">Assign the NAT rules to the NICs on the VMs.</span></span>

### <a name="storage-account-recommendations"></a><span data-ttu-id="81411-184">Recomendações de conta de armazenamento</span><span class="sxs-lookup"><span data-stu-id="81411-184">Storage account recommendations</span></span>

<span data-ttu-id="81411-185">Também é recomendável usar os [discos gerenciado](/azure/storage/storage-managed-disks-overview) com o [armazenamento premium][premium].</span><span class="sxs-lookup"><span data-stu-id="81411-185">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview) with [premium storage][premium].</span></span> <span data-ttu-id="81411-186">Os discos gerenciados não exigem uma conta de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="81411-186">Managed disks do not require a storage account.</span></span> <span data-ttu-id="81411-187">Você simplesmente especifica o tamanho e o tipo de disco e é implantado como um recurso altamente disponível.</span><span class="sxs-lookup"><span data-stu-id="81411-187">You simply specify the size and type of disk and it is deployed as a highly available resource.</span></span>

<span data-ttu-id="81411-188">Se você estiver utilizando discos não gerenciados, crie contas de armazenamento do Azure separadas para cada VM para manter os VHDs (discos rígidos virtuais), para evitar atingir os [limites de IOPS][vm-disk-limits] (operações de entrada/saída por segundo) para contas de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="81411-188">If you are using unmanaged disks, create separate Azure storage accounts for each VM to hold the virtual hard disks (VHDs), in order to avoid hitting the input/output operations per second [(IOPS) limits][vm-disk-limits] for storage accounts.</span></span>

<span data-ttu-id="81411-189">Crie uma conta de armazenamento para logs de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="81411-189">Create one storage account for diagnostic logs.</span></span> <span data-ttu-id="81411-190">Esta conta de armazenamento pode ser compartilhada por todas as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-190">This storage account can be shared by all the VMs.</span></span> <span data-ttu-id="81411-191">Ela pode ser uma conta de armazenamento não gerenciada usando discos padrão.</span><span class="sxs-lookup"><span data-stu-id="81411-191">This can be an unmanaged storage account using standard disks.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="81411-192">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="81411-192">Availability considerations</span></span>

<span data-ttu-id="81411-193">O conjunto de disponibilidade torna seu aplicativo mais resiliente a eventos de manutenção planejados e não planejados.</span><span class="sxs-lookup"><span data-stu-id="81411-193">The availability set makes your application more resilient to both planned and unplanned maintenance events.</span></span>

* <span data-ttu-id="81411-194">A *manutenção planejada* ocorre quando a Microsoft atualiza a plataforma subjacente, podendo fazer com que as VMs sejam reiniciadas.</span><span class="sxs-lookup"><span data-stu-id="81411-194">*Planned maintenance* occurs when Microsoft updates the underlying platform, sometimes causing VMs to be restarted.</span></span> <span data-ttu-id="81411-195">O Azure garante que as VMs em um conjunto de disponibilidade não sejam reiniciadas ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="81411-195">Azure makes sure the VMs in an availability set are not all restarted at the same time.</span></span> <span data-ttu-id="81411-196">Pelo menos uma delas é mantida em execução enquanto as outras estão reiniciando.</span><span class="sxs-lookup"><span data-stu-id="81411-196">At least one is kept running while others are restarting.</span></span>
* <span data-ttu-id="81411-197">A *manutenção não planejada* ocorre em caso de falha de hardware.</span><span class="sxs-lookup"><span data-stu-id="81411-197">*Unplanned maintenance* happens if there is a hardware failure.</span></span> <span data-ttu-id="81411-198">O Azure garante que as VMs em um conjunto de disponibilidade sejam provisionadas em mais de um rack do servidor.</span><span class="sxs-lookup"><span data-stu-id="81411-198">Azure makes sure that VMs in an availability set are provisioned across more than one server rack.</span></span> <span data-ttu-id="81411-199">Isso ajuda a reduzir o impacto de falhas de hardware, interrupções de rede, interrupções de energia e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="81411-199">This helps to reduce the impact of hardware failures, network outages, power interruptions, and so on.</span></span>

<span data-ttu-id="81411-200">Para obter mais informações, consulte [Gerenciar a disponibilidade de máquinas virtuais][availability-set].</span><span class="sxs-lookup"><span data-stu-id="81411-200">For more information, see [Manage the availability of virtual machines][availability-set].</span></span> <span data-ttu-id="81411-201">O vídeo a seguir também fornece uma boa visão geral dos conjuntos de disponibilidade: [Como configurar um conjunto de disponibilidade para dimensionar VMs][availability-set-ch9].</span><span class="sxs-lookup"><span data-stu-id="81411-201">The following video also provides a good overview of availability sets: [How Do I Configure an Availability Set to Scale VMs][availability-set-ch9].</span></span>

> [!WARNING]
> <span data-ttu-id="81411-202">Verifique se o conjunto de disponibilidade está configurado ao provisionar a VM.</span><span class="sxs-lookup"><span data-stu-id="81411-202">Make sure to configure the availability set when you provision the VM.</span></span> <span data-ttu-id="81411-203">Atualmente, não há nenhuma maneira de adicionar uma VM do Resource Manager a um conjunto de disponibilidade depois que a VM é provisionada.</span><span class="sxs-lookup"><span data-stu-id="81411-203">Currently, there is no way to add a Resource Manager VM to an availability set after the VM is provisioned.</span></span>

<span data-ttu-id="81411-204">O balanceador de carga utiliza [investigações de integridade][health-probes] para monitorar a disponibilidade de instâncias de VM.</span><span class="sxs-lookup"><span data-stu-id="81411-204">The load balancer uses [health probes][health-probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="81411-205">Se uma investigação não puder acessar uma instância dentro de um período de tempo limite, o balanceador de carga parará de enviar tráfego para essa VM.</span><span class="sxs-lookup"><span data-stu-id="81411-205">If a probe cannot reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="81411-206">Contudo, o balanceador de carga continuará a investigar e, se a VM ficar disponível novamente, o balanceador de carga reiniciará o envio de tráfego para ela.</span><span class="sxs-lookup"><span data-stu-id="81411-206">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="81411-207">Aqui estão algumas recomendações sobre as investigações de integridade do balanceador de carga:</span><span class="sxs-lookup"><span data-stu-id="81411-207">Here are some recommendations on load balancer health probes:</span></span>

* <span data-ttu-id="81411-208">As investigações podem testar HTTP ou TCP.</span><span class="sxs-lookup"><span data-stu-id="81411-208">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="81411-209">Se suas VMs são executadas em um servidor HTTP, crie uma investigação HTTP.</span><span class="sxs-lookup"><span data-stu-id="81411-209">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="81411-210">Caso contrário, crie uma investigação TCP.</span><span class="sxs-lookup"><span data-stu-id="81411-210">Otherwise create a TCP probe.</span></span>
* <span data-ttu-id="81411-211">Para uma investigação HTTP, especifique o caminho para um ponto de extremidade HTTP.</span><span class="sxs-lookup"><span data-stu-id="81411-211">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="81411-212">A investigação verifica uma resposta HTTP 200 para esse caminho.</span><span class="sxs-lookup"><span data-stu-id="81411-212">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="81411-213">Ele pode ser o caminho raiz (“/”) ou um ponto de extremidade de monitoramento de integridade que implementa lógica personalizada para verificar a integridade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="81411-213">This can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="81411-214">O ponto de extremidade deve permitir solicitações HTTP anônimas.</span><span class="sxs-lookup"><span data-stu-id="81411-214">The endpoint must allow anonymous HTTP requests.</span></span>
* <span data-ttu-id="81411-215">A investigação é enviada de um endereço IP [conhecido][health-probe-ip], 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="81411-215">The probe is sent from a [known IP address][health-probe-ip], 168.63.129.16.</span></span> <span data-ttu-id="81411-216">Verifique se o tráfego de ou para esse endereço IP não é bloqueado por quaisquer políticas de firewall ou regras de NSG (Grupo de Segurança de Rede).</span><span class="sxs-lookup"><span data-stu-id="81411-216">Make sure you don't block traffic to or from this IP address in any firewall policies or network security group (NSG) rules.</span></span>
* <span data-ttu-id="81411-217">Use os [logs de investigação de integridade][health-probe-log] para exibir o status das investigações de integridade.</span><span class="sxs-lookup"><span data-stu-id="81411-217">Use [health probe logs][health-probe-log] to view the status of the health probes.</span></span> <span data-ttu-id="81411-218">Habilite o registro em log no Portal do Azure para cada balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="81411-218">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="81411-219">Os logs são gravados no Armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="81411-219">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="81411-220">Os logs de mostram como muitas VMs no back-end não estão recebendo o tráfego de rede devido a respostas de investigação com falha.</span><span class="sxs-lookup"><span data-stu-id="81411-220">The logs show how many VMs on the back end are not receiving network traffic due to failed probe responses.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="81411-221">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="81411-221">Manageability considerations</span></span>

<span data-ttu-id="81411-222">Com várias VMs, é importante automatizar os processos para que eles sejam confiáveis e reproduzíveis.</span><span class="sxs-lookup"><span data-stu-id="81411-222">With multiple VMs, it is important to automate processes so they are reliable and repeatable.</span></span> <span data-ttu-id="81411-223">Você pode usar a [Automação do Azure][azure-automation] para automatizar a implantação, aplicação de patches do sistema operacional e outras tarefas.</span><span class="sxs-lookup"><span data-stu-id="81411-223">You can use [Azure Automation][azure-automation] to automate deployment, OS patching, and other tasks.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="81411-224">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="81411-224">Security considerations</span></span>

<span data-ttu-id="81411-225">Redes virtuais são um limite de isolamento de tráfego no Azure.</span><span class="sxs-lookup"><span data-stu-id="81411-225">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="81411-226">As VMs em uma VNet não podem se comunicar diretamente com VMs em uma VNet diferente.</span><span class="sxs-lookup"><span data-stu-id="81411-226">VMs in one VNet cannot communicate directly with VMs in a different VNet.</span></span> <span data-ttu-id="81411-227">As VMs na mesma VNet podem se comunicar, a menos que você crie NSGs ([Grupos de Segurança de Rede][nsg]) para restringir o tráfego.</span><span class="sxs-lookup"><span data-stu-id="81411-227">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="81411-228">Para obter mais informações, consulte [Serviços em nuvem da Microsoft e segurança de rede][network-security].</span><span class="sxs-lookup"><span data-stu-id="81411-228">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="81411-229">Para tráfego de entrada da Internet, as regras do balanceador de carga definem qual tráfego pode alcançar o back-end.</span><span class="sxs-lookup"><span data-stu-id="81411-229">For incoming Internet traffic, the load balancer rules define which traffic can reach the back end.</span></span> <span data-ttu-id="81411-230">No entanto, as regras do balanceador de carga não dão suporte a listas de IP de confiança, por isso se você desejar adicionar determinados endereços IP públicos a uma lista de confiança, acrescente um NSG à sub-rede.</span><span class="sxs-lookup"><span data-stu-id="81411-230">However, load balancer rules don't support IP safe lists, so if you want to add certain public IP addresses to a safe list, add an NSG to the subnet.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="81411-231">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="81411-231">Deploy the solution</span></span>

<span data-ttu-id="81411-232">Uma implantação para essa arquitetura está disponível no [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="81411-232">A deployment for this architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="81411-233">Ela implanta o seguinte:</span><span class="sxs-lookup"><span data-stu-id="81411-233">It deploys the following:</span></span>

  * <span data-ttu-id="81411-234">Uma rede virtual com uma única sub-rede chamada **Web** que contém as VMs.</span><span class="sxs-lookup"><span data-stu-id="81411-234">A virtual network with a single subnet named **web** that contains the VMs.</span></span>
  * <span data-ttu-id="81411-235">Um conjunto de dimensionamento de VM que contém as VMs que executam a versão mais recente do Ubuntu 16.04.3 LTS.</span><span class="sxs-lookup"><span data-stu-id="81411-235">A VM scale set that contains VMs running the latest version of Ubuntu 16.04.3 LTS.</span></span> <span data-ttu-id="81411-236">O dimensionamento automático está habilitado.</span><span class="sxs-lookup"><span data-stu-id="81411-236">Autoscale is enabled.</span></span>
  * <span data-ttu-id="81411-237">Um balanceador de carga localizado na frente do conjunto de dimensionamento da VM.</span><span class="sxs-lookup"><span data-stu-id="81411-237">A load balancer that sits in front of the VM scale set.</span></span>
  * <span data-ttu-id="81411-238">Um NSG com duas regras de entrada que permite tráfego HTTP para o conjunto de dimensionamento da VM.</span><span class="sxs-lookup"><span data-stu-id="81411-238">An NSG with incoming rules that allow HTTP traffic to the VM scale set.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="81411-239">pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="81411-239">Prerequisites</span></span>

<span data-ttu-id="81411-240">Antes de implantar a arquitetura de referência para sua própria assinatura, você deve executar as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="81411-240">Before you can deploy the reference architecture to your own subscription, you must perform the following steps.</span></span>

1. <span data-ttu-id="81411-241">Clone, crie um fork ou baixe o arquivo zip das [arquiteturas de referência][ref-arch-repo] no repositório GitHub.</span><span class="sxs-lookup"><span data-stu-id="81411-241">Clone, fork, or download the zip file for the [reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="81411-242">Verifique se a CLI do Azure 2.0 está instalada no computador.</span><span class="sxs-lookup"><span data-stu-id="81411-242">Make sure you have the Azure CLI 2.0 installed on your computer.</span></span> <span data-ttu-id="81411-243">Para obter instruções de instalação da CLI, consulte [Instalar a CLI 2.0 do Azure][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="81411-243">For CLI installation instructions, see [Install Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="81411-244">Instale os pacote npm dos [Blocos de construção do Azure][azbb].</span><span class="sxs-lookup"><span data-stu-id="81411-244">Install the [Azure building blocks][azbb] npm package.</span></span>

4. <span data-ttu-id="81411-245">Em um prompt de comando, bash prompt ou prompt do PowerShell, faça logon na sua conta do Azure usando um dos comandos abaixo e siga os prompts.</span><span class="sxs-lookup"><span data-stu-id="81411-245">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using one of the commands below, and follow the prompts.</span></span>

   ```bash
   az login
   ```

### <a name="deploy-the-solution-using-azbb"></a><span data-ttu-id="81411-246">Implantar a solução usando azbb</span><span class="sxs-lookup"><span data-stu-id="81411-246">Deploy the solution using azbb</span></span>

<span data-ttu-id="81411-247">Para implantar a carga de trabalho de VM única de exemplo, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="81411-247">To deploy the sample single VM workload, follow these steps:</span></span>

1. <span data-ttu-id="81411-248">Navegue até a pasta `virtual-machines\multi-vm\parameters\linux` do repositório que você baixou na etapa de pré-requisitos acima.</span><span class="sxs-lookup"><span data-stu-id="81411-248">Navigate to the `virtual-machines\multi-vm\parameters\linux` folder for the repository you downloaded in the pre-requisites step above.</span></span>

2. <span data-ttu-id="81411-249">Abra o arquivo `multi-vm-v2.json` e insira um nome de usuário e a chave SSH entre aspas, conforme mostrado abaixo e salve o arquivo.</span><span class="sxs-lookup"><span data-stu-id="81411-249">Open the `multi-vm-v2.json` file and enter a username and SSH key between the quotes, as shown below, then save the file.</span></span>

   ```bash
   "adminUsername": "",
   "sshPublicKey": "",
   ```

3. <span data-ttu-id="81411-250">Execute `azbb` para implantar as VMs conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="81411-250">Run `azbb` to deploy the VMs as shown below.</span></span>

   ```bash
   azbb -s <subscription_id> -g <resource_group_name> -l <location> -p multi-vm-v2.json --deploy
   ```

<span data-ttu-id="81411-251">Para obter mais informações sobre como implantar essa arquitetura de referência de exemplo, visite nosso [Repositório GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="81411-251">For more information on deploying this sample reference architecture, visit our [GitHub repository][git].</span></span>

<!-- links -->

[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[availability-set-ch9]: https://channel9.msdn.com/Series/Microsoft-Azure-Fundamentals-Virtual-Machines/08
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[azure-automation]: /azure/automation/automation-intro
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-cli-2]: /azure/install-azure-cli?view=azure-cli-latest
[azure-dns]: /azure/dns/dns-overview
[git]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[health-probe-log]: /azure/load-balancer/load-balancer-monitor-log
[health-probes]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[load-balancer]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load-balancer-hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[naming-conventions]: ../../best-practices/naming-conventions.md
[network-security]: /azure/best-practices-network-security
[nsg]: /azure/virtual-network/virtual-networks-nsg
[premium]: /azure/storage/common/storage-premium-storage
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview 
[runbook-gallery]: /azure/automation/automation-runbook-gallery#runbooks-in-runbook-gallery
[single-vm]: single-vm.md
[subscription-limits]: /azure/azure-subscription-service-limits
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[vm-disk-limits]: /azure/azure-subscription-service-limits#virtual-machine-disk-limits
[vm-scaleset]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vm-sizes]: https://azure.microsoft.com/documentation/articles/virtual-machines-windows-sizes/
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_2/
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[vmss-quickstart]: https://azure.microsoft.com/documentation/templates/?term=scale+set
[0]: ./images/multi-vm-diagram.png "Arquitetura de uma solução de várias VMs no Azure composta por um conjunto de disponibilidade com duas VMs e um balanceador de carga"

---
title: Executar VMs do Windows para uma arquitetura de N camadas
description: "Como implementar uma arquitetura multicamadas no Azure, atentando-se em especial para a disponibilidade, segurança, escalabilidade e capacidade de gerenciamento da segurança."
author: MikeWasson
ms.date: 11/22/2016
pnp.series.title: Windows VM workloads
pnp.series.next: multi-region-application
pnp.series.prev: multi-vm
ms.openlocfilehash: e25d10d661ac4759f209bd27384303dee2ee454e
ms.sourcegitcommit: 583e54a1047daa708a9b812caafb646af4d7607b
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/28/2017
---
# <a name="run-windows-vms-for-an-n-tier-application"></a><span data-ttu-id="c2365-103">Executar VMs do Windows para um aplicativo de N camadas</span><span class="sxs-lookup"><span data-stu-id="c2365-103">Run Windows VMs for an N-tier application</span></span>

<span data-ttu-id="c2365-104">Essa arquitetura de referência mostra um conjunto de práticas comprovadas para executar VMs (máquinas virtuais) do Windows para um aplicativo de N camadas.</span><span class="sxs-lookup"><span data-stu-id="c2365-104">This reference architecture shows a set of proven practices for running Windows virtual machines (VMs) for an N-tier application.</span></span> [<span data-ttu-id="c2365-105">**Implantar esta solução**.</span><span class="sxs-lookup"><span data-stu-id="c2365-105">**Deploy this solution**.</span></span>](#deploy-the-solution) 

<span data-ttu-id="c2365-106">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="c2365-106">![[0]][0]</span></span>

<span data-ttu-id="c2365-107">*Baixe um [arquivo Visio][visio-download] dessa arquitetura.*</span><span class="sxs-lookup"><span data-stu-id="c2365-107">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="c2365-108">Arquitetura</span><span class="sxs-lookup"><span data-stu-id="c2365-108">Architecture</span></span> 

<span data-ttu-id="c2365-109">Há muitas maneiras de implementar uma arquitetura de N camadas.</span><span class="sxs-lookup"><span data-stu-id="c2365-109">There are many ways to implement an N-tier architecture.</span></span> <span data-ttu-id="c2365-110">O diagrama mostra um aplicativo Web de três camadas típico.</span><span class="sxs-lookup"><span data-stu-id="c2365-110">The diagram shows a typical 3-tier web application.</span></span> <span data-ttu-id="c2365-111">Essa arquitetura se baseia em [Executar VMs com balanceamento de carga para escalabilidade e disponibilidade][multi-vm].</span><span class="sxs-lookup"><span data-stu-id="c2365-111">This architecture builds on [Run load-balanced VMs for scalability and availability][multi-vm].</span></span> <span data-ttu-id="c2365-112">As camadas comerciais e da Web usam VMs com balanceamento de carga.</span><span class="sxs-lookup"><span data-stu-id="c2365-112">The web and business tiers use load-balanced VMs.</span></span>

* <span data-ttu-id="c2365-113">**Conjuntos de disponibilidade.**</span><span class="sxs-lookup"><span data-stu-id="c2365-113">**Availability sets.**</span></span> <span data-ttu-id="c2365-114">Crie um [conjunto de disponibilidade][azure-availability-sets] para cada camada e provisione pelo menos duas VMs em cada camada.</span><span class="sxs-lookup"><span data-stu-id="c2365-114">Create an [availability set][azure-availability-sets] for each tier, and provision at least two VMs in each tier.</span></span> <span data-ttu-id="c2365-115">Isso torna as VMs qualificadas para um [SLA (Contrato de Nível de Serviço)][vm-sla] mais elevado.</span><span class="sxs-lookup"><span data-stu-id="c2365-115">This makes the VMs eligible for a higher [service level agreement (SLA)][vm-sla] for VMs.</span></span> <span data-ttu-id="c2365-116">É possível implantar uma VM única em um conjunto de disponibilidade, mas a VM única não se qualificará para uma garantia de SLA, a menos que a VM única esteja utilizando o Armazenamento Premium do Azure para todos discos de dados e SO.</span><span class="sxs-lookup"><span data-stu-id="c2365-116">You can deploy a single VM in an availability set, but the single VM will not qualify for an SLA guarantee unless the single VM is using Azure Premium Storage for all OS and data disks.</span></span>  
* <span data-ttu-id="c2365-117">**Sub-redes.**</span><span class="sxs-lookup"><span data-stu-id="c2365-117">**Subnets.**</span></span> <span data-ttu-id="c2365-118">Sempre crie uma sub-rede separada para cada camada.</span><span class="sxs-lookup"><span data-stu-id="c2365-118">Create a separate subnet for each tier.</span></span> <span data-ttu-id="c2365-119">Especifique o intervalo de endereços e a máscara de sub-rede usando a notação [CIDR].</span><span class="sxs-lookup"><span data-stu-id="c2365-119">Specify the address range and subnet mask using [CIDR] notation.</span></span> 
* <span data-ttu-id="c2365-120">**Balanceadores de carga.**</span><span class="sxs-lookup"><span data-stu-id="c2365-120">**Load balancers.**</span></span> <span data-ttu-id="c2365-121">Use um [Balanceador de carga para a Internet][load-balancer-external] para distribuir o tráfego de entrada da Internet para a camada da Web e um [balanceador de carga interno][load-balancer-internal] para distribuir o tráfego de rede da camada da Web para a camada comercial.</span><span class="sxs-lookup"><span data-stu-id="c2365-121">Use an [Internet-facing load balancer][load-balancer-external] to distribute incoming Internet traffic to the web tier, and an [internal load balancer][load-balancer-internal] to distribute network traffic from the web tier to the business tier.</span></span>
* <span data-ttu-id="c2365-122">**Jumpbox.**</span><span class="sxs-lookup"><span data-stu-id="c2365-122">**Jumpbox.**</span></span> <span data-ttu-id="c2365-123">Também chamada de um [host bastião].</span><span class="sxs-lookup"><span data-stu-id="c2365-123">Also called a [bastion host].</span></span> <span data-ttu-id="c2365-124">Uma VM protegida na rede que os administradores usam para se conectar às outras VMs.</span><span class="sxs-lookup"><span data-stu-id="c2365-124">A secure VM on the network that administrators use to connect to the other VMs.</span></span> <span data-ttu-id="c2365-125">O jumpbox tem um NSG que permite o tráfego remoto apenas de endereços IP públicos em uma lista segura.</span><span class="sxs-lookup"><span data-stu-id="c2365-125">The jumpbox has an NSG that allows remote traffic only from public IP addresses on a safe list.</span></span> <span data-ttu-id="c2365-126">O NSG deve permitir o tráfego de RDP (área de trabalho remota).</span><span class="sxs-lookup"><span data-stu-id="c2365-126">The NSG should permit remote desktop (RDP) traffic.</span></span>
* <span data-ttu-id="c2365-127">**Monitoramento.**</span><span class="sxs-lookup"><span data-stu-id="c2365-127">**Monitoring.**</span></span> <span data-ttu-id="c2365-128">Softwares de monitoramento, como [Nagios], [Zabbix] ou [Icinga] podem fornecer informações sobre o tempo de resposta, tempo de atividade da VM e a integridade geral do sistema.</span><span class="sxs-lookup"><span data-stu-id="c2365-128">Monitoring software such as [Nagios], [Zabbix], or [Icinga] can give you insight into response time, VM uptime, and the overall health of your system.</span></span> <span data-ttu-id="c2365-129">Instale o software de monitoramento em uma VM que se encontra em uma sub-rede separada de gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="c2365-129">Install the monitoring software on a VM that's placed in a separate management subnet.</span></span>
* <span data-ttu-id="c2365-130">**NSGs.**</span><span class="sxs-lookup"><span data-stu-id="c2365-130">**NSGs.**</span></span> <span data-ttu-id="c2365-131">Use os NSGs [grupos de segurança de rede][nsg] para restringir o tráfego de rede na VNet.</span><span class="sxs-lookup"><span data-stu-id="c2365-131">Use [network security groups][nsg] (NSGs) to restrict network traffic within the VNet.</span></span> <span data-ttu-id="c2365-132">Por exemplo, na arquitetura de três camadas mostrada aqui, a camada de banco de dados não aceita o tráfego de front-end da Web, somente da camada comercial e da sub-rede de gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="c2365-132">For example, in the 3-tier architecture shown here, the database tier does not accept traffic from the web front end, only from the business tier and the management subnet.</span></span>
* <span data-ttu-id="c2365-133">**Grupo de Disponibilidade Always On do SQL Server.**</span><span class="sxs-lookup"><span data-stu-id="c2365-133">**SQL Server Always On Availability Group.**</span></span> <span data-ttu-id="c2365-134">Fornece alta disponibilidade na camada de dados, habilitando replicação e failover.</span><span class="sxs-lookup"><span data-stu-id="c2365-134">Provides high availability at the data tier, by enabling replication and failover.</span></span>
* <span data-ttu-id="c2365-135">**Servidores AD DS (Active Directory Domain Services)**.</span><span class="sxs-lookup"><span data-stu-id="c2365-135">**Active Directory Domain Services (AD DS) Servers**.</span></span> <span data-ttu-id="c2365-136">Antes do Windows Server 2016, os Grupos de Disponibilidade Always On do SQL Server precisavam ser ingressados em um domínio.</span><span class="sxs-lookup"><span data-stu-id="c2365-136">Prior to Windows Server 2016, SQL Server Always On Availability Groups must be joined to a domain.</span></span> <span data-ttu-id="c2365-137">Isso ocorria porque os Grupos de Disponibilidade dependem da tecnologia do WSFC (Cluster de Failover do Windows Server).</span><span class="sxs-lookup"><span data-stu-id="c2365-137">This is because Availability Groups depend on Windows Server Failover Cluster (WSFC) technology.</span></span> <span data-ttu-id="c2365-138">O Windows Server 2016 introduziu a capacidade de criar um Cluster de Failover sem o Active Directory e nesse caso os servidores do AD DS não são necessários para essa arquitetura.</span><span class="sxs-lookup"><span data-stu-id="c2365-138">Windows Server 2016 introduces the ability to create a Failover Cluster without Active Directory, in which case the AD DS servers are not required for this architecture.</span></span> <span data-ttu-id="c2365-139">Para obter mais informações, consulte [Novidades no Clustering de Failover do Windows Server 2016][wsfc-whats-new].</span><span class="sxs-lookup"><span data-stu-id="c2365-139">For more information, see [What's new in Failover Clustering in Windows Server 2016][wsfc-whats-new].</span></span>

## <a name="recommendations"></a><span data-ttu-id="c2365-140">Recomendações</span><span class="sxs-lookup"><span data-stu-id="c2365-140">Recommendations</span></span>

<span data-ttu-id="c2365-141">Seus requisitos podem ser diferentes dos requisitos da arquitetura descrita aqui.</span><span class="sxs-lookup"><span data-stu-id="c2365-141">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="c2365-142">Use essas recomendações como ponto de partida.</span><span class="sxs-lookup"><span data-stu-id="c2365-142">Use these recommendations as a starting point.</span></span> 

### <a name="vnet--subnets"></a><span data-ttu-id="c2365-143">VNet / Sub-redes</span><span class="sxs-lookup"><span data-stu-id="c2365-143">VNet / Subnets</span></span>

<span data-ttu-id="c2365-144">Quando você cria a VNet, determine quantos endereços IP seus recursos em cada sub-rede exigem.</span><span class="sxs-lookup"><span data-stu-id="c2365-144">When you create the VNet, determine how many IP addresses your resources in each subnet require.</span></span> <span data-ttu-id="c2365-145">Especifique uma máscara de sub-rede e um intervalo de endereços de VNet grande o suficiente para os endereços IP necessários, usando a notação [CIDR].</span><span class="sxs-lookup"><span data-stu-id="c2365-145">Specify a subnet mask and a VNet address range large enough for the required IP addresses, using [CIDR] notation.</span></span> <span data-ttu-id="c2365-146">Use um espaço de endereço que esteja dentro dos [blocos de endereço IP privados][private-ip-space] padrão, que são 10.0.0.0/8, 172.16.0.0/12 e 192.168.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="c2365-146">Use an address space that falls within the standard [private IP address blocks][private-ip-space], which are 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16.</span></span>

<span data-ttu-id="c2365-147">Escolha um intervalo de endereços que não se sobreponha ao da rede local para caso seja necessário configurar um gateway entre a VNet e a rede local mais tarde.</span><span class="sxs-lookup"><span data-stu-id="c2365-147">Choose an address range that does not overlap with your on-premises network, in case you need to set up a gateway between the VNet and your on-premise network later.</span></span> <span data-ttu-id="c2365-148">Depois de criar a VNet, não será possível alterar o intervalo de endereços.</span><span class="sxs-lookup"><span data-stu-id="c2365-148">Once you create the VNet, you can't change the address range.</span></span>

<span data-ttu-id="c2365-149">Crie as sub-redes levando em conta os requisitos de funcionalidade e de segurança.</span><span class="sxs-lookup"><span data-stu-id="c2365-149">Design subnets with functionality and security requirements in mind.</span></span> <span data-ttu-id="c2365-150">Todas as VMs na mesma camada ou função devem ir para a mesma sub-rede, que pode ser um limite de segurança.</span><span class="sxs-lookup"><span data-stu-id="c2365-150">All VMs within the same tier or role should go into the same subnet, which can be a security boundary.</span></span> <span data-ttu-id="c2365-151">Para obter mais informações sobre como criar VNets e sub-redes, consulte [Planejar e criar redes virtuais do Azure][plan-network].</span><span class="sxs-lookup"><span data-stu-id="c2365-151">For more information about designing VNets and subnets, see [Plan and design Azure Virtual Networks][plan-network].</span></span>

<span data-ttu-id="c2365-152">Especifique o espaço de endereço para cada sub-rede em notação CIDR.</span><span class="sxs-lookup"><span data-stu-id="c2365-152">For each subnet, specify the address space for the subnet in CIDR notation.</span></span> <span data-ttu-id="c2365-153">Por exemplo, “10.0.0.0/24” cria um intervalo de 256 endereços IP.</span><span class="sxs-lookup"><span data-stu-id="c2365-153">For example, '10.0.0.0/24' creates a range of 256 IP addresses.</span></span> <span data-ttu-id="c2365-154">VMs podem usar 251 deles; cinco são reservados.</span><span class="sxs-lookup"><span data-stu-id="c2365-154">VMs can use 251 of these; five are reserved.</span></span> <span data-ttu-id="c2365-155">Verifique se que os intervalos de endereços não se sobrepõem a outras sub-redes.</span><span class="sxs-lookup"><span data-stu-id="c2365-155">Make sure the address ranges don't overlap across subnets.</span></span> <span data-ttu-id="c2365-156">Consulte as [Perguntas Frequentes sobre rede virtual][vnet faq].</span><span class="sxs-lookup"><span data-stu-id="c2365-156">See the [Virtual Network FAQ][vnet faq].</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="c2365-157">Grupos de segurança de rede</span><span class="sxs-lookup"><span data-stu-id="c2365-157">Network security groups</span></span>

<span data-ttu-id="c2365-158">Use as regras de NSG para restringir o tráfego entre as camadas.</span><span class="sxs-lookup"><span data-stu-id="c2365-158">Use NSG rules to restrict traffic between tiers.</span></span> <span data-ttu-id="c2365-159">Por exemplo, a arquitetura de três camadas mostrada acima, a camada da Web não se comunica diretamente com a camada de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-159">For example, in the 3-tier architecture shown above, the web tier does not communicate directly with the database tier.</span></span> <span data-ttu-id="c2365-160">Para impor isso, a camada de banco de dados deve bloquear o tráfego de entrada da sub-rede da camada da Web.</span><span class="sxs-lookup"><span data-stu-id="c2365-160">To enforce this, the database tier should block incoming traffic from the web tier subnet.</span></span>  

1. <span data-ttu-id="c2365-161">Crie um NSG e associe-o à sub-rede da camada de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-161">Create an NSG and associate it to the database tier subnet.</span></span>
2. <span data-ttu-id="c2365-162">Adicione uma regra que nega todo o tráfego de entrada da VNet.</span><span class="sxs-lookup"><span data-stu-id="c2365-162">Add a rule that denies all inbound traffic from the VNet.</span></span> <span data-ttu-id="c2365-163">(Use a marca `VIRTUAL_NETWORK` na regra.)</span><span class="sxs-lookup"><span data-stu-id="c2365-163">(Use the `VIRTUAL_NETWORK` tag in the rule.)</span></span> 
3. <span data-ttu-id="c2365-164">Adicione uma regra com uma prioridade mais alta que permite tráfego de entrada da sub-rede da camada comercial.</span><span class="sxs-lookup"><span data-stu-id="c2365-164">Add a rule with a higher priority that allows inbound traffic from the business tier subnet.</span></span> <span data-ttu-id="c2365-165">Essa regra substitui a regra anterior e permite que a camada comercial se comunique com a camada de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-165">This rule overrides the previous rule, and allows the business tier to talk to the database tier.</span></span>
4. <span data-ttu-id="c2365-166">Adicione uma regra para permitir o tráfego de entrada de dentro da própria sub-rede da camada de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-166">Add a rule that allows inbound traffic from within the database tier subnet itself.</span></span> <span data-ttu-id="c2365-167">Essa regra permite a comunicação entre as VMs na camada de banco de dados, que é necessária para failover e replicação de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-167">This rule allows communication between VMs in the database tier, which is needed for database replication and failover.</span></span>
5. <span data-ttu-id="c2365-168">Adicione uma regra para permitir o tráfego RDP da sub-rede de jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-168">Add a rule that allows RDP traffic from the jumpbox subnet.</span></span> <span data-ttu-id="c2365-169">Essa regra permite que os administradores se conectem à camada de banco de dados do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-169">This rule lets administrators connect to the database tier from the jumpbox.</span></span>
   
   > [!NOTE]
   > <span data-ttu-id="c2365-170">Um NSG tem regras padrão que permitem qualquer tráfego de entrada de dentro da VNet.</span><span class="sxs-lookup"><span data-stu-id="c2365-170">An NSG has default rules that allow any inbound traffic from within the VNet.</span></span> <span data-ttu-id="c2365-171">Essas regras não podem ser excluídas, mas você pode substituí-las criando regras de prioridade mais alta.</span><span class="sxs-lookup"><span data-stu-id="c2365-171">These rules can't be deleted, but you can override them by creating higher priority rules.</span></span>
   > 
   > 

### <a name="load-balancers"></a><span data-ttu-id="c2365-172">Balanceadores de carga</span><span class="sxs-lookup"><span data-stu-id="c2365-172">Load balancers</span></span>

<span data-ttu-id="c2365-173">Um balanceador externo de carga que distribui o tráfego da Internet para a camada da Web.</span><span class="sxs-lookup"><span data-stu-id="c2365-173">The external load balancer distributes Internet traffic to the web tier.</span></span> <span data-ttu-id="c2365-174">Crie um endereço IP público para esse balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="c2365-174">Create a public IP address for this load balancer.</span></span> <span data-ttu-id="c2365-175">Consulte [Criação de um balanceador de carga para a Internet][lb-external-create].</span><span class="sxs-lookup"><span data-stu-id="c2365-175">See [Creating an Internet-facing load balancer][lb-external-create].</span></span>

<span data-ttu-id="c2365-176">O balanceador de carga interno distribui o tráfego de rede da camada da Web para a camada comercial.</span><span class="sxs-lookup"><span data-stu-id="c2365-176">The internal load balancer distributes network traffic from the web tier to the business tier.</span></span> <span data-ttu-id="c2365-177">Para conceder a este balanceador de carga de um endereço IP privado, crie uma configuração de IP de front-end e associe-o à sub-rede para a camada comercial.</span><span class="sxs-lookup"><span data-stu-id="c2365-177">To give this load balancer a private IP address, create a frontend IP configuration and associate it with the subnet for the business tier.</span></span> <span data-ttu-id="c2365-178">Consulte [Introdução à criação de um balanceador de carga interno][lb-internal-create].</span><span class="sxs-lookup"><span data-stu-id="c2365-178">See [Get started creating an Internal load balancer][lb-internal-create].</span></span>

### <a name="sql-server-always-on-availability-groups"></a><span data-ttu-id="c2365-179">Grupos de Disponibilidade Always On do SQL Server</span><span class="sxs-lookup"><span data-stu-id="c2365-179">SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="c2365-180">Recomendamos usar os [Grupos de Disponibilidade Always On][sql-alwayson] para alta disponibilidade no SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c2365-180">We recommend [Always On Availability Groups][sql-alwayson] for SQL Server high availability.</span></span> <span data-ttu-id="c2365-181">Antes do Windows Server 2016, os Grupos de Disponibilidade Always On exigiam um controlador de domínio e todos os nós no grupo de disponibilidade precisavam estar no mesmo domínio do AD.</span><span class="sxs-lookup"><span data-stu-id="c2365-181">Prior to Windows Server 2016, Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same AD domain.</span></span>

<span data-ttu-id="c2365-182">Outras camadas se conectam ao banco de dados por meio de um [ouvinte do grupo de disponibilidade][sql-alwayson-listeners].</span><span class="sxs-lookup"><span data-stu-id="c2365-182">Other tiers connect to the database through an [availability group listener][sql-alwayson-listeners].</span></span> <span data-ttu-id="c2365-183">O ouvinte permite que um cliente SQL se conecte sem saber o nome da instância física do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c2365-183">The listener enables a SQL client to connect without knowing the name of the physical instance of SQL Server.</span></span> <span data-ttu-id="c2365-184">VMs que acessam o banco de dados precisam ser ingressadas no domínio.</span><span class="sxs-lookup"><span data-stu-id="c2365-184">VMs that access the database must be joined to the domain.</span></span> <span data-ttu-id="c2365-185">O cliente (neste caso, outra camada) usa o DNS para resolver o nome da rede virtual do ouvinte em endereços IP.</span><span class="sxs-lookup"><span data-stu-id="c2365-185">The client (in this case, another tier) uses DNS to resolve the listener's virtual network name into IP addresses.</span></span>

<span data-ttu-id="c2365-186">Configure um grupo de disponibilidade Always On do SQL Server da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="c2365-186">Configure the SQL Server Always On Availability Group as follows:</span></span>

1. <span data-ttu-id="c2365-187">Crie um cluster WSFC (Clustering de Failover do Windows Server), um Grupo de Disponibilidade Always On do SQL Server e uma réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c2365-187">Create a Windows Server Failover Clustering (WSFC) cluster, a SQL Server Always On Availability Group, and a primary replica.</span></span> <span data-ttu-id="c2365-188">Para obter mais informações, consulte [Introdução aos Grupos de disponibilidade Always On][sql-alwayson-getting-started].</span><span class="sxs-lookup"><span data-stu-id="c2365-188">For more information, see [Getting Started with Always On Availability Groups][sql-alwayson-getting-started].</span></span> 
2. <span data-ttu-id="c2365-189">Crie um balanceador de carga interno com um endereço IP privado estático.</span><span class="sxs-lookup"><span data-stu-id="c2365-189">Create an internal load balancer with a static private IP address.</span></span>
3. <span data-ttu-id="c2365-190">Crie um ouvinte do grupo de disponibilidade e mapeie o nome DNS do ouvinte para o endereço IP de um balanceador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="c2365-190">Create an availability group listener, and map the listener's DNS name to the IP address of an internal load balancer.</span></span> 
4. <span data-ttu-id="c2365-191">Crie uma regra do balanceador de carga para a porta de escuta do SQL Server (porta TCP 1433 por padrão).</span><span class="sxs-lookup"><span data-stu-id="c2365-191">Create a load balancer rule for the SQL Server listening port (TCP port 1433 by default).</span></span> <span data-ttu-id="c2365-192">A regra do balanceador de carga deve habilitar *IP flutuante*, também chamado de Retorno de Servidor Direto.</span><span class="sxs-lookup"><span data-stu-id="c2365-192">The load balancer rule must enable *floating IP*, also called Direct Server Return.</span></span> <span data-ttu-id="c2365-193">Isso faz com que a VM responda diretamente para o cliente, o que permite uma conexão direta com a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c2365-193">This causes the VM to reply directly to the client, which enables a direct connection to the primary replica.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="c2365-194">Quando o IP flutuante está habilitado, o número da porta de front-end deve ser igual ao número da porta de back-end na regra do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="c2365-194">When floating IP is enabled, the front-end port number must be the same as the back-end port number in the load balancer rule.</span></span>
  > 
  > 

<span data-ttu-id="c2365-195">Quando um cliente SQL tenta se conectar, o balanceador de carga roteia a solicitação de conexão para a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c2365-195">When a SQL client tries to connect, the load balancer routes the connection request to the primary replica.</span></span> <span data-ttu-id="c2365-196">Se houver um failover para outra réplica, o balanceador de carga encaminhará automaticamente as solicitações subsequentes para uma nova réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c2365-196">If there is a failover to another replica, the load balancer automatically routes subsequent requests to a new primary replica.</span></span> <span data-ttu-id="c2365-197">Para obter mais informações, consulte [Configurar um ouvinte de ILB para Grupos de Disponibilidade Always On do SQL Server][sql-alwayson-ilb].</span><span class="sxs-lookup"><span data-stu-id="c2365-197">For more information, see [Configure an ILB listener for SQL Server Always On Availability Groups][sql-alwayson-ilb].</span></span>

<span data-ttu-id="c2365-198">Durante um failover, as conexões de cliente existentes são fechadas.</span><span class="sxs-lookup"><span data-stu-id="c2365-198">During a failover, existing client connections are closed.</span></span> <span data-ttu-id="c2365-199">Após a conclusão do failover, novas conexões serão roteadas para a nova réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c2365-199">After the failover completes, new connections will be routed to the new primary replica.</span></span>

<span data-ttu-id="c2365-200">Se seu aplicativo realiza muito mais leituras do que gravações, você pode descarregar algumas das consultas somente leitura para uma réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="c2365-200">If your application makes significantly more reads than writes, you can offload some of the read-only queries to a secondary replica.</span></span> <span data-ttu-id="c2365-201">Consulte [Usar um ouvinte para se conectar a uma réplica secundária somente leitura (roteamento somente leitura)][sql-alwayson-read-only-routing].</span><span class="sxs-lookup"><span data-stu-id="c2365-201">See [Using a Listener to Connect to a Read-Only Secondary Replica (Read-Only Routing)][sql-alwayson-read-only-routing].</span></span>

<span data-ttu-id="c2365-202">Teste a implantação por [forçando um failover manual][sql-alwayson-force-failover] do grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c2365-202">Test your deployment by [forcing a manual failover][sql-alwayson-force-failover] of the availability group.</span></span>

### <a name="jumpbox"></a><span data-ttu-id="c2365-203">Jumpbox</span><span class="sxs-lookup"><span data-stu-id="c2365-203">Jumpbox</span></span>

<span data-ttu-id="c2365-204">O jumpbox terá requisitos mínimos de desempenho, portanto, selecione um tamanho de VM pequeno para o jumpbox como A1 Standard.</span><span class="sxs-lookup"><span data-stu-id="c2365-204">The jumpbox will have minimal performance requirements, so select a small VM size for the jumpbox such as Standard A1.</span></span> 

<span data-ttu-id="c2365-205">Crie um [endereço IP público] para o jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-205">Create a [public IP address] for the jumpbox.</span></span> <span data-ttu-id="c2365-206">Coloque o jumpbox na mesma VNet que as outras VMs, mas em uma sub-rede de gerenciamento separada.</span><span class="sxs-lookup"><span data-stu-id="c2365-206">Place the jumpbox in the same VNet as the other VMs, but in a separate management subnet.</span></span>

<span data-ttu-id="c2365-207">Não permita o acesso RDP da Internet pública para as VMs que executam a carga de trabalho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="c2365-207">Do not allow RDP access from the public Internet to the VMs that run the application workload.</span></span> <span data-ttu-id="c2365-208">Em vez disso, todo o acesso RDP a essas VMs deve ocorrer por meio do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-208">Instead, all RDP access to these VMs must come through the jumpbox.</span></span> <span data-ttu-id="c2365-209">Um administrador faz logon no jumpbox e, em seguida, faz logon na VM por meio do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-209">An administrator logs into the jumpbox, and then logs into the other VM from the jumpbox.</span></span> <span data-ttu-id="c2365-210">O jumpbox permite que tráfego RDP da Internet, mas apenas de endereços IP conhecidos e seguros.</span><span class="sxs-lookup"><span data-stu-id="c2365-210">The jumpbox allows RDP traffic from the Internet, but only from known, safe IP addresses.</span></span>

<span data-ttu-id="c2365-211">Para proteger o jumpbox, crie um NSG e aplique-o à sub-rede do jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-211">To secure the jumpbox, create an NSG and apply it to the jumpbox subnet.</span></span> <span data-ttu-id="c2365-212">Adicione uma regra NSG para permitir conexões RDP somente de um conjunto seguro de endereços IP públicos.</span><span class="sxs-lookup"><span data-stu-id="c2365-212">Add an NSG rule that allows RDP connections only from a safe set of public IP addresses.</span></span> <span data-ttu-id="c2365-213">O NSG pode ser conectado à sub-rede ou à NIC de jumpbox.</span><span class="sxs-lookup"><span data-stu-id="c2365-213">The NSG can be attached either to the subnet or to the jumpbox NIC.</span></span> <span data-ttu-id="c2365-214">Nesse caso, recomendamos anexá-lo à NIC para que o tráfego RDP seja permitido somente para o jumpbox, mesmo se você adicionar outras VMs à mesma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c2365-214">In this case, we recommend attaching it to the NIC, so RDP traffic is permitted only to the jumpbox, even if you add other VMs to the same subnet.</span></span>

<span data-ttu-id="c2365-215">Configure os NSGs para outras sub-redes para permitir o tráfego RDP da sub-rede de gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="c2365-215">Configure the NSGs for the other subnets to allow RDP traffic from the management subnet.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="c2365-216">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="c2365-216">Availability considerations</span></span>

<span data-ttu-id="c2365-217">Na camada de banco de dados, ter várias VMs não automaticamente significa ter um banco de dados altamente disponível.</span><span class="sxs-lookup"><span data-stu-id="c2365-217">At the database tier, having multiple VMs does not automatically translate into a highly available database.</span></span> <span data-ttu-id="c2365-218">Para um banco de dados relacional, você normalmente precisa usar a replicação e failover para obter alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c2365-218">For a relational database, you will typically need to use replication and failover to achieve high availability.</span></span> <span data-ttu-id="c2365-219">Para o SQL Server, recomendamos usar os [Grupos de Disponibilidade Always On][sql-alwayson].</span><span class="sxs-lookup"><span data-stu-id="c2365-219">For SQL Server, we recommend using [Always On Availability Groups][sql-alwayson].</span></span> 

<span data-ttu-id="c2365-220">Se você precisar de disponibilidade mais alta do que a fornecida pelo [SLA do Azure para VMs][vm-sla], replique o aplicativo em duas regiões e use o Gerenciador de Tráfego do Azure para failover.</span><span class="sxs-lookup"><span data-stu-id="c2365-220">If you need higher availability than the [Azure SLA for VMs][vm-sla] provides, replicate the application across two regions and use Azure Traffic Manager for failover.</span></span> <span data-ttu-id="c2365-221">Para obter mais informações, consulte [Executar VMs do Windows em várias regiões para ter alta disponibilidade][multi-dc].</span><span class="sxs-lookup"><span data-stu-id="c2365-221">For more information, see [Run Windows VMs in multiple regions for high availability][multi-dc].</span></span>   

## <a name="security-considerations"></a><span data-ttu-id="c2365-222">Considerações de segurança</span><span class="sxs-lookup"><span data-stu-id="c2365-222">Security considerations</span></span>

<span data-ttu-id="c2365-223">Criptografe dados confidenciais em repouso e use o [Azure Key Vault][azure-key-vault] para gerenciar as chaves de criptografia de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2365-223">Encrypt sensitive data at rest and use [Azure Key Vault][azure-key-vault] to manage the database encryption keys.</span></span> <span data-ttu-id="c2365-224">O Key Vault pode armazenar chaves de criptografia em HSMs (módulos de segurança de hardware).</span><span class="sxs-lookup"><span data-stu-id="c2365-224">Key Vault can store encryption keys in hardware security modules (HSMs).</span></span> <span data-ttu-id="c2365-225">Para obter mais informações, consulte [Configurar a integração do Azure Key Vault para o SQL Server em VMs do Azure][sql-keyvault] Também é recomendado armazenar segredos do aplicativo, como cadeias de caracteres de conexão de banco de dados, no Key Vault.</span><span class="sxs-lookup"><span data-stu-id="c2365-225">For more information, see [Configure Azure Key Vault Integration for SQL Server on Azure VMs][sql-keyvault] It's also recommended to store application secrets, such as database connection strings, in Key Vault.</span></span>

<span data-ttu-id="c2365-226">Considere adicionar uma NVA (solução de virtualização de rede) para criar uma DMZ entre a Internet e a rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="c2365-226">Consider adding a network virtual appliance (NVA) to create a DMZ between the Internet and the Azure virtual network.</span></span> <span data-ttu-id="c2365-227">NVA é um termo genérico para uma solução de virtualização que pode executar tarefas relacionadas à rede, como firewall, inspeção de pacotes, auditoria e roteamento personalizado.</span><span class="sxs-lookup"><span data-stu-id="c2365-227">NVA is a generic term for a virtual appliance that can perform network-related tasks, such as firewall, packet inspection, auditing, and custom routing.</span></span> <span data-ttu-id="c2365-228">Para obter mais informações, consulte [Implementação de uma DMZ entre o Azure e a Internet][dmz].</span><span class="sxs-lookup"><span data-stu-id="c2365-228">For more information, see [Implementing a DMZ between Azure and the Internet][dmz].</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="c2365-229">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="c2365-229">Scalability considerations</span></span>

<span data-ttu-id="c2365-230">Os balanceadores de carga distribuem o tráfego de rede para as camadas comercial e da Web.</span><span class="sxs-lookup"><span data-stu-id="c2365-230">The load balancers distribute network traffic to the web and business tiers.</span></span> <span data-ttu-id="c2365-231">Dimensione horizontalmente adicionando novas instâncias de VM.</span><span class="sxs-lookup"><span data-stu-id="c2365-231">Scale horizontally by adding new VM instances.</span></span> <span data-ttu-id="c2365-232">Observe que é possível dimensionar as camadas comercial e da Web independentemente, dependendo da carga.</span><span class="sxs-lookup"><span data-stu-id="c2365-232">Note that you can scale the web and business tiers independently, based on load.</span></span> <span data-ttu-id="c2365-233">Para reduzir possíveis complicações causadas pela necessidade de manter a afinidade do cliente, as VMs na camada da Web devem ser sem estado.</span><span class="sxs-lookup"><span data-stu-id="c2365-233">To reduce possible complications caused by the need to maintain client affinity, the VMs in the web tier should be stateless.</span></span> <span data-ttu-id="c2365-234">As VMs que hospedam a lógica de negócios também devem ser sem estado.</span><span class="sxs-lookup"><span data-stu-id="c2365-234">The VMs hosting the business logic should also be stateless.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="c2365-235">Considerações sobre capacidade de gerenciamento</span><span class="sxs-lookup"><span data-stu-id="c2365-235">Manageability considerations</span></span>

<span data-ttu-id="c2365-236">Simplifique o gerenciamento de todo o sistema usando ferramentas de administração centralizada, como [Automação do Azure][azure-administration], [Microsoft Operations Management Suite][operations-management-suite], [Chef][chef] ou [Puppet][puppet].</span><span class="sxs-lookup"><span data-stu-id="c2365-236">Simplify management of the entire system by using centralized administration tools such as [Azure Automation][azure-administration], [Microsoft Operations Management Suite][operations-management-suite], [Chef][chef], or [Puppet][puppet].</span></span> <span data-ttu-id="c2365-237">Essas ferramentas podem consolidar informações de diagnóstico e de integridade capturadas de várias VMs para fornecer uma visão geral do sistema.</span><span class="sxs-lookup"><span data-stu-id="c2365-237">These tools can consolidate diagnostic and health information captured from multiple VMs to provide an overall view of the system.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="c2365-238">Implantar a solução</span><span class="sxs-lookup"><span data-stu-id="c2365-238">Deploy the solution</span></span>

<span data-ttu-id="c2365-239">Uma implantação para essa arquitetura de referência está disponível no [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="c2365-239">A deployment for this reference architecture is available on [GitHub][github-folder].</span></span> 

### <a name="prerequisites"></a><span data-ttu-id="c2365-240">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="c2365-240">Prerequisites</span></span>

<span data-ttu-id="c2365-241">Antes de implantar a arquitetura de referência para sua própria assinatura, você deve executar as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="c2365-241">Before you can deploy the reference architecture to your own subscription, you must perform the following steps.</span></span>

1. <span data-ttu-id="c2365-242">Clone, crie fork ou baixe o arquivo zip para as [arquiteturas de referência AzureCAT][ref-arch-repo] no repositório GitHub.</span><span class="sxs-lookup"><span data-stu-id="c2365-242">Clone, fork, or download the zip file for the [AzureCAT reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="c2365-243">Verifique se a CLI do Azure 2.0 está instalada no computador.</span><span class="sxs-lookup"><span data-stu-id="c2365-243">Make sure you have the Azure CLI 2.0 installed on your computer.</span></span> <span data-ttu-id="c2365-244">Para instalar a CLI, siga as instruções em [Instalar a CLI do Azure 2.0][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="c2365-244">To install the CLI, follow the instructions in [Install Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="c2365-245">Instale os pacote npm dos [Blocos de construção do Azure][azbb].</span><span class="sxs-lookup"><span data-stu-id="c2365-245">Install the [Azure building blocks][azbb] npm package.</span></span>

  ```bash
  npm install -g @mspnp/azure-building-blocks
  ```

4. <span data-ttu-id="c2365-246">Em um prompt de comando, bash prompt ou prompt do PowerShell, faça logon na sua conta do Azure usando um dos comandos abaixo e siga os prompts.</span><span class="sxs-lookup"><span data-stu-id="c2365-246">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using one of the commands below, and follow the prompts.</span></span>

  ```bash
  az login
  ```

### <a name="deploy-the-solution-using-azbb"></a><span data-ttu-id="c2365-247">Implantar a solução usando azbb</span><span class="sxs-lookup"><span data-stu-id="c2365-247">Deploy the solution using azbb</span></span>

<span data-ttu-id="c2365-248">Para implantar as VMs do Windows para uma arquitetura de referência de aplicativo de n camada, siga essas etapas:</span><span class="sxs-lookup"><span data-stu-id="c2365-248">To deploy the Windows VMs for an N-tier application reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="c2365-249">Navegue até a pasta `virtual-machines\n-tier-windows` para o repositório que você clonou na etapa 1 dos pré-requisitos acima.</span><span class="sxs-lookup"><span data-stu-id="c2365-249">Navigate to the `virtual-machines\n-tier-windows` folder for the repository you cloned in step 1 of the pre-requisites above.</span></span>

2. <span data-ttu-id="c2365-250">O arquivo de parâmetro especifica um nome de usuário e senha de administrador padrão para cada VM na implantação.</span><span class="sxs-lookup"><span data-stu-id="c2365-250">The parameter file specifies a default adminstrator user name and password for each VM in the deployment.</span></span> <span data-ttu-id="c2365-251">Você deverá alterá-los antes de implantar a arquitetura de referência.</span><span class="sxs-lookup"><span data-stu-id="c2365-251">You must change these before you deploy the reference architecture.</span></span> <span data-ttu-id="c2365-252">Abra o arquivo `n-tier-windows.json` e substitua cada campo **adminUsername** e **adminPassword** com suas novas configurações.</span><span class="sxs-lookup"><span data-stu-id="c2365-252">Open the `n-tier-windows.json` file and replace each **adminUsername** and **adminPassword** field with your new settings.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="c2365-253">Há vários scripts que são executados durante essa implantação tanto nos objetos **VirtualMachineExtension** quanto nas configurações de **extensões** para alguns dos objetos **VirtualMachine**.</span><span class="sxs-lookup"><span data-stu-id="c2365-253">There are multiple scripts that run during this deployment both in the  **VirtualMachineExtension** objects and in the **extensions** settings for some of the **VirtualMachine** objects.</span></span> <span data-ttu-id="c2365-254">Alguns desses scripts requerem o nome de usuário e a senha do administrador que você acabou de alterar.</span><span class="sxs-lookup"><span data-stu-id="c2365-254">Some of these scripts require the administrator user name and password that you have just changed.</span></span> <span data-ttu-id="c2365-255">É recomendável revisar esses scripts para garantir que você especificou as credenciais corretas.</span><span class="sxs-lookup"><span data-stu-id="c2365-255">It's recommended that you review these scripts to ensure that you specified the correct credentials.</span></span> <span data-ttu-id="c2365-256">A implantação poderá falhar se você não especificou as credenciais corretas.</span><span class="sxs-lookup"><span data-stu-id="c2365-256">The deployment may fail if you have not specified the correct credentials.</span></span>
  > 
  > 

<span data-ttu-id="c2365-257">Salve o arquivo.</span><span class="sxs-lookup"><span data-stu-id="c2365-257">Save the file.</span></span>

3. <span data-ttu-id="c2365-258">Implante a arquitetura de referência usando a ferramenta de linha de comando **azbb** conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="c2365-258">Deploy the reference architecture using the **azbb** command line tool as shown below.</span></span>

  ```bash
  azbb -s <your subscription_id> -g <your resource_group_name> -l <azure region> -p n-tier-windows.json --deploy
  ```

<span data-ttu-id="c2365-259">Para obter mais informações sobre a implantação dessa arquitetura de referência de exemplo utilizando blocos de construção Blocos de Construção do Azure, visite o repositório [GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="c2365-259">For more information on deploying this sample reference architecture using Azure Building Blocks, visit the [GitHub repository][git].</span></span>


<!-- links -->
[dmz]: ../dmz/secure-vnet-dmz.md
[multi-dc]: multi-region-application.md
[multi-vm]: multi-vm.md
[n-tier]: n-tier.md
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[azure-administration]: /azure/automation/automation-intro
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-windows-manage-availability#configure-each-application-tier-into-separate-availability-sets
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-cli-2]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest
[azure-key-vault]: https://azure.microsoft.com/services/key-vault
[host bastião]: https://en.wikipedia.org/wiki/Bastion_host
[cidr]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[chef]: https://www.chef.io/solutions/azure/
[git]: https://github.com/mspnp/template-building-blocks
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-windows
[lb-external-create]: /azure/load-balancer/load-balancer-get-started-internet-portal
[lb-internal-create]: /azure/load-balancer/load-balancer-get-started-ilb-arm-portal
[load-balancer-external]: /azure/load-balancer/load-balancer-internet-overview
[load-balancer-internal]: /azure/load-balancer/load-balancer-internal-overview
[nsg]: /azure/virtual-network/virtual-networks-nsg
[operations-management-suite]: https://www.microsoft.com/server-cloud/operations-management-suite/overview.aspx
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[endereço IP público]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[puppet]: https://puppetlabs.com/blog/managing-azure-virtual-machines-puppet
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[sql-alwayson]: https://msdn.microsoft.com/library/hh510230.aspx
[sql-alwayson-force-failover]: https://msdn.microsoft.com/library/ff877957.aspx
[sql-alwayson-getting-started]: https://msdn.microsoft.com/library/gg509118.aspx
[sql-alwayson-ilb]: /azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener
[sql-alwayson-listeners]: https://msdn.microsoft.com/library/hh213417.aspx
[sql-alwayson-read-only-routing]: https://technet.microsoft.com/library/hh213417.aspx#ConnectToSecondary
[sql-keyvault]: /azure/virtual-machines/virtual-machines-windows-ps-sql-keyvault
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vnet faq]: /azure/virtual-network/virtual-networks-faq
[wsfc-whats-new]: https://technet.microsoft.com/windows-server-docs/failover-clustering/whats-new-in-failover-clustering
[Nagios]: https://www.nagios.org/
[Zabbix]: http://www.zabbix.com/
[Icinga]: http://www.icinga.org/
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[0]: ./images/n-tier-diagram.png "Arquitetura de N camadas usando o Microsoft Azure"
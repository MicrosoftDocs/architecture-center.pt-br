---
title: Diretrizes gerais de repetição
titleSuffix: Best practices for cloud applications
description: Orientações sobre repetição no tratamento de falhas transitórias.
author: dragon119
ms.date: 07/13/2016
ms.custom: seodec18
ms.openlocfilehash: 00ea1e21bcef2c3de271bec8aebb4a3cb482f57f
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011813"
---
# <a name="transient-fault-handling"></a><span data-ttu-id="a29fb-103">Tratamento de falhas transitórias</span><span class="sxs-lookup"><span data-stu-id="a29fb-103">Transient fault handling</span></span>

<span data-ttu-id="a29fb-104">Todos os aplicativos que se comunicam com serviços e recursos remotos são suscetíveis a falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-104">All applications that communicate with remote services and resources must be sensitive to transient faults.</span></span> <span data-ttu-id="a29fb-105">Especificamente, esse é o caso de aplicativos que são executados na nuvem, onde a natureza do ambiente e da conectividade pela Internet significam que esses tipos de falha provavelmente podem ser encontrados com mais frequência.</span><span class="sxs-lookup"><span data-stu-id="a29fb-105">This is especially the case for applications that run in the cloud, where the nature of the environment and connectivity over the Internet means these types of faults are likely to be encountered more often.</span></span> <span data-ttu-id="a29fb-106">As falhas transitórias incluem a perda momentânea da conectividade de rede com componentes e serviços, a indisponibilidade temporária de um serviço ou tempos limite que surgem quando um serviço está ocupado.</span><span class="sxs-lookup"><span data-stu-id="a29fb-106">Transient faults include the momentary loss of network connectivity to components and services, the temporary unavailability of a service, or timeouts that arise when a service is busy.</span></span> <span data-ttu-id="a29fb-107">Essas falhas geralmente são autocorretivas e, se a ação for repetida após um tempo razoável, é provável que seja bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="a29fb-107">These faults are often self-correcting, and if the action is repeated after a suitable delay it is likely succeed.</span></span>

<span data-ttu-id="a29fb-108">Este documento aborda as diretrizes gerais para lidar com falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-108">This document covers general guidance for transient fault handling.</span></span> <span data-ttu-id="a29fb-109">Para obter informações sobre como lidar com falhas transitórias ao usar os serviços do Microsoft Azure, consulte [Diretrizes para repetição específica de serviços do Azure](./retry-service-specific.md).</span><span class="sxs-lookup"><span data-stu-id="a29fb-109">For information about handling transient faults when using Microsoft Azure services, see [Azure service-specific retry guidelines](./retry-service-specific.md).</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="why-do-transient-faults-occur-in-the-cloud"></a><span data-ttu-id="a29fb-110">Por que ocorrem falhas transitórias na nuvem?</span><span class="sxs-lookup"><span data-stu-id="a29fb-110">Why do transient faults occur in the cloud?</span></span>

<!-- markdownlint-enable MD026 -->

<span data-ttu-id="a29fb-111">As falhas transitórias podem ocorrer em qualquer ambiente, em qualquer plataforma ou sistema operacional e em qualquer tipo de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-111">Transient faults can occur in any environment, on any platform or operating system, and in any kind of application.</span></span> <span data-ttu-id="a29fb-112">Em soluções que são executadas na infraestrutura local, o desempenho e a disponibilidade do aplicativo e seus componentes geralmente são mantidos por meio de redundância de hardware muitas vezes subutilizada e cara, e os componentes e recursos são localizados próximos um do outro.</span><span class="sxs-lookup"><span data-stu-id="a29fb-112">In solutions that run on local, on-premises infrastructure, performance and availability of the application and its components is typically maintained through expensive and often under-used hardware redundancy, and components and resources are located close to each another.</span></span> <span data-ttu-id="a29fb-113">Embora isso torne uma falha menos provável, isso ainda pode resultar em falhas transitórias e, até mesmo, em uma interrupção por meio de eventos inesperados, como problemas externos de rede e fonte de energia, ou outros cenários de desastre.</span><span class="sxs-lookup"><span data-stu-id="a29fb-113">While this makes a failure less likely, it can still result in transient faults - and even an outage through unforeseen events such as external power supply or network issues, or other disaster scenarios.</span></span>

<span data-ttu-id="a29fb-114">A hospedagem da nuvem, incluindo sistemas de nuvem privada, pode oferecer uma disponibilidade geral mais alta usando recursos compartilhados, redundância, failover automático e alocação dinâmica de recursos em um grande número de nós de computação primários.</span><span class="sxs-lookup"><span data-stu-id="a29fb-114">Cloud hosting, including private cloud systems, can offer a higher overall availability by using shared resources, redundancy, automatic failover, and dynamic resource allocation across a huge number of commodity compute nodes.</span></span> <span data-ttu-id="a29fb-115">No entanto, a natureza desses ambientes pode significar que falhas transitórias têm mais probabilidade de ocorrer.</span><span class="sxs-lookup"><span data-stu-id="a29fb-115">However, the nature of these environments can mean that transient faults are more likely to occur.</span></span> <span data-ttu-id="a29fb-116">Há vários motivos para isso:</span><span class="sxs-lookup"><span data-stu-id="a29fb-116">There are several reasons for this:</span></span>

- <span data-ttu-id="a29fb-117">Muitos recursos em um ambiente de nuvem são compartilhados e o acesso a eles está sujeito à limitação para proteger o recurso.</span><span class="sxs-lookup"><span data-stu-id="a29fb-117">Many resources in a cloud environment are shared, and access to these resources is subject to throttling in order to protect the resource.</span></span> <span data-ttu-id="a29fb-118">Alguns serviços recusarão conexões quando a carga subir para um nível específico, ou uma taxa de transferência máxima for atingida, para permitir o processamento de solicitações existentes e manter o desempenho do serviço para todos os usuários.</span><span class="sxs-lookup"><span data-stu-id="a29fb-118">Some services will refuse connections when the load rises to a specific level, or a maximum throughput rate is reached, in order to allow processing of existing requests and to maintain performance of the service for all users.</span></span> <span data-ttu-id="a29fb-119">A limitação ajuda a manter a qualidade do serviço para vizinhos e outros locatários que estão usando o recurso compartilhado.</span><span class="sxs-lookup"><span data-stu-id="a29fb-119">Throttling helps to maintain the quality of service for neighbors and other tenants using the shared resource.</span></span>

- <span data-ttu-id="a29fb-120">Os ambientes de nuvem são criados usando grandes números de unidades de hardware primárias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-120">Cloud environments are built using vast numbers of commodity hardware units.</span></span> <span data-ttu-id="a29fb-121">Eles proporcionam desempenho distribuindo dinamicamente a carga por várias unidades de computação e componentes de infraestrutura, bem como oferecem confiabilidade reciclando ou substituindo automaticamente as unidades com falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-121">They deliver performance by dynamically distributing the load across multiple computing units and infrastructure components, and deliver reliability by automatically recycling or replacing failed units.</span></span> <span data-ttu-id="a29fb-122">Essa natureza dinâmica significa que falhas transitórias e de conexão temporária podem ocorrer ocasionalmente.</span><span class="sxs-lookup"><span data-stu-id="a29fb-122">This dynamic nature means that transient faults and temporary connection failures may occasionally occur.</span></span>

- <span data-ttu-id="a29fb-123">Muitas vezes, há mais componentes de hardware, incluindo estrutura de rede, como roteadores e balanceadores de carga, entre o aplicativo e os recursos e serviços que ele usa.</span><span class="sxs-lookup"><span data-stu-id="a29fb-123">There are often more hardware components, including network infrastructure such as routers and load balancers, between the application and the resources and services it uses.</span></span> <span data-ttu-id="a29fb-124">Essa infraestrutura adicional pode, ocasionalmente, introduzir latência de conexão adicional e falhas de conexão transitórias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-124">This additional infrastructure can occasionally introduce additional connection latency and transient connection faults.</span></span>

- <span data-ttu-id="a29fb-125">As condições de rede entre o cliente e o servidor podem ser variáveis, especialmente quando a comunicação atravessa a Internet.</span><span class="sxs-lookup"><span data-stu-id="a29fb-125">Network conditions between the client and the server may be variable, especially when communication crosses the Internet.</span></span> <span data-ttu-id="a29fb-126">Mesmo em pontos locais, as cargas de tráfego muito pesadas podem atrasar a comunicação e causar falhas de conexão intermitentes.</span><span class="sxs-lookup"><span data-stu-id="a29fb-126">Even in on-premises locations, very heavy traffic loads may slow communication and cause intermittent connection failures.</span></span>

## <a name="challenges"></a><span data-ttu-id="a29fb-127">Desafios</span><span class="sxs-lookup"><span data-stu-id="a29fb-127">Challenges</span></span>

<span data-ttu-id="a29fb-128">As falhas transitórias podem ter um enorme impacto na disponibilidade percebida de um aplicativo, mesmo que ele tenha sido integralmente testado sob todas as circunstâncias previsíveis.</span><span class="sxs-lookup"><span data-stu-id="a29fb-128">Transient faults can have a huge impact on the perceived availability of an application, even if it has been thoroughly tested under all foreseeable circumstances.</span></span> <span data-ttu-id="a29fb-129">Para garantir que aplicativos hospedados na nuvem operem de forma confiável, eles devem ser capazes de responder aos seguintes desafios:</span><span class="sxs-lookup"><span data-stu-id="a29fb-129">To ensure that cloud-hosted applications operate reliably, they must be able to respond to the following challenges:</span></span>

- <span data-ttu-id="a29fb-130">O aplicativo deve ser capaz de detectar falhas quando elas ocorrerem e determinar se essas falhas têm probabilidade de serem transitórias, de duração mais longa ou falhas de terminal.</span><span class="sxs-lookup"><span data-stu-id="a29fb-130">The application must be able to detect faults when they occur, and determine if these faults are likely to be transient, more long-lasting, or are terminal failures.</span></span> <span data-ttu-id="a29fb-131">Diferentes recursos têm mais probabilidade de retornar respostas diferentes quando uma falha ocorre, e essas respostas também podem variar de acordo com o contexto da operação; por exemplo, a resposta de um erro ao ler no armazenamento pode ser diferente da resposta de um erro ao gravar no armazenamento.</span><span class="sxs-lookup"><span data-stu-id="a29fb-131">Different resources are likely to return different responses when a fault occurs, and these responses may also vary depending on the context of the operation; for example, the response for an error when reading from storage may be different from response for an error when writing to storage.</span></span> <span data-ttu-id="a29fb-132">Muitos recursos e serviços têm contratos de falha transitória bem documentados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-132">Many resources and services have well-documented transient failure contracts.</span></span> <span data-ttu-id="a29fb-133">No entanto, quando essas informações não estão disponíveis, pode ser difícil descobrir a natureza da falha e se há probabilidade de que ela seja transitória.</span><span class="sxs-lookup"><span data-stu-id="a29fb-133">However, where such information is not available, it may be difficult to discover the nature of the fault and whether it is likely to be transient.</span></span>

- <span data-ttu-id="a29fb-134">O aplicativo deve poder repetir a operação se determinar que a falha pode ser transitória e acompanhar o número de vezes que a operação foi repetida.</span><span class="sxs-lookup"><span data-stu-id="a29fb-134">The application must be able to retry the operation if it determines that the fault is likely to be transient and keep track of the number of times the operation was retried.</span></span>

- <span data-ttu-id="a29fb-135">O aplicativo deve usar uma estratégia apropriada para as repetições.</span><span class="sxs-lookup"><span data-stu-id="a29fb-135">The application must use an appropriate strategy for the retries.</span></span> <span data-ttu-id="a29fb-136">Essa estratégia especifica o número de vezes que ele deve tentar novamente, o intervalo entre cada tentativa e as ações a serem executadas após cada tentativa que falhar.</span><span class="sxs-lookup"><span data-stu-id="a29fb-136">This strategy specifies the number of times it should retry, the delay between each attempt, and the actions to take after a failed attempt.</span></span> <span data-ttu-id="a29fb-137">O número apropriado de tentativas e o intervalo entre cada uma delas costumam ser difíceis de determinar e variam de acordo com o tipo de recurso, bem como das condições operacionais do recurso e do próprio aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-137">The appropriate number of attempts and the delay between each one are often difficult to determine, and vary based on the type of resource as well as the current operating conditions of the resource and the application itself.</span></span>

## <a name="general-guidelines"></a><span data-ttu-id="a29fb-138">Diretrizes gerais</span><span class="sxs-lookup"><span data-stu-id="a29fb-138">General guidelines</span></span>

<span data-ttu-id="a29fb-139">As diretrizes a seguir ajudarão você a projetar um mecanismo adequado para tratamento de falha transitória de seus aplicativos:</span><span class="sxs-lookup"><span data-stu-id="a29fb-139">The following guidelines will help you to design a suitable transient fault handing mechanism for your applications:</span></span>

- <span data-ttu-id="a29fb-140">**Determine se há um mecanismo interno de repetição:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-140">**Determine if there is a built-in retry mechanism:**</span></span>

  - <span data-ttu-id="a29fb-141">Muitos serviços fornecem uma biblioteca de cliente ou um SDK que contém um mecanismo de tratamento para falha transitória.</span><span class="sxs-lookup"><span data-stu-id="a29fb-141">Many services provide an SDK or client library that contains a transient fault handling mechanism.</span></span> <span data-ttu-id="a29fb-142">A política de repetição usada por ele geralmente é personalizado para a natureza e os requisitos do serviço de destino.</span><span class="sxs-lookup"><span data-stu-id="a29fb-142">The retry policy it uses is typically tailored to the nature and requirements of the target service.</span></span> <span data-ttu-id="a29fb-143">Como alternativa, as interfaces REST para serviços podem retornar informações que são úteis para determinar se uma repetição é apropriada e quanto tempo esperar antes da próxima tentativa de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-143">Alternatively, REST interfaces for services may return information that is useful in determining whether a retry is appropriate, and how long to wait before the next retry attempt.</span></span>

  - <span data-ttu-id="a29fb-144">Use o mecanismo interno de repetição onde houver um disponível, a menos que haja requisitos específicos e bem entendidos que significam que um comportamento de repetição diferente é mais adequado.</span><span class="sxs-lookup"><span data-stu-id="a29fb-144">Use the built-in retry mechanism where one is available unless you have specific and well-understood requirements that mean a different retry behavior is more appropriate.</span></span>

- <span data-ttu-id="a29fb-145">**Determine se a operação é adequada para repetição**:</span><span class="sxs-lookup"><span data-stu-id="a29fb-145">**Determine if the operation is suitable for retrying**:</span></span>

  - <span data-ttu-id="a29fb-146">Você deve repetir a operação apenas onde as falhas forem transitórias (geralmente indicadas pela natureza do erro) e se houver, pelo menos, alguma probabilidade de que a operação seja bem-sucedida na nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="a29fb-146">You should only retry operations where the faults are transient (typically indicated by the nature of the error), and if there is at least some likelihood that the operation will succeed when reattempted.</span></span> <span data-ttu-id="a29fb-147">Não faz sentido repetir operações que indicam uma operação inválida, como atualização de um banco de dados para um item que não existe, ou solicitações para um serviço ou recurso que sofreu um erro fatal.</span><span class="sxs-lookup"><span data-stu-id="a29fb-147">There is no point in reattempting operations that indicate an invalid operation such as a database update to an item that does not exist, or requests to a service or resource that has suffered a fatal error</span></span>

  - <span data-ttu-id="a29fb-148">Em geral, você deve implementar novas tentativas apenas onde o impacto total disso puder ser determinado, e as condições forem bem entendidas e puderem ser validadas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-148">In general, you should implement retries only where the full impact of this can be determined, and the conditions are well understood and can be validated.</span></span> <span data-ttu-id="a29fb-149">Caso contrário, deixe que o código de chamada implemente as novas tentativas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-149">If not, leave it to the calling code to implement retries.</span></span> <span data-ttu-id="a29fb-150">Lembre-se de que os erros retornados de recursos e serviços fora do seu controle podem evoluir ao longo do tempo, e talvez seja necessário rever sua lógica de detecção de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-150">Remember that the errors returned from resources and services outside your control may evolve over time, and you may need to revisit your transient fault detection logic.</span></span>

  - <span data-ttu-id="a29fb-151">Ao criar serviços ou componentes, considere a implementação de mensagens e códigos de erro que ajudarão os clientes a determinar se devem repetir as operações com falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-151">When you create services or components, consider implementing error codes and messages that will help clients determine whether they should retry failed operations.</span></span> <span data-ttu-id="a29fb-152">Em particular, indique se o cliente deve repetir a operação (talvez retornando um valor **isTransient** ) e sugira um intervalo adequado antes da próxima tentativa de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-152">In particular, indicate if the client should retry the operation (perhaps by returning an **isTransient** value) and suggest a suitable delay before the next retry attempt.</span></span> <span data-ttu-id="a29fb-153">Se você criar um serviço Web, considere retornar erros personalizados definidos em seus contratos de serviço.</span><span class="sxs-lookup"><span data-stu-id="a29fb-153">If you build a web service, consider returning custom errors defined within your service contracts.</span></span> <span data-ttu-id="a29fb-154">Mesmo que os clientes genéricos não possam lê-los, eles serão úteis na criação de clientes personalizados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-154">Even though generic clients may not be able to read these, they will be useful when building custom clients.</span></span>

- <span data-ttu-id="a29fb-155">**Determine uma contagem de repetições e intervalo apropriados:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-155">**Determine an appropriate retry count and interval:**</span></span>

  - <span data-ttu-id="a29fb-156">É fundamental otimizar a contagem de repetições e o intervalo para o tipo de caso de uso.</span><span class="sxs-lookup"><span data-stu-id="a29fb-156">It is vital to optimize the retry count and the interval to the type of use case.</span></span> <span data-ttu-id="a29fb-157">Se você não repetir um número de vezes suficiente, o aplicativo não poderá concluir a operação e, provavelmente, apresentar uma falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-157">If you do not retry a sufficient number of times, the application will be unable to complete the operation and is likely to experience a failure.</span></span> <span data-ttu-id="a29fb-158">Se você repetir muitas vezes, ou com um intervalo muito curto entre as tentativas, há grandes chances de que o aplicativo retenha recursos como threads, conexões e memória por longos períodos, o que afetará negativamente a integridade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-158">If you retry too many times, or with too short an interval between tries, the application can potentially hold resources such as threads, connections, and memory for long periods, which will adversely affect the health of the application.</span></span>

  - <span data-ttu-id="a29fb-159">Os valores apropriados para o intervalo de tempo e o número de tentativas de repetição dependem do tipo de operação que está sendo tentada.</span><span class="sxs-lookup"><span data-stu-id="a29fb-159">The appropriate values for the time interval and the number of retry attempts depend on the type of operation being attempted.</span></span> <span data-ttu-id="a29fb-160">Por exemplo, se a operação fizer parte de uma interação do usuário, o intervalo deverá ser curto e apenas algumas tentativas deverão ser feitas a fim de evitar que os usuários tenham que esperar por uma resposta (o que retém conexões abertas e pode reduzir a disponibilidade para outros usuários).</span><span class="sxs-lookup"><span data-stu-id="a29fb-160">For example, if the operation is part of a user interaction, the interval should be short and only a few retries attempted to avoid making users wait for a response (which holds open connections and can reduce availability for other users).</span></span> <span data-ttu-id="a29fb-161">Se a operação fizer parte de um fluxo de trabalho de execução longa ou crítico, onde cancelar e reiniciar o processo seja caro ou demorado, é apropriado aguardar mais tempo entre as tentativas e repetir mais vezes.</span><span class="sxs-lookup"><span data-stu-id="a29fb-161">If the operation is part of a long running or critical workflow, where cancelling and restarting the process is expensive or time-consuming, it is appropriate to wait longer between attempts and retry more times.</span></span>

  - <span data-ttu-id="a29fb-162">Determinar os intervalos apropriados entre repetições é a parte mais difícil na criação de uma estratégia bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="a29fb-162">Determining the appropriate intervals between retries is the most difficult part of designing a successful strategy.</span></span> <span data-ttu-id="a29fb-163">As estratégias comuns usam os seguintes tipos de intervalo de repetição:</span><span class="sxs-lookup"><span data-stu-id="a29fb-163">Typical strategies use the following types of retry interval:</span></span>

    - <span data-ttu-id="a29fb-164">**Retirada exponencial**.</span><span class="sxs-lookup"><span data-stu-id="a29fb-164">**Exponential back-off**.</span></span> <span data-ttu-id="a29fb-165">O aplicativo aguarda pouco tempo antes da primeira repetição e depois os tempos aumentam exponencialmente entre as repetições subsequentes.</span><span class="sxs-lookup"><span data-stu-id="a29fb-165">The application waits a short time before the first retry, and then exponentially increasing times between each subsequent retry.</span></span> <span data-ttu-id="a29fb-166">Por exemplo, ele pode repetir a operação depois de 3 segundos, 12 segundos, 30 segundos e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="a29fb-166">For example, it may retry the operation after 3 seconds, 12 seconds, 30 seconds, and so on.</span></span>

    - <span data-ttu-id="a29fb-167">**Intervalos incrementais**.</span><span class="sxs-lookup"><span data-stu-id="a29fb-167">**Incremental intervals**.</span></span> <span data-ttu-id="a29fb-168">O aplicativo aguarda pouco tempo antes da primeira repetição e depois os tempos aumentam de modo incremental entre as repetições subsequentes.</span><span class="sxs-lookup"><span data-stu-id="a29fb-168">The application waits a short time before the first retry, and then incrementally increasing times between each subsequent retry.</span></span> <span data-ttu-id="a29fb-169">Por exemplo, ele pode repetir a operação depois de 3 segundos, 7 segundos, 13 segundos e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="a29fb-169">For example, it may retry the operation after 3 seconds, 7 seconds, 13 seconds, and so on.</span></span>

    - <span data-ttu-id="a29fb-170">**Intervalos regulares**.</span><span class="sxs-lookup"><span data-stu-id="a29fb-170">**Regular intervals**.</span></span> <span data-ttu-id="a29fb-171">O aplicativo aguarda o mesmo período entre cada tentativa.</span><span class="sxs-lookup"><span data-stu-id="a29fb-171">The application waits for the same period of time between each attempt.</span></span> <span data-ttu-id="a29fb-172">Por exemplo, ele pode repetir a operação a cada 3 segundos.</span><span class="sxs-lookup"><span data-stu-id="a29fb-172">For example, it may retry the operation every 3 seconds.</span></span>

    - <span data-ttu-id="a29fb-173">**Repetição imediata**.</span><span class="sxs-lookup"><span data-stu-id="a29fb-173">**Immediate retry**.</span></span> <span data-ttu-id="a29fb-174">Às vezes, uma falha transitória é extremamente curta, talvez devido a um evento, como uma colisão de pacote de rede ou um pico em um componente de hardware.</span><span class="sxs-lookup"><span data-stu-id="a29fb-174">Sometimes a transient fault is extremely short, perhaps caused by an event such as a network packet collision or a spike in a hardware component.</span></span> <span data-ttu-id="a29fb-175">Neste caso, repetir a operação imediatamente é apropriado, pois ela poderá ser bem-sucedida se a falha for removida no tempo que leva para o aplicativo montar e enviar a próxima solicitação.</span><span class="sxs-lookup"><span data-stu-id="a29fb-175">In this case, retrying the operation immediately is appropriate because it may succeed if the fault has cleared in the time it takes the application to assemble and send the next request.</span></span> <span data-ttu-id="a29fb-176">No entanto, nunca deverá haver mais de uma tentativa de repetição imediata, e você deverá tentar estratégias alternativas, como retirada exponencial ou ações de fallback, caso a repetição imediata falhe.</span><span class="sxs-lookup"><span data-stu-id="a29fb-176">However, there should never be more than one immediate retry attempt, and you should switch to alternative strategies, such as such as exponential back-off or fallback actions, if the immediate retry fails.</span></span>

    - <span data-ttu-id="a29fb-177">**Aleatoriedade**.</span><span class="sxs-lookup"><span data-stu-id="a29fb-177">**Randomization**.</span></span> <span data-ttu-id="a29fb-178">Qualquer uma das estratégias de repetição listadas acima pode incluir uma aleatoriedade para impedir que várias instâncias do cliente enviem tentativas de repetição subsequentes ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-178">Any of the retry strategies listed above may include a randomization to prevent multiple instances of the client sending subsequent retry attempts at the same time.</span></span> <span data-ttu-id="a29fb-179">Por exemplo, uma instância pode repetir a operação após 3 segundos, 11 segundos, 28 segundos e assim por diante, enquanto outra instância pode repetir a operação após 4 segundos, 12 segundos, 26 segundos e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="a29fb-179">For example, one instance may retry the operation after 3 seconds, 11 seconds, 28 seconds, and so on while another instance may retry the operation after 4 seconds, 12 seconds, 26 seconds, and so on.</span></span> <span data-ttu-id="a29fb-180">A aleatoriedade é uma técnica útil que pode ser combinada com outras estratégias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-180">Randomization is a useful technique that may be combined with other strategies.</span></span>

  - <span data-ttu-id="a29fb-181">Como regra geral, use uma estratégia de retirada exponencial para operações em segundo plano, bem como estratégias de repetição de intervalo regular ou imediato para operações interativas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-181">As a general guideline, use an exponential back-off strategy for background operations, and immediate or regular interval retry strategies for interactive operations.</span></span> <span data-ttu-id="a29fb-182">Em ambos os casos, você deve escolher o intervalo e a contagem de repetições para que a latência máxima de todas as tentativas de repetição esteja dentro do requisito obrigatório de latência de ponta a ponta.</span><span class="sxs-lookup"><span data-stu-id="a29fb-182">In both cases, you should choose the delay and the retry count so that the maximum latency for all retry attempts is within the required end-to-end latency requirement.</span></span>

  - <span data-ttu-id="a29fb-183">Leve em consideração a combinação de todos os fatores que contribuem para o tempo limite geral máximo de uma operação repetida.</span><span class="sxs-lookup"><span data-stu-id="a29fb-183">Take into account the combination of all the factors that contribute to the overall maximum timeout for a retried operation.</span></span> <span data-ttu-id="a29fb-184">Esses fatores incluem o tempo necessário para que uma conexão com falha gere uma resposta (normalmente definido por um valor de tempo limite do cliente), bem como o intervalo entre tentativas de repetição e o número máximo de repetições.</span><span class="sxs-lookup"><span data-stu-id="a29fb-184">These factors include the time taken for a failed connection to produce a response (typically set by a timeout value in the client) as well as the delay between retry attempts and the maximum number of retries.</span></span> <span data-ttu-id="a29fb-185">O total de todos esses tempos pode resultar em um número de vezes de operação bem alto, especialmente ao usar uma estratégia de intervalo exponencial onde o intervalo entre repetições aumenta rapidamente após cada falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-185">The total of all these times can result in very large overall operation times, especially when using an exponential delay strategy where the interval between retries grows rapidly after each failure.</span></span> <span data-ttu-id="a29fb-186">Se um processo deve atender a um SLA (contrato de nível de serviço) específico, o tempo de operação geral, incluindo todos os tempos limite e intervalos, deverá estar dentro do que foi definido no SLA.</span><span class="sxs-lookup"><span data-stu-id="a29fb-186">If a process must meet a specific service level agreement (SLA), the overall operation time, including all timeouts and delays, must be within that defined in the SLA.</span></span>

  - <span data-ttu-id="a29fb-187">Estratégias de repetição superagressivas, que têm intervalos muito curtos ou muitas repetições, podem ter um efeito negativo no recurso ou serviço de destino.</span><span class="sxs-lookup"><span data-stu-id="a29fb-187">Over-aggressive retry strategies, which have too short intervals or too many retries, can have an adverse effect on the target resource or service.</span></span> <span data-ttu-id="a29fb-188">Isso pode impedir que o recurso ou serviço se recupere de seu estado sobrecarregado, e ele continuará bloqueando ou recusando solicitações.</span><span class="sxs-lookup"><span data-stu-id="a29fb-188">This may prevent the resource or service from recovering from its overloaded state, and it will continue to block or refuse requests.</span></span> <span data-ttu-id="a29fb-189">Isso resulta em um círculo vicioso onde cada vez mais solicitações são enviadas para o recurso ou serviço e, consequentemente, sua capacidade de recuperação é ainda mais reduzida.</span><span class="sxs-lookup"><span data-stu-id="a29fb-189">This results in a vicious circle where more and more requests are sent to the resource or service, and consequently its ability to recover is further reduced.</span></span>

  - <span data-ttu-id="a29fb-190">Leve em conta o tempo limite das operações ao escolher os intervalos de repetição para evitar iniciar uma tentativa subsequente imediatamente (por exemplo, se o período de tempo limite for semelhante ao intervalo de repetição).</span><span class="sxs-lookup"><span data-stu-id="a29fb-190">Take into account the timeout of the operations when choosing the retry intervals to avoid launching a subsequent attempt immediately (for example, if the timeout period is similar to the retry interval).</span></span> <span data-ttu-id="a29fb-191">Além disso, considere se você precisa manter o período possível total (o tempo limite mais os intervalos de repetição) abaixo de um tempo total específico.</span><span class="sxs-lookup"><span data-stu-id="a29fb-191">Also consider if you need to keep the total possible period (the timeout plus the retry intervals) to below a specific total time.</span></span> <span data-ttu-id="a29fb-192">As operações com tempos limite extraordinariamente curtos ou muito longos podem influenciar o tempo de espera e quantas vezes repetir a operação.</span><span class="sxs-lookup"><span data-stu-id="a29fb-192">Operations that have unusually short or very long timeouts may influence how long to wait, and how often to retry the operation.</span></span>

  - <span data-ttu-id="a29fb-193">Use o tipo da exceção e quaisquer dados que ele contenha, ou os códigos e mensagens de erro retornados do serviço, para otimizar o intervalo e o número de repetições.</span><span class="sxs-lookup"><span data-stu-id="a29fb-193">Use the type of the exception and any data it contains, or the error codes and messages returned from the service, to optimize the interval and the number of retries.</span></span> <span data-ttu-id="a29fb-194">Por exemplo, alguns códigos de erro ou exceções (como o código HTTP 503 Serviço Indisponível com um cabeçalho Repetir Após na resposta) podem indicar quanto tempo o erro pode durar ou que o serviço falhou e não responderá a nenhuma tentativa subsequente.</span><span class="sxs-lookup"><span data-stu-id="a29fb-194">For example, some exceptions or error codes (such as the HTTP code 503 Service Unavailable with a Retry-After header in the response) may indicate how long the error might last, or that the service has failed and will not respond to any subsequent attempt.</span></span>

- <span data-ttu-id="a29fb-195">**Evite antipadrões**:</span><span class="sxs-lookup"><span data-stu-id="a29fb-195">**Avoid anti-patterns**:</span></span>

  - <span data-ttu-id="a29fb-196">Na grande maioria dos casos, você deve evitar implementações que incluam camadas duplicadas de código de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-196">In the vast majority of cases, you should avoid implementations that include duplicated layers of retry code.</span></span> <span data-ttu-id="a29fb-197">Evite designs que incluam mecanismos de repetição em cascata ou que implementam a repetição em cada fase de uma operação que envolva uma hierarquia de solicitações, a menos que tenha requisitos específicos que a exijam.</span><span class="sxs-lookup"><span data-stu-id="a29fb-197">Avoid designs that include cascading retry mechanisms, or that implement retry at every stage of an operation that involves a hierarchy of requests, unless you have specific requirements that demand this.</span></span> <span data-ttu-id="a29fb-198">Nessas circunstâncias excepcionais, use políticas que evitem números de repetições e períodos de intervalo excessivos, e assegure-se de entender as consequências.</span><span class="sxs-lookup"><span data-stu-id="a29fb-198">In these exceptional circumstances, use policies that prevent excessive numbers of retries and delay periods, and make sure you understand the consequences.</span></span> <span data-ttu-id="a29fb-199">Por exemplo, se um componente fizer uma solicitação para outro, que então acessa o serviço de destino, e você implementar a repetição com uma contagem de três em ambas as chamadas, no total, haverá nove tentativas de repetição no serviço.</span><span class="sxs-lookup"><span data-stu-id="a29fb-199">For example, if one component makes a request to another, which then accesses the target service, and you implement retry with a count of three on both calls there will be nine retry attempts in total against the service.</span></span> <span data-ttu-id="a29fb-200">Muitos serviços e recursos implementam um mecanismo interno de repetição e você deve investigar como pode desabilitá-lo ou modificá-lo, caso precise implementar repetições em um nível mais alto.</span><span class="sxs-lookup"><span data-stu-id="a29fb-200">Many services and resources implement a built-in retry mechanism and you should investigate how you can disable or modify this if you need to implement retries at a higher level.</span></span>

  - <span data-ttu-id="a29fb-201">Nunca implemente um mecanismo de repetição infinita.</span><span class="sxs-lookup"><span data-stu-id="a29fb-201">Never implement an endless retry mechanism.</span></span> <span data-ttu-id="a29fb-202">Isso provavelmente impedirá o recurso ou serviço de se recuperar de situações de sobrecarga e fará com que conexões recusadas e a limitação continuem por um período ainda mais longo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-202">This is likely to prevent the resource or service recovering from overload situations, and cause throttling and refused connections to continue for a longer period.</span></span> <span data-ttu-id="a29fb-203">Use um número finito ou repetições, ou implemente um padrão como [Disjuntor](../patterns/circuit-breaker.md) para permitir que o serviço se recupere.</span><span class="sxs-lookup"><span data-stu-id="a29fb-203">Use a finite number or retries, or implement a pattern such as [Circuit Breaker](../patterns/circuit-breaker.md) to allow the service to recover.</span></span>

  - <span data-ttu-id="a29fb-204">Nunca execute uma repetição imediata mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="a29fb-204">Never perform an immediate retry more than once.</span></span>

  - <span data-ttu-id="a29fb-205">Evite usar um intervalo de repetição regular, especialmente quando você tem um grande número de tentativas de repetição, ao acessar serviços e recursos no Azure.</span><span class="sxs-lookup"><span data-stu-id="a29fb-205">Avoid using a regular retry interval, especially when you have a large number of retry attempts, when accessing services and resources in Azure.</span></span> <span data-ttu-id="a29fb-206">A abordagem ideal nesse cenário é uma estratégia de retirada exponencial com um recurso de interrupção do circuito.</span><span class="sxs-lookup"><span data-stu-id="a29fb-206">The optimum approach is this scenario is an exponential back-off strategy with a circuit-breaking capability.</span></span>

  - <span data-ttu-id="a29fb-207">Impeça que várias instâncias do mesmo cliente, ou várias instâncias de diferentes clientes, enviem repetições ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-207">Prevent multiple instances of the same client, or multiple instances of different clients, from sending retries at the same times.</span></span> <span data-ttu-id="a29fb-208">Se houver probabilidade de isso acontecer, introduza uma aleatoriedade nos intervalos de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-208">If this is likely to occur, introduce randomization into the retry intervals.</span></span>

- <span data-ttu-id="a29fb-209">**Teste sua estratégia de repetição e implementação:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-209">**Test your retry strategy and implementation:**</span></span>

  - <span data-ttu-id="a29fb-210">Assegure-se de testar completamente a implementação da estratégia de repetição sob o maior número de circunstâncias possível, especialmente quando o aplicativo e os recursos ou serviços de destino que ele usa estiverem sob carga extrema.</span><span class="sxs-lookup"><span data-stu-id="a29fb-210">Ensure you fully test your retry strategy implementation under as wide a set of circumstances as possible, especially when both the application and the target resources or services it uses are under extreme load.</span></span> <span data-ttu-id="a29fb-211">Para verificar o comportamento durante o teste, você pode:</span><span class="sxs-lookup"><span data-stu-id="a29fb-211">To check behavior during testing, you can:</span></span>

    - <span data-ttu-id="a29fb-212">Injetar falhas transitórias e não transitórias no serviço.</span><span class="sxs-lookup"><span data-stu-id="a29fb-212">Inject transient and non-transient faults into the service.</span></span> <span data-ttu-id="a29fb-213">Por exemplo, envie solicitações inválidas ou adicione código que detecte solicitações de teste e responda com diferentes tipos de erro.</span><span class="sxs-lookup"><span data-stu-id="a29fb-213">For example, send invalid requests or add code that detects test requests and responds with different types of errors.</span></span> <span data-ttu-id="a29fb-214">Para obter um exemplo usando o TestApi, confira [Teste de injeção de falha com o TestApi](https://msdn.microsoft.com/magazine/ff898404.aspx) e [Introdução ao TestApi – parte 5: APIs de injeção de falhas por código gerenciado](https://blogs.msdn.microsoft.com/ivo_manolov/2009/11/25/introduction-to-testapi-part-5-managed-code-fault-injection-apis/).</span><span class="sxs-lookup"><span data-stu-id="a29fb-214">For an example using TestApi, see [Fault Injection Testing with TestApi](https://msdn.microsoft.com/magazine/ff898404.aspx) and [Introduction to TestApi – Part 5: Managed Code Fault Injection APIs](https://blogs.msdn.microsoft.com/ivo_manolov/2009/11/25/introduction-to-testapi-part-5-managed-code-fault-injection-apis/).</span></span>

    - <span data-ttu-id="a29fb-215">Criar uma simulação do recurso ou serviço que retorne uma gama de erros que o serviço real pode retornar.</span><span class="sxs-lookup"><span data-stu-id="a29fb-215">Create a mock of the resource or service that returns a range of errors that the real service may return.</span></span> <span data-ttu-id="a29fb-216">Certifique-se de incluir todos os tipos de erro que sua estratégia de repetição foi projetada para detectar.</span><span class="sxs-lookup"><span data-stu-id="a29fb-216">Ensure you cover all the types of error that your retry strategy is designed to detect.</span></span>

    - <span data-ttu-id="a29fb-217">Forçar a ocorrência de erros transitórios desabilitando ou sobrecarregando temporariamente o serviço se for um serviço personalizado que você criou e implantou (você não deve, é claro, tentar sobrecarregar nenhum recurso ou serviço compartilhado no Azure).</span><span class="sxs-lookup"><span data-stu-id="a29fb-217">Force transient errors to occur by temporarily disabling or overloading the service if it is a custom service that you created and deployed (you should not, of course, attempt to overload any shared resources or shared services within Azure).</span></span>

    - <span data-ttu-id="a29fb-218">Para APIs baseadas em HTTP, pensar em usar a biblioteca FiddlerCore em seus testes automatizados para alterar a saída das solicitações HTTP, seja adicionando tempos extras de viagem de ida e volta, seja alterando a resposta (como código de status HTTP, cabeçalhos, corpo ou outros fatores).</span><span class="sxs-lookup"><span data-stu-id="a29fb-218">For HTTP-based APIs, consider using the FiddlerCore library in your automated tests to change the outcome of HTTP requests, either by adding extra roundtrip times or by changing the response (such as the HTTP status code, headers, body, or other factors).</span></span> <span data-ttu-id="a29fb-219">Isso permite o teste determinista de um subconjunto das condições de falha, sejam falhas transitórias ou outros tipos de falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-219">This enables deterministic testing of a subset of the failure conditions, whether transient faults or other types of failure.</span></span> <span data-ttu-id="a29fb-220">Para saber mais, consulte [FiddlerCore](https://www.telerik.com/fiddler/fiddlercore).</span><span class="sxs-lookup"><span data-stu-id="a29fb-220">For more information, see [FiddlerCore](https://www.telerik.com/fiddler/fiddlercore).</span></span> <span data-ttu-id="a29fb-221">Para obter exemplos de como usar a biblioteca, especificamente a classe **HttpMangler** , examine o [código-fonte do SDK do Armazenamento do Azure](https://github.com/Azure/azure-storage-net/tree/master/Test).</span><span class="sxs-lookup"><span data-stu-id="a29fb-221">For examples of how to use the library, particularly the **HttpMangler** class, examine the [source code for the Azure Storage SDK](https://github.com/Azure/azure-storage-net/tree/master/Test).</span></span>

    - <span data-ttu-id="a29fb-222">Execute o fator de carga alta e testes simultâneos para garantir que o mecanismo e a estratégia de repetição funcionem corretamente sob essas condições, e não tenham um efeito negativo na operação do cliente nem causem contaminação cruzada entre solicitações.</span><span class="sxs-lookup"><span data-stu-id="a29fb-222">Perform high load factor and concurrent tests to ensure that the retry mechanism and strategy works correctly under these conditions, and does not have an adverse effect on the operation of the client or cause cross-contamination between requests.</span></span>

- <span data-ttu-id="a29fb-223">**Gerencie as configurações de política de repetição:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-223">**Manage retry policy configurations:**</span></span>

  - <span data-ttu-id="a29fb-224">Uma *política de repetição* é uma combinação de todos os elementos de sua estratégia de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-224">A *retry policy* is a combination of all of the elements of your retry strategy.</span></span> <span data-ttu-id="a29fb-225">Ela define o mecanismo de detecção que determina se uma falha tem probabilidade de ser transitória, o tipo de intervalo a ser usado (como regular, retirada exponencial e aleatoriedade), os valores reais de intervalo e o número de vezes da repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-225">It defines the detection mechanism that determines whether a fault is likely to be transient, the type of interval to use (such as regular, exponential back-off, and randomization), the actual interval value(s), and the number of times to retry.</span></span>

  - <span data-ttu-id="a29fb-226">As repetições devem ser implementadas em muitos locais até mesmo no aplicativo mais simples e em cada camada dos aplicativos mais complexos.</span><span class="sxs-lookup"><span data-stu-id="a29fb-226">Retries must be implemented in many places within even the simplest application, and in every layer of more complex applications.</span></span> <span data-ttu-id="a29fb-227">Em vez de embutir os elementos em código de cada política em vários locais, pense em usar um ponto central para armazenar todas as políticas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-227">Rather than hard-coding the elements of each policy at multiple locations, consider using a central point for storing all the policies.</span></span> <span data-ttu-id="a29fb-228">Por exemplo, armazene os valores como o intervalo e a contagem de repetições em arquivos de configuração de aplicativo, leia-os no tempo de execução e crie as políticas de repetição de modo programático.</span><span class="sxs-lookup"><span data-stu-id="a29fb-228">For example, store the values such as the interval and retry count in application configuration files, read them at runtime, and programmatically build the retry policies.</span></span> <span data-ttu-id="a29fb-229">Isso facilita o gerenciamento das configurações, bem como modificar e ajustar os valores para que respondam aos requisitos e cenários em constante mudança.</span><span class="sxs-lookup"><span data-stu-id="a29fb-229">This makes it easier to manage the settings, and to modify and fine tune the values in order to respond to changing requirements and scenarios.</span></span> <span data-ttu-id="a29fb-230">No entanto, projete o sistema para armazenar os valores em vez de reler um arquivo de configuração toda vez e garanta que padrões adequados sejam usados se os valores não puderem ser obtidos da configuração.</span><span class="sxs-lookup"><span data-stu-id="a29fb-230">However, design the system to store the values rather than rereading a configuration file every time, and ensure suitable defaults are used if the values cannot be obtained from configuration.</span></span>

  - <span data-ttu-id="a29fb-231">Em um aplicativo de Serviços de Nuvem do Azure, pense em armazenar os valores que são usados para criar as políticas de repetição no tempo de execução no arquivo de configuração de serviço, de modo que elas possam ser alteradas sem a necessidade de reiniciar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-231">In an Azure Cloud Services application, consider storing the values that are used to build the retry policies at runtime in the service configuration file so that they can be changed without needing to restart the application.</span></span>

  - <span data-ttu-id="a29fb-232">Aproveite as estratégias de repetição padrão ou internas disponíveis nas APIs do cliente que você usa, mas somente onde elas forem apropriadas para seu cenário.</span><span class="sxs-lookup"><span data-stu-id="a29fb-232">Take advantage of built-in or default retry strategies available in the client APIs you use, but only where they are appropriate for your scenario.</span></span> <span data-ttu-id="a29fb-233">Essas estratégias geralmente são para fins gerais.</span><span class="sxs-lookup"><span data-stu-id="a29fb-233">These strategies are typically general-purpose.</span></span> <span data-ttu-id="a29fb-234">Em alguns cenários, elas podem ser tudo o que é necessário, mas em outros, elas podem não oferecer a gama total de opções adequadas aos seus requisitos específicos.</span><span class="sxs-lookup"><span data-stu-id="a29fb-234">In some scenarios they may be all that is required, but in other scenarios they may not offer the full range of options to suit your specific requirements.</span></span> <span data-ttu-id="a29fb-235">Você deve entender como as configurações afetarão o aplicativo por meio de testes que determinam a maioria dos valores apropriados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-235">You must understand how the settings will affect your application through testing to determine the most appropriate values.</span></span>

- <span data-ttu-id="a29fb-236">**Registre em log e rastreie falhas transitórias e não transitórias:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-236">**Log and track transient and non-transient faults:**</span></span>

  - <span data-ttu-id="a29fb-237">Como parte de sua estratégia de repetição, inclua o tratamento de exceções e outra instrumentação que é registrada em log quando são feitas tentativas de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-237">As part of your retry strategy, include exception handling and other instrumentation that logs when retry attempts are made.</span></span> <span data-ttu-id="a29fb-238">Embora uma falha transitória ocasional e a repetição sejam esperadas, e não indiquem um problema, números regulares e crescentes de repetições, muitas vezes, são um indicador de um problema que pode causar uma falha ou que pode estar afetando, no momento, o desempenho e a disponibilidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-238">While an occasional transient failure and retry are to be expected, and do not indicate a problem, regular and increasing numbers of retries are often an indicator of an issue that may cause a failure, or is currently impacting application performance and availability.</span></span>

  - <span data-ttu-id="a29fb-239">Registre falhas transitórias em log como entradas de Aviso em vez de entradas de Erro, de modo que a monitoração dos sistemas não as detecte como erros de aplicativo que podem disparar alertas falsos.</span><span class="sxs-lookup"><span data-stu-id="a29fb-239">Log transient faults as Warning entries rather than Error entries so that monitoring systems do not detect them as application errors that may trigger false alerts.</span></span>

  - <span data-ttu-id="a29fb-240">Considere armazenar um valor em suas entradas de log que indique se as repetições foram causadas por limitação no serviço ou por outros tipos de falha, como falhas de conexão, para que você possa diferenciá-las durante a análise dos dados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-240">Consider storing a value in your log entries that indicates if the retries were caused by throttling in the service, or by other types of faults such as connection failures, so that you can differentiate them during analysis of the data.</span></span> <span data-ttu-id="a29fb-241">Um aumento no número de erros de limitação geralmente é um indicador de uma falha de design no aplicativo ou a necessidade de alternar para um serviço premium que ofereça hardware dedicado.</span><span class="sxs-lookup"><span data-stu-id="a29fb-241">An increase in the number of throttling errors is often an indicator of a design flaw in the application or the need to switch to a premium service that offers dedicated hardware.</span></span>

  - <span data-ttu-id="a29fb-242">Considere a possibilidade de medir e registrar em log o tempo geral necessário para operações que incluem um mecanismo de repetição.</span><span class="sxs-lookup"><span data-stu-id="a29fb-242">Consider measuring and logging the overall time taken for operations that include a retry mechanism.</span></span> <span data-ttu-id="a29fb-243">Esse é um bom indicador do efeito geral das falhas transitórias nos tempos de resposta do usuário, na latência de processo e na eficiência dos casos de uso do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a29fb-243">This is a good indicator of the overall effect of transient faults on user response times, process latency, and the efficiency of the application use cases.</span></span> <span data-ttu-id="a29fb-244">Registre também o número de repetições ocorridas para entender os fatores que contribuíram para o tempo de resposta.</span><span class="sxs-lookup"><span data-stu-id="a29fb-244">Also log the number of retries occurred in order to understand the factors that contributed to the response time.</span></span>

  - <span data-ttu-id="a29fb-245">Considere implementar um sistema de telemetria e monitoramento que possa gerar alertas quando o número e a taxa de falhas, o número médio de repetições ou os tempos gerais necessários para que as operações sejam bem-sucedidas, estiverem aumentando.</span><span class="sxs-lookup"><span data-stu-id="a29fb-245">Consider implementing a telemetry and monitoring system that can raise alerts when the number and rate of failures, the average number of retries, or the overall times taken for operations to succeed, is increasing.</span></span>

- <span data-ttu-id="a29fb-246">**Gerencie operações que falham continuamente:**</span><span class="sxs-lookup"><span data-stu-id="a29fb-246">**Manage operations that continually fail:**</span></span>
  
  - <span data-ttu-id="a29fb-247">Haverá circunstâncias em que a operação continuará falhando a cada tentativa, e é essencial considerar como você tratará essa situação:</span><span class="sxs-lookup"><span data-stu-id="a29fb-247">There will be circumstances where the operation continues to fail at every attempt, and it is vital to consider how you will handle this situation:</span></span>

    - <span data-ttu-id="a29fb-248">Embora uma estratégia de repetição defina o número máximo de vezes que uma operação deve ser repetida, ela não impede que o aplicativo repita a operação novamente, com o mesmo número de repetições.</span><span class="sxs-lookup"><span data-stu-id="a29fb-248">Although a retry strategy will define the maximum number of times that an operation should be retried, it does not prevent the application repeating the operation again, with the same number of retries.</span></span> <span data-ttu-id="a29fb-249">Por exemplo, se um serviço de processamento de pedido falhar com um erro fatal que o faça parar de funcionar permanentemente, a estratégia de repetição poderá detectar um tempo limite de conexão e considerá-la uma falha transitória.</span><span class="sxs-lookup"><span data-stu-id="a29fb-249">For example, if an order processing service fails with a fatal error that puts it out of action permanently, the retry strategy may detect a connection timeout and consider it to be a transient fault.</span></span> <span data-ttu-id="a29fb-250">O código repetirá a operação um número especificado de vezes e só então desistirá.</span><span class="sxs-lookup"><span data-stu-id="a29fb-250">The code will retry the operation a specified number of times and then give up.</span></span> <span data-ttu-id="a29fb-251">No entanto, quando outro cliente fizer um pedido, a operação será tentada novamente, mesmo com a certeza de que falhará todas as vezes.</span><span class="sxs-lookup"><span data-stu-id="a29fb-251">However, when another customer places an order, the operation will be attempted again - even though it is sure to fail every time.</span></span>

    - <span data-ttu-id="a29fb-252">Para impedir as repetições constantes de operações que falham continuamente, pense na implementação do padrão de [Disjuntor](../patterns/circuit-breaker.md).</span><span class="sxs-lookup"><span data-stu-id="a29fb-252">To prevent continual retries for operations that continually fail, consider implementing the [Circuit Breaker pattern](../patterns/circuit-breaker.md).</span></span> <span data-ttu-id="a29fb-253">Nesse padrão, se o número de falhas em uma janela de tempo especificada exceder o limite, as solicitações serão retornadas ao originador imediatamente como erros, sem tentar acessar o recurso ou serviço com falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-253">In this pattern, if the number of failures within a specified time window exceeds the threshold, requests are returned to the caller immediately as errors, without attempting to access the failed resource or service.</span></span>

    - <span data-ttu-id="a29fb-254">O aplicativo pode testar o serviço periodicamente, de forma intermitente e com intervalos bastante longos entre as solicitações a fim de detectar quando ele se torna disponível.</span><span class="sxs-lookup"><span data-stu-id="a29fb-254">The application can periodically test the service, on an intermittent basis and with very long intervals between requests, to detect when it becomes available.</span></span> <span data-ttu-id="a29fb-255">Um intervalo apropriado dependerá do cenário, como a importância da operação e a natureza do serviço, e pode ser entre alguns minutos e várias horas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-255">An appropriate interval will depend on the scenario, such as the criticality of the operation and the nature of the service, and might be anything between a few minutes and several hours.</span></span> <span data-ttu-id="a29fb-256">No ponto em que o teste for bem-sucedido, o aplicativo pode retomar as operações normais e passar solicitações ao serviço recém-recuperado.</span><span class="sxs-lookup"><span data-stu-id="a29fb-256">At the point where the test succeeds, the application can resume normal operations and pass requests to the newly recovered service.</span></span>

    - <span data-ttu-id="a29fb-257">Enquanto isso, é possível fazer fallback para outra instância do serviço (talvez em outro datacenter ou aplicativo), usar um serviço semelhante que ofereça funcionalidade compatível (talvez mais simples) ou executar algumas operações alternativas na esperança de que o serviço logo estará disponível.</span><span class="sxs-lookup"><span data-stu-id="a29fb-257">In the meantime, it may be possible to fall back to another instance of the service (perhaps in a different datacenter or application), use a similar service that offers compatible (perhaps simpler) functionality, or perform some alternative operations in the hope that the service will become available soon.</span></span> <span data-ttu-id="a29fb-258">Por exemplo, talvez seja apropriado armazenar solicitações para o serviço em uma fila ou um repositório de dados e repeti-las mais tarde.</span><span class="sxs-lookup"><span data-stu-id="a29fb-258">For example, it may be appropriate to store requests for the service in a queue or data store and replay them later.</span></span> <span data-ttu-id="a29fb-259">Caso contrário, talvez você possa redirecionar o usuário para uma instância alternativa do aplicativo, reduzir o desempenho do aplicativo, mas ainda oferecer funcionalidade aceitável, ou apenas retornar uma mensagem ao usuário indicando que o aplicativo não está disponível no momento.</span><span class="sxs-lookup"><span data-stu-id="a29fb-259">Otherwise you might be able to redirect the user to an alternative instance of the application, degrade the performance of the application but still offer acceptable functionality, or just return a message to the user indicating that the application is not available at present.</span></span>

- <span data-ttu-id="a29fb-260">**Outras considerações**</span><span class="sxs-lookup"><span data-stu-id="a29fb-260">**Other considerations**</span></span>
  
  - <span data-ttu-id="a29fb-261">Ao decidir sobre os valores para o número de repetições e os intervalos de repetição para uma política, considere se a operação no serviço ou recurso faz parte de uma operação de execução longa ou de várias etapas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-261">When deciding on the values for the number of retries and the retry intervals for a policy, consider if the operation on the service or resource is part of a long-running or multi-step operation.</span></span> <span data-ttu-id="a29fb-262">Pode ser difícil ou dispendioso compensar todas as outras etapas operacionais que já foram bem-sucedidas quando uma falha.</span><span class="sxs-lookup"><span data-stu-id="a29fb-262">It may be difficult or expensive to compensate all the other operational steps that have already succeeded when one fails.</span></span> <span data-ttu-id="a29fb-263">Nesse caso, um intervalo muito longo e um grande número de repetições podem ser aceitáveis, desde que isso não bloqueie outras operações mantendo ou prendendo recursos escassos.</span><span class="sxs-lookup"><span data-stu-id="a29fb-263">In this case, a very long interval and a large number of retries may be acceptable as long as it does not block other operations by holding or locking scarce resources.</span></span>

  - <span data-ttu-id="a29fb-264">Considere se repetir a mesma operação pode causar inconsistências nos dados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-264">Consider if retrying the same operation may cause inconsistencies in data.</span></span> <span data-ttu-id="a29fb-265">Se algumas partes de um processo de várias etapas forem repetidas e as operações não forem idempotentes, isso poderá resultar em uma inconsistência.</span><span class="sxs-lookup"><span data-stu-id="a29fb-265">If some parts of a multi-step process are repeated, and the operations are not idempotent, it may result in an inconsistency.</span></span> <span data-ttu-id="a29fb-266">Por exemplo, uma operação que incrementa um valor, se repetida, produzirá um resultado inválido.</span><span class="sxs-lookup"><span data-stu-id="a29fb-266">For example, an operation that increments a value, if repeated, will produce an invalid result.</span></span> <span data-ttu-id="a29fb-267">Repetir uma operação que envia uma mensagem a uma fila poderá causar uma inconsistência no consumidor da mensagem se ele não puder detectar mensagens duplicadas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-267">Repeating an operation that sends a message to a queue may cause an inconsistency in the message consumer if it cannot detect duplicate messages.</span></span> <span data-ttu-id="a29fb-268">Para evitar isso, assegure-se de projetar cada etapa como uma operação idempotente.</span><span class="sxs-lookup"><span data-stu-id="a29fb-268">To prevent this, ensure that you design each step as an idempotent operation.</span></span> <span data-ttu-id="a29fb-269">Para saber mais sobre idempotência, confira [Padrões de idempotência][idempotency-patterns].</span><span class="sxs-lookup"><span data-stu-id="a29fb-269">For more information about idempotency, see [Idempotency patterns][idempotency-patterns].</span></span>

  - <span data-ttu-id="a29fb-270">Considere o escopo das operações que serão repetidas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-270">Consider the scope of the operations that will be retried.</span></span> <span data-ttu-id="a29fb-271">Por exemplo, pode ser mais fácil implementar o código de repetição em um nível que englobe várias operações e repetir todas elas se uma falhar.</span><span class="sxs-lookup"><span data-stu-id="a29fb-271">For example, it may be easier to implement retry code at a level that encompasses several operations, and retry them all if one fails.</span></span> <span data-ttu-id="a29fb-272">No entanto, fazer isso pode resultar em problemas de idempotência ou em operações de reversão desnecessárias.</span><span class="sxs-lookup"><span data-stu-id="a29fb-272">However, doing this may result in idempotency issues or unnecessary rollback operations.</span></span>

  - <span data-ttu-id="a29fb-273">Se você escolher um escopo de repetição que englobe várias operações, leve em conta a latência total de todos elas ao determinar os intervalos de repetição, ao monitorar o tempo gasto e antes de gerar alertas para falhas.</span><span class="sxs-lookup"><span data-stu-id="a29fb-273">If you choose a retry scope that encompasses several operations, take into account the total latency of all of them when determining the retry intervals, when monitoring the time taken, and before raising alerts for failures.</span></span>

  - <span data-ttu-id="a29fb-274">Considere como sua estratégia de repetição pode afetar vizinhos e outros locatários em um aplicativo compartilhado ou ao usar os serviços e recursos compartilhados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-274">Consider how your retry strategy may affect neighbors and other tenants in a shared application, or when using shared resources and services.</span></span> <span data-ttu-id="a29fb-275">As políticas de repetição agressivas podem aumentar o número de falhas transitórias que ocorrem para esses outros usuários e para aplicativos que compartilham os recursos e serviços.</span><span class="sxs-lookup"><span data-stu-id="a29fb-275">Aggressive retry policies can cause an increasing number of transient faults to occur for these other users and for applications that share the resources and services.</span></span> <span data-ttu-id="a29fb-276">Da mesma forma, seu aplicativo poderá ser afetado pelas políticas de repetição implementadas por outros usuários dos recursos e serviços.</span><span class="sxs-lookup"><span data-stu-id="a29fb-276">Likewise, your application may be affected by the retry policies implemented by other users of the resources and services.</span></span> <span data-ttu-id="a29fb-277">Para aplicativos de missão crítica, você pode decidir usar os serviços premium que não são compartilhados.</span><span class="sxs-lookup"><span data-stu-id="a29fb-277">For mission-critical applications, you may decide to use premium services that are not shared.</span></span> <span data-ttu-id="a29fb-278">Isso oferece muito mais controle sobre a carga e a limitação resultante desses recursos e serviços, o que pode ajudar a justificar o custo adicional.</span><span class="sxs-lookup"><span data-stu-id="a29fb-278">This provides you with much more control over the load and consequent throttling of these resources and services, which can help to justify the additional cost.</span></span>

## <a name="more-information"></a><span data-ttu-id="a29fb-279">Mais informações</span><span class="sxs-lookup"><span data-stu-id="a29fb-279">More information</span></span>

- [<span data-ttu-id="a29fb-280">Diretrizes para repetição específicas do serviço do Azure</span><span class="sxs-lookup"><span data-stu-id="a29fb-280">Azure service-specific retry guidelines</span></span>](./retry-service-specific.md)
- [<span data-ttu-id="a29fb-281">Padrão de interruptor de circuito</span><span class="sxs-lookup"><span data-stu-id="a29fb-281">Circuit Breaker pattern</span></span>](../patterns/circuit-breaker.md)
- [<span data-ttu-id="a29fb-282">Padrão de transação de compensação</span><span class="sxs-lookup"><span data-stu-id="a29fb-282">Compensating Transaction pattern</span></span>](../patterns/compensating-transaction.md)
- <span data-ttu-id="a29fb-283">[Padrões de idempotência][idempotency-patterns]</span><span class="sxs-lookup"><span data-stu-id="a29fb-283">[Idempotency patterns][idempotency-patterns]</span></span>

<!-- links -->

[idempotency-patterns]: https://blog.jonathanoliver.com/idempotency-patterns/

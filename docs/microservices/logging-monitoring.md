---
title: "Registro em log e monitoramento em microsserviços"
description: "Registro em log e monitoramento em microsserviços"
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 1da67047daa9ae87cda5dd7dd581d6081183c428
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/12/2017
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="a6271-103">Projetando microsserviços: registro em log e monitoramento</span><span class="sxs-lookup"><span data-stu-id="a6271-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="a6271-104">Em qualquer aplicativo complexo, em algum momento, algo dará errado.</span><span class="sxs-lookup"><span data-stu-id="a6271-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="a6271-105">Em um aplicativo de microsserviço, você precisa controlar o que está acontecendo em dúzias ou até mesmo centenas de serviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="a6271-106">O monitoramento e o registro em log são extremamente importantes para fornecer uma visão holística do sistema.</span><span class="sxs-lookup"><span data-stu-id="a6271-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="a6271-107">Em uma arquitetura de microsserviços, descobrir a causa exata de erros ou gargalos de desempenho pode ser algo especialmente desafiador.</span><span class="sxs-lookup"><span data-stu-id="a6271-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="a6271-108">Uma única operação de usuário pode abranger vários serviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="a6271-109">Serviços podem atingir os limites de E/S de rede dentro do cluster.</span><span class="sxs-lookup"><span data-stu-id="a6271-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="a6271-110">Uma cadeia de chamadas entre serviços pode causar pressão de retorno no sistema, resultando em latência alta ou em falhas em cascata.</span><span class="sxs-lookup"><span data-stu-id="a6271-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="a6271-111">Além disso, geralmente você não sabe em qual nó um contêiner específico será executado.</span><span class="sxs-lookup"><span data-stu-id="a6271-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="a6271-112">Contêineres colocados no mesmo nó podem estar competindo por CPU ou memória limitada.</span><span class="sxs-lookup"><span data-stu-id="a6271-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="a6271-113">Para entender o que está acontecendo, o aplicativo deve emitir eventos de telemetria.</span><span class="sxs-lookup"><span data-stu-id="a6271-113">To make sense of what's happening, the application must emit telemetry events.</span></span> <span data-ttu-id="a6271-114">Você pode categorizar essas métricas e logs baseados em texto.</span><span class="sxs-lookup"><span data-stu-id="a6271-114">You can categorize these into metrics and text-based logs.</span></span> 

<span data-ttu-id="a6271-115">*Métricas* são valores numéricos que podem ser analisados.</span><span class="sxs-lookup"><span data-stu-id="a6271-115">*Metrics* are numerical values that can be analyzed.</span></span> <span data-ttu-id="a6271-116">Você pode usá-los para observar o sistema em tempo real (ou quase em tempo real) ou então para analisar as tendências de desempenho ao longo do tempo.</span><span class="sxs-lookup"><span data-stu-id="a6271-116">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="a6271-117">As métricas incluem:</span><span class="sxs-lookup"><span data-stu-id="a6271-117">Metrics include:</span></span>

- <span data-ttu-id="a6271-118">Métricas do sistema no nível de nó, incluindo CPU, memória, rede, disco e uso do sistema de arquivos.</span><span class="sxs-lookup"><span data-stu-id="a6271-118">Node-level system metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="a6271-119">As métricas do sistema ajudam a compreender a alocação de recurso para cada nó no cluster e exceções de solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="a6271-119">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>
 
- <span data-ttu-id="a6271-120">Métricas de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="a6271-120">Kubernetes metrics.</span></span> <span data-ttu-id="a6271-121">Já que os serviços são executados em contêineres, você precisa coletar métricas no nível do contêiner, não apenas no nível de VM.</span><span class="sxs-lookup"><span data-stu-id="a6271-121">Because services run in containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="a6271-122">No Kubernetes, o cAdvisor (Assistente de Contêiner) é o agente que coleta estatísticas sobre a CPU, memória, sistema de arquivos e recursos de rede usados por cada contêiner.</span><span class="sxs-lookup"><span data-stu-id="a6271-122">In Kubernetes, cAdvisor (Container Advisor) is the agent that collects statistics about the CPU, memory, file system, and network resources used by each container.</span></span> <span data-ttu-id="a6271-123">O daemon kubelet coleta estatísticas de recursos do cAdvisor e as expõe por meio de uma API REST.</span><span class="sxs-lookup"><span data-stu-id="a6271-123">The kubelet daemon collects resource statistics from cAdvisor and exposes them through a REST API.</span></span>
   
- <span data-ttu-id="a6271-124">Métricas de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-124">Application metrics.</span></span> <span data-ttu-id="a6271-125">Isso inclui as métricas que são relevantes para entender o comportamento de um serviço.</span><span class="sxs-lookup"><span data-stu-id="a6271-125">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="a6271-126">Exemplos incluem o número de solicitações HTTP de entrada na fila, latência de solicitação, comprimento da fila de mensagens ou número de transações processadas por segundo.</span><span class="sxs-lookup"><span data-stu-id="a6271-126">Examples include the number of queued inbound HTTP requests, request latency, message queue length, or number of transactions processed per second.</span></span>

- <span data-ttu-id="a6271-127">Métricas de serviço dependentes.</span><span class="sxs-lookup"><span data-stu-id="a6271-127">Dependent service metrics.</span></span> <span data-ttu-id="a6271-128">Serviços de cluster podem chamar serviços externos que estão fora do cluster, tais como serviços de PaaS gerenciados.</span><span class="sxs-lookup"><span data-stu-id="a6271-128">Services inside the cluster may call external services that are outside the cluster, such as managed PaaS services.</span></span> <span data-ttu-id="a6271-129">Você pode monitorar os Serviços do Azure usando o [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span><span class="sxs-lookup"><span data-stu-id="a6271-129">You can monitor Azure services by using [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span></span> <span data-ttu-id="a6271-130">Os serviços de terceiros podem ou não fornecer alguma métrica.</span><span class="sxs-lookup"><span data-stu-id="a6271-130">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="a6271-131">Se não fornecerem, você dependerá de suas próprias métricas de aplicativo para acompanhar as estatísticas de latência e taxa de erros.</span><span class="sxs-lookup"><span data-stu-id="a6271-131">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

<span data-ttu-id="a6271-132">*Logs* são registros de eventos que ocorrem durante a execução do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-132">*Logs* are records of events that occur while the application is running.</span></span> <span data-ttu-id="a6271-133">Eles incluem itens como logs de aplicativos (instruções de rastreamento) ou logs do servidor Web.</span><span class="sxs-lookup"><span data-stu-id="a6271-133">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="a6271-134">Os logs são úteis principalmente para análise da causa raiz e análise forense.</span><span class="sxs-lookup"><span data-stu-id="a6271-134">Logs are primarily useful for forensics and root cause analysis.</span></span> 

## <a name="considerations"></a><span data-ttu-id="a6271-135">Considerações</span><span class="sxs-lookup"><span data-stu-id="a6271-135">Considerations</span></span>

<span data-ttu-id="a6271-136">O artigo [Monitoramento e diagnóstico](../best-practices/monitoring.md) descreve práticas recomendadas gerais para monitorar um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-136">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="a6271-137">Aqui estão algumas coisas específicas para se pensar no contexto de uma arquitetura de microsserviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-137">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="a6271-138">**Configuração e gerenciamento**.</span><span class="sxs-lookup"><span data-stu-id="a6271-138">**Configuration and management**.</span></span> <span data-ttu-id="a6271-139">Você usará um serviço gerenciado para monitoramento e registro em log ou implantará os componentes de registro em log e monitoramento como contêineres dentro do cluster?</span><span class="sxs-lookup"><span data-stu-id="a6271-139">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="a6271-140">Para mais informações sobre essas opções, consulte a seção [Opções de tecnologia](#technology-options) abaixo.</span><span class="sxs-lookup"><span data-stu-id="a6271-140">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="a6271-141">**Taxa de ingestão**.</span><span class="sxs-lookup"><span data-stu-id="a6271-141">**Ingestion rate**.</span></span> <span data-ttu-id="a6271-142">Qual é a taxa de transferência na qual o sistema pode incluir eventos de telemetria?</span><span class="sxs-lookup"><span data-stu-id="a6271-142">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="a6271-143">O que acontece se essa taxa é excedida?</span><span class="sxs-lookup"><span data-stu-id="a6271-143">What happens if that rate is exceeded?</span></span> <span data-ttu-id="a6271-144">Por exemplo, o sistema pode limitar os clientes, caso em que os dados de telemetria são perdidos, ou pode reduzir a amostra de dados.</span><span class="sxs-lookup"><span data-stu-id="a6271-144">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="a6271-145">Às vezes, você pode atenuar esse problema reduzindo a quantidade de dados coletados:</span><span class="sxs-lookup"><span data-stu-id="a6271-145">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="a6271-146">Agregue métricas calculando estatísticas como média e desvio padrão e envie esses dados estatísticos para o sistema de monitoramento.</span><span class="sxs-lookup"><span data-stu-id="a6271-146">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="a6271-147">Reduza a amostra de dados &mdash; ou seja, processe apenas um percentual dos eventos.</span><span class="sxs-lookup"><span data-stu-id="a6271-147">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="a6271-148">Envie os dados em lotes para reduzir o número de chamadas de rede para o serviço de monitoramento.</span><span class="sxs-lookup"><span data-stu-id="a6271-148">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="a6271-149">**Custo**.</span><span class="sxs-lookup"><span data-stu-id="a6271-149">**Cost**.</span></span> <span data-ttu-id="a6271-150">O custo de ingerir e armazenar dados de telemetria pode ser alto, especialmente em grandes volumes.</span><span class="sxs-lookup"><span data-stu-id="a6271-150">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="a6271-151">Em alguns casos, ele pode até mesmo exceder o custo de executar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-151">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="a6271-152">Nesse caso, convém reduzir o volume de telemetria agregando os dados, reduzindo sua resolução ou enviando-os em lotes, conforme descrito acima.</span><span class="sxs-lookup"><span data-stu-id="a6271-152">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="a6271-153">**Fidelidade de dados**.</span><span class="sxs-lookup"><span data-stu-id="a6271-153">**Data fidelity**.</span></span> <span data-ttu-id="a6271-154">Qual o nível de precisão das métricas?</span><span class="sxs-lookup"><span data-stu-id="a6271-154">How accurate are the metrics?</span></span> <span data-ttu-id="a6271-155">Médias podem ocultar exceções, especialmente em escala.</span><span class="sxs-lookup"><span data-stu-id="a6271-155">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="a6271-156">Além disso, se a taxa de amostragem é muito baixa, ela pode suavizar flutuações nos dados.</span><span class="sxs-lookup"><span data-stu-id="a6271-156">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="a6271-157">Pode parecer que tem todas as solicitações têm aproximadamente a mesma latência de ponta a ponta, quando na verdade uma parte significativa das solicitações estão demorando muito mais.</span><span class="sxs-lookup"><span data-stu-id="a6271-157">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="a6271-158">**Latência**.</span><span class="sxs-lookup"><span data-stu-id="a6271-158">**Latency**.</span></span> <span data-ttu-id="a6271-159">Para habilitar alertas e monitoramento em tempo real, os dados de telemetria devem estar disponíveis rapidamente.</span><span class="sxs-lookup"><span data-stu-id="a6271-159">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="a6271-160">Quanto a disponibilização dos dados que aparecem no painel de monitoramento realmente se aproxima de "tempo real"?</span><span class="sxs-lookup"><span data-stu-id="a6271-160">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="a6271-161">Com alguns segundos de atraso?</span><span class="sxs-lookup"><span data-stu-id="a6271-161">A few seconds old?</span></span> <span data-ttu-id="a6271-162">Mais de um minuto?</span><span class="sxs-lookup"><span data-stu-id="a6271-162">More than a minute?</span></span>

<span data-ttu-id="a6271-163">**Armazenamento.**</span><span class="sxs-lookup"><span data-stu-id="a6271-163">**Storage.**</span></span> <span data-ttu-id="a6271-164">Para logs, pode ser mais eficiente para gravar os eventos de log em armazenamento efêmero no cluster e configurar um agente para enviar os arquivos de log para armazenamento mais persistente.</span><span class="sxs-lookup"><span data-stu-id="a6271-164">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="a6271-165">Dados devem ser movidos eventualmente para o armazenamento de longo prazo para que ele esteja disponível para análise retrospectiva.</span><span class="sxs-lookup"><span data-stu-id="a6271-165">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="a6271-166">Uma arquitetura de microsserviços pode gerar um grande volume de dados de telemetria, portanto, o custo de armazenar esses dados é uma consideração importante.</span><span class="sxs-lookup"><span data-stu-id="a6271-166">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="a6271-167">Além disso, considere como você consultará os dados.</span><span class="sxs-lookup"><span data-stu-id="a6271-167">Also consider how you will query the data.</span></span> 

<span data-ttu-id="a6271-168">**Painel e visualização.**</span><span class="sxs-lookup"><span data-stu-id="a6271-168">**Dashboard and visualization.**</span></span> <span data-ttu-id="a6271-169">Você tem uma visão holística do sistema, em todos os serviços, tanto de dentro do cluster quanto dos serviços externos?</span><span class="sxs-lookup"><span data-stu-id="a6271-169">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="a6271-170">Se você estiver gravando dados de telemetria e logs em mais de um local, o painel poderá mostrar todos eles e correlacioná-los?</span><span class="sxs-lookup"><span data-stu-id="a6271-170">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="a6271-171">O painel de monitoramento deve mostrar pelo menos as seguintes informações:</span><span class="sxs-lookup"><span data-stu-id="a6271-171">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="a6271-172">Alocação de recurso geral para crescimento e capacidade.</span><span class="sxs-lookup"><span data-stu-id="a6271-172">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="a6271-173">Isso inclui o número de contêineres, as métricas do sistema de arquivos, rede e alocação de núcleos.</span><span class="sxs-lookup"><span data-stu-id="a6271-173">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="a6271-174">Métricas de contêiner correlacionadas no nível de serviço.</span><span class="sxs-lookup"><span data-stu-id="a6271-174">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="a6271-175">As métricas do sistema correlacionadas a contêineres.</span><span class="sxs-lookup"><span data-stu-id="a6271-175">System metrics correlated with containers.</span></span>
- <span data-ttu-id="a6271-176">Erros de serviço e exceções.</span><span class="sxs-lookup"><span data-stu-id="a6271-176">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="a6271-177">Rastreamento distribuído</span><span class="sxs-lookup"><span data-stu-id="a6271-177">Distributed tracing</span></span>

<span data-ttu-id="a6271-178">Conforme mencionado, um desafio em microsserviços é entender o fluxo de eventos entre os serviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-178">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="a6271-179">Uma única operação ou transação pode envolver a chamadas para vários serviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-179">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="a6271-180">Para reconstruir a toda sequência de etapas, cada serviço deve propagar uma *ID de correlação* que atua como um identificador exclusivo para essa operação.</span><span class="sxs-lookup"><span data-stu-id="a6271-180">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="a6271-181">A ID de correlação habilita o [rastreamento distribuído](http://microservices.io/patterns/observability/distributed-tracing.html) entre serviços.</span><span class="sxs-lookup"><span data-stu-id="a6271-181">The correlation ID enables [distributed tracing](http://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="a6271-182">O primeiro serviço que recebe uma solicitação de cliente deve gerar a ID de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-182">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="a6271-183">Se o serviço faz uma chamada HTTP para outro serviço, ele coloca a ID de correlação em um cabeçalho de solicitação.</span><span class="sxs-lookup"><span data-stu-id="a6271-183">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="a6271-184">Da mesma forma, se o serviço envia uma mensagem assíncrona, ele coloca a ID de correlação nessa mensagem.</span><span class="sxs-lookup"><span data-stu-id="a6271-184">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="a6271-185">Serviços de downstream continuam a propagar a ID de correlação, de modo que ela flui através de todo o sistema.</span><span class="sxs-lookup"><span data-stu-id="a6271-185">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="a6271-186">Além disso, todo o código que grava eventos de log ou métricas do aplicativo deve incluir a ID de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-186">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="a6271-187">Quando as chamadas de serviço são correlacionadas, você pode calcular métricas operacionais, como a latência de ponta a ponta para uma transação completa, o número de transações bem-sucedidas por segundo e o percentual de transações com falha.</span><span class="sxs-lookup"><span data-stu-id="a6271-187">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="a6271-188">Incluir IDs de correlação nos logs de aplicativo possibilita realizar a análise da causa raiz.</span><span class="sxs-lookup"><span data-stu-id="a6271-188">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="a6271-189">Se uma operação falhar, você poderá encontrar as instruções de log para todas as chamadas de serviço que fizerem parte da mesma operação.</span><span class="sxs-lookup"><span data-stu-id="a6271-189">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="a6271-190">Aqui estão algumas considerações ao implementar o rastreamento distribuído:</span><span class="sxs-lookup"><span data-stu-id="a6271-190">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="a6271-191">Atualmente, não há nenhum cabeçalho HTTP padrão para IDs de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-191">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="a6271-192">Sua equipe deve padronizar em um valor de cabeçalho personalizado.</span><span class="sxs-lookup"><span data-stu-id="a6271-192">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="a6271-193">Essa escolha pode ser decidida por sua estrutura de monitoramento/registro em log ou sua escolha de malha de serviço.</span><span class="sxs-lookup"><span data-stu-id="a6271-193">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="a6271-194">Para mensagens assíncronas, se sua infraestrutura de mensagens é compatível com a adição de metadados a mensagens, você deve incluir a ID de correlação como metadados.</span><span class="sxs-lookup"><span data-stu-id="a6271-194">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="a6271-195">Caso contrário, inclua-a como parte do esquema de mensagem.</span><span class="sxs-lookup"><span data-stu-id="a6271-195">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="a6271-196">Em vez de um único identificador opaco, você pode enviar um *contexto de correlação* que inclui informações mais avançadas, tais como relações chamador/receptor.</span><span class="sxs-lookup"><span data-stu-id="a6271-196">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="a6271-197">O SDK do Azure Application Insights injeta automaticamente o contexto de correlação em cabeçalhos HTTP e inclui a ID de correlação nos logs do Application Insights.</span><span class="sxs-lookup"><span data-stu-id="a6271-197">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="a6271-198">Se você decidir usar recursos de correlação do Application Insights, alguns serviços ainda precisarão propagar os cabeçalhos de correlação explicitamente, dependendo de bibliotecas que estiverem sendo usadas.</span><span class="sxs-lookup"><span data-stu-id="a6271-198">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="a6271-199">Para obter mais informações, consulte [Correlação de telemetria no Application Insights](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="a6271-199">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="a6271-200">Se você estiver usando Istio ou linkerd como uma malha de serviço, essas tecnologias gerarão cabeçalhos de correlação automaticamente quando chamadas HTTP forem roteadas por meio dos proxies de malha de serviço.</span><span class="sxs-lookup"><span data-stu-id="a6271-200">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="a6271-201">Os serviços devem encaminhar os cabeçalhos pertinentes.</span><span class="sxs-lookup"><span data-stu-id="a6271-201">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="a6271-202">Istio: [rastreamento de solicitações distribuído](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span><span class="sxs-lookup"><span data-stu-id="a6271-202">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="a6271-203">linkerd: [cabeçalhos de contexto](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span><span class="sxs-lookup"><span data-stu-id="a6271-203">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="a6271-204">Considere o modo como você agregará os logs.</span><span class="sxs-lookup"><span data-stu-id="a6271-204">Consider how you will aggregate logs.</span></span> <span data-ttu-id="a6271-205">Você talvez queira que o modo como as IDs de correlação são incluídas nos logs seja padronizado entre as equipes.</span><span class="sxs-lookup"><span data-stu-id="a6271-205">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="a6271-206">Use um formato estruturado ou semiestruturado, tal como JSON, e defina um campo comum para conter a ID de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-206">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="a6271-207">Opções de tecnologia</span><span class="sxs-lookup"><span data-stu-id="a6271-207">Technology options</span></span>

<span data-ttu-id="a6271-208">**Application Insights** é um serviço gerenciado do Azure que ingere e armazena dados de telemetria e fornece ferramentas para pesquisar por dados e analisá-los.</span><span class="sxs-lookup"><span data-stu-id="a6271-208">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="a6271-209">Para usar o Application Insights, você pode instalar um pacote de instrumentação em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-209">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="a6271-210">Esse pacote monitora o aplicativo e envia dados de telemetria para o serviço do Application Insights.</span><span class="sxs-lookup"><span data-stu-id="a6271-210">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="a6271-211">Ele também pode efetuar pull de dados de telemetria do ambiente de host.</span><span class="sxs-lookup"><span data-stu-id="a6271-211">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="a6271-212">O Application Insights fornece correlação e acompanhamento de dependência internos.</span><span class="sxs-lookup"><span data-stu-id="a6271-212">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="a6271-213">Ele permite controlar as métricas do sistema, de aplicativo e de serviço do Azure, em um só lugar.</span><span class="sxs-lookup"><span data-stu-id="a6271-213">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="a6271-214">Lembre-se de que o Application Insights será limitado se a taxa de dados exceder um limite máximo; para obter detalhes, consulte [Limites do Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="a6271-214">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="a6271-215">Uma única operação pode gerar vários eventos de telemetria, portanto, se o aplicativo passar por um alto volume de tráfego, ele provavelmente será limitado.</span><span class="sxs-lookup"><span data-stu-id="a6271-215">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="a6271-216">Para atenuar esse problema, você pode executar amostragem para reduzir o tráfego de telemetria.</span><span class="sxs-lookup"><span data-stu-id="a6271-216">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="a6271-217">A desvantagem é que suas métricas serão menos precisas.</span><span class="sxs-lookup"><span data-stu-id="a6271-217">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="a6271-218">Para obter mais informações, consulte [Amostragem no Application Insights](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="a6271-218">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="a6271-219">Você também pode reduzir o volume de dados pré-agregando métricas &mdash; ou seja, calculando valores estatísticos como média e desvio padrão e enviando esses valores em lugar da telemetria bruta.</span><span class="sxs-lookup"><span data-stu-id="a6271-219">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="a6271-220">A postagem no blog a seguir descreve uma abordagem para uso do Application Insights em escala: [Monitoramento do Azure e análise em escala](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span><span class="sxs-lookup"><span data-stu-id="a6271-220">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="a6271-221">Além disso, verifique se você compreende o modelo de preços para o Application Insights, porque a cobrança é feita com base no volume de dados.</span><span class="sxs-lookup"><span data-stu-id="a6271-221">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="a6271-222">Para obter mais informações, consulte [Gerenciar o preço e o volume de dados no Application Insights](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="a6271-222">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="a6271-223">Se seu aplicativo gera um grande volume de telemetria e você não deseja realizar amostragem nem agregação dos dados, o Application Insights pode não ser a escolha apropriada.</span><span class="sxs-lookup"><span data-stu-id="a6271-223">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="a6271-224">Se o Application Insights não atende às suas necessidades, aqui estão algumas abordagens sugeridas que usam tecnologias de software livre populares.</span><span class="sxs-lookup"><span data-stu-id="a6271-224">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="a6271-225">Para métricas de sistema e de contêiner, considere exportar métricas para um banco de dados de série temporal como **Prometheus** ou **InfluxDB** em execução no cluster.</span><span class="sxs-lookup"><span data-stu-id="a6271-225">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="a6271-226">InfluxDB é um sistema baseado em push.</span><span class="sxs-lookup"><span data-stu-id="a6271-226">InfluxDB is a push-based system.</span></span> <span data-ttu-id="a6271-227">É necessário que um agente envie as métricas por push.</span><span class="sxs-lookup"><span data-stu-id="a6271-227">An agent needs to push the metrics.</span></span> <span data-ttu-id="a6271-228">Você pode usar o [Heapster][heapster], que é um serviço que coleta métricas de todo o cluster do kubelet, agrega os dados e envia-os por push para InfluxDB ou outra solução de armazenamento de série temporal.</span><span class="sxs-lookup"><span data-stu-id="a6271-228">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="a6271-229">O Serviço de Contêiner do Azure implanta o Heapster como parte da configuração do cluster.</span><span class="sxs-lookup"><span data-stu-id="a6271-229">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="a6271-230">Outra opção é o [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), que é um agente para coletar e relatar métricas.</span><span class="sxs-lookup"><span data-stu-id="a6271-230">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="a6271-231">O Prometheus é um sistema baseado em pull.</span><span class="sxs-lookup"><span data-stu-id="a6271-231">Prometheus is a pull-based system.</span></span> <span data-ttu-id="a6271-232">Ele extrai periodicamente as métricas de locais configurados.</span><span class="sxs-lookup"><span data-stu-id="a6271-232">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="a6271-233">O Prometheus pode extrair métricas geradas por cAdvisor ou métricas de estado kube.</span><span class="sxs-lookup"><span data-stu-id="a6271-233">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="a6271-234">[métricas de estado kube][kube-state-metrics] é um serviço que coleta métricas do servidor de API do Kubernetes e as disponibiliza para o Prometheus (ou um extrator que seja compatível com um ponto de extremidade de cliente do Prometheus).</span><span class="sxs-lookup"><span data-stu-id="a6271-234">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="a6271-235">Embora o Heapster agregue as métricas geradas pelo Kubernetes e encaminhe-as para um coletor, o serviço métricas de estado kube gera suas próprias métricas e disponibiliza-as por meio de um ponto de extremidade para extração.</span><span class="sxs-lookup"><span data-stu-id="a6271-235">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="a6271-236">Para métricas do sistema, use o [Exportador de nó](https://github.com/prometheus/node_exporter), que é um exportador Prometheus para métricas do sistema.</span><span class="sxs-lookup"><span data-stu-id="a6271-236">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="a6271-237">O Prometheus é compatível com os dados de ponto flutuante, mas não com os dados de cadeia de caracteres, portanto, ele é apropriado para as métricas do sistema, mas não para logs.</span><span class="sxs-lookup"><span data-stu-id="a6271-237">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="a6271-238">Usar uma ferramenta de painel, tal como **Kibana** ou **Grafana**, para visualizar e monitorar os dados.</span><span class="sxs-lookup"><span data-stu-id="a6271-238">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="a6271-239">O serviço de painel também pode ser executado dentro de um contêiner no cluster.</span><span class="sxs-lookup"><span data-stu-id="a6271-239">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="a6271-240">Para logs de aplicativo, considere o uso de **Fluentd** e **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="a6271-240">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="a6271-241">Fluentd é um coletor de dados de software livre e Elasticsearch é um banco de dados de documento que é otimizado para atuar como um mecanismo de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="a6271-241">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="a6271-242">Usando essa abordagem, cada serviço envia logs para `stdout` e `stderr` e o Kubernetes grava esses fluxos para o sistema de arquivos local.</span><span class="sxs-lookup"><span data-stu-id="a6271-242">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="a6271-243">O Fluentd coleta os logs, opcionalmente enriquece-os com metadados adicionais do Kubernetes e envia os logs para o Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="a6271-243">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="a6271-244">Use o Kibana, o Grafana ou uma ferramenta semelhante para criar um painel para o Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="a6271-244">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="a6271-245">O Fluentd é executado como um conjunto de daemons no cluster, o que garante que um pod do Fluentd é atribuído a cada nó.</span><span class="sxs-lookup"><span data-stu-id="a6271-245">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="a6271-246">Você pode configurar o Fluentd para coletar logs do kubelet, bem como os logs de contêiner.</span><span class="sxs-lookup"><span data-stu-id="a6271-246">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="a6271-247">Em grandes volumes, gravar logs no sistema de arquivos local pode se tornar um gargalo de desempenho, especialmente quando vários serviços estão em execução no mesmo nó.</span><span class="sxs-lookup"><span data-stu-id="a6271-247">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="a6271-248">Monitore a latência do disco e a utilização do sistema de arquivos na produção.</span><span class="sxs-lookup"><span data-stu-id="a6271-248">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="a6271-249">Uma vantagem de usar Fluentd com Elasticsearch para logs é que os serviços não exigem nenhuma dependência de biblioteca adicional.</span><span class="sxs-lookup"><span data-stu-id="a6271-249">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="a6271-250">Cada serviço grava apenas para `stdout` e `stderr` e o Fluentd fica responsável pela exportação dos logs para o Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="a6271-250">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="a6271-251">Além disso, as equipes que escrevem código de serviços não precisam entender como configurar a infraestrutura de log.</span><span class="sxs-lookup"><span data-stu-id="a6271-251">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="a6271-252">Um desafio é configurar o cluster Elasticsearch para uma implantação de produção de modo que ele seja dimensionado para lidar com o tráfego.</span><span class="sxs-lookup"><span data-stu-id="a6271-252">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="a6271-253">Outra opção é enviar logs para o Log Analytics do OMS (Operations Management Suite).</span><span class="sxs-lookup"><span data-stu-id="a6271-253">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="a6271-254">O serviço [Log Analytics][log-analytics] coleta dados de log em um repositório central e também pode consolidar dados de outros serviços do Azure usados pelo seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a6271-254">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="a6271-255">Para obter mais informações, consulte [Monitorar um cluster do Serviço de Contêiner do Azure com o Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="a6271-255">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="a6271-256">Exemplo: registro em log com IDs de correlação</span><span class="sxs-lookup"><span data-stu-id="a6271-256">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="a6271-257">Para ilustrar alguns dos pontos abordados neste capítulo, aqui está um exemplo estendido de como o serviço Package implementa o registro em log.</span><span class="sxs-lookup"><span data-stu-id="a6271-257">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="a6271-258">O serviço Package foi escrito em TypeScript e usa a estrutura [Koa](http://koajs.com/) da Web para Node.js.</span><span class="sxs-lookup"><span data-stu-id="a6271-258">The Package service was written in TypeScript and uses the [Koa](http://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="a6271-259">Há várias bibliotecas de registro em log do Node.js à sua escolha.</span><span class="sxs-lookup"><span data-stu-id="a6271-259">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="a6271-260">Escolhemos [Winston](https://github.com/winstonjs/winston), uma biblioteca de log popular que atendeu a nossos requisitos de desempenho quando testada.</span><span class="sxs-lookup"><span data-stu-id="a6271-260">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="a6271-261">Para encapsular os detalhes de implementação, definimos uma interface `ILogger` abstrata:</span><span class="sxs-lookup"><span data-stu-id="a6271-261">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="a6271-262">Aqui está uma implementação de `ILogger` que encapsula a biblioteca Winston.</span><span class="sxs-lookup"><span data-stu-id="a6271-262">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="a6271-263">Ela usa a ID de correlação como um parâmetro de construtor e injeta a ID em todas as mensagens de log.</span><span class="sxs-lookup"><span data-stu-id="a6271-263">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="a6271-264">O serviço Package precisa extrair a ID de correlação da solicitação HTTP.</span><span class="sxs-lookup"><span data-stu-id="a6271-264">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="a6271-265">Por exemplo, se você estiver usando linkerd, a ID de correlação será encontrada no cabeçalho `l5d-ctx-trace`.</span><span class="sxs-lookup"><span data-stu-id="a6271-265">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="a6271-266">No Koa, a solicitação HTTP é armazenada em um objeto Context que é passado por meio da pipeline de processamento de solicitação.</span><span class="sxs-lookup"><span data-stu-id="a6271-266">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="a6271-267">Podemos definir uma função de middleware para obter a ID de correlação do Context e inicializar o agente.</span><span class="sxs-lookup"><span data-stu-id="a6271-267">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="a6271-268">(Uma função de middleware em Koa é simplesmente uma função que é executada para cada solicitação.)</span><span class="sxs-lookup"><span data-stu-id="a6271-268">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="a6271-269">Esse middleware chama uma função definida pelo chamador, `getCorrelationId`, para obter a ID de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-269">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="a6271-270">Em seguida, ele cria uma instância do agente e armazena-a dentro de `ctx.state`, que é um dicionário de chave-valor usado em Koa para passar informações por meio do pipeline.</span><span class="sxs-lookup"><span data-stu-id="a6271-270">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="a6271-271">O middleware do agente é adicionado ao pipeline na inicialização:</span><span class="sxs-lookup"><span data-stu-id="a6271-271">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="a6271-272">Depois que tudo está configurado, é fácil adicionar instruções de registro em log ao código.</span><span class="sxs-lookup"><span data-stu-id="a6271-272">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="a6271-273">Por exemplo, aqui está o método que pesquisa um pacote.</span><span class="sxs-lookup"><span data-stu-id="a6271-273">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="a6271-274">Ele faz duas chamadas para o método `ILogger.info`.</span><span class="sxs-lookup"><span data-stu-id="a6271-274">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="a6271-275">Não precisamos incluir a ID de correlação em instruções de registro em log, porque isso é feito automaticamente pela função de middleware.</span><span class="sxs-lookup"><span data-stu-id="a6271-275">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="a6271-276">Isso torna o código de log mais limpo e reduz a chance de que um desenvolvedor esqueça de incluir a ID de correlação.</span><span class="sxs-lookup"><span data-stu-id="a6271-276">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="a6271-277">Já que todas as instruções de registro em log usam a interface `ILogger` abstrata, seria fácil substituir a implementação do agente posteriormente.</span><span class="sxs-lookup"><span data-stu-id="a6271-277">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="a6271-278">Integração e entrega contínuas</span><span class="sxs-lookup"><span data-stu-id="a6271-278">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/
---
title: Comunicação entre serviços nos microsserviços
description: Comunicação entre serviços nos microsserviços
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: aff2fb7b2be25ca32d6224cee15363880cfb1488
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/29/2017
ms.locfileid: "27549120"
---
# <a name="designing-microservices-interservice-communication"></a><span data-ttu-id="3f202-103">Criando microsserviços: comunicação entre serviços</span><span class="sxs-lookup"><span data-stu-id="3f202-103">Designing microservices: Interservice communication</span></span>

<span data-ttu-id="3f202-104">A comunicação entre os microsserviços deve ser eficiente e robusta.</span><span class="sxs-lookup"><span data-stu-id="3f202-104">Communication between microservices must be efficient and robust.</span></span> <span data-ttu-id="3f202-105">Com vários serviços pequenos interagindo para concluir uma única transação, isso pode ser um desafio.</span><span class="sxs-lookup"><span data-stu-id="3f202-105">With lots of small services interacting to complete a single transaction, this can be a challenge.</span></span> <span data-ttu-id="3f202-106">Neste capítulo, vamos examinar as compensações entre o sistema de mensagens assíncrono em relação às APIs síncronas.</span><span class="sxs-lookup"><span data-stu-id="3f202-106">In this chapter, we look at the tradeoffs between asynchronous messaging versus synchronous APIs.</span></span> <span data-ttu-id="3f202-107">Em seguida, vamos observar alguns dos desafios ao criar uma comunicação entre serviços resiliente e a função que uma malha de serviço pode desempenhar.</span><span class="sxs-lookup"><span data-stu-id="3f202-107">Then we look at some of the challenges in designing resilient interservice communication, and the role that a service mesh can play.</span></span>

![](./images/interservice-communication.png)

## <a name="challenges"></a><span data-ttu-id="3f202-108">Desafios</span><span class="sxs-lookup"><span data-stu-id="3f202-108">Challenges</span></span> 

<span data-ttu-id="3f202-109">Aqui estão alguns dos principais desafios decorrentes da comunicação de serviço a serviço.</span><span class="sxs-lookup"><span data-stu-id="3f202-109">Here are some of the main challenges arising from service-to-service communication.</span></span> <span data-ttu-id="3f202-110">As malhas de serviço, descritas mais adiante neste capítulo, são projetadas para lidar com muitos desses desafios.</span><span class="sxs-lookup"><span data-stu-id="3f202-110">Service meshes, described later in this chapter, are designed to handle many of these challenges.</span></span>

<span data-ttu-id="3f202-111">**Resiliência.**</span><span class="sxs-lookup"><span data-stu-id="3f202-111">**Resiliency.**</span></span> <span data-ttu-id="3f202-112">Pode haver dezenas ou até mesmo centenas de instâncias de qualquer microsserviço.</span><span class="sxs-lookup"><span data-stu-id="3f202-112">There may be dozens or even hundreds of instances of any given microservice.</span></span> <span data-ttu-id="3f202-113">Uma instância pode falhar por vários motivos.</span><span class="sxs-lookup"><span data-stu-id="3f202-113">An instance can fail for any number of reasons.</span></span> <span data-ttu-id="3f202-114">Pode haver uma falha no nível de nó, como uma falha de hardware ou uma reinicialização da VM.</span><span class="sxs-lookup"><span data-stu-id="3f202-114">There can be a node-level failure, such as a hardware failure or a VM reboot.</span></span> <span data-ttu-id="3f202-115">Uma instância pode falhar ou ficar sobrecarregada com solicitações e, assim, impossibilitada de processar solicitações novas.</span><span class="sxs-lookup"><span data-stu-id="3f202-115">An instance might crash, or be overwhelmed with requests and unable to process any new requests.</span></span> <span data-ttu-id="3f202-116">Qualquer um desses eventos pode fazer com que uma chamada de rede falhe.</span><span class="sxs-lookup"><span data-stu-id="3f202-116">Any of these events can cause a network call to fail.</span></span> <span data-ttu-id="3f202-117">Há dois padrões de design que podem ajudar a tornar as chamadas de rede de serviço a serviço mais resilientes:</span><span class="sxs-lookup"><span data-stu-id="3f202-117">There are two design patterns that can help make service-to-service network calls more resilient:</span></span>

- <span data-ttu-id="3f202-118">**[Repetição](../patterns/retry.md)**.</span><span class="sxs-lookup"><span data-stu-id="3f202-118">**[Retry](../patterns/retry.md)**.</span></span> <span data-ttu-id="3f202-119">Uma chamada de rede pode falhar por causa de uma falha temporária que desaparece por si só.</span><span class="sxs-lookup"><span data-stu-id="3f202-119">A network call may fail because of a transient fault that goes away by itself.</span></span> <span data-ttu-id="3f202-120">Em vez de falhar totalmente, o autor da chamada normalmente deverá repetir a operação um determinado número de vezes ou até que um período de tempo limite configurado expire.</span><span class="sxs-lookup"><span data-stu-id="3f202-120">Rather than fail outright, the caller should typically retry the operation a certain number of times, or until a configured time-out period elapses.</span></span> <span data-ttu-id="3f202-121">No entanto, se uma operação não for idempotente, as repetições poderão causar efeitos colaterais não intencionais.</span><span class="sxs-lookup"><span data-stu-id="3f202-121">However, if an operation is not idempotent, retries can cause unintended side effects.</span></span> <span data-ttu-id="3f202-122">A chamada original talvez seja bem-sucedida, mas o autor da chamada nunca receberá uma resposta.</span><span class="sxs-lookup"><span data-stu-id="3f202-122">The original call might succeed, but the caller never gets a response.</span></span> <span data-ttu-id="3f202-123">Se o autor da chamada fizer novas tentativas, a operação poderá ser invocada duas vezes.</span><span class="sxs-lookup"><span data-stu-id="3f202-123">If the caller retries, the operation may be invoked twice.</span></span> <span data-ttu-id="3f202-124">Em geral, não é seguro repetir os métodos POST ou PATCH, uma vez que não há garantias de que eles sejam idempotentes.</span><span class="sxs-lookup"><span data-stu-id="3f202-124">Generally, it's not safe to retry POST or PATCH methods, because these are not guaranteed to be idempotent.</span></span>

- <span data-ttu-id="3f202-125">**[Disjuntor](../patterns/circuit-breaker.md)**.</span><span class="sxs-lookup"><span data-stu-id="3f202-125">**[Circuit Breaker](../patterns/circuit-breaker.md)**.</span></span> <span data-ttu-id="3f202-126">Um número excessivo de solicitações com falha pode causar um gargalo, já que as solicitações pendentes se acumulam na fila.</span><span class="sxs-lookup"><span data-stu-id="3f202-126">Too many failed requests can cause a bottleneck, as pending requests accumulate in the queue.</span></span> <span data-ttu-id="3f202-127">Essas solicitações bloqueadas podem reter recursos críticos do sistema, como memória, threads, conexões de banco de dados e outros, e provocar falhas em cascata.</span><span class="sxs-lookup"><span data-stu-id="3f202-127">These blocked requests might hold critical system resources such as memory, threads, database connections, and so on, which can cause cascading failures.</span></span> <span data-ttu-id="3f202-128">O uso do padrão de Disjuntor pode impedir que um serviço tente repetir várias vezes uma operação que provavelmente falhará.</span><span class="sxs-lookup"><span data-stu-id="3f202-128">The Circuit Breaker pattern can prevent a service from repeatedly trying an operation that is likely to fail.</span></span> 

<span data-ttu-id="3f202-129">**Balanceamento de carga**.</span><span class="sxs-lookup"><span data-stu-id="3f202-129">**Load balancing**.</span></span> <span data-ttu-id="3f202-130">Quando o serviço “A” chama o serviço “B”, a solicitação deve alcançar uma instância em execução do serviço “B”.</span><span class="sxs-lookup"><span data-stu-id="3f202-130">When service "A" calls service "B", the request must reach a running instance of service "B".</span></span> <span data-ttu-id="3f202-131">No Kubernetes, o tipo de recurso `Service` fornece um endereço IP estável para um grupo de pods.</span><span class="sxs-lookup"><span data-stu-id="3f202-131">In Kubernetes, the `Service` resource type provides a stable IP address for a group of pods.</span></span> <span data-ttu-id="3f202-132">O tráfego de rede para o endereço IP do serviço é encaminhado para um pod por meio de regras de iptable.</span><span class="sxs-lookup"><span data-stu-id="3f202-132">Network traffic to the service's IP address gets forwarded to a pod by means of iptable rules.</span></span> <span data-ttu-id="3f202-133">Por padrão, um pod aleatório é escolhido.</span><span class="sxs-lookup"><span data-stu-id="3f202-133">By default, a random pod is chosen.</span></span> <span data-ttu-id="3f202-134">Uma malha de serviço (veja abaixo) pode fornecer algoritmos de balanceamento de carga mais inteligentes com base na latência observada ou em outras métricas.</span><span class="sxs-lookup"><span data-stu-id="3f202-134">A service mesh (see below) can provide more intelligent load balancing algorithms based on observed latency or other metrics.</span></span>

<span data-ttu-id="3f202-135">**Rastreamento distribuído**.</span><span class="sxs-lookup"><span data-stu-id="3f202-135">**Distributed tracing**.</span></span> <span data-ttu-id="3f202-136">Uma única transação pode abranger vários serviços.</span><span class="sxs-lookup"><span data-stu-id="3f202-136">A single transaction may span multiple services.</span></span> <span data-ttu-id="3f202-137">Isso pode dificultar o monitoramento do desempenho geral e da integridade do sistema.</span><span class="sxs-lookup"><span data-stu-id="3f202-137">That can make it hard to monitor the overall performance and health of the system.</span></span> <span data-ttu-id="3f202-138">Mesmo que cada serviço gere logs e métricas, sem alguma forma associá-los, eles serão de utilidade limitada.</span><span class="sxs-lookup"><span data-stu-id="3f202-138">Even if every service generates logs and metrics, without some way to tie them together, they are of limited use.</span></span> <span data-ttu-id="3f202-139">O capítulo [Log e monitoramento](./logging-monitoring.md) fala mais sobre o rastreamento distribuído, mas nós o mencionamos aqui como um desafio.</span><span class="sxs-lookup"><span data-stu-id="3f202-139">The chapter [Logging and monitoring](./logging-monitoring.md) talks more about distributed tracing, but we mention it here as a challenge.</span></span>

<span data-ttu-id="3f202-140">**Controle de versão do serviço**.</span><span class="sxs-lookup"><span data-stu-id="3f202-140">**Service versioning**.</span></span> <span data-ttu-id="3f202-141">Quando uma equipe implanta uma nova versão de um serviço, ela deve evitar a interrupção de qualquer outro serviço ou cliente externo que dependa dele.</span><span class="sxs-lookup"><span data-stu-id="3f202-141">When a team deploys a new version of a service, they must avoid breaking any other services or external clients that depend on it.</span></span> <span data-ttu-id="3f202-142">Além disso, talvez você queira executar várias versões de uma serviço lado a lado e rotear solicitações para uma versão específica.</span><span class="sxs-lookup"><span data-stu-id="3f202-142">In addition, you might want to run multiple versions of a service side-by-side, and route requests to a particular version.</span></span> <span data-ttu-id="3f202-143">Consulte [API Versioning](./api-design.md#api-versioning) (Controle de versão da API) para conferir mais discussões sobre esse problema.</span><span class="sxs-lookup"><span data-stu-id="3f202-143">See [API Versioning](./api-design.md#api-versioning) for more discussion of this issue.</span></span>

<span data-ttu-id="3f202-144">**Criptografia de TLS e autenticação de TLS mútua**.</span><span class="sxs-lookup"><span data-stu-id="3f202-144">**TLS encryption and mutual TLS authentication**.</span></span> <span data-ttu-id="3f202-145">Por motivos de segurança, convém criptografar o tráfego entre os serviços com TLS e usar a autenticação de TLS mútua para autenticar os autores de chamadas.</span><span class="sxs-lookup"><span data-stu-id="3f202-145">For security reasons, you may want to encrypt traffic between services with TLS, and use mutual TLS authentication to authenticate callers.</span></span>

## <a name="synchronous-versus-asynchronous-messaging"></a><span data-ttu-id="3f202-146">Sistema de mensagens síncrono versus assíncrono</span><span class="sxs-lookup"><span data-stu-id="3f202-146">Synchronous versus asynchronous messaging</span></span>

<span data-ttu-id="3f202-147">Há dois padrões básicos de mensagens que os microsserviços podem utilizar para se comunicarem com outros microsserviços.</span><span class="sxs-lookup"><span data-stu-id="3f202-147">There are two basic messaging patterns that microservices can use to communicate with other microservices.</span></span> 

1. <span data-ttu-id="3f202-148">Comunicação síncrona.</span><span class="sxs-lookup"><span data-stu-id="3f202-148">Synchronous communication.</span></span> <span data-ttu-id="3f202-149">Nesse padrão, um serviço chama uma API que outro serviço expõe usando um protocolo, como o HTTP ou o gRPC.</span><span class="sxs-lookup"><span data-stu-id="3f202-149">In this pattern, a service calls an API that another service exposes, using a protocol such as HTTP or gRPC.</span></span> <span data-ttu-id="3f202-150">Esta opção é um padrão de sistema de mensagens síncrono porque o autor da chamada aguarda uma resposta do receptor.</span><span class="sxs-lookup"><span data-stu-id="3f202-150">This option is a synchronous messaging pattern because the caller waits for a response from the receiver.</span></span> 

2. <span data-ttu-id="3f202-151">Transmissão de mensagens assíncronas.</span><span class="sxs-lookup"><span data-stu-id="3f202-151">Asynchronous message passing.</span></span> <span data-ttu-id="3f202-152">Nesse padrão, um serviço envia a mensagem sem aguardar uma resposta, e um ou mais serviços processam a mensagem de maneira assíncrona.</span><span class="sxs-lookup"><span data-stu-id="3f202-152">In this pattern, a service sends message without waiting for a response, and one or more services process the message asynchronously.</span></span>

<span data-ttu-id="3f202-153">É importante distinguir entre uma E/S assíncrona e um protocolo assíncrono.</span><span class="sxs-lookup"><span data-stu-id="3f202-153">It's important to distinguish between asynchronous I/O and an asynchronous protocol.</span></span> <span data-ttu-id="3f202-154">Uma E/S assíncrona indica que o thread de chamada não será bloqueado enquanto a E/S não for concluída.</span><span class="sxs-lookup"><span data-stu-id="3f202-154">Asynchronous I/O means the calling thread is not blocked while the I/O completes.</span></span> <span data-ttu-id="3f202-155">Isso é importante para o desempenho, mas é um detalhe de implementação em termos de arquitetura.</span><span class="sxs-lookup"><span data-stu-id="3f202-155">That's important for performance, but is an implementation detail in terms of the architecture.</span></span> <span data-ttu-id="3f202-156">Um protocolo assíncrono indica que o remetente não aguardará uma resposta.</span><span class="sxs-lookup"><span data-stu-id="3f202-156">An asynchronous protocol means the sender doesn't wait for a response.</span></span> <span data-ttu-id="3f202-157">O HTTP será um protocolo síncrono, mesmo que um cliente HTTP utilize a E/S assíncrona ao enviar uma solicitação.</span><span class="sxs-lookup"><span data-stu-id="3f202-157">HTTP is a synchronous protocol, even though an HTTP client may use asynchronous I/O when it sends a request.</span></span> 

<span data-ttu-id="3f202-158">Há vantagens e desvantagens para cada padrão.</span><span class="sxs-lookup"><span data-stu-id="3f202-158">There are tradeoffs to each pattern.</span></span> <span data-ttu-id="3f202-159">O paradigma de solicitação/resposta é bem compreendido, de modo que a criação de uma API pode parecer mais natural do que a criação de um sistema de mensagens.</span><span class="sxs-lookup"><span data-stu-id="3f202-159">Request/response is a well-understood paradigm, so designing an API may feel more natural than designing a messaging system.</span></span> <span data-ttu-id="3f202-160">No entanto, o sistema de mensagens assíncrono apresenta algumas vantagens que podem ser muito úteis em uma arquitetura de microsserviços:</span><span class="sxs-lookup"><span data-stu-id="3f202-160">However, asynchronous messaging has some advantages that can be very useful in a microservices architecture:</span></span>

- <span data-ttu-id="3f202-161">**Acoplamento reduzido**.</span><span class="sxs-lookup"><span data-stu-id="3f202-161">**Reduced coupling**.</span></span> <span data-ttu-id="3f202-162">O remetente da mensagem não precisa saber sobre o consumidor.</span><span class="sxs-lookup"><span data-stu-id="3f202-162">The message sender does not need to know about the consumer.</span></span> 

- <span data-ttu-id="3f202-163">**Vários assinantes**.</span><span class="sxs-lookup"><span data-stu-id="3f202-163">**Multiple subscribers**.</span></span> <span data-ttu-id="3f202-164">Ao usar um modelo pub/sub, vários consumidores podem assinar para receber eventos.</span><span class="sxs-lookup"><span data-stu-id="3f202-164">Using a pub/sub model, multiple consumers can subscribe to receive events.</span></span> <span data-ttu-id="3f202-165">Consulte [Arquitetura orientada a eventos](/azure/architecture/guide/architecture-styles/event-driven).</span><span class="sxs-lookup"><span data-stu-id="3f202-165">See [Event-driven architecture style](/azure/architecture/guide/architecture-styles/event-driven).</span></span>

- <span data-ttu-id="3f202-166">**Isolamento de falha**.</span><span class="sxs-lookup"><span data-stu-id="3f202-166">**Failure isolation**.</span></span> <span data-ttu-id="3f202-167">Se o consumidor falhar, o remetente ainda poderá enviar mensagens.</span><span class="sxs-lookup"><span data-stu-id="3f202-167">If the consumer fails, the sender can still send messages.</span></span> <span data-ttu-id="3f202-168">As mensagens serão removidas quando o consumidor recuperá-las.</span><span class="sxs-lookup"><span data-stu-id="3f202-168">The messages will be picked up when the consumer recovers.</span></span> <span data-ttu-id="3f202-169">Essa capacidade é especialmente útil em uma arquitetura de microsserviços, uma vez que cada serviço tem seu próprio ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="3f202-169">This ability is especially useful in a microservices architecture, because each service has its own lifecycle.</span></span> <span data-ttu-id="3f202-170">Um serviço pode se tornar indisponível ou ser substituído por uma versão mais recente a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="3f202-170">A service could become unavailable or be replaced with a newer version at any given time.</span></span> <span data-ttu-id="3f202-171">O sistema de mensagens assíncrono pode controlar o tempo de inatividade intermitente.</span><span class="sxs-lookup"><span data-stu-id="3f202-171">Asynchronous messaging can handle intermittent downtime.</span></span> <span data-ttu-id="3f202-172">Por outro lado, as APIs síncronas exigem que o serviço de downstream esteja disponível, ou a operação falhará.</span><span class="sxs-lookup"><span data-stu-id="3f202-172">Synchronous APIs, on the other hand, require the downstream service to be available or the operation fails.</span></span> 
 
- <span data-ttu-id="3f202-173">**Capacidade de resposta**.</span><span class="sxs-lookup"><span data-stu-id="3f202-173">**Responsiveness**.</span></span> <span data-ttu-id="3f202-174">Um serviço de upstream poderá responder mais rapidamente se ele não aguardar os serviços de downstream.</span><span class="sxs-lookup"><span data-stu-id="3f202-174">An upstream service can reply faster if it does not wait on downstream services.</span></span> <span data-ttu-id="3f202-175">Isso é especialmente útil em uma arquitetura de microsserviços.</span><span class="sxs-lookup"><span data-stu-id="3f202-175">This is especially useful in a microservices architecture.</span></span> <span data-ttu-id="3f202-176">Se houver uma cadeia de dependências de serviço (o serviço A chama o serviço B, que chama o C e assim por diante), a espera pelas chamadas síncronas poderá adicionar quantidades de latência inaceitáveis.</span><span class="sxs-lookup"><span data-stu-id="3f202-176">If there is a chain of service dependencies (service A calls B, which calls C, and so on), waiting on synchronous calls can add unacceptable amounts of latency.</span></span>

- <span data-ttu-id="3f202-177">**Nivelamento de carga**.</span><span class="sxs-lookup"><span data-stu-id="3f202-177">**Load leveling**.</span></span> <span data-ttu-id="3f202-178">Uma fila pode atuar como um buffer para nivelar a carga de trabalho, de modo que os destinatários possam processar as mensagens em seu próprio ritmo.</span><span class="sxs-lookup"><span data-stu-id="3f202-178">A queue can act as a buffer to level the workload, so that receivers can process messages at their own rate.</span></span> 

- <span data-ttu-id="3f202-179">**Fluxos de trabalho**.</span><span class="sxs-lookup"><span data-stu-id="3f202-179">**Workflows**.</span></span> <span data-ttu-id="3f202-180">As filas podem ser usadas para gerenciar um fluxo de trabalho, marcando a mensagem após cada etapa no fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="3f202-180">Queues can be used to manage a workflow, by check-pointing the message after each step in the workflow.</span></span>

<span data-ttu-id="3f202-181">No entanto, há também alguns desafios para usar o sistema de mensagens assíncrono com eficiência.</span><span class="sxs-lookup"><span data-stu-id="3f202-181">However, there are also some challenges to using asynchronous messaging effectively.</span></span>

- <span data-ttu-id="3f202-182">**Acoplamento com a infraestrutura de mensagens**.</span><span class="sxs-lookup"><span data-stu-id="3f202-182">**Coupling with the messaging infrastructure**.</span></span> <span data-ttu-id="3f202-183">O uso de uma infraestrutura de mensagens específica pode causar um acoplamento estreito com essa infraestrutura.</span><span class="sxs-lookup"><span data-stu-id="3f202-183">Using a particular messaging infrastructure may cause tight coupling with that infrastructure.</span></span> <span data-ttu-id="3f202-184">Será difícil mudar para outra infraestrutura de mensagens posteriormente.</span><span class="sxs-lookup"><span data-stu-id="3f202-184">It will be difficult to switch to another messaging infrastructure later.</span></span>

- <span data-ttu-id="3f202-185">**Latência**.</span><span class="sxs-lookup"><span data-stu-id="3f202-185">**Latency**.</span></span> <span data-ttu-id="3f202-186">A latência de ponta a ponta para uma operação poderá ser alta se as filas de mensagens forem preenchidas.</span><span class="sxs-lookup"><span data-stu-id="3f202-186">End-to-end latency for an operation may become high if the message queues fill up.</span></span>  

- <span data-ttu-id="3f202-187">**Custo**.</span><span class="sxs-lookup"><span data-stu-id="3f202-187">**Cost**.</span></span> <span data-ttu-id="3f202-188">Nas taxas de transferência altas, o custo monetário da infraestrutura de mensagens pode ser significativo.</span><span class="sxs-lookup"><span data-stu-id="3f202-188">At high throughputs, the monetary cost of the messaging infrastructure could be significant.</span></span>

- <span data-ttu-id="3f202-189">**Complexidade**.</span><span class="sxs-lookup"><span data-stu-id="3f202-189">**Complexity**.</span></span> <span data-ttu-id="3f202-190">Controlar o sistema de mensagens assíncrono não é uma tarefa fácil.</span><span class="sxs-lookup"><span data-stu-id="3f202-190">Handling asynchronous messaging is not a trivial task.</span></span> <span data-ttu-id="3f202-191">Por exemplo, você deve lidar com mensagens duplicadas, seja ao eliminar a duplicação ou ao tornar as operações idempotentes.</span><span class="sxs-lookup"><span data-stu-id="3f202-191">For example, you must handle duplicated messages, either by de-duplicating or by making operations idempotent.</span></span> <span data-ttu-id="3f202-192">Também é difícil implementar a semântica de solicitação-resposta usando o sistema de mensagens assíncrono.</span><span class="sxs-lookup"><span data-stu-id="3f202-192">It's also hard to implement request-response semantics using asynchronous messaging.</span></span> <span data-ttu-id="3f202-193">Para enviar uma resposta, você precisa de outra fila, além de uma maneira de correlacionar as mensagens de solicitação e de resposta.</span><span class="sxs-lookup"><span data-stu-id="3f202-193">To send a response, you need another queue, plus a way to correlate request and response messages.</span></span>

- <span data-ttu-id="3f202-194">**Taxa de transferência**.</span><span class="sxs-lookup"><span data-stu-id="3f202-194">**Throughput**.</span></span> <span data-ttu-id="3f202-195">Se as mensagens exigirem uma *semântica de fila*, a fila poderá se tornar um gargalo no sistema.</span><span class="sxs-lookup"><span data-stu-id="3f202-195">If messages require *queue semantics*, the queue can become a bottleneck in the system.</span></span> <span data-ttu-id="3f202-196">Cada mensagem exige, pelo menos, uma operação de fila e uma operação de remoção da fila.</span><span class="sxs-lookup"><span data-stu-id="3f202-196">Each message requires at least one queue operation and one dequeue operation.</span></span> <span data-ttu-id="3f202-197">Além disso, a semântica de fila geralmente exige algum tipo de bloqueio na infraestrutura de mensagens.</span><span class="sxs-lookup"><span data-stu-id="3f202-197">Moreover, queue semantics generally require some kind of locking inside the messaging infrastructure.</span></span> <span data-ttu-id="3f202-198">Se a fila for um serviço gerenciado, poderá haver latência adicional, uma vez que a fila é externa à rede virtual do cluster.</span><span class="sxs-lookup"><span data-stu-id="3f202-198">If the queue is a managed service, there may be additional latency, because the queue is external to the cluster's virtual network.</span></span> <span data-ttu-id="3f202-199">Você pode mitigar esses problemas por meio de mensagens de lote, mas isso complica o código.</span><span class="sxs-lookup"><span data-stu-id="3f202-199">You can mitigate these issues by batching messages, but that complicates the code.</span></span> <span data-ttu-id="3f202-200">Se as mensagens não exigirem a semântica de fila, você poderá usar o *fluxo* de evento em vez de uma fila.</span><span class="sxs-lookup"><span data-stu-id="3f202-200">If the messages don't require queue semantics, you might be able to use an event *stream* instead of a queue.</span></span> <span data-ttu-id="3f202-201">Para obter mais informações, consulte [Arquitetura orientada a eventos](../guide/architecture-styles/event-driven.md).</span><span class="sxs-lookup"><span data-stu-id="3f202-201">For more information, see [Event-driven architectural style](../guide/architecture-styles/event-driven.md).</span></span>  

## <a name="drone-delivery-choosing-the-messaging-patterns"></a><span data-ttu-id="3f202-202">Entrega por drone: escolhendo os padrões de mensagens</span><span class="sxs-lookup"><span data-stu-id="3f202-202">Drone Delivery: Choosing the messaging patterns</span></span>

<span data-ttu-id="3f202-203">Com essas considerações em mente, a equipe de desenvolvimento fez as seguintes opções de design para o aplicativo de entrega por drone</span><span class="sxs-lookup"><span data-stu-id="3f202-203">With these considerations in mind, the development team made the following design choices for the Drone Delivery application</span></span>

- <span data-ttu-id="3f202-204">O serviço Ingestão expõe uma API de REST pública que os aplicativos clientes usam para agendar, atualizar ou cancelar as entregas.</span><span class="sxs-lookup"><span data-stu-id="3f202-204">The Ingestion service exposes a public REST API that client applications use to schedule, update, or cancel deliveries.</span></span>

- <span data-ttu-id="3f202-205">O serviço Ingestão usa os Hubs de Eventos para enviar mensagens assíncronas para o serviço Agendador.</span><span class="sxs-lookup"><span data-stu-id="3f202-205">The Ingestion service uses Event Hubs to send asynchronous messages to the Scheduler service.</span></span> <span data-ttu-id="3f202-206">As mensagens assíncronas são necessárias para implementar o nivelamento de carregamento que é necessário para a ingestão de dados.</span><span class="sxs-lookup"><span data-stu-id="3f202-206">Asynchronous messages are necessary to implement the load-leveling that is required for ingestion.</span></span> <span data-ttu-id="3f202-207">Para obter detalhes sobre como os serviços Ingestão e Agendador interagem, consulte [Ingestion and workflow][ingestion-workflow] (Ingestão de dados e fluxo de trabalho).</span><span class="sxs-lookup"><span data-stu-id="3f202-207">For details on how the Ingestion and Scheduler services interact, see [Ingestion and workflow][ingestion-workflow].</span></span>

- <span data-ttu-id="3f202-208">Os serviços Contabilidade, Entrega, Empacotamento, Drone e Transporte de Terceiros expõem as APIs de REST internas.</span><span class="sxs-lookup"><span data-stu-id="3f202-208">The Account, Delivery, Package, Drone, and Third-party Transport services all expose internal REST APIs.</span></span> <span data-ttu-id="3f202-209">O serviço Agendador chama essas APIs para executar uma solicitação de usuário.</span><span class="sxs-lookup"><span data-stu-id="3f202-209">The Scheduler service calls these APIs to carry out a user request.</span></span> <span data-ttu-id="3f202-210">Um motivo para usar as APIs síncronas é que o Agendador precisa obter uma resposta de cada um dos serviços de downstream.</span><span class="sxs-lookup"><span data-stu-id="3f202-210">One reason to use synchronous APIs is that the Scheduler needs to get a response from each of the downstream services.</span></span> <span data-ttu-id="3f202-211">Uma falha em qualquer um dos serviços de downstream indica que toda a operação falhou.</span><span class="sxs-lookup"><span data-stu-id="3f202-211">A failure in any of the downstream services means the entire operation failed.</span></span> <span data-ttu-id="3f202-212">No entanto, um problema potencial é a quantidade de latência que é introduzida ao chamar os serviços de back-end.</span><span class="sxs-lookup"><span data-stu-id="3f202-212">However, a potential issue is the amount of latency that is introduced by calling the backend services.</span></span> 

- <span data-ttu-id="3f202-213">Se algum serviço de downstream tiver uma falha não transitória, toda a transação deverá ser marcada como com falha.</span><span class="sxs-lookup"><span data-stu-id="3f202-213">If any downstream service has a non-transient failure, the entire transaction should be marked as failed.</span></span> <span data-ttu-id="3f202-214">Para lidar com este caso, o serviço Agendador envia uma mensagem assíncrona para o Supervisor, para que o Supervisor possa agendar transações de compensação, conforme descrito no capítulo [Ingestion and workflow][ingestion-workflow] (Ingestão de dados e fluxo de trabalho).</span><span class="sxs-lookup"><span data-stu-id="3f202-214">To handle this case, the Scheduler service sends an asynchronous message to the Supervisor, so that the Supervisor can schedule compensating transactions, as described in the chapter [Ingestion and workflow][ingestion-workflow].</span></span>   

- <span data-ttu-id="3f202-215">O serviço Entrega expõe uma API pública que os clientes podem usar para obter o status de uma entrega.</span><span class="sxs-lookup"><span data-stu-id="3f202-215">The Delivery service exposes a public API that clients can use to get the status of a delivery.</span></span> <span data-ttu-id="3f202-216">No capítulo [Gateway da API](./gateway.md), discutiremos como um gateway de API pode ocultar os serviços subjacentes do cliente, para que o cliente não precise saber quais serviços expõem as APIs.</span><span class="sxs-lookup"><span data-stu-id="3f202-216">In the chapter [API gateway](./gateway.md), we discuss how an API gateway can hide the underlying services from the client, so the client doesn't need to know which services expose which APIs.</span></span> 

- <span data-ttu-id="3f202-217">Enquanto um drone está em trânsito, o serviço Drone envia eventos que contêm a localização e o status atual do drone.</span><span class="sxs-lookup"><span data-stu-id="3f202-217">While a drone is in flight, the Drone service sends events that contain the drone's current location and status.</span></span> <span data-ttu-id="3f202-218">O serviço Entrega segue esses eventos para acompanhar o status de uma entrega.</span><span class="sxs-lookup"><span data-stu-id="3f202-218">The Delivery service listens to these events in order to track the status of a delivery.</span></span>

- <span data-ttu-id="3f202-219">Quando o status de uma entrega é alterado, o serviço Entrega envia um evento de status de entrega, como `DeliveryCreated` ou `DeliveryCompleted`.</span><span class="sxs-lookup"><span data-stu-id="3f202-219">When the status of a delivery changes, the Delivery service sends a delivery status event, such as `DeliveryCreated` or `DeliveryCompleted`.</span></span> <span data-ttu-id="3f202-220">Qualquer serviço pode assinar esses eventos.</span><span class="sxs-lookup"><span data-stu-id="3f202-220">Any service can subscribe to these events.</span></span> <span data-ttu-id="3f202-221">No projeto atual, o serviço Entrega é o único assinante, mas poderá haver outros assinantes posteriormente.</span><span class="sxs-lookup"><span data-stu-id="3f202-221">In the current design, the Delivery service is the only subscriber, but there might be other subscribers later.</span></span> <span data-ttu-id="3f202-222">Por exemplo, os eventos poderão ir para um serviço de análise em tempo real.</span><span class="sxs-lookup"><span data-stu-id="3f202-222">For example, the events might go to a real-time analytics service.</span></span> <span data-ttu-id="3f202-223">E, uma vez que o Agendador não precisa aguardar uma resposta, a adição de mais assinantes não afeta o caminho principal do fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="3f202-223">And because the Scheduler doesn't have to wait for a response, adding more subscribers doesn't affect the main workflow path.</span></span>

![](./images/drone-communication.png)

<span data-ttu-id="3f202-224">Observe que os eventos de status de entrega são derivados de eventos de localização de drone.</span><span class="sxs-lookup"><span data-stu-id="3f202-224">Notice that delivery status events are derived from drone location events.</span></span> <span data-ttu-id="3f202-225">Por exemplo, quando um drone alcança um local de entrega e solta um pacote, o serviço Entrega converte isso em um evento DeliveryCompleted.</span><span class="sxs-lookup"><span data-stu-id="3f202-225">For example, when a drone reaches a delivery location and drops off a package, the Delivery service translates this into a DeliveryCompleted event.</span></span> <span data-ttu-id="3f202-226">Este é um exemplo de raciocínio em termos de modelos de domínio.</span><span class="sxs-lookup"><span data-stu-id="3f202-226">This is an example of thinking in terms of domain models.</span></span> <span data-ttu-id="3f202-227">Conforme descrito anteriormente, o Gerenciamento de Drone pertence a um contexto limitado separado.</span><span class="sxs-lookup"><span data-stu-id="3f202-227">As described earlier, Drone Management belongs in a separate bounded context.</span></span> <span data-ttu-id="3f202-228">Os eventos de drone transmitem a localização física de um drone.</span><span class="sxs-lookup"><span data-stu-id="3f202-228">The drone events convey the physical location of a drone.</span></span> <span data-ttu-id="3f202-229">Por outro lado, os eventos de entrega representam as alterações no status de uma entrega, que é uma entidade de negócios diferente.</span><span class="sxs-lookup"><span data-stu-id="3f202-229">The delivery events, on the other hand, represent changes in the status of a delivery, which is a different business entity.</span></span>

## <a name="using-a-service-mesh"></a><span data-ttu-id="3f202-230">Usando uma malha de serviço</span><span class="sxs-lookup"><span data-stu-id="3f202-230">Using a service mesh</span></span>

<span data-ttu-id="3f202-231">Uma *malha do serviço* é uma camada de software que gerencia a comunicação de serviço a serviço.</span><span class="sxs-lookup"><span data-stu-id="3f202-231">A *service mesh* is a software layer that handles service-to-service communication.</span></span> <span data-ttu-id="3f202-232">As malhas de serviço são projetadas para abordar muitas das preocupações listadas na seção anterior e para levar a responsabilidade por essas preocupações para longe dos próprios microsserviços e para dentro de uma camada compartilhada.</span><span class="sxs-lookup"><span data-stu-id="3f202-232">Service meshes are designed to address many of the concerns listed in the previous section, and to move responsibility for these concerns away from the microservices themselves and into a shared layer.</span></span> <span data-ttu-id="3f202-233">A malha de serviço atua como um proxy que intercepta a comunicação de rede entre os microsserviços no cluster.</span><span class="sxs-lookup"><span data-stu-id="3f202-233">The service mesh acts as a proxy that intercepts network communication between microservices in the cluster.</span></span> 

> [!NOTE]
> <span data-ttu-id="3f202-234">A malha de serviço é um exemplo do [Padrão embaixador](../patterns/ambassador.md) &mdash;, um serviço auxiliar que envia as solicitações de rede em nome do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3f202-234">Service mesh is an example of the [Ambassador pattern](../patterns/ambassador.md) &mdash; a helper service that sends network requests on behalf of the application.</span></span> 

<span data-ttu-id="3f202-235">No momento, as principais opções para uma malha de serviço no Kubernetes são [linkerd](https://linkerd.io/) e [Istio](https://istio.io/).</span><span class="sxs-lookup"><span data-stu-id="3f202-235">Right now, the main options for a service mesh in Kubernetes are [linkerd](https://linkerd.io/) and [Istio](https://istio.io/).</span></span> <span data-ttu-id="3f202-236">Ambas as tecnologias estão evoluindo rapidamente.</span><span class="sxs-lookup"><span data-stu-id="3f202-236">Both of these technologies are evolving rapidly.</span></span> <span data-ttu-id="3f202-237">No momento em que escrevemos este guia, a versão mais recente do Istio é a 0,2, portanto, ele ainda é muito novo.</span><span class="sxs-lookup"><span data-stu-id="3f202-237">At the time we wrote this guide, the latest Istio release is 0.2, so it is still very new.</span></span> <span data-ttu-id="3f202-238">No entanto, alguns recursos que o linkerd e o Istio têm em comum incluem:</span><span class="sxs-lookup"><span data-stu-id="3f202-238">However, some features that both linkerd and Istio have in common include:</span></span> 

- <span data-ttu-id="3f202-239">O balanceamento de carga no nível da sessão, com base nas latências observadas ou no número de solicitações pendentes.</span><span class="sxs-lookup"><span data-stu-id="3f202-239">Load balancing at the session level, based on observed latencies or number of outstanding requests.</span></span> <span data-ttu-id="3f202-240">Isso pode melhorar o desempenho em relação ao balanceamento de carga da camada 4 fornecido pelo Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="3f202-240">This can improve performance over the layer-4 load balancing that is provided by Kubernetes.</span></span> 

- <span data-ttu-id="3f202-241">Roteamento da camada 7 com base no caminho da URL, no cabeçalho de Host, na versão da API ou em outras regras no nível de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3f202-241">Layer-7 routing based on URL path, Host header, API version, or other application-level rules.</span></span>

- <span data-ttu-id="3f202-242">Repetição de solicitações com falha.</span><span class="sxs-lookup"><span data-stu-id="3f202-242">Retry of failed requests.</span></span> <span data-ttu-id="3f202-243">Uma malha de serviço reconhece os códigos de erro de HTTP e pode repetir automaticamente as solicitações com falha.</span><span class="sxs-lookup"><span data-stu-id="3f202-243">A service mesh understands HTTP error codes, and can automatically retry failed requests.</span></span> <span data-ttu-id="3f202-244">Você pode configurar o número máximo de repetições, juntamente com um período de tempo limite para delimitar a latência máxima.</span><span class="sxs-lookup"><span data-stu-id="3f202-244">You can configure that maximum number of retries, along with a timeout period in order to bound the maximum latency.</span></span> 

- <span data-ttu-id="3f202-245">Interrupção de circuito.</span><span class="sxs-lookup"><span data-stu-id="3f202-245">Circuit breaking.</span></span> <span data-ttu-id="3f202-246">Se uma instância falhar de modo consistente nas solicitações, a malha de serviço a marcará temporariamente como indisponível.</span><span class="sxs-lookup"><span data-stu-id="3f202-246">If an instance consistently fails requests, the service mesh will temporarily mark it as unavailable.</span></span> <span data-ttu-id="3f202-247">Após um período de retirada, ele tentará a instância novamente.</span><span class="sxs-lookup"><span data-stu-id="3f202-247">After a backoff period, it will try the instance again.</span></span> <span data-ttu-id="3f202-248">Você pode configurar o disjuntor com base em vários critérios, como o número de falhas consecutivas.</span><span class="sxs-lookup"><span data-stu-id="3f202-248">You can configure the circuit breaker based on various criteria, such as the number of consecutive failures,</span></span>  

- <span data-ttu-id="3f202-249">A malha de serviço captura métricas sobre chamadas entre serviços, como o volume de solicitação, a latência, as taxas de êxito e de erro e os tamanhos das respostas.</span><span class="sxs-lookup"><span data-stu-id="3f202-249">Service mesh captures metrics about interservice calls, such as the request volume, latency, error and success rates, and response sizes.</span></span> <span data-ttu-id="3f202-250">A malha de serviço também habilita o rastreamento distribuído ao adicionar informações de correlação para cada salto em uma solicitação.</span><span class="sxs-lookup"><span data-stu-id="3f202-250">The service mesh also enables distributed tracing by adding correlation information for each hop in a request.</span></span>

- <span data-ttu-id="3f202-251">Autenticação de TLS mútua para chamadas de serviço a serviço.</span><span class="sxs-lookup"><span data-stu-id="3f202-251">Mutual TLS Authentication for service-to-service calls.</span></span>

<span data-ttu-id="3f202-252">Você precisa de uma malha de serviço?</span><span class="sxs-lookup"><span data-stu-id="3f202-252">Do you need a service mesh?</span></span> <span data-ttu-id="3f202-253">O valor agregado a um sistema distribuído é, de fato, interessante.</span><span class="sxs-lookup"><span data-stu-id="3f202-253">The value they add to a distributed system is certainly compelling.</span></span> <span data-ttu-id="3f202-254">Se não tiver uma malha de serviço, você precisará considerar cada um dos desafios mencionados no início deste capítulo.</span><span class="sxs-lookup"><span data-stu-id="3f202-254">If you don't have a service mesh, you will need to consider each of the challenges mentioned at the beginning of the chapter.</span></span> <span data-ttu-id="3f202-255">Você pode resolver problemas de repetição, no disjuntor e de rastreamento distribuído sem uma malha de serviço, mas uma malha do serviço transfere essas problemas dos serviços individuais para uma camada dedicada.</span><span class="sxs-lookup"><span data-stu-id="3f202-255">You can solve problems like retry, circuit breaker, and distributed tracing without a service mesh, but a service mesh moves these concerns out of the individual services and into a dedicated layer.</span></span> <span data-ttu-id="3f202-256">Por outro lado, a malha de serviço é uma tecnologia relativamente nova, que ainda está em desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="3f202-256">On the other hand, service meshes are a relatively new technology that is still maturing.</span></span> <span data-ttu-id="3f202-257">A implantação de uma malha de serviço adiciona complexidade à instalação e à configuração do cluster.</span><span class="sxs-lookup"><span data-stu-id="3f202-257">Deploying a service mesh adds complexity to the setup and configuration of the cluster.</span></span> <span data-ttu-id="3f202-258">Pode haver implicações de desempenho porque as solicitações agora são roteadas por meio do proxy da malha de serviço e também porque os serviços extras agora estão sendo executados em cada nó no cluster.</span><span class="sxs-lookup"><span data-stu-id="3f202-258">There may be performance implications, because requests now get routed through the service mesh proxy, and because extra services are now running on every node in the cluster.</span></span> <span data-ttu-id="3f202-259">Você deve realizar testes de carga e de desempenho minuciosos antes de implementar uma malha de serviço na produção.</span><span class="sxs-lookup"><span data-stu-id="3f202-259">You should do thorough performance and load testing before deploying a service mesh in production.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="3f202-260">Design de API</span><span class="sxs-lookup"><span data-stu-id="3f202-260">API design</span></span>](./api-design.md)

<!-- links -->

[ingestion-workflow]: ./ingestion-workflow.md

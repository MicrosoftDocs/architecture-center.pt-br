---
title: "CI/CD para microsserviços"
description: "Integração contínua e a entrega contínua para microsserviços"
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 7d8a81b7bc236e50d722a68a0115b9220d4e094f
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/12/2017
---
# <a name="designing-microservices-continuous-integration"></a><span data-ttu-id="66e02-103">Criando microsserviços: integração contínua</span><span class="sxs-lookup"><span data-stu-id="66e02-103">Designing microservices: Continuous integration</span></span>

<span data-ttu-id="66e02-104">CI/CD (integração contínua e entrega contínua) são um requisito fundamental para alcançar êxito com microsserviços.</span><span class="sxs-lookup"><span data-stu-id="66e02-104">Continuous integration and continuous delivery (CI/CD) are a key requirement for achieving success with microservices.</span></span> <span data-ttu-id="66e02-105">Sem um bom processo de CI/CD, você não obterá a agilidade que os microsserviços prometem.</span><span class="sxs-lookup"><span data-stu-id="66e02-105">Without a good CI/CD process, you will not achieve the agility that microservices promise.</span></span> <span data-ttu-id="66e02-106">Alguns dos desafios de CI/CD para microsserviços são oriundos de se ter várias bases de código e ambientes de build heterogêneos para os diversos serviços.</span><span class="sxs-lookup"><span data-stu-id="66e02-106">Some of the CI/CD challenges for microservices arise from having multiple code bases and heterogenous build environments for the various services.</span></span> <span data-ttu-id="66e02-107">Este capítulo descreve os desafios e recomenda algumas abordagens para o problema.</span><span class="sxs-lookup"><span data-stu-id="66e02-107">This chapter describes the challenges and recommends some approaches to the problem.</span></span>

![](./images/ci-cd.png)

<span data-ttu-id="66e02-108">Ciclos de lançamento mais rápidos são um dos maiores motivos para se adotar uma arquitetura de microsserviços.</span><span class="sxs-lookup"><span data-stu-id="66e02-108">Faster release cycles are one of the biggest reasons to adopt a microservices architecture.</span></span> 

<span data-ttu-id="66e02-109">Em um aplicativo totalmente monolítico, há um único pipeline de build cuja saída é o executável do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="66e02-109">In a purely monolithic application, there is a single build pipeline whose output is the application executable.</span></span> <span data-ttu-id="66e02-110">Todo o trabalho de desenvolvimento alimenta este pipeline.</span><span class="sxs-lookup"><span data-stu-id="66e02-110">All development work feeds into this pipeline.</span></span> <span data-ttu-id="66e02-111">Se for encontrado um bug de alta prioridade, uma correção deverá ser integrada, testada e publicada, o que poderá atrasar o lançamento dos novos recursos.</span><span class="sxs-lookup"><span data-stu-id="66e02-111">If a high-priority bug is found, a fix must be integrated, tested, and published, which can delay the release of new features.</span></span> <span data-ttu-id="66e02-112">É verdade que você pode atenuar esses problemas com módulos bem fatorados e usando ramificações de recursos para minimizar o impacto de alterações de código.</span><span class="sxs-lookup"><span data-stu-id="66e02-112">It's true that you can mitigate these problems by having well-factored modules and using feature branches to minimize the impact of code changes.</span></span> <span data-ttu-id="66e02-113">Mas conforme o aplicativo se torna mais complexo e mais recursos são adicionados, o processo de liberação para um monolito tende a se tornar mais frágil e suscetível a interrupção.</span><span class="sxs-lookup"><span data-stu-id="66e02-113">But as the application grows more complex, and more features are added, the release process for a monolith tends to become more brittle and likely to break.</span></span> 

<span data-ttu-id="66e02-114">Seguindo a filosofia de microsserviços, nunca deverá haver uma versão de treinamento longa em que todas as equipes precisam se mobilizar.</span><span class="sxs-lookup"><span data-stu-id="66e02-114">Following the microservices philosophy, there should never be a long release train where every team has to get in line.</span></span> <span data-ttu-id="66e02-115">A equipe que cria o serviço "A" pode lançar uma atualização a qualquer momento, sem esperar que as alterações no serviço "B" sejam mescladas, testadas e implantadas.</span><span class="sxs-lookup"><span data-stu-id="66e02-115">The team that builds service "A" can release an update at any time, without waiting for changes in service "B" to be merged, tested, and deployed.</span></span> <span data-ttu-id="66e02-116">O processo de CI/CD é essencial para tornar isso possível.</span><span class="sxs-lookup"><span data-stu-id="66e02-116">The CI/CD process is critical to making this possible.</span></span> <span data-ttu-id="66e02-117">O pipeline de lançamento deve ser automatizado e altamente confiável, para que os riscos de implantação de atualizações sejam minimizados.</span><span class="sxs-lookup"><span data-stu-id="66e02-117">Your release pipeline must be automated and highly reliable, so that the risks of deploying updates are minimized.</span></span> <span data-ttu-id="66e02-118">Se você estiver liberando para produção diariamente ou várias vezes ao dia, as regressões ou as interrupções de serviço deverão ser muito raras.</span><span class="sxs-lookup"><span data-stu-id="66e02-118">If you are releasing to production daily or multiple times a day, regressions or service disruptions must be very rare.</span></span> <span data-ttu-id="66e02-119">Ao mesmo tempo, se uma atualização inválida é implantada, você deve ter uma maneira confiável de reverter ou efetuar roll forward rapidamente para uma versão anterior de um serviço.</span><span class="sxs-lookup"><span data-stu-id="66e02-119">At the same time, if a bad update does get deployed, you must have a reliable way to quickly roll back or roll forward to a previous version of a service.</span></span>

![](./images/cicd-monolith.png)

<span data-ttu-id="66e02-120">Quando falamos sobre CI/CD, realmente falamos sobre vários processos relacionados: integração contínua, entrega contínua e implantação contínua.</span><span class="sxs-lookup"><span data-stu-id="66e02-120">When we talk about CI/CD, we are really talking about several related processes: Continuous integration, continuous delivery, and continuous deployment.</span></span>

- <span data-ttu-id="66e02-121">Integração contínua significa que as alterações de código são frequentemente mescladas à ramificação principal, usando processos de build e de teste automatizados para garantir que o código na ramificação principal tenha sempre qualidade em nível de produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-121">Continuous integration means that code changes are frequently merged into the main branch, using automated build and test processes to ensure that  code in the main branch is always production-quality.</span></span>

- <span data-ttu-id="66e02-122">Entrega contínua significa que as alterações de código que passam pelo processo de CI são publicadas automaticamente em um ambiente similar ao de produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-122">Continuous delivery means that code changes that pass the CI process are automatically published to a production-like environment.</span></span> <span data-ttu-id="66e02-123">A implantação no ambiente de produção dinâmico pode exigir aprovação manual, mas caso contrário, é automatizada.</span><span class="sxs-lookup"><span data-stu-id="66e02-123">Deployment into the live production environment may require manual approval, but is otherwise automated.</span></span> <span data-ttu-id="66e02-124">A meta é que o seu código esteja sempre *pronto* para implantação na produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-124">The goal is that your code should always be *ready* to deploy into production.</span></span>

- <span data-ttu-id="66e02-125">Implantação contínua significa que as alterações de código que passam pelo processo de CI/CD são automaticamente implantadas em produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-125">Continuous deployment means that code changes that pass the CI/CD process are automatically deployed into production.</span></span>

<span data-ttu-id="66e02-126">No contexto de Kubernetes e microsserviços, o estágio de CI trata de compilar e testar as imagens de contêiner e enviá-las por push para um registro de contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-126">In the context of Kubernetes and microservices, the CI stage is concerned with building and testing container images, and pushing those images to a container registry.</span></span> <span data-ttu-id="66e02-127">No estágio de implantação, especificações de pod são atualizadas para que a imagem de produção mais recente seja escolhida.</span><span class="sxs-lookup"><span data-stu-id="66e02-127">In the deployment stage, pod specs are updated to pick up the latest production image.</span></span>

## <a name="challenges"></a><span data-ttu-id="66e02-128">Desafios</span><span class="sxs-lookup"><span data-stu-id="66e02-128">Challenges</span></span>

- <span data-ttu-id="66e02-129">**Várias bases de código pequenas independentes**.</span><span class="sxs-lookup"><span data-stu-id="66e02-129">**Many small independent code bases**.</span></span> <span data-ttu-id="66e02-130">Cada equipe é responsável por criar seu próprio serviço, com seu próprio pipeline de build.</span><span class="sxs-lookup"><span data-stu-id="66e02-130">Each team is responsible for building its own service, with its own build pipeline.</span></span> <span data-ttu-id="66e02-131">Em algumas organizações, as equipes podem usar repositórios de código separados.</span><span class="sxs-lookup"><span data-stu-id="66e02-131">In some organizations, teams may use separate code repositories.</span></span> <span data-ttu-id="66e02-132">Isso pode levar a uma situação em que o conhecimento de como compilar o sistema é disseminado entre as equipes e ninguém na organização sabe como implantar o aplicativo inteiro.</span><span class="sxs-lookup"><span data-stu-id="66e02-132">This could lead to a situation where the knowledge of how to build the system is spread across teams, and nobody in the organization knows how to deploy the entire application.</span></span> <span data-ttu-id="66e02-133">Por exemplo, o que acontecerá em um cenário de recuperação de desastre, se você precisar implantar rapidamente para um novo cluster?</span><span class="sxs-lookup"><span data-stu-id="66e02-133">For example, what happens in a disaster recovery scenario, if you need to quickly deploy to a new cluster?</span></span>   

- <span data-ttu-id="66e02-134">**Múltiplas linguagens de programação e estruturas**.</span><span class="sxs-lookup"><span data-stu-id="66e02-134">**Multiple languages and frameworks**.</span></span> <span data-ttu-id="66e02-135">Com cada equipe usando seu próprio conjunto de tecnologias, pode ser difícil criar um processo de build único que funcione em toda a organização.</span><span class="sxs-lookup"><span data-stu-id="66e02-135">With each team using its own mix of technologies, it can be difficult to create a single build process that works across the organization.</span></span> <span data-ttu-id="66e02-136">O processo de build deve ser flexível o suficiente para que cada equipe possa adaptá-lo para sua linguagem de programação ou estrutura de preferência.</span><span class="sxs-lookup"><span data-stu-id="66e02-136">The build process must be flexible enough that every team can adapt it for their choice of language or framework.</span></span> 

- <span data-ttu-id="66e02-137">**Integração e teste de carga**.</span><span class="sxs-lookup"><span data-stu-id="66e02-137">**Integration and load testing**.</span></span> <span data-ttu-id="66e02-138">Com as equipes de liberação de atualizações em seu próprio ritmo, pode ser difícil projetar testes de ponta a ponta robustos, especialmente quando os serviços têm dependências em outros serviços.</span><span class="sxs-lookup"><span data-stu-id="66e02-138">With teams releasing updates at their own pace, it can be challenging to design robust end-to-end testing, especially when services have dependencies on other services.</span></span> <span data-ttu-id="66e02-139">Além disso, o processo de execução de um cluster de produção completo pode ser cara, portanto, é improvável que cada equipe possa executar seu próprio cluster completo em escalas de produção, apenas para teste.</span><span class="sxs-lookup"><span data-stu-id="66e02-139">Moreover, running a full production cluster can be expensive, so it's unlikely that every team will be able to run its own full cluster at production scales, just for testing.</span></span> 

- <span data-ttu-id="66e02-140">**Gerenciamento de versão**.</span><span class="sxs-lookup"><span data-stu-id="66e02-140">**Release management**.</span></span> <span data-ttu-id="66e02-141">Cada equipe deve ter a capacidade de implantar uma atualização em produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-141">Every team should have the ability to deploy an update to production.</span></span> <span data-ttu-id="66e02-142">Isso não significa que cada membro da equipe tem permissões para fazer isso.</span><span class="sxs-lookup"><span data-stu-id="66e02-142">That doesn't mean that every team member has permissions to do so.</span></span> <span data-ttu-id="66e02-143">Mas ter uma função de Gerenciador de Versão centralizada pode reduzir a velocidade das implantações.</span><span class="sxs-lookup"><span data-stu-id="66e02-143">But having a centralized Release Manager role can reduce the velocity of deployments.</span></span> <span data-ttu-id="66e02-144">Quanto mais o processo de CI/CD for automatizado e confiável, menos deverá haver necessidade de uma autoridade central.</span><span class="sxs-lookup"><span data-stu-id="66e02-144">The more that your CI/CD process is automated and reliable, the less there should be a need for a central authority.</span></span> <span data-ttu-id="66e02-145">Dito isso, você pode ter diferentes políticas para liberar atualizações dos principais recursos e correções de bugs secundários.</span><span class="sxs-lookup"><span data-stu-id="66e02-145">That said, you might have different policies for releasing major feature updates versus minor bug fixes.</span></span> <span data-ttu-id="66e02-146">Ser descentralizado não significa que não deve haver governança.</span><span class="sxs-lookup"><span data-stu-id="66e02-146">Being decentralized does not mean there should be zero governance.</span></span>

- <span data-ttu-id="66e02-147">**Controle de versão de imagem de contêiner**.</span><span class="sxs-lookup"><span data-stu-id="66e02-147">**Container image versioning**.</span></span> <span data-ttu-id="66e02-148">Durante o ciclo de desenvolvimento e teste, o processo de CI/CD cria muitas imagens de contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-148">During the development and test cycle, the CI/CD process will build many container images.</span></span> <span data-ttu-id="66e02-149">Somente alguns deles são candidatos a lançamento, e apenas alguns desses serão enviados por push para produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-149">Only some of those are candidates for release, and then only some of those release candidates will get pushed into production.</span></span> <span data-ttu-id="66e02-150">É preciso ter uma estratégia de controle de versão clara para que você saiba quais imagens estão implantadas atualmente para produção e possa reverter para uma versão anterior, se necessário.</span><span class="sxs-lookup"><span data-stu-id="66e02-150">You should have a clear versioning strategy, so that you know which images are currently deployed to production, and can roll back to a previous version if necessary.</span></span> 

- <span data-ttu-id="66e02-151">**Atualizações de serviço**.</span><span class="sxs-lookup"><span data-stu-id="66e02-151">**Service updates**.</span></span> <span data-ttu-id="66e02-152">Quando você atualizar um serviço para uma nova versão, ele não deverá interromper outros serviços que dependem dele.</span><span class="sxs-lookup"><span data-stu-id="66e02-152">When you update a service to a new version, it shouldn't break other services that depend on it.</span></span> <span data-ttu-id="66e02-153">Se você fizer uma atualização sem interrupção, haverá um período de tempo quando uma mistura de versões estará em execução.</span><span class="sxs-lookup"><span data-stu-id="66e02-153">If you do a rolling update, there will be a period of time when a mix of versions is running.</span></span> 
 
<span data-ttu-id="66e02-154">Esses desafios refletem uma tensão fundamental.</span><span class="sxs-lookup"><span data-stu-id="66e02-154">These challenges reflect a fundamental tension.</span></span> <span data-ttu-id="66e02-155">Por outro lado, as equipes precisam trabalhar de modo tão independente quanto possível.</span><span class="sxs-lookup"><span data-stu-id="66e02-155">On the one hand, teams need to work as independently as possible.</span></span> <span data-ttu-id="66e02-156">Por outro lado, algumas coordenação é necessária para que uma única pessoa possa realizar tarefas como executar um teste de integração, reimplantar a solução inteira para um novo cluster ou reverter uma atualização inválida.</span><span class="sxs-lookup"><span data-stu-id="66e02-156">On the other hand, some coordination is needed so that a single person can do tasks like running an integration test, redeploying the entire solution to a new cluster, or rolling back a bad update.</span></span> 
 
## <a name="cicd-approaches-for-microservices"></a><span data-ttu-id="66e02-157">Abordagens de CI/CD para microsserviços</span><span class="sxs-lookup"><span data-stu-id="66e02-157">CI/CD approaches for microservices</span></span>

<span data-ttu-id="66e02-158">É uma prática recomendada que cada equipe de serviço coloque o respectivo ambiente de build em um contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-158">It's a good practice for every service team to containerize their build environment.</span></span> <span data-ttu-id="66e02-159">Esse contêiner deverá ter todas as ferramentas de build necessárias para compilar os artefatos de código para o serviço dessa equipe.</span><span class="sxs-lookup"><span data-stu-id="66e02-159">This container should have all of the build tools necessary to build the code artifacts for their service.</span></span> <span data-ttu-id="66e02-160">Geralmente, você pode encontrar uma imagem do Docker oficial para sua linguagem de programação e estrutura.</span><span class="sxs-lookup"><span data-stu-id="66e02-160">Often you can find an official Docker image for your language and framework.</span></span> <span data-ttu-id="66e02-161">Em seguida, você pode usar `docker run` ou o Docker Compose para executar o build.</span><span class="sxs-lookup"><span data-stu-id="66e02-161">Then you can use `docker run` or Docker Compose to run the build.</span></span> 

<span data-ttu-id="66e02-162">Com essa abordagem, é simples configurar um novo ambiente de build.</span><span class="sxs-lookup"><span data-stu-id="66e02-162">With this approach, it's trivial to set up a new build environment.</span></span> <span data-ttu-id="66e02-163">Um desenvolvedor que deseja compilar seu código não precisa instalar um conjunto de ferramentas de build, apenas executar a imagem de contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-163">A developer who wants to build your code doesn't need to install a set of build tools, but simply runs the container image.</span></span> <span data-ttu-id="66e02-164">E o que é talvez ainda mais importante, o servidor de build pode ser configurado para fazer a mesma coisa.</span><span class="sxs-lookup"><span data-stu-id="66e02-164">Perhaps more importantly, your build server can be configured to do the same thing.</span></span> <span data-ttu-id="66e02-165">Dessa forma, você não precisa instalar essas ferramentas no servidor de build nem gerenciar versões conflitantes de ferramentas.</span><span class="sxs-lookup"><span data-stu-id="66e02-165">That way, you don't need to install those tools onto the build server, or manage conflicting versions of tools.</span></span> 

<span data-ttu-id="66e02-166">Para desenvolvimento e teste locais, use o Docker para executar o serviço dentro de um contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-166">For local development and testing, use Docker to run the service inside a container.</span></span> <span data-ttu-id="66e02-167">Como parte desse processo, talvez seja necessário executar outros contêineres com serviços simulados ou bancos de dados de teste necessários para teste local.</span><span class="sxs-lookup"><span data-stu-id="66e02-167">As part of this process, you may need to run other containers that have mock services or test databases needed for local testing.</span></span> <span data-ttu-id="66e02-168">Você pode usar o Docker Compose para coordenar esses contêineres ou usar o Minikube para executar o Kubernetes localmente.</span><span class="sxs-lookup"><span data-stu-id="66e02-168">You could use Docker Compose to coordinate these containers, or use Minikube to run Kubernetes locally.</span></span> 

<span data-ttu-id="66e02-169">Quando o código estiver pronto, abra uma solicitação pull e realize a mesclagem no mestre.</span><span class="sxs-lookup"><span data-stu-id="66e02-169">When the code is ready, open a pull request and merge into master.</span></span> <span data-ttu-id="66e02-170">Isso iniciará um trabalho no servidor de build:</span><span class="sxs-lookup"><span data-stu-id="66e02-170">This will start a job on the build server:</span></span>

1. <span data-ttu-id="66e02-171">Compile os ativos de código.</span><span class="sxs-lookup"><span data-stu-id="66e02-171">Build the code assets.</span></span> 
2. <span data-ttu-id="66e02-172">Execute testes de unidade no código.</span><span class="sxs-lookup"><span data-stu-id="66e02-172">Run unit tests against the code.</span></span>
3. <span data-ttu-id="66e02-173">Compile a imagem de contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-173">Build the container image.</span></span>
4. <span data-ttu-id="66e02-174">Teste a imagem de contêiner executando testes funcionais em um contêiner em execução.</span><span class="sxs-lookup"><span data-stu-id="66e02-174">Test the container image by running functional tests on a running container.</span></span> <span data-ttu-id="66e02-175">Essa etapa pode detectar erros no arquivo de Docker como um ponto de entrada inválido.</span><span class="sxs-lookup"><span data-stu-id="66e02-175">This step can catch errors in the Docker file, such as a bad entry point.</span></span>
5. <span data-ttu-id="66e02-176">Envie a imagem por push para um registro de contêiner.</span><span class="sxs-lookup"><span data-stu-id="66e02-176">Push the image to a container registry.</span></span>
6. <span data-ttu-id="66e02-177">Atualize o cluster de teste com a nova imagem para executar testes de integração.</span><span class="sxs-lookup"><span data-stu-id="66e02-177">Update the test cluster with the new image to run integration tests.</span></span>

<span data-ttu-id="66e02-178">Quando a imagem estiver pronta para entrar em produção, atualize os arquivos de implantação necessários para especificar a imagem mais recente, inclusive eventuais arquivos de configuração do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="66e02-178">When the image is ready to go into production, update the deployment files as needed to specify the latest image, including any Kubernetes configuration files.</span></span> <span data-ttu-id="66e02-179">Em seguida, aplique a atualização ao cluster de produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-179">Then apply the update to the production cluster.</span></span>

<span data-ttu-id="66e02-180">Aqui estão algumas recomendações para tornar as implantações mais confiáveis:</span><span class="sxs-lookup"><span data-stu-id="66e02-180">Here are some recommendations for making deployments more reliable:</span></span>
 
- <span data-ttu-id="66e02-181">Defina as convenções de toda a organização para marcações de contêiner, controle de versão e convenções de nomenclatura de recursos implantados para o cluster (pods, serviços e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="66e02-181">Define organization-wide conventions for container tags, versioning, and naming conventions for resources deployed to the cluster (pods, services, and so on).</span></span> <span data-ttu-id="66e02-182">Isso pode facilitar o diagnóstico de problemas de implantação.</span><span class="sxs-lookup"><span data-stu-id="66e02-182">That can make it easier to diagnose deployment issues.</span></span> 

- <span data-ttu-id="66e02-183">Crie dois registros de contêiner separados, um para desenvolvimento/teste e outro para produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-183">Create two separate container registries, one for development/testing and one for production.</span></span> <span data-ttu-id="66e02-184">Não envie uma imagem por push para o registro de produção até que você esteja pronto para implantá-lo em produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-184">Don't push an image to the production registry until you're ready to deploy it into production.</span></span> <span data-ttu-id="66e02-185">Se você combinar essa prática com controle de versão semântico de imagens de contêiner, isso poderá reduzir a chance de acidentalmente implantar uma versão não aprovada para lançamento.</span><span class="sxs-lookup"><span data-stu-id="66e02-185">If you combine this practice with semantic versioning of container images, it can reduce the chance of accidentally deploying a version that wasn't approved for release.</span></span>

## <a name="updating-services"></a><span data-ttu-id="66e02-186">Atualizando serviços</span><span class="sxs-lookup"><span data-stu-id="66e02-186">Updating services</span></span>

<span data-ttu-id="66e02-187">Há várias estratégias para atualizar um serviço que já está em produção.</span><span class="sxs-lookup"><span data-stu-id="66e02-187">There are various strategies for updating a service that's already in production.</span></span> <span data-ttu-id="66e02-188">Aqui, abordamos três opções comuns: atualização sem interrupção, implantação "blue-green" e versão canário.</span><span class="sxs-lookup"><span data-stu-id="66e02-188">Here we discuss three common options: Rolling update, blue-green deployment, and canary release.</span></span>

### <a name="rolling-update"></a><span data-ttu-id="66e02-189">Atualização sem interrupção</span><span class="sxs-lookup"><span data-stu-id="66e02-189">Rolling update</span></span> 

<span data-ttu-id="66e02-190">Em uma atualização sem interrupção, você implanta novas instâncias de um serviço e as novas instâncias começam a receber solicitações imediatamente.</span><span class="sxs-lookup"><span data-stu-id="66e02-190">In a rolling update, you deploy new instances of a service, and the new instances start receiving requests right away.</span></span> <span data-ttu-id="66e02-191">À medida que as novas instâncias chegam, as anteriores são removidas.</span><span class="sxs-lookup"><span data-stu-id="66e02-191">As the new instances come up, the previous instances are removed.</span></span>

<span data-ttu-id="66e02-192">Atualizações sem interrupção são o comportamento padrão no Kubernetes quando você atualiza a especificação de pod para uma implantação.</span><span class="sxs-lookup"><span data-stu-id="66e02-192">Rolling updates are the default behavior in Kubernetes when you update the pod spec for a Deployment.</span></span> <span data-ttu-id="66e02-193">O controlador de implantação cria um novo ReplicaSet para os pods atualizados.</span><span class="sxs-lookup"><span data-stu-id="66e02-193">The Deployment controller creates a new ReplicaSet for the updated pods.</span></span> <span data-ttu-id="66e02-194">Em seguida, ele expande o novo ReplicaSet e reduz simultaneamente o antigo, para manter a contagem de réplicas desejada.</span><span class="sxs-lookup"><span data-stu-id="66e02-194">Then it scales up the new ReplicaSet while scaling down the old one, to maintain the desired replica count.</span></span> <span data-ttu-id="66e02-195">Ela não exclui os pods antigos até que os novos estejam prontos.</span><span class="sxs-lookup"><span data-stu-id="66e02-195">It doesn't delete old pods until the new ones are ready.</span></span> <span data-ttu-id="66e02-196">O Kubernetes mantém um histórico da atualização, de modo que você pode usar kubectl para reverter uma atualização se necessário.</span><span class="sxs-lookup"><span data-stu-id="66e02-196">Kubernetes keeps a history of the update, so you can use kubectl to roll back an update if needed.</span></span> 

<span data-ttu-id="66e02-197">Se o seu serviço executa uma tarefa de inicialização longa, você pode definir um teste de preparação.</span><span class="sxs-lookup"><span data-stu-id="66e02-197">If your service performs a long startup task, you can define a readiness probe.</span></span> <span data-ttu-id="66e02-198">A investigação de preparação relata quando o contêiner está pronto para começar a receber tráfego.</span><span class="sxs-lookup"><span data-stu-id="66e02-198">The readiness probe reports when the container is ready to start receiving traffic.</span></span> <span data-ttu-id="66e02-199">O Kubernetes não enviará tráfego para o pod até que a investigação relate êxito.</span><span class="sxs-lookup"><span data-stu-id="66e02-199">Kubernetes won't send traffic to the pod until the probe reports success.</span></span> 

<span data-ttu-id="66e02-200">Um desafio de reverter atualizações é que durante o processo de atualização uma mistura das versões antiga e nova estão em execução e recebendo tráfego.</span><span class="sxs-lookup"><span data-stu-id="66e02-200">One challenge of rolling updates is that during the update process, a mix of old and new versions are running and receiving traffic.</span></span> <span data-ttu-id="66e02-201">Durante esse período, qualquer solicitação poderia ser roteada para qualquer uma das duas versões.</span><span class="sxs-lookup"><span data-stu-id="66e02-201">During this period, any request could get routed to either of the two versions.</span></span> <span data-ttu-id="66e02-202">Isso pode causar ou não problemas, dependendo do escopo das alterações entre as duas versões.</span><span class="sxs-lookup"><span data-stu-id="66e02-202">That may or may not cause problems, depending on the scope of the changes between the two versions.</span></span> 

### <a name="blue-green-deployment"></a><span data-ttu-id="66e02-203">Implantação "blue-green"</span><span class="sxs-lookup"><span data-stu-id="66e02-203">Blue-green deployment</span></span>

<span data-ttu-id="66e02-204">Em uma implantação "blue-green", você deve implantar a nova versão juntamente com a versão anterior.</span><span class="sxs-lookup"><span data-stu-id="66e02-204">In a blue-green deployment, you deploy the new version alongside the previous version.</span></span> <span data-ttu-id="66e02-205">Depois de validar a nova versão, você pode mudar todo o tráfego da versão anterior para a nova versão, de uma só vez.</span><span class="sxs-lookup"><span data-stu-id="66e02-205">After you validate the new version, you switch all traffic at once from the previous version to the new version.</span></span> <span data-ttu-id="66e02-206">Após a troca, você deve monitorar o aplicativo para quaisquer problemas.</span><span class="sxs-lookup"><span data-stu-id="66e02-206">After the switch, you monitor the application for any problems.</span></span> <span data-ttu-id="66e02-207">Se algo der errado, você poderá retornar à versão antiga.</span><span class="sxs-lookup"><span data-stu-id="66e02-207">If something goes wrong, you can swap back to the old version.</span></span> <span data-ttu-id="66e02-208">Se nenhum problema ocorrer, você poderá excluir a versão antiga.</span><span class="sxs-lookup"><span data-stu-id="66e02-208">Assuming there are no problems, you can delete the old version.</span></span>

<span data-ttu-id="66e02-209">Com um aplicativo monolítico ou de N camadas mais tradicional, a implantação "blue-green" geralmente significa provisionar dois ambientes idênticos.</span><span class="sxs-lookup"><span data-stu-id="66e02-209">With a more traditional monolithic or N-tier application, blue-green deployment generally meant provisioning two identical environments.</span></span> <span data-ttu-id="66e02-210">Você implantaria a nova versão em um ambiente de preparo e então redirecionaria o tráfego de cliente para o ambiente de preparo &mdash; por exemplo, alternando VIPs.</span><span class="sxs-lookup"><span data-stu-id="66e02-210">You would deploy the new version to a staging environment, then redirect client traffic to the staging environment &mdash; for example, by swapping VIP addresses.</span></span>

<span data-ttu-id="66e02-211">No Kubernetes, você não precisa provisionar um cluster separado para fazer implantações "blue-green".</span><span class="sxs-lookup"><span data-stu-id="66e02-211">In Kubernetes, you don't need to provision a separate cluster to do blue-green deployments.</span></span> <span data-ttu-id="66e02-212">Em vez disso, você pode tirar proveito de seletores.</span><span class="sxs-lookup"><span data-stu-id="66e02-212">Instead, you can take advantage of selectors.</span></span> <span data-ttu-id="66e02-213">Crie um novo recurso de implantação com uma nova especificação de pod e um conjunto diferente de rótulos.</span><span class="sxs-lookup"><span data-stu-id="66e02-213">Create a new Deployment resource with a new pod spec and a different set of labels.</span></span> <span data-ttu-id="66e02-214">Crie essa implantação sem excluir a implantação anterior nem modificar o serviço que aponta para ela.</span><span class="sxs-lookup"><span data-stu-id="66e02-214">Create this deployment, without deleting the previous deployment or modifying the service that points to it.</span></span> <span data-ttu-id="66e02-215">Quando os novo pods estiverem em execução, você poderá atualizar o seletor do serviço para corresponder à nova implantação.</span><span class="sxs-lookup"><span data-stu-id="66e02-215">Once the new pods are running, you can update the service's selector to match the new deployment.</span></span> 

<span data-ttu-id="66e02-216">Uma vantagem de implantações "blue-green" é que o serviço muda todos os pods simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="66e02-216">An advantage of blue-green deployments is that the service switches all the pods at the same time.</span></span> <span data-ttu-id="66e02-217">Depois que o serviço for atualizado, todas as novas solicitações serão roteadas para a nova versão.</span><span class="sxs-lookup"><span data-stu-id="66e02-217">After the service is updated, all new requests get routed to the new version.</span></span> <span data-ttu-id="66e02-218">Uma desvantagem é que durante a atualização você executa o dobro de pods para o serviço (os atuais e os próximos).</span><span class="sxs-lookup"><span data-stu-id="66e02-218">One drawback is that during the update, you are running twice as many pods for the service (current and next).</span></span> <span data-ttu-id="66e02-219">Se os pods exigirem muitos recursos de CPU ou de memória, talvez você precisará expandir o cluster temporariamente para dar conta do consumo de recursos.</span><span class="sxs-lookup"><span data-stu-id="66e02-219">If the pods require a lot of CPU or memory resources, you may need to scale out the cluster temporarily to handle the resource consumption.</span></span> 

### <a name="canary-release"></a><span data-ttu-id="66e02-220">Versão canário</span><span class="sxs-lookup"><span data-stu-id="66e02-220">Canary release</span></span>

<span data-ttu-id="66e02-221">Em uma versão canário, você distribui uma versão atualizada para um número pequeno de clientes.</span><span class="sxs-lookup"><span data-stu-id="66e02-221">In a canary release, you roll out an updated version to a small number of clients.</span></span> <span data-ttu-id="66e02-222">Em seguida, você monitora o comportamento do novo serviço antes de implantá-lo em todos os clientes.</span><span class="sxs-lookup"><span data-stu-id="66e02-222">Then you monitor the behavior of the new service before rolling it out to all clients.</span></span> <span data-ttu-id="66e02-223">Isso lhe permite fazer uma distribuição lenta de forma controlada, observar dados reais e identificar problemas antes que todos os clientes sejam afetados.</span><span class="sxs-lookup"><span data-stu-id="66e02-223">This lets you do a slow rollout in a controlled fashion, observe real data, and spot problems before all customers are affected.</span></span>

<span data-ttu-id="66e02-224">Uma versão canário é mais complexa de gerenciar do que a atualização sem interrupção ou "blue-green", porque você deve rotear solicitações dinamicamente para diferentes versões do serviço.</span><span class="sxs-lookup"><span data-stu-id="66e02-224">A canary release is more complex to manage than either blue-green or rolling update, because you must dynamically route requests to different versions of the service.</span></span> <span data-ttu-id="66e02-225">No Kubernetes, você pode configurar um serviço para abranger dois conjuntos de réplicas (um para cada versão) e ajustar as contagens de réplicas manualmente.</span><span class="sxs-lookup"><span data-stu-id="66e02-225">In Kubernetes, you can configure a Service to span two replica sets (one for each version) and adjust the replica counts manually.</span></span> <span data-ttu-id="66e02-226">No entanto, essa abordagem tem uma granularidade bastante alta devido ao modo como o Kubernetes balanceia a carga entre os pods.</span><span class="sxs-lookup"><span data-stu-id="66e02-226">However, this approach is rather coarse-grained, because of the way Kubernetes load balances across pods.</span></span> <span data-ttu-id="66e02-227">Por exemplo, se você tiver um total de dez réplicas, só poderá realizar deslocamentos de tráfego em incrementos de 10%.</span><span class="sxs-lookup"><span data-stu-id="66e02-227">For example, if you have a total of ten replicas, you can only shift traffic in 10% increments.</span></span> <span data-ttu-id="66e02-228">Se você estiver usando uma malha de serviço, poderá usar as regras de roteamento de malha do serviço para implementar uma estratégia de versão canário mais sofisticada.</span><span class="sxs-lookup"><span data-stu-id="66e02-228">If you are using a service mesh, you can use the service mesh routing rules to implement a more sophisticated canary release strategy.</span></span> <span data-ttu-id="66e02-229">Aqui estão alguns recursos que podem ser úteis:</span><span class="sxs-lookup"><span data-stu-id="66e02-229">Here are some resources that may be helpful:</span></span>

- <span data-ttu-id="66e02-230">Kubernetes sem malha de serviço: [implantações canário](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)</span><span class="sxs-lookup"><span data-stu-id="66e02-230">Kubernetes without service mesh: [Canary deployments](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)</span></span>
- <span data-ttu-id="66e02-231">Linkerd: [roteamento de solicitações dinâmico](https://linkerd.io/features/routing/)</span><span class="sxs-lookup"><span data-stu-id="66e02-231">Linkerd: [Dynamic request routing](https://linkerd.io/features/routing/)</span></span>
- <span data-ttu-id="66e02-232">Istio: [implantações canário usando Istio](https://istio.io/blog/canary-deployments-using-istio.html)</span><span class="sxs-lookup"><span data-stu-id="66e02-232">Istio: [Canary Deployments using Istio](https://istio.io/blog/canary-deployments-using-istio.html)</span></span>

## <a name="conclusion"></a><span data-ttu-id="66e02-233">Conclusão</span><span class="sxs-lookup"><span data-stu-id="66e02-233">Conclusion</span></span>

<span data-ttu-id="66e02-234">Nos últimos anos, houve uma mudança radical na indústria, um movimento saindo da criação de *sistemas de registro* em direção à criação de *sistemas de engajamento*.</span><span class="sxs-lookup"><span data-stu-id="66e02-234">In recent years, there has been a sea change in the industry, a movement from building *systems of record* to building *systems of engagement*.</span></span>

<span data-ttu-id="66e02-235">Sistemas de registro são aplicativos de gerenciamento de dados de back office tradicionais.</span><span class="sxs-lookup"><span data-stu-id="66e02-235">Systems of record are traditional back-office data management applications.</span></span> <span data-ttu-id="66e02-236">No núcleo desses sistemas geralmente há um RDBMS, que é a única fonte de verdade.</span><span class="sxs-lookup"><span data-stu-id="66e02-236">At the heart of these systems there often sits an RDBMS that is the single source of truth.</span></span> <span data-ttu-id="66e02-237">O termo "sistema de engajamento" é creditado a Geoffrey Moore em seu artigo de 2011, *Systems of Engagement and the Future of Enterprise IT* (sistemas de engajamento e o futuro do TI empresarial).</span><span class="sxs-lookup"><span data-stu-id="66e02-237">The term "system of engagement" is credited to Geoffrey Moore, in his 2011 paper *Systems of Engagement and the Future of Enterprise IT*.</span></span> <span data-ttu-id="66e02-238">Sistemas de engajamento são aplicativos voltados à comunicação e colaboração.</span><span class="sxs-lookup"><span data-stu-id="66e02-238">Systems of engagement are applications focused on communication and collaboration.</span></span> <span data-ttu-id="66e02-239">Eles conectam pessoas em tempo real.</span><span class="sxs-lookup"><span data-stu-id="66e02-239">They connect people in real time.</span></span> <span data-ttu-id="66e02-240">Eles devem estar disponíveis 24 horas por dia, 7 dias por semana.</span><span class="sxs-lookup"><span data-stu-id="66e02-240">They must be available 24/7.</span></span> <span data-ttu-id="66e02-241">Novos recursos são introduzidos regularmente sem que o aplicativo fique offline.</span><span class="sxs-lookup"><span data-stu-id="66e02-241">New features are introduced regularly without taking the application offline.</span></span> <span data-ttu-id="66e02-242">Os usuários esperam mais e são menos pacientes com relação a tempo de inatividade ou atrasos inesperados.</span><span class="sxs-lookup"><span data-stu-id="66e02-242">Users expect more and are less patient of unexpected delays or downtime.</span></span>

<span data-ttu-id="66e02-243">No espaço do consumidor, uma melhor experiência de usuário pode ter valor comercial mensurável.</span><span class="sxs-lookup"><span data-stu-id="66e02-243">In the consumer space, a better user experience can have measurable business value.</span></span> <span data-ttu-id="66e02-244">A quantidade de tempo durante o qual um usuário se envolve com um aplicativo pode ser convertida diretamente em receita.</span><span class="sxs-lookup"><span data-stu-id="66e02-244">The amount of time that a user engages with an application may translate directly into revenue.</span></span> <span data-ttu-id="66e02-245">E no universo dos sistemas comerciais, as expectativas dos usuários mudaram.</span><span class="sxs-lookup"><span data-stu-id="66e02-245">And in the realm of business systems, users' expectations have changed.</span></span> <span data-ttu-id="66e02-246">Se esses sistemas visam promover comunicação e colaboração, eles devem usar como referência os aplicativos voltados para o consumidor.</span><span class="sxs-lookup"><span data-stu-id="66e02-246">If these systems aim to foster communication and collaboration, they must take their cue from consumer-facing applications.</span></span>

<span data-ttu-id="66e02-247">Microsserviços são uma resposta a essa paisagem em mudança.</span><span class="sxs-lookup"><span data-stu-id="66e02-247">Microservices are a response to this changing landscape.</span></span> <span data-ttu-id="66e02-248">Ao decompor um aplicativo monolítico em um grupo de serviços acoplados de forma flexível, podemos controlar o ciclo de versão de cada serviço e habilitar atualizações frequentes, sem tempo de inatividade nem alterações significativas.</span><span class="sxs-lookup"><span data-stu-id="66e02-248">By decomposing a monolithic application into a group of loosely coupled services, we can control the release cycle of each service, and enable frequent updates without downtime or breaking changes.</span></span> <span data-ttu-id="66e02-249">Os microsserviços também ajudam com a escalabilidade, o isolamento de falhas e a resiliência.</span><span class="sxs-lookup"><span data-stu-id="66e02-249">Microservices also help with scalability, failure isolation, and resiliency.</span></span> <span data-ttu-id="66e02-250">Enquanto isso, plataformas de nuvem estão facilitando o build e a execução de microsserviços, com o provisionamento automatizado de recursos de computação, orquestradores de contêiner como um serviço e ambientes sem servidor controlados por eventos.</span><span class="sxs-lookup"><span data-stu-id="66e02-250">Meanwhile, cloud platforms are making it easier to build and run microservices, with automated provisioning of compute resources, container orchestrators as a service, and event-driven serverless environments.</span></span>

<span data-ttu-id="66e02-251">Mas, como vimos, arquiteturas de microsserviços também enfrentam muitos desafios.</span><span class="sxs-lookup"><span data-stu-id="66e02-251">But as we've seen, microservices architectures also being a lot of challenges.</span></span> <span data-ttu-id="66e02-252">Para ter êxito, você deve iniciar de um design sólido.</span><span class="sxs-lookup"><span data-stu-id="66e02-252">To succeed, you must start from a solid design.</span></span> <span data-ttu-id="66e02-253">Você deve pensar cuidadosamente ao analisar o domínio, escolher as tecnologias, modelar dados, projetar APIs e criar uma cultura de DevOps madura.</span><span class="sxs-lookup"><span data-stu-id="66e02-253">You must put careful thought into analyzing the domain, choosing technologies, modeling data, designing APIs, and building a mature DevOps culture.</span></span> <span data-ttu-id="66e02-254">Esperamos que este guia e que a [implementação de referência](https://github.com/mspnp/microservices-reference-implementation) que o acompanha tenham ajudado a iluminar a jornada.</span><span class="sxs-lookup"><span data-stu-id="66e02-254">We hope that this guide, and the accompanying [reference implementation](https://github.com/mspnp/microservices-reference-implementation), has helped to illuminate the journey.</span></span> 


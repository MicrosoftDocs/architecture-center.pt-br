---
title: Refatorar um Aplicativo Azure Service Fabric migrado a partir dos Serviços de Nuvem do Azure
description: Como refatorar um Aplicativo do Azure Service Fabric existente migrado a partir dos Serviços de Nuvem do Azure
author: petertay
ms.date: 02/02/2018
ms.openlocfilehash: 14ecaf81a07c72296e8db300df371e9a0c990434
ms.sourcegitcommit: dbbf914757b03cdee7a274204f9579fa63d7eed2
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/02/2018
ms.locfileid: "50916457"
---
# <a name="refactor-an-azure-service-fabric-application-migrated-from-azure-cloud-services"></a><span data-ttu-id="47381-103">Refatorar um Aplicativo Azure Service Fabric migrado a partir dos Serviços de Nuvem do Azure</span><span class="sxs-lookup"><span data-stu-id="47381-103">Refactor an Azure Service Fabric Application migrated from Azure Cloud Services</span></span>

<span data-ttu-id="47381-104">[Código de exemplo do ![GitHub](../_images/github.png)][sample-code]</span><span class="sxs-lookup"><span data-stu-id="47381-104">[![GitHub](../_images/github.png) Sample code][sample-code]</span></span>

<span data-ttu-id="47381-105">Este artigo descreve a refatoração de um aplicativo do Azure Service Fabric existente para uma arquitetura mais granular.</span><span class="sxs-lookup"><span data-stu-id="47381-105">This article describes refactoring an existing Azure Service Fabric application to a more granular architecture.</span></span> <span data-ttu-id="47381-106">Este artigo foca nas considerações de design, empacotamento, desempenho e implantação do aplicativo refatorado do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-106">This article focuses on the design, packaging, performance, and deployment considerations of the refactored Service Fabric application.</span></span>

## <a name="scenario"></a><span data-ttu-id="47381-107">Cenário</span><span class="sxs-lookup"><span data-stu-id="47381-107">Scenario</span></span>

<span data-ttu-id="47381-108">Conforme discutido no artigo anterior, [Migrar um aplicativo dos Serviços de Nuvem do Azure para o Azure Service Fabric][migrate-from-cloud-services], a equipe responsável pelas diretrizes escreveu um livro, em 2012, documentando o processo de criação e implementação de um aplicativo dos Serviços de Nuvem no Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-108">As discussed in the previous article, [Migrating an Azure Cloud Services application to Azure Service Fabric][migrate-from-cloud-services], the patterns & practices team authored a book in 2012 that documented the process for designing and implementing a Cloud Services application in Azure.</span></span> <span data-ttu-id="47381-109">O livro descreve uma empresa fictícia chamada Tailspin que deseja criar um aplicativo dos Serviços de Nuvem chamado **Surveys**.</span><span class="sxs-lookup"><span data-stu-id="47381-109">The book describes a fictitious company named Tailspin that wants to create a Cloud Services application named **Surveys**.</span></span> <span data-ttu-id="47381-110">O aplicativo Surveys permite que os usuários criem e publiquem pesquisas que podem ser respondidas pelo público.</span><span class="sxs-lookup"><span data-stu-id="47381-110">The Surveys application allows users to create and publish surveys that can be answered by the public.</span></span> <span data-ttu-id="47381-111">O diagrama a seguir mostra a arquitetura dessa versão do aplicativo Surveys:</span><span class="sxs-lookup"><span data-stu-id="47381-111">The following diagram shows the architecture of this version of the Surveys application:</span></span>

![](./images/tailspin01.png)

<span data-ttu-id="47381-112">A função Web **Tailspin.Web** hospeda um site ASP.NET MVC que os clientes da Tailspin usam para:</span><span class="sxs-lookup"><span data-stu-id="47381-112">The **Tailspin.Web** web role hosts an ASP.NET MVC site that Tailspin customers use to:</span></span>
* <span data-ttu-id="47381-113">inscrever-se no aplicativo Surveys,</span><span class="sxs-lookup"><span data-stu-id="47381-113">sign up for the Surveys application,</span></span>
* <span data-ttu-id="47381-114">criar ou excluir uma pesquisa única,</span><span class="sxs-lookup"><span data-stu-id="47381-114">create or delete a single survey,</span></span>
* <span data-ttu-id="47381-115">exibir resultados de uma pesquisa única,</span><span class="sxs-lookup"><span data-stu-id="47381-115">view results for a single survey,</span></span>
* <span data-ttu-id="47381-116">solicitar que os resultados dessa pesquisa sejam exportados para o SQL, e</span><span class="sxs-lookup"><span data-stu-id="47381-116">request that survey results be exported to SQL, and</span></span>
* <span data-ttu-id="47381-117">exibir resultados e análises de pesquisa agregados.</span><span class="sxs-lookup"><span data-stu-id="47381-117">view aggregated survey results and analysis.</span></span>

<span data-ttu-id="47381-118">A função Web **Tailspin.Web.Survey.Public** também hospeda um site ASP.NET MVC que o público acessa para preencher as pesquisas.</span><span class="sxs-lookup"><span data-stu-id="47381-118">The **Tailspin.Web.Survey.Public** web role also hosts an ASP.NET MVC site that the public visits to fill out the surveys.</span></span> <span data-ttu-id="47381-119">Essas respostas são colocadas em uma fila para serem salvas.</span><span class="sxs-lookup"><span data-stu-id="47381-119">These responses are put in a queue to be saved.</span></span>

<span data-ttu-id="47381-120">A função de trabalho **Tailspin.Workers.Survey** executa o processamento em segundo plano selecionando solicitações de várias filas.</span><span class="sxs-lookup"><span data-stu-id="47381-120">The **Tailspin.Workers.Survey** worker role performs background processing by picking up requests from multiple queues.</span></span>

<span data-ttu-id="47381-121">Em seguida, a equipe responsável pelas diretrizes criou um novo projeto para compatibilizar esse aplicativo com o Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-121">The patterns & practices team then created a new project to port this application to Azure Service Fabric.</span></span> <span data-ttu-id="47381-122">O objetivo desse projeto era fazer somente as alterações de código necessárias para pôr o aplicativo em execução em um cluster do Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-122">The goal of this project was to make only the necessary code changes to get the application running in an Azure Service Fabric cluster.</span></span> <span data-ttu-id="47381-123">Como resultado, as funções Web e de trabalho originais não foram decompostas em uma arquitetura mais granular.</span><span class="sxs-lookup"><span data-stu-id="47381-123">As a result, the original web and worker roles were not decomposed into a more granular architecture.</span></span> <span data-ttu-id="47381-124">A arquitetura resultante é muito semelhante à versão do Serviço de Nuvem do aplicativo:</span><span class="sxs-lookup"><span data-stu-id="47381-124">The resulting architecture is very similar to the Cloud Service version of the application:</span></span>

![](./images/tailspin02.png)

<span data-ttu-id="47381-125">O serviço **Tailspin.Web** foi transferido da função Web original *Tailspin.Web*.</span><span class="sxs-lookup"><span data-stu-id="47381-125">The **Tailspin.Web** service is ported from the original *Tailspin.Web* web role.</span></span>

<span data-ttu-id="47381-126">O serviço **Tailspin.Web.Survey.Public** foi tranferido da função Web original *Tailspin.Web.Survey.Public*.</span><span class="sxs-lookup"><span data-stu-id="47381-126">The **Tailspin.Web.Survey.Public** service is ported from the original *Tailspin.Web.Survey.Public* web role.</span></span>

<span data-ttu-id="47381-127">O serviço **Tailspin.AnswerAnalysisService** foi transferido da função de trabalho original *Tailspin.Workers.Survey*.</span><span class="sxs-lookup"><span data-stu-id="47381-127">The **Tailspin.AnswerAnalysisService** service is ported from the original *Tailspin.Workers.Survey* worker role.</span></span>

> [!NOTE] 
> <span data-ttu-id="47381-128">Embora as alterações mínimas de código tenham sido feitas em cada uma das funções Web e de trabalho, **Tailspin.Web** e **Tailspin.Web.Survey.Public** foram modificados para auto-hospedar um servidor Web do [Kestrel].</span><span class="sxs-lookup"><span data-stu-id="47381-128">While minimal code changes were made to each of the web and worker roles, **Tailspin.Web** and **Tailspin.Web.Survey.Public** were modified to self-host a [Kestrel] web server.</span></span> <span data-ttu-id="47381-129">O aplicativo Surveys anterior é um aplicativo ASP.NET que foi hospedado usando os Serviços de Informação da Internet (IIS), mas não é possível executar o IIS como um serviço no Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-129">The earlier Surveys application is an ASP.NET application that was hosted using Interet Information Services (IIS), but it is not possible to run IIS as a service in Service Fabric.</span></span> <span data-ttu-id="47381-130">Portanto, qualquer servidor Web deve ser capaz de ser auto-hospedado, como o [Kestrel].</span><span class="sxs-lookup"><span data-stu-id="47381-130">Therefore, any web server must be capable of being self-hosted, such as [Kestrel].</span></span> <span data-ttu-id="47381-131">É possível executar o IIS em um contêiner no Service Fabric em algumas situações.</span><span class="sxs-lookup"><span data-stu-id="47381-131">It is possible to run IIS in a container in Service Fabric in some situations.</span></span> <span data-ttu-id="47381-132">Confira [Cenários para usar contêineres][container-scenarios] para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="47381-132">See [scenarios for using containers][container-scenarios] for more information.</span></span>  

<span data-ttu-id="47381-133">Agora, a Tailspin está refatorando o aplicativo Surveys para uma arquitetura mais granular.</span><span class="sxs-lookup"><span data-stu-id="47381-133">Now, Tailspin is refactoring the Surveys application to a more granular architecture.</span></span> <span data-ttu-id="47381-134">A motivação da Tailspin para refatorar é facilitar o desenvolvimento, a compilação e a implantação do aplicativo Surveys.</span><span class="sxs-lookup"><span data-stu-id="47381-134">Tailspin's motivation for refactoring is to make it easier to develop, build, and deploy the Surveys application.</span></span> <span data-ttu-id="47381-135">Ao decompor as funções Web e de trabalho existentes para uma arquitetura mais granular, a Tailspin deseja remover as dependências existentes da comunicação e dos dados, extremamente integradas, entre essas funções.</span><span class="sxs-lookup"><span data-stu-id="47381-135">By decomposing the existing web and worker roles to a more granular architecture, Tailspin wants to remove the existing tightly coupled communication and data dependencies between these roles.</span></span>

<span data-ttu-id="47381-136">A Tailspin vê outros benefícios em passar o aplicativo Surveys para uma arquitetura mais granular:</span><span class="sxs-lookup"><span data-stu-id="47381-136">Tailspin sees other benefits in moving the Surveys application to a more granular architecture:</span></span>
* <span data-ttu-id="47381-137">Cada serviço pode ser empacotado em projetos independentes com um escopo pequeno o suficiente para ser gerenciado por uma pequena equipe.</span><span class="sxs-lookup"><span data-stu-id="47381-137">Each service can be packaged into independent projects with a scope small enough to be managed by a small team.</span></span>
* <span data-ttu-id="47381-138">Cada serviço pode ser implantado independentemente e ter seu próprio controle de versão.</span><span class="sxs-lookup"><span data-stu-id="47381-138">Each service can be independently versioned and deployed.</span></span>
* <span data-ttu-id="47381-139">Cada serviço pode ser implementado usando a melhor tecnologia para o serviço.</span><span class="sxs-lookup"><span data-stu-id="47381-139">Each service can be implemented using the best technology for that service.</span></span> <span data-ttu-id="47381-140">Por exemplo, um cluster do Service Fabric pode incluir serviços criados com diferentes versões do .Net Framework, Java ou outras linguagens, como C ou C++.</span><span class="sxs-lookup"><span data-stu-id="47381-140">For example, a service fabric cluster can include services built using different versions of the .Net Frameworks, Java, or other languages such as C or C++.</span></span>
* <span data-ttu-id="47381-141">Cada serviço pode ser dimensionado independentemente para responder a aumentos e diminuições de carga.</span><span class="sxs-lookup"><span data-stu-id="47381-141">Each service can be independently scaled to respond to increases and decreases in load.</span></span>

> [!NOTE] 
> <span data-ttu-id="47381-142">A multilocação está fora do escopo da refatoração deste aplicativo.</span><span class="sxs-lookup"><span data-stu-id="47381-142">Multitenancy is out of scope for the refactoring of this application.</span></span> <span data-ttu-id="47381-143">A Tailspin tem várias opções para dar suporte à multilocação e pode tomar essas decisões de design mais tarde sem afetar o design inicial.</span><span class="sxs-lookup"><span data-stu-id="47381-143">Tailspin has several options to support multitenancy and can make these design decisions later without affecting the initial design.</span></span> <span data-ttu-id="47381-144">Por exemplo, a Tailspin pode criar instâncias separadas dos serviços para cada locatário em um cluster ou criar um cluster separado para cada locatário.</span><span class="sxs-lookup"><span data-stu-id="47381-144">For example, Tailspin can create separate instances of the services for each tenant within a cluster or create a separate cluster for each tenant.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="47381-145">Considerações sobre o design</span><span class="sxs-lookup"><span data-stu-id="47381-145">Design considerations</span></span>
 
<span data-ttu-id="47381-146">O diagrama a seguir mostra a arquitetura do aplicativo Surveys refatorado para uma arquitetura mais granular:</span><span class="sxs-lookup"><span data-stu-id="47381-146">The following diagram shows the architecture of the Surveys application refactored to a more granular architecture:</span></span>

![](./images/surveys_03.png)

<span data-ttu-id="47381-147">O **Tailspin.Web** é um serviço sem estado que auto-hospeda um aplicativo ASP.NET MVC que os clientes da Tailspin visitam para criar pesquisas e exibir resultados da pesquisa.</span><span class="sxs-lookup"><span data-stu-id="47381-147">**Tailspin.Web** is a stateless service self-hosting an ASP.NET MVC application that Tailspin customers visit to create surveys and view survey results.</span></span> <span data-ttu-id="47381-148">Esse serviço compartilha a maior parte desse código com o serviço *Tailspin.Web* do aplicativo do Service Fabric transferido.</span><span class="sxs-lookup"><span data-stu-id="47381-148">This service shares most of its code with the *Tailspin.Web* service from the ported Service Fabric application.</span></span> <span data-ttu-id="47381-149">Como mencionado anteriormente, esse serviço usa o ASP.NET Core e comutadores ao usar o Kestrel como front-end da Web para implementar um WebListener.</span><span class="sxs-lookup"><span data-stu-id="47381-149">As mentioned earlier, this service uses ASP.NET core and switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="47381-150">**Tailspin.Web.Survey.Public** é um serviço sem estado que também auto-hospeda um site ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="47381-150">**Tailspin.Web.Survey.Public** is a stateless service also self-hosting an ASP.NET MVC site.</span></span> <span data-ttu-id="47381-151">Os usuários visitam esse site para selecionar pesquisas a partir de uma lista e, em seguida, preenchê-las. Esse serviço compartilha a maior parte do seu código com o serviço *Tailspin.Web.Survey.Public* do aplicativo do Service Fabric transferido.</span><span class="sxs-lookup"><span data-stu-id="47381-151">Users visit this site to select surveys from a list and then fill them out. This service shares most of its code with the *Tailspin.Web.Survey.Public* service from the ported Service Fabric application.</span></span> <span data-ttu-id="47381-152">Esse serviço também usa o ASP.NET Core e comutadores ao usar o Kestrel como front-end da Web para implementar um WebListener.</span><span class="sxs-lookup"><span data-stu-id="47381-152">This service also uses ASP.NET Core and also switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="47381-153">O **Tailspin.SurveyResponseService** é um serviço com estado que armazena respostas de pesquisa no Armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-153">**Tailspin.SurveyResponseService** is a stateful service that stores survey answers in Azure Blob Storage.</span></span> <span data-ttu-id="47381-154">Ele também mescla respostas nos dados da análise de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="47381-154">It also merges answers into the survey analysis data.</span></span> <span data-ttu-id="47381-155">O serviço é implementado como um serviço com estado, pois usa um [ReliableConcurrentQueue][reliable-concurrent-queue] para processar respostas de pesquisa em lotes.</span><span class="sxs-lookup"><span data-stu-id="47381-155">The service is implemented as a stateful service because it uses a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers in batches.</span></span> <span data-ttu-id="47381-156">Essa funcionalidade foi originalmente implementada no serviço *Tailspin.AnswerAnalysisService* no aplicativo Service Fabric portado.</span><span class="sxs-lookup"><span data-stu-id="47381-156">This functionality was originally implemented in the *Tailspin.AnswerAnalysisService* service in the ported Service Fabric application.</span></span>

<span data-ttu-id="47381-157">O **Tailspin.SurveyManagementService** é um serviço sem estado que armazena e recupera pesquisas e perguntas de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="47381-157">**Tailspin.SurveyManagementService** is a stateless service that stores and retrieves surveys and survey questions.</span></span> <span data-ttu-id="47381-158">O serviço usa o armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-158">The service uses Azure Blob storage.</span></span> <span data-ttu-id="47381-159">Essa funcionalidade também foi originalmente implementada nos componentes de acesso a dados dos serviços *Tailspin.Web* e *Tailspin.Web.Survey.Public* no aplicativo Service Fabric portado.</span><span class="sxs-lookup"><span data-stu-id="47381-159">This functionality was also originally implemented in the data access components of the *Tailspin.Web* and *Tailspin.Web.Survey.Public* services in the ported Service Fabric application.</span></span> <span data-ttu-id="47381-160">A Tailspin refatorou a funcionalidade original nesse serviço para permitir que ela seja dimensionada de forma independente.</span><span class="sxs-lookup"><span data-stu-id="47381-160">Tailspin refactored the original functionality into this service to allow it to scale independently.</span></span>

<span data-ttu-id="47381-161">O **Tailspin.SurveyAnswerService** é um serviço sem estado que recupera respostas e análises de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="47381-161">**Tailspin.SurveyAnswerService** is a stateless service that retrieves survey answers and survey analysis.</span></span> <span data-ttu-id="47381-162">O serviço também usa o armazenamento de Blobs do Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-162">The service also uses Azure Blob storage.</span></span> <span data-ttu-id="47381-163">Essa funcionalidade também foi originalmente implementada nos componentes de acesso a dados do serviço *Tailspin.Web* no aplicativo Service Fabric portado.</span><span class="sxs-lookup"><span data-stu-id="47381-163">This functionality was also originally implemented in the data access components of the *Tailspin.Web* service in the ported Service Fabric application.</span></span> <span data-ttu-id="47381-164">A Tailspin refatorou a funcionalidade original nesse serviço porque espera menos carga e deseja usar menos instâncias para conservar recursos.</span><span class="sxs-lookup"><span data-stu-id="47381-164">Tailspin refactored the original functionality into this service because it expects less load and wants to use fewer instances to conserve resources.</span></span>

<span data-ttu-id="47381-165">O **Tailspin.SurveyAnalysisService** é um serviço sem estado que persiste dados de resumo de resposta da pesquisa em um cache Redis para recuperação rápida.</span><span class="sxs-lookup"><span data-stu-id="47381-165">**Tailspin.SurveyAnalysisService** is a stateless service that persists survey answer summary data in a Redis cache for quick retrieval.</span></span> <span data-ttu-id="47381-166">Esse serviço é chamado pelo *Tailspin.SurveyResponseService* sempre que uma pesquisa é respondida e os novos dados de resposta da pesquisa forem mesclados nos dados de resumo.</span><span class="sxs-lookup"><span data-stu-id="47381-166">This service is called by the *Tailspin.SurveyResponseService* each time a survey is answered and the new survey answer data is merged in the summary data.</span></span> <span data-ttu-id="47381-167">Esse serviço inclui a funcionalidade originalmente implementada no serviço *Tailspin.AnswerAnalysisService* do aplicativo Service Fabric portado.</span><span class="sxs-lookup"><span data-stu-id="47381-167">This service includes the functionality originally implemented in the *Tailspin.AnswerAnalysisService* service from the ported Service Fabric application.</span></span>

## <a name="stateless-versus-stateful-services"></a><span data-ttu-id="47381-168">Serviços com estado vs. serviços sem estado</span><span class="sxs-lookup"><span data-stu-id="47381-168">Stateless versus stateful services</span></span>

<span data-ttu-id="47381-169">O Azure Service Fabric oferece suporte aos modelos de programação a seguir:</span><span class="sxs-lookup"><span data-stu-id="47381-169">Azure Service Fabric supports the following programming models:</span></span>
* <span data-ttu-id="47381-170">O modelo convidado executável permite que qualquer executável seja empacotado como um serviço e implantado a um cluster do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-170">The guest executable model allows any executable to be packaged as a service and deployed to a Service Fabric cluster.</span></span> <span data-ttu-id="47381-171">O Service Fabric orquestra e gerencia a execução do convidado executável.</span><span class="sxs-lookup"><span data-stu-id="47381-171">Service Fabric orchestrates and manages execution of the guest executable.</span></span>
* <span data-ttu-id="47381-172">O modelo do contêiner permite a implantação de serviços em imagens de contêiner.</span><span class="sxs-lookup"><span data-stu-id="47381-172">The container model allows for deployment of services in container images.</span></span> <span data-ttu-id="47381-173">O Service Fabric oferece suporte à criação e gerenciamento de contêineres sobre o kernel do Linux, bem como a contêineres do Windows Server.</span><span class="sxs-lookup"><span data-stu-id="47381-173">Service Fabric supports creation and management of containers on top of Linux kernel containers as well as Windows Server containers.</span></span> 
* <span data-ttu-id="47381-174">O modelo de programação de serviços confiável permite a criação de serviços com ou sem estado que se integram com todos os recursos de plataforma do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-174">The reliable services programming model allows for the creation of stateless or stateful services that integrate with all Service Fabric platform features.</span></span> <span data-ttu-id="47381-175">Os serviços com estado permitem que estados replicados sejam armazenados no cluster do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-175">Stateful services allow for replicated state to be stored in the Service Fabric cluster.</span></span> <span data-ttu-id="47381-176">Os serviços sem estado não permitem.</span><span class="sxs-lookup"><span data-stu-id="47381-176">Stateless services do not.</span></span>
* <span data-ttu-id="47381-177">O modelo confiável de programação de atores permite a criação de serviços que implementam o padrão de ator virtual.</span><span class="sxs-lookup"><span data-stu-id="47381-177">The reliable actors programming model allows for the creation of services that implement the virtual actor pattern.</span></span>

<span data-ttu-id="47381-178">Todos os serviços do aplicativo Surveys são serviços sem estado confiáveis, exceto para o serviço *Tailspin.SurveyResponseService*.</span><span class="sxs-lookup"><span data-stu-id="47381-178">All the services in the Surveys application are stateless reliable services, except for the *Tailspin.SurveyResponseService* service.</span></span> <span data-ttu-id="47381-179">Este serviço implementa um [ReliableConcurrentQueue][reliable-concurrent-queue] para processar respostas de pesquisa quando elas são recebidas.</span><span class="sxs-lookup"><span data-stu-id="47381-179">This service implements a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers when they are received.</span></span> <span data-ttu-id="47381-180">As respostas em ReliableConcurrentQueue são salvas no Armazenamento de Blobs do Azure e passadas para o *Tailspin.SurveyAnalysisService* para análise.</span><span class="sxs-lookup"><span data-stu-id="47381-180">Responses in the ReliableConcurrentQueue are saved into Azure Blob Storage and passed to the *Tailspin.SurveyAnalysisService* for analysis.</span></span> <span data-ttu-id="47381-181">O Tailspin escolhe uma ReliableConcurrentQueue porque as respostas não exigem uma ordenação estrita PEPS (primeiro a entrar, primeiro a sair) fornecida por uma fila como o Barramento de Serviço do Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-181">Tailspin chooses a ReliableConcurrentQueue because responses do not require strict first-in-first-out (FIFO) ordering provided by a queue such as Azure Service Bus.</span></span> <span data-ttu-id="47381-182">Um ReliableConcurrentQueue também foi projetado para oferecer alta taxa de transferência e baixa latência para operações da fila e de remoção da fila.</span><span class="sxs-lookup"><span data-stu-id="47381-182">A ReliableConcurrentQueue is also designed to deliver high throughput and low latency for queue and dequeue operations.</span></span>

<span data-ttu-id="47381-183">Observe que as operações para persistir com os itens removidos da fila de um ReliableConcurrentQueue devem ser, de preferência, idempotentes.</span><span class="sxs-lookup"><span data-stu-id="47381-183">Note that operations to persist dequeued items from a ReliableConcurrentQueue should ideally be idempotent.</span></span> <span data-ttu-id="47381-184">Se uma exceção for lançada durante o processamento de um item da fila, o mesmo item pode ser processado mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="47381-184">If an exception is thrown during the processing of an item from the queue, the same item may be processed more than once.</span></span> <span data-ttu-id="47381-185">No aplicativo Surveys, a operação para mesclar as respostas da pesquisa com o *Tailspin.SurveyAnalysisService* não é idempotente porque a Tailspin decidiu que os dados de análise da pesquisa são apenas uma visão rápida atual dos dados de análise, e não precisam ser consistentes.</span><span class="sxs-lookup"><span data-stu-id="47381-185">In the Surveys application, the operation to merge survey answers to the *Tailspin.SurveyAnalysisService* is not idempotent because Tailspin decided that the survey analysis data is only a current snapshot of the analysis data and does not need to be consistent.</span></span> <span data-ttu-id="47381-186">As respostas de pesquisa salvas no Armazenamento de Blobs do Azure são eventualmente consistentes. Assim, a análise de pesquisa final sempre pode ser recalculada corretamente a partir desses dados.</span><span class="sxs-lookup"><span data-stu-id="47381-186">The survey answers saved to Azure Blob Storage are eventually consistent, so the survey final analysis can always be recalculated correctly from this data.</span></span>

## <a name="communication-framework"></a><span data-ttu-id="47381-187">Estrutura de comunicação</span><span class="sxs-lookup"><span data-stu-id="47381-187">Communication framework</span></span>

<span data-ttu-id="47381-188">Cada serviço do aplicativo Surveys se comunica usando uma API RESTful Web.</span><span class="sxs-lookup"><span data-stu-id="47381-188">Each service in the Surveys application communicates using a RESTful web API.</span></span> <span data-ttu-id="47381-189">As APIs RESTful oferecem os seguintes benefícios:</span><span class="sxs-lookup"><span data-stu-id="47381-189">RESTful APIs offer the following benefits:</span></span>
* <span data-ttu-id="47381-190">Facilidade de uso: cada serviço é criado usando o ASP.NET Core MVC, que oferece suporte nativo à criação de APIs Web.</span><span class="sxs-lookup"><span data-stu-id="47381-190">Ease of use: each service is built using ASP.NET Core MVC, which natively supports the creation of Web APIs.</span></span>
* <span data-ttu-id="47381-191">Segurança: embora não sejam todos os serviços que exijam o protocolo SSL, a Tailspin pode exigir que todos os serviços façam isso.</span><span class="sxs-lookup"><span data-stu-id="47381-191">Security: While each service does not require SSL, Tailspin could require each service to do so.</span></span> 
* <span data-ttu-id="47381-192">Controle de versão: os clientes podem ser gravados e testados em relação a uma versão específica de uma API Web.</span><span class="sxs-lookup"><span data-stu-id="47381-192">Versioning: clients can be written and tested against a specific version of a web API.</span></span>

<span data-ttu-id="47381-193">Os serviços do aplicativo Surveys fazem uso do [proxy reverso][reverse-proxy] implementado pelo Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-193">Services in the Survey application make use of the [reverse proxy][reverse-proxy] implemented by Service Fabric.</span></span> <span data-ttu-id="47381-194">O proxy reverso é um serviço executado em cada nó do cluster do Service Fabric e fornece resolução do ponto de extremidade e repetição automática e lida com outros tipos de falhas de conexão.</span><span class="sxs-lookup"><span data-stu-id="47381-194">Reverse proxy is a service that runs on each node in the Service Fabric cluster and provides endpoint resolution, automatic retry, and handles other types of connection failures.</span></span> <span data-ttu-id="47381-195">Para usar o proxy reverso, cada chamada de API RESTful a um serviço específico é feita usando uma porta de proxy reverso predefinida.</span><span class="sxs-lookup"><span data-stu-id="47381-195">To use the reverse proxy, each RESTful API call to a specific service is made using a predefined reverse proxy port.</span></span>  <span data-ttu-id="47381-196">Por exemplo, se a porta de proxy reverso foi definida como **19081**, uma chamada ao *Tailspin.SurveyAnswerService* pode ser feita da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="47381-196">For example, if the reverse proxy port has been set to **19081**, a call to the *Tailspin.SurveyAnswerService* can be made as follows:</span></span>

```csharp
static SurveyAnswerService()
{
    httpClient = new HttpClient
    {
        BaseAddress = new Uri("http://localhost:19081/Tailspin/SurveyAnswerService/")
    };
}
```
<span data-ttu-id="47381-197">Para habilitar o proxy reverso, especifique uma porta de proxy reverso durante a criação do cluster do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-197">To enable reverse proxy, specify a reverse proxy port during creation of the Service Fabric cluster.</span></span> <span data-ttu-id="47381-198">Para obter mais informações, confira [proxy reverso][reverse-proxy] no Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-198">For more information, see [reverse proxy][reverse-proxy] in Azure Service Fabric.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="47381-199">Considerações sobre o desempenho</span><span class="sxs-lookup"><span data-stu-id="47381-199">Performance considerations</span></span>

<span data-ttu-id="47381-200">A Tailspin criou os serviços do ASP.NET Core para o *Tailspin.Web* e o *Tailspin.Web.Surveys.Public* usando modelos do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="47381-200">Tailspin created the ASP.NET Core services for *Tailspin.Web* and *Tailspin.Web.Surveys.Public* using Visual Studio templates.</span></span> <span data-ttu-id="47381-201">Por padrão, esses modelos incluem o registro de log para o console.</span><span class="sxs-lookup"><span data-stu-id="47381-201">By default, these templates include logging to the console.</span></span> <span data-ttu-id="47381-202">O registro de log para o console pode ser feito durante o desenvolvimento e a depuração, mas todos os registros de log para o console devem ser removidos quando o aplicativo for implantado para produção.</span><span class="sxs-lookup"><span data-stu-id="47381-202">Logging to the console may be done during development and debugging, but all logging to the console should be removed when the application is deployed to production.</span></span>

> [!NOTE]
> <span data-ttu-id="47381-203">Para obter mais informações sobre como configurar o monitoramento e os diagnósticos para aplicativos do Service Fabric em execução na produção, confira [monitoramento e diagnóstico][monitoring-diagnostics] para o Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-203">For more information about setting up monitoring and diagnostics for Service Fabric applications running in production, see [monitoring and diagnostics][monitoring-diagnostics] for Azure Service Fabric.</span></span>

<span data-ttu-id="47381-204">Por exemplo, as linhas a seguir no *startup.cs* para cada serviço de front-end Web devem ser comentadas:</span><span class="sxs-lookup"><span data-stu-id="47381-204">For example, the following lines in *startup.cs* for each of the web front end services should be commented out:</span></span>

```csharp
// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    //loggerFactory.AddConsole(Configuration.GetSection("Logging"));
    //loggerFactory.AddDebug();

    app.UseMvc();
}
```

> [!NOTE]
> <span data-ttu-id="47381-205">Essas linhas podem ser excluídas condicionalmente quando o Visual Studio estiver definido como “versão” ao ser publicado.</span><span class="sxs-lookup"><span data-stu-id="47381-205">These lines may be conditionally excluded when Visual Studio is set to “release” when publishing.</span></span>

<span data-ttu-id="47381-206">Finalmente, quando a Tailspin implantar seu aplicativo para produção, o Visual Studio será alternado para o modo **versão**.</span><span class="sxs-lookup"><span data-stu-id="47381-206">Finally, when Tailspin deploys the Tailspin application to production, they switch Visual Studio to **release** mode.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="47381-207">Considerações de implantação</span><span class="sxs-lookup"><span data-stu-id="47381-207">Deployment considerations</span></span>

<span data-ttu-id="47381-208">O aplicativo Surveys refatorado é composto por cinco serviços sem estado e um serviço com estado para que o planejamento de cluster seja limitado à definição do tamanho correto de VM e do número de nós.</span><span class="sxs-lookup"><span data-stu-id="47381-208">The refactored Surveys application is composed of five stateless services and one stateful service, so cluster planning is limited to determining the correct VM size and number of nodes.</span></span> <span data-ttu-id="47381-209">No arquivo *applicationmanifest.xml* que descreve o cluster, a Tailspin define o atributo *InstanceCount* da marca *StatelessService* como -1 para cada um dos serviços.</span><span class="sxs-lookup"><span data-stu-id="47381-209">In the *applicationmanifest.xml* file that describes the cluster, Tailspin sets the *InstanceCount* attribute of the *StatelessService* tag to -1 for each of the services.</span></span> <span data-ttu-id="47381-210">Um valor de -1 direciona o Service Fabric para criar uma instância do serviço em cada nó no cluster.</span><span class="sxs-lookup"><span data-stu-id="47381-210">A value of -1 directs Service Fabric to create an instance of the service on each node in the cluster.</span></span>

> [!NOTE]
> <span data-ttu-id="47381-211">Os serviços com estado exigem a etapa adicional de planejamento do número correto de partições e réplicas de seus dados.</span><span class="sxs-lookup"><span data-stu-id="47381-211">Stateful services require the additional step of planning the correct number of partitions and replicas for their data.</span></span>

<span data-ttu-id="47381-212">A Tailspin implanta o cluster usando o Portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="47381-212">Tailspin deploys the cluster using the Azure Portal.</span></span> <span data-ttu-id="47381-213">O tipo de recurso de Cluster do Service Fabric implanta todos as infraestruturas necessárias, incluindo conjuntos de dimensionamento de VMs e um balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="47381-213">The Service Fabric Cluster resource type deploys all of the necessary infrastructure, including VM scale sets and a load balancer.</span></span> <span data-ttu-id="47381-214">Os tamanhos de VM recomendados são exibidos no portal do Azure durante o processo de provisionamento do cluster do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="47381-214">The recommended VM sizes are displayed in the Azure portal during the provisioning process for the Service Fabric cluster.</span></span> <span data-ttu-id="47381-215">Observe que, como as VMs são implantadas em um conjunto de dimensionamento de VM, elas podem ser dimensionadas vertical e horizontalmente à medida que o usuário aumenta a carga.</span><span class="sxs-lookup"><span data-stu-id="47381-215">Note that because the VMs are deployed in a VM scale set, they can be both scaled up and out as user load increases.</span></span>

> [!NOTE]
> <span data-ttu-id="47381-216">Conforme discutido anteriormente, na versão migrada do aplicativo Surveys, os dois front-ends da Web foram auto-hospedados usando o ASP.NET Core e o Kestrel como um servidor Web.</span><span class="sxs-lookup"><span data-stu-id="47381-216">As discussed earlier, in the migrated version of the Surveys application the two web front ends were self-hosted using ASP.NET Core and Kestrel as a web server.</span></span> <span data-ttu-id="47381-217">Embora a versão migrada do aplicativo Surveys não use um proxy reverso, é altamente recomendável usar um proxy reverso como IIS, Nginx ou Apache.</span><span class="sxs-lookup"><span data-stu-id="47381-217">While the migrated version of the Survey application does not use a reverse proxy, it is strongly recommended to use a reverse proxy such as IIS, Nginx, or Apache.</span></span> <span data-ttu-id="47381-218">Para obter mais informações, confira [introdução à implementação do servidor Web Kestrel no ASP.NET Core][kestrel-intro].</span><span class="sxs-lookup"><span data-stu-id="47381-218">For more information see [introduction to Kestrel web server implementation in ASP.NET core][kestrel-intro].</span></span>
> <span data-ttu-id="47381-219">No aplicativo Surveys refatorado, os dois front-ends da Web são auto-hospedados usando o ASP.NET Core com [WebListener][weblistener] como um servidor Web, para que um proxy reverso não seja necessário.</span><span class="sxs-lookup"><span data-stu-id="47381-219">In the refactored Surveys application, the two web front ends are self-hosted using ASP.NET Core with [WebListener][weblistener] as a web server so a reverse proxy is not necessary.</span></span>

## <a name="next-steps"></a><span data-ttu-id="47381-220">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="47381-220">Next steps</span></span>

<span data-ttu-id="47381-221">O código do aplicativo Surveys está disponível no [GitHub][sample-code].</span><span class="sxs-lookup"><span data-stu-id="47381-221">The Surveys application code is available on [GitHub][sample-code].</span></span>

<span data-ttu-id="47381-222">Se você está apenas começando a usar o [Azure Service Fabric][service-fabric], primeiro configure seu ambiente de desenvolvimento, depois baixe a versão mais recente do [SDK do Azure][azure-sdk] e [SDK do Azure Service Fabric][service-fabric-sdk].</span><span class="sxs-lookup"><span data-stu-id="47381-222">If you are just getting started with [Azure Service Fabric][service-fabric], first set up your development environment then download the latest [Azure SDK][azure-sdk] and the [Azure Service Fabric SDK][service-fabric-sdk].</span></span> <span data-ttu-id="47381-223">O SDK inclui o gerenciador de cluster OneBox para que você possa implantar e testar o aplicativo Surveys localmente com depuração F5 completa.</span><span class="sxs-lookup"><span data-stu-id="47381-223">The SDK includes the OneBox cluster manager so you can deploy and test the Surveys application locally with full F5 debugging.</span></span>

<!-- links -->
[azure-sdk]: https://azure.microsoft.com/downloads/archive-net-downloads/
[container-scenarios]: /azure/service-fabric/service-fabric-containers-overview
[kestrel]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore2x
[kestrel-intro]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore1x
[migrate-from-cloud-services]: migrate-from-cloud-services.md
[monitoring-diagnostics]: /azure/service-fabric/service-fabric-diagnostics-overview
[reliable-concurrent-queue]: /azure/service-fabric/service-fabric-reliable-services-reliable-concurrent-queue
[reverse-proxy]: /azure/service-fabric/service-fabric-reverseproxy
[sample-code]: https://github.com/mspnp/cloud-services-to-service-fabric/tree/master/servicefabric-phase-2
[service-fabric]: /azure/service-fabric/service-fabric-get-started
[service-fabric-sdk]: /azure/service-fabric/service-fabric-get-started
[weblistener]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/weblistener
